
csui.define('css!xecmpf/pages/start/perspectivewithoutheader',[],function(){});
csui.define('xecmpf/pages/start/perspective-only.page.view',['csui/lib/underscore', 'csui/lib/jquery',
  'csui/lib/marionette', 'csui/lib/fastclick',
  'csui/utils/contexts/perspective/perspective.context',
  'csui/utils/contexts/factories/connector',
  'csui/pages/start/multi.perspective.routing', 'csui/utils/base',
  'csui/controls/perspective.panel/perspective.panel.view',
  'csui/controls/mixins/view.events.propagation/view.events.propagation.mixin',
  'csui/behaviors/keyboard.navigation/tabables.behavior',
  'csui/utils/page.leaving.blocker',
  'csui/controls/globalmessage/globalmessage',
  'csui/controls/iconpreload/icon.preload.view',
  "css!xecmpf/pages/start/perspectivewithoutheader"
], function (_, $, Marionette, FastClick,
  PerspectiveContext, ConnectorFactory, MultiPerspectiveRouting,
  base, PerspectivePanelView, ViewEventsPropagationMixin,
  TabablesBehavior, PageLeavingBlocker, GlobalMessage, IconPreloadView) {

  var PerspectiveOnlyPageView = Marionette.ItemView.extend({

    behaviors: {
      TabablesBehavior: {
        behaviorClass: TabablesBehavior
      }
    },

    template: false,

    constructor: function PerspectiveOnlyPageView(options) {
      Marionette.ItemView.prototype.constructor.call(this, options);

      if (!this.options.el) {
        this.setElement(document.body);
      }

      // Create application context for this page
      var context = options.context || new PerspectiveContext(),
        connector = context.getObject(ConnectorFactory);

      // SAPRM-9977
      context.options = context.options || {};
      context.options.suppressReferencePanel = true;
      // End of SAPRM-9977

      context.options.navigateMode = options.navigateMode;
      context.options.enableWorkspaceNavigation = true;

      // Check if the page has authentication information
      // Use Basic Authentication (known credentials)
      if (!connector.connection.credentials &&
        // Use pre-authenticated session (session.ticket)
        !connector.authenticator.isAuthenticated() &&
        // Try pre-authenticated session from session storage
        !connector.authenticator.syncStorage().isAuthenticated()) {
        this._navigateToSignIn();
        return;
      }

      this.perspectivePanel = new PerspectivePanelView({
        context: context
      });
      this.propagateEventsToViews(this.perspectivePanel);

      // Initialize URL routing
      var routing = new MultiPerspectiveRouting({
        context: context
      });
      routing.ensureStart({
        pushState: true
      });

      // Enable styling workarounds for Safari on iPad.  We might want to
      // put them to a separate CSS file loaded dynamically, instead of
      // having them in the same file identified by this class, if the size
      // of the workaround styles grows too much.
      if (base.isAppleMobile()) {
        this.$el.addClass('csui-on-ipad');
      }

      // Workaround for an iPad quirk for the price of disabling its
      // double-tap features; it waits 300ms before the click event
      // is dispatched and this makes it do it immediately
      FastClick.attach(this.el);

      // Workaround for the back-forward cache in Safari, which ignores the
      // no-store cache control flag and loads the page from cache, when the
      // back button is clicked.  As long as logging out does not invalidate
      // the LLCookie/OTCSTicket and we write the ticket to the /app, going
      // back would allow the logged-out user working with the REST API again.
      //
      // http://madhatted.com/2013/6/16/you-do-not-understand-browser-history
      // http://www.mobify.com/blog/beginners-guide-to-http-cache-headers/
      $(window).on("unload", function () {});
    },

    onRender: function () {
      if (!this._redirecting) {
        this.$el.addClass("binf-widgets xecm-page-widget");
        this.$el.append("<div class='binf-widgets xecm-page-widget-sub-wrapper'></div>");
        this.$el.find('.xecm-page-widget-sub-wrapper').addClass("xecm-no-iframe-wrap");

        IconPreloadView.ensureOnThePage();
        GlobalMessage.setMessageRegionView(this, {
          classes: "xecm-global-message",
          useClass: true,
          sizeToParentContainer: true
        });
        var perspectiveRegion = new Marionette.Region({
          el: this.$el.find("div.xecm-page-widget-sub-wrapper")
        });
        perspectiveRegion.show(this.perspectivePanel);
      }
    },

    _navigateToSignIn: function () {
      if (MultiPerspectiveRouting.routesWithSlashes()) {
        // If the session expires or is not available, reload the /app page;
        // authentication should be performed by the server redirecting to
        // the OTDS login page
        PageLeavingBlocker.forceDisable();
        location.reload();
      }
      // The REST of the view rendering continues, until the context
      // is switched, and the page would quickly show its content
      // before the location change finally kicks in.
      this._redirecting = true;
    }

  });

  _.extend(PerspectiveOnlyPageView.prototype, ViewEventsPropagationMixin);

  return PerspectiveOnlyPageView;

});
csui.define('xecmpf/widgets/integration/folderbrowse/impl/nls/localized.strings',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});

csui.define('xecmpf/widgets/integration/folderbrowse/impl/nls/root/localized.strings',{
  BackButtonToolItem: "Back",
  PageWidgetToolItem: "Open Full Page Workspace",
  SearchToolItem: "Search From Here",
  SearchFromHerePlaceHolder: "Search From Here",
  CloseToolTip:"Close"
});



csui.define('css!xecmpf/widgets/integration/folderbrowse/impl/folderbrowse',[],function(){});
csui.define('xecmpf/widgets/integration/folderbrowse/search.box.view',['module', 'csui/lib/underscore', 'csui/lib/jquery',
  'csui/widgets/search.box/search.box.view',
  'i18n!xecmpf/widgets/integration/folderbrowse/impl/nls/localized.strings',
  "css!xecmpf/widgets/integration/folderbrowse/impl/folderbrowse"
], function (module, _, $, SearchBoxView, Lang) {
  "use strict";

  var config = _.defaults({}, module.config(), {
    showOptionsDropDown: false,
    showSearchInput: true,
    searchFromHere: true,
    customSearchIconClass: "xecmpf-icon-search",
    customSearchIconEnabledClass: "xecmpf-icon-search-md",
    placeholder: Lang.SearchFromHerePlaceHolder
  });

  var CustomSearchBoxView = SearchBoxView.extend({
    constructor: function CustomSearchBoxView(options) {
      options = options || {};
      options.data = _.defaults({}, options.data, config);
      SearchBoxView.prototype.constructor.call(this, options);
    },
    //Overriding the searchIconClicked method of SearchBoxView to prevent window beforeunload event
    //of the connector from getting called."beforeunload" method of connector sets a flag which
    //indefinitely shows the blocker in case of error
    searchIconClicked: function (event) {
      event.preventDefault();
      event.stopPropagation();
      SearchBoxView.prototype.searchIconClicked.call(this, event);
    },

    // Avoid the bubbling of space key event - XECMPF-880
    inputTyped: function (event) {
      if (event.which === 32) {
        event.stopPropagation();
      } else {
        SearchBoxView.prototype.inputTyped.call(this, event);
      }
    }
  });

  return CustomSearchBoxView;

});

csui.define('xecmpf/widgets/integration/folderbrowse/full.page.workspace.view',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/marionette',
  'csui/utils/contexts/factories/node',
  'csui/utils/contexts/perspective/perspective.context',
  'csui/controls/perspective.panel/perspective.panel.view',
  'csui/lib/radio',
  'csui/controls/globalmessage/globalmessage',
  'csui/pages/start/multi.perspective.routing',
  'csui/models/navigation.history',
  'css!xecmpf/widgets/integration/folderbrowse/impl/folderbrowse'
], function (_, $, Marionette, NodeModelFactory, PerspectiveContext,
  PerspectivePanelView, Radio, GlobalMessage,
  MultiPerspectiveRouting, NavigationHistory) {
  "use strict";

  var perspectiveContext;
  var channel = Radio.channel('xecmpf-workspace');
  var FullPageWorkpsaceView = Marionette.ItemView.extend({

    className: 'xecm-full-page-workspace',

    constructor: function FullPageWorkpsaceView(options) {
      options = options || {};
      Marionette.ItemView.prototype.constructor.apply(this, arguments);
      NavigationHistory.urlCanChange = false;
      csui.require.config({
        config: {
          // Always disable the back button otherwise it may get enabled in
          // certain scenarios like when switched from folder browser widget
          'csui/utils/commands/back.to.last.fragment': {
            enabled: false
          },
          'xecmpf/widgets/header/header.view': {
            hideMetadata: true,
            pageWidget: true,
            toolbarBlacklist: ['SearchFromHere']
          },
          'xecmpf/utils/commands/folderbrowse/search.container': {
            pageWidget: true,
            enabled: true
          }
        }
      });
    },

    template: false,

    onRender: function () {
      csui.require.config({
        config: {
          'csui/integration/folderbrowser2/container.enforcer': {
            enabled: false
          }
        }
      });

      var factories = {
        connector: this.options.connector
      };
      perspectiveContext = new PerspectiveContext({
        factories: factories
      });
      var routing = new MultiPerspectiveRouting({
        context: perspectiveContext
      });
      routing.ensureStart({
        pushState: false,
        silent: true
      });

      // clear routing history just in case available.
      var viewStateModel = perspectiveContext.viewStateModel;
      if (viewStateModel) {
        viewStateModel.clearHistory();
        viewStateModel.set(viewStateModel.CONSTANTS.CURRENT_ROUTER, undefined);
      }
      var that = this;
      var perspectiveView = new PerspectivePanelView({
        context: perspectiveContext
      });
      var nextNode = perspectiveContext.hasModel('nextNode') ?
        perspectiveContext.getModel('nextNode') : undefined;
      if (nextNode) {
        if(nextNode.get('id') === this.options.nodeID) {
          nextNode.unset('id', {silent:true});
        }
        nextNode.set('id', this.options.nodeID);
        _.extend(perspectiveContext.options, {
          initialWkspId: that.options.nodeID,
          viewMode: that.options.data.viewMode,
          navigateMode: that.options.data.navigateMode,
          enableWorkspaceNavigation: true,
          hideBreadcrumbsPanel: true,
          headerViewOptions: {
            hideWorkspaceType: true,
            hideDescription: true,
            hideActivityFeed: true,
            hideToolbarExtension: true,
            enableCollapse: !_.isUndefined(that.options.enableCollapse) ? that.options.enableCollapse : false
          }
        });
        if (that.options.renderType === undefined || that.options.renderType !== 'dialog') {
          that.listenTo(channel, 'xecm:delete:workspace', function () {
            _.defaults(that.options.data, {
              deletecallback: true
            });
            that.options.status.wksp_controller.selectWorkspace(that.options);
          });

          that.listenTo(that.options.status.wksp_controller, 'xecm:change:fullPage', function (data) {
            if (data && data.action === 'enterContainer') {
              that.enterContainer(data, perspectiveContext);
            }
          });

          // TODO: remove the following code and all the code related to maximize and minimiz widget view once
          // LPAD-88059 is Resolved.
          perspectiveView.on("swap:perspective", function () {
            that.removeMaximizedWidget.apply(perspectiveView);
          });

        } else if (that.options.renderType === 'dialog') {
          perspectiveView.on("show:perspective swap:perspective", function () {
            that.removeMaximizedWidget.apply(perspectiveView);
            if (that.$el.find(".conws-header-wrapper").length === 0) {
              that.trigger('show:dialog:header');
            } else {
              that.trigger('hide:dialog:header');
            }
          });

          that.listenTo(perspectiveContext.perspective, 'close:workspace:dialog', function () {
            channel.trigger('xecm:close:fullpage:overlay');
          });
        }

        perspectiveContext.options.suppressReferencePanel = true;
        that.listenTo(perspectiveContext, 'clear', function () {
          var nodeModelFactory = perspectiveContext.getModel(NodeModelFactory);
          if (!nodeModelFactory.get('id')) {
            nodeModelFactory.set(nextNode.toJSON());
          }
        });

        that.listenTo(perspectiveContext, "maximize:widget", _.bind(that.addMaximizedWidget, perspectiveView));
        that.listenTo(perspectiveContext, "restore:widget:size", _.bind(that.removeMaximizedWidget, perspectiveView));

        GlobalMessage.setMessageRegionView(
          new Marionette.View({
            el: $.fn.binf_modal.getDefaultContainer()
          }), {
          classes: "xecm-global-message",
          useClass: true,
          sizeToParentContainer: true
        });

        var contentRegion = new Marionette.Region({
          el: that.el
        });
        that.$el.addClass("binf-widgets xecm-page-widget xecm-no-iframe-wrap");
        contentRegion.show(perspectiveView);
        perspectiveContext.applyPerspective(nextNode);
      }
    },

    onBeforeDestroy: function () {
      csui.require.config({
        config: {
          'xecmpf/utils/commands/folderbrowse/search.container': {
            pageWidget: false,
            enabled: true
          }
        }
      });
    },

    onDestroy: function () {
      if (perspectiveContext) {
        perspectiveContext.destroy();
      }
    },

    // TODO: remove the following code and all the code related to maximize and minimize widget view once
    // LPAD-88059 is Resolved.
    addMaximizedWidget: function () {
      if ($(".xecm-no-iframe-wrap").length && !($("body").hasClass("binf-widgets"))) {
        if (!$(".xecm-no-iframe-wrap").hasClass("csui-maximized-widget-mode")) {
          $(".xecm-no-iframe-wrap").addClass("csui-maximized-widget-mode");
          if (this.currentPerspectiveView && this.currentPerspectiveView.perspectiveView &&
            this.currentPerspectiveView.perspectiveView.tabPanel) {
            this.currentPerspectiveView.perspectiveView.tabPanel.trigger("dom:refresh");
          }
        }
      }
    },

    removeMaximizedWidget: function () {
      if ($(".xecm-no-iframe-wrap").length && !($("body").hasClass("binf-widgets"))) {
        if ($(".xecm-no-iframe-wrap").hasClass("csui-maximized-widget-mode")) {
          $(".xecm-no-iframe-wrap").removeClass("csui-maximized-widget-mode");
          if (this.currentPerspectiveView && this.currentPerspectiveView.perspectiveView &&
            this.currentPerspectiveView.perspectiveView.tabPanel) {
            this.currentPerspectiveView.perspectiveView.tabPanel.trigger("dom:refresh");
          }
        }
      }
    },

    enterContainer: function (data, perspectiveContext) {
      if (perspectiveContext) {
        var nextNode = perspectiveContext.getModel('nextNode');
        if (nextNode) {
          nextNode.set('id', data.id);
        }
      }
    }
  });

  return FullPageWorkpsaceView;
});
csui.define('xecmpf/widgets/integration/folderbrowse/search.results/search.results.view',['module', 'csui/lib/underscore', 'csui/lib/jquery',
  'csui/widgets/search.results/search.results.view',
  'i18n!xecmpf/widgets/integration/folderbrowse/impl/nls/localized.strings',
  "css!xecmpf/widgets/integration/folderbrowse/impl/folderbrowse"
], function (module, _, $, SearchResultsView, Lang) {
  "use strict";

  var CustomSearchResultsView = SearchResultsView.extend({
    constructor: function CustomSearchResultsView(options) {
      options = options || {};
      options = _.extend(options, options.data);
      SearchResultsView.prototype.constructor.call(this, options);
      this.listenTo(this, "go:back", function () {
        var context = options.context,
          viewStateModel = context.viewStateModel;
        viewStateModel.restoreLastFragment();
      })
    }
  });

  return CustomSearchResultsView;

});

csui.define('xecmpf/utils/commands/nls/localized.strings',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});

csui.define('xecmpf/utils/commands/nls/root/localized.strings',{

  DetachPageLeavingWarning: "If you leave the page now, pending items will not be detached.",
  DetachBusAtts: 'Detaching {0} business objects',
  DetachingOneBusAtt: 'Detaching business object',

  DetachBusAttsNoneMessage: "No business objects detached.",
  DetachOneBusAttSuccessMessage: "1 business object succeeded to detach.",
  DetachSomeBusAttsSuccessMessage: "{0} business objects succeeded to detach.",
  DetachManyBusAttsSuccessMessage: "{0} business objects succeeded to detach.",
  DetachOneBusAttFailMessage: "1 business object failed to detach.",
  DetachSomeBusAttsFailMessage: "{0} business objects failed to detach.",
  DetachManyBusAttsFailMessage2: "{2} business objects failed to detach.", // {2} !!
  DetachSomeBusAttsFailMessage2: "{2} business objects failed to detach.", // {2} !!
  DetachingSomeBusAtts: 'Detaching {0} business objets',

  DetachBusAttsCommandConfirmDialogTitle: "Detach",
  DetachBusAttsCommandConfirmDialogSingleMessage: "Do you want to detach {0}?",
  DetachBusAttsCommandConfirmDialogMultipleMessage: "Do you want to detach {0} items?",
  CommandDoneVerbDetached: 'detached',
  CommandNameDetach: 'Detach Business Attachment',

  AttachPageLeavingWarning: "If you leave the page now, pending items will not be detached.",
  AttachBusAtts: 'Attaching {0} business objects',
  AttachingOneBusAtt: 'Attaching business object',

  AttachBusAttsNoneMessage: "No business objects attached.",
  AttachOneBusAttSuccessMessage: "1 business object succeeded to attach.",
  AttachSomeBusAttsSuccessMessage: "{0} business objects succeeded to attach.",
  AttachManyBusAttsSuccessMessage: "{0} business objects succeeded to attach.",
  AttachOneBusAttFailMessage: "1 business object failed to attach.",
  AttachSomeBusAttsFailMessage: "{0} business objects failed to attach.",
  AttachManyBusAttsFailMessage: "{0} business objects failed to attach.",
  AttachManyBusAttsFailMessage2: "{2} business objects failed to attach.", // {2} !!
  AttachSomeBusAttsFailMessage2: "{2} business objects failed to attach.", // {2} !!
  AttachingSomeBusAtts: 'attaching {0} business objets',

  AttachBusAttsCommandConfirmDialogTitle: "Attach",
  AttachBusAttsCommandConfirmDialogSingleMessage: "Do you want to attach {0}?",
  AttachBusAttsCommandConfirmDialogMultipleMessage: "Do you want to attach {0} items?",
  AttachBusAttsCommandConfirmDialogHtml: "<span class='msgIcon WarningIcon'>" +
    "<%- message %>" +
    "</span>",
  CommandDoneVerbAttached: 'attached',
  CommandNameAttach: 'Attach Business Attachment',

  CommandNameOpenSapObject: 'Open Sap Object',

  CommandNameGoToWorkspace: 'Go To Workspace',

  GoToWorkpsaceHistory: "Go To Workspace History",
  OpenFullPageWorkpsace: "Open Full Page Wokspace",
  SearchWorkspace: "Search From Here",
  SearchBackTooltip: "Go Back to '{0}'",  

  /* Start BO Attachment */
  BOAttachmentCreate: {
    name: 'Add business attachment',
    verb: 'attach',
    doneVerb: 'attached',
    addButtonLabel: 'Attach',
    pageLeavingWarning: 'If you leave the page now, pending items will not be attached.',
    successMessages: {
      formatForNone: 'No business attachments attached.',
      formatForOne: '1 business attachment succeeded to attach.',
      formatForMultiple: '{0} business attachments succeeded to attach.'
    },
    errorMessages: {
      //formatForNone: 'No business attachments attached.',
      formatForOne: '1 business attachment failed to attach.',
      formatForMultiple: '{0} business attachments failed to attach.'
    },
    progressBarMessages: {
      oneFileTitle: 'Attaching business attachment',
      //oneFileSuccess: '1 business attachment succeeded to attach.',
      //multiFileSuccess: '{0} business attachments succeeded to attach.',
      //oneFilePending: 'Attaching business attachment',
      multiFilePending: 'Attaching {0} business attachments',
      //oneFileFailure: '1 business attachment failed to attach.',
      multiFileFailure: '{2} business attachments failed to attach.', // {2} !!
      //someFileSuccess: '{0} business attachments succeeded to attach.',
      //someFilePending: 'Attaching {0} business attachments',
      //someFileFailure: '{2} business attachments failed to attach.' // {2} !!
    }
  },
  /* End BO Attachment */

  backButtonToolTip: 'Go back',

  // BO Attachments Snapshot Command
  CommandSnapshot: 'Snapshot',
  snapshotCreated: 'Snapshot created',
  snapshotCreatedWithName: "Snapshot '{0}' created",
  snapshotFailed: 'Snapshot creation failed',
  CommandDoneVerbCreated: 'created',

  
  // Delete
  DeleteCommandConfirmDialogTitle: "Delete",
  DeleteCommandConfirmDialogHtml: "<span class='msgIcon WarningIcon'>" +
                                  "<%- message %>" +
                                  "</span>",
  DeleteCommandConfirmDialogSingleMessage: "Do you want to delete {0}?",
  DeleteCommandConfirmDialogMultipleMessage: "Do you want to delete {0} items?",
  CommandTitleDelete: "Delete items",
  CommandNameDelete: "Delete",
  CommandVerbDelete: "delete",
  DeletePageLeavingWarning: "If you leave the page now, pending items will not be deleted.",
  DeleteItemFailed: 'Deleting item {0} failed.',
  DeleteItems: 'Deleting {0} items',
  DeletingOneItem: 'Deleting "{0}"',
  DeletingSomeItems: 'Deleting {0} items',
  DeleteItemsNoneMessage: "No items deleted.",
  DeleteOneItemSuccessMessage: "'{0}' deleted.",
  DeleteSomeItemsSuccessMessage: "{0} items successfully deleted.",
  DeleteManyItemsSuccessMessage: "{0} items successfully deleted.",
  DeleteOneItemFailMessage: "'{0}' failed to delete.",
  DeleteManyItemsOneFailMessage: "1 item failed to delete.",
  DeleteSomeItemsFailMessage: "{0} items failed to delete.",
  DeleteManyItemsFailMessage: "{0} items failed to delete.",
  DeleteSomeItemsFailMessage2: "{2} items failed to delete.",   // {2} !!
  DeleteManyItemsFailMessage2: "{2} items failed to delete.",   // {2} !!
  deletingLocationLabel: 'Deleting from "{0}"',
  deletedLocationLabel: 'Deleted from "{0}"',
  DeleteNotAllowed : 'Unable to delete. Please try again when the current operation is finished',

  //EAC Global Messages
  Refresh: 'Events refreshed.',
  RefreshError: 'Error while refreshing.',
  AuthenticationError: 'Authentication failed',
  addEvents:'Add events',
  Delete:'Delete',
  AddtoWareHouse:'Add wareHouse',
  system_name:"Source",
  ActionPlans:"Action plans",

  noPlans:"No plans added",
  dialogTitle: "Event action center",
  AddActionPlan:"Add action plan",
  NoMoreToAdd:"No more to add in the leading system",
  add:"Add",
  cancel:"Cancel",
  NoLeadingSys:"All events for this source are already added.",
  selectEvent:"Select event",
  selectSource:"Select source",
  SaveFailError:"Unable tosave event server error",
  Event: "Event",

  // Appworks Integration workflows

  close : "Close",

  // XECMPF create document 

  createDocumentCommand: "Create document",
  createDocumentDialogTitle: "Create document",
  createDocumentCancelBtnLabel: "Cancel",

});

/**
 * Commands related to xECM PF module at Nodes table view.
 * So far, the following list of commands will be available at Nodes table.
 * In future, can extend these commands by following the same syntax.
 */

 csui.define('xecmpf/utils/commands/xecmpf.nodestable.toolitems',['i18n!xecmpf/utils/commands/nls/localized.strings'
], function (lang) {
  'use strict';
  return {
    leftToolbar: [
      {
        signature: "XECMPFCreateDocument",
        icon: "icon xecmpf-nodestable-docgen-action",
        name: lang.createDocumentCommand,
        type: "leftToolbar"
      }
    ],
    inlineActionbar: [
      {
        signature: "XECMPFCreateDocument",
        name: lang.createDocumentCommand,
        icon: "icon xecmpf-workspaces-docgen"
      }
    ]
  };
});

csui.define('xecmpf/utils/commands/xecmpf.searchresults.toolitems',['i18n!xecmpf/utils/commands/nls/localized.strings'], function (lang) {
	'use strict';
	return {
	  inlineToolbar: [
		{
		  signature: "XECMPFCreateDocument",
		  name: lang.createDocumentCommand,
		  icon: "icon xecmpf-workspaces-docgen"
		}
	  ],
	  tabularInlineToolbar: [
		{
		  signature: "XECMPFCreateDocument",
		  name: lang.createDocumentCommand,
		  icon: "icon xecmpf-workspaces-docgen"
		}
	  ]
	};
  });
  
csui.define('xecmpf/utils/contexts/factories/eventactioncenter/eventactioncentercolumncollection',[
  'csui/lib/underscore', 'csui/lib/backbone',
  'csui/models/nodechildrencolumn', 'csui/models/nodechildrencolumns',
  'i18n!xecmpf/utils/commands/nls/localized.strings'
], function (_, Backbone, NodeChildrenColumnModel, NodeChildrenColumnCollection, lang) {

  var EventActionCenterColumnModel = NodeChildrenColumnModel.extend({

    constructor: function EventActionCenterColumnModel(attributes, options) {
      if (attributes && !attributes.title) {
        var columnKey = attributes.column_key;
        attributes.title = lang[columnKey];
      }
      NodeChildrenColumnModel.prototype.constructor.call(this, attributes, options);
    }

  });

  var EventActionCenterColumnCollection = NodeChildrenColumnCollection.extend({

    model: EventActionCenterColumnModel,

    constructor: function EventActionCenterColumnCollection(models, options) {
      if (!models) {
        models = [

          {
            key: 'system_name',
            contextual_menu: false,
            name: lang.system_name
          },
          {
            key: 'name',
            align: 'left',
            title: lang.Event,
          },
          {
            key: 'action_plan_text',
            name: lang.ActionPlans,
            isNaming: true
          }
        ];
        models.forEach(function (column, index) {
          column.definitions_order = index + 100;
          column.column_key = column.key;
        });
      }
      NodeChildrenColumnCollection.prototype.constructor.call(this, models, options);

    }

  });

  return EventActionCenterColumnCollection;

});
csui.define('xecmpf/utils/contexts/factories/eventactioncenter/server.adaptor.mixin',[
  'csui/lib/underscore',
  'csui/utils/url','i18n!xecmpf/utils/commands/nls/localized.strings',
], function (_, Url,lang) {
  'use strict';

  var ServerAdaptorMixin = {
    mixin: function (prototype) {
      return _.extend(prototype, {
        makeServerAdaptor: function (options) {
          return this;
        },

        url: function (options) {

          var restUrl = Url.combine(this.connector.getConnectionUrl().getApiBase('v2'),
              'eventactioncenter/eventdefinitions');
          return restUrl;

        },

        parse: function (response) {
          this.options.fetched = false;
          var result = [];
          var NoPlanMessage;
          var result_holder  = {};          
          result_holder.data = {};
     for(var key in response.results.data){                        
         var resultp =  response.results.data[key].filter(function(res){
           return res.status === 1;
          });                        
         result_holder.data[key] = resultp;
         resultp.forEach(function (ele, index) {
          if (ele.status === 1) {
            result.push({
              id: ele.dataID,
              system_name: ele.namespace,
              namespace:ele.namespace,
              name: ele.name,
              event_name:ele.name,
              action_plan_text: ele.actionPlanCountText,
              action_plan_count: ele.actionPlanCount,
              status: 0,
              event_def_id:ele.dataID,
              type: ele.type
            });
          }
        });
       }
   

          return result;
        }
      });
    }

  };

  return ServerAdaptorMixin;
});

csui.define('xecmpf/utils/contexts/factories/eventactioncenter/eventactioncentercollection',[
  'csui/lib/underscore', 'csui/lib/backbone',
  'xecmpf/utils/contexts/factories/eventactioncenter/eventactioncentercolumncollection',
  'csui/models/mixins/connectable/connectable.mixin',
  'csui/models/mixins/fetchable/fetchable.mixin',
  'csui/models/mixins/v2.additional.resources/v2.additional.resources.mixin',
  'csui/models/mixins/v2.fields/v2.fields.mixin',
  'csui/models/mixins/v2.expandable/v2.expandable.mixin',
  'csui/models/mixins/v2.commandable/v2.commandable.mixin',
  'csui/models/mixins/state.requestor/state.requestor.mixin',
  'csui/models/mixins/v2.delayed.commandable/v2.delayed.commandable.mixin',
  'csui/models/browsable/client-side.mixin', 'csui/models/browsable/v2.response.mixin',
  'csui/models/node/node.model',
  'xecmpf/utils/contexts/factories/eventactioncenter/server.adaptor.mixin',
  'csui/utils/deepClone/deepClone'
], function (_, Backbone, EventActionCenterColumnCollection, ConnectableMixin, FetchableMixin,
    AdditionalResourcesV2Mixin, FieldsV2Mixin, ExpandableV2Mixin, StateRequestorMixin,
    CommandableV2Mixin, DelayedCommandableV2Mixin, ClientSideBrowsableMixin,
    BrowsableV2ResponseMixin, NodeModel, ServerAdaptorMixin) {
  'use strict';

  var EventActionCenterdModel = NodeModel.extend({});

  var EventActionCenterCollection = Backbone.Collection.extend({

    model: EventActionCenterdModel,

    constructor: function EventActionCenterCollection(attributes, options) {
      Backbone.Collection.prototype.constructor.apply(this, arguments);

      if (options) {
        this.options = _.pick(options, ['connector', 'autoreset',
          'includeResources', 'fields', 'expand', 'eventactioncenter']);
      }

      this.makeConnectable(options)
          .makeFetchable(options)
          .makeAdditionalResourcesV2Mixin(options)
          .makeFieldsV2(options)
          .makeExpandableV2(options)
          .makeStateRequestor(options)
          .makeCommandableV2(options)
          .makeClientSideBrowsable(options)
          .makeBrowsableV2Response(options)
          .makeDelayedCommandableV2(options)
          .makeServerAdaptor(options);

      this.columns = new EventActionCenterColumnCollection();
    },

    _prepareModel: function (attrs, options) {
      options || (options = {});
      options.promotedActionCommands = this.promotedActionCommands;
      options.nonPromotedActionCommands = this.nonPromotedActionCommands;
      return Backbone.Collection.prototype._prepareModel.call(this, attrs, options);
    },

    getResourceScope: function () {
      return _.deepClone({
        fields: this.fields,
        expand: this.expand,
        includeResources: this._additionalResources,
        commands: this.commands,
        defaultActionCommands: this.defaultActionCommands
      });
    },

    setResourceScope: function (scope) {
      this.excludeResources();
      scope.includeResources && this.includeResources(scope.includeResources);
      this.resetFields();
      scope.fields && this.setFields(scope.fields);
      this.resetExpand();
      scope.expand && this.setExpand(scope.expand);
      this.resetCommands();
      scope.commands && this.setCommands(scope.commands);
      this.resetDefaultActionCommands();
      scope.defaultActionCommands && this.setDefaultActionCommands(scope.defaultActionCommands);
    }

  });

  ClientSideBrowsableMixin.mixin(EventActionCenterCollection.prototype);
  BrowsableV2ResponseMixin.mixin(EventActionCenterCollection.prototype);
  ConnectableMixin.mixin(EventActionCenterCollection.prototype);
  FetchableMixin.mixin(EventActionCenterCollection.prototype);
  AdditionalResourcesV2Mixin.mixin(EventActionCenterCollection.prototype);
  FieldsV2Mixin.mixin(EventActionCenterCollection.prototype);
  ExpandableV2Mixin.mixin(EventActionCenterCollection.prototype);
  CommandableV2Mixin.mixin(EventActionCenterCollection.prototype);
  DelayedCommandableV2Mixin.mixin(EventActionCenterCollection.prototype);
  ServerAdaptorMixin.mixin(EventActionCenterCollection.prototype);

  return EventActionCenterCollection;

});

csui.define('xecmpf/utils/contexts/factories/eventactioncenter/eventactioncenterfactory',['module', 'csui/lib/underscore', 'csui/lib/backbone',
  'csui/utils/contexts/factories/factory', 'csui/utils/contexts/factories/connector',
  'xecmpf/utils/contexts/factories/eventactioncenter/eventactioncentercollection',
  'csui/utils/commands',
], function (module, _, Backbone, ModelFactory, ConnectorFactory,
    EventActionCenterCollection, commands) {
  'use strict';

  var EventActionCenterFactory = ModelFactory.extend({

    propertyPrefix: 'eventactioncenterfeed',

    constructor: function NotificationCollectionFactory(context, options) {
      ModelFactory.prototype.constructor.apply(this, arguments);

      var eventactioncenterfeed = this.options.eventactioncenterfeed || {};
      if (!(eventactioncenterfeed instanceof Backbone.Model)) {
        var connector = context.getObject(ConnectorFactory, options);

        eventactioncenterfeed = new EventActionCenterCollection(eventactioncenterfeed.models, _.extend(
            {connector: connector},
            eventactioncenterfeed.options,
            {autoreset: true}));
      }
      this.property = eventactioncenterfeed;
    },

    fetch: function (options) {
      return this.property.fetch(options);
    }

  }, {

    getDefaultResourceScope: function () {
      return _.deepClone({
        stateEnabled: true,
        commands: commands.getAllSignatures()
      });
    }

  });

  return EventActionCenterFactory;

});

csui.define('xecmpf/widgets/eac/impl/nls/lang',{
    // Always load the root bundle for the default locale (en-us)
    "root": true,
    // Do not load English locale bundle provided by the root bundle
    "en-us": false,
    "en": false
});

// Defines localizable strings in the default language (English)

csui.define('xecmpf/widgets/eac/impl/nls/root/lang',{
    //New Localization Strings
    dialogTitle: "Event action center",
    emptyListText: "Add new event",
    toolbarItemBack: "Back",
    actionPlan: "Action plan",
    addActionPlan: "Add action plan",
    columnEventName: "Event Name",
    columnSystemName: "System Name",
    columnActionPlan: "Action Plan",
    sourceLabel: "Source",
    rulesLabel: "Rules",
    runAs: "Run as",
    processMode: "Process mode",
    conjunctionAndLabel: "and",
    conjunctionOrLabel: "or",
    operatorEqualtoLabel: "equal to",
    operatorNotequaltoLabel: "not equal to",
    synchronouslyProcessLabel: "Synchronously",
    asynchronouslyProcessLabel: "Asynchronously",
    csObjLabel: "Content Server object",
    evtPropLabel: "Event property",
    prevActLabel: "Result from previous action",
    workspaceLabel: "Parent workspace",
    eventPropLabel: "Event property",
    reminderInitLabel: "Item initiating the event",
    selectSourceForEscalation: "Select source for escalation",
    labelExtendedECMVolume: "Extended ECM",
    saveLabel: "Save",
    cancelLabel: "Cancel",
    deleteActionPlanButton: "Delete",
    deleteActionPlanButtonAria: "Delete action plan",
    actionPlansGroup:"Action plans",
    backTitle: "Back",
    rulesTabLabel: "Rules",
    actionsTabLabel: "Actions",
    processModeTabLabel: "Process mode",
    rulesSetLegend: "Conditions",
    deleteActionPlanConfirmatonTitle: 'Delete action plan',
    deleteActionPlanConfirmatonText: 'Are you sure you want to delete {0}? ',
    newActionPlan: "New action plan",
    actionPlansListHeader: "Action plans",
    createLabel: "Create",
    closeLabel: "Close",
    genericWarningMsgOnDeletion: "Server Error: Unable to perform the action",
    warningMsgOnActionPlanNavigation: "All unsaved changes will be lost. Are you sure you want to continue?",
    actionPlanCreateError: "An item with the name '{0}' already exists.",
    actionPlanNavigationDialogTitle: "Unsaved changes",
    actionAttrParameterNameLabel: "Parameters",
    actionAttrParameterLabel: "Parameter",
    actionAttrSourceLabel: "Source",
    actionAttrValueLabel: "Value",
    actionPlanTitlePlaceholder: "Enter name",
    addToWareHouseFailure: "Failed to add to warehouse",
    requiredField: "This is a required field",
    conjunctionFieldLabel: "Expression",
    fromFieldLabel: "Event properties",
    toFieldLabel: "Value",
    operatorFieldLabel: "Operator",
    configureActionPlanText: "Add a name to start configuring action plan",
    delete:"Delete events",
    addToWareHouse:"Add to warehouse",
    rulesFieldPlaceholder: "Select value",
    Unclassified: "Unclassified",
    Any: "Any",
    Custom: "Custom",
    addEvents: "Add event",
    noReminderTypes : "No reminder types available for the reminder clients",
    reminderClientPlaceholder: "Select client",
    reminderTypePlaceholder: "Select type",
    eventInitDay: "Event initiation day",
    selectSourceForDueDate: "Select source for due date",
    days: "days",
    weeks: "weeks",
    months: "months",
    years: "years",
    selectSourceForAssignee: "Select source for assignee",
    roleLabel: "Role",
    categoryAttrLabel: "Category attribute",
    DependsOn: "Depends on previous action",
    DependsOnText: "Enable to execute current action after the completion of previous action",
    selectDifferentParameter: "Select a different parameter",
    centralWorkspaceTemplateIdPlaceholder: "Enter document template id",
    actions: "Actions",
    ContentServerUser: "Content Server user",
    fromPreviousAction: "From previous action",
    userInput: "User Input",
    Attribute: "Attribute",
    fromDesktop: "From desktop",
    fromShortcut: "Add Shortcut"
});


csui.define('xecmpf/widgets/eac/toolbaritems',[
    'csui/lib/underscore',  
    'i18n!xecmpf/widgets/eac/impl/nls/lang',
    'csui/controls/toolbar/toolitems.factory',
    'csui/controls/toolbar/toolitem.model',
    'csui-ext!csui/widgets/nodestable/toolbaritems'
  ], function (_, lang, ToolItemsFactory,TooItemModel,extraToolItems) {
    'use strict';
  
    var toolbarItems = {
  
      leftToolbar: new ToolItemsFactory(
        {
          main: [          
           
            {
              signature: "EACBack",
              name: lang.toolbarItemBack,
              toolItemAria: lang.ToolbarItemBackAria,
              iconName: "csui_action_back32"
    
            },
            
            {
              signature: "addEvents",
              name: lang.addEvents,
              type: 806,
              iconName: "csui_action_add32",
            },
           
          ]
        }),
  
        tableHeaderToolbar: new ToolItemsFactory({
          info: [
            {signature: "addActionPlan", name: lang.addActionPlan},
            {signature: "addToWarehouse", name: lang.addToWareHouse},
            {signature: "deleteEvent", name: lang.delete}
          ],
        },
        {
          maxItemsShown: 15,
          dropDownIcon: "icon icon-toolbar-more",
          dropDownSvgId: "themes--carbonfiber--image--generated_icons--action_more32",
          dropDownText: lang.ToolbarItemMore,
          addGroupSeparators: false,
          lazyActions: true
        }),
  
        inlineActionbar:  new ToolItemsFactory({
          main: [           
            {
              signature:'addActionPlan',
              name:'Add Action Plan',
              icon: "icon icon-toolbarAdd",
              svgId: "themes--carbonfiber--image--generated_icons--action_add32"
              
            }
          ],
        },
        {
          maxItemsShown: 5,
          dropDownText: lang.ToolbarItemMore,
          dropDownIcon: "icon icon-toolbar-more",
          dropDownSvgId: "themes--carbonfiber--image--generated_icons--action_more32",
          addGroupSeparators: false
        }),


  
  
     
    };

    return toolbarItems;
  });
  


csui.define('xecmpf/widgets/eac/headermenuitems',[
    'csui/lib/underscore',
    'i18n!csui/controls/tabletoolbar/impl/nls/localized.strings',
    'csui/controls/toolbar/toolitems.factory',
    'csui/controls/toolbar/toolitem.model',
    // Load extra tool items to be added to this collection
    'csui-ext!xecmpf/widgets/eac/headermenuitems'
  ], function (_, lang, ToolItemsFactory, TooItemModel, extraMenuItems) {
    'use strict';
  
    var toolbarItems = {
      headerMenuToolbar: new ToolItemsFactory({
            
          },
          {
            maxItemsShown: 0, // force toolbar to immediately start with a drop-down list
            dropDownIcon: "icon icon-expandArrowDown",
            dropDownSvgId: "themes--carbonfiber--image--generated_icons--action_caret_down32"
          }
      )
    };
  
    if (extraMenuItems) {
      _.each(extraMenuItems, function (moduleMenuItems) {
        _.each(moduleMenuItems, function (menuItems, key) {
          var targetToolbar = toolbarItems[key];
          if (!targetToolbar) {
            throw new Error('Invalid target toolbar: ' + key);
          }
          _.each(menuItems, function (menuItem) {
            menuItem = new TooItemModel(menuItem);
            targetToolbar.addItem(menuItem);
          });
        });
      });
    }
  
    toolbarItems.clone = function () {
      return ToolItemsFactory.cloneToolbarItems(this);
    };
  
    return toolbarItems;
  });
  
csui.define('xecmpf/widgets/eac/headermenuitems.mask',['module', 'csui/lib/underscore',
  'csui/controls/toolbar/toolitems.mask',
  'csui/utils/toolitem.masks/global.toolitems.mask'
], function (module, _, ToolItemMask, GlobalMenuItemsMask) {
  'use strict';

  var HeaderMenuItemsMask = ToolItemMask.extend({

    constructor: function HeaderMenuItemsMask() {
      var config = module.config(),
          globalMask = new GlobalMenuItemsMask();
      ToolItemMask.prototype.constructor.call(this, globalMask, {normalize: false});
      // Masks passed in by separate require.config calls are sub-objects
      // stored in the outer object be different keys
      _.each(config, function (source, key) {
        this.extendMask(source);
      }, this);
      // Enable restoring the mask to its initial state
      this.storeMask();
    }

  });

  return HeaderMenuItemsMask;

});


csui.define('css!xecmpf/widgets/eac/impl/eac',[],function(){});
csui.define('xecmpf/widgets/eac/eac.view',["module", "csui/lib/jquery", "csui/lib/underscore", "csui/lib/backbone",
  "csui/lib/marionette", "csui/utils/log", 'csui/utils/base',
  'csui/models/node/node.model',
  'csui/utils/contexts/factories/node',
  'csui/controls/tabletoolbar/tabletoolbar.view',
  'csui/controls/toolbar/toolbar.command.controller',
  'xecmpf/utils/contexts/factories/eventactioncenter/eventactioncentercolumncollection',
  'xecmpf/utils/contexts/factories/eventactioncenter/eventactioncenterfactory',
  'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',
  'csui/controls/mixins/view.state/node.view.state.mixin',
  'csui/controls/mixins/view.state/multi.node.fetch.mixin',
  'csui/controls/mixins/view.state/node.selection.restore.mixin',
  'csui/widgets/nodestable/nodestable.view',
  'csui/utils/commands',
  'csui/controls/globalmessage/globalmessage',
  'xecmpf/widgets/eac/toolbaritems',
  'xecmpf/widgets/eac/headermenuitems',
  'xecmpf/widgets/eac/headermenuitems.mask',
  'i18n!xecmpf/widgets/eac/impl/nls/lang',
  'css!xecmpf/widgets/eac/impl/eac'
], function (module, $, _, Backbone, Marionette, log, base, NodeModel,
    NodeModelFactory, TableToolbarView, ToolbarCommandController,
    EventActionCenterTableColumns, EventActionCenterFactory,
    LayoutViewEventsPropagationMixin,   NodeViewStateMixin,
    MultiNodeFetchMixin, NodeSelectionRestoreMixin,
    NodesTable, commands, GlobalMessage, toolbarItems, headermenuItems, headermenuItemsMask, lang) {
  'use strict';

  var EventActionCenterView = NodesTable.extend({

    constructor: function EventActionCenterView(options) {
      options = _.defaults(options, {
        orderBy: 'name desc',
        tableColumns: new EventActionCenterTableColumns(),
        toolbarItems: toolbarItems,
        headermenuItems: headermenuItems.clone(),
        urlParamsList: [],
        showSelectionCounter: true
      });

      NodesTable.prototype.constructor.apply(this, arguments);
      this.propagateEventsToRegions();

    },
    initialize: function () {

      var that = this;
	  
      this.container = this.options.container || this.context.getModel(NodeModelFactory);

      this.container.set('type', 806);
      this.container.set('name', 'Event action center');

      this.trigger('update:model', this.container);
      this.collection = this.options.collection;
      if (!this.collection) {
        this.collection = this.context.getCollection(EventActionCenterFactory, {
          options: this._restoreCollectionOptionsFromViewState()
        });
      }
  
     
      this.initSelectionMixin(this.options, this.collection);
      this._allCommands = this.defaultActionController.actionItems.getAllCommandSignatures(
          commands);
      this.commandController = new ToolbarCommandController({commands: commands});

      if (this.collection) {
        this.listenTo(this.collection, 'sync', function () {
          // clear selections when collection parent node changes (drilldown)
          this.clearAllSelectedNodes();

        });
      }
      this.listenTo(this.commandController, 'click:toolitem:action', this._toolbarActionTriggered);
      this.listenTo(this.commandController, 'before:execute:command', this._beforeExecuteCommand);
      this.listenTo(this.commandController, 'after:execute:command', this._afterExecuteCommand);
      this.collection.setResourceScope(EventActionCenterFactory.getDefaultResourceScope());
      this.collection.setDefaultActionCommands(this._allCommands);
      this.collection.setEnabledDelayRestCommands(true);

      if (this.collection.delayedActions) {
        this.listenTo(this.collection.delayedActions, 'error',
            function (collection, request, options) {
              var error = new base.Error(request);
              GlobalMessage.showMessage('error', error.message);
            });
      }

      this.columns = this.collection.columns ||
                     this.context.getCollection(EventActionCenterFactory);

      this.columns = this.collection.columns;

      this._setToolBar();

      this.setTableView({
        orderBy: this.options.orderBy,
        filterBy: this.options.filterBy,
        nameEdit: false,
        haveDetailsRowExpandCollapseColumn: false,
        showSelectionCounter: true,
        tableColumns: this.options.tableColumns,
        tableTexts: {
          zeroRecords: lang.emptyListText
        }
      });

      this.tableView.listenTo(this.tableView, 'clicked:cell', function (event) {  
        var winEvent = window.event;
        if (event.colIndex !== 0 && !($(winEvent.target).hasClass('icon-toolbarAdd'))) {
          this.triggerMethod('execute:defaultAction', event.model);
        }            
      });
      var self = this;
      this.tableView.$el.on('keydown', function (event) {
        if (event.originalEvent.keyCode === 13) {
          for(var i=0; i< self.collection.length; i++) {
            if((event.target.getAttribute('aria-label') === self.collection.models[i].get('system_name') && $(event.target).siblings('.csui-table-cell-generic-text[data-csui-attribute="name"]').attr('aria-label') === self.collection.models[i].get('name')) || 
              (event.target.getAttribute('aria-label') === self.collection.models[i].get('name') && $(event.target).siblings('.csui-table-cell-generic-text[data-csui-attribute="system_name"]').attr('aria-label') === self.collection.models[i].get('system_name')) ||
              (event.target.getAttribute('aria-label') === self.collection.models[i].get('action_plan_text') && $(event.target).siblings('.csui-table-cell-generic-text[data-csui-attribute="name"]').attr('aria-label') === self.collection.models[i].get('name') &&
              $(event.target).siblings('.csui-table-cell-generic-text[data-csui-attribute="system_name"]').attr('aria-label') === self.collection.models[i].get('system_name'))){
              self.triggerMethod('execute:defaultAction', self.collection.models[i]);
            }
          }
        } 
      });

      this.listenTo(this.tableView, 'render', function () {
        this.$el.remove('.csui-table-empty-default');
        if (this.tableView.tableBodyView) { 
          this.tableView.tableBodyView.accFocusedCell.column = 1;
        }
        if(this.tableView.collection.length === 0) {
          this.$el.find('.icon-toolbarAdd').prop('tabindex','0');
          this.$el.find('.icon-toolbarAdd').trigger('focus');
        }
        if (this.tableView.collection.length > 1) {
          var isInlineForm = this.tableView.$el.find(".csui-table-row-shows-inlineform");
          if (isInlineForm.length) {
            isInlineForm.find("td.csui-inlineform-parent").attr("colspan", 3);
          }
        }
        if (this.tableView.collection.length === 0) {
          this.$el.find('thead button').hide();
        }
        else {
          this.$el.find('thead button').show();
        }
        // place holder for further use
      });
      this._setTableRowSelectionToolbarEventListeners();
      this.setPagination();
      if (this.options.collection) {
        this.collection.fetched = false;
      }
    },

    // Toolbar view
    _setToolBar: function () {
      var parentNode = new NodeModel({id: undefined},
          {connector: this.collection.connector});
      this.collection.node = parentNode;
      this.tableToolbarView = new TableToolbarView({
        context: this.options.context,
        toolbarItems: this.options.toolbarItems,
        headermenuItems: this.options.headermenuItems,
        headermenuItemsMask: this.options.headermenuItemsMask,
        container: this.container,
        collection: this.collection,
        originatingView: this,
        blockingParentView: this.options.blockingParentView || this,
        addableTypes: this.addableTypes,
        toolbarCommandController: this.commandController
      });
    }
    
  });


  _.extend(EventActionCenterView.prototype, LayoutViewEventsPropagationMixin);
  _.extend(EventActionCenterView.prototype, NodeViewStateMixin);
  _.extend(EventActionCenterView.prototype, MultiNodeFetchMixin);
  _.extend(EventActionCenterView.prototype, NodeSelectionRestoreMixin);

  return EventActionCenterView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/integration/folderbrowse/modaldialog/impl/modal.dialog',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"binf-modal-dialog binf-modal-lg\">\r\n  <div class=\"binf-modal-content\">\r\n    <div class=\"xecm-modal-header\">\r\n      <div title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"closeToolTip") || (depth0 != null ? lookupProperty(depth0,"closeToolTip") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"closeToolTip","hash":{},"loc":{"start":{"line":4,"column":18},"end":{"line":4,"column":34}}}) : helper)))
    + "\"\r\n          class=\"cs-close\" tabindex=\"0\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"closeToolTip") || (depth0 != null ? lookupProperty(depth0,"closeToolTip") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"closeToolTip","hash":{},"loc":{"start":{"line":5,"column":52},"end":{"line":5,"column":68}}}) : helper)))
    + "\" role=\"button\">\r\n        "
    + ((stack1 = (lookupProperty(helpers,"icon-v2")||(depth0 && lookupProperty(depth0,"icon-v2"))||container.hooks.helperMissing).call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"icon-v2","hash":{"states":"true","theme":(depth0 != null ? lookupProperty(depth0,"iconTheme") : depth0),"iconName":"csui_action_minimize32"},"loc":{"start":{"line":6,"column":8},"end":{"line":6,"column":85}}})) != null ? stack1 : "")
    + "\r\n      </div>\r\n    </div>\r\n    <div class=\"binf-modal-body\"></div>\r\n  </div>\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_widgets_integration_folderbrowse_modaldialog_impl_modal.dialog', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/integration/folderbrowse/modaldialog/impl/modal.dialog',[],function(){});
csui.define('xecmpf/widgets/integration/folderbrowse/modaldialog/modal.dialog.view',['csui/lib/underscore', 'csui/controls/dialog/dialog.view',
  'hbs!xecmpf/widgets/integration/folderbrowse/modaldialog/impl/modal.dialog',
  'i18n!xecmpf/widgets/integration/folderbrowse/impl/nls/localized.strings',
  'css!xecmpf/widgets/integration/folderbrowse/modaldialog/impl/modal.dialog',
  'csui/controls/icons.v2'
], function (_, DialogView, Template, Lang) {
  var ModalDialogView = DialogView.extend({
    template: Template,
    templateHelpers: function () {
      return {
        closeToolTip: Lang.CloseToolTip,
        iconName: this._iconName,
        iconTheme: this.options.useIconsForDarkBackground ? 'dark' : ''
      };
    },

    events: function(){
      return _.extend({},DialogView.prototype.events,{
        'keypress .cs-close' : 'onKeyPress'
      });
    },

    onKeyPress: function (event) {
      var keyCode = event.keyCode;

      //Enter/space
      if (keyCode === 13 || keyCode === 32) {
        event.preventDefault();
        event.stopPropagation();
        this.destroy();
      }
    }
  });
  return ModalDialogView;
});
csui.define('xecmpf/utils/table/inlineforms/eventactioncenter/factories/server.adaptor.mixin',[
  'csui/lib/underscore',
  'csui/utils/url'
], function (_, Url) {
  'use strict';

  var ServerAdaptorMixin = {
    mixin: function (prototype) {
      return _.extend(prototype, {
        makeServerAdaptor: function (options) {
          return this;
        },

        url: function (options) {

          var restUrl = Url.combine(this.connector.getConnectionUrl().getApiBase('v2'),
              'eventactioncenter/eventdefinitions');
          return restUrl;

        },

        parse: function (response) {
          this.options.fetched = false;
          var rs = {};
          rs.data = {};
          for (var key in response.results.data) {
            var results = response.results.data[key].filter(function (res) {
              return res.status === 0;
            });
            rs.data[key] = results;

          }
          return rs;

        }
      });
    }

  };

  return ServerAdaptorMixin;
});

csui.define('xecmpf/utils/table/inlineforms/eventactioncenter/factories/eventfeedmodel',[
    'csui/lib/underscore', 'csui/lib/backbone',
    'csui/models/mixins/connectable/connectable.mixin',
    'csui/models/mixins/fetchable/fetchable.mixin',
    'csui/models/mixins/v2.additional.resources/v2.additional.resources.mixin',
    'csui/models/mixins/v2.fields/v2.fields.mixin',
    'csui/models/mixins/v2.expandable/v2.expandable.mixin',
    'csui/models/mixins/v2.commandable/v2.commandable.mixin',
    'csui/models/mixins/state.requestor/state.requestor.mixin',
    'csui/models/mixins/v2.delayed.commandable/v2.delayed.commandable.mixin',
    'csui/models/browsable/client-side.mixin', 'csui/models/browsable/v2.response.mixin',   
    'csui/models/node/node.model', 
     'xecmpf/utils/table/inlineforms/eventactioncenter/factories/server.adaptor.mixin'
], function (_, Backbone, ConnectableMixin, FetchableMixin,
             AdditionalResourcesV2Mixin, FieldsV2Mixin, ExpandableV2Mixin, StateRequestorMixin,
             CommandableV2Mixin, DelayedCommandableV2Mixin, ClientSideBrowsableMixin,
             BrowsableV2ResponseMixin, NodeModel,ServerAdaptorMixin) {
    'use strict';


    var EventFeedModel = NodeModel.extend({

    });

    var EventFeedCollection = Backbone.Collection.extend({

        model: EventFeedModel,

        constructor: function EventFeedCollection(attributes, options) {
            Backbone.Collection.prototype.constructor.apply(this, arguments);

            // Support collection cloning
            if (options) {
                this.options = _.pick(options, ['connector', 'autoreset',
                    'includeResources', 'fields', 'expand', 'eventfeed']);
            }

            this.makeConnectable(options)
                .makeFetchable(options)
                .makeAdditionalResourcesV2Mixin(options)
                .makeFieldsV2(options)
                .makeExpandableV2(options)
                .makeStateRequestor(options)
                .makeCommandableV2(options)
                .makeClientSideBrowsable(options)
                .makeBrowsableV2Response(options)
                .makeDelayedCommandableV2(options)
                .makeServerAdaptor(options);

               // this.columns = new EventFeedColumnCollection();
        },

        _prepareModel: function (attrs, options) {
            options || (options = {});
            options.promotedActionCommands = this.promotedActionCommands;
            options.nonPromotedActionCommands = this.nonPromotedActionCommands;
            return Backbone.Collection.prototype._prepareModel.call(this, attrs, options);
        },

        getResourceScope: function () {
            return _.deepClone({
                fields: this.fields,
                expand: this.expand,
                includeResources: this._additionalResources,
                commands: this.commands,
                defaultActionCommands: this.defaultActionCommands
            });
        },

        setResourceScope: function (scope) {
            this.excludeResources();
            scope.includeResources && this.includeResources(scope.includeResources);
            this.resetFields();
            scope.fields && this.setFields(scope.fields);
            this.resetExpand();
            scope.expand && this.setExpand(scope.expand);
            this.resetCommands();
            scope.commands && this.setCommands(scope.commands);
            this.resetDefaultActionCommands();
            scope.defaultActionCommands && this.setDefaultActionCommands(scope.defaultActionCommands);
        }

    });

    
    ClientSideBrowsableMixin.mixin(EventFeedCollection.prototype);
    BrowsableV2ResponseMixin.mixin(EventFeedCollection.prototype);
    ConnectableMixin.mixin(EventFeedCollection.prototype);
    FetchableMixin.mixin(EventFeedCollection.prototype);
    AdditionalResourcesV2Mixin.mixin(EventFeedCollection.prototype); 
    FieldsV2Mixin.mixin(EventFeedCollection.prototype);
    ExpandableV2Mixin.mixin(EventFeedCollection.prototype);    
    CommandableV2Mixin.mixin(EventFeedCollection.prototype);
    DelayedCommandableV2Mixin.mixin(EventFeedCollection.prototype);
    ServerAdaptorMixin.mixin(EventFeedCollection.prototype);

    return EventFeedCollection;

});

csui.define('xecmpf/utils/table/inlineforms/eventactioncenter/factories/event.factory',['module', 'csui/lib/underscore', 'csui/lib/backbone',
    'csui/utils/contexts/factories/factory', 'csui/utils/contexts/factories/connector',
    'xecmpf/utils/table/inlineforms/eventactioncenter/factories/eventfeedmodel', 'csui/utils/commands',
], function (module, _, Backbone, ModelFactory, ConnectorFactory,
             EventFeedModel, commands ) {
    'use strict';

    var EventCollectionFactory = ModelFactory.extend({

        propertyPrefix: 'eventfeed',

        constructor: function EventCollectionFactory(context, options) {
            ModelFactory.prototype.constructor.apply(this, arguments);

            var eventfeed = this.options.eventfeed || {};
            if (!(eventfeed instanceof Backbone.Model)) {
                var connector = context.getObject(ConnectorFactory, options);
                   
                eventfeed = new EventFeedModel(eventfeed.models, _.extend(
                    {connector: connector},
                    eventfeed.options,
                    //  NotificationCollectionFactory.getDefaultResourceScope(),
                    {autoreset: true}));
            }
            this.property = eventfeed;
            this.property.fetched = false;
        },

        fetch: function (options) {
            return this.property.fetch(options);
        }

    }, {

        getDefaultResourceScope: function () {
            return _.deepClone({               
                stateEnabled: true,              
                commands: commands.getAllSignatures()
            });
        }


    });

    return EventCollectionFactory;

});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/utils/table/inlineforms/eventactioncenter/impl/event',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "            <option tabindex=\"0\"><a data-id=\""
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\" title=\""
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"attributes") : depth0)) != null ? lookupProperty(stack1,"event_name") : stack1), depth0))
    + "\">"
    + container.escapeExpression(container.lambda(depth0, depth0))
    + "</a></option>      \r\n        \r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"csui-inlineform-group\">\r\n  <div data-csui-attribute=\"system_name\">\r\n    <select class=\"xecmpf-eac-inlineform-select icon-caret-down\" tabindex=\"0\" >  \r\n      \r\n"
    + ((stack1 = lookupProperty(helpers,"each").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"eventproperties") : depth0),{"name":"each","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"loc":{"start":{"line":5,"column":10},"end":{"line":8,"column":19}}})) != null ? stack1 : "")
    + "    </select>\r\n  </div>  \r\n  <div data-csui-attribute=\"name\">\r\n    <select  id=\"xecmpf-eac-inlineform-options\" class=\"xecmpf-eac-inlineform-options icon-caret-down\" tabindex=\"0\">\r\n              <!-- populated using JavaScript -->\r\n              <option value=\"Select Event\" tabindex=\"0\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"selectEvent") || (depth0 != null ? lookupProperty(depth0,"selectEvent") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"selectEvent","hash":{},"loc":{"start":{"line":14,"column":56},"end":{"line":14,"column":71}}}) : helper)))
    + "</option>\r\n    </select>\r\n    <div class=\"xecmpf-eac xecmpf-inline-action-container \">\r\n      <button type=\"button\" class=\"csui-btn-save csui-btn binf-btn\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"add") || (depth0 != null ? lookupProperty(depth0,"add") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"add","hash":{},"loc":{"start":{"line":17,"column":68},"end":{"line":17,"column":75}}}) : helper)))
    + "</button>\r\n      <button type=\"button\" class=\"csui-btn-cancel csui-btn binf-btn\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"cancel") || (depth0 != null ? lookupProperty(depth0,"cancel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"cancel","hash":{},"loc":{"start":{"line":18,"column":70},"end":{"line":18,"column":80}}}) : helper)))
    + "</button>\r\n    </div>\r\n  </div>\r\n</div>\r\n<div class=\"csui-inlineform-group csui-inlineform-group-error binf-hidden\">\r\n  <div class=\"binf-text-danger\"><span class=\"csui-text-danger\"></span></div>\r\n</div>\r\n";
}});
Handlebars.registerPartial('xecmpf_utils_table_inlineforms_eventactioncenter_impl_event', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/utils/table/inlineforms/eventactioncenter/impl/event',[],function(){});
csui.define('xecmpf/utils/table/inlineforms/eventactioncenter/eventactioncenter.view',[
  'csui/lib/jquery',
  'csui/lib/underscore',
  "csui/lib/marionette",
  'csui/controls/table/inlineforms/inlineform.registry',
  'csui/controls/table/inlineforms/inlineform/impl/inlineform.view',
  'csui/behaviors/keyboard.navigation/tabkey.behavior',
  'csui/controls/icon/icon.view',
  'xecmpf/utils/table/inlineforms/eventactioncenter/factories/event.factory',
  "hbs!xecmpf/utils/table/inlineforms/eventactioncenter/impl/event",
  'i18n!xecmpf/utils/commands/nls/localized.strings',
  "css!xecmpf/utils/table/inlineforms/eventactioncenter/impl/event",

], function ($, _, Marionette, inlineFormViewRegistry, InlineFormView, TabKeyBehavior,  IconView, EventFeedCollectionFactory,
    template, lang) {

  var InlineFormEventView = InlineFormView.extend({

        className: function () {
          var className = "xecmpf-eac-inlineform-eac";
          if (InlineFormView.prototype.className) {
            className += ' ' + _.result(InlineFormView.prototype, 'className');
          }
          return className;
        },

        template: template,

        templateHelpers: function () {
          if (!!this.arrayofleadingsys && this.arrayofleadingsys.length > 0) {            
            this.Select_List_Data = {
              'choices': { // name of associated select box
                // names match option values in controlling select box
                'Select source': {
                  text: [lang.selectEvent],
                  value: [lang.selectEvent]
                }
              }

            };
            this.Select_List_Data = JSON.parse(JSON.stringify(this.Select_List_Data).replace('Select source', lang.selectSource));
            //loop through leading systems to push objects:
            for (var temp = 0; temp < this.arrayofleadingsys.length; temp++) {
              this.Select_List_Data['choices'][this.arrayofleadingsys[temp].key[temp]] =

              {
                "text": this.arrayofleadingsys[temp].value,
                "value": this.arrayofleadingsys[temp].EventIds
              }
            }

            this.enumobjs = Object.keys(this.Select_List_Data.choices);
          }

          return {
            eventproperties: this.enumobjs ? this.enumobjs : {},
            errorMessage: this.errorMessage,
            haveErrorMessage: this.haveErrorMessage,
            add: lang.add,
            cancel: lang.cancel,
            selectEvent: lang.selectEvent
          };

        },

        ui: {
          'selectBox': '.xecmpf-eac-inlineform-select',
          'selectEvent':'.xecmpf-eac-inlineform-options'

        },
        events: {
          'change @ui.selectBox': 'onChangeSelectBox',
          'change @ui.selectEvent': 'onChangeSelectEvent',
          'keydown @ui.selectEvent': 'keyReleased',
          'keydown': 'onKeyInView'
        },

        behaviors: {
          TabKeyBehavior: {
            behaviorClass: TabKeyBehavior
          }
        },

        // preparing array of Values

        onDomRefresh: function () {
          if (!!this.$el.find('xecmpf-eac-inlineform-eac')) {          
            $('.csui-table-empty').removeClass('xecmpf-table-empty');

          }
          this.updateSaveButtonDisableStatus(true);
          this.refreshTabableElements();
          !!this.tabableElements && !!this.tabableElements[0] &&
          $(this.tabableElements[0]).trigger('focus');
        },

        keyReleased: function () {
          this.refreshTabableElements();
        },

        onKeyInView: function (event) {
          if (event.keyCode === 9) {
            this._moveTab(event);
            return true;
          }
        },

        refreshTabableElements: function () {
          this.tabableElements = this.$el.find('select:not([disabled]),  button:not([disabled])').filter(
              ':visible').toArray();
        },

        _moveTab: function (event) {
          this.currentlyFocusedElementIndex = this.tabableElements.indexOf(event.target);
          if (event.shiftKey) {
            if (this.currentlyFocusedElementIndex > 0) {
              this.currentlyFocusedElementIndex -= 1;
              $(this.tabableElements[this.currentlyFocusedElementIndex]).trigger('focus');
            } else {
              this.currentlyFocusedElementIndex = this.tabableElements.length - 1;
              $(this.tabableElements[this.currentlyFocusedElementIndex]).trigger('focus');
            }
          } else {
            if (this.currentlyFocusedElementIndex < this.tabableElements.length - 1) {
              this.currentlyFocusedElementIndex += 1;
              $(this.tabableElements[this.currentlyFocusedElementIndex]).trigger('focus');
            } else {
              this.currentlyFocusedElementIndex = 0;
              $(this.tabableElements[this.currentlyFocusedElementIndex]).trigger('focus');
            }
          }
          event.stopPropagation();
          event.preventDefault();
        },

        onChangeSelectEvent: function(event) {
          if (event.target.value !== "0") {
            this.updateSaveButtonDisableStatus(false);
          } else {
            this.updateSaveButtonDisableStatus(true);
          }
        },

        onChangeSelectBox: function (event) {
          !!this.collection && !this.collection.fetched && this.collection.fetch();
          this.sel = document.getElementById('xecmpf-eac-inlineform-options');
          this.options = this.Select_List_Data['choices'][event.target.value];
          this.removeAllOptions(this.sel);
          this.updateSaveButtonDisableStatus(true);
          if (this.options.text.length === 1 && event.target.value !== lang.selectSource) {
            this.haveErrorMessage = true;
            this.errorMessage = lang.NoLeadingSys;
            this.$el.addClass('csui-form-error');
            this.$el.find('.csui-inlineform-group-error').removeClass('binf-hidden');
            this.$el.find('.binf-text-danger').attr('role', 'alert');
            this.$el.find('.csui-text-danger').text(this.errorMessage);
          } else {
            this.$el.removeClass('csui-form-error');
            this.$el.find('.csui-inlineform-group-error').addClass('binf-hidden');
          }
          if (event.target.value !== lang.selectSource) {
            this.ui.selectEvent.prop('disabled', false);
          }
          else {
            this.ui.selectEvent.prop('disabled', true);
          }
          this.refreshTabableElements();
          this.appendDataToSelect(this.sel, this.options);

        },

        /**
         * Function: updateSaveButtonDisableStatus
         * Description: disable or enable save button based on parameter value
         */
        updateSaveButtonDisableStatus: function(disableIt) {
          var $saveBtn = this.$el.find('.xecmpf-inline-action-container .csui-btn-save');
          $saveBtn.prop('disabled', disableIt);
        },

        constructor: function InlineFormEventView(options) {
          this.options = options || {};
          this.iconSaveState = false;
          this.saveEditIconView = new IconView({iconName: 'csui_action_input_confirm_disable', size: 'small'});
          this.cancelEditIconView = new IconView({iconName: 'csui_action_input_cancel', size: 'small'});
          // extend the base class ui and events hashes
          this.ui = _.extend({}, this.ui, InlineFormView.prototype.ui);
          this.events = _.extend({}, this.events, InlineFormView.prototype.events);
          this.select_box = $('.xecmpf-eac-inlineform-select');
          this.collection = options.context.getCollection(EventFeedCollectionFactory, {});
          this.listenTo(this.collection, 'sync', this._fetchingEventFeed);
          this.listenTo(this.options.model.collection, 'sync', this._fetchingEventStatusFeed);
          !this.collection.fetched && this.collection.fetch();
          Marionette.ItemView.prototype.constructor.apply(this, arguments);
        },

        onRender: function(){
          this.ui.selectEvent.prop('disabled', true);
        },

        _fetchingEventStatusFeed: function () {
           // preparing array of Values for Each Leading System when landing page loads
          this.arrayofleadingsys = [];
          this.collection = !!this.options.model && this.options.model.collection;
          if (!!this.collection) {
            var models_len = this.collection.models.length;
            for (var tempmodels = 0; tempmodels < models_len; tempmodels++) {
              var leading_sys = Object.keys(this.collection.models[tempmodels].attributes.data);
              var sys_len = leading_sys.length;
              for (var tempsys = 0; tempsys < sys_len; tempsys++) {
                var length_of_values = this.collection.models[tempmodels].attributes.data[leading_sys[tempsys]].length;
                var arrayofele = [];
                var arrayofEvents = [0];
                arrayofele.push(lang.selectEvent);               
                for (var tempvalues = 0; tempvalues < length_of_values; tempvalues++) {
                  arrayofele.push(
                      this.collection.models[tempmodels].attributes.data[leading_sys[tempsys]][tempvalues].name);
                  arrayofEvents.push(
                      this.collection.models[tempmodels].attributes.data[leading_sys[tempsys]][tempvalues].dataID);
                }
                this.arrayofleadingsys.push({
                  key: leading_sys,
                  value: arrayofele,
                  EventIds: arrayofEvents

                });
              }

            }

          }

          this.render();

        },

        _fetchingEventFeed: function () {
           // preparing array of Values for updated Landing Page
          this.arrayofleadingsys = [];
          var len_models = this.collection.models.length;
          for (var modelItr = 0; modelItr < len_models; modelItr++) {
            var leading_sys_name = Object.keys(this.collection.models[modelItr].attributes.data); 
            var len_led_sys = leading_sys_name.length;
            for (var leadingsysitr = 0; leadingsysitr < len_led_sys; leadingsysitr++) {
              var len_of_values = this.collection.models[modelItr].attributes.data[leading_sys_name[leadingsysitr]].length;
              var arrayofelements = [];
              var arrayofEventIds = [0];
              arrayofelements.push(lang.selectEvent);             
              for (var eachsystem = 0; eachsystem < len_of_values; eachsystem++) {

                if (this.collection.models[modelItr].attributes.data[leading_sys_name[leadingsysitr]][eachsystem].status === 0) {
                  arrayofelements.push(
                      this.collection.models[modelItr].attributes.data[leading_sys_name[leadingsysitr]][eachsystem].name);
                  arrayofEventIds.push(
                      this.collection.models[modelItr].attributes.data[leading_sys_name[leadingsysitr]][eachsystem].dataID);
                }

              }
              this.arrayofleadingsys.push({
                key: leading_sys_name,
                value: arrayofelements,
                EventIds: arrayofEventIds

              });

            }

          }

          this.render();

        },

        appendDataToSelect: function (sel, obj) {

          var f = document.createDocumentFragment();
          var optEle, i, objlen = obj.text.length;

          for (i = 0; i < objlen; i++) {
            optEle = document.createElement('option');
            optEle.appendChild(document.createTextNode(obj.text[i]));

            if (obj.value) {
              optEle.value = obj.value[i];
            }

            f.appendChild(optEle);
          }
          sel.appendChild(f);

        },

        removeAllOptions: function (sel) {
          var len, par;
          len = sel.options.length;
          for (var i = len; i; i--) {
            par = sel.options[i - 1].parentNode;
            par.removeChild(sel.options[i - 1]);
          }
        },

        cancelClicked: function (event) {
          event.preventDefault();
          event.stopPropagation();
          //this.model.destroy();
          this.collection.fetch();

          this.cancel();
        },

        saveClicked: function () {
          if (this.sel.value) {
            this.model.set('id', this.sel.value);
            this.model.set('action_plan_text', lang.noPlans);
            this._save({id: this.sel.value, status: 1}).fail(function () {
              this.model.set('csuiInlineFormErrorMessage', lang.SaveFailError);
            }.bind(this));
          }
        },

       getAddableCommandInfo: function () {
          return {
            signature: "addEvents"
          };
        }
      },
      {
        CSSubType: 806
      }
  );

  inlineFormViewRegistry.registerByAddableType(
      InlineFormEventView.CSSubType,
      InlineFormEventView);

  return InlineFormEventView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/table/cells/node.state/impl/external.document.icons',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"tooltip") || (depth0 != null ? lookupProperty(depth0,"tooltip") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"tooltip","hash":{},"loc":{"start":{"line":2,"column":13},"end":{"line":2,"column":24}}}) : helper)))
    + "\"> "
    + ((stack1 = (lookupProperty(helpers,"icon-v2")||(depth0 && lookupProperty(depth0,"icon-v2"))||container.hooks.helperMissing).call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"icon-v2","hash":{"iconName":(depth0 != null ? lookupProperty(depth0,"icon") : depth0)},"loc":{"start":{"line":2,"column":27},"end":{"line":2,"column":54}}})) != null ? stack1 : "")
    + " </span>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"icon") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"loc":{"start":{"line":1,"column":0},"end":{"line":3,"column":7}}})) != null ? stack1 : "");
}});
Handlebars.registerPartial('xecmpf_controls_table_cells_node.state_impl_external.document.icons', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/controls/table/cells/node.state/impl/nls/lang',{
    // Always load the root bundle for the default locale (en-us)

    // Do not load English locale bundle provided by the root bundle
    "en-us": false,
    "en": false,
    "root": true
  });

// Defines localizable strings in the default language (English)

csui.define('xecmpf/controls/table/cells/node.state/impl/nls/root/lang',{
  sap_al: "External document from SAP AL",
  sap_cmis: "External document from an SAP system",
  sap_dms: "External document from SAP DMS",
  sfsf_cmis: "External document from SAP SuccessFactors",
  sap : "External document from SAP"
  });

csui.define('xecmpf/controls/table/cells/node.state/cmis.icon/cmis.node.state.icon',['module', 'csui/lib/marionette',
    'hbs!xecmpf/controls/table/cells/node.state/impl/external.document.icons',
    'i18n!xecmpf/controls/table/cells/node.state/impl/nls/lang',
    'csui/controls/icons.v2'
], function (module, Marionette, template, lang,  iconRegistry) {

    var ExternalDocument_NodeStateView = Marionette.ItemView.extend({
        tagName: 'li',
        className: 'csui-node-state-cmis',
        template: template,

        constructor: function ExternalDocument_NodeStateView() {
            Marionette.ItemView.prototype.constructor.apply(this, arguments);
        },

        templateHelpers: function () {
            var externalSource = false;

            if (this.model.attributes && this.model.attributes.data && this.model.attributes.data["external_source"]) {
                externalSource = this.model.attributes.data["external_source"];
            }

            var data = { icon: "", toolTip: "" };

            if (externalSource) {

                var tooltip = lang[externalSource];
                if(iconRegistry._icons[externalSource]) {
                    data = {
                        icon: externalSource,
                        tooltip: tooltip
                    };
                }
            }

            return data;
        }


    },
        {
            enabled: function (status) {
                var enabled = false;

                if (status && status.node && status.node.attributes &&
                            status.node.attributes.data && status.node.attributes.data["external_source"]) {
                    enabled = true;
                }

                return enabled;
            }
        });

    // return [
    //     {
    //         sequence: 30,
    //         iconView: ExternalDocument_NodeStateView
    //     }
    // ];
        return ExternalDocument_NodeStateView;
});

csui.define('xecmpf/models/workflows/server.adaptor.mixin',[
  'csui/lib/underscore', 'csui/utils/url'
], function (_, Url) {
  'use strict';

  var ServerAdaptorMixin = {
    mixin: function (prototype) {
      return _.extend(prototype, {
        makeServerAdaptor: function (options) {
          return this;
        },
        url: function () {

          var url   = this.options.node.connector.getConnectionUrl().getApiBase('v2'),
              query = Url.combineQueryString(
                  {
                    status: this.options.status
                  }
              );
          return Url.combine(url, 'nodes/xecmpfappintgn/workflows', this.options.node.get('id'),
              "?" + query);
        },

        parse: function (response, options) {

          _.each(response.results, function (workflow) {
            workflow.type = '678'; // TODO: update it from RestAPI
            workflow.inactive = false;
            workflow.id = workflow.WorkflowID;
            workflow.defaultActionUrl = workflow.OpenURL
          });

          this.columns && this.columns.resetColumnsV2(response, this.options);

          return response.results;
        },

        isFetchable: function () {
          return !!this.options;
        },

      });
    }

  };

  return ServerAdaptorMixin;
});
csui.define('xecmpf/models/workflows/metadata.workflow.collection',['csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/backbone',
  'csui/models/mixins/connectable/connectable.mixin',
  'csui/models/mixins/fetchable/fetchable.mixin',
  'csui/models/browsable/client-side.mixin',
  'csui/models/browsable/v1.request.mixin',
  'xecmpf/models/workflows/server.adaptor.mixin',
  'csui/models/nodechildrencolumn',
  'csui/models/nodechildrencolumns',
  'csui/models/node/node.model'
], function (_, $, Backbone, ConnectableMixin, FetchableMixin, ClientSideBrowsableMixin,
    BrowsableV1RequestMixin, ServerAdaptorMixin, NodeChildrenColumnModel,
    NodeChildrenColumnCollection, NodeModel) {

  var workflow = {
    WorkflowTitle: 'WorkflowTitle',
    WorkflowStatusName: 'workflowStatusName',
    ModifiedByName: 'ModifiedByName',
    InitiatedDate: 'InitiatedDate',
    InitiatedByName: 'InitiatedByName',
    dateType: -7
  };

  var WorkflowColumnModel = NodeChildrenColumnModel.extend({

    constructor: function WorkflowColumnModel(attributes, options) {
      NodeChildrenColumnModel.prototype.constructor.call(this, attributes, options);
    }
  });

  var WorkflowColumnCollection = NodeChildrenColumnCollection.extend({

    model: WorkflowColumnModel,

    resetColumnsV2: function (response, options) {
      if (!this.models.length) {// Stopping reset as event data is static and doesn't change after first fetch
        this.resetCollection(this.getV2Columns(response), options);
      }
    },

    getColumnModels: function (columnKeys, definitions) {
      var columns = NodeChildrenColumnCollection.prototype.getColumnModels.call(
          this, columnKeys, definitions);
      _.each(columns, function (column) {
        var columnKey = column['column_key'];
        column.sort = true;

        if (columnKey === 'WorkflowTitle') {
          column.default_action = true;
        }
      });
      return columns;
    },

    getV2Columns: function (response) {

      var definitions  = {},
          workflowKeys = Object.keys(workflow);
      _.each(workflowKeys, function (column) {
        definitions[column] = {};
        definitions[column].key = workflow[column];
      });

      definitions.InitiatedDate.type = workflow.dateType;

      var columnKeys = _.keys(definitions);
      return this.getColumnModels(columnKeys, definitions);
    }

  });

  var WorkflowModel = NodeModel.extend({});

  var WorkflowCollection = Backbone.Collection.extend({

    model: WorkflowModel,

    constructor: function WorkflowCollection(models, options) {
      this.options = options || {};
      Backbone.Collection.prototype.constructor.call(this, models, options);

      this.makeConnectable(options)
          .makeFetchable(options)
          .makeBrowsable(options)
          .makeBrowsableV1Request(options)
          .makeServerAdaptor(options);

      this.columns = new WorkflowColumnCollection();
    }

  });

  ConnectableMixin.mixin(WorkflowCollection.prototype);
  FetchableMixin.mixin(WorkflowCollection.prototype);
  ClientSideBrowsableMixin.mixin(WorkflowCollection.prototype);
  BrowsableV1RequestMixin.mixin(WorkflowCollection.prototype);
  ServerAdaptorMixin.mixin(WorkflowCollection.prototype);

  return WorkflowCollection;

});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/table/cells/node.state/impl/workflow.node.state',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<button type=\"button\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"workflow") || (depth0 != null ? lookupProperty(depth0,"workflow") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"workflow","hash":{},"loc":{"start":{"line":1,"column":34},"end":{"line":1,"column":46}}}) : helper)))
    + "\" class=\"csui-workflow-button csui-workflow-cellview\">\r\n  <span title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"workflow") || (depth0 != null ? lookupProperty(depth0,"workflow") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"workflow","hash":{},"loc":{"start":{"line":2,"column":15},"end":{"line":2,"column":27}}}) : helper)))
    + "\" class=\"csui-icon-workflow\"> "
    + ((stack1 = (lookupProperty(helpers,"icon-v2")||(depth0 && lookupProperty(depth0,"icon-v2"))||container.hooks.helperMissing).call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"icon-v2","hash":{"size":"small","iconName":"status_workflow24"},"loc":{"start":{"line":2,"column":57},"end":{"line":2,"column":112}}})) != null ? stack1 : "")
    + " </span>\r\n</button>";
}});
Handlebars.registerPartial('xecmpf_controls_table_cells_node.state_impl_workflow.node.state', t);
return t;
});
/* END_TEMPLATE */
;

/* START_TEMPLATE */
csui.define('hbs!xecmpf/utils/commands/workflows/dialog/header',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<h2 class=\"binf-modal-title\">\r\n  <!--todo add icon if needed -->\r\n  <span class=\"title-text workflow-dialog-title\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"title") || (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"title","hash":{},"loc":{"start":{"line":3,"column":56},"end":{"line":3,"column":65}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"title") || (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"title","hash":{},"loc":{"start":{"line":3,"column":67},"end":{"line":3,"column":76}}}) : helper)))
    + "</span>\r\n</h2>\r\n";
}});
Handlebars.registerPartial('xecmpf_utils_commands_workflows_dialog_header', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/utils/commands/workflows/dialog/header.view',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/marionette',
  'hbs!xecmpf/utils/commands/workflows/dialog/header'
], function (_, $, Marionette, HeaderTemplate) {

  var DialogHeaderView = Marionette.ItemView.extend({

    template: HeaderTemplate,

    templateHelpers: function () {
      return {
        title: this.options.title
      };
    },

    constructor: function DialogHeaderView(options) {
      options || (options = {});
      Marionette.ItemView.prototype.constructor.apply(this, arguments);
    }

  });

  return DialogHeaderView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/utils/workflows/impl/embed.appworks',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class=\"xecm4gov-embed-appworks\"></div>";
}});
Handlebars.registerPartial('xecmpf_utils_workflows_impl_embed.appworks', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/utils/workflows/impl/nls/lang',{
    // Always load the root bundle for the default locale (en-us)

    // Do not load English locale bundle provided by the root bundle
    "en-us": false,
    "en": false,
    "root": true
  });

// Defines localizable strings in the default language (English)

csui.define('xecmpf/utils/workflows/impl/nls/root/lang',{
  workflow: "Dynamic workflow",
  startWorkflow: 'Start workflow action was successful.',
  cancelWorkflow: 'Cancel workflow action was successful.'
});


csui.define('css!xecmpf/utils/workflows/impl/embed.appworks',[],function(){});
csui.define('xecmpf/utils/workflows/embed.appworks',[
  'require',
  'csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/backbone',
  'csui/lib/marionette',
  'csui/utils/url',
  'csui/controls/globalmessage/globalmessage',
  'csui/controls/progressblocker/blocker',
  'hbs!xecmpf/utils/workflows/impl/embed.appworks',
  'i18n!xecmpf/utils/workflows/impl/nls/lang',
  'css!xecmpf/utils/workflows/impl/embed.appworks'

], function (require, _, $, Backbone, Marionette, Url, GlobalMessage, BlockingView, EmbedAppworksTemplate, lang) {

  /**
   * @desc - this view is used to load Appworks url in the iframe
   */
  var EmbedAppWorksView = Marionette.ItemView.extend({

    template: EmbedAppworksTemplate,

    tagName: 'div',

    className: 'xecm4gov-embed-appworks-view',


    constructor: function EmbedAppWorksView(options) {
      options || (options = {});
      Marionette.ItemView.prototype.constructor.call(this, options);
      BlockingView.imbue(this);
    },
    /**
     * @desc - It generates iframe element and attaches load event and unblocks view on load of page and inserts styles to avoid issue with scrollbars
     */
    generateIframeElement: function () {
      var embedAppWorksIframe,
          that = this,
          embedAppWorksDocEle;

      // removes existing iframe elements
      this.$el.find(".embed-appWorks-iframe").remove();
      embedAppWorksIframe = document.createElement("iframe");
      embedAppWorksIframe.setAttribute("id", "embedAppWorks");
      embedAppWorksIframe.setAttribute("name", "embedAppWorks");
      embedAppWorksIframe.setAttribute("class", "embed-appWorks-iframe");
      embedAppWorksIframe.setAttribute("aria-label", lang.workflow);

      this.$el.find(".xecm4gov-embed-appworks").append(embedAppWorksIframe);

      // attaches load event to unblock
      if (embedAppWorksIframe) {
        embedAppWorksIframe.addEventListener("load", function () {
          that.unblockActions();
          //Registring to appworks web hooks framework
          var bundesWindow = embedAppWorksIframe.contentWindow;
          if (bundesWindow && that.validHost) {
            window.clientIntervalID = window.setInterval(function () {
              bundesWindow.postMessage({ name: "subscribe" }, that.validHost);
            }, 200);
          }
         
        }, that);
      }
    },

    /**
     * @desc - loads given url in the iframe
     * @param { urlToLoad: String } - url to load
     */
    loadUrlInIframe: function (urlToLoad) {
      this.validHost = this.options.validHost || "";
      this.blockActions();
      this.generateIframeElement();
      this.$el.find("#embedAppWorks").attr("src", urlToLoad);
      this.addMethodToGlobalContext();
    },

    addMethodToGlobalContext: function () {
      var self = this;
      var currentOptions = this.options;
      var bwsId = currentOptions.bwsId;
      var workflowInstanceid = currentOptions.wfinstanceid;
      var isActionLevel = currentOptions.action || "workflow";
      var callbackFunction = currentOptions.callback;
      isActionLevel = isActionLevel.toLowerCase();

      if (self.validHost) {

        var listener = function(event) {

          if (event.origin !== self.validHost){
            return;
          }

          if (event.data.name === 'subscribed'){
            window.clearInterval(window.clientIntervalID);
          }

          if (event.data.name === 'unsubscribed'){
            window.console.log('unsubscribed to client message');
          }

          if (event.data.name === 'workflow-started'){
            self.options.dialogView.trigger('close:appworks:dialog');
            GlobalMessage.showMessage("success", lang.startWorkflow);
            window.removeEventListener('message',listener, false);
          }

          if (event.data.name === 'workflow-cancelled'){
            self.options.dialogView.trigger('cancel:appworks:workflow');
            GlobalMessage.showMessage("success", lang.cancelWorkflow);
            window.removeEventListener('message', listener, false);
          }

        }

        window.addEventListener('message', listener, false);

      }

    }

  });

  return EmbedAppWorksView;

});
csui.define('xecmpf/utils/commands/workflows/open.workflow',['csui/lib/underscore', 'csui/lib/jquery', 'csui/utils/commands/open',
  'csui/utils/commandhelper', 'xecmpf/utils/commands/workflows/dialog/header.view',
  'xecmpf/utils/workflows/embed.appworks', 'csui/controls/dialog/dialog.view',
  'i18n!xecmpf/utils/commands/nls/localized.strings'
], function (_, $, OpenCommand, CommandHelper, HeaderView, EmbedWorkflowView, DialogView, lang) {
  'use strict';

  var WorkflowOpenCommand = OpenCommand.extend({
    defaults: {
      signature: 'WorkflowOpen',
      command_key: ['workflow_open', 'Open'],
      scope: 'single'
    },

    enabled: function (status) {
      var node      = CommandHelper.getJustOneNode(status),
          urlToLoad = node.get('OpenURL');
      return !!urlToLoad;
    },

    execute: function (status, options) {
      options || (options = {});
      var node              = CommandHelper.getJustOneNode(status),
          urlToLoad         = node.get('OpenURL'),
          dialogTitle       = node.get('WorkflowTitle'),
          deferred          = $.Deferred(),
          embedWorkflowView = new EmbedWorkflowView(options);
      options.title = dialogTitle
      this.headerView = new HeaderView(options);

      var dialog = new DialogView({

        title: dialogTitle,
        className: "workflow-dailog",
        largeSize: true,
        view: embedWorkflowView,
        headerView: this.headerView,
        attributes: {
          'aria-label': dialogTitle
        },
        buttons: [{
          id: "close",
          label: lang.close,
          close: true,
        }]
      });
      dialog.show();
      dialog.listenTo(dialog, 'hide', _.bind(this.onHideDialog, this));
      embedWorkflowView.dialogView = dialog;
      embedWorkflowView.loadUrlInIframe(urlToLoad);
      return deferred.resolve(dialog).promise();
    },

    onHideDialog: function () {
      if (this.headerView.options.originatingView.options.originatingView && !!this.headerView.options.originatingView.options.originatingView.$el.find('.csui-workflow-button').length) {
        this.headerView.options.originatingView.options.originatingView.$el.find('.csui-workflow-button').focus();
      }
      else {
        this.headerView.options.originatingView.previousFocusElm.focus();
        this.headerView.options.originatingView.previousFocusElm = undefined;
      }
    },

  });

  return WorkflowOpenCommand;
});
csui.define('xecmpf/utils/commands/workflows',['csui/lib/underscore', 'csui/models/commands',
  'xecmpf/utils/commands/workflows/open.workflow',
], function (_, CommandCollection,
    workflowOpenCommand) {
  'use strict';

  var commands = new CommandCollection([
    new workflowOpenCommand()
  ]);

  return commands;

});
csui.define('xecmpf/controls/table/cells/node.state/workflow.icon/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});

csui.define('xecmpf/controls/table/cells/node.state/workflow.icon/impl/nls/root/lang',{
    from: "From",
    created: "Created",   
    step: "Step {0}: {1}",
    workflows: "Workflows",
    workflow: "Workflow"
  });
  


/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/table/cells/node.state/workflow.icon/popover/impl/workflow.item',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"workflow-item\" role=\"listitem\" > \r\n    <div class=\"workflow-title\">\r\n        <a href=\"javascript:void(0)\" class=\"csui-title-link\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"title") || (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"title","hash":{},"loc":{"start":{"line":3,"column":68},"end":{"line":3,"column":77}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"title") || (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"title","hash":{},"loc":{"start":{"line":3,"column":91},"end":{"line":3,"column":100}}}) : helper)))
    + "\">\r\n            <span class=\"cs-label\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"title") || (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"title","hash":{},"loc":{"start":{"line":4,"column":35},"end":{"line":4,"column":46}}}) : helper)))
    + "</span>\r\n        </a>\r\n    </div>\r\n    <div class=\"workflow-initiator\">\r\n        <span class=\"csui-label\" >"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"from") || (depth0 != null ? lookupProperty(depth0,"from") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"from","hash":{},"loc":{"start":{"line":8,"column":34},"end":{"line":8,"column":42}}}) : helper)))
    + "</span>\r\n        <span class=\"csui-value\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"iitiator") || (depth0 != null ? lookupProperty(depth0,"iitiator") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"iitiator","hash":{},"loc":{"start":{"line":9,"column":40},"end":{"line":9,"column":52}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"initiator") || (depth0 != null ? lookupProperty(depth0,"initiator") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"initiator","hash":{},"loc":{"start":{"line":9,"column":66},"end":{"line":9,"column":79}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"initiator") || (depth0 != null ? lookupProperty(depth0,"initiator") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"initiator","hash":{},"loc":{"start":{"line":9,"column":81},"end":{"line":9,"column":94}}}) : helper)))
    + "</span>\r\n    </div>\r\n    <div class=\"workflow-intiated-date\">\r\n        <span class=\"csui-label\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"created") || (depth0 != null ? lookupProperty(depth0,"created") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"created","hash":{},"loc":{"start":{"line":12,"column":33},"end":{"line":12,"column":44}}}) : helper)))
    + "</span>\r\n        <span class=\"csui-value\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"initiatedDate") || (depth0 != null ? lookupProperty(depth0,"initiatedDate") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"initiatedDate","hash":{},"loc":{"start":{"line":13,"column":40},"end":{"line":13,"column":57}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"intiatedDate") || (depth0 != null ? lookupProperty(depth0,"intiatedDate") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"intiatedDate","hash":{},"loc":{"start":{"line":13,"column":71},"end":{"line":13,"column":87}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"initiatedDate") || (depth0 != null ? lookupProperty(depth0,"initiatedDate") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"initiatedDate","hash":{},"loc":{"start":{"line":13,"column":89},"end":{"line":13,"column":106}}}) : helper)))
    + "</span>\r\n    </div>\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_controls_table_cells_node.state_workflow.icon_popover_impl_workflow.item', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/controls/table/cells/node.state/workflow.icon/popover/workflow.popover.item.view',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/marionette','csui/utils/base',
  'xecmpf/models/workflows/metadata.workflow.collection',
  'xecmpf/utils/commands/workflows',
  'csui/utils/commandhelper',
  'i18n!xecmpf/controls/table/cells/node.state/workflow.icon/impl/nls/lang',
  'hbs!xecmpf/controls/table/cells/node.state/workflow.icon/popover/impl/workflow.item'
], function (_, $, Marionette, base, WorkflowCollection, Commands, CommandHelper, lang, template) {
  'use strict';
  var WorkflowPopoverItemView = Marionette.ItemView.extend({
    className: 'workflow-item',
    tagName: 'li',
    template: template,
    templateHelpers: function () {
      var initiatedDate = this.model.get('InitiatedDate');
      return {
        title: this.model.get('WorkflowTitle'),
        from: lang.from,
        created: lang.created,
        initiator: this.model.get('InitiatedByName'),
        initiatedDate: base.formatExactDate(initiatedDate) + " " + base.formatExactTime(initiatedDate)
      };
    },

    attributes: {
      role: 'none'
    },

    events: {
      'click .csui-title-link': 'onClickWorkflowName',
      'keydown .csui-title-link': 'onKeyInView',
    },

    constructor: function WorkflowPopoverItemView(options) {
      options || (options = {});
      this.options = options;
      this.collection = options.collection;
      Marionette.ItemView.prototype.constructor.call(this, options);
    },

    onClickWorkflowName: function () {

      //destroy popover while opening dialog view
      var originatingView = this.options && this.options.originatingView;
      if (originatingView) {
        originatingView.closePopover(originatingView);
      }

      var status = { nodes: new WorkflowCollection([this.model]) },
        command = Commands.get('WorkflowOpen');
      var cmdOption = { context: this.options.context, originatingView: this };
      var promise = command.execute(status, cmdOption);
      CommandHelper.handleExecutionResults(
        promise, {
        command: command,
        suppressSuccessMessage: "Error Eecuting command",
        suppressFailMessage: "Fecting commands data failed"
      });
    },

    onKeyInView: function (event) {
      if (event.keyCode === 27) {
        this.$el.closest('.binf-popover').siblings('.csui-workflow-button').trigger('focus');
        this.options.originatingView.closePopover();
      }
      else if (event.keyCode === 13 || event.keyCode === 32) {
        this.onClickWorkflowName();
      }
    },

  });
  return WorkflowPopoverItemView;
});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/table/cells/node.state/workflow.icon/popover/impl/workflow.list',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<ul class=\"workflow-list csui-normal-scrolling  csui-no-scroll-x\" role=\"list\"></ul>\r\n";
}});
Handlebars.registerPartial('xecmpf_controls_table_cells_node.state_workflow.icon_popover_impl_workflow.list', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/controls/table/cells/node.state/workflow.icon/popover/workflow.popover.list.view',['csui/lib/underscore', 'csui/lib/marionette',
'xecmpf/controls/table/cells/node.state/workflow.icon/popover/workflow.popover.item.view',
'hbs!xecmpf/controls/table/cells/node.state/workflow.icon/popover/impl/workflow.list'
], function (_, Marionette, WorkflowPopoverItemView,template) {
  'use strict';
  var WorkflowPopoverView = Marionette.CompositeView.extend({
    className: 'workflow-collection',
    template: template,
    childViewContainer: '.workflow-list',
    childView: WorkflowPopoverItemView,

    childViewOptions: function () {
      return {
        collection: this.options.collection,
        originatingView: this.options.originatingView,
        parentView: this,
      };
    },

    constructor: function WorkflowPopoverView(options) {
      options || (options = {});
      this.options = options;
      this.collection = options.collection;
      this.originatingView = options.originatingView;
      Marionette.CompositeView.prototype.constructor.apply(this, arguments);
    },
  });
  return WorkflowPopoverView;
});

csui.define('css!xecmpf/controls/table/cells/node.state/impl/workflow.node.state',[],function(){});
csui.define('xecmpf/controls/table/cells/node.state/workflow.icon/workflow.node.state.view',['csui/lib/jquery', 'i18n',
  'csui/lib/underscore', 'csui/lib/marionette3', 'csui/utils/base',
  'xecmpf/models/workflows/metadata.workflow.collection', 
  'csui/utils/contexts/factories/connector',
  'csui/controls/mixins/keyboard.navigation/modal.keyboard.navigation.mixin',
  'hbs!xecmpf/controls/table/cells/node.state/impl/workflow.node.state',
  'xecmpf/controls/table/cells/node.state/workflow.icon/popover/workflow.popover.list.view',
  'i18n!xecmpf/controls/table/cells/node.state/workflow.icon/impl/nls/lang',
  'css!xecmpf/controls/table/cells/node.state/impl/workflow.node.state'
], function ($, i18n, _, Marionette, base,
   WorkflowModelCollection, ConnectorFactory, ModalKeyboardNavigationMixin, template, WorkflowPopover, lang) {
  'use strict';

  var WorkflowNodeState = Marionette.View.extend({
    tagName: 'li',
    className: 'csui-node-state-workflow',

    template: template,

    templateContext: function () {
      return{
        workflow: lang.workflow
      }
    },

    events: {
      'click button': 'onClickShowFlyout'
    },

    constructor: function WorkflowNodeState() {
      Marionette.View.prototype.constructor.apply(this, arguments);
      this.windowResizeHandler = _.bind(this._onWindowResize, this);
      $(window).on('resize', this.windowResizeHandler);
      $(window).on('resize', _.bind(this.closePopover, this));
    },

    initialize: function () {
      this.collection = new WorkflowModelCollection(undefined, {
        connector: this.options.context.getObject(ConnectorFactory),
        node: this.options.model,
        status: 'in progress'
      });
      this.collection.fetch();
    },

    _onWindowResize: function () {
      this.popoverEl && this.closePopover();
    },
   
    onClickShowFlyout: function (event) {
      var popoverEl = this.$el.find('button');
      this.openPopover(event, popoverEl);
    },

    openPopover: function (event, popoverEl) {
      if (!this.collection.length) {
        return;
      }
      var self=this,
      rightOffset, placement,
      widgetWidth = $('.workflow-list').width(),
      isWidthDiff = ($(window).width() !== widgetWidth),
      isRtl = i18n && i18n.settings.rtl;
      this.popoverEl = popoverEl ? popoverEl : $(event.currentTarget);
      this.WorkflowPopoverView = new WorkflowPopover({
        originatingView: this,
        collection: this.collection
      });
      this.WorkflowPopoverView.render();

      if (isRtl && isWidthDiff) {
        rightOffset = ($(window).width() - this.popoverEl.offset().left
          - this.popoverEl.width());
      } else {
        var tableRowEleWidth = $('.csui-nodestable').width() || 
                                  $('.csui-search-results').width();
        rightOffset = (tableRowEleWidth - this.popoverEl.offset().left
          - this.popoverEl.width());
      }
      placement = rightOffset < 260 ? 'left' : 'right'; // width of popover(260)
      this.popoverEl.binf_popover({
        content: this.WorkflowPopoverView.$el,
        html: true,
        placement: placement,
        trigger: 'manual',
        title: (this.collection.length >= 2) ?  lang.workflows : lang.workflow
      });
      this.popoverEl.binf_popover('show');
      this.popover = this.popoverEl.siblings(".binf-popover");

      this.onShowOverviewFlyout(),
      this.popoverEl.on('shown.binf.popover', _.bind(function () {
        var originatingView = this.options.originatingView ? this.options.originatingView : this.options.tableView;
        this.scrollEle = originatingView && originatingView.thumbnailView ? this.options.tableView.thumbnail.$el.find('.csui-thumbnail-results') : this.options.tableView.$el.find('tbody');
        this.scrollEle.on('scroll.popover', {view: this}, this._handleScrollEvent);
        $(document).on('mouseup.popover', { view: this }, this._handleClickEvent);
        $(this.WorkflowPopoverView.$el.find('.workflow-title .csui-title-link')[0]).trigger('focus');
      }, this));
      this.engageModalKeyboardFocusOnOpen(this.WorkflowPopoverView.el);
    },
    
    onShowOverviewFlyout: function () {
      var flyOutTarget = this.popoverEl,
        popoverContainer = flyOutTarget.parent().find(".binf-popover"),
        popoverArrowEl = popoverContainer.find('.binf-arrow'),
        popoverTitle = popoverContainer.find('.binf-popover-title'),
        popoverContent = popoverContainer.find('.binf-popover-content'),
        popoverArrowWidth = parseInt(popoverArrowEl.css('border-top-width')),
        navBarHeight = $('nav.csui-navbar').length ? $('nav.csui-navbar').innerHeight() :
          $(".binf-nav").parents('nav') && $(".binf-nav").parents('nav').length ?
            $(".binf-nav").parents('nav').innerHeight() : 0,
        paginationHeight = $('.csui-table-paginationview').innerHeight() || $('.csui-pagination').innerHeight(),
        breadcrumbHeight = $('#breadcrumb-wrap').innerHeight() || 0,
        flyOutTopPosition, workflowListHeight, popoverArrowTop,
        iconWidth = $('.csui-workflow-button').width(),
        workflowList = popoverContainer.find(".workflow-list"),
        workflowListOuterHeight = popoverTitle.outerHeight() + popoverContent.outerHeight() - popoverContent.height();
      popoverContainer.addClass('csui-workflow-popover');
      //Set the max-height
      workflowListHeight = window.innerHeight - (workflowListOuterHeight + navBarHeight + paginationHeight + breadcrumbHeight);
      flyOutTopPosition = flyOutTarget.offset().top - (navBarHeight + parseInt(popoverArrowEl.css('top')) + workflowListOuterHeight);
      if (flyOutTopPosition < navBarHeight) {
        flyOutTopPosition = navBarHeight - workflowListOuterHeight;
        popoverArrowTop = flyOutTarget.offset().top - navBarHeight;
      } else {
        popoverArrowTop = parseInt(popoverArrowEl.css('top')) + navBarHeight;
      }
      var perspectivePanel = $(".cs-perspective-panel"),
        perspectivePanelClientTop = perspectivePanel.length > 0 ?
          perspectivePanel[0].getBoundingClientRect().top : 0;
      if (base.isIE11()) {
        flyOutTopPosition += workflowListOuterHeight;
        popoverArrowTop = (flyOutTarget.offset().top - flyOutTopPosition) + (perspectivePanelClientTop - navBarHeight) + popoverArrowWidth / 2;
      }
      workflowList.css({ 'max-height': workflowListHeight });
      popoverContainer.css({
        'position': 'fixed',
        'top': flyOutTopPosition
      });
      popoverArrowEl.css('top', popoverArrowTop);
      var flyOutLeft,
        flyOutTargetLeft,
        popoverContainerLeft = parseInt(popoverContainer.css('left')),
        originatingView = this.options.originatingView ? this.options.originatingView : this.options.tableView;
      if (originatingView) {
        flyOutTargetLeft = flyOutTarget.offset().left;
        if (popoverContainer.hasClass('binf-left')) {
          flyOutLeft = flyOutTargetLeft - (popoverContainer.outerWidth() + popoverArrowWidth / 2);
        }
        else {
          flyOutLeft = flyOutTargetLeft + flyOutTarget.width();
        }
      } else {
        if (popoverContainer.hasClass('binf-left')) {
          flyOutLeft = popoverContainerLeft - popoverArrowWidth / 2;
        } else {
          flyOutLeft = popoverContainerLeft + popoverArrowWidth;
        }
      }
      if(!!$('.csui-search-results').length){
        flyOutLeft += iconWidth/2;
      }
      popoverContainer.css({
        'right': 'auto',
        'left': flyOutLeft
      });
    },

  _handleClickEvent: function (event) {
    if (!$(event.target).closest('.binf-popover').length) {
      var view = event.data.view;
      $(document).off('mouseup.popover', this._handleClickEvent);
      view.closePopover(event.data.view);
    }
  },

    _handleScrollEvent: function (event) {
      var self = event.data.view;
      if (!$(event.target).closest('.binf-popover').length) {
        // always turn off the scroll event in case the popover was already closed
        self.scrollEle.off('scroll.popover', self._handleScrollEvent);
        self && self.closePopover();
      }
    },

    closePopover: function (view) {
      view = view ? view : this;
      this.disengageModalKeyboardFocusOnClose();
      this.popover && this.popover.addClass('binf-hidden');
      this.popoverEl && this.popoverEl.binf_popover('destroy');
      if (view.WorkflowPopoverView) {
        view.WorkflowPopoverView.destroy();
      }
    },
  },
    {
      enabled: function (status) {
        var model = status.node,
          data = model && model.get('data');
        return data && data.showworkflowicon;
      },

      getModelFields: function (options) {
        return { showworkflowicon: '' };
      }
    });
  ModalKeyboardNavigationMixin.mixin(WorkflowNodeState.prototype);
  return WorkflowNodeState;
});
csui.define('xecmpf/controls/table/cells/node.state/node.state.icons',[
    'xecmpf/controls/table/cells/node.state/cmis.icon/cmis.node.state.icon',
    'xecmpf/controls/table/cells/node.state/workflow.icon/workflow.node.state.view'
  ], function (CMISIconView, WorkflowIconView) {
    'use strict';
  
    return [
      {
          sequence: 30,
          iconView: CMISIconView
      },
      {
          sequence: 40,
          iconView: WorkflowIconView
      }
    ];
  
  });
  

csui.define('css!xecmpf/utils/icons/icons',[],function(){});
/**
 * Custom icons
 */
csui.define('xecmpf/utils/icons/icons',[
    'css!xecmpf/utils/icons/icons'
  ], function () {
  
    return [
      {
        equals: {type: 889},
        className: 'csui-icon xecmpf-mime_businessobjecttype'
      },
	  {
        equals: {type: 882},
        className: 'csui-icon csui-icon-extended-ecm-volume'
      },
      {   
        //TO DO ,have to replace once we have ICON for EAC    
        equals: {type: 806},
        className: 'csui-icon icon-reserved_self'
        
      },
      {
        //Core Capture rule icon for Intelligent Filing
        equals: {type: 803},
        className: 'csui-icon core-capture-rule',
      },
      {
        //Core Capture Profile
        equals: {type: 807},
        className: 'csui-icon core-capture-profile'
      },
      {
        //Core Capture Metadata Export
        equals: {type: 804},
        className: 'csui-icon metadata-export',
      }      
    ];
  });
csui.define('xecmpf/utils/icons/xecmpf.icons.v2',[], function () {
  return {
"sap":'<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" class="csui-icon-v2 csui-icon-v2__sap"><path d="M10 19.375C15.1777 19.375 19.375 15.1777 19.375 10C19.375 4.82233 15.1777 0.625 10 0.625C4.82233 0.625 0.625 4.82233 0.625 10C0.625 15.1777 4.82233 19.375 10 19.375Z" fill="#2E3D98"/><path d="M15.2085 6.34838C15.0259 5.58949 14.4103 4.97393 13.6514 4.79128C13.4693 4.74718 13.29 4.72656 13.1159 4.72656C12.4692 4.72656 11.8935 5.01277 11.5008 5.46484L10.2592 6.7065C9.68532 7.2046 9.37851 7.99849 9.58513 8.8571C9.63834 9.07715 9.73087 9.28281 9.84976 9.4717L9.47199 9.84947C9.2831 9.73058 9.07744 9.63757 8.85739 9.58484C8.67522 9.54121 8.49592 9.5206 8.3219 9.5206C7.67519 9.5206 7.09942 9.8068 6.70679 10.2589L5.46514 11.5005C4.89129 11.9986 4.58447 12.7925 4.79109 13.6511C4.97375 14.4105 5.5893 15.0261 6.3482 15.2087C6.53037 15.2528 6.70967 15.2734 6.88369 15.2734C7.53041 15.2734 8.10617 14.9872 8.4988 14.5352L9.74045 13.2935C10.3143 12.7954 10.6211 12.0015 10.4145 11.1429C10.3613 10.9229 10.2688 10.7172 10.1499 10.5283L10.5276 10.1505C10.7165 10.2694 10.9222 10.3619 11.1422 10.4152C11.3244 10.4588 11.5037 10.4794 11.6777 10.4794C12.3244 10.4794 12.9002 10.1932 13.2928 9.74112L14.5345 8.49947C15.1083 8.00089 15.4156 7.207 15.2085 6.34838ZM9.48254 11.3673C9.59232 11.8232 9.45377 12.2729 9.11196 12.5696L9.08655 12.5917L9.06258 12.6156L7.82092 13.8573L7.79695 13.8813L7.7749 13.9067C7.54623 14.1699 7.22982 14.3146 6.88369 14.3146C6.78206 14.3146 6.67755 14.3017 6.57304 14.2768C6.16363 14.178 5.82181 13.8367 5.72353 13.4273C5.61375 12.9713 5.7523 12.5217 6.09411 12.2249L6.11952 12.2029L6.14349 12.1789L7.38515 10.9372L7.40912 10.9133L7.43117 10.8879C7.65936 10.6242 7.97577 10.4794 8.3219 10.4794C8.42353 10.4794 8.52804 10.4923 8.63255 10.5173C8.6757 10.5278 8.71405 10.5508 8.75528 10.5662L7.74326 11.5782C7.55581 11.7656 7.55581 12.0686 7.74326 12.2561C7.83674 12.35 7.95947 12.397 8.0822 12.397C8.20493 12.397 8.32765 12.35 8.42114 12.2566L9.43316 11.2445C9.44898 11.2858 9.47199 11.3241 9.48254 11.3673ZM13.906 7.77509L13.8806 7.79714L13.8566 7.82111L12.615 9.06277L12.591 9.08674L12.5689 9.11214C12.3403 9.37582 12.0239 9.5206 11.6777 9.5206C11.5761 9.5206 11.4716 9.50765 11.3671 9.48272C11.3239 9.47218 11.2856 9.44917 11.2443 9.43382L12.2564 8.4218C12.4438 8.23436 12.4438 7.93137 12.2564 7.74393C12.0689 7.55648 11.7659 7.55648 11.5785 7.74393L10.5665 8.75595C10.5511 8.71472 10.5276 8.67637 10.5176 8.63322C10.4078 8.17731 10.5463 7.72763 10.8881 7.43088L10.9136 7.40882L10.9375 7.38485L12.1792 6.1432L12.2031 6.11923L12.2252 6.09382C12.4534 5.83015 12.7698 5.68537 13.1159 5.68537C13.2176 5.68537 13.3221 5.69831 13.4266 5.72324C13.836 5.822 14.1778 6.16333 14.2761 6.57275C14.3864 7.02914 14.2478 7.47834 13.906 7.77509Z" fill="white"/></svg>',
"status_workflow24":'<svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 24 24" class="csui-icon-v2 csui-icon-v2__status_workflow24"><g><path d="M3,0.5h18c1.381,0,2.5,1.119,2.5,2.5v18c0,1.381-1.119,2.5-2.5,2.5H3c-1.381,0-2.5-1.119-2.5-2.5V3 C0.5,1.619,1.619,0.5,3,0.5z" fill="#2E3D98" class="undefined"/><path d="M21,24H3c-1.654,0-3-1.346-3-3V3c0-1.654,1.346-3,3-3h18c1.654,0,3,1.346,3,3v18C24,22.654,22.654,24,21,24z M3,1C1.897,1,1,1.897,1,3v18c0,1.103,0.897,2,2,2h18c1.103,0,2-0.897,2-2V3c0-1.103-0.897-2-2-2H3z" fill="#FFFFFF" class="undefined"/></g><g><path d="M17.714,9h-3.429C13.6,9,13,8.4,13,7.714V4.286C13,3.6,13.6,3,14.286,3h3.429C18.4,3,19,3.6,19,4.286v3.429 C19,8.4,18.4,9,17.714,9z M17.714,8.143c0.257,0,0.429-0.171,0.429-0.429V4.286c0-0.257-0.172-0.429-0.429-0.429h-3.429 c-0.257,0-0.429,0.171-0.429,0.429v3.429c0,0.257,0.172,0.429,0.429,0.429H17.714z" fill="#FFFFFF" class="undefined"/></g><g><path d="M8.714,15H5.286C4.6,15,4,14.4,4,13.714v-3.429C4,9.6,4.6,9,5.286,9h3.429C9.4,9,10,9.6,10,10.286v3.429 C10,14.4,9.4,15,8.714,15z M8.714,14.143c0.257,0,0.429-0.172,0.429-0.429v-3.429c0-0.257-0.171-0.429-0.429-0.429H5.286 c-0.257,0-0.429,0.171-0.429,0.429v3.429c0,0.257,0.171,0.429,0.429,0.429H8.714z" fill="#FFFFFF" class="undefined"/></g><g><path d="M7,6.5C7,6.2,7.2,6,7.5,6H13V5H7.5C6.7,5,6,5.7,6,6.5V9h1V6.5z" fill="#FFFFFF" class="undefined"/></g><g><path d="M17.714,21h-3.429C13.6,21,13,20.4,13,19.714v-3.429C13,15.6,13.6,15,14.286,15h3.429 C18.4,15,19,15.6,19,16.286v3.429C19,20.4,18.4,21,17.714,21z M13.857,16.286v3.429c0,0.257,0.172,0.429,0.429,0.429h3.429 c0.257,0,0.429-0.172,0.429-0.429v-3.429c0-0.257-0.172-0.429-0.429-0.429h-3.429C14.029,15.857,13.857,16.029,13.857,16.286z" fill="#FFFFFF" class="undefined"/></g><g><path d="M7,17.5C7,17.8,7.2,18,7.5,18H13v1H7.5C6.7,19,6,18.3,6,17.5V15h1V17.5z" fill="#FFFFFF" class="undefined"/></g><g opacity="0.6" class="undefined"><path d="M18,8.5c0.3,0,0.5-0.2,0.5-0.5V4c0-0.3-0.2-0.5-0.5-0.5h-4c-0.3,0-0.5,0.2-0.5,0.5v4c0,0.3,0.2,0.5,0.5,0.5H18 z" fill="#FFFFFF" class="undefined"/></g><g opacity="0.6" class="undefined"><path d="M9,14.5c0.3,0,0.5-0.2,0.5-0.5v-4c0-0.3-0.2-0.5-0.5-0.5H5c-0.3,0-0.5,0.2-0.5,0.5v4c0,0.3,0.2,0.5,0.5,0.5H9z " fill="#FFFFFF" class="undefined"/></g><g opacity="0.6" class="undefined"><path d="M13.5,16v4c0,0.3,0.2,0.5,0.5,0.5h4c0.3,0,0.5-0.2,0.5-0.5v-4c0-0.3-0.2-0.5-0.5-0.5h-4 C13.7,15.5,13.5,15.7,13.5,16z" fill="#FFFFFF" class="undefined"/></g></svg>',
 };
});
csui.define('xecmpf/utils/eventdefinition.defaultactionitems',[],function () {
  'use strict';

  return [
    // Event Definition
    {
      equals: {type: [806]},
      signature: 'OpenEventDefinition',
      sequence: 25
    },
    {
      equals: {type: [678]},
      signature: 'WorkflowOpen',
      sequence: 25
    }
  ];

});
csui.define('xecmpf/utils/commands/folderbrowse/go.to.workspace.history',['module',
  'csui/lib/jquery',
  'csui/lib/underscore',
  'csui/models/command',
  'csui/lib/backbone',
  'i18n!xecmpf/utils/commands/nls/localized.strings'
], function (module, $, _, CommandModel, Backbone, lang) {
  var localHistory = [location.href]
  var listening;
  var GoToWorkpsaceHistory = CommandModel.extend({
    defaults: {
      signature: 'WorkspaceHistory',
      name: lang.GoToWorkpsaceHistory
    },
    enabled: function (status, options) {
      var config = _.extend({
        enabled: false
      }, module.config());
      if (!listening) {
        listening = true;
        window.addEventListener('popstate', function () {
          if (localHistory.length > 1 && localHistory[localHistory.length - 2] === location.href) {
            localHistory.pop();
          }
        });
        Backbone.history.on('navigate', function () {
          localHistory.push(location.href);
        });
      }
      return config.enabled && localHistory.length > 1;
    },
    execute: function (status, options) {
      history.back();
      return $.Deferred().resolve().promise();
    }

  });
  return GoToWorkpsaceHistory;
});




csui.define('xecmpf/utils/commands/folderbrowse/search.container',['module',
  'require',
  'csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/marionette',
  'csui/models/command',
  'i18n!xecmpf/utils/commands/nls/localized.strings'
], function (module, require, _, $, Marionette, CommandModel, lang) {
  var SearchWorkspace = CommandModel.extend({

    defaults: {
      signature: 'SearchFromHere',
      name: lang.SearchWorkspace
    },
    enabled: function (status, options) {
      var config = _.extend({
        enabled: false
      }, module.config());
      return config.enabled;
    },

    execute: function (status, options) {
      var config = _.extend({
        pageWidget: false
      }, module.config());

      var self         = this;
      var deferred = $.Deferred();
      csui.require(['xecmpf/widgets/integration/folderbrowse/search.box.view',
        'xecmpf/controls/search.textbox/search.textbox.view',
        'csui/widgets/search.results/search.results.view',
        'csui/utils/contexts/factories/node',
        'csui/utils/contexts/factories/next.node',
        'csui/utils/contexts/factories/search.query.factory',
        this.get('commands')
      ], function (SearchBoxView, HeaderSearchBoxView, SearchResultsView, NodeModelFactory,
          NextNodeModelFactory, SearchQueryModelFactory, commands) {
        var searchIconHolder = status.originatingView.$el.find('.csui-search-button');
        if (!searchIconHolder.find('div.csui-searchbox-holder').length) {
          searchIconHolder.append("<div class='csui-searchbox-holder'></div>");
        }
        //var self         = this,
        var  searchRegion = new Marionette.Region({
              el: options.el ? options.el : searchIconHolder.find('div.csui-searchbox-holder')
            }),
            context      = status.originatingView && status.originatingView.context ? status.originatingView.context :
                           options && options.context,
            node         = !!context ? context.getModel(NodeModelFactory) : null,
            nodeId       = !!node ? node.get("id") : 0,
            wkspNodeId   = (status.originatingView && status.originatingView.options && status.originatingView.options.workspaceContext && status.originatingView.options.workspaceContext.wkspid && status.originatingView.options.workspaceContext.wkspid.get("id")) ? status.originatingView.options.workspaceContext.wkspid.get("id") : 0;
        if (!config.pageWidget) { // No need to delete the the factory in case of page widget as
          // it is cleared on perspective change
          delete context._factories["searchQuery"];
        }
        var searchInCommand = false;
        var searchView = wkspNodeId === 0 ? SearchBoxView : HeaderSearchBoxView;
        searchInCommand = wkspNodeId === 0 ? false : true;
        self.searchBoxView = new searchView({
            context: context,
            originatingView: status.originatingView,
            data: {
              nodeId: wkspNodeId === 0 ? nodeId : wkspNodeId
            }
        });

        self.originatingViewElement = status.originatingView.$el;
        self.listenTo(self.searchBoxView, "hide:searchbar", function () {
          self.searchBoxView.destroy();
          self.originatingViewElement.find("a.csui-toolitem").show();
          self.originatingViewElement.find("a.csui-toolitem").trigger("focus");
        });
        self.listenTo(self.searchBoxView, "show", function () {
          setTimeout(function () {
              var inputBoxClass = !!searchInCommand ? '.xecmpf-input' : '.csui-input';
              self.originatingViewElement.find(inputBoxClass).trigger("focus");
          }, 25);
        });
        
        status.originatingView.$el.find('.csui-search-button > a.csui-toolitem').hide();
        searchRegion.show(self.searchBoxView);
        if (!config.pageWidget || searchInCommand) {
          // replace the originatingView with sliding left/right animation
          if (status.originatingView) {
            var _searchQuery = context.getModel(SearchQueryModelFactory);
            var _viewName, _triggerViewName, _eventName;
            if (searchInCommand) {
              _viewName = self.searchBoxView,
              _triggerViewName = self.searchBoxView,
              _eventName = 'search:results'
            } else {
              _viewName = status.originatingView,
              _triggerViewName = _searchQuery,
              _eventName = 'change'
           }

            _viewName.listenTo(_triggerViewName, _eventName, function () {
              delete context._factories["searchResults"];
              var searchResultsView = new SearchResultsView({
                container: status.container,
                originatingView: status.originatingView,
                context: context,
                commands: commands,
                enableBackButton: true,
                backButtonToolTip: _.str.sformat(lang.SearchBackTooltip,
                    status.container.get("name"))
              });

              var _showOriginatingView, $csSearchResults;
              var originatingViewParent = self.originatingViewElement.parent();
              originatingViewParent.find('.cs-search-results-wrapper').remove();
              originatingViewParent.append("<div class='cs-search-results-wrapper'></div>");

              self.$csSearchResults = $(
                  originatingViewParent.find('.cs-search-results-wrapper')[0]);
              self.$csSearchResults.hide();
              searchResultsView.render();
              if (searchInCommand) {
                searchResultsView.collection.fetch();
              } else {
                context.fetch();
              }
              Marionette.triggerMethodOn(searchResultsView, 'before:show');
              self.$csSearchResults.append(searchResultsView.el);
              if (searchInCommand) {
                self.originatingViewElement.hide();
              } else {
                self.originatingViewElement.hide('blind', {
                  direction: 'left',
                  complete: function () {
                    self.$csSearchResults.show('blind',
                        {
                          direction: 'right',
                          complete: function () {
                            Marionette.triggerMethodOn(searchResultsView, 'show');
                          }
                        },
                        100);
                  }
                }, 100);
              }
              
              _showOriginatingView = function () {

                self.$csSearchResults.hide('blind', {
                  direction: 'right',
                  complete: function () {
                    self.originatingViewElement.show('blind',
                        {
                          direction: 'left',
                          complete: function () {
                            delete context._factories["searchResults"];
                            delete context._factories["searchFacets"];
                            status.originatingView.triggerMethod('dom:refresh');
                          }
                        },
                        100);
                    searchResultsView.destroy();
                    self.$csSearchResults.remove();
                  }
                }, 100);
              };
              self._nextNode = context.getModel(NextNodeModelFactory);
              self.listenToOnce(self._nextNode, 'change:id', _.bind(_showOriginatingView, self));
              self.listenToOnce(searchResultsView, 'go:back', _.bind(_showOriginatingView, self));

            });
          }
        }
        deferred.resolve();
      }, function (error) {
        deferred.reject(error);
      });

      return deferred.promise();
    }
  });

  return SearchWorkspace;
});
csui.define('xecmpf/utils/commands/folderbrowse/open.full.page.workspace',['module',
  'csui/lib/jquery',
  'csui/lib/underscore',
  'csui/lib/radio',
  'csui/models/command',
  'csui/utils/contexts/factories/connector',
  'csui/utils/url',
  'csui/utils/log',
  'csui/dialogs/modal.alert/modal.alert',
  'i18n!xecmpf/utils/commands/nls/localized.strings'
], function (module, $, _, Radio, CommandModel, ConnectorFactory, Url, log, ModalAlert, lang) {
  var channel = Radio.channel('xecmpf-workspace');
  var OpenFullPageWorkpsace = CommandModel.extend({
    defaults: {
      signature: 'WorkspacePage',
      name: lang.OpenFullPageWorkpsace,
      scope: 'single'
    },

    enabled: function (status, options) {
      var config = _.extend({
        enabled: false
      }, module.config());
      return config.enabled && !!status.container;
    },
    execute: function (status, options) {
      var that = this,
        config = _.extend({
          fullPageOverlay: false,
        }, module.config()),
        deferred = $.Deferred(),
        context = status.originatingView ? status.originatingView.context : options && options.context,
        urlPrefix = 'xecm',
        connector = context.getObject(ConnectorFactory),
        cgiUrl = connector && connector.connection && connector.connection.url ?
        connector.connection.url.replace('/api/v1', '') : '',
        currentWindowRef = window,
        applyTheme = !!status && !!status.data && !!status.data.applyTheme,
        themePath = applyTheme ? $(currentWindowRef.document).find(
          "head > link[data-csui-theme-overrides]").attr('href') : undefined,
        fullPageWorkspaceUrl = Url.combine(cgiUrl, urlPrefix, 'nodes',
          status.container.get('id')),
        navigateMode = context.options.navigateMode,
        xhr = new XMLHttpRequest();
      if (config.fullPageOverlay) {
        csui.require(['xecmpf/widgets/integration/folderbrowse/modaldialog/modal.dialog.view',
            'xecmpf/widgets/integration/folderbrowse/full.page.workspace.view',
            'csui/utils/high.contrast/detector!'
          ],
          function (ModalDialogView, FullPageWorkspaceView, highContrast) {
            var _useIconsForDarkBackground;
            if (highContrast === 2) {
              _useIconsForDarkBackground = false;
            }
            else {
              _useIconsForDarkBackground = true;
            }
            that.authenticate(xhr, cgiUrl, connector);
            xhr.onreadystatechange = function () {
              if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                var viewMode = context.options.viewMode || {};
                var dialog;
                // Note: container.enforcer is needed for folder
                // browser widget, not for the full page workspace.
                csui.require.config({
                  config: {
                    'csui/integration/folderbrowser2/container.enforcer': {
                      enabled: false
                    }
                  }
                });
                var data = {
                  viewMode: viewMode,
                  navigateMode: navigateMode
                };
                var fullPageNoIFrameOptions = {
                  data: data,
                  nodeID: status.container.get('id'),
                  status: status,
                  context: context,
                  connector: connector,
                  renderType: 'dialog',
                  enableCollapse: config.fullPageOverlay
                };
                var fullPageWorkspace = new FullPageWorkspaceView(fullPageNoIFrameOptions);
                dialog = new ModalDialogView({
                  title: status.container.get("name"),
                  className: 'xecm-modal-dialog xecm-no-iframe-dialog',
                  iconRight: "icon-tileCollapse",
                  view: fullPageWorkspace,
                  useIconsForDarkBackground: _useIconsForDarkBackground
                });
                dialog.show();
                that.listenTo(fullPageWorkspace, 'show:dialog:header', function () {
                    that.showDialogHeader(dialog);
                  })
                  .listenTo(fullPageWorkspace, 'hide:dialog:header', function () {
                    that.hideDialogHeader(dialog);
                  });
                that.listenTo(dialog, 'destroy', function () {
                  $('body').removeClass('csui-support-maximize-widget');
                  if (config.fullPageOverlay && viewMode.mode === 'folderBrowse') {
                    // Note: container.enforcer and back.to.last.fragment are needed for
                    // folder browser widget, not for the full page workspace.
                    csui.require.config({
                      config: {
                        'csui/integration/folderbrowser2/container.enforcer': {
                          enabled: true
                        },
                        'csui/utils/commands/back.to.last.fragment': {
                          enabled: true
                        }
                      }
                    });
                  }
                });
                that.listenToOnce(channel, 'xecm:close:fullpage:overlay', function () {
                  dialog && dialog.destroy();
                });
              }
            }
            deferred.resolve();
          },
          function (error) {
            deferred.reject(error);
          });
      } else {
        this.getXecmToken(xhr, cgiUrl, connector)
          .done(function (data) {
            var xecm_token = encodeURIComponent(data.token);
            fullPageWorkspaceUrl = fullPageWorkspaceUrl + '?xecmToken=' + xecm_token;
            if (applyTheme && themePath &&
              (themePath.indexOf('overrides.css') > -1 || themePath.indexOf('overrides-rtl.css') > -1)) {
              var csPath;
              if (themePath.indexOf('overrides-rtl.css') > -1) {
                csPath = themePath.match('/widget_themes/(.*)/' + 'overrides-rtl.css');
              } else {
                csPath = themePath.match('/widget_themes/(.*)/' + 'overrides.css');
              }
              if (csPath !== null && csPath.length === 2 && csPath[1].length > 0) {
                var themeData = csPath[1];
                csPath = [];
                csPath = themeData.split('/');
                var overridesTheme = csPath.length === 2 && csPath[0].length > 0 && csPath[1].length > 0 ?
                  '&theme=sap.' + csPath[0] + '.' + csPath[1] : ''; // e.g. sap.belize.bcw
                fullPageWorkspaceUrl = fullPageWorkspaceUrl + overridesTheme;
              }
            }
            if (navigateMode && navigateMode !== '') {
              fullPageWorkspaceUrl = Url.appendQuery(fullPageWorkspaceUrl, 'navigateMode=' + navigateMode);
            }
            var targetWindowRef = currentWindowRef.open('');
            targetWindowRef.location.href = fullPageWorkspaceUrl;
            deferred.resolve();
          })
          .fail(function (data) {
            ModalAlert.showError(data.responseJSON.error);
          });
      }
      return deferred.promise();
    },
    getXecmToken: function (xhr, cgiUrl, connector) {
      var url = Url.combine(cgiUrl, '/api/v2/xecmauthentication/getusertoken'); //REST URL
      return connector.makeAjaxCall({
        type: 'GET',
        url: url,
        beforeSend: _.bind(function (request, settings) {
          request.setRequestHeader("OTCSTicket", connector.connection.session.ticket);
          request.settings = settings;
          if (this.reportSending) {
            this.reportSending(request, settings);
          }
        }, this),
        success: _.bind(function (data, result, request) {
          if (this.reportSuccess) {
            this.reportSuccess(request);
          }
        }, this),
        error: _.bind(function (request, message, statusText) {
          if (this.reportError) {
            this.reportError(request);
          }
        }, this)
      });
    },
    reportError: function (error) {
      csui.require(['csui/dialogs/modal.alert/modal.alert'], function (ModalAlert) {
        ModalAlert.showError(error.message);
      });
    },
    reportSuccess: function (request) {
      if (request && request.settings) {
        log.debug('Receiving response for {0} from {1}.', request.settings.type,
          request.settings.url);
      }
    },
    reportSending: function (request, settings) {
      if (request && settings) {
        log.debug('Sending request as {0} to {1}.', settings.type, settings.url);
      }
    },

    dialogActions: function (e, cgiUrl, dialog) {
      if (e.origin &&
        (new RegExp(e.origin, "i").test(new Url(cgiUrl).getOrigin()))) {
        if (e.data) {
          if (e.data.status === 'closeDialog') {
            dialog.$el.find(".cs-close").trigger("click");
          } else if (e.data.status === 'showDialogHeader') {
            this.showDialogHeader(dialog);
          } else if (e.data.status === 'hideDialogHeader') {
            this.hideDialogHeader(dialog);
          }
        }
      }
    },

    showDialogHeader: function (dialog) {
      dialog.$el.find(".xecm-modal-header").show();
    },

    hideDialogHeader: function (dialog) {
      dialog.$el.find(".xecm-modal-header").hide();
    },

    authenticate: function (xhr, cgiUrl, connector) {
      if (connector.connection.session && connector.connection.session.ticket) {
        this.authenticateworkspace(xhr, cgiUrl, connector);
      } else if (!!connector.connection.credentials) {
        var that = this,
          request = new XMLHttpRequest();
        request.onreadystatechange = function () {
          if (request.readyState === 4) {
            try {
              if (request.status === 200) {
                var contentType = request.getResponseHeader('content-type');
                if (/^application\/json/i.test(contentType)) {
                  var response = JSON.parse(request.responseText);
                  connector.connection.session = response;
                  that.authenticateworkspace(xhr, cgiUrl, connector);
                } else {
                  throw new Error('Unsupported content type: ' + contentType);
                }
              } else {
                throw new Error(request.status + ' ' + request.statusText);
              }
            } catch (error) {
              console.error(error);
            }
          }
        };
        request.open('POST', connector.connection.url + '/auth', true);
        request.setRequestHeader('Accept', 'application/json');
        request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        request.send('username=' + encodeURIComponent(connector.connection.credentials.username) +
          '&' + 'password=' +
          encodeURIComponent(connector.connection.credentials.password));
      } else {
        ModalAlert.showError(lang.AuthenticationError);
      }
    },

    authenticateworkspace: function (xhr, cgiUrl, connector) {
      xhr.open("GET", cgiUrl + "/xecmauth", true);
      xhr.setRequestHeader("OTCSTicket", connector.connection.session.ticket);
      xhr.withCredentials = true;
      xhr.send(null);
    }

  });

  return OpenFullPageWorkpsace;
});
csui.define('xecmpf/utils/commands/workspaces/delete.workspace.handler',[
  'csui/utils/commands/delete/delete.self.handler',
  'csui/utils/contexts/perspective/perspective.context',
  'csui/lib/radio'
], function (DeleteSelfHandler, PerspectiveContext, Radio) {
  'use strict';

  var extSystemViewModes = Object.freeze(['folderBrowse', 'fullPage']);
  var channel = Radio.channel('xecmpf-workspace');

  return function (node, options) {
    var executeCSUIDeleteHandler = false;
    if (options.context && options.context.options) {
      var data = options.context.options;
      if (node.get('type') === 848 && data.initialWkspId === node.get('id') &&
        data.viewMode && extSystemViewModes.indexOf(data.viewMode.mode) > -1) {
        // clear the history
        if (options.context instanceof PerspectiveContext) {
          var viewStateModel = options.context.viewStateModel;
          if (viewStateModel) {
            viewStateModel.clearHistory();
            viewStateModel.set(viewStateModel.CONSTANTS.CURRENT_ROUTER, undefined);
          }
        }
        channel.trigger('xecm:delete:workspace');
      }
      else if (node.get('type') === 848 && data.initialWkspId !== node.get('id') &&
        data.viewMode && extSystemViewModes.indexOf(data.viewMode.mode) > -1) {
        viewStateModel = options.context.viewStateModel;
        if (viewStateModel) {
          viewStateModel.restoreLastFragment();
        } else {
          executeCSUIDeleteHandler = true;
        }
      } else {
        executeCSUIDeleteHandler = true;
      }
    } else {
      executeCSUIDeleteHandler = true;
    }
    if (executeCSUIDeleteHandler) {
      DeleteSelfHandler(node, options);
    }
  }
});
csui.define('xecmpf/utils/commands/boattachments/boattachments.create',['module', 'require', 'csui/lib/underscore', 'csui/lib/jquery', 'csui/utils/url',
  'csui/utils/commandhelper', 'csui/utils/command.error', 'csui/utils/commands/multiple.items',
  'csui/models/command', 'i18n!xecmpf/utils/commands/nls/localized.strings'
], function (module, require, _, $, Url,
  CommandHelper, CommandError, MultipleItemsCommand,
  CommandModel, lang) {
  'use strict';

  var config = _.extend({
    nodesSelectionType: 'savedQuery' //browse
  }, module.config());

  var CmdModelWithMultipleItemsMixin = CommandModel.extend({});
  _.extend(CmdModelWithMultipleItemsMixin.prototype, MultipleItemsCommand);

  var GlobalMessage, BOAttachment;

  var BOAttachmentsCreate = CmdModelWithMultipleItemsMixin.extend({
    defaults: {
      signature: 'BOAttachmentsCreate',
      command_key: ['BOAttachmentsCreate'],
      name: lang.BOAttachmentCreate.name,
      verb: lang.BOAttachmentCreate.verb,
      doneVerb: lang.BOAttachmentCreate.doneVerb,
      pageLeavingWarning: lang.BOAttachmentCreate.pageLeavingWarning,
      scope: 'multiple',
      successMessages: {
        formatForNone: lang.BOAttachmentCreate.successMessages.formatForNone,
        formatForOne: lang.BOAttachmentCreate.successMessages.formatForOne,
        formatForTwo: lang.BOAttachmentCreate.successMessages.formatForMultiple,
        formatForFive: lang.BOAttachmentCreate.successMessages.formatForMultiple
      },
      errorMessages: {
        formatForNone: lang.BOAttachmentCreate.successMessages.formatForNone,
        formatForOne: lang.BOAttachmentCreate.errorMessages.formatForOne,
        formatForTwo: lang.BOAttachmentCreate.errorMessages.formatForMultiple,
        formatForFive: lang.BOAttachmentCreate.errorMessages.formatForMultiple
      }
    },

    enabled: function (status) {
      // to check the table header action in the search results table view
      if (status.data && status.data.enabledAttach) {
        var nodes = CommandHelper.getAtLeastOneNode(status);
        return !!nodes.length;
      }
      // to check if user can add BO attachment
      return !!status.collection &&
        !!status.collection.businessObjectActions &&
        !!status.collection.businessObjectActions.data &&
        _.has(status.collection.businessObjectActions.data, this.defaults.signature);
    },

    execute: function (status, options) {
      var deferred = $.Deferred();
      // avoid messages from handleExecutionResults
      status.suppressFailMessage = true;
      status.suppressSuccessMessage = true;
      status.context = status.context || options && options.context;

      options = _.extend(options, status.data, {
        collection: status.collection
      });

      // SelectedNodes would be available from "Saved Query Node Picker Results Table".
      var selectedNodes = CommandHelper.getAtLeastOneNode(status);
      if (selectedNodes.length && !!status.originatingView) {
        // originating view would be Search Results View
        // to set the _result in Saved Query Node Picker
        status.originatingView.triggerMethod('set:picker:result', {
          nodes: selectedNodes.models
        });
        // resolve the Search Results Table command execute
        deferred.resolve();
        // to close the Saved Query Node Picker
        status.originatingView.triggerMethod('close');
      }
      // if selectedNodes are not available, open node picker to select nodes
      else {
        status.nodesSelectionType = status.nodesSelectionType ||
          (options && options.nodesSelectionType) ||
          config.nodesSelectionType;

        csui.require(['csui/controls/globalmessage/globalmessage',
          'xecmpf/widgets/boattachments/impl/boattachment.model'
        ], function () {
          GlobalMessage = arguments[0];
          BOAttachment = arguments[1];
          this._selectNodes(status, options)
            .then(function (results) {
              this._showProgressbarAndPerformActions(results.nodes, status, options)
                .then(deferred.resolve, deferred.reject);
            }.bind(this), function (err) {
              if (err && !err.cancelled) {
                GlobalMessage.showMessage('error', err);
              }
              deferred.reject(); // cancel action without error
            });
        }.bind(this), deferred.reject);
      }
      return deferred;
    },

    _selectNodes: function (status, options) {
      var deferred = $.Deferred(),
        that = this;
      csui.require(['csui/dialogs/node.picker/node.picker',
        'xecmpf/controls/savedquery.node.picker/savedquery.node.picker.view',
        'csui/controls/toolbar/toolitems.factory'
      ], function (NodePickerDialog, SavedQueryNodePickerView, ToolItemsFactory) {

        var toolItemsFactory = new ToolItemsFactory({
          main: [{
            signature: that.get('signature'),
            name: lang.BOAttachmentCreate.addButtonLabel,
            commandData: {
              enabledAttach: true
            }
          }]
        }, {
          maxItemsShown: 1,
          dropDownText: lang.ToolbarItemMore,
          dropDownIcon: 'icon icon-toolbar-more',
          addGroupSeparators: false
        });

        var nodePicker = status.nodesSelectionType === 'savedQuery' ?

          new SavedQueryNodePickerView(_.extend({
            title: lang.BOAttachmentCreate.name,
            enableBackButton: true,
            backButtonToolTip: lang.backButtonToolTip,
            connector: status.collection.connector,
            toolbarItems: {
              otherToolbar: toolItemsFactory,
              // as discussed with PM, inline actions not required
              inlineToolbar: [],
              tableHeaderToolbar: toolItemsFactory
              /*new ToolItemsFactory({
                                             other: [
                                               {
                                                 signature: that.get('signature'),
                                                 name: that.get('name'),
                                                 icon: that.get('icon')
                                               }
                                             ]
                                           }, {
                                             maxItemsShown: 1,
                                             dropDownText: lang.ToolbarItemMore,
                                             dropDownIcon: 'icon icon-toolbar-more',
                                             addGroupSeparators: false
                                           })*/
            }
          }, _.omit(status, 'collection', 'toolbarItems'))) :

          new NodePickerDialog(_.extend({
            selectMultiple: true,
            selectableTypes: [],
            unselectableTypes: [],
            showAllTypes: true,
            dialogTitle: lang.BOAttachmentCreate.name,
            selectButtonLabel: lang.selectButtonLabel
          }));

        nodePicker
          .show()
          .then(deferred.resolve, deferred.reject);

      }, deferred.reject);
      return deferred;
    },

    _showProgressbarAndPerformActions: function (selectedNodes, status, options) {
      var deferred = $.Deferred();
      csui.require(['csui/models/fileuploads'], function (UploadFileCollection) {

        var models = _.map(selectedNodes, function (node) {
          return {
            name: node.get('name'),
            state: 'pending',
            count: 0,
            total: 1,
            node: node
          };
        }),
          uploadCollection = new UploadFileCollection(models),
          newStatus = _.defaults({
            nodes: uploadCollection,
            suppressMultipleFailMessage: true
          }, status);

        uploadCollection.each(function (model) {
          model.node = model.get('node');
          model.unset('node', {
            silent: true
          });
        });

        GlobalMessage.showProgressPanel(uploadCollection, {
          oneFileTitle: lang.BOAttachmentCreate.progressBarMessages.oneFileTitle,
          oneFileSuccess: lang.BOAttachmentCreate.successMessages.formatForOne,
          multiFileSuccess: lang.BOAttachmentCreate.successMessages.formatForMultiple,
          oneFilePending: lang.BOAttachmentCreate.progressBarMessages.oneFileTitle,
          multiFilePending: lang.BOAttachmentCreate.progressBarMessages.multiFilePending,
          oneFileFailure: lang.BOAttachmentCreate.errorMessages.formatForOne,
          multiFileFailure: lang.BOAttachmentCreate.progressBarMessages.multiFileFailure,
          someFileSuccess: lang.BOAttachmentCreate.successMessages.formatForMultiple,
          someFilePending: lang.BOAttachmentCreate.progressBarMessages.multiFilePending,
          someFileFailure: lang.BOAttachmentCreate.progressBarMessages.multiFileFailure,
          enableCancel: false
        });

        this._performActions(newStatus, options)
          .then(function () {
            GlobalMessage.hideFileUploadProgress();
            deferred.resolve.apply(deferred, arguments);
          }.bind(this), deferred.reject);

      }.bind(this), deferred.reject);
      return deferred;
    },

    _performAction: function (model, options) {
      csui.require(['xecmpf/utils/util'], function (XecmpfUtil) {
        var node = model.node,
          connector = node.connector;
        return connector.makeAjaxCall({
          url: Url.combine(connector.getConnectionUrl().getApiBase('v2'), 'businessobjects',
            encodeURIComponent(XecmpfUtil.unEscapeSpecialCharacters(options.extId)), encodeURIComponent(options.boType), encodeURIComponent(options.boid), 'businessattachments', node.get('id')),
          type: 'POST',
          data: {
            expand: {
              properties: {
                fields: ['original_id', 'ancestors', 'parent_id', 'reserved_user_id', 'createdby', 'modifiedby']
              }
            }
          },
          success: function (response, status, xhr) {
            var boAttachment = new BOAttachment(response.results[0], {
              connector: connector,
              parse: true
            });
            boAttachment.isLocallyCreated = true;
            options.collection.add(boAttachment, {
              at: 0
            });
            model.deferred.resolve(model);
          },
          error: function (xhr, status, err) {
            var cmdError = xhr ? new CommandError(xhr, node) : xhr;
            model.deferred.reject(model, cmdError);
          },
          complete: function (xhr, status) {
            model.set('count', 1);
          }
        });
      });
    }
  });

  return BOAttachmentsCreate;
});
csui.define('xecmpf/models/eac/eac.eventlist.columns.definitions',['i18n!xecmpf/widgets/eac/impl/nls/lang'
], function (lang) {

  var EACEventListColumnsDefinition = {
    "event_name": {
      "hidden": false,
      "key": "event_name",
      "name": lang.documentTypeLabel,
      "type": -1,
      "type_name": "String",
      "sort": true,
    },

    "namespace": {
      "key": "namespace",
      "name": lang.documentNameLabel,
      "type": -2,
      "type_name": "String"
    },

    "action_plan": {
      "key": "action_plan",
      "name": lang.documentStatusLabel,
      "type": -1,
      "type_name": "String"
    }
  };

  return EACEventListColumnsDefinition;
});

csui.define('xecmpf/models/eac/eventactionplans.model',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/backbone',
  'csui/utils/url',
  'csui/models/mixins/connectable/connectable.mixin',
  'csui/models/mixins/expandable/expandable.mixin', 'csui/models/browsable/client-side.mixin',
  'csui/models/columns',
  'xecmpf/models/eac/eac.eventlist.columns.definitions'
], function (_, $, Backbone, Url, ConnectableMixin, ExpandableMixin, ClientSideBrowsableMixin,
  NodeColumnCollection, eacEventListColumnsDefinition) {

    var EACEventActionPlan = Backbone.Model.extend({

      idAttribute: '',

      constructor: function EACEventActionPlan(attributes, options) {
        this.options = options || (options = {});
        Backbone.Model.prototype.constructor.apply(this, arguments);
      },

      parse: function (response) {
        if(response) {
          response.has_action_plan = "false";
          if(response.action_plans) {
            response.has_action_plan = (!!response.action_plans.length).toString();
          }
        }
        return response;
      }
    });

    var EACEventActionPlans = Backbone.Collection.extend({

      model: EACEventActionPlan,

      constructor: function EACEventActionPlans(models, options) {
        this.options = options || {};
        Backbone.Collection.prototype.constructor.apply(this, arguments);
        this.makeConnectable(options)
          .makeClientSideBrowsable(options);
        this.columns = new NodeColumnCollection();
        this.columns.reset(this.getColumnModels());
      },

      url: function () {
        var url = this.connector.getConnectionUrl().getApiBase('v2');
        url = Url.combine(url, 'eventactioncenter', 'actionplan') ;
        return url;
      },

      getColumnModels: function () {
        var definitions = eacEventListColumnsDefinition;
        var columnKeys = _.keys(definitions);
        var columns = _.reduce(columnKeys, function (colArray, column) {
          var definition = definitions[column];
          if (definition) {
            colArray.push(_.extend({ column_key: column }, definition));
          }
          return colArray;
        }, []);
        return columns;
      },

      parse: function (response) {
        var results = response.results.data;
        for (var i = 0; i < results.length; i++) {
          if (results[i].action_plan_count && parseInt(results[i].action_plan_count) > 0) {
            results[i].enableActionPlanCount = true;
          }
          results[i].eventIndexCount = i;
        }
        return results;
      }

    });

    ConnectableMixin.mixin(EACEventActionPlans.prototype);
    ClientSideBrowsableMixin.mixin(EACEventActionPlans.prototype);

    return EACEventActionPlans;
  });

csui.define('xecmpf/utils/commands/eac/eac.refresh',['csui/lib/underscore',
  "i18n!xecmpf/utils/commands/nls/localized.strings",
  "csui/utils/commandhelper", "csui/utils/commands/node",
  "csui/utils/command.error",
  'xecmpf/models/eac/eventactionplans.model',
  'csui/controls/globalmessage/globalmessage'
], function (_, lang, CommandHelper, NodeCommand, CommandError, EACEventActionPlans, GlobalMessage) {
  'use strict';

  var EACRefreshCommand = NodeCommand.extend({

    defaults: {
      signature: "EACRefresh",
      command_key: ['EACRefresh'],
    },

    //only one node allowed at a time
    enabled: function (status, options) {
      return true;
    },

    execute: function (status, options) {
      status.suppressSuccessMessage = true;
      status.suppressFailMessage = true;

      if (this.eacCollection) {
        this.eacCollection = null;
      }

      this.eacCollection = new EACEventActionPlans(undefined, _.extend({}, status.collection.options));

      var promise = this.eacCollection.fetch();

      promise.done(function () {
        status.collection.reset(this.eacCollection.models);
        GlobalMessage.showMessage('success', lang.Refresh);
      }.bind(this));
      promise.done().fail(function () {
        GlobalMessage.showMessage('error', lang.RefreshError);
      }
      )
      return promise;
    }
  });

  return EACRefreshCommand;

});


csui.define('xecmpf/utils/commands/eac/eac.back',["require", 'csui/lib/jquery', 'csui/utils/base', 'csui/lib/underscore',
  "i18n!csui/utils/commands/nls/localized.strings",
  "csui/utils/commandhelper", "csui/utils/commands/node",
  'csui/utils/command.error'
], function (require, $, base, _, lang, CommandHelper, NodeCommand, CommandError) {
  'use strict';

  var EACBackCommand = NodeCommand.extend({

    defaults: {
      signature: "EACBack",
      command_key: ['EACBack'],
    },

    enabled: function (status, options) {
      return true;
    },

    execute: function (status, options) {
      //Back command
     var  context     = status.context || options.context,     
      viewStateModel = context && context.viewStateModel;
    if (viewStateModel) {
      viewStateModel.restoreLastRouter();
    }
    }
  });

  return EACBackCommand;

});

csui.define('xecmpf/utils/commands/eac/add.to.warehouse',['module', 'require', 'csui/lib/underscore', 'csui/lib/jquery',
  'i18n!xecmpf/widgets/eac/impl/nls/lang',
  'csui/utils/commands/node',
  'csui/models/nodechildren',
  'csui/utils/commands/open.classic.page',
  'csui/utils/url'
], function (module, require, _, $, lang, NodeCommand, NodeChildrenCollection, OpenClassicPageCommand, Url) {
  'use strict';

  var ConnectorFactory, NodeModelFactory;

  var config = _.extend({
    enabled: true,
    // Allow defining a value specific for this command
    openInNewTab: null
  }, module.config());
  // If no specific value was set, use the value for all Classic UI pages
  if (config.openInNewTab == null) {
    config.openInNewTab = OpenClassicPageCommand.openInNewTab;
  }
  var AddToWarehouseCommand = NodeCommand.extend({
    defaultPagesList: [],
    defaults: {
      signature: 'addToWarehouse',
      command_key: ['addToWarehouse', 'addToWarehouse'],
      name: lang.addToWareHouse,
      successMessages: {
        formatForNone: lang.addToWareHouse,
        formatForOne: lang.addToWareHouse,
        formatForTwo: lang.addToWareHouse,
        formatForFive: lang.addToWareHouse
      },
      errorMessages: {
        formatForNone: lang.addToWareHouseFailure,
        formatForOne: lang.addToWareHouseFailure,
        formatForTwo: lang.addToWareHouseFailure,
        formatForFive: lang.addToWareHouseFailure
      }
    },
    enabled: function (status) {
      var enabled = false;
      if (!!status && !!status.nodes.models) {
        status.nodes.models.forEach(function (model) {
          // Event Definition
          if ( ( model.get('type') === 806 ) && !!model.actions.get({signature: 'addToWarehouse'}) ) {
            if ( model.get('action_plan_count') > 0 ) {
              model.isEvent = true;
              enabled = true;
            }
          }
          // Action Plan
          if ( ( model.get('type') === 875 ) && !!model.actions.get({signature: 'addToWarehouse'}) ) {
            enabled = true;
          }
        });
      } else {
        enabled = false;
      }
      return enabled;
    },
    execute: function (status, options) {
      var deferred = $.Deferred(),
        context = status.context || options && options.context,
        target = config.openInNewTab && window.open('', '_blank') || window,
        self = this;
      target.focus();
      csui.require(['csui/utils/contexts/factories/connector',
        'csui/utils/contexts/factories/node'
      ], function () {
        ConnectorFactory = arguments[0];
        NodeModelFactory = arguments[1];
        var children, promises, rawWhen = $.when, deferred = $.Deferred();
        $.whenAll = function (promise) {
          if ($.isArray(promise)) {
            var dfd = $.Deferred();
            rawWhen.apply($, promise).done(function () {
              dfd.resolve(Array.prototype.slice.call(arguments));
            }).fail(function () {
              dfd.reject(Array.prototype.slice.call(arguments));
            });
            return dfd.promise();
          }
          else {
            return rawWhen.apply($, arguments);
          }
        };
        promises = status.nodes.models.map(function (model) {
          if (model.isEvent) {
            children = new NodeChildrenCollection(undefined, {
              node: model
            });
            model.nodeCollection = children;
            return children.fetch();
          } else {
            target.location.href = self._getUrl(context, status);
            deferred.resolve();
          }
        });
        $.whenAll(promises)
          .then(function () {
            target.location.href = self._getUrl(context, status);
            deferred.resolve();
          });
      }, deferred.reject);
    },

    _getUrl: function (context, status) {
      var connector = context.getObject(ConnectorFactory),
        cgiUrl = new Url(connector.connection.url).getCgiScript(),
        urlQueryParameters = this._getUrlQueryParameters(context, status, cgiUrl),
        urlQuery = Url.combineQueryString(urlQueryParameters);
      return Url.appendQuery(cgiUrl, urlQuery);
    },

    _getUrlQueryParameters: function (context, status, cgiUrl) {
      var parameters, nodeID_list = [];
      if (!!status.nodes.models) {
        status.nodes.models.forEach(function (model) {
          if (model.isEvent) {
            model.nodeCollection.models.forEach(function (apmodel) {
              nodeID_list.push(apmodel.get('id'));
            });
          } else {
            nodeID_list.push(model.get('id'));
          }
        });
      }
      else {
        return parameters;
      }
      if (nodeID_list.length > 1) {
        // Compute parameters for the multiple action plan
        parameters = {
          func: 'transport.ProcessMultiAddToWarehouse',
          nodeID: nodeID_list,
          nextUrl: cgiUrl
        };
      } else {
        // Compute parameters for the single action plan
        parameters = {
          func: 'll',
          objId: nodeID_list[0],
          objAction: 'addToWarehouse',
          nextUrl: cgiUrl
        };
      }
      return parameters;
    }
  });
  return AddToWarehouseCommand;
});
csui.define('xecmpf/widgets/boattachments/impl/boattachment.table/commands/snapshot',[
  'csui/lib/jquery',
  'csui/lib/underscore',
  'csui/models/command',
  'csui/utils/commandhelper',
  'i18n!xecmpf/utils/commands/nls/localized.strings'
], function ($, _, CommandModel, CommandHelper, lang) {

  var SnapshotCommand = CommandModel.extend({

    defaults: {
      signature: 'Snapshot',
      name: lang.CommandSnapshot,
      scope: 'multiple',
      doneVerb: lang.CommandDoneVerbCreated
    },

    enabled: function (status) {
      return status && status.container && status.nodes && status.nodes.length > 0;
    },

    execute: function (status, options) {
      status.suppressSuccessMessage = true;
      status.suppressFailMessage = true;

      var deferred  = $.Deferred(),
          container = status.container;

      csui.require(['csui/utils/url',
        'csui/utils/base',
        'csui/utils/contexts/factories/node',
        'csui/utils/contexts/factories/children',
        'csui/utils/contexts/factories/children2',
        'csui/controls/globalmessage/globalmessage',
        'csui/widgets/nodestable/nodestable.view',
        'csui/utils/contexts/factories/next.node',
        'csui/behaviors/default.action/default.action.behavior'
      ], function (Url, base, NodeModelFactory,
          ChildrenCollectionFactory, Children2CollectionFactory,
          GlobalMessage, NodesTableView, NextNodeModelFactory,
          DefaultActionBehavior) {

        // FormData available (IE10+, WebKit)
        var formData       = new FormData(),
            ids            = JSON.stringify(
                status.nodes.map(function (node) {
                  return node.get('id');
                })
            ).replace('[', '{').replace(']', '}'),
            isoDate        = base.formatISODateTime(new Date(new Date().getTime())),
            snapshotConfig = status.collection.options.data.snapshot || {},
            snapshotName   = status.collection.options.data.foldername || // for backwards-compatibility
                             snapshotConfig.folderNamePrefix || '';

        snapshotName = snapshotName.trim() + ' ' +
                       isoDate.substring(0, isoDate.indexOf('.')).replace(/T/g, ' ')
                           .replace(/:/g, '.');
        snapshotName = snapshotName.trim();

        formData.append('body', JSON.stringify(_.extend({}, { // not adding undefined properties
          snapshot_parent_name: snapshotConfig.parentFolderName,
          snapshot_name: snapshotName,
          bus_attach_ids: ids
        })));

        var createSnapshotUrl = Url.combine(
            container.connector.getConnectionUrl().getApiBase('v2'),
            'nodes', container.get('id'), 'snapshots'),
            ajaxOptions = {
              type: 'POST',
              url: createSnapshotUrl,
              data: formData,
              contentType: false,
              processData: false
            };

        var context = status.context || options.context;
        var snapshotNode;

        container.connector.makeAjaxCall(ajaxOptions)
            .done(function (response, statusText, jqxhr) {
              if (NodesTableView.useV2RestApi) {
                ChildrenCollectionFactory = Children2CollectionFactory;
              }
              var currentNode = context.getModel(NodeModelFactory);
              var children = context.getCollection(ChildrenCollectionFactory);
              var snapshotParentId = Math.abs(response.results.data.parent_id);
              snapshotNode = context.getModel(NodeModelFactory, {
                connector: container.connector,
                attributes: { id: response.results.data.id }
              });
              var snapshotParentFolder;
              if ( response.results.parent ) {
                snapshotParentFolder = context.getModel(NodeModelFactory, {
                  connector: container.connector,
                  attributes: response.results.parent
                });
              }

              // if current node in the nodes table is the parent for the new node
              // update nodes table children collection
              if (currentNode.get('id') === snapshotParentId) {
                updateChildrenCollection(children, snapshotNode);
              } else if ( snapshotParentFolder && currentNode.get('id') === Math.abs(snapshotParentFolder.get('parent_id')) ) {
                updateChildrenCollection(children, snapshotParentFolder);
              } else {
                // else, if current nodes table children collection already has the parent node
                // update the parent
                currentNode = children.findWhere({id: snapshotParentId});
                if (currentNode) {
                  currentNode.fetch().always(function() {
                    showSuccessMessageWithLink();
                    deferred.resolve();
                  });
                } else {
                  showSuccessMessageWithLink();
                  deferred.resolve();
                }
              }
            })
            .fail(function (jqXHR, statusText, error) {
              var errmsg = jqXHR.responseJSON && (new base.Error(jqXHR.responseJSON)).error;
              GlobalMessage.showMessage('error', lang.snapshotFailed, errmsg);
              deferred.reject();
            });

        function updateChildrenCollection ( children, node ) {
          node.isLocallyCreated = true;
          node.fetch().always(function() {
            children.add(node, {at: 0});
            showSuccessMessageWithLink();
            deferred.resolve();
          });
        }

        function showSuccessMessageWithLink () {
          var msgOptions = {
            context: status.context,
            nextNodeModelFactory: NextNodeModelFactory,
            link_url: DefaultActionBehavior.getDefaultActionNodeUrl(snapshotNode),
            targetFolder: snapshotNode
          };
          var message = _.str.sformat(lang.snapshotCreatedWithName, snapshotName);
          GlobalMessage.showMessage('success_with_link', message, undefined, msgOptions);
        }
      });
      return deferred.promise();
    }
  });

  return SnapshotCommand;
});

csui.define('xecmpf/utils/commands/eac/add.events',['module',
  'require',
  'csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/marionette',
  'csui/utils/commands/add',  
  'i18n!xecmpf/utils/commands/nls/localized.strings'
], function (module, require, _, $, Marionette, AddCommand, lang) {

    var config = _.extend({
        enabled: true
      }, module.config());
  var AddEvents = AddCommand.extend({

    defaults: {
      signature: 'addEvents',
      name: lang.addEvents,
      scope: 'single'
    },
    enabled: function (status, options) {
      return config.enabled;
    },

    execute: function (status, options) {
      status.forwardToTable = true;
      var newNode, 
          deferred = $.Deferred(),
          addableTypeName = this._getAddableTypeName(status, options);
      csui.require(['xecmpf/utils/table/inlineforms/eventactioncenter/factories/eventfeedmodel','csui/models/node/node.model'
      ], function (EventFeedCollection ,NodeModel) {

        var collection =  new  EventFeedCollection(undefined,{connector : status.container.connector});
        collection.fetch();
        newNode = new NodeModel({        
          "type": options.addableType,
          "type_name": addableTypeName,
          "collection":collection,
          "container": true,
        },{connector: status.container.connector,
        collection:collection});
            $.Deferred().resolve(newNode).promise()
            .done(function(){
              deferred.resolve.apply(deferred, arguments);
            }).fail(function(){
          deferred.reject.apply(deferred, arguments);
        });
      }, function (error) {
        deferred.reject(error);
      });
      return deferred.promise();
    }
  });

  return AddEvents;
});
csui.define('xecmpf/utils/commands/eac/add.action.plan',['module',
  'require',
  'csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/marionette',
  'csui/models/command',
  'csui/utils/commandhelper',
  'i18n!xecmpf/utils/commands/nls/localized.strings'
], function (module, require, _, $, Marionette, CommandModel,CommandHelper, lang) {
    var config = _.extend({
        enabled: true
      }, module.config());
      
  var AddActionPlan = CommandModel.extend({

    defaults: {
      signature: 'addActionPlan',
      name: lang.AddActionPlan,
      scope: 'single'
    },

    execute: function (status, options) {
      
      var deferred = $.Deferred()
      csui.require(
        ['csui/utils/contexts/factories/next.node'],
        function (NextNodeModelFactory) {
          var context = status.context || options && options.context,
            node = CommandHelper.getJustOneNode(status),
            nextNode = context.getModel(NextNodeModelFactory);
            node.set('isAddActionPlan', true);
          _.extend(context, {
            model: node
          });
          nextNode.set('id', node.get('id'));
          deferred.resolve();
        }, deferred.reject);
      return deferred.promise();
    }

  });

  return AddActionPlan;
});
csui.define('xecmpf/utils/commands/eac/delete',['module',
  'require',
  'csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/marionette',
  'csui/utils/command.error',
  'csui/utils/commandhelper',
  'csui/models/fileuploads',
  'csui/controls/globalmessage/globalmessage',
  'csui/utils/url',
  'csui/utils/taskqueue',
  'csui/utils/commands/node',
  'csui/utils/commands/multiple.items',
  'csui/utils/commands/confirmable',
  'i18n!xecmpf/utils/commands/nls/localized.strings'
], function (module, require, _, $, Marionette,CommandError,CommandHelper,UploadFileCollection,
  GlobalMessage,Url,TaskQueue, NodeCommand,MultipleItemsCommand,ConfirmableCommand,lang) {

    var config = _.extend({
        enabled: true,
        parallelism: 1,
        actionType: 'DELETE',
        allowMultipleInstances: true
      }, module.config());

  var  NextNodeModelFactory;

  var DeleteCommand = NodeCommand.extend({

    defaults: {
      signature: 'deleteEvent',
      multiple: true,
      scope: 'multiple',
      // command_key: ['delete', 'Delete'],
      name: lang.delete,
      verb: lang.CommandVerbDelete,
      pageLeavingWarning: lang.DeletePageLeavingWarning,
      allowMultipleInstances : config.allowMultipleInstances,      
      successMessages: {
        formatForNone: lang.DeleteItemsNoneMessage,
        formatForOne: lang.DeleteOneItemSuccessMessage,
        formatForTwo: lang.DeleteSomeItemsSuccessMessage,
        formatForFive: lang.DeleteManyItemsSuccessMessage
      },
      errorMessages: {
        formatForNone: lang.DeleteItemsNoneMessage,
        formatForOne: lang.DeleteOneItemFailMessage,
        formatForTwo: lang.DeleteSomeItemsFailMessage,
        formatForFive: lang.DeleteManyItemsFailMessage
      }
    },
    enabled: function (status, options) {
      
      return config.enabled;
    },

    allowCollectionRefetch: false,

    _getConfirmTemplate: function (status, options) {
      return _.template(lang.DeleteCommandConfirmDialogHtml);
    },

    _getConfirmData: function (status, options) {
      var nodes = CommandHelper.getAtLeastOneNode(status);
      var msg = (nodes.length === 1 ?
                 _.str.sformat(lang.DeleteCommandConfirmDialogSingleMessage,
                     nodes.at(0).get('name')) :
                 _.str.sformat(lang.DeleteCommandConfirmDialogMultipleMessage,
                     nodes.length));
      return {
        title: lang.DeleteCommandConfirmDialogTitle,
        message: msg
      };
    },

   

    _performAction:function(model,options){
      var node = model.node;
      var d = $.Deferred();
      var  deleteOptions = {
        url: Url.combine(node.connector.getConnectionUrl().getApiBase('v2'),
            '/nodes/' + node.get("id")),
        type: 'PUT',
        originatingView:status.originatingView,
        collection:status.collection,
        data: {
          status: 0                  
        }
      };   
      node.connector.makeAjaxCall(deleteOptions).done(function () {         
          model.deferred.resolve(model);
          d.resolve(node);
        })
        .fail(function (error) {
          var commandError = error ? new CommandError(error, node) :
            error;
          model.deferred.reject(model, commandError);

          d.reject(commandError);
        });

        var originatingView = options.originatingView;
        if (originatingView && originatingView.unblockActions) {
          originatingView.unblockActions();
        }

      return d.promise();
    },

    


      startGlobalMessage: function (uploadCollection, options) {
      
        GlobalMessage.showProgressPanel(uploadCollection, {
          oneFileTitle: lang.DeletingOneItem,
          oneFileSuccess: lang.DeleteOneItemSuccessMessage,
          multiFileSuccess: lang.DeleteManyItemsSuccessMessage,
          oneFilePending: lang.DeletingOneItem,
          multiFilePending: lang.DeleteItems,
          oneFileFailure: lang.DeleteOneItemFailMessage,
          multiFileFailure: lang.DeleteManyItemsFailMessage,
          someFileSuccess: lang.DeleteSomeItemsSuccessMessage,
          someFilePending: lang.DeletingSomeItems,
          someFileFailure: lang.DeleteSomeItemsFailMessage,
          enableCancel: false,
          originatingView: options.originatingView,
          locationLabelPending : lang.deletingLocationLabel,
          locationLabelCompleted: lang.deletedLocationLabel,
          allowMultipleInstances : config.allowMultipleInstances,
          actionType: config.actionType
        });
      },

      
    
  });

  _.extend(DeleteCommand.prototype,ConfirmableCommand,  {  
    execute: function (status, options) {
      var deferred = $.Deferred(),
          self     = this;

      // avoid messages from handleExecutionResults (must be set here and not in any async
      // callbacks, because it is used in the calling code immediately after calling execute)
      status.suppressFailMessage = true;
      status.suppressSuccessMessage = true;
      status.deleteBlockAction = true;

      csui.require([
        'csui/models/fileuploads',
        'csui/utils/contexts/factories/next.node',
        'csui/controls/globalmessage/globalmessage'
      ], function (localUploadFileCollection, localNextNodeModelFactory,
          localGlobalMessage) {
        UploadFileCollection = localUploadFileCollection;
        NextNodeModelFactory = localNextNodeModelFactory;
        GlobalMessage = localGlobalMessage;
        if (GlobalMessage.isActionInProgress(config.actionType, lang.DeleteNotAllowed, lang.CommandTitleDelete)) {
          return deferred.resolve();
        }
        self._executeDelete(status, options)
            .then(deferred.resolve, deferred.reject);
      }, deferred.reject);
      return deferred.promise();
    },

    _executeDelete: function (status, options) {
      var self = this;
      options || (options = {});
      var nodes       = CommandHelper.getAtLeastOneNode(status),
          node        = nodes.length === 1 && nodes.first(),
          deferred    = $.Deferred(),
          context     = status.context || options.context;

      options.parallelism || (options.parallelism = config.parallelism);
      options.originatingView = status.originatingView;


      // Do not use 'apply' with 'arguments' array because the 'options' parameter that is
      // undefined and locally set will not be passed on with the locally set value.
      // Use 'call' with parameters list.
      ConfirmableCommand.execute.call(this, status, options)
      .done(function (results) {
  

            // If the current container is deleted, open its parent
            if (node && node === status.container) {
              // Let the other subscribers execute before navigating away
              setTimeout(function () {
                var nextNode = context.getModel(NextNodeModelFactory),
                    parentId = status.container.get('parent_id');
                nextNode.set('id', parentId.id || parentId);
              });
            }
            // For mobile we refresh last page in order to retrieve pushed
            // up items after a delete.
            else if (options.infiniteScroll) {
              status.collection.fetch({
                reset: false,
                remove: false,
                merge: true
              });
            }
            //to refetch collection in table View
            self.allowCollectionRefetch = true;
            deferred.resolve(results);
          })
          .fail(function (args) {
            //only return a result if there is at least one successful delete.
            //This way the waiting CommandHelper in the tabletoolbar.view will trigger
            //an execute complete event.
            var oneSuccess = args && _.find(args, function (result) {
              return !(result instanceof CommandError);
            });
            var rejectResults = oneSuccess ? oneSuccess : args;
            deferred.reject(rejectResults);
          });
        
         

      return deferred.promise();
    },

    _performActions: function (status, options) {
      var self               = this,
          deferred           = $.Deferred(),
          commandData        = status.data || {},
          showProgressDialog = commandData.showProgressDialog != null ?
                               commandData.showProgressDialog : true,
          models             = status.nodes.models;
      var nodes = _.map(models, function (node) {
        return {
          name: node.get('name'),
          state: 'pending',
          count: 0,
          total: 1,
          node: node
        };
      });
      var connector = models && models[0] && models[0].connector;
      var uploadCollection = new UploadFileCollection(nodes, {
        connector: connector,
        container: status.container ? status.container.clone() : undefined
      });
      var newStatus = _.defaults({nodes: uploadCollection}, status);
      var bundleNumber = new Date().getTime();
      // TODO: Make the progressbar a reusable component; do not
      // misuse the file-upload-progressbar for other scenarios.
      // TODO: Handle this in the multi-item command to be consistent
      // with other commands; do not override the delete command only.
      uploadCollection.each(function (fileUpload) {
        // Replace the new node in the file upload model with the existing
        // one to be able to destroy it; sync and destroy events will be
        // triggered on it and the parent collection and view will see them.
        var node = fileUpload.get('node');
        fileUpload.node = node;
        fileUpload.unset('node');

      });

      // var isVersionModel = uploadCollection.models[0].node instanceof VersionModel;
      if (showProgressDialog) {
        this.startGlobalMessage(uploadCollection, options);
      }

      var originatingView = status.originatingView;
      if (originatingView && originatingView.unblockActions) {
        originatingView.unblockActions();
      }

      // do not display our result messages in _performActions
      newStatus.suppressMultipleSuccessMessage = true;
      newStatus.suppressMultipleFailMessage = true;

      var that = this;

      MultipleItemsCommand._performActions.call(this, newStatus, options)
          .done(function (results) {           
            // if (showProgressDialog) {
            //   GlobalMessage.hideFileUploadProgress();
            // }
            // self.showSuccess(results);
            var originalCollection  = results[0].collection;
              for(var i=0;i<results.length;i++){
                originalCollection.remove(results[i]);
              }
            deferred.resolve(results);
          },this)
          .fail(function (errors) {
            if (!showProgressDialog) {
              self.showError(errors);
            }
            return deferred.reject(errors);
          });
      return deferred.promise();
    }
  });

  return DeleteCommand;
});
csui.define('xecmpf/utils/commands/eac/open.eventdefinition',['module','require', 'csui/lib/underscore', 'csui/lib/jquery',
  'csui/models/command', 'csui/utils/commandhelper'
], function (module, require, _, $, CommandModel, CommandHelper) {
  'use strict';

  var config = _.extend({
    enabled: true
  }, module.config());

  var OpenEventDefinition = CommandModel.extend({

    defaults: {
      signature: 'OpenEventDefinition',
      command_key: ['default', 'browse'],
      scope: 'single'
    },

    enabled: function (status) {
      return true;
    },
    
    execute: function (status, options) {
      var deferred = $.Deferred()
      csui.require(
        ['csui/utils/contexts/factories/next.node'],
        function (NextNodeModelFactory) {
          var context = status.context || options && options.context,
            node = CommandHelper.getJustOneNode(status),
            nextNode = context.getModel(NextNodeModelFactory);
          _.extend(context, {
            model: node
          });
          nextNode.set('id', node.get('id'));
          deferred.resolve();
        }, deferred.reject);
      return deferred.promise();
    }

  });

  return OpenEventDefinition;

});

csui.define('xecmpf/utils/commands/xecm.open.plugins/impl/al.web.viewer.plugin',['module',
  'csui/lib/underscore', 'csui/lib/jquery', 'csui/utils/url'
], function (module, _, $, Url) {
  'use strict';

  var config = window.csui.requirejs.s.contexts._.config
    .config['csui/utils/commands/open'] || {};

  config = _.extend({
    isWebViewerConfigured: false,
    supportedWebViewerMimeTypes: [],
  }, config);

  config = _.extend(config, module.config());

  config.supportedWebViewerMimeTypes = _.invoke(
    config.supportedWebViewerMimeTypes, 'toLowerCase');

  function ALWebViewerPlugin() {}

  ALWebViewerPlugin.prototype.getUrl = function (node) {
    var url, error;
    var query = '';
    var apiBase = node.connector.getConnectionUrl().getApiBase('v2');
    var version = node.get('version_number');
    if (version) {
      query = Url.combineQueryString({
        version: version,
        ignoreEditorRanking: true
      });
    }
    var restUrl = Url.appendQuery(Url.combine(apiBase, 'externalviewer/webviewer/' +
      node.get('id') + '/viewerconfig'), query);
    node.connector.makeAjaxCall({
      url: restUrl,
      type: 'GET',
      async: false
    }).done(function (data, textStatus, jqXHR) {
      url = data.url + 'xml=' + data.xml;
    }).fail(function (jqXHR, textStatus, errorThrown) {
      error = errorThrown;
    });
    if (url) {
      return $.Deferred().resolve(url).promise();
    } else {
      return $.Deferred().reject(error).promise();
    }
  };

  ALWebViewerPlugin.prototype.needsAuthentication = function (node) {
    return true;
  };

  ALWebViewerPlugin.isSupported = function (node) {
    var isSupported = false;
    var externalSource = false;
    var mimeType = node.get('mime_type');

    isSupported = mimeType && config.isWebViewerConfigured &&
      config.supportedWebViewerMimeTypes.indexOf(mimeType.toLowerCase()) >= 0;

    if (isSupported) {
      if (node.attributes && node.attributes.data && node.attributes.data["external_source"]) {
        externalSource = node.attributes.data["external_source"];
      }

      if (externalSource && (externalSource === 'sap_al') ){
        isSupported = true;
      } else {
        isSupported = false;
      }
    }

    if (isSupported) {
      isSupported = false;
      var query = '';
      var apiBase = node.connector.getConnectionUrl().getApiBase('v2');
      var version = node.get('version_number');
      if (version) {
        query = Url.combineQueryString({
          version: version,
          ignoreEditorRanking: true,
          ignoreAncestor: true
        });
      } else {
        query = Url.combineQueryString({
          ignoreEditorRanking: true,
          ignoreAncestor: true
        });
      }
      var url = Url.appendQuery(Url.combine(apiBase, 'externalviewer/webviewer/' +
        node.get("id") + '/enabledstatus'), query);
      node.connector.makeAjaxCall({
        url: url,
        type: 'GET',
        async: false
      }).done(function (response, statusText, jqxhr) {
        if (response && response.enabledStatus) {
          isSupported = true;
        } else {
          isSupported = false;
        }
      });
    }
    return isSupported;
  };

  return ALWebViewerPlugin;
});
csui.define('xecmpf/utils/commands/xecm.open.plugins/impl/web.viewer.plugin',['module',
  'csui/lib/underscore', 'csui/lib/jquery', 'csui/utils/url'
], function (module, _, $, Url) {
  'use strict';

  var config = window.csui.requirejs.s.contexts._.config
    .config['csui/utils/commands/open'] || {};

  config = _.extend({
    isWebViewerConfigured: false,
    supportedWebViewerMimeTypes: [],
  }, config);

  config = _.extend(config, module.config());

  config.supportedWebViewerMimeTypes = _.invoke(
    config.supportedWebViewerMimeTypes, 'toLowerCase');

  function WebViewerPlugin() {}

  WebViewerPlugin.prototype.getUrl = function (node) {
    var url, error;
    var query = '';
    var apiBase = node.connector.getConnectionUrl().getApiBase('v2');
    var version = node.get('version_number');
    if (version) {
      query = Url.combineQueryString({
        version: version
      });
    }
    var restUrl = Url.appendQuery(Url.combine(apiBase, 'externalviewer/webviewer/' +
      node.get('id') + '/viewerconfig'), query);
    node.connector.makeAjaxCall({
      url: restUrl,
      type: 'GET',
      async: false
    }).done(function (data, textStatus, jqXHR) {
      url = data.url + 'xml=' + data.xml;
    }).fail(function (jqXHR, textStatus, errorThrown) {
      error = errorThrown;
    });
    if (url) {
      return $.Deferred().resolve(url).promise();
    } else {
      return $.Deferred().reject(error).promise();
    }
  };

  WebViewerPlugin.prototype.needsAuthentication = function (node) {
    return true;
  };

  WebViewerPlugin.isSupported = function (node) {
    var isSupported = false;
    var mimeType = node.get('mime_type');

    isSupported = mimeType && config.isWebViewerConfigured &&
      config.supportedWebViewerMimeTypes.indexOf(mimeType.toLowerCase()) >= 0;

    if (isSupported) {
      isSupported = false;
      var query = '';
      var apiBase = node.connector.getConnectionUrl().getApiBase('v2');
      var version = node.get('version_number');
      if (version) {
        query = Url.combineQueryString({
          version: version
        });
      }
      var url = Url.appendQuery(Url.combine(apiBase, 'externalviewer/webviewer/' +
        node.get("id") + '/enabledstatus'), query);
      node.connector.makeAjaxCall({
        url: url,
        type: 'GET',
        async: false
      }).done(function (response, statusText, jqxhr) {
        if (response && response.enabledStatus) {
          isSupported = true;
        } else {
          isSupported = false;
        }
      });
    }
    return isSupported;
  };

  return WebViewerPlugin;
});
csui.define('xecmpf/utils/commands/xecm.open.plugins/impl/xecm.open.plugins',[
  'xecmpf/utils/commands/xecm.open.plugins/impl/al.web.viewer.plugin',
  'xecmpf/utils/commands/xecm.open.plugins/impl/web.viewer.plugin'
], function (ArchiveLinkWebViewerPlugin, WebViewerPlugin) {
  'use strict';

  return [{
    sequence: 50,
    plugin: ArchiveLinkWebViewerPlugin,
    decides: ArchiveLinkWebViewerPlugin.isSupported
  },
  {
    sequence: 500,
    plugin: WebViewerPlugin,
    decides: WebViewerPlugin.isSupported
  }];
});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/utils/createdocument/impl/embed.powerdocs',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class=\"xecmpf-embed-powerdocs\"></div>";
}});
Handlebars.registerPartial('xecmpf_utils_createdocument_impl_embed.powerdocs', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/utils/createdocument/nls/createdocument.lang',{
    // Always load the root bundle for the default locale (en-us)
    "root": true,
    // Do not load English locale bundle provided by the root bundle
    "en-us": false,
    "en": false
});
csui.define('xecmpf/utils/createdocument/nls/root/createdocument.lang',{ 
    genericWarningMessage: 'Server Error: Unable to perform the action'
});


csui.define('css!xecmpf/utils/createdocument/impl/embed.powerdocs',[],function(){});
csui.define('xecmpf/utils/createdocument/embed.powerdocs.view',[
  'require',
  'csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/backbone',
  'csui/lib/marionette',
  'csui/utils/url',
  'csui/controls/progressblocker/blocker',
  'hbs!xecmpf/utils/createdocument/impl/embed.powerdocs',
  'i18n!xecmpf/utils/createdocument/nls/createdocument.lang',
  'css!xecmpf/utils/createdocument/impl/embed.powerdocs'

], function (require, _, $, Backbone, Marionette, Url, BlockingView, EmbedPowerdocsTemplate, lang) {

  /**
   * @desc - this view is used to load powerdocs url in the iframe
   */
  var EmbedPowerDocsView = Marionette.ItemView.extend({

    template: EmbedPowerdocsTemplate,

    tagName: 'div',

    className: 'xecmpf-embed-powerdocs-view',

    constructor: function DocumentTypeView(options) {
      options || (options = {});
      Marionette.ItemView.prototype.constructor.call(this, options);
      BlockingView.imbue(this);
    },
    /**
     * @desc - It generates iframe element and attaches load event and unblocks view on load of page and inserts styles to avoid issue with scrollbars
     */
    generateIframeElement: function () {
      var embedPowerDocsIframe,
        self = this,
        embedPowerDocsDocEle,
        embedPowerDocsHeaderEle;

      // removes existing iframe elements
      this.$el.find(".embed-powerDocs-iframe").remove();
      embedPowerDocsIframe = document.createElement("iframe");
      embedPowerDocsIframe.setAttribute("id", "embedPowerDocs");
      embedPowerDocsIframe.setAttribute("name", "embedPowerDocs");
      embedPowerDocsIframe.setAttribute("class", "embed-powerDocs-iframe");
      this.$el.find(".xecmpf-embed-powerdocs").append(embedPowerDocsIframe);

      // attaches load event to unblock and add css
      if (embedPowerDocsIframe) {
        embedPowerDocsIframe.addEventListener("load", function () {
          self.unblockActions();
          var styleEle;
          if (embedPowerDocsIframe.contentWindow && embedPowerDocsIframe.contentWindow.document) {
            // to avoid scrollbars in inner iframe when cs url is loaded
            embedPowerDocsDocEle = embedPowerDocsIframe.contentWindow.document;
            styleEle = embedPowerDocsDocEle.createElement("style");
            styleEle.innerHTML = "html{ overflow: auto } body{ height: auto }";
            embedPowerDocsDocEle.head.appendChild(styleEle);
          }
        });
      }
    },

    /**
     * @desc - loads given url in the iframe
     * @param { urlToLoad: String } - url to load
     */
    loadUrlInIframe: function ( urlToLoad ) {
      this.blockActions();
      this.generateIframeElement();
      this.$el.find("#embedPowerDocs").attr( "src", urlToLoad );
    },

    /**
     * @desc - creates temporary form and triggers call to load powerdocs url
     * @param { cgiUrl: String } - cgi url
     * @param { submitRequest: String } - Request hadler
     */
     loadPFPowerDocsUrl: function (cgiUrl, wsId, submitRequest ) {
      var documentGenerationForm = document.createElement('form'),
        formElement = document.createElement('input');
      this.blockActions();
      this.generateIframeElement();
      $(documentGenerationForm).attr({
        name: 'DocumentGeneration',
        id: 'DocumentGeneration',
        method: 'post',
        target: 'embedPowerDocs',
        action: cgiUrl
      });
      $(formElement).attr({
        type: 'hidden',
        value: submitRequest,
        name: 'func'
      });
      documentGenerationForm.appendChild(formElement);
    
      formElement = document.createElement('input');
      $(formElement).attr({
        type: 'hidden',
        value: wsId,
        name: 'wsId'
      });
      documentGenerationForm.appendChild(formElement);

      formElement = document.createElement('input');
      $(formElement).attr({
        type: 'hidden',
        value: true,
        name: 'hideHeader'
      });
      documentGenerationForm.appendChild(formElement);
      document.body.appendChild(documentGenerationForm);
      documentGenerationForm.submit();
      document.body.removeChild(documentGenerationForm);
    },

    /**
     * @desc - creates temporary form and triggers call to load powerdocs url
     * @param { cgiUrl: String } - cgi url
     * @param { wsId: number } - workspace id
     * @param { effectiveDate: string } - effective date
     * @param { documentContext: string } - document context
     */
    loadPowerDocsUrl: function (cgiUrl, wsId, effectiveDate, documentContext, source ) {
      var documentGenerationForm = document.createElement('form'),
        formElement = document.createElement('input');
      this.blockActions();
      this.generateIframeElement();
      $(documentGenerationForm).attr({
        name: 'DocumentGeneration',
        id: 'DocumentGeneration',
        method: 'post',
        target: 'embedPowerDocs',
        action: cgiUrl
      });
      $(formElement).attr({
        type: 'hidden',
        value: 'xecmpfdocgen.PowerDocsPayload',
        name: 'func'
      });
      documentGenerationForm.appendChild(formElement);
      //create featuredate filed
      if (effectiveDate) {
        formElement = document.createElement('input');
        $(formElement).attr({
          type: 'hidden',
          value: effectiveDate,
          name: 'featureDate'
        });
        documentGenerationForm.appendChild(formElement);
      }

      if (documentContext) {
        formElement = document.createElement('input');
        $(formElement).attr({
          type: 'hidden',
          value: documentContext,
          name: 'context'
        });
        documentGenerationForm.appendChild(formElement);
      }

      if (source) {
        formElement = document.createElement('input');
        $(formElement).attr({
          type: 'hidden',
          value: source,
          name: 'source'
        });
        documentGenerationForm.appendChild(formElement);
      }
      formElement = document.createElement('input');
      $(formElement).attr({
        type: 'hidden',
        value: wsId,
        name: 'wsId'
      });
      documentGenerationForm.appendChild(formElement);

      formElement = document.createElement('input');
      $(formElement).attr({
        type: 'hidden',
        value: true,
        name: 'hideHeader'
      });
      documentGenerationForm.appendChild(formElement);
      document.body.appendChild(documentGenerationForm);
      documentGenerationForm.submit();
      document.body.removeChild(documentGenerationForm);
    }

  });

  return EmbedPowerDocsView;

});

csui.define('css!xecmpf/utils/commands/impl/createdocument/createdocument',[],function(){});
csui.define('xecmpf/utils/commands/createdocument',['require',
  'module',
  'csui/lib/underscore',
  'csui/lib/jquery',
  'csui/utils/url',
  'csui/models/command',
  'csui/utils/commandhelper',
  'csui/utils/contexts/factories/connector',
  'xecmpf/utils/createdocument/embed.powerdocs.view',
  'i18n!xecmpf/utils/commands/nls/localized.strings',
  'css!xecmpf/utils/commands/impl/createdocument/createdocument'
], function (require, module, _, $, Url, CommandModel, CommandHelper, ConnectorFactory, EmbedPowerDocsView, lang) {
  var csTypeEcmWorkspace = 848,
      SidePanelView,
      ensureDependencies = _.once(function () {
        var deferred = $.Deferred();
        csui.require(['csui/controls/side.panel/side.panel.view'
        ], function () {
          SidePanelView = arguments[0];
          deferred.resolve();
        }, function (err) {
          deferred.reject(err);
        });
        return deferred.promise();
      }),
      config = module.config();

  /**
   * Function: Command
   * This command is used to navigate for create document. If configuration is set it shows dialog to capture date and proceeds further
   **/
  var CreateDocumentCommand = CommandModel.extend({
    defaults: {
      signature: 'XECMPFCreateDocument',
      command_key: ['xecmpfcreatedocument', 'XECMPFCreateDocument'],
      name: lang.createDocumentCommand,
      scope: 'single',
      types: [csTypeEcmWorkspace]
    },

    /*
     * overridden to update the nodes retrieving logic when displayed in table header
     */
    _getNodesByScope: function (status, scope) {
      var nodes;
      if (status.toolItem.attributes.type === "leftToolbar") {
        nodes = [status.container];
      } else {
        nodes = CommandModel.prototype._getNodesByScope.apply(this, arguments);
      }
      return nodes;
    },

    /**
     * @desc : checks nodes length in the status and creates options object to process further
     */
    execute: function (status, options) {
      var nodeModel,
          connector = status.container && status.container.connector;
      if (status.toolItem.attributes.type === "leftToolbar") {
        nodeModel = status.container;
      } else {
        nodeModel = CommandHelper.getJustOneNode(status);
      }
      if (connector === undefined) {
        nodeModel && (connector = nodeModel.connector)
      }
      options = _.extend({}, options, {
        context: options ? options.context : status.context,
        connector: connector,
        model: nodeModel
      });
      this._openFormInSidepanel(options);
    },

    
    /**
     * @desc- opens initial form in the side panel to capture effective date and context
     * @param {options|Object} - options which contains node model
     */
    _openFormInSidepanel: function (options) {
      ensureDependencies().then(function () {
        var sidePanel, embeddedPowerDocsView, connector, cgiUrl, wsId;

        embeddedPowerDocsView = new EmbedPowerDocsView();
        connector = options.connector;
        cgiUrl = new Url(connector.connection.url).getCgiScript();
        wsId = options.model.get("id");
        sidePanel = new SidePanelView({
          slides: [{
            title: lang.createDocumentDialogTitle,
            content: embeddedPowerDocsView,
            containerClass: 'xecmpf-create-document-slide'
          }],
          backdrop: "sidepanel-backdrop",
          sidePanelClassName: "xecmpf-create-document-side-panel",
          layout: {
            header: true,
            resize: true,
            footer: true,
            mask: true
          }
        });
        sidePanel.show();
        embeddedPowerDocsView.loadPFPowerDocsUrl(cgiUrl, wsId, 'xecmpfdocgen.XECMPFPowerDocsPayload' );
      });
    } 
  });

  return CreateDocumentCommand;
});

csui.define('xecmpf/behaviors/toggle.header/toggle.header.behavior',[
    'csui/lib/jquery', 'csui/lib/underscore', 'csui/lib/marionette',
    'csui/controls/table.rowselection.toolbar/table.rowselection.toolbar.view',
    'csui/utils/non-emptying.region/non-emptying.region', 'csui/lib/jquery.redraw'
  ], function ($, _, Marionette, TableRowSelectionToolbarView, NonEmptyingRegion) {
   'use strict';

    var slideTime = 500;

    var ToggleHeaderBehavior = Marionette.Behavior.extend({

        initialize: function () {
            this.listenTo(this.view, {
                'before:render': this.setTableRowSelectionToolbar
            });
            this.tableHeader = this.options.tableHeader;
            this.container = this.options.alternatingTableContainer;
            this.tableToolbar = this.options.tableToolbar;
            this.tableRowSlectionToolbarViewOptions = this.options.tableRowSlectionToolbarViewOptions;
        },

        setTableRowSelectionToolbar: function () {
           if (!this.view.tableView) {
                return;
            }

            // Start listening to selection changes even before construction of the RowSelecitonToolbar
            // to make toolbar visible first and then fetch lazy actions.
            // Otherwise lazy actions fetch will triggered first and then UI changes will happen which
            // makes the "Snapshot" action (which is not lazy) also needs to wait for lazy actions to be fetched
            // due to size calculations in ToolbarView
            this._setTableRowSelectionToolbarEventListeners();

            this.view._tableRowSelectionToolbarView = new TableRowSelectionToolbarView(_.extend({
                toolItemFactory: this.view.options.toolbarItems.tableHeaderToolbar,
                toolbarItemsMask: this.view.options.toolbarItemsMasks.toolbars.tableHeaderToolbar,
                toolbarCommandController: this.view.commandController,
                showCondensedHeaderToggle: true,

                // if toolbarCommandController is not defined, a new ToolbarCommandController
                // with the following commands is created
                commands: this.view.defaultActionController.commands,
                selectedChildren: this.view.tableView.selectedChildren,
                container: this.view.collection.node,
                context: this.view.context,
                originatingView: this.view,
                collection: this.view.collection
            }, this.tableRowSlectionToolbarViewOptions));

            var toolbarView = this.view._tableRowSelectionToolbarView;
            // hide/show the condensed header
            this.listenTo(toolbarView, 'toggle:condensed:header', function () {
                var $tableHeaderEl = this.$el.find(this.tableHeader);
                var $container = this.$el.find(this.container);
                var showingBothToolbars;
                if ($tableHeaderEl.is(":visible")) {
                    showingBothToolbars = false;
                    $tableHeaderEl.slideUp(slideTime);
                    $container.removeClass('xecmpf-show-header');
                } else {
                    showingBothToolbars = true;
                    $tableHeaderEl.slideDown(slideTime);
                    $container.addClass('xecmpf-show-header');
                }
                // let the right toolbar know to update its attributes
                toolbarView.trigger('toolbar:activity', true, showingBothToolbars);
            });
        },

        _setTableRowSelectionToolbarEventListeners: function () {
            // listen for change of the selected rows in the table.view and if at least one row is
            // selected, display the table-row-selected-toolbar and hide the table-toolbar
            var region = new NonEmptyingRegion({el: this.tableToolbar});
            this.listenTo(this.view.tableView.selectedChildren, 'reset', function () {
                region.show(this.view._tableRowSelectionToolbarView);
                this._onSelectionDisplayOrHide(this.view.tableView.selectedChildren.length);
            });
        },

        _onSelectionDisplayOrHide: function (selectionLength) {
            var $tableHeaderEl = this.$el.find(this.tableHeader);
            var $tableToolbar = this.$el.find(this.tableToolbar);
            var $container = this.$el.find(this.container);
            if (selectionLength > 0) {
                if ($tableToolbar.is(":hidden")) {
                    $tableHeaderEl.slideUp(slideTime);
                    $tableToolbar.slideDown(slideTime);
                    this._triggerToolbarActivityEvent(true, false);
                }
            } else {
                if ($tableToolbar.is(":visible")) {
                    $tableToolbar.slideUp(slideTime);
                    $tableHeaderEl.slideDown(slideTime);
                    $container.removeClass('xecmpf-show-header');
                    this._triggerToolbarActivityEvent(false, true);
                }
            }
        },

        _triggerToolbarActivityEvent: function (toolbarVisible, headerVisible) {
            // let the right toolbar know to update its attributes
            var toolbarView = this.view._tableRowSelectionToolbarView;
            toolbarView.trigger('toolbar:activity', toolbarVisible, headerVisible);
        }
    });
    return ToggleHeaderBehavior;
});

csui.define('xecmpf/widgets/integration/folderbrowse/toolbaritems',[
  'i18n!xecmpf/widgets/integration/folderbrowse/impl/nls/localized.strings',
  'css!xecmpf/widgets/integration/folderbrowse/impl/folderbrowse'
], function (FolderBrowseLang) {
  var toolbarItems = {
    rightToolbar: [
      {
        signature: "SearchFromHere",
        name: FolderBrowseLang.SearchToolItem,
        icon: "icon xecmpf-icon-search",
        group: "main",
        className: "csui-search-button"
      },
      {
        signature: "WorkspacePage",
        name: FolderBrowseLang.PageWidgetToolItem,
        icon: "icon csui-icon-open-full-page",
        group: "main",
        options: {
          hAlign: "right"
        },
        commandData: {applyTheme: true}
      }
    ]
  };
  return toolbarItems;
});

csui.define('xecmpf/widgets/boattachments/impl/boattachment.table/tablecell/createdby.view',[
  'csui/lib/underscore', 'csui/controls/table/cells/cell/cell.view',
  'csui/controls/table/cells/cell.registry', 'csui/utils/base'
], function (_, CellView, cellViewRegistry, base) {
  'use strict';

  var MemberCellView = CellView.extend({
    className: 'csui-truncate',

    getValueText: function () {
      return MemberCellView.getValue(this.model, this.options.column);
    }
  }, {
    getValue: function (model, column) {
      var columnName = column.name,
          value = model.get(columnName + "_expand") ||
                  model.get(columnName) || '',
          text;
      if (_.isObject(value)) {
        // Prefer the expanded user information
        text = base.formatMemberName(value);
      } else {
        // Then try the server-pre-formatted value and fall back to the id
        text = model.get(columnName + "_formatted") || value.toString();
      }
      return text;
    },

    getModelExpand: function (options) {
      return {properties: [options.column.name]};
    }
  });

  cellViewRegistry.registerByDataType(14, MemberCellView);
  cellViewRegistry.registerByDataType(19, MemberCellView);
  cellViewRegistry.registerByColumnKey('createdby', MemberCellView);

  return MemberCellView;
});

csui.define('xecmpf/widgets/boattachments/impl/boattachment.table/tablecell/modifiedby.view',[
  'csui/lib/underscore', 'csui/controls/table/cells/cell/cell.view',
  'csui/controls/table/cells/cell.registry', 'csui/utils/base'
], function (_, CellView, cellViewRegistry, base) {
  'use strict';

  var MemberCellView = CellView.extend({
    className: 'csui-truncate',

    getValueText: function () {
      return MemberCellView.getValue(this.model, this.options.column);
    }
  }, {
    getValue: function (model, column) {
      var columnName = column.name,
          value = model.get(columnName + "_expand") ||
                  model.get(columnName) || '',
          text;
      if (_.isObject(value)) {
        // Prefer the expanded user information
        text = base.formatMemberName(value);
      } else {
        // Then try the server-pre-formatted value and fall back to the id
        text = model.get(columnName + "_formatted") || value.toString();
      }
      return text;
    },

    getModelExpand: function (options) {
      return {properties: [options.column.name]};
    }
  });

  cellViewRegistry.registerByDataType(14, MemberCellView);
  cellViewRegistry.registerByDataType(19, MemberCellView);
  cellViewRegistry.registerByColumnKey('modifiedby', MemberCellView);

  return MemberCellView;
});


csui.define('css!xecmpf/widgets/eac/impl/actionplan.list/impl/actionplan.listitem',[],function(){});
csui.define('xecmpf/widgets/eac/impl/actionplan.list/impl/actionplan.toolbaritems',[
    'csui/lib/underscore',
    'csui/controls/toolbar/toolitems.factory',
    'csui/controls/toolbar/toolitem.model',
    'i18n!csui/controls/tabletoolbar/impl/nls/localized.strings',
    'i18n!xecmpf/widgets/eac/impl/nls/lang',
    'css!xecmpf/widgets/eac/impl/actionplan.list/impl/actionplan.listitem'
  ], function (_, ToolItemsFactory, ToolItemModel, lang, EacLang) {
    'use strict';
  
    var toolbarItems = {
  
      // inline action bar
      inlineActionbar: new ToolItemsFactory({
            main: [
              {
                signature: "InlineEdit",
                name: lang.ToolbarItemRename
              },
              {
                signature: "Delete",
                name: lang.ToolbarItemDelete
              }
            ]
          },
          {
            maxItemsShown: 1,
            dropDownText: lang.ToolbarItemMore,
            dropDownIcon: "icon xecmpf-more-actions-inline"
          }),
          headerActionbar: new ToolItemsFactory({
            main: [
              {
                signature: "addToWarehouse",
                name: EacLang.addToWareHouse
              },
              {
                signature: "Delete",
                name: lang.ToolbarItemDelete
              }
            ]
          },
          {
            maxItemsShown: 2,
            dropDownText: lang.ToolbarItemMore,
            dropDownIcon: "icon xecmpf-more-action-plan-inline"
          })
    };
  
    return toolbarItems;
  });
  

/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/eac/impl/actionplan.list/impl/actionplan.listitem',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a role=\"button\" href=\"#\" class=\"binf-flex-row xecmpf-eac-action-plan-name-link\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"name") || (depth0 != null ? lookupProperty(depth0,"name") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"name","hash":{},"loc":{"start":{"line":4,"column":93},"end":{"line":4,"column":101}}}) : helper)))
    + "\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"name") || (depth0 != null ? lookupProperty(depth0,"name") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"name","hash":{},"loc":{"start":{"line":4,"column":110},"end":{"line":4,"column":118}}}) : helper)))
    + "\" tabindex=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"tabindex") || (depth0 != null ? lookupProperty(depth0,"tabindex") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"tabindex","hash":{},"loc":{"start":{"line":4,"column":130},"end":{"line":4,"column":142}}}) : helper)))
    + "\">\r\n    <span class=\"xecmpf-eac-action-plan-name\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"name") || (depth0 != null ? lookupProperty(depth0,"name") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"name","hash":{},"loc":{"start":{"line":5,"column":46},"end":{"line":5,"column":54}}}) : helper)))
    + "</span>\r\n</a>\r\n<input id=\"actionplan-object-name-input-"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"nodeId") || (depth0 != null ? lookupProperty(depth0,"nodeId") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"nodeId","hash":{},"loc":{"start":{"line":7,"column":40},"end":{"line":7,"column":50}}}) : helper)))
    + "\" class=\"actionplan-object-name-input \r\n    binf-form-control cs-input rename-field binf-hidden\" placeholder=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"namePlaceholder") || (depth0 != null ? lookupProperty(depth0,"namePlaceholder") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"namePlaceholder","hash":{},"loc":{"start":{"line":8,"column":70},"end":{"line":8,"column":89}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"namePlaceHolder") || (depth0 != null ? lookupProperty(depth0,"namePlaceHolder") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"namePlaceHolder","hash":{},"loc":{"start":{"line":8,"column":103},"end":{"line":8,"column":122}}}) : helper)))
    + "\" tabindex=\"0\">\r\n<span class=\"actionplan-object-name-cancel csui-undo actionplan-edit-cancel inline-edit-icon\r\n      rename-field binf-hidden\" tabindex=\"0\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"cancel") || (depth0 != null ? lookupProperty(depth0,"cancel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"cancel","hash":{},"loc":{"start":{"line":10,"column":52},"end":{"line":10,"column":62}}}) : helper)))
    + "\"></span>\r\n<div class=\"csui-inlineform-group csui-inlineform-group-error actionplan-error binf-hidden \">\r\n    <div id=\"actionplan-object-error-message-"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"nodeId") || (depth0 != null ? lookupProperty(depth0,"nodeId") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"nodeId","hash":{},"loc":{"start":{"line":12,"column":45},"end":{"line":12,"column":55}}}) : helper)))
    + "\" class=\"binf-text-danger actionplan-error-message\">\r\n        <span class=\"csui-text-danger actionplan-err-message\"></span>\r\n    </div>\r\n</div>\r\n";
},"3":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<input type=\"text\" class=\"xecmpf-eac-action-plan-list-item-input \r\n     binf-form-control cs-input rename-field\" placeholder=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"namePlaceHolder") || (depth0 != null ? lookupProperty(depth0,"namePlaceHolder") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"namePlaceHolder","hash":{},"loc":{"start":{"line":18,"column":59},"end":{"line":18,"column":78}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"namePlaceHolder") || (depth0 != null ? lookupProperty(depth0,"namePlaceHolder") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"namePlaceHolder","hash":{},"loc":{"start":{"line":18,"column":92},"end":{"line":18,"column":111}}}) : helper)))
    + "\" tabindex=\"0\">\r\n<span class=\"actionplan-object-title-cancel csui-undo actionplan-edit-cancel inline-edit-icon\r\n      rename-field\" tabindex=\"0\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"cancel") || (depth0 != null ? lookupProperty(depth0,"cancel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"cancel","hash":{},"loc":{"start":{"line":20,"column":40},"end":{"line":20,"column":50}}}) : helper)))
    + "\"></span>\r\n<div class=\"csui-inlineform-group csui-inlineform-group-error actionplan-create-error binf-hidden \">\r\n    <div id=\"actionplan-create-object-error-message\" class=\"binf-text-danger actionplan-create-error-message\">\r\n        <span class=\"csui-text-danger actionplan-create-err-message\"></span>\r\n    </div>\r\n</div>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"xecmpf-eac-action-plan-list-item-selection-marker\"></div>\r\n<div class=\"xecmpf-eac-check-box-list\"></div>\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"name") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"loc":{"start":{"line":3,"column":0},"end":{"line":26,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"xecmpf-eac-action-plan-actions\"></div>";
}});
Handlebars.registerPartial('xecmpf_widgets_eac_impl_actionplan.list_impl_actionplan.listitem', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/widgets/eac/impl/actionplan.list/actionplan.listitem.view',['csui/lib/underscore',
    'csui/lib/jquery',
    'csui/lib/backbone',
    'csui/lib/marionette',
    'csui/utils/contexts/factories/connector',
    'csui/controls/checkbox/checkbox.view',
    'csui/utils/commandhelper',
    'csui/controls/tableactionbar/tableactionbar.view',
    'xecmpf/widgets/eac/impl/actionplan.list/impl/actionplan.toolbaritems',
    'hbs!xecmpf/widgets/eac/impl/actionplan.list/impl/actionplan.listitem',
    'i18n!xecmpf/widgets/eac/impl/nls/lang',
    'css!xecmpf/widgets/eac/impl/actionplan.list/impl/actionplan.listitem'
], function (_, $, Backbone, Marionette, ConnectorFactory, CheckboxView, CommandHelper, TableActionBarView, toolbarItems, ActionPlanListItemTemplate, lang) {
    /**
     * Function: ActionPlanListItemView
     * Item view to represent individual action plan, triggers clicks on item click and delete button click
     */
    var ActionPlanListItemView = Marionette.LayoutView.extend({
        tagName: 'li',
        /**
         * Function: className
         * Adds class to identify new action plan among existing action plan item
         */
        className: function () {
            var className = 'xecmpf-eac-action-plan-list-item';
            className += (!this.model.get('id') ? ' xecmpf-new-eac-action-plan-list-item' : '');
            return className;
        },
        template: ActionPlanListItemTemplate,
        constructor: function ActionPlanListItemView(options) {
            options = (options || {});
            Marionette.LayoutView.prototype.constructor.call(this, options);
            var that = this;
            this.listenTo(this.model, "show:inline:action:bar", this.onRender);
            this.listenTo(this.model, "delete:action:plan", this.deleteActionPlan);
            this.listenTo(this.model, "change:csuiInlineFormErrorMessage", this.onRenameMode);
            this.listenTo(this.model, "destroy", function () {
                this.options.originatingView.onActionPlanDelete(this)
            });
            this.listenTo(this.model, "toggle:checkbox", function () {
                this.checkboxView.$el.trigger('click');
            });
        },
        modelEvents: {
            'change': 'onActionPlanListItemModelUpdate'
        },
        regions: {
            checkBoxListRegion: '.xecmpf-eac-check-box-list',
            actionBarRegion: '.xecmpf-eac-action-plan-actions'
        },
        templateHelpers: function () {
            return {
                // setting tabindex of first list item to 0 for tabbing
                tabindex: this._index === 0 ? '0' : '-1',
                name:  this.model.get('name'),
                username: this.model.get('username'),
                deleteTooltip: lang.deleteActionPlanButton,
                deleteAria: lang.deleteActionPlanButtonAria + ' ' + this.model.get('name'),
                nodeId: this.model.get('id'),
                namePlaceHolder: lang.actionPlanTitlePlaceholder,
                cancel: lang.cancelLabel,
                hideCheckbox: !this.model.attributes.hideCheckbox
            }
        },
        triggers: {
            'click .xecmpf-eac-action-plan-name-link': 'click:actionplan:item'
        },

        ui: {
            actionPlanNameButton: '.xecmpf-eac-action-plan-name-link',
            actionPlanName: '.xecmpf-eac-action-plan-name',
            actionPlanNameInput: '.actionplan-object-name-input',
            actionPlanNameCancel: '.actionplan-object-name-cancel',
            actionPlanErrorMsg: '.actionplan-error',
            checkBoxList: '.xecmpf-eac-check-box-list',
            acctions: '.xecmpf-eac-action-plan-actions',
            titleCancel: '.actionplan-object-title-cancel',
            titleInput: '.xecmpf-eac-action-plan-input',
            actionPlanErr: '.actionplan-err-message',
            actionPlanErrParent: '.actionplan-error-message'
        },
        events: {
            'click .actionplan-object-name-cancel': '_cancelEdit',
            'focusout .xecmpf-eac-action-plan-list-item-input': 'onFocusOutActionPlan',
            'focusout @ui.actionPlanNameInput' : 'onFocusOutRename',
            'click .actionplan-object-title-cancel': 'onTitleCancel',
            'focus @ui.actionPlanNameButton': function (event) {
                this._hasFocus = true;
            },
            'focusin': function (event) {
                this.ui.acctions.css('display','block');
                this.ui.checkBoxList.css('display','block');
                this.$el.addClass("action-plan-list-item-focus");
            },
            'focusout': 'onFocusOut',
            "keydown ": 'onkeyInView',
            'keydown .xecmpf-eac-action-plan-list-item-input': 'onKeyInRenameMode',
            'mouseover': 'showHideInlineActionBar',
            'mouseout':function () {
                this.ui.acctions.css('display','none');
                this.model.get('checked') ?
                    this.ui.actionPlanNameButton.css('margin-left', '8px')
                    : (this.ui.checkBoxList.css('display', 'none') &&
                        this.ui.actionPlanNameButton.css('margin-left', '22px'));
            },
        },
        showHideInlineActionBar: function () {
            if (!this.model.attributes.checked) {
                !!this.tableActionBarView && this.tableActionBarView.$el.show();
            }
            else {
                !!this.tableActionBarView && this.tableActionBarView.$el.hide();
            }
            this.ui.checkBoxList.css('display','block');
            this.ui.acctions.css('display','block');
            !this.$el.hasClass('xecmpf-new-eac-action-plan-list-item') && this.ui.actionPlanNameButton.css('margin-left','8px');
        },
        onFocusOut: function (event) {
            if (!event.currentTarget.contains(event.relatedTarget)) {
                this.ui.acctions.css('display', 'none');
                this.$el.removeClass("action-plan-list-item-focus");
                this.model.get('checked') ?
                    this.ui.actionPlanNameButton.css('margin-left', '8px')
                    : (this.ui.checkBoxList.css('display', 'none') &&
                        this.ui.actionPlanNameButton.css('margin-left', '22px'));
            }
        },

        onFocusOutRename: function (event) {
            if (!event.delegateTarget.contains(event.relatedTarget) && $(event.currentTarget).is(":visible")) {
                this._submitDescription();
            }
        },
       
        onKeyInRenameMode: function (event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                this.onFocusOutActionPlan(event);
            }
        },
        onTitleCancel: function () {
            this.options.originatingView.onActionPlanDelete(this);
        },
        onRenameMode: function () {
            var commandCS = this.model.actions.findWhere({ signature: 'rename' });
            var commandCI = this.model.actions.findWhere({ signature: 'delete' });
            var emptyModel;
            if (!_.isUndefined(commandCS) || !_.isUndefined(commandCI) && !this._parent.errorCase) {

                if (!this.ui.actionPlanName.hasClass('binf-hidden')) {

                    var fileName = this.model.get("name");
                    this.ui.actionPlanNameInput.val(fileName);
                    this.ui.actionPlanName.addClass('binf-hidden');
                    this.ui.actionPlanNameButton.addClass('binf-hidden');
                    this.ui.actionPlanErrorMsg.addClass('binf-hidden');
                    this.ui.actionPlanNameInput.removeClass("binf-hidden");
                    this.ui.checkBoxList.addClass('binf-hidden');
                    this.ui.acctions.addClass('binf-hidden');
                    this.ui.actionPlanNameCancel.removeClass('binf-hidden');
                    this.ui.actionPlanNameInput.trigger('focus');
                    emptyModel = this.options.originatingView.collection.findWhere({plan_id:''});
                    if(emptyModel){
                        this.options.originatingView.collection.remove(emptyModel);
                    }
                    this.options.originatingView.onActionPlanRenameCancel(this);
                }
            }
        },
        _checkName: function () {
            return this.ui.actionPlanName.hasClass("binf-hidden") ?
                this.ui.actionPlanNameInput.val().trim() : this.model.get("name");
        },
        setErrorMessage: function (message,mode) {
            if(mode === 'rename'){
            this.$el.addClass('cs-form-error');
            this.ui.actionPlanErr.text(message);
            this.ui.actionPlanErrParent.attr('title', message);
            if (this.ui.actionPlanErrorMsg.hasClass("binf-hidden")) {
                this.ui.actionPlanErrorMsg.removeClass("binf-hidden");
            }
        }else{
            this.$el.addClass('cs-form-error');
            this.$el.find('.actionplan-create-err-message').text(message);
            this.$el.find('.actionplan-create-error-message').attr('title',message);
            if (this.$el.find('.actionplan-create-error').hasClass("binf-hidden")) {
                this.$el.find('.actionplan-create-error').removeClass("binf-hidden");
            }
        }

        },
        _submitDescription: function () {
            if (!!this.ui.actionPlanName && this.ui.actionPlanName.hasClass('binf-hidden')) {
                //get the new name and description and store it in the model, save it and render the view
                var actionPlanData, newName = this._checkName(),
                    that = this;
                if (newName.length > 0) {
                    actionPlanData = this.model.get('data');
                    this.model.save({ 'name': newName },
                        { wait: true, patch: true, includeActions: true })
                        .done(_.bind(function () {
                            var promise = CommandHelper.refreshModelAttributesFromServer(this.model);
                            this.model.set('name', newName);
                            promise.done(function () {
                                that.model.attributes.create = false;
                                that.model.set('data',actionPlanData);
                                that.render();
                            });
                            this.$el.find('.csui-inlineform-group-error').hide();
                            this.$el.removeClass('cs-form-error');
                        }, this))
                        .fail(_.bind(function (error) {
                            this.setErrorMessage(error.responseJSON.error,'rename');
                        }, this));
                }
            }
        },
        _cancelEdit: function () {
            this.ui.actionPlanNameInput.addClass("binf-hidden");
            this.ui.actionPlanNameCancel.addClass('binf-hidden');
            this.onFocusOutActionPlan();
        },
        onMouseEnter: function () {
            var that = this,
                data, event_def_id;
            if (!!this.model.get('id')) {
                if (this.model.fetched) {
                    data = this.model.get('data');
                    event_def_id = this.model.get('event_def_id');
                }
                this.model.fetch().done(function () {
                    that.model.set('data', data);
                    that.model.set('event_def_id', event_def_id);
                    that.tableActionBarView = new TableActionBarView(_.extend({
                        context: that.options.context,
                        collection: toolbarItems.inlineActionbar,
                        status: {
                            context: that.options.context,
                            originatingView: that.options.originatingView,
                            model: that.model
                        },
                        model: that.model,
                        originatingView: that.options.originatingView
                    }, toolbarItems.inlineActionbar.options, { maxItemsShown: 1 }));
                    // set the action state, without this the css class 'csui-state-undefined' is added to toolbar action bar
                    that.tableActionBarView.actionState.set('state', 'full');
                    // render the action bar
                    that.actionBarRegion.show(that.tableActionBarView);
                    that.listenTo(that.tableActionBarView, 'after:execute:command', function (eventArgs) {
                        if (eventArgs.commandSignature === 'Delete') {
                            that.model.planID = that.model.attributes.plan_id;
                            that.model.event_def_id = that.model.attributes.event_def_id;
                            that.options.actionPlanListView.refreshCurrentActionPlanItem(that.model);
                        }
                    });
                });
            }         
        },
        deleteActionPlan: function (eventArgs) {
            if (!eventArgs || eventArgs.commandSignature === 'Delete') {
                this.options.originatingView.onActionPlanDelete(this)
            }
        },
        onRender: function () {
            var showCheckBox = this.model.attributes.create ? true : this.model.attributes.hideCheckBox;
            if (!showCheckBox ) {
                this.checkboxView = new CheckboxView({
                    checked: false,
                    disabled: false,
                    ariaLabel: lang.selectAllAria,
                    title: lang.selectAll
                });
                this.listenTo(this.checkboxView.model, 'change:checked', function (event) {
                    if (event.changed.checked) {
                        event.changed.checked === 'true' ? this.model.set('checked', true) :
                            this.model.set('checked', false);
                    }
                    this.triggerMethod("show:actionplan:moreButton");
                });

                this.model.set('checked', false, { silet: true });
                this.checkBoxListRegion.show(this.checkboxView);
            }
            this.listenToOnce(this.model,"change:csuiInlineFormErrorMessage", this.onRenameMode);
            this.onMouseEnter();

        },
        onFocusOutActionPlan: function (event) {
            if (this.model.attributes.plan_id === '') {
                if (!this.ui.titleCancel.is(event.relatedTarget) || event.keyCode === 13) {
                    if (this.$el.find('.xecmpf-eac-action-plan-list-item-input').val()) {
                        var actionPlanName = this.$el.find('.xecmpf-eac-action-plan-list-item-input').val(),
                        alreadyexists = this.options.originatingView.collection.findWhere({ name: actionPlanName });
                        if( alreadyexists ) {
                            var messageToShow = _.str.sformat(lang.actionPlanCreateError, actionPlanName);
                            this.setErrorMessage(messageToShow, 'create');    
                        }
                        else {
                            this.trigger('click:actionplan:item');
                            this.model.set('name', actionPlanName, { silent: true });
                            this.model.set('isAddActionPlan',false, { silent: true });
                            this.model.set('planCreated',true, { silent: true });
                            this.model.attributes.hideCheckBox = true;
                            this.$el.removeClass('cs-form-error');
                            this.render();
                        }
                    }
                }
            } else if (!event) {
                this.model.set('hideCheckBox', false, { silent: true });
                this.model.set('create', false, { silent: true });
                this.$el.removeClass('cs-form-error');
                this.render();
            }
        },
        /**
         * Function: onkeyInView
         * Used in keyboard navigation
         */
        onkeyInView: function (event) {
            var keyCode = event.keyCode;
            switch (keyCode) {
                case 13:
                case 32:
                    if (event.target.classList.contains('cs-input')) {
                        if (keyCode === 13) {
                            //enter in the input field, save the new description
                            event.preventDefault();
                            event.stopPropagation();
                            this._submitDescription();
                        }
                        /* space in the input field, no action here */
                    } else if (event.target.classList.contains('actionplan-object-name-cancel')) {
                        //space or enter on the cancel button, cancel the edit mode
                        event.preventDefault();
                        event.stopPropagation();
                        this._cancelEdit();
                    } else if (event.target.classList.contains('actionplan-object-title-cancel')) {
                        //space or enter on the cancel button, cancel the edit mode
                        event.preventDefault();
                        event.stopPropagation();
                        this.onTitleCancel();
                    } 
                    break;
                case 27:
                    if (event.target.classList.contains('xecmpf-eac-action-plan-list-item-input')) {
                            //escape in the input field, cancel the edit mode
                            event.preventDefault();
                            event.stopPropagation();
                            this.onTitleCancel();
                    } else if (this.ui.actionPlanNameInput.is($(event.target))) {
                        event.preventDefault();
                        event.stopPropagation();
                        this._cancelEdit();
                    }
                    break;
                case 9:
                    if (event.target.classList.contains('actionplan-object-title-cancel')) {
                        this.onFocusOutActionPlan(event);
                    }
                    break;
                case 39:
                    if (this.ui.actionPlanNameButton.is($(event.target))) {
                        this.ui.acctions.find('.binf-dropdown-toggle').prop('tabindex', 0).trigger("focus");
                    } else if (event.target.classList.contains('csui-checkbox')) {
                        this.ui.actionPlanNameButton.prop('tabindex', 0).trigger("focus");
                    } 
                    break;
                case 37:
                    if (this.ui.actionPlanNameButton.is($(event.target))) {
                        this.$el.find('.csui-checkbox').prop('tabindex', 0).trigger("focus");
                    } else if (this.ui.acctions.find('.binf-dropdown-toggle').is($(event.target))) {
                        this.ui.actionPlanNameButton.prop('tabindex', 0).trigger("focus");
                    }
            }
        },

        /**
         * Function: _setFocus
         * Sets the focus on current ActionPlanListItem
         */
        _setFocus: function () {
            if (this.ui.actionPlanNameButton.length > 0) {
                this.ui.actionPlanNameButton.trigger('focus');
            } else if (this.$el.find('.xecmpf-eac-action-plan-list-item-input').length) {
                this.$el.find('.xecmpf-eac-action-plan-list-item-input').trigger('focus');
            }
        },

        /**
         * Function: onActionPlanListItemModelUpdate
         * It is called on model updates. code to update the view on model change can be placed here
         */
        onActionPlanListItemModelUpdate: function () {
            this.updateNewActionPlanIndication();
        },

        /**
         * Function: updateNewActionPlanIndication
         * adds and removes class (to distinguish new action plan item) from el based on model 
         */
        updateNewActionPlanIndication: function () {
            this.$el.removeClass('xecmpf-new-eac-action-plan-list-item');
            !this.model.get('id') &&
                this.$el.addClass('xecmpf-new-eac-action-plan-list-item');
        }
    });
    return ActionPlanListItemView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/eac/impl/actionplan.list/impl/actionplan.list',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"cs-header xecmpf-eac-action-plan-header-region\">\r\n  <div class=\"xecmpf-eac-action-plan-header\">\r\n    <span class=\"cs-title xecmpf-eac-action-plan-header-text\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"actionPlansListHeader") || (depth0 != null ? lookupProperty(depth0,"actionPlansListHeader") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"actionPlansListHeader","hash":{},"loc":{"start":{"line":4,"column":62},"end":{"line":4,"column":89}}}) : helper)))
    + "</span>\r\n    <div title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"newActionPlanLabel") || (depth0 != null ? lookupProperty(depth0,"newActionPlanLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"newActionPlanLabel","hash":{},"loc":{"start":{"line":5,"column":16},"end":{"line":5,"column":40}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"newActionPlanLabel") || (depth0 != null ? lookupProperty(depth0,"newActionPlanLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"newActionPlanLabel","hash":{},"loc":{"start":{"line":5,"column":54},"end":{"line":5,"column":78}}}) : helper)))
    + "\" tabindex=\"0\" role=\"button\" class=\"binf-btn csui-groups-header-plus xecmpf-eac-add-action-plan-btn\">\r\n      <span class=\"icon icon-toolbarAdd\"></span>\r\n    </div>\r\n  </div>\r\n  <div class=\"xecmpf-action-plan-actions-list-container\"></div>\r\n</div>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"showAddActionPlan") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"loc":{"start":{"line":1,"column":0},"end":{"line":11,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"cs-content xecmpf-eac-action-plan-list binf-flex-column\" role=\"navigation\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"actionPlansGroup") || (depth0 != null ? lookupProperty(depth0,"actionPlansGroup") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"actionPlansGroup","hash":{},"loc":{"start":{"line":12,"column":99},"end":{"line":12,"column":119}}}) : helper)))
    + "\"></div>";
}});
Handlebars.registerPartial('xecmpf_widgets_eac_impl_actionplan.list_impl_actionplan.list', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/eac/impl/actionplan.list/impl/actionplan.list',[],function(){});
csui.define('xecmpf/widgets/eac/impl/actionplan.list/actionplan.list.view',['csui/lib/underscore',
'csui/lib/jquery',
'csui/lib/backbone',
'csui/lib/marionette',
'csui/utils/contexts/factories/connector',
'csui/controls/tile/behaviors/perfect.scrolling.behavior',
'csui/controls/table.rowselection.toolbar/table.rowselection.toolbar.view',
'csui/models/node/node.model',
'xecmpf/models/eac/eventactionplans.model',
'xecmpf/widgets/eac/impl/actionplan.list/impl/actionplan.toolbaritems',
'xecmpf/widgets/eac/impl/actionplan.list/actionplan.listitem.view',
'hbs!xecmpf/widgets/eac/impl/actionplan.list/impl/actionplan.list',
'i18n!xecmpf/widgets/eac/impl/nls/lang',
'css!xecmpf/widgets/eac/impl/actionplan.list/impl/actionplan.list'], function(_, $, Backbone, Marionette, ConnectorFactory, PerfectScrollingBehavior, TableRowSelectionToolbarView, NodeModel, EACEventActionPlans, toolbarItems, ActionPlanListItemView, ActionPlanListTemplate, lang) {
    /**
     * Function: ActionPlanListItemCollectionView
     * Collection view to represent set of action plans. uses ActionPlanListItemView to represent each action plan item
     * Handles click on the child item and trigger it again to propagate event
     */
    var ActionPlanListItemCollectionView = Marionette.CollectionView.extend({
        className: 'xecmpf-action-plan-list-rows',
        tagName: 'ul',
        constructor: function ActionPlanListItemCollectionView(options) {
            options = options || {};
            this.options = options;
            this._focusIndex = 0;
            Marionette.CollectionView.prototype.constructor.call(this, options);

            
        },
        childView: ActionPlanListItemView,
        childEvents: {
            'click:actionplan:item': 'onActionPlanClickItem',
            'click:actionplan': 'onClickAddActionPlan',
            'click:actionplan:delete': 'onActionPlanDelete',
            'click:actionplan:rename':'onActionPlanRename',
            'keydown:action:rename':'onEditAction'
        },
        events:{
            'keydown' : 'onkeyInView'
        },
        /**
         * Function: childViewOptions 
         * Provides context to child view
         * */     
        childViewOptions: function(model, index) {
            return {
                context: this.options.context,
                originatingView: this,
                actionPlanListView: this.options.originatingView
            }
        },  

        onEditAction:function(src){           
            this.triggerMethod('keydown:action:rename',src);
        },

        /**
         * Function: onActionPlanClickItem
         * retriggers click item with triggerMethod
         * */    
        onActionPlanClickItem: function(src) {
            this.triggerMethod('actionplan:click:item', src);
        },

        onClickAddActionPlan: function(src) {
            this.triggerMethod('click:add:actionplan', src);
        },

        /**
         * Function: onActionPlanDelete
         * retriggers click item with triggerMethod
         * */ 
        onActionPlanDelete: function(src) {
            this.triggerMethod('actionplan:click:delete', src);
        },
        onActionPlanRename: function(src) {
            this.triggerMethod('actionplan:click:rename', src);
        },
        onActionPlanRenameCancel: function (src) {
            var currentEle = this.$el.find('.binf-active');
            $(currentEle).removeClass('binf-active');
            src.$el.addClass('binf-active');
        },
        /**
         * Function: onkeyInView
         * Used in keyboard navigation
         */
        onkeyInView: function (event) {
            var nextActionPlan, nextView,
               currentView =  this.children.findByModel(this.collection.at(this._focusIndex));
            switch (event.keyCode) {
                case 38: // up arrow key
                case 40: // down arrow key
                    event.preventDefault();
                    event.stopPropagation();
                    if (event.keyCode === 38 && this._focusIndex > 0) {
                        this._focusIndex--;
                    } else if (event.keyCode === 40 && this._focusIndex < this.children.length-1) {
                        this._focusIndex++;
                    }
                    nextView = this.children.findByModel(this.collection.at(this._focusIndex));
                    this._changeTabIndexesAndSetFocus(currentView, nextView, true);
                    nextView._setFocus();
                    break;
                case 9:
                    if (event.shiftKey) {
                        event.preventDefault();
                        event.stopPropagation();
                        if (this.options.originatingView.actionsRegion.$el.is(':visible')) {
                            this.options.originatingView.actionsRegion.$el.find('li[data-csui-command="delete"] > a').prop('tabindex', '0');
                            this.options.originatingView.actionsRegion.$el.find('li[data-csui-command="delete"] > a').trigger('focus');
                        } else if (event.target.classList.contains('actionplan-object-title-cancel')) {
                            $(event.target).siblings('.xecmpf-eac-action-plan-list-item-input').trigger('focus');
                        } else {
                            this.$el.closest('.xecmpf-actionplan-details').find('.xecmpf-back-button-container').prop('tabindex', '0');
                            this.$el.closest('.xecmpf-actionplan-details').find('.xecmpf-back-button-container').trigger('focus');
                        }
                        if (currentView.ui.actionPlanNameInput.is($(event.target))) {
                            currentView._submitDescription();
                        }
                    } else if (currentView.ui.actionPlanNameInput.is($(event.target))) {
                        event.preventDefault();
                        event.stopPropagation();
                        currentView.ui.actionPlanNameCancel.trigger('focus');
                    } else if (event.target.classList.contains('xecmpf-eac-action-plan-list-item-input')) {
                        event.preventDefault();
                        event.stopPropagation();
                        $(event.target).siblings('.actionplan-object-title-cancel').trigger('focus');
                    } else {
                        event.preventDefault();
                        event.stopPropagation();
                        this.$el.closest('.xecmpf-actionplan-details').find('li[role="presentation"] > .cs-tablink').first().trigger('focus');
                        if (currentView.ui.actionPlanNameCancel.is($(event.target))) {
                            currentView._submitDescription();
                        }
                    }
                    break;
                case 36: // home button
                    event.preventDefault();
                    event.stopPropagation();
                    this._focusIndex = 0;
                    nextView = this.children.findByModel(this.collection.at(this._focusIndex));
                    this._changeTabIndexesAndSetFocus(currentView, nextView, true);
                    nextView._setFocus();
                    break;
                case 35: // end button 
                    event.preventDefault();
                    event.stopPropagation();
                    this._focusIndex = this.children.length-1;
                    nextView = this.children.findByModel(this.collection.at(this._focusIndex));
                    this._changeTabIndexesAndSetFocus(currentView, nextView, true);
                    nextView._setFocus();
                    break;      
            }
        },
        /**
         * Function: _changeTabIndexesAndSetFocus
         * Used to change the tabindex and set the focus on next action plan.
         */
        _changeTabIndexesAndSetFocus: function (currentView, nextView, showDeleteIcon) {
            //tabindex change
            currentView.$el.find('a').prop('tabindex', -1)
            currentView.$el.find('.xecmpf-eac-action-plan-list-item-delete-btn').prop('tabindex', -1)
            currentView.$el.find('.xecmpf-eac-action-plan-list-item-delete-btn').hide();
            currentView._hasFocus = false;
            nextView.$el.find('a').prop('tabindex', 0);
            nextView.$el.find('.xecmpf-eac-action-plan-list-item-delete-btn').prop('tabindex', 0);
            if (showDeleteIcon) {
                nextView.$el.find('.xecmpf-eac-action-plan-list-item-delete-btn').show();
            }
            nextView._hasFocus = true;
        },
        /**
         * Function: onFocusoutActionPlan
         * On focus out of the ActionPlanCollectionList hiding the delete button 
         */
        onFocusoutActionPlan: function (childView, event) {
            if (event.relatedTarget) {
                if ($.contains(this.el, event.relatedTarget) === false) {
                    // focus out of this view
                    childView.$el.find('.xecmpf-eac-action-plan-list-item-delete-btn').hide();
                }
            }
        }

    });

    /**
     * Function: ActionPlanListView
     * It show add action plan button and action plans collection.     
     */
    var ActionPlanListView = Marionette.LayoutView.extend({
        className:'xecmpf-eac-action-plan-list-view',
        constructor: function ActionPlanListView(options) {
            options = options || {};
            /**
             * Populates collection from the action_plans data in the model passed in. It maps namespace and event_name 
             * to collection models as those are used in rules view 
             */
            if (!!options.model && !options.model.action_plans) {
                options.model.attributes.action_plans = options.model.collection.models.map(function(action_plan) {
                    action_plan.namespace = options.model.attributes.system_name;
                    action_plan.event_name = options.model.attributes.name;
                    action_plan.event_def_id = options.model.attributes.id;
                    action_plan.event_id = options.model.attributes.id;
                    return action_plan;
                });
                options.collection = new Backbone.Collection(options.model.attributes.action_plans);
            }
            this.options = options;
          
            Marionette.LayoutView.prototype.constructor.call(this, options);
        },
        template: ActionPlanListTemplate,
        templateHelpers: function() {
            return {
                showAddActionPlan: !!this.options.showAddActionPlan,
                newActionPlanLabel: lang.newActionPlan,
                actionPlansListHeader:  lang.actionPlansListHeader,
                actionPlansGroup: lang.actionPlansGroup,
                addToWareHouse:lang.addToWareHouse,
                delete:lang.deleteActionPlanButton
            }
        },
        behaviors: {
            PerfectScrolling: {
                behaviorClass: PerfectScrollingBehavior,
                contentParent: '.xecmpf-action-plan-list-rows',
                suppressScrollX: true,
                // like bottom padding of container, otherwise scrollbar is shown always
                scrollYMarginOffset: 15
            }
        },
        regions: {
            actionPlanListRegion: '.xecmpf-eac-action-plan-list',
            actionsRegion: ".xecmpf-action-plan-actions-list-container"
        },
        hideOptions: function () {
            if (!!event && $(event.target).closest('.xecmpf-more-action-plan-list-container').length === 0) {
                $('.xecmpf-more-action-plan-list-container').removeClass('binf-open');
            }
        },
        /**
         * Function: onRender
         * Creates collection view and shows it in the region
         */
        onRender: function() {            
            this.actionPlanListItemCollectionView = new ActionPlanListItemCollectionView({
                 collection: this.options.collection,
                 context: this.options.context,
                 originatingView: this
            });
            this.actionPlanListRegion.show(this.actionPlanListItemCollectionView);
            if (this.options.collection.length === 0 || this.options.model.get('isAddActionPlan')) {
                // no action plans are present, view might have been opened from Add Action plan button click
                this.addNewActionPlan(); // to open first action plan item by default
            }
            this.$el.find('.xecmpf-action-plan-actions-list-container').addClass('binf-hidden');
            this.$el.on('click.dropdown.close', _.bind(this.hideOptions, this));
     
        },
        ui: {
            'addActionEle': '.xecmpf-eac-add-action-plan-btn',
            'ulelement':'.xecmpf-more-action-plan-list-container',
        },
        events: {
            'click @ui.addActionEle': 'onAddActionPlanClick',
            'keydown @ui.addActionEle': 'onAddActionPlanKeydown',
            'click @ui.ulelement': function (event) {
                if ($('.xecmpf-more-action-plan-list-container').hasClass('binf-open')) {
                    $('.xecmpf-more-action-plan-list-container').removeClass('binf-open');
                    $(event.currentTarget).addClass('binf-open');
                } else {
                    $(event.currentTarget).addClass('binf-open');
                }
            },
            'focusout @ui.ulelement': function (event) {

            }
        },
        childEvents: {
            'actionplan:click:item': 'onActionPlanClick',
            'click:add:actionplan': 'onClickAddActionPlan',
            'actionplan:click:delete': 'onActionPlanDelete',
            'actionplan:click:rename': 'onActionPlanRenameEdit',
            'actionplan:click:renamecancel': 'onActionPlanCancelRename',
            'keydown:action:rename':'onEditAction',
            'show:actionplan:moreButton':'showMoreBtn'

        },
         
        showMoreBtn: function (childView, src) {
            var res,
                that = this,
                selectedNodeCollection = new Backbone.Collection();
            res = _.filter(childView.model.collection.models, function (model) {
                if (model.get('checked')) {
                    selectedNodeCollection.add(model);
                    return model.get('checked') === true;
                }
            });
            if (res.length > 0) {
                this.showToolBar();
                if (!!this.model) {
                    that.tablerowselectiontoolbar = new TableRowSelectionToolbarView({
                        toolItemFactory: toolbarItems.headerActionbar,
                        // if toolbarCommandController is not defined, a new ToolbarCommandController
                        // with the following commands is created
                        selectedChildren: selectedNodeCollection,
                        container: that.model,
                        context: that.options.context,
                        originatingView: that.options.originatingView,
                        collection: that.collection
                    });
                    that.actionsRegion.show(that.tablerowselectiontoolbar);
                    that.listenTo(that.tablerowselectiontoolbar._commandController, 'after:execute:command', function (eventArgs) {
                       that.deleteActionPlan(eventArgs);
                    });
                }
            } else {
                this.hideToolBar();
            }
        },
        /**
         * Function: onActionPlanClick
         * triggers event to propagate to parent views.
         */
        onEditAction: function (childView, src) {

            var editcancelClicked =
                    event.relatedTarget ? $(event.relatedTarget).find(
                        '.xecmpf-eac-action-plan-list-item-cancelrename-btn.cancelrename-write-mode') :
                    '';
            if (!!editcancelClicked) {
                this.onActionPlanCancelRename(childView, src);

            } else {
                src.$el.find(".xecmpf-eac-action-plan-list-item-text").removeClass(
                    'binf-active binf-edit-active');
                var value = event.target.value;
                // src.model.set({name:value}); 
                childView.render();
            }

        },
        onActionPlanClick: function(childView, src) {
            this.trigger('actionplan:click:item', src);
        },

        onClickAddActionPlan: function(childView, src) {
            this.trigger('click:add:actionplan', src);
        },

        onActionPlanDelete: function(childView, src) {
            this.trigger('actionplan:click:delete', src);
        },

        onActionPlanRenameCancel: function(childView, src) {
            this.trigger('actionplan:click:renamecancel', src);
        },

        /**
         * Function: onActionPlanRename
         * triggers event to propagate to parent views.
         */
        onActionPlanRenameEdit: function (childView, src) {
            src.$el.addClass('binf-edit-active');
            src.$el.find(".binf-flex-row.xecmpf-eac-action-plan-name-link").addClass('binf-hidden');
            src.$el.find(".xecmpf-eac-action-plan-list-item-text").removeClass('binf-hidden');
            var currentVaule = src.$el.find('.xecmpf-eac-action-plan-name').text();
            src.$el.find(".xecmpf-eac-action-plan-list-item-text")[0].value = currentVaule;
            src.$el.find(".binf-btn.xecmpf-eac-action-plan-list-item-cancelrename-btn").addClass(
                "cancelrename-write-mode").removeClass("binf-hidden");
            src.$el.find(".binf-btn.xecmpf-eac-action-plan-list-item-rename-btn").addClass(
                "binf-hidden");
            src.$el.find(".xecmpf-more-actions-container").addClass("binf-hidden");

        },

        onActionPlanCancelRename: function (childView, src) {
            src.$el.find(".xecmpf-more-actions-container").removeClass("binf-hidden");
            src.$el.removeClass('binf-edit-active');
            src.$el.find(".binf-flex-row.xecmpf-eac-action-plan-name-link").removeClass(
                'binf-hidden');
            src.$el.find(".xecmpf-eac-action-plan-list-item-text").addClass('binf-hidden');
            src.$el.find(".xecmpf-eac-action-plan-list-item-text").removeClass(
                'binf-active binf-edit-active');
            src.$el.find(".binf-btn.xecmpf-eac-action-plan-list-item-cancelrename-btn").removeClass(
                "cancelrename-write-mode").addClass("binf-hidden");
            src.$el.find(".binf-btn.xecmpf-eac-action-plan-list-item-rename-btn").removeClass(
                "binf-hidden");

        },

        /**
         * Function: onAddActionPlanClick
         * triggers event to propagate to parent views.
         */  
        onAddActionPlanClick: function(src) {
            this.trigger('actionplan:add:item', src)
        },

        onAddActionPlanKeydown: function(event) {
            if (event.keyCode === 13) {
                this.onAddActionPlanClick(event);
            }
        },

        /**
         * Function: addNewActionPlan
         * It adds new model into collection to represent the new action plan and re-renders the form 
         */
        addNewActionPlan: function() {
            var model = this.actionPlanListItemCollectionView.collection.findWhere({ plan_id: '' }),
                namespace = !!this.options.model.attributes.namespace ? this.options.model.attributes.namespace : this.options.model.attributes.system_name,
                event_name = !!this.options.model.attributes.event_name ? this.options.model.attributes.event_name : this.options.model.attributes.name,
                event_def_id = !!this.options.model.attributes.event_def_id ? this.options.model.attributes.event_def_id : this.options.model.attributes.id;
            if (!model) {
                var newActionListItemModel = new NodeModel(undefined, { connector: this.options.connector }),
                    newActionListItem;
                newActionListItemModel.set({
                    plan_id: '',
                    process_mode: '',
                    rule_id: '',
                    rules: [{}],
                    namespace: namespace,
                    event_name: event_name,
                    event_def_id: event_def_id,
                    event_id: this.options.model.attributes.event_id,
                    eventType: this.options.model.attributes.event_type,
                    hideCheckBox: true,
                    isAddActionPlan: true
                });
                this.actionPlanListItemCollectionView.collection.add(newActionListItemModel); // adding to collection
                newActionListItem = this.actionPlanListItemCollectionView.children.findByModel(newActionListItemModel);
                newActionListItem.trigger('click:actionplan');
                newActionListItem.$el.find('.xecmpf-eac-action-plan-list-item-input').trigger('focus');
            }
            else {
                model = this.actionPlanListItemCollectionView.children.findByModel(model);
                model.trigger('click:actionplan:item');
            }
        },

        /**
         * Function: fetchEventActionPlans
         * Makes service call to fetch eventplan actions data
         * Returns: Promise
         */
        fetchEventActionPlans: function() {
            // method to refresh the collection
            var deferred = $.Deferred(),
                that = this,
                connector = this.options.context.getObject(ConnectorFactory),
                ajaxOptions;

            ajaxOptions = {
                type: 'GET',
                url: connector.getConnectionUrl().getApiBase('v2') + '/eventactioncenter/actionplandetails?action_plan_id=' + this.model.get('id')
            };
            connector.makeAjaxCall(ajaxOptions)
                .done(function (response, statusText, jqxhr) {
                    if (response) {
                        if (response.results.data) {
                            that.model.set('data', response.results.data);
                            that.model.set('event_def_id', that.model.get('event_def_id'));
                            var actionPlanModel = new NodeModel({ id: that.model.attributes.id },
                                {
                                    connector: that.options.connector,
                                    includeActions: true,
                                    commands: ["rename", "delete", "addToWarehouse"]
                                });
                            actionPlanModel.connector = that.options.connector;
                            actionPlanModel.fetch().done(function () {
                                that.options.originatingView.children.add(actionPlanModel);
                                actionPlanModel.set('data', that.model.get('data'));
                                actionPlanModel.set('event_def_id', that.model.get('event_def_id'));
                                actionPlanModel.set('eventType', response.results.data.eventType);
                                that.actionPlanListItemCollectionView.collection.remove(that.model);
                                that.actionPlanListItemCollectionView.collection.set(actionPlanModel, { remove: false });
                                deferred.resolve(that.actionPlanListItemCollectionView.collection);
                            });
                        }
                    }
                }).fail(function (jqXHR, statusText, error) {
                    deferred.reject();
                });
            return deferred.promise();
        },

        /**
         * Function: refreshCurrentActionPlanItem
         * It makes service call to fetch updated event action plan data, 
         * Once data fetched it filters event model through event id
         * Fetches action plan through plan id from the event model.
         */
        refreshCurrentActionPlanItem: function(eventInfo) {
            var planID = eventInfo.planID,
                modelToBeUpdated,
                $deferred = $.Deferred();
            if (eventInfo.operation === 'create') {
                // as it is create operatin fetch model with empty plan id
                modelToBeUpdated = this.actionPlanListItemCollectionView.collection.findWhere({ plan_id: '' });
            } else {
                // fetching model through plan id
                modelToBeUpdated = this.actionPlanListItemCollectionView.collection.findWhere({ id: planID });
                this.model= modelToBeUpdated;
            }
            if (!!modelToBeUpdated) {
                var that = this;
                // TODO: Fetch only action plan which is required. currently fetching total events action plans
                // fetching new collection
                this.fetchEventActionPlans().then(function(eacPlansCollection) {
                    var eventModel = eacPlansCollection.findWhere({ id: eventInfo.planID });
                    if (eventModel ) {
                            eventModel.set('isAddActionPlan',false);
                            eventModel.set('planCreated',false);
                            that.actionListItemToRetrigger = that.actionPlanListItemCollectionView.children.findByModel(eventModel);
                            $deferred.resolve(that.actionListItemToRetrigger);
                        }
                        else {
                            modelToBeUpdated.trigger('delete:action:plan');
                            $deferred.reject();
                        }
                }, function() {
                    $deferred.reject();
                });
            } else {
                $deferred.reject();
            }
            return $deferred.promise();
        },
        hideToolBar: function(){
            this.$el.find('.xecmpf-action-plan-actions-list-container').addClass('binf-hidden');
            this.$el.find('.xecmpf-eac-action-plan-header').removeClass('binf-hidden');
        },
        showToolBar: function(){
            this.$el.find('.xecmpf-eac-action-plan-header').addClass('binf-hidden');
            this.$el.find('.xecmpf-action-plan-actions-list-container').removeClass('binf-hidden');
        },
        deleteActionPlan: function (eventArgs) {
            var model;
            if (eventArgs.commandSignature === 'Delete') {
                this.hideToolBar();
                 for (var index = 0; index < this.actionPlanListItemCollectionView.collection.length; index++) {
                     model = this.actionPlanListItemCollectionView.collection.models[index];
                    if (!!model && model.get('checked')) {
                         model.trigger('toggle:checkbox');   
                     }
                 }
               
            }
        }
    });

    return ActionPlanListView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/eac/impl/actionplan.header/impl/actionplan.header',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"xecmpf-back-button-container\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"backTitle") || (depth0 != null ? lookupProperty(depth0,"backTitle") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"backTitle","hash":{},"loc":{"start":{"line":1,"column":49},"end":{"line":1,"column":62}}}) : helper)))
    + "\" tabindex=\"0\"\r\n     aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"backTitle") || (depth0 != null ? lookupProperty(depth0,"backTitle") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"backTitle","hash":{},"loc":{"start":{"line":2,"column":17},"end":{"line":2,"column":30}}}) : helper)))
    + "\" role=\"button\">\r\n  <span class=\"arrow_back cs-go-back\"></span>\r\n</div>\r\n<div class=\"xecmpf-actionplan-title\">\r\n  <h2 class=\"title\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"title") || (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"title","hash":{},"loc":{"start":{"line":6,"column":20},"end":{"line":6,"column":29}}}) : helper)))
    + "</h2>\r\n</div>\r\n";
}});
Handlebars.registerPartial('xecmpf_widgets_eac_impl_actionplan.header_impl_actionplan.header', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/eac/impl/actionplan.header/impl/actionplan.header',[],function(){});
csui.define('xecmpf/widgets/eac/impl/actionplan.header/actionplan.header.view',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/marionette',
  'hbs!xecmpf/widgets/eac/impl/actionplan.header/impl/actionplan.header',
  'i18n!xecmpf/widgets/eac/impl/nls/lang',
  'css!xecmpf/widgets/eac/impl/actionplan.header/impl/actionplan.header'
], function (_, $, Marionette, template, lang) {

  var ActionPlanHeaderView = Marionette.ItemView.extend({

    className: 'xecmpf-actionplan-header',

    template: template,

    events: {
      'keydown .xecmpf-back-button-container': 'onKeyInView',
      'click .cs-go-back': 'onClickBackButton'
    },

    templateHelpers: function () {
      return {
        title: this.model.get('name'),
        backTitle: lang.backTitle
      };
    },

    constructor: function ActionPlanHeaderView(options) {
      Marionette.ItemView.prototype.constructor.apply(this, arguments);
    },

    onKeyInView: function (event) {
      if (event.keyCode === 32 || event.keyCode === 13) {
        this.onClickBackButton();
      }
    },

    onClickBackButton: function() {
      this.trigger('actionplan:click:back');
    }
  });

  return ActionPlanHeaderView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/eac/impl/actionplan.processmode/impl/actionplan.processmode',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class='xecmpf-eac-processmode-view'>\r\n    <div class=\"xecmpf-eac-header\">\r\n        <h4 class=\"xecmpf-eac-processmode-header\" title=\"{{options.header}}\" aria-label=\"{{options.header}}\">{{options.header}}</h4>\r\n    </div>\r\n    <div class=\"xecmpf-eac-processmode-form\">\r\n        <div class=\"xecmpf-eac-processmode-runas\" id=\"xecmpf-eac-processmode-run_as\"></div>\r\n        <div class=\"xecmpf-eac-processmode-processmode\" id=\"xecmpf-eac-processmode-process_mode\"></div>\r\n    </div>\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_widgets_eac_impl_actionplan.processmode_impl_actionplan.processmode', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/eac/impl/actionplan.processmode/impl/actionplan.processmode',[],function(){});
csui.define('xecmpf/widgets/eac/impl/actionplan.processmode/actionplan.processmode.view',['require', 'csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/backbone',
    'csui/controls/form/form.view',
    'hbs!xecmpf/widgets/eac/impl/actionplan.processmode/impl/actionplan.processmode',
    'i18n!xecmpf/widgets/eac/impl/nls/lang',
    'css!xecmpf/widgets/eac/impl/actionplan.processmode/impl/actionplan.processmode',
], function (require, _, $, Backbone, FormView, formTemplate, lang) {

    var ActionPlanProcessModeView = FormView.extend({

        constructor: function ActionPlanProcessModeView(options) {
            FormView.prototype.constructor.call(this, options);
        },

        formTemplate: formTemplate,

        formTemplateHelpers: function() {
            return {
                header : lang.processModeTabLabel
            };
        },

        _getLayout: function () {
            var template = this.getOption('formTemplate'),
                html = template.call(this, {
                    data: this.alpaca.data,
                    mode: this.mode
                }),
                bindings = this._getBindings(),
                view = {
                    parent: 'bootstrap-csui',
                    layout: {
                        template: html,
                        bindings: bindings
                    }
                };
            return view;
        },

        _getBindings: function () {
            return {
                run_as: 'xecmpf-eac-processmode-run_as',
                process_mode: 'xecmpf-eac-processmode-process_mode'
            };
        }

    });
    
    return ActionPlanProcessModeView;
});


csui.define('xecmpf/widgets/eac/impl/actionplan.processmode/impl/actionplan.processmode.form.model',['csui/models/form', 'i18n!xecmpf/widgets/eac/impl/nls/lang'], function (FormModel, lang
) {

    var ActionPlanProcessModeFormModel = FormModel.extend({
        constructor: function ActionPlanProcessModeFormModel(attributes, options) {
            this.options = options || (options = {});
            attributes || (attributes = {
                schema: { properties: {} },
                options: { fields: {} },
                date: {}
            });
            FormModel.prototype.constructor.call(this, attributes, options);
        },

        initialize: function (attributes, options) {
            this._setAttributes();
        },

        _setAttributes: function () {
            var that = this;
            var run_as = '';
            var process_mode = '';
            if(!!this.options.eventModel && !!this.options.eventModel.attributes.data && !!this.options.eventModel.attributes.data.processMode){
                process_mode = this.options.eventModel.attributes.data.processMode
            }
            if(!!this.options.eventModel && !!this.options.eventModel.attributes.data && !!this.options.eventModel.attributes.data.runAs){
                run_as = this.options.eventModel.attributes.data.runAs
            }
            
            this.set({
                schema: {
                    properties: {
                        run_as: {
                            required: true,
                            type: "otcs_user_picker"
                        },
                        process_mode: {
                            type: "text",
                            readonly: true,
                            default: lang.asynchronouslyProcessLabel
                        }
                    }
                },
                options: {
                    fields: {
                        run_as: {
                            label: lang.runAs,
                            type: "otcs_user_picker",
                            events: {
                                change: function () {
                                    that.setValue(this.path, this.getValue());
                                }
                            }
                        },
                        process_mode: {
                            label: lang.processMode,
                            type: "text",
                            readonly: true,
                            removeDefaultNone: true
                        }
                    }
                },
                data: {
                    run_as: run_as,
                    process_mode: process_mode
                }
            });
        }

    });
    return ActionPlanProcessModeFormModel;
});
csui.define('xecmpf/models/eac/eac.planproperties.model',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/backbone',
    'csui/models/mixins/connectable/connectable.mixin',
    'csui/models/mixins/fetchable/fetchable.mixin',
    'csui/utils/url',
], function (_, $, Backbone, ConnectableMixin, FetchableMixin, Url) {

    var EACPlanPropertiesModel = Backbone.Model.extend({
        constructor: function EACPlanPropertiesModel(attributes, options) {
            this.options = options || {};
            Backbone.Model.prototype.constructor.apply(this, arguments);
            this.makeConnectable(options);
        },
        parse: function (response) {
            return response;
        }
    });
    ConnectableMixin.mixin(EACPlanPropertiesModel.prototype);

    var EACPlanPropertiesCollection = Backbone.Collection.extend({

        model: EACPlanPropertiesModel,

        constructor: function EACPlanPropertiesCollection(models, options) {
            this.options = options || {};
            Backbone.Collection.prototype.constructor.apply(this, arguments);
            this.makeConnectable(options)
                .makeFetchable(options);
        },

        url: function () {
            var url = new Url(this.connector.connection.url).getApiBase('v2');
            url = Url.combine(url, 'eventactioncenter', 'eventproperties');
            return url + this.queryParamsToString(this.options.query);
        },

        parse: function (response) {
            return response.results.data;
        },

        queryParamsToString: function (params) {
            var query = '';
            if (!_.isEmpty(params)) {
                query = '?' + $.param(params);
            }
            return query.replace(/%5B%5D/g, '');
        }
    });

    ConnectableMixin.mixin(EACPlanPropertiesCollection.prototype);
    FetchableMixin.mixin(EACPlanPropertiesCollection.prototype);

    return EACPlanPropertiesCollection;
});

csui.define('xecmpf/models/eac/eac.planproperties.factory',['csui/lib/underscore', 'csui/lib/backbone',
  'csui/utils/contexts/factories/factory', 'csui/utils/contexts/factories/connector',
  'xecmpf/models/eac/eac.planproperties.model'
], function (_, Backbone,
  CollectionFactory, ConnectorFactory,
  EACPlanPropertiesCollection) {
    var EACPlanPropertiesFactory = CollectionFactory.extend({
      propertyPrefix: 'EACPlanPropertiesCollection',
      constructor: function EACPlanPropertiesFactory(context, options) {
        CollectionFactory.prototype.constructor.apply(this, arguments);
        var eacCollection = this.options.EACPlanPropertiesCollection || {};
        if (!(eacCollection instanceof Backbone.Collection)) {
          var event_definition_id;
          if(!!options.eventModel){
            event_definition_id = !!options.eventModel.get('event_def_id') ? options.eventModel.get('event_def_id') : options.eventModel.get('id');
          } else {
            event_definition_id = !!options.eventModel.get('event_def_id') ? options.eventModel.attributes.event_def_id : options.eventModel.attributes.id;
          }
          eacCollection = new EACPlanPropertiesCollection(eacCollection.models, _.extend({
            connector: context.getModel(ConnectorFactory),
            query: {
              event_definition_id: event_definition_id
            },
            autofetch: true
          }, eacCollection.options));
        }
        this.property = eacCollection;
      },
      fetch: function (options) {
        return this.property.fetch(options);
      }
    });
    return EACPlanPropertiesFactory;
  });
'use strict'

csui.define('xecmpf/widgets/eac/impl/actionplan.rules/impl/actionplan.rules.form.model',['csui/lib/jquery', "csui/utils/base", 'csui/lib/underscore', 'csui/models/form',
    'xecmpf/models/eac/eac.planproperties.factory',
    'i18n!xecmpf/widgets/eac/impl/nls/lang'
], function ($, base, _, FormModel, EACPlanPropertiesFactory, lang) {
    /**
     * Function: EACRulesFormModel
     * Model contains alpaca schema and options configurations for rules form 
     */
    var EACRulesFormModel = FormModel.extend({

        constructor: function EACRulesFormModel(attributes, options) {
            this.options = options || (options = {});
            attributes || (attributes = {
                data: {},
                schema: { properties: {} },
                options: { fields: {} }
            });
            FormModel.prototype.constructor.call(this, attributes, options);
        },

        /**
         * Function: initialize
         * Fetches plan properties by passing Event Definition Id. Sets model attributes after fetching data
         */
        initialize: function (attributes, options) {
            var event_definition_id = options.eventModel.get('id') ? options.eventModel.get('parent_id') : options.eventModel.get('event_def_id');
            var eacPlanProperties = options.context.getCollection(EACPlanPropertiesFactory, {
                eventModel: options.eventModel,
                attributes: {
                    event_definition_id: event_definition_id
                }
            });
            this.eacPropertiesCollection = eacPlanProperties;
            if (!!eacPlanProperties && !eacPlanProperties.type) {
                this.listenToOnce(eacPlanProperties, 'sync', function () {
                    eacPlanProperties.planProperties = eacPlanProperties.map(function (model) {
                        return model.get('name');
                    });
                    eacPlanProperties.type = eacPlanProperties.map(function (model) {
                        return model.get('alpacaFieldType').toLowerCase();
                    });
                    this._setAttributes(eacPlanProperties, eacPlanProperties.planProperties, eacPlanProperties.type);
                });
                eacPlanProperties.fetch();
            } else {
                this._setAttributes(eacPlanProperties, eacPlanProperties.planProperties, eacPlanProperties.type);
            }
        },

        /**
         * Function: _setAttributes
         * Sets schema and options configuration values to the model attributes for rules forms 
         */
        _setAttributes: function (eacPlanProperties, planProperties, type) {
            var formData = [];
            var modelData = {};
            var attributes, exe, propType;
            if (this.options.collection) {
                // preparing formData to show previous data
                formData = this.options.collection.models.map(function (modelObj, index) {
                    exe = modelObj.get('operand');
                    propType = !!exe && eacPlanProperties.findWhere({ name: exe }).get('type');
                    modelData = {
                        from: modelObj.get('operand'),
                        operator: lang.rulesFieldPlaceholder,
                        conjunction: modelObj.get('conjunction'),
                        value: ''
                    }
                    if (!!exe) {
                        modelData["operator" + exe] = modelObj.get('operator');
                        modelData["value" + exe] = modelObj.get('to');
                        if( propType === "Classification" ) {
                            switch (modelObj.get('to')) {
                                case "0":
                                    modelData["value" + exe] = "Unclassified";
                                    break;
                                case "1":
                                    modelData["value" + exe] = "Any";
                                    break;
                                default:    
                                    modelData["value" + exe] = "Custom";
                                    modelData["to2" + exe] = modelObj.get('to');
                                    break;
                            }  
                        }
                        if (exe === "Category Attribute" && modelObj.get('categoryDetails')) {
                            var categoryDetails = modelObj.get('categoryDetails');
                            modelData["categorDetails"] = categoryDetails;
                            switch (categoryDetails.typeName) {
                                case "Date":
                                    modelData["to2" + exe + "date"] = categoryDetails.expValue;
                                    break;
                                case "Integer":
                                    modelData["to2" + exe + "integer"] = categoryDetails.expValue;

                                    break;
                                case "User":
                                    modelData["to2" + exe + "otcs_user_picker"] = categoryDetails.expValue;

                                    break;
                                case "StringField":
                                    modelData["to2" + exe] = categoryDetails.expValue;

                                    break;
                                case "StringPopup":
                                    modelData["to2" + exe] = categoryDetails.expValue;

                                    break;
                                case "IntegerPopup":
                                    modelData["to2" + exe] = categoryDetails.expValue;
                                    break;
                                case "Boolean":
                                    modelData["to2" + exe + "checkbox"] = (categoryDetails.expValue === 'true') ? true : false;
                                    break;
                            }
                        }
                    }
                    for (var i = 0; i < planProperties.length; i++) {
                        if (!modelData["operator" + planProperties[i]]) {
                            modelData["operator" + planProperties[i]] = '';
                            modelData["value" + planProperties[i]] = '';
                        }
                    }
                    return modelData;
                });
            }
            attributes = {
                "options": {
                    "fields": {
                        "rulesSet": {
                            "fields": {
                                "item": {
                                    "fields": {
                                        "conjunction": {
                                            "hidden": false,
                                            "hideInitValidationError": true,
                                            "optionLabels": [lang.conjunctionAndLabel, lang.conjunctionOrLabel],
                                            "label": lang.conjunctionFieldLabel,
                                            "readonly": false,
                                            "type": "select",
                                            "removeDefaultNone": true
                                        },
                                        "from": {
                                            "hidden": false,
                                            "hideInitValidationError": true,
                                            "label": lang.fromFieldLabel,
                                            "readonly": false,
                                            "type": "select"

                                        },
                                        "operator": {
                                            "hidden": false,
                                            "hideInitValidationError": true,
                                            //TODO: Once "LPAD-86194" and "XECMPF-2157" are resolved,
                                            //"placeholder" attribute should be used to display the default label(placeholder for select field) insteadof "optionLabels" first argument(to be removed)
                                            "optionLabels": [lang.rulesFieldPlaceholder, lang.operatorEqualtoLabel, lang.operatorNotequaltoLabel],
                                            "label": lang.operatorFieldLabel,
                                            "readonly": false,
                                            "type": "select",
                                            "dependencies": { "from": "" },
                                            "disabled": true,
                                            "removeDefaultNone": true

                                        },
                                        "value": {
                                            "hidden": false,
                                            "hideInitValidationError": true,
                                            "label": lang.toFieldLabel,
                                            "readonly": false,
                                            "type": "text",
                                            "dependencies": { "from": "" },
                                            "disabled": true,
                                            "placeholder": lang.rulesFieldPlaceholder
                                        }
                                    },
                                    "type": "object"
                                }
                            },
                            "hidden": false,
                            "hideInitValidationError": true,
                            "items": {
                                "showMoveDownItemButton": false,
                                "showMoveUpItemButton": false
                            },
                            "label": "",
                            "toolbarSticky": true,
                            "showMessages": false,
                            "isSetType": true
                        }
                    }
                },
                "schema": {
                    "properties": {
                        "rulesSet": {
                            "items": {
                                "defaultItems": 1,
                                "maxItems": 50,
                                "minItems": 1,
                                "properties": {
                                    "conjunction": {
                                        "enum": ['and', 'or'],
                                        "readonly": false,
                                        "title": lang.conjunctionFieldLabel,
                                        "type": "string"
                                    },
                                    "from": {
                                        "enum": planProperties,
                                        "readonly": false,
                                        "title": lang.fromFieldLabel,
                                        "type": "string"
                                    },
                                    "operator": {
                                        "enum": ['Select value','equal to', 'not equal to'],
                                        "readonly": false,
                                        "title": lang.operatorFieldLabel,
                                        "type": "string",
                                        "dependencies": "from",
                                        "disabled": true
                                    },
                                    "value": {
                                        "maxLength": 248,
                                        "minLength": 1,
                                        "readonly": false,
                                        "title": lang.toFieldLabel,
                                        "type": "string",
                                        "dependencies": "from",
                                        "disabled": true
                                    }
                                },
                                "type": "object"
                            },
                            "title": "",
                            "type": "array"
                        }
                    },
                    "type": "object"
                }
            }
            var actionFieldEnum = [],
                actionFieldLabels = [],
                k, key, planPropertieslength = planProperties.length;
                this.currentTarget=[];
            for ( k = 0; k < planPropertieslength; k++) {
                key = planProperties[k];
                actionFieldEnum.push(key);
                actionFieldLabels.push(key);

                var schema, options, that = this;
                schema = attributes.schema;
    
                schema.properties['rulesSet'].items.properties["operator" + key] = { "enum": {}, "readonly": false, "required": true, "dependencies": "from", "type": "string", "removeDefaultNone": true, "title": lang.operatorFieldLabel, "label": lang.operatorFieldLabel };
                schema.properties['rulesSet'].items.properties["value" + key] = { "dependencies": "from", "type": "string", "title": lang.toFieldLabel, "placeholder": lang.rulesFieldPlaceholder };

                options = attributes.options;
                options.fields['rulesSet'].fields.item.fields["operator" + key] = { "optionLabels": {}, "readonly": false, "type": "select", "required": true, "removeDefaultNone": true, "dependencies": { "from": key }, "label": lang.operatorFieldLabel };
                options.fields['rulesSet'].fields.item.fields["value" + key] = { "dependencies": { "from": key }, "type": "text", "label": lang.toFieldLabel, "placeholder": lang.rulesFieldPlaceholder };
               

                if (!!eacPlanProperties.models[k].get('operators')) {
                    schema.properties['rulesSet'].items.properties["operator" + key].enum = eacPlanProperties.models[k].get('operators');
                    options.fields['rulesSet'].fields.item.fields["operator" + key].optionLabels = eacPlanProperties.models[k].get('operators');
                }
                if (!!eacPlanProperties.models[k].get('key') && ( eacPlanProperties.models[k].get('key') === 'UpdateWorkspaceMetadataEvent.WorkspaceType' ) ) {
                    schema.properties['rulesSet'].items.properties["operator" + key].enum = ["equals", "not equal"];
                    options.fields['rulesSet'].fields.item.fields["operator" + key].optionLabels = [lang.operatorEqualtoLabel, lang.operatorNotequaltoLabel];
                }
                if (eacPlanProperties.models[k].get('values').length > 0) {
                    if (eacPlanProperties.models[k].get('type') === "StringPopup") {
                        schema.properties['rulesSet'].items.properties["value" + key].enum = eacPlanProperties.models[k].get('values');
                        options.fields['rulesSet'].fields.item.fields["value" + key].optionLabels = eacPlanProperties.models[k].get('values');
                        options.fields['rulesSet'].fields.item.fields["value" + key].type = "select";
                    }
                    else {
                        schema.properties['rulesSet'].items.properties["value" + key].enum = eacPlanProperties.models[k].get('values');
                        schema.properties['rulesSet'].items.properties["value" + key].type = "Integer";
                        options.fields['rulesSet'].fields.item.fields["value" + key].optionLabels = eacPlanProperties.models[k].get('values');
                        options.fields['rulesSet'].fields.item.fields["value" + key].type = "select";
                    }
                }
                else {
                    if(!!eacPlanProperties.models[k].get('key') && eacPlanProperties.models[k].get('key') === "UpdateWorkspaceMetadataEvent.CategoryAttribute"){
                        var i = 0, typeArr = ['integer', 'checkbox', 'date', 'otcs_user_picker', 'otcs_node_picker'];
                        schema.properties['rulesSet'].items.properties["to2" + key] = { "dependencies": "valueCategory Attribute", "type": type[k], "required": true };
                        options.fields['rulesSet'].fields.item.fields["to2" + key] = {"hidden":true, "dependencies": {}, "type": type[k], "required": true };
                        options.fields['rulesSet'].fields.item.fields["to2" + key].label = lang.toFieldLabel;
                        options.fields['rulesSet'].fields.item.fields["to2" + key].type = type[k];
                        options.fields['rulesSet'].fields.item.fields["value" + key].validator = function (callback) {
                            var value = this.getValue();
                            if (!that.currentTarget.includes(this)) {
                                that.currentTarget.push(this);
                            }
                            if (value.length > 0 && this.fieldView.preVal !== value) {
                                that.validateValue("category", value).done(function (response) {
                                    if (!!response.results && !response.results.ok) {
                                        callback({
                                            "status": false,
                                            "message": response.results.errMsg
                                        });
                                        that.value = response.links.data.self.href;
                                        that.trigger("field:invalid");
                                    } else {
                                        callback({
                                            "status": true
                                        });
                                        that.categoryResponse = response.results;
                                        that.value = response.links.data.self.href;
                                        that.trigger("field:valid");
                                    }
                                })
                            }
                        }
                        for (i = 0; i < typeArr.length; i++) {
                            schema.properties['rulesSet'].items.properties["to2" + key + typeArr[i]] = { "required": true, "dependencies": "from", "type": typeArr[i], "title": lang.toFieldLabel, "placeholder": lang.rulesFieldPlaceholder };
                            options.fields['rulesSet'].fields.item.fields["to2" + key + typeArr[i]] = { "dependencies": { "from": key }, "hidden": true, "type": typeArr[i], "label": lang.toFieldLabel, "placeholder": lang.rulesFieldPlaceholder };
                        }
                      }
                    if (type[k] === "otcs_node_picker") {
                        if (eacPlanProperties.models[k].get('type') === "Classification") {
                            schema.properties['rulesSet'].items.properties["value" + key].enum = ["Unclassified", "Any", "Custom"];
                            schema.properties['rulesSet'].items.properties["value" + key].type = "select"; 
                            schema.properties['rulesSet'].items.properties["value" + key].required = true;
                            options.fields['rulesSet'].fields.item.fields["value" + key].optionLabels = [lang.Unclassified, lang.Any, lang.Custom];
                            options.fields['rulesSet'].fields.item.fields["value" + key].type = "select";
                            options.fields['rulesSet'].fields.item.fields["value" + key].removeDefaultNone = true;
                            options.fields['rulesSet'].fields.item.fields["value" + key].required = true;
                            schema.properties['rulesSet'].items.properties["to2" + key] = { "dependencies": "valueDocument Type", "type": type[k], "required": true };
                            options.fields['rulesSet'].fields.item.fields["to2" + key] = { "dependencies": {}, "type": type[k] ,"required": true  };
                            options.fields['rulesSet'].fields.item.fields["to2" + key].label = lang.toFieldLabel;
                            options.fields['rulesSet'].fields.item.fields["to2" + key].dependencies["value" + key] = "Custom";
                            options.fields['rulesSet'].fields.item.fields["to2" + key].type_control = {
                                "parameters": {
                                    startLocations: ["classifications/dialogs/node.picker/start.locations/classifications.volume"],
                                    select_types: [196, 199]
                                }
                            };
                            options.fields['rulesSet'].fields.item.fields["to2" + key].type = type[k];

                        } else if (!!eacPlanProperties.models[k].get('key') && ( eacPlanProperties.models[k].get('key') === "UpdateWorkspaceMetadataEvent.WorkspaceTemplate" ) ) {
                            options.fields['rulesSet'].fields.item.fields["value" + key].type_control = {
                                "parameters": {
                                    startLocations: [
                                        "doctemplates/dialogs/node.picker/start.locations/document.templates.volume"
                                    ],
                                    select_types: [848]
                                }
                            };
                            options.fields['rulesSet'].fields.item.fields["value" + key].type = type[k];
                            schema.properties['rulesSet'].items.properties["value" + key].type = type[k];
                        }
                        else {

                            options.fields['rulesSet'].fields.item.fields["value" + key].type_control = {
                                "parameters": {
                                        startLocations: [
                                            "csui/dialogs/node.picker/start.locations/current.location",
                                            "csui/dialogs/node.picker/start.locations/enterprise.volume",
                                            "csui/dialogs/node.picker/start.locations/personal.volume",
                                            "csui/dialogs/node.picker/start.locations/favorites",
                                            "csui/dialogs/node.picker/start.locations/recent.containers",
                                            "csui/dialogs/node.picker/start.locations/perspective.assets.volume",
                                            "xecmpf/dialogs/node.picker/start.locations/extended.ecm.volume.container"
                                        ]
                                    }
                            };
                            options.fields['rulesSet'].fields.item.fields["value" + key].type = type[k];
                            schema.properties['rulesSet'].items.properties["value" + key].type = type[k]; 
                            
                        }

                    }
                    else {
                        options.fields['rulesSet'].fields.item.fields["value" + key].type = type[k];
                        schema.properties['rulesSet'].items.properties["value" + key].type = type[k];
                    }
                    
                }

            }
            attributes.schema.properties["rulesSet"].items.properties["from"].enum = actionFieldEnum;
            attributes.options.fields['rulesSet'].fields.item.fields['from'].optionLabels = actionFieldLabels;
            attributes.data = { rulesSet: formData };
            this.set(attributes);
        },
        validateValue: function (type, value) {
            var deferred = $.Deferred(),
                connector = this.eacPropertiesCollection.connector,
                url = connector.getConnectionUrl().getApiBase('v2') + '/eventactioncenter/validateformfields?field_type=' + type + '&field_value=' + value + '&is_rule=true';

            $.ajax(connector.extendAjaxOptions({
                url: url,
                type: "GET",
                contentType: false,
                crossDomain: true,
                processData: false,
                success: function (response, status, jXHR) {
                    deferred.resolve(response);
                },
                error: function (xhr, status, text) {
                    var error = new base.RequestErrorMessage(xhr);
                    deferred.reject(xhr, status, error.toString());
                }
            }));
            return deferred.promise();
        }
    });

    return EACRulesFormModel;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/eac/impl/actionplan.rules/impl/actionplan.rules',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div>\r\n    <div class=\"xecmpf-eac-rules-header-wrapper binf-col-md-12 xecmpf-eac-header\">\r\n        <h4 class=\"xecmpf-eac-rules-header\" title=\"{{options.rulesLabel}}\" aria-label=\"{{options.rulesLabel}}\">{{options.rulesLabel}}</h4>\r\n    </div>\r\n    <div class=\"xecmpf-eac-rules-container-wrapper\">\r\n        <div class=\"binf-row\">\r\n            <div class=\"xecmpf-eac-rules-container binf-col-md-12 cs-form-singlecolumn csui-form-set-array-wrapper cs-form-set\"></div>\r\n        </div>\r\n    </div>\r\n</div>\r\n";
}});
Handlebars.registerPartial('xecmpf_widgets_eac_impl_actionplan.rules_impl_actionplan.rules', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/eac/impl/actionplan.rules/impl/actionplan.rules',[],function(){});
csui.define('xecmpf/widgets/eac/impl/actionplan.rules/actionplan.rules.view',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/backbone', 'csui/lib/marionette',
    'csui/utils/contexts/factories/connector', 'csui/controls/form/form.view', 'csui/controls/progressblocker/blocker',
    'xecmpf/widgets/eac/impl/actionplan.rules/impl/actionplan.rules.form.model',
    'hbs!xecmpf/widgets/eac/impl/actionplan.rules/impl/actionplan.rules',
    'csui/controls/globalmessage/globalmessage',
    'i18n!xecmpf/widgets/eac/impl/nls/lang',
    'css!xecmpf/widgets/eac/impl/actionplan.rules/impl/actionplan.rules'
], function (_, $, Backbone, Marionette,
    ConnectorFactory, FormView, BlockingView,
    EACRuleFormModel, formTemplate, GlobalMessage, lang) {
        /**
         * Function: EACRulesView
         * It shows form to capture the eac conditions
         */
        var EACRulesView = FormView.extend({
            className: function() {
                var computedClassName = FormView.prototype.className.call(this);
                computedClassName += ' xecmpf-eac-rules xecmpf-eac-rules-read xecmpf-eac-rules-hide-validation-errors';
                // adds class to indicate rules section for new action plan item
                computedClassName += (this.options.isNewActionPlan ? ' xecmpf-eac-new-action-plan-rules' : '');
                return computedClassName;
            },
            constructor: function(options) {
                FormView.prototype.constructor.call(this, options);
                this.listenTo(this, "change:field", this.onFieldChanged);
                this.listenTo(this.model, 'field:invalid', this.disableSave);
                this.listenTo(this.model, 'field:valid', this.enableProperties);
                this.listenTo(this, 'render:form', this.displayField);
            },
            ui: {
                pullRight: '.cs-pull-right',
				editIcon: '.inline-edit-icon',
                expressionButton: '.alpaca-container-item-first.csui-field-select .cs-field-write button'
            },
            events: {
                "mouseenter @ui.pullRight": "onMouseEnterOnActionButtons",
                "mouseleave @ui.pullRight": "onMouseLeaveFromActionButtons",
                "click @ui.editIcon": "_doEditActions",
                "focusout .alpaca-field-array": "showInReadMode",
                "click @ui.expressionButton": "onExpressionClick"
            },
            formTemplate: formTemplate,
            formTemplateHelpers: function () {
                return {
                    rulesLabel: lang.rulesLabel,
                    rulesSetLegend: lang.rulesSetLegend
                };
            },
            /**
             * Function: onRenderForm
             * It would be called after form renders. It adds class to existing rows to differenatiate them from 
             * newly added rows
             */
            onRenderForm: function() {
                var rulesRowsSelector = ".xecmpf-eac-rules-container .cs-form-set .cs-array.alpaca-container-item";
                this.$el.find(rulesRowsSelector).addClass("xecmpf-eac-existing-rule");
                if (this.alpaca.options.fields.rulesSet && this.alpaca.options.fields.rulesSet.actionbar) {
                    var removeAction = this.alpaca.options.fields.rulesSet.actionbar.actions.filter(function (action) { return (action.action === 'remove'); })[0];
                    var orgClick = removeAction.click;
                    var self = this;
                    removeAction.click = function (key, action, itemIndex) {
                        orgClick.call(this, key, action, itemIndex);
                        if (itemIndex === 1) {
                            self.form.childrenByPropertyId["rulesSet"].children[0].childrenByPropertyId["from"].fieldView.ui.toggle.trigger("focus");
                        }
                    };
                    var addAction = this.alpaca.options.fields.rulesSet.actionbar.actions.filter(function (action) { return (action.action === 'add'); })[0];
                    var addOrgClick = addAction.click;
                    addAction.click = function (key, action, itemIndex) {
                        if (!self.addBlockClickCheck) {
                            addOrgClick.call(this, key, action, itemIndex);
                            self.addBlockClickCheck = true;
                            self.form.field.on("fieldupdate", { self: self, rowCount: self.form.children[0].children.length, itemIndex: itemIndex }, self.addActionFieldUpdateListener);
                        }
                    }
                }
                
            },  
            
            _getLayout: function () {
                FormView.prototype._getLayout.call(this);
                var template = this.getOption('formTemplate'),
                    html = template.call(this, {
                        data: this.alpaca.data,
                        mode: this.mode
                    }),
                    bindings = this._getBindings(),
                    view = {
                        parent: 'bootstrap-csui',
                        layout: {
                            template: html,
                            bindings: bindings
                        }
                    };
                return view;
            },
            _getBindings: function () {
                return {
                    rulesSet: '.xecmpf-eac-rules-container'
                };
            }, 
            /**
             * Function: isFormValid
             * Returns: Boolean flag to indicate form validation status
             */
            isFormValid: function() {
                this.$el.removeClass('xecmpf-eac-rules-hide-validation-errors'); // error indications can be shown after calling this method
                return this.validate();
            },  
            /**
             * Function: getSubmitData
             * Returns: Rules form data if formView is available
             */
            getSubmitData: function () {
                var data = this.getValues().rulesSet;
                // in case of only empty row, do not send any value
                data.length === 1 && !data[0].operator && !data[0].from && !data[0].to && (data = []);                
                return data;
            },
            /**
             * TODO: this behavior should be handled in the csui. Remove this method if it is fixed in csui
             * Function: onMouseEnterOnActionButtons
             * @desc: Theis method is added to fix below issue.
             * When new items are added through add button, add and delete icons in new row
             * are not being shown on mouseenter in the buttons section. triggers mouseenter event to show buttons section
             */
            onMouseEnterOnActionButtons: function(event) {
                var $currentTarget = $(event.currentTarget);
                if ($currentTarget.find('button').hasClass('binf-hidden')) {
                    $currentTarget.parent().find('.cs-pull-left .cs-field-write').trigger('mouseenter');
                }
            },
            /**
             * TODO: this behavior should be handled in the csui. Remove this method if it is fixed in csui
             * Function: onMouseLeaveFromActionButtons
             * @desc: To hide buttons section on mouse leave, triggers mouseleave event
             */
            onMouseLeaveFromActionButtons: function(event) {
                var $currentTarget = $(event.currentTarget);
                if (!$currentTarget.find('button').hasClass('binf-hidden')) {
                    $currentTarget.parent().find('.cs-pull-left .cs-field-write').trigger('mouseleave');
                }
            },
            /**
             * Setting focus for "from" field on click of edit icon
             */
            _doEditActions: function () {
                var that = this;
                if (this.form.childrenByPropertyId["rulesSet"].children.length > 0) {
                    this.$el.addClass("xecmpf-eac-rules-write");
                    this.$el.removeClass("xecmpf-eac-rules-read");
                    $(document).on('click.' + this.cid, {view: this}, this._documentClick);
                } else {
                    this.$el.removeClass("xecmpf-eac-rules-write");
                    this.$el.addClass("xecmpf-eac-rules-read");
                    $(document).off('click.' + this.cid, {view: this}, this._documentClick);
                    this.$el.on('tab:content:field:changed', function (event) {
                        if ($(event.target).find(".csui-bulk-edit-cancel").length) {
                            that.displayField(false);
                        }
                    });
                }
                var fromField, i,
                    ruleSetField = this.form.childrenByPropertyId["rulesSet"].childrenById;
                for (i in ruleSetField) {
                    fromField = i;
                }
               
                if (!!this.form.childrenByPropertyId["rulesSet"].children[0]) {
                    this.form.childrenByPropertyId["rulesSet"].children[0].childrenByPropertyId["conjunction"].containerItemEl.css('visibility', 'hidden');
                    this.form.childrenByPropertyId["rulesSet"].children[0].childrenByPropertyId["conjunction"].containerItemEl.css('display', 'block');
                }
                if (!!this.form.childrenByPropertyId["rulesSet"].childrenById[fromField]) {
                    this.form.childrenByPropertyId["rulesSet"].childrenById[fromField].childrenByPropertyId["from"].fieldView.ui.toggle.trigger("focus");
                }
            },

            _documentClick: function (event) {
                var self = event.data.view;
                if (!self.$el.find('.xecmpf-eac-rules-container').has(event.target).length && !($(event.target).is('.csui-array-icon-delete-toolbarSticky'))) {
                    self.$el.removeClass("xecmpf-eac-rules-write");
                    self.$el.addClass("xecmpf-eac-rules-read");
                }
            },

            showInReadMode: function () {
                var invalidField = this.$el.find('.cs-formfield.cs-formfield-invalid');
                if (invalidField.length) {
                    invalidField.removeClass('cs-formfield-invalid');
                }
                var ruleSetField, i, readField, writeFieldText,
                    length = this.form.childrenByPropertyId["rulesSet"].children.length;
                	this.onFieldChanged();
                if (length > 1) {
                    for (i = 1; i < length; i++) {
                        ruleSetField = this.form.childrenByPropertyId["rulesSet"].children[i];
                        readField = ruleSetField.childrenByPropertyId["conjunction"].fieldView.ui.readField.children()[0];
                        writeFieldText = ruleSetField.childrenByPropertyId["conjunction"].fieldView.ui.writeField.children()[0].innerText;
                        readField.innerText = writeFieldText;
                    }
                }
            },
            onFieldChanged: function () {
                var length = this.alpaca.options.fields.rulesSet.fields.item.fields.from.optionLabels.length;
                var i, ele, label;
                for (var rule in this.form.childrenByPropertyId["rulesSet"].childrenById) {
                    for (i = 0; i < length; i++) {
                        label = this.alpaca.options.fields.rulesSet.fields.item.fields.from.optionLabels[i];
                        this.setRequireStatus(rule, label, "value");
                        this.setRequireStatus(rule, label, "to2");
                    }
                }
            },
            setRequireStatus: function (rule, label, field) {
                var ele = this.form.childrenByPropertyId["rulesSet"].childrenById[rule].childrenByPropertyId[field + label];
                if (!!ele) {
                    if (!ele.isHidden()) {
                        if (ele.isEmpty()) {
                            this.form.schema.properties.rulesSet.items.properties[field + label].required = true;
                            ele.displayMessage(lang.requiredField);
                            ele.getFieldEl().addClass('binf-has-error');
                        }
                        else if(!this.form.options.fields.rulesSet.fields.item.fields[field + label].removeDefaultNone){
                            this.form.schema.properties.rulesSet.items.properties[field + label].required = false;
                        }
                    }
                    else {
                        if (this.form.schema.properties.rulesSet.items.properties[field + label].required &&
                            !this.form.options.fields.rulesSet.fields.item.fields[field + label].removeDefaultNone) {
                            this.form.schema.properties.rulesSet.items.properties[field + label].required = false;
                        }

                    }
                }
            },
            onExpressionClick: function (event) {
                if ($(event.currentTarget).parents('.cs-array.alpaca-container-item').attr('data-alpaca-container-item-index') !== '1') {
                    event.preventDefault();
                    event.stopPropagation();
                }
                this.listenTo(this.form.children[0].children[1].children[0].fieldView, "childview:click:link", function (selectFieldItemView) {
                    var value = {}, rowExpressionFieldview;
                    value.id = this.form.children[0].children[1].children[0].fieldView.model.id;
                    value.name = this.form.children[0].children[1].children[0].fieldView.model.attributes.name;
                    for (var i = 2; i < this.form.children[0].children.length; i++) {
                        rowExpressionFieldview = this.form.children[0].children[i].children[0].fieldView;
                        if (!!rowExpressionFieldview) {
                            rowExpressionFieldview.options.model.attributes.data = value.id;
                            rowExpressionFieldview.model.set(value);
                            rowExpressionFieldview.alpacaField && rowExpressionFieldview.alpacaField.setValue(rowExpressionFieldview.model.id);
                        }
                    }
                });
            },
            addActionFieldUpdateListener: function (event) {
                var self = event.data.self, itemIndex = event.data.itemIndex;
                if (self.form.children[0].children.length > event.data.rowCount) {
                    self.form.field.off("fieldupdate", self.addActionFieldUpdateListener);
                    self.addBlockClickCheck = false;
                    self.form.children[0].children[itemIndex + 1].children[0].containerItemEl.find('button').on('focus', { self: self, itemIndex: itemIndex }, self.setExpressionValue);
                }
            },
            setExpressionValue: function (event) {
                var self = event.data.self, itemIndex = event.data.itemIndex + 1;
                var rowExpressionField = self.form.children[0].children[itemIndex].children[0];
                var value = {};
                if (itemIndex === 1) {
                    value.id = (self.form.children[0].children[2] && self.form.children[0].children[2].children[0].fieldView.model.id) || "and";
                    value.name = (self.form.children[0].children[2] && self.form.children[0].children[2].children[0].fieldView.model.id) || "and";
                }
                else {
                    value.id = self.form.children[0].children[1].children[0].fieldView.model.id || "and";
                    value.name = self.form.children[0].children[1].children[0].fieldView.model.attributes.name || "and";
                }
                if (!!rowExpressionField) {
                    rowExpressionField.containerItemEl.find('button').off('focus', self.setExpressionValue);
                    rowExpressionField.fieldView.options.model.attributes.data = value.id;
                    rowExpressionField.fieldView.model.set(value);
                    rowExpressionField.fieldView.alpacaField && rowExpressionField.fieldView.alpacaField.setValue(rowExpressionField.fieldView.model.id);
                    rowExpressionField.containerItemEl.find('button').trigger('focus');
                }
            },
            UpdateDependantCatAttrs: function (children, type) {
                var element = children.find(function (ele) {
                    return ele.name.includes('to2Category Attribute') && ele.type !== type && !ele.isHidden();
                });
                if (!!element) {
                    element.containerItemEl.addClass('binf-hidden');
                    element.field.addClass('binf-hidden');
                    switch (element.type) {
                        case "date":
                            this.alpaca.options.fields.rulesSet.fields.item.fields["to2Category Attributedate"].hidden = true;
                            break;
                        case "integer":
                            this.alpaca.options.fields.rulesSet.fields.item.fields["to2Category Attributeinteger"].hidden = true;
                            break;
                        case "otcs_user":
                            this.alpaca.options.fields.rulesSet.fields.item.fields["to2Category Attributeotcs_user_picker"].hidden = true;
                            break;
                        case "string":
                            this.alpaca.options.fields.rulesSet.fields.item.fields["to2Category Attribute"].hidden = true;
                            break;
                        case "text":
                            this.alpaca.options.fields.rulesSet.fields.item.fields["to2Category Attribute"].hidden = true;
                            break;
                        case "checkbox":
                            this.alpaca.options.fields.rulesSet.fields.item.fields["to2Category Attributecheckbox"].hidden = true;
                            break;
                    }
                }
            },
            UpdateOperators: function (operators, field, value) {
                var typeArray = [], i = 0, j = 0;
                field.fieldView.collection.reset();
                for (i = 0; i < operators.length; i++) {
                    if (value === operators[i]) {
                        j = i;
                    }
                    typeArray.push(new Backbone.Model({ 'id': operators[i], 'name': operators[i] }));
                }
                field.fieldView.collection.reset(typeArray);
                this.model.attributes.options.fields.rulesSet.fields.item.fields["operatorCategory Attribute"].optionLabels = operators;
                this.model.attributes.schema.properties.rulesSet.items.properties["operatorCategory Attribute"].enum = operators;
                field.fieldView.collection.reset(typeArray);
                field.fieldView.setValue(typeArray[j]);
            },
           
            enableProperties: function () {
                var type, currentRule, operators, currentOperator;
                if (!!this.model.categoryResponse && !!this.model.categoryResponse.typeName) {
                    type = this.model.categoryResponse.typeName;
                    operators = this.model.categoryResponse.operators;
                    if (this.model.currentTarget.length > 0) {
                        for (var i = 0; i < this.model.currentTarget.length; i++) {

                            if (this.model.currentTarget[i].data === this.model.value.split("&")[1].split('=')[1]) {
                                currentRule = this.form.childrenByPropertyId["rulesSet"].childrenById[this.model.currentTarget[i].parent.id];
                                this.model.currentTarget.splice(i, 1);
                                this.enableFieldbyType(type, currentRule, operators, currentOperator);
                            }
                        }
                    }

                } else {
                    if (!!this.model.children) {
                        type = this.model.typeName;
                        currentRule = this.model.children;
                        operators = this.model.operators;
                        currentOperator = this.model.currentOperator;
                    }
                    this.enableFieldbyType(type, currentRule, operators, currentOperator);
                }
            },
            enableFieldbyType: function (type, currentRule, operators, currentOperator) {
                switch (type) {
                    case "Date":
                        this.hideDependentFields(true, type, currentRule);
                        currentRule.childrenByPropertyId["to2Category Attributedate"].field.removeClass('binf-hidden');
                        currentRule.childrenByPropertyId["to2Category Attributedate"].containerItemEl.removeClass('binf-hidden');
                        break;
                    case "Integer":
                        this.hideDependentFields(true, type, currentRule);
                        currentRule.childrenByPropertyId["to2Category Attributeinteger"].field.removeClass('binf-hidden');
                        currentRule.childrenByPropertyId["to2Category Attributeinteger"].containerItemEl.removeClass('binf-hidden');
                        break;
                    case "User":
                        this.hideDependentFields(true, type, currentRule);
                        currentRule.childrenByPropertyId["to2Category Attributeotcs_user_picker"].field.removeClass('binf-hidden');
                        currentRule.childrenByPropertyId["to2Category Attributeotcs_user_picker"].containerItemEl.removeClass('binf-hidden');
                        break;
                    case "StringField":
                        this.hideDependentFields(true, type, currentRule);
                        if (currentRule.childrenByPropertyId["to2Category Attribute"].isHidden()) {
                            currentRule.childrenByPropertyId["to2Category Attribute"].field.removeClass('binf-hidden');
                            currentRule.childrenByPropertyId["to2Category Attribute"].containerItemEl.removeClass('binf-hidden');
                        }
                        break;
                    case "Boolean":
                        this.hideDependentFields(true, type, currentRule);
                        currentRule.childrenByPropertyId["to2Category Attributecheckbox"].field.removeClass('binf-hidden');
                        currentRule.childrenByPropertyId["to2Category Attributecheckbox"].containerItemEl.removeClass('binf-hidden');
                        break;
                }
                this.UpdateOperators(operators, currentRule.childrenByPropertyId["operatorCategory Attribute"], currentOperator);
                this._doEditActions();    
            },
            disableSave: function () {
                var currentRule;
                if (this.model.currentTarget.length > 0) {
                    for (var i = 0; i < this.model.currentTarget.length; i++) {

                        if (this.model.currentTarget[i].data === this.model.value.split("&")[1].split('=')[1]) {
                            currentRule = this.form.childrenByPropertyId["rulesSet"].childrenById[this.model.currentTarget[i].parent.id];
                            this.UpdateDependantCatAttrs(currentRule.children, this.model.currentTarget.type);
                            this.hideDependentFields(true, this.model.currentTarget.type, currentRule);
                        }
                    }
                }
                this.$el.closest(".xecmpf-actionpan-details-view").find(".xecmpf-eac-save-actionplan").prop("disabled", true);
            },
            displayField: function (EditAction) {
                var i, children, type, that = this, setAttributes;
                that.model.currentTarget = [];
                if (!!this.form && !!this.form.childrenByPropertyId) {
                    for (i = 0; i < this.form.childrenByPropertyId["rulesSet"].children.length; i++) {
                        if (!!this.model.attributes.data.rulesSet[i] && !!this.model.attributes.data.rulesSet[i]["valueCategory Attribute"]) {
                            setAttributes = this.form.childrenByPropertyId["rulesSet"].children[i].childrenByPropertyId["valueCategory Attribute"];
                            !!setAttributes && setAttributes.fieldView.alpacaField.refreshValidationState(false, function () {
                                if (that.$el.find(".binf-has-error").length > 0) {
                                    if (that.$el.find('.csui-bulk-edit-rulesSet') && !!EditAction) {
                                        that.$el.find('.csui-bulk-edit-rulesSet').trigger('click');
                                    }
                                }
                                that.$el.off('tab:content:field:changed');
                            });
                        } else {
                            if (!!this.model.get('data').rulesSet[i] && !!this.model.get('data').rulesSet[i]["categorDetails"]) {
                                this.model.children = children = this.form.childrenByPropertyId["rulesSet"].children[i];
                                type = this.model.typeName = this.model.get('data').rulesSet[i]["categorDetails"].typeName;
                                this.model.operators = this.model.get('data').rulesSet[i]["categorDetails"].operators;
                                this.model.currentOperator = this.model.get('data').rulesSet[i]["operatorCategory Attribute"];
                                this.enableProperties();
                                this.hideDependentFields(true, type, children);
                            }
                            setAttributes = this.form.childrenByPropertyId["rulesSet"].children[i].childrenByPropertyId["valueCategory Attribute"];
                            that.model.currentTarget.push(setAttributes);
                            !!setAttributes && setAttributes.fieldView.alpacaField.refreshValidationState(false, function (event) {
                                that.$el.off('tab:content:field:changed');
                            });
                        }
                    }
                }
            },
            getFieldOnType: function (child, type) {
                switch (type) {
                    case "Date":
                        return child.childrenByPropertyId["to2Category Attributedate"];
                    case "Integer":
                        return child.childrenByPropertyId["to2Category Attributeinteger"];
                    case "StringField":
                        return child.childrenByPropertyId["to2Category Attribute"];
                    case "User":
                        return child.childrenByPropertyId["to2Category Attributeotcs_user_picker"];
                    case "Boolean":
                        return child.childrenByPropertyId["to2Category Attributecheckbox"];
                }
            },
            hideDependentFields: function (hide, type, child) {
                var types = ["Date", "StringField", "Integer", "User", "Boolean"], element, that = this;
                types.forEach(function (value) {
                    if (value !== type) {
                        if (hide) {
                            element = that.getFieldOnType(child, value);
                            element.containerItemEl.addClass('binf-hidden');
                        } else {
                            element = that.getFieldOnType(child, value);
                            element.containerItemEl.removeClass('binf-hidden');
                        }
                    }
                })
            }
        });
        return EACRulesView;
    });

csui.define('xecmpf/models/eac/eac.complete.reminder.model',['csui/lib/underscore', 'csui/utils/url', 'csui/models/form',
  'csui/models/mixins/resource/resource.mixin'
], function (_, Url, FormModel, ResourceMixin) {

  'use strict';

  var ReminderCompleteFormModel = FormModel.extend({

    constructor: function ReminderCompleteFormModel(attributes, options) {
      FormModel.prototype.constructor.apply(this, arguments);

      this.makeResource(options);
    },

    clone: function () {
      return new this.constructor(this.attributes, {
        connector: this.connector
      });
    },

    url: function () {
      var url = Url.combine(this.connector.connection.url, 'forms','nodes', "reminder", "create"),
      urlparms = this.get("client_id") ? {client_id: this.get('client_id')} : {};
      urlparms = this.get("id") ? _.extend(urlparms, {id: this.get('id')}) : urlparms;
      urlparms =  _.extend(urlparms, {exclude_personal: 'true'});
      url = !!urlparms ? Url.appendQuery(url, Url.combineQueryString(urlparms)) : url;
      return url;
    },

    parse: function (response) {
      var form = !!response.forms && response.forms[0];
      form = form ? form : response;
      return form;
    }

  });

  ResourceMixin.mixin(ReminderCompleteFormModel.prototype);

  return ReminderCompleteFormModel;

});

csui.define('xecmpf/models/eac/eac.defaultplans.model',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/backbone',
    'csui/models/mixins/connectable/connectable.mixin',
    'csui/models/mixins/fetchable/fetchable.mixin',
    'csui/utils/url'
], function (_, $, Backbone, ConnectableMixin, FetchableMixin, Url) {

    var EACDefaultPlansModel = Backbone.Model.extend({
        constructor: function EACDefaultPlansModel(attributes, options) {
            options || (options = {});
            Backbone.Model.prototype.constructor.apply(this, arguments);
            this.makeConnectable(options);
        },
        parse: function (response) {
            return response;
        }
    });
    ConnectableMixin.mixin(EACDefaultPlansModel.prototype);

    var EACDefaultPlansCollection = Backbone.Collection.extend({

        model: EACDefaultPlansModel,

        constructor: function EACDefaultPlansCollection(models, options) {
            this.options = options || {};
            Backbone.Collection.prototype.constructor.apply(this, arguments);
            this.makeConnectable(options)
                .makeFetchable(options);
        },

        url: function () {
            var url = new Url(this.connector.connection.url).getApiBase('v2');
            url = Url.combine(url, 'eventactioncenter', 'actions');
            return url + this.queryParamsToString(this.options.query);
        },

        parse: function (response) {
            return response.results.actions;
        },

        queryParamsToString: function (params) {
            var query = '';
            if (!_.isEmpty(params)) {
                query = '?' + $.param(params);
            }
            return query.replace(/%5B%5D/g, '');
        }
    });

    ConnectableMixin.mixin(EACDefaultPlansCollection.prototype);
    FetchableMixin.mixin(EACDefaultPlansCollection.prototype);

    return EACDefaultPlansCollection;
});

csui.define('xecmpf/models/eac/eac.defaultplans.factory',['csui/lib/underscore', 'csui/lib/backbone',
  'csui/utils/contexts/factories/factory', 'csui/utils/contexts/factories/connector',
  'xecmpf/models/eac/eac.defaultplans.model'
], function (_, Backbone,
  CollectionFactory, ConnectorFactory,
  EACDefaultPlansCollection) {

    var EACDefaultPlansFactory = CollectionFactory.extend({
      propertyPrefix: 'EACDefaultPlansCollection',
      constructor: function EACDefaultPlansFactory(context, options) {
        CollectionFactory.prototype.constructor.apply(this, arguments);
        var eacCollection = this.options.EACDefaultPlansCollection || {};
        if (!(eacCollection instanceof Backbone.Collection)) {
          eacCollection = new EACDefaultPlansCollection(eacCollection.models, _.extend({
            connector: context.getModel(ConnectorFactory),
            autofetch: true
          }, eacCollection.options));
        }
        this.property = eacCollection;
      },
      fetch: function (options) {
        return this.property.fetch(options);
      }
    });

    return EACDefaultPlansFactory;
  });
csui.define('xecmpf/models/eac/eac.action.reminder.model',['csui/lib/underscore', 'csui/utils/url', 'csui/models/form',
  'csui/models/mixins/resource/resource.mixin'
], function (_, Url, FormModel, ResourceMixin) {
  'use strict';

  var ReminderFormModel = FormModel.extend({

    constructor: function ReminderFormModel(attributes, options) {
      FormModel.prototype.constructor.apply(this, arguments);

      this.makeResource(options);
    },

    clone: function () {
      return new this.constructor(this.attributes, {
        connector: this.connector
      });
    },

    url: function () {

      var url = Url.combine(this.connector.connection.url, 'forms', 'nodes', 'followup',
          'getClientTypes'),
      urlparms;
      urlparms = this.get("client_id") ? {client_id: this.get('client_id')} : {};
      urlparms = this.get("id") ? _.extend(urlparms, {id: this.get('id')}) : urlparms;
      urlparms =  _.extend(urlparms, {exclude_personal: 'true'});
      url = !!urlparms ? Url.appendQuery(url, Url.combineQueryString(urlparms)) : url;
      return url;

    },

    parse: function (response) {
      var form = !!response.forms && response.forms[0];
      return form;
    }

  });

  ResourceMixin.mixin(ReminderFormModel.prototype);

  return ReminderFormModel;

});




csui.define('xecmpf/models/eac/eac.action.workflow.attributes.model',['csui/lib/underscore', 'csui/utils/url', 'csui/models/form',
    'csui/models/mixins/resource/resource.mixin'
], function (_, Url, FormModel, ResourceMixin) {
    'use strict';

    var WorkflowAttrModel = FormModel.extend({

        constructor: function WorkflowAttrModel(attributes, options) {
            FormModel.prototype.constructor.apply(this, arguments);

            this.makeResource(options);
        },

        clone: function () {
            return new this.constructor(this.attributes, {
                connector: this.connector
            });
        },

        url: function () {
            var url, urlparms;
            url = new Url(this.connector.connection.url).getApiBase('v2');
            url = Url.combine(url, 'eventactioncenter', 'workflowattributes');
            urlparms = this.get("workflow_id") ? { workflow_id: this.get('workflow_id') } : {};
            urlparms = this.get("id") ? _.extend(urlparms, { id: this.get('id') }) : urlparms;
            url = !!urlparms ? Url.appendQuery(url, Url.combineQueryString(urlparms)) : url;
            return url;
        },

        parse: function (response) {
            var form = !!response.forms && response.forms[0];
            return form;
        }

    });

    ResourceMixin.mixin(WorkflowAttrModel.prototype);

    return WorkflowAttrModel;

});




csui.define('xecmpf/widgets/eac/impl/actionplan.actions/impl/actionplan.actions.webreport',['module',
      'csui/lib/jquery',
      'csui/lib/underscore',
      'i18n!xecmpf/widgets/eac/impl/nls/lang'
    ],
    function (module, $, _, lang) {
      var webreport = {
        buildWebreportModel: function (that, eacDefaultPlans, planProperties, actionProperties, actionFields, properties, fields, schema, options) {
            var key = eacDefaultPlans.get("action_key"),
                webreportsProperties = planProperties.slice();
                webreportsProperties.unshift(lang.rulesFieldPlaceholder);

            properties["actionattributes"] = {
                "type": "object",
                "properties": {
                }
            };

            fields["actionattributes"] = {
                "type": "object",
                "fields": {
                }
            };
            actionProperties = schema.properties['actions_Data'].items.properties[key + "_fields"].properties["actionattributes"].properties;
            actionFields = options.fields['actions_Data'].fields.item.fields[key + "_fields"].fields["actionattributes"].fields;
                if (eacDefaultPlans.get('actions_attributes').length > 0) {
                    var webreportAttributes = eacDefaultPlans.get('actions_attributes');
                    for (var j = 0; j < webreportAttributes.length; j++) {
                        var wfieldKey = webreportAttributes[j].key;

                        actionProperties["key" + j] = {
                            "required": false,
                            "type": "text",
                            "hidden": true,
                            "label": lang.actionAttrParameterNameLabel,
                            "default": wfieldKey
                        };
                        actionFields["key" + j] = {
                            "type": "text",
                            "label": lang.actionAttrParameterNameLabel,
                            "hidden": true
                        };
                        if (wfieldKey === 'Webreport') {

                            schema.properties['actions_Data'].items.properties["actionattrname" + wfieldKey] = {
                                "helper": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "required": eacDefaultPlans.attributes.actions_attributes[j].required,
                                "type": "text",
                                "default": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "dependencies": key + "_fields"
                            };
                            options.fields['actions_Data'].fields.item.fields["actionattrname" + wfieldKey] = {
                                "type": "text",
                                "label": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "dependencies": key + "_fields"
                            };
                            schema.properties['actions_Data'].items.properties["value" + wfieldKey] = {
                                "type": "otcs_node_picker",
                                "dependencies": [key + "_fields"]
                            };
                            options.fields['actions_Data'].fields.item.fields["value" + wfieldKey] = {
                                "type": "otcs_node_picker",
                                "label": lang.actionAttrValueLabel,
                                "type_control": {
                                    "parameters": {
                                        "select_types": [
                                            30303
                                        ],
                                        "startLocation": "csui/dialogs/node.picker/start.locations/current.location",
                                        "startLocations": [
                                            "csui/dialogs/node.picker/start.locations/current.location",
                                            "csui/dialogs/node.picker/start.locations/enterprise.volume",
                                            "csui/dialogs/node.picker/start.locations/personal.volume",
                                            "csui/dialogs/node.picker/start.locations/favorites",
                                            "csui/dialogs/node.picker/start.locations/recent.containers",
                                            "csui/dialogs/node.picker/start.locations/category.volume",
                                            "csui/dialogs/node.picker/start.locations/perspective.assets.volume",
                                            "recman/dialogs/node.picker/start.locations/classifications.volume", "xecmpf/dialogs/node.picker/start.locations/extended.ecm.volume.container"
                                        ]
                                    }
                                },
                                "fieldClass": "value" + wfieldKey,
                                "dependencies": [key + "_fields"]
                            };

                        } else if (wfieldKey === 'WebreportParameters') {
                            schema.properties['actions_Data'].items.properties["actionattrname" + wfieldKey] = {
                                "helper": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "required": eacDefaultPlans.attributes.actions_attributes[j].required,
                                "type": "text",
                                "default": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "dependencies": key + "_fields"
                            };
                            options.fields['actions_Data'].fields.item.fields["actionattrname" + wfieldKey] = {
                                "type": "text",
                                "label": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "dependencies": key + "_fields"
                            };
                            schema.properties['actions_Data'].items.properties["value" + wfieldKey] = {
                                "readonly": false,
                                "required": false,
                                "title": "Enabled",
                                "type": "checkbox",
                                "dependencies": [key + "_fields"]
                            };
                            options.fields['actions_Data'].fields.item.fields["value" + wfieldKey] = {
                                "hidden": false,
                                "hideInitValidationError": true,
                                "label": "Enabled",
                                "readonly": false,
                                "type": "checkbox",
                                "dependencies": [key + "_fields"]
                            };
                        } else if (wfieldKey === 'WebreportParametersList') {
                            schema.properties['actions_Data'].items.properties["actionattrname" + wfieldKey] = {
                                "helper": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "required": eacDefaultPlans.attributes.actions_attributes[j].required,
                                "type": "text",
                                "default": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "dependencies": "valueWebreportParameters"
                            };
                            options.fields['actions_Data'].fields.item.fields["actionattrname" + wfieldKey] = {
                                "type": "text",
                                "label": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "dependencies": {}
                            };
                            schema.properties['actions_Data'].items.properties["value" + wfieldKey] = {
                                "dependencies": "valueWebreportParameters",
                                "type": "array",
                                "label": lang.actionAttrValueLabel,
                                "items": {
                                    "defaultItems": 1,
                                    "maxItems": planProperties.length,
                                    "minItems": 1,
                                    "enum": webreportsProperties,
                                    "type": "string",
                                    "default": lang.rulesFieldPlaceholder
                                }
                            };
                            options.fields['actions_Data'].fields.item.fields["value" + wfieldKey] = {
                                "fields": {
                                    "item": {
                                        "hidden": false,
                                        "type": "select",
                                        "removeDefaultNone": true,
                                        "label": lang.actionAttrValueLabel,
                                        "fieldClass": "value" + wfieldKey,
                                        "placeholder": lang.rulesFieldPlaceholder,
                                        "onFieldChange": function(event) {
											that.trigger('change:parameter',event);
										}
                                    }
                                },
                                "dependencies": {},
                                "validator": function (callback) {
                                    that.trigger('update:parameter', this);
                                }
                            }; 
                            options.fields['actions_Data'].fields.item.fields["value" + wfieldKey].dependencies["valueWebreportParameters"] = true;
                            options.fields['actions_Data'].fields.item.fields["actionattrname" + wfieldKey].dependencies["valueWebreportParameters"] = true;
                        }
                    }
                }
            
        }
      }
      return webreport;
    });

csui.define('xecmpf/widgets/eac/impl/actionplan.actions/impl/actionplan.actions.centralworkspace',['module',
      'csui/lib/jquery',
      'csui/lib/underscore',
      'i18n!xecmpf/widgets/eac/impl/nls/lang',
      'csui/utils/deepClone/deepClone'
    ],
    function (module, $, _, lang) {
      var centralWorkspace = {
        buildCentralWorkspaceModel: function ( that,eacDefaultPlans, planProperties, actionProperties, actionFields, properties, fields, schema, options) {
            var key = eacDefaultPlans.get("action_key"),
                centralWorkspaceProperties = planProperties.slice();

            properties["actionattributes"] = {
                "type": "object",
                "properties": {
                }
            };

            fields["actionattributes"] = {
                "type": "object",
                "fields": {
                }
            };

            actionProperties = schema.properties['actions_Data'].items.properties[key + "_fields"].properties["actionattributes"].properties;
            actionFields = options.fields['actions_Data'].fields.item.fields[key + "_fields"].fields["actionattributes"].fields;
            if (eacDefaultPlans.get('actions_attributes').length > 0) {
                var centralWorkspaceAttributes = eacDefaultPlans.get('actions_attributes');
                for (var j = 0; j < centralWorkspaceAttributes.length; j++) {
                    var wfieldKey = centralWorkspaceAttributes[j].key;

                    actionProperties["key" + j] = {
                        "required": false,
                        "type": "text",
                        "hidden": true,
                        "label": lang.actionAttrParameterNameLabel,
                        "default": wfieldKey
                    };
                    actionFields["key" + j] = {
                        "type": "text",
                        "label": lang.actionAttrParameterNameLabel,
                        "hidden": true
                    };

                    switch( wfieldKey ) {
                        case 'central_workspace_boType':
                            schema.properties['actions_Data'].items.properties["actionattrname" + wfieldKey] = {
                                "helper": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "required": eacDefaultPlans.attributes.actions_attributes[j].required,
                                "type": "text",
                                "default": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "dependencies": key + "_fields"
                            };
                            options.fields['actions_Data'].fields.item.fields["actionattrname" + wfieldKey] = {
                                "type": "text",
                                "order": 1,
                                "label": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "dependencies": key + "_fields"
                            };
                            schema.properties['actions_Data'].items.properties["value" + wfieldKey] = {
                                "type": "otcs_node_picker",
                                "dependencies": [key + "_fields"]
                            };
                            options.fields['actions_Data'].fields.item.fields["value" + wfieldKey] = {
                                "type": "otcs_node_picker",
                                "order": 2,
                                "label": lang.actionAttrValueLabel,
                                "type_control": {
                                    "parameters": {
                                        "startLocations": [
                                            'xecmpf/dialogs/node.picker/start.locations/businessobjecttypes.container'
                                        ]
                                    }
                                },
                                "fieldClass": "value" + wfieldKey,
                                "dependencies": [key + "_fields"]
                            };
                            break;
                        case 'central_workspace_userId':
                            schema.properties['actions_Data'].items.properties["actionattrname" + wfieldKey] = {
                                "helper": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "required": eacDefaultPlans.attributes.actions_attributes[j].required,
                                "type": "text",
                                "default": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "dependencies": key + "_fields"
                            };
                            options.fields['actions_Data'].fields.item.fields["actionattrname" + wfieldKey] = {
                                "type": "text",
                                "order": 3,
                                "label": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "dependencies": {}
                            };
                            schema.properties['actions_Data'].items.properties["value" + wfieldKey] = {
                                "label": lang.actionAttrValueLabel,
                                "enum": centralWorkspaceProperties,
                                "type": "string",
                                "dependencies": key + "_fields"
                            };
                            options.fields['actions_Data'].fields.item.fields["value" + wfieldKey] = {
                                "hidden": false,
                                "order": 4,
                                "type": "select",
                                "removeDefaultNone": false,
                                "label": lang.actionAttrValueLabel,
                                "fieldClass": "value" + wfieldKey,
                                "placeholder": lang.rulesFieldPlaceholder,
                                "dependencies": {}
                            };
                            break;
                        case 'central_workspace_templateId':
                            schema.properties['actions_Data'].items.properties["actionattrname" + wfieldKey] = {
                                "helper": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "required": eacDefaultPlans.attributes.actions_attributes[j].required,
                                "type": "text",
                                "default": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "dependencies": key + "_fields"
                            };
                            options.fields['actions_Data'].fields.item.fields["actionattrname" + wfieldKey] = {
                                "type": "text",
                                "order": 5,
                                "label": eacDefaultPlans.attributes.actions_attributes[j].name,
                                "dependencies": {}
                            };
                            schema.properties['actions_Data'].items.properties["value" + wfieldKey] = {
                                "label": lang.actionAttrValueLabel,
                                "required":  eacDefaultPlans.attributes.actions_attributes[j].required,
                                "type": "integer",
                                "dependencies": key + "_fields"
                            };
                            options.fields['actions_Data'].fields.item.fields["value" + wfieldKey] = {
                                "hidden": false,
                                "order": 6,
                                "type": "integer",
                                "hideInitValidationError": true,
                                "label": lang.actionAttrValueLabel,
                                "fieldClass": "value" + wfieldKey,
                                "placeholder": lang.centralWorkspaceTemplateIdPlaceholder,
                                "dependencies": {}
                            };
                            break;
                        case 'central_workspace_synchronize_permissions':
                            this.createCheckbox( eacDefaultPlans.attributes.actions_attributes[j], schema, options, wfieldKey, key, 7, true);
                            break;
                        case 'central_workspace_synchronize_candidates':
                            this.createCheckbox( eacDefaultPlans.attributes.actions_attributes[j], schema, options, wfieldKey, key, 9, true);
                            break;
                        case 'central_workspace_update_candidates':
                            this.createCheckbox( eacDefaultPlans.attributes.actions_attributes[j], schema, options, wfieldKey, key, 11, false);
                            break;
                        case 'central_workspace_remove_candidate_reference':
                            this.createCheckbox( eacDefaultPlans.attributes.actions_attributes[j], schema, options, wfieldKey, key, 13, false);
                            break;
                        case 'central_workspace_synchronize_assignments':
                            this.createCheckbox( eacDefaultPlans.attributes.actions_attributes[j], schema, options, wfieldKey, key, 15, true);
                            break;
                    }
                }
            } 
        },
        createCheckbox: function( actions_attributes, schema, options, attribute_key, action_key, order, defaltValue ) {
            schema.properties['actions_Data'].items.properties["actionattrname" + attribute_key] = {
                "helper": actions_attributes.name,
                "required": actions_attributes.required,
                "type": "text",
                "default": actions_attributes.name,
                "dependencies": action_key + "_fields"
            };
            options.fields['actions_Data'].fields.item.fields["actionattrname" + attribute_key] = {
                "type": "text",
                "order": order,
                "label": actions_attributes.name,
                "dependencies": action_key + "_fields"
            };
            schema.properties['actions_Data'].items.properties["value" + attribute_key] = {
                "readonly": false,
                "required": false,
                "title": "Enabled",
                "type": "checkbox",
                "default": defaltValue,
                "dependencies": [action_key + "_fields"]
            };
            options.fields['actions_Data'].fields.item.fields["value" + attribute_key] = {
                "hidden": false,
                "order": order + 1,
                "hideInitValidationError": true,
                "label": "Enabled",
                "value": true,
                "readonly": false,
                "type": "checkbox",
                "dependencies": [action_key + "_fields"]
            };
        },

        /**
         * @desc - It converts dynamic type value into boolean type
         * @param { val | any } - value 
         * @return { result | boolean } - contains either true or false based on given value
         */
        transformToBooleanValue: function (val) {
          var result = !!val;
          if ( typeof val === "string" ) {
            result = ( val.toLowerCase() === "true" );
          }
          return result;
        },

        /**
         * @desc - It validates given action attributes of central workspace action and do
         *  - converts specific attributes value to boolean value 
         *  - adds false values for attributes which does not have saved value.
         * @param { actionAttributes | Array } - List of action attributes
         * @return { actionAttr | Array } - Updated action attributes
         */
        validateCentralWorkspaceActionAttributes: function ( actionAttributes ) {
          var actionAttr = _.deepClone(actionAttributes),
              propsList = ["central_workspace_remove_candidate_reference", "central_workspace_synchronize_assignments", "central_workspace_synchronize_candidates", "central_workspace_synchronize_permissions", "central_workspace_update_candidates"],
              that = this;
          
          propsList.forEach(function(prop) {
            var filteredList = actionAttr.filter( function(attr) {
              if ( attr.mappingAttributeName === prop ) {
                return true;
              }
            });
            if ( filteredList.length > 0 ) {
              filteredList[0].mappingData = that.transformToBooleanValue(filteredList[0].mappingData);
            } else {
              actionAttr.push({
                mappingAttributeName: prop,
                mappingMethod: "NA",
                mappingData: false,
                position: actionAttr.length + 1
              });
            }
          });
          return actionAttr;
        }
      }

      return centralWorkspace;
    });

'use strict'

csui.define('xecmpf/widgets/eac/impl/actionplan.actions/impl/actionplan.actions.form.model',['csui/lib/underscore', 'csui/lib/jquery', 'csui/utils/base',
    'csui/models/form',
    'csui/utils/contexts/factories/connector',
    'xecmpf/models/eac/eac.complete.reminder.model',
    'xecmpf/models/eac/eac.planproperties.factory',
    'xecmpf/models/eac/eac.defaultplans.factory',
    'xecmpf/models/eac/eac.action.reminder.model',
    'xecmpf/models/eac/eac.action.workflow.attributes.model',
    'xecmpf/widgets/eac/impl/actionplan.actions/impl/actionplan.actions.webreport',
    'xecmpf/widgets/eac/impl/actionplan.actions/impl/actionplan.actions.centralworkspace',
    'i18n!xecmpf/widgets/eac/impl/nls/lang'
], function (_, $, base, Form, ConnectorFactory, ReminderCompleteFormModel, EACPlanProperties, EACDefaultPlansFactory, ReminderFormModel, WorkflowAttrModel, Webreport, CentralWorkspace, lang) {

    var EACActionsFormModel = Form.extend({

        constructor: function (attributes, options) {
            this.options = options || (options = {});
            attributes || (attributes = {
                data: {},
                options: {},
                schema: {}
            });

            Form.prototype.constructor.call(this, attributes, options);
        },

        initialize: function (attributes, options) {
            var promises = [],
                namespace = !!options.eventModel ? options.eventModel.namespace : undefined,
                eventname = !!options.eventModel ? options.eventModel.event_name : undefined,
                eacDefaultPlans = options.context.getCollection(EACDefaultPlansFactory),
                connector = options.context.getModel(ConnectorFactory),
                eacPlanProperties = options.context.getCollection(EACPlanProperties, {
                    eventModel: options.eventModel,
                    // EAC plan properties are unique by namespace and event_name both
                    attributes: {
                        namespace: namespace,
                        event_name: eventname
                    }
                }), promise;

            this.escModel = new ReminderCompleteFormModel({}, { connector: connector });
            this.attrModel = new WorkflowAttrModel({}, { connector: connector });

            if (!!options.context && !options.context.formModel) {
                this.formModel = new ReminderFormModel({}, { connector: connector });
                promise = this.formModel.fetch();
                options.context.formModel = this.formModel;
                options.context.promise = promise;
            } else {
                promise = options.context.promise;
                this.formModel = options.context.formModel;
            }

            if (!eacDefaultPlans.fetched) {
                promises.push(eacDefaultPlans.fetch());
            }

            if (!eacPlanProperties.planProperties) {
                promises.push(eacPlanProperties.fetch());
            }
            options.eventModel.actionAttributeCollection = eacDefaultPlans;

            $.when.apply($, promises).done(function () {
                eacPlanProperties.planProperties = eacPlanProperties.map(function (model) {
                    return model.get('name');
                });
                var that = this;
                promise.done(function () {
                    if (!!options && !!options.eventModel.data && !!options.eventModel.data.actions) {
                        eacDefaultPlans.actions = options.eventModel.data[options.eventModel.data.actions + "_fields"];
                        that._setAttributes(eacDefaultPlans, eacPlanProperties.planProperties, that.formModel);
                    } else {
                        that._setAttributes(eacDefaultPlans, eacPlanProperties.planProperties, that.formModel);
                    }
                });
                promise.fail(function () {
                    if (!!options && !!options.eventModel.data && !!options.eventModel.data.actions) {
                        eacDefaultPlans.actions = options.eventModel.data[options.eventModel.data.actions + "_fields"];
                        that._setAttributes(eacDefaultPlans, eacPlanProperties.planProperties);
                    } else {
                        that._setAttributes(eacDefaultPlans, eacPlanProperties.planProperties);
                    }
                });
            }.bind(this));
        },
        
        _setAttributes: function (eacDefaultPlans, planProperties, formModel) {
            var that = this,
                attributes = {
                "options": {
                    "fields": {
                        "actions_Data": {
                            "fields": {
                                "item": {
                                    "type": "object",
                                    "fields": {
                                        "action": {
                                            "readonly": false,
                                            "type": "select",
                                            "label": lang.actions,
                                            "fieldclass": "eac-action-label",
                                            "onFieldChange": function(event) {       
                                                that.trigger('update:error',event);   
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }
                },
                "schema": {
                    "type": "object",
                    "properties": {
                        "actions_Data": {
                            "type": "array",
                            "items": {
                                "defaultItems": 1,
                                "maxItems": 50,
                                "minItems": 1,
                                "type": "object",
                                "properties": {
                                    "action": {
                                        "enum": ["CreateOrUpdateEventAction.Create Or Update Workspace", "DocGenEventAction.Create document"],
                                        "readonly": false,
                                        "required": true,
                                        "type": "string"
                                    }
                                }
                            }
                        }
                    }
                }
            };

            attributes.schema.properties['actions_Data'].items.properties["actionattrnameDependsOn"] = {
                "helper": lang.DependsOn,
                "required": false,
                "type": "text",
                "default": lang.DependsOn
            };
            attributes.options.fields['actions_Data'].fields.item.fields["actionattrnameDependsOn"] = {
                "type": "text",
                "hidden": false,
                "label": lang.DependsOn
            };
            attributes.schema.properties['actions_Data'].items.properties["valueDependsOn"] = {
                "readonly": false,
                "required": false,
                "title": "Enabled",
                "type": "checkbox"
            };
            attributes.options.fields['actions_Data'].fields.item.fields["valueDependsOn"] = {
                "hidden": false,
                "hideInitValidationError": true,
                "label": "Enabled",
                "readonly": false,
                "type": "checkbox",
                "helper": lang.DependsOnText
            };

            var wschema, woptions, wAschema, wAoptions;
            var actionFieldEnum = [],
                actionFieldLabels = [];
                attributes.data = this.getFormData(this.options.collection, eacDefaultPlans);

            for (var k = 0; k < eacDefaultPlans.models.length; k++) {
                var key = eacDefaultPlans.models[k].get("action_key");
                actionFieldEnum.push(key);
                actionFieldLabels.push(eacDefaultPlans.models[k].get('action_name'));

                //creating dynamic alpaca  form for source and dependent attributes
                var schema, options, actionProperties, actionFields, dependentValue, value;

                schema = attributes.schema;
                schema.properties['actions_Data'].items.properties[key + "_fields"] = { "properties": {}, "dependencies": "action", "type": "object" };
                var properties = schema.properties['actions_Data'].items.properties[key + "_fields"].properties;

                options = attributes.options;
                options.fields['actions_Data'].fields.item.fields[key + "_fields"] = { "fields": {}, "dependencies": { "action": key } };
                var fields = options.fields['actions_Data'].fields.item.fields[key + "_fields"].fields;
                
                if (eacDefaultPlans.models[k].get("action_key") === "StartWorkflowEventAction.Start workflow") {

                    properties["actionattributes"] = {
                        "type": "object",
                        "properties": {
                        }
                    };

                    fields["actionattributes"] = {
                        "type": "object",
                        "fields": {
                        }
                    };
                    this.updateAttributeValues(attributes, true);
                    actionProperties = schema.properties['actions_Data'].items.properties[key + "_fields"].properties["actionattributes"].properties;
                    actionFields = options.fields['actions_Data'].fields.item.fields[key + "_fields"].fields["actionattributes"].fields;
                    if (eacDefaultPlans.models[k].get('actions_attributes').length > 0) {
                        var workflowAttributes = eacDefaultPlans.models[k].get('actions_attributes');
                        for (var j = 0; j < workflowAttributes.length; j++) {
                            var wrequiredField = workflowAttributes[j].required,
                                wfieldKey = workflowAttributes[j].key,
                                wsourceKey = "valueWorkflowInitiator",
                                workflowProperties = planProperties.slice();
                            workflowProperties.unshift(lang.rulesFieldPlaceholder);

                            actionProperties["key" + j] = {
                                "required": false,
                                "type": "text",
                                "hidden": true,
                                "label": lang.actionAttrParameterNameLabel,
                                "default": wfieldKey
                            };
                            actionFields["key" + j] = {
                                "type": "text",
                                "label": lang.actionAttrParameterNameLabel,
                                "hidden": true
                            };
                            if (wfieldKey === "Workflow") {

                                schema.properties['actions_Data'].items.properties["actionattrname" + wfieldKey] = {
                                    "helper": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "required": eacDefaultPlans.models[k].attributes.actions_attributes[j].required,
                                    "type": "text",
                                    "default": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": key + "_fields"
                                };
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + wfieldKey] = {
                                    "type": "text",
                                    "order": 1,
                                    "label": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": key + "_fields"
                                };
                                schema.properties['actions_Data'].items.properties["value" + wfieldKey] = {
                                    "type": "otcs_node_picker",
                                    "dependencies": [key + "_fields"]
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + wfieldKey] = {
                                    "type": "otcs_node_picker",
                                    "order": 2,
                                    "label": lang.actionAttrValueLabel,
                                    "type_control": {
                                        "parameters": {
                                            "select_types": [
                                                128
                                            ],
                                            "startLocation": "csui/dialogs/node.picker/start.locations/current.location",
                                            "startLocations": [
                                                "csui/dialogs/node.picker/start.locations/current.location",
                                                "csui/dialogs/node.picker/start.locations/enterprise.volume",
                                                "csui/dialogs/node.picker/start.locations/personal.volume",
                                                "csui/dialogs/node.picker/start.locations/favorites",
                                                "csui/dialogs/node.picker/start.locations/recent.containers",
                                                "csui/dialogs/node.picker/start.locations/category.volume",
                                                "csui/dialogs/node.picker/start.locations/perspective.assets.volume",
                                                "recman/dialogs/node.picker/start.locations/classifications.volume", "xecmpf/dialogs/node.picker/start.locations/extended.ecm.volume.container"
                                            ]
                                        }
                                    },
                                    "dependencies": [key + "_fields"],
                                    "validator": function (callback) {
                                       var value = this.getValue();
                                       if (value) {
                                         that.updateAttributeValues(attributes, false, value, this);
                                       }
                                     }
                                };

                            }
                            else if (wfieldKey === "WorkflowInitiator") {
                                schema.properties['actions_Data'].items.properties["actionattrname" + wfieldKey] = {
                                    "required": eacDefaultPlans.models[k].attributes.actions_attributes[j].required,
                                    "type": "text",
                                    "default": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": key + "_fields"
                                };
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + wfieldKey] = {
                                    "type": "text",
                                    "order": 3,
                                    "label": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": key + "_fields"
                                };
                                schema.properties['actions_Data'].items.properties["value" + wfieldKey] = {
                                    "type": "string",
                                    "enum": [null, "ContentServerUser", "eventProp"],
                                    "dependencies": [key + "_fields"]
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + wfieldKey] = {
                                    "type": "select",
                                    "order": 4,
                                    "placeholder": lang.rulesFieldPlaceholder,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + wfieldKey,
                                    "removeDefaultNone": true,
                                    "optionLabels": [lang.rulesFieldPlaceholder, lang.ContentServerUser, lang.eventPropLabel],
                                    "dependencies": [key + "_fields"]
                                };

                            } else if (wfieldKey === 'WorkflowEvtProp') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + wfieldKey] = {

                                    "required": eacDefaultPlans.models[k].attributes.actions_attributes[j].required,
                                    "type": "text",
                                    "default": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": wsourceKey
                                };
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + wfieldKey] = {
                                    "type": "text",
                                    "order": 5,
                                    "label": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": {}
                                };

                                schema.properties['actions_Data'].items.properties["value" + wfieldKey] = {
                                    "dependencies": wsourceKey,
                                    "label": lang.actionAttrValueLabel,
                                    "type": "string",
                                    "enum": workflowProperties
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + wfieldKey] = {
                                    "type": "select",
                                    "order": 6,
                                    "placeholder": lang.rulesFieldPlaceholder,
                                    "removeDefaultNone": true,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + wfieldKey,
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + wfieldKey].dependencies[wsourceKey] = "eventProp";
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + wfieldKey].dependencies[wsourceKey] = "eventProp";

                            } else if (wfieldKey === 'WorkflowUser') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + wfieldKey] = {
                                    "required": eacDefaultPlans.models[k].attributes.actions_attributes[j].required,
                                    "type": "text",
                                    "default": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": wsourceKey
                                };
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + wfieldKey] = {
                                    "type": "text",
                                    "order": 7,
                                    "label": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": {}
                                };

                                schema.properties['actions_Data'].items.properties["value" + wfieldKey] = {
                                    "dependencies": wsourceKey,
                                    "type": "otcs_member_picker"
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + wfieldKey] = {
                                    "order": 8,
                                    "label": lang.actionAttrValueLabel,
                                    "type": "otcs_member_picker",
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + wfieldKey].dependencies[wsourceKey] = "ContentServerUser";
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + wfieldKey].dependencies[wsourceKey] = "ContentServerUser";
                            } else if (wfieldKey === 'WorkflowAttributes') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + wfieldKey] = {
                                    "helper": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "required": eacDefaultPlans.models[k].attributes.actions_attributes[j].required,
                                    "type": "text",
                                    "default": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": key + "_fields"
                                };
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + wfieldKey] = {
                                    "type": "text",
                                    "order": 9,
                                    "label": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": key + "_fields"
                                };
                                schema.properties['actions_Data'].items.properties["value" + wfieldKey] = {
                                    "readonly": false,
                                    "required": false,
                                    "title": "Enabled",
                                    "type": "checkbox",
                                    "dependencies": [key + "_fields"]
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + wfieldKey] = {
                                    "hidden": false,
                                    "hideInitValidationError": true,
                                    "order": 10,
                                    "label": "Enabled",
                                    "readonly": false,
                                    "type": "checkbox",
                                    "dependencies": [key + "_fields"]
                                };
                            } else if (wfieldKey === 'WorkflowAttribute') {

                                schema.properties['actions_Data'].items.properties["value" + wfieldKey] = {
                                    "dependencies": "valueWorkflowAttributes",
                                    "type": "array",
                                    "items": {
                                        "type": "object",
                                        "properties": {
                                            "Attribute": {
                                                "enum": [null],
                                                "readonly": false,
                                                "required": true,
                                                "type": "string"
                                            }
                                        }
                                    }
                                };


                                options.fields['actions_Data'].fields.item.fields["value" + wfieldKey] = {
                                    "order": 11,
                                    "fields": {
                                        "item": {
                                            "type": "object",
                                            "fields": {
                                                "Attribute": {
                                                    "readonly": false,
                                                    "hideInitValidationError": true,
                                                    "optionLabels": [lang.rulesFieldPlaceholder],
                                                    "type": "select",
                                                    "onFieldChange": function (event) {
                                                        that.trigger('update:valueField', event);
                                                    },
                                                    "label": lang.Attribute
                                                }
                                            }
                                        }
                                    },
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + wfieldKey].dependencies["valueWorkflowAttributes"] = true;
                                wschema = attributes.schema;
                                woptions = attributes.options;
                            } else if (wfieldKey === 'WorkflowAttributeValueFrom') {
                                wschema.properties['actions_Data'].items.properties["valueWorkflowAttribute"].items.properties["actionattrname" + wfieldKey] = {
                                    "required": true,
                                    "type": "text",
                                    "default": eacDefaultPlans.models[k].attributes.actions_attributes[j].name
                                };
                                woptions.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["actionattrname" + wfieldKey] = {
                                    "type": "text",
                                    "order": 12,
                                    "label": eacDefaultPlans.models[k].attributes.actions_attributes[j].name
                                };
                                wschema.properties['actions_Data'].items.properties["valueWorkflowAttribute"].items.properties["value" + wfieldKey] = {
                                    "type": "string",
                                    "required": true,
                                    "enum": [null, "csObj", "evtProp", "UserInput", "prevAct"]
                                };
                                woptions.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["value" + wfieldKey] = {
                                    "type": "select",
                                    "order": 13,
                                    "placeholder": lang.rulesFieldPlaceholder,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + wfieldKey,
                                    "removeDefaultNone": true,
                                    "onFieldChange": function (event) {
                                        that.trigger('update:userInput', event);
                                    },
                                    "optionLabels": [lang.rulesFieldPlaceholder, lang.csObjLabel, lang.evtPropLabel, lang.userInput, lang.fromPreviousAction]
                                };
                            } else if (wfieldKey === 'WorkflowAttributeCSObject') {
                                wschema.properties['actions_Data'].items.properties["valueWorkflowAttribute"].items.properties["actionattrname" + wfieldKey] = {
                                    "required": true,
                                    "dependencies": "valueWorkflowAttributeValueFrom",
                                    "type": "text",
                                    "default": eacDefaultPlans.models[k].attributes.actions_attributes[j].name

                                };
                                woptions.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["actionattrname" + wfieldKey] = {
                                    "type": "text",
                                    "order": 14,
                                    "label": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": {}

                                };
                                wschema.properties['actions_Data'].items.properties["valueWorkflowAttribute"].items.properties["value" + wfieldKey] = {
                                    "dependencies": "valueWorkflowAttributeValueFrom",
                                    "type": "string",
                                    "required": true
                                };
                                woptions.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["value" + wfieldKey] = {
                                    "type": "otcs_node_picker",
                                    "order": 15,
                                    "label": lang.actionAttrValueLabel,
                                    "type_control": {
                                        "parameters": {
                                            "startLocation": "csui/dialogs/node.picker/start.locations/current.location",
                                            "startLocations": [
                                                "csui/dialogs/node.picker/start.locations/current.location",
                                                "csui/dialogs/node.picker/start.locations/enterprise.volume",
                                                "csui/dialogs/node.picker/start.locations/personal.volume",
                                                "csui/dialogs/node.picker/start.locations/favorites",
                                                "csui/dialogs/node.picker/start.locations/recent.containers",
                                                "csui/dialogs/node.picker/start.locations/category.volume",
                                                "csui/dialogs/node.picker/start.locations/perspective.assets.volume",
                                                "recman/dialogs/node.picker/start.locations/classifications.volume", "xecmpf/dialogs/node.picker/start.locations/extended.ecm.volume.container"
                                            ]
                                        }
                                    },
                                    "dependencies": [key + "_fields"]
                                };
                                options.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["value" + wfieldKey].dependencies["valueWorkflowAttributeValueFrom"] = "csObj";
                                options.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["actionattrname" + wfieldKey].dependencies["valueWorkflowAttributeValueFrom"] = "csObj";
                            } else if (wfieldKey === 'WorkflowAttributeEvtProp') {

                                wschema.properties['actions_Data'].items.properties["valueWorkflowAttribute"].items.properties["actionattrname" + wfieldKey] = {
                                    "required": true,
                                    "dependencies": "valueWorkflowAttributeValueFrom",
                                    "type": "text",
                                    "default": eacDefaultPlans.models[k].attributes.actions_attributes[j].name

                                };
                                woptions.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["actionattrname" + wfieldKey] = {
                                    "type": "text",
                                    "order": 16,
                                    "label": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": {}
                                };

                                wschema.properties['actions_Data'].items.properties["valueWorkflowAttribute"].items.properties["value" + wfieldKey] = {
                                    "dependencies": "valueWorkflowAttributeValueFrom",
                                    "label": lang.actionAttrValueLabel,
                                    "required": true,
                                    "type": "string",
                                    "enum": workflowProperties
                                };
                                woptions.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["value" + wfieldKey] = {
                                    "type": "select",
                                    "order": 17,
                                    "placeholder": lang.rulesFieldPlaceholder,
                                    "removeDefaultNone": true,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + wfieldKey,
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["value" + wfieldKey].dependencies["valueWorkflowAttributeValueFrom"] = "evtProp";
                                options.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["actionattrname" + wfieldKey].dependencies["valueWorkflowAttributeValueFrom"] = "evtProp";
                            } else if (wfieldKey === 'WorkflowAttributeUserInput') {
                                var n, typeArr = ['text', 'integer', 'checkbox', 'date', 'otcs_user_picker'];
                                for (n = 0; n < typeArr.length; n++) {
                                    wschema.properties['actions_Data'].items.properties["valueWorkflowAttribute"].items.properties["actionattrname" + wfieldKey + typeArr[n]] = { "required": true, "dependencies": "Attribute", "type": "text", "default": eacDefaultPlans.models[k].attributes.actions_attributes[j].name };
                                    woptions.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["actionattrname" + wfieldKey + typeArr[n]] = { "dependencies": {}, "order": 18 + n, "type": "text", "label": eacDefaultPlans.models[k].attributes.actions_attributes[j].name };
                                    wschema.properties['actions_Data'].items.properties["valueWorkflowAttribute"].items.properties["value" + wfieldKey + typeArr[n]] = { "required": true, "dependencies": "Attribute", "type": typeArr[n], "placeholder": lang.rulesFieldPlaceholder };
                                    woptions.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["value" + wfieldKey + typeArr[n]] = { "dependencies": {}, "order": 19 + n, "type": typeArr[n], "placeholder": lang.rulesFieldPlaceholder };
                                    options.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["value" + wfieldKey + typeArr[n]].dependencies["Attribute"] = "";
                                    options.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["actionattrname" + wfieldKey + typeArr[n]].dependencies["Attribute"] = "";
                                }
                            } else if (wfieldKey === 'WorkflowAttachments') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + wfieldKey] = {
                                    "helper": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "required": false,
                                    "type": "text",
                                    "default": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": key + "_fields"
                                };
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + wfieldKey] = {
                                    "type": "text",
                                    "order": 24,
                                    "label": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": key + "_fields"
                                };
                                schema.properties['actions_Data'].items.properties["value" + wfieldKey] = {
                                    "readonly": false,
                                    "required": false,
                                    "title": "Enabled",
                                    "type": "checkbox",
                                    "dependencies": [key + "_fields"]
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + wfieldKey] = {
                                    "hidden": false,
                                    "hideInitValidationError": true,
                                    "order": 25,
                                    "label": "Enabled",
                                    "readonly": false,
                                    "type": "checkbox",
                                    "dependencies": [key + "_fields"]
                                };
                            } else if (wfieldKey === 'WorkflowAttachmentsValueFrom') {
                                schema.properties['actions_Data'].items.properties["value" + wfieldKey] = {
                                    "dependencies": "valueWorkflowAttachments",
                                    "type": "array",
                                    "items": {
                                        "maxItems": 1,
                                        "type": "object",
                                        "properties": {
                                            "Attachments": {
                                                "enum": [null, "csObj", "fromDesktop", "fromShortcut", "prevAct"],
                                                "readonly": false,
                                                "required": true,
                                                "type": "string"
                                            }
                                        }
                                    }
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + wfieldKey] = {
                                    "order": 26,
                                    "fields": {
                                        "item": {
                                            "type": "object",
                                            "fields": {
                                                "Attachments": {
                                                    "readonly": false,
                                                    "hideInitValidationError": true,
                                                    "optionLabels": [lang.rulesFieldPlaceholder, lang.csObjLabel, lang.fromDesktop, lang.fromShortcut, lang.fromPreviousAction],
                                                    "type": "select",
                                                    "onFieldChange": function (event) {
                                                        that.trigger('update:valueFromDesktop', event);
                                                    },
                                                    "label": eacDefaultPlans.models[k].attributes.actions_attributes[j].name
                                                }
                                            }
                                        }
                                    },
                                    "dependencies": {}
                                };
                                wAschema = attributes.schema;
                                wAoptions = attributes.options;
                                options.fields['actions_Data'].fields.item.fields["value" + wfieldKey].dependencies["valueWorkflowAttachments"] = true;
                            } else if (wfieldKey === 'WorkflowAttachmentsValueFromCSObject') {
                                wAschema.properties['actions_Data'].items.properties["valueWorkflowAttachmentsValueFrom"].items.properties["actionattrname" + wfieldKey] = {
                                    "required": true,
                                    "dependencies": "Attachments",
                                    "type": "text",
                                    "default": eacDefaultPlans.models[k].attributes.actions_attributes[j].name
                                };
                                wAoptions.fields['actions_Data'].fields.item.fields["valueWorkflowAttachmentsValueFrom"].fields.item.fields["actionattrname" + wfieldKey] = {
                                    "type": "text",
                                    "order": 27,
                                    "label": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": {}
                                };
                                wAschema.properties['actions_Data'].items.properties["valueWorkflowAttachmentsValueFrom"].items.properties["value" + wfieldKey] = {
                                    "dependencies": "Attachments",
                                    "type": "string",
                                    "required": true
                                };
                                wAoptions.fields['actions_Data'].fields.item.fields["valueWorkflowAttachmentsValueFrom"].fields.item.fields["value" + wfieldKey] = {
                                    "type": "otcs_node_picker",
                                    "order": 28,
                                    "label": lang.actionAttrValueLabel,
                                    "type_control": {
                                        "parameters": {
                                            "select_types": [
                                                848, 298, 136, 144, 751, 0, 123469, 1, 140, 5573
                                            ],
                                            "startLocation": "csui/dialogs/node.picker/start.locations/current.location",
                                            "startLocations": [
                                                "csui/dialogs/node.picker/start.locations/current.location",
                                                "csui/dialogs/node.picker/start.locations/enterprise.volume",
                                                "csui/dialogs/node.picker/start.locations/personal.volume",
                                                "csui/dialogs/node.picker/start.locations/favorites",
                                                "csui/dialogs/node.picker/start.locations/recent.containers"
                                            ]
                                        }
                                    },
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["valueWorkflowAttachmentsValueFrom"].fields.item.fields["value" + wfieldKey].dependencies["Attachments"] = "csObj";
                                options.fields['actions_Data'].fields.item.fields["valueWorkflowAttachmentsValueFrom"].fields.item.fields["actionattrname" + wfieldKey].dependencies["Attachments"] = "csObj";
                            } else if (wfieldKey === 'WorkflowAttachmentsValueFromDesktop') {
                                wAschema.properties['actions_Data'].items.properties["valueWorkflowAttachmentsValueFrom"].items.properties["actionattrname" + wfieldKey] = {
                                    "required": false,
                                    "dependencies": "Attachments",
                                    "type": "text",
                                    "default": eacDefaultPlans.models[k].attributes.actions_attributes[j].name
                                };
                                wAoptions.fields['actions_Data'].fields.item.fields["valueWorkflowAttachmentsValueFrom"].fields.item.fields["actionattrname" + wfieldKey] = {
                                    "type": "text",
                                    "order": 29,
                                    "label": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": {}
                                };
                                wAschema.properties['actions_Data'].items.properties["valueWorkflowAttachmentsValueFrom"].items.properties["value" + wfieldKey] = {
                                    "dependencies": "Attachments",
                                    "type": "string",
                                    "required": false
                                };
                                wAoptions.fields['actions_Data'].fields.item.fields["valueWorkflowAttachmentsValueFrom"].fields.item.fields["value" + wfieldKey] = {
                                    "type": "otcs_node_picker",
                                    "order": 30,
                                    "label": lang.actionAttrValueLabel,
                                    "type_control": {
                                        "parameters": {
                                            "select_types": [
                                                848, 298, 136, 144, 751, 0, 123469, 1, 140, 5573
                                            ],
                                            "startLocation": "csui/dialogs/node.picker/start.locations/current.location",
                                            "startLocations": [
                                                "csui/dialogs/node.picker/start.locations/current.location",
                                                "csui/dialogs/node.picker/start.locations/enterprise.volume",
                                                "csui/dialogs/node.picker/start.locations/personal.volume",
                                                "csui/dialogs/node.picker/start.locations/favorites",
                                                "csui/dialogs/node.picker/start.locations/recent.containers"
                                            ]
                                        }
                                    },
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["valueWorkflowAttachmentsValueFrom"].fields.item.fields["value" + wfieldKey].dependencies["Attachments"] = "fromDesktop";
                                options.fields['actions_Data'].fields.item.fields["valueWorkflowAttachmentsValueFrom"].fields.item.fields["actionattrname" + wfieldKey].dependencies["Attachments"] = "fromDesktop";
                            } else if (wfieldKey === 'WorkflowAttachmentsValueFromAddShortcut') {
                                wAschema.properties['actions_Data'].items.properties["valueWorkflowAttachmentsValueFrom"].items.properties["actionattrname" + wfieldKey] = {
                                    "required": true,
                                    "dependencies": "Attachments",
                                    "type": "text",
                                    "default": eacDefaultPlans.models[k].attributes.actions_attributes[j].name
                                };
                                wAoptions.fields['actions_Data'].fields.item.fields["valueWorkflowAttachmentsValueFrom"].fields.item.fields["actionattrname" + wfieldKey] = {
                                    "type": "text",
                                    "order": 31,
                                    "label": eacDefaultPlans.models[k].attributes.actions_attributes[j].name,
                                    "dependencies": {}
                                };
                                wAschema.properties['actions_Data'].items.properties["valueWorkflowAttachmentsValueFrom"].items.properties["value" + wfieldKey] = {
                                    "dependencies": "Attachments",
                                    "type": "string",
                                    "required": true
                                };
                                wAoptions.fields['actions_Data'].fields.item.fields["valueWorkflowAttachmentsValueFrom"].fields.item.fields["value" + wfieldKey] = {
                                    "type": "otcs_node_picker",
                                    "order": 32,
                                    "label": lang.actionAttrValueLabel,
                                    "type_control": {
                                        "parameters": {
                                            "select_types": [
                                                848, 298, 136, 144, 751, 0, 123469, 1, 140, 5573
                                            ],
                                            "startLocation": "csui/dialogs/node.picker/start.locations/current.location",
                                            "startLocations": [
                                                "csui/dialogs/node.picker/start.locations/current.location",
                                                "csui/dialogs/node.picker/start.locations/enterprise.volume",
                                                "csui/dialogs/node.picker/start.locations/personal.volume",
                                                "csui/dialogs/node.picker/start.locations/favorites",
                                                "csui/dialogs/node.picker/start.locations/recent.containers"
                                            ]
                                        }
                                    },
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["valueWorkflowAttachmentsValueFrom"].fields.item.fields["value" + wfieldKey].dependencies["Attachments"] = "fromShortcut";
                                options.fields['actions_Data'].fields.item.fields["valueWorkflowAttachmentsValueFrom"].fields.item.fields["actionattrname" + wfieldKey].dependencies["Attachments"] = "fromShortcut";
                            }
                        }
                    }
                } else if (eacDefaultPlans.models[k].get("action_key") === "StartWebreportEventAction.Start webreport") {
                    Webreport.buildWebreportModel(that, eacDefaultPlans.models[k], planProperties, actionProperties, actionFields, properties, fields, schema, options);
                } else if (eacDefaultPlans.models[k].get("action_key") === "CreateOrUpdateCentralWorkspace.Create Or Update Central Workspace") {
                    CentralWorkspace.buildCentralWorkspaceModel(that, eacDefaultPlans.models[k], planProperties, actionProperties, actionFields, properties, fields, schema, options);
                } else if (eacDefaultPlans.models[k].get("action_key") === "ReminderEventAction.Add A Reminder" && formModel) {
                    properties["actionattributes"] = {
                        "type": "object",
                        "properties": {
                        }
                    };

                    fields["actionattributes"] = {
                        "type": "object",
                        "fields": {
                        }
                    };
                    this.updateTypeValues(attributes);
                    actionProperties = schema.properties['actions_Data'].items.properties[key + "_fields"].properties["actionattributes"].properties;
                    actionFields = options.fields['actions_Data'].fields.item.fields[key + "_fields"].fields["actionattributes"].fields;
                    if (eacDefaultPlans.models[k].get('actions_attributes').length > 0) {
                        var ReminderAttributes = eacDefaultPlans.models[k].get('actions_attributes');
                        for (var l = 0; l < ReminderAttributes.length; l++) {
                            var reminderField = ReminderAttributes[l].required,
                                rfieldKey = ReminderAttributes[l].key,
                                rsourceKey = "valueReminderDueDateFrom",
                                assigneeKey = "valueReminderAssigneeFrom",
                                metadataKey = "valueReminderAssigneePWMetadata",
                                rescalationKey = "valueReminderEscalationTo",
                                rescalationMetadata ="valueReminderEscalationToPWMetadata",
                                reminderProperties = planProperties.slice();
                                reminderProperties.unshift(lang.rulesFieldPlaceholder);

                            actionProperties['key' + l] = {
                                "required": false,
                                "type": "text",
                                "hidden": true,
                                "label": lang.actionAttrParameterNameLabel,
                                "default": rfieldKey
                            };
                            actionFields["key" + l] = {
                                "type": "text",
                                "label": lang.actionAttrParameterNameLabel,
                                "hidden": true
                            };
                            schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey] = {
                                "required": reminderField,
                                "type": "text"
                            };
                            options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey] = {
                                "type": "text",
                                "dependencies": {}
                            };
                            if (rfieldKey === 'Reminder_client') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 1;
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = "ReminderEventAction.Add A Reminder_fields";
                                this.getPlaceholder(null,formModel.attributes.schema.properties.followup_client_name.enum);
                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": [key + "_fields"],
                                    "type": "string",
                                    "enum": formModel.attributes.schema.properties.followup_client_name.enum
                                };
                                this.getPlaceholder(lang.reminderClientPlaceholder,formModel.attributes.options.fields.followup_client_name.optionLabels);
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "select",
                                    "order": 2,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "optionLabels": formModel.attributes.options.fields.followup_client_name.optionLabels,
                                    "onFieldChange": function(event) {
                                        that.trigger('change:client',event);
                                    },
                                    "removeDefaultNone":true,
                                    "dependencies": {},
                                    "placeholder": lang.reminderClientPlaceholder
                                };
                            } else if (rfieldKey === 'Reminder_type') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = "ReminderEventAction.Add A Reminder_fields";
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 3;
                                for (var val = 0; val < formModel.attributes.schema.properties.followup_client_name.enum.length; val++) {
                                        value = formModel.attributes.schema.properties.followup_client_name.enum[val];
                                        dependentValue = !!value ? value : "";
                                    schema.properties['actions_Data'].items.properties["value" + rfieldKey + value] = {
                                        "dependencies": "valueReminder_client",
                                        "type": "string",
                                        "enum": [null] //TO DO: need to remove once LPAD-88277 is fixed
                                    };
                                    options.fields['actions_Data'].fields.item.fields["value" + rfieldKey + value] = {
                                        "type": "select",
                                        "order": 4,
                                        "label": lang.actionAttrValueLabel,
                                        "fieldClass": "value" + rfieldKey + value,
                                        "optionLabels": [lang.reminderTypePlaceholder],//TO DO: need to remove once LPAD-88277 is fixed
                                        "removeDefaultNone": true,
                                        "placeholder": lang.reminderTypePlaceholder,
                                        "dependencies": { "valueReminder_client": dependentValue },
                                        "onFieldChange": function (event) {
                                            that.trigger('change:type', event);
                                        },
                                    };
                                }
                            } else if (rfieldKey === 'ReminderAddFor') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = "ReminderEventAction.Add A Reminder_fields";
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 5;
                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": [key + "_fields"],
                                    "type": "string",
                                    "default": lang.reminderInitLabel,
                                    "enum": [lang.reminderInitLabel]
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "select",
                                    "order": 6,
                                    "removeDefaultNone": true,
                                    "label": lang.actionAttrValueLabel,
                                    "dependencies": {},
                                    "fieldClass": "value" + rfieldKey
                                };
                            }  else if (rfieldKey === 'ReminderDueDateFrom') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = "ReminderEventAction.Add A Reminder_fields";
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 13;
                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "type": "string",
                                    "enum": [null, "eventProp","initObj", "pWorkspace", "evtInitDay"],
                                    "dependencies": [key + "_fields"]
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "select",
                                    "order": 14,
                                    "placeholder": lang.rulesFieldPlaceholder,
                                    "removeDefaultNone": true,
                                    "fieldClass": "value" + rfieldKey,
                                    "label": lang.actionAttrValueLabel,
                                    "helper": lang.selectSourceForDueDate,
                                    "optionLabels": [lang.rulesFieldPlaceholder, lang.eventPropLabel, lang.reminderInitLabel, lang.workspaceLabel, lang.eventInitDay],
                                    "dependencies": [key + "_fields"]
                                };
                            } else if (rfieldKey === 'ReminderDueDateEvtProp') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 15;
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = rsourceKey;
    
                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": rsourceKey,
                                    "label": lang.actionAttrValueLabel,
                                    "type": "string",
                                    "enum": reminderProperties
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "select",
                                    "placeholder": lang.rulesFieldPlaceholder,
                                    "removeDefaultNone":true,
                                    "order": 16,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "dependencies": {},
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey].dependencies[rsourceKey] = "eventProp";
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].dependencies[rsourceKey] = "eventProp";
                            } else if (rfieldKey === 'ReminderDueDateCategoryAttr') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 15;
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = rsourceKey;
                                
                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": rsourceKey,
                                    "type": "string",
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "text",
                                    "order": 16,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "validator": function(callback) {
                                        var value = this.getValue();
                                        if( value.length > 0 ) {
                                            that.validateValue("category", value).done(function(response) {
                                                if ( !!response.results && !response.results.ok ) {
                                                    callback({
                                                        "status": false,
                                                        "message": response.results.errMsg
                                                    });
                                                    that.trigger("field:invalid");
                                                } else {
                                                    callback({
                                                        "status": true
                                                    });
                                                }
                                            })
                                        }
                                    },
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey].dependencies[rsourceKey] = "initObj";
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].dependencies[rsourceKey] = "initObj";
                            } else if (rfieldKey === 'ReminderDueDatePWCategoryAttr') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 15;
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = rsourceKey;
                               
                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": rsourceKey,
                                    "type": "string",
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "text",
                                    "order": 16,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "validator": function(callback) {
                                        var value = this.getValue();
                                        if( value.length > 0 ) {
                                            that.validateValue("category", value).done(function(response) {
                                                if ( !!response.results && !response.results.ok ) {
                                                    callback({
                                                        "status": false,
                                                        "message": response.results.errMsg
                                                    });
                                                    that.trigger("field:invalid");
                                                } else {
                                                    callback({
                                                        "status": true
                                                    });
                                                }
                                            })
                                        }
                                    },
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey].dependencies[rsourceKey] = "pWorkspace";
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].dependencies[rsourceKey] = "pWorkspace";
                            } else if (rfieldKey === 'ReminderDueDateCompleteIn') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 15;
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = rsourceKey;
                               
                                schema.properties['actions_Data'].items.properties["value1" + rfieldKey] = {
                                    "dependencies": rsourceKey,
                                    "label": lang.actionAttrValueLabel,
                                    "type": "integer",
                                    "maximum": 99,
                                    "minimum":1,
                                    "default": 1
                                };
                                options.fields['actions_Data'].fields.item.fields["value1" + rfieldKey] = {
                                    "type": "integer",
                                    "order": 16,
                                    "fieldClass": "value1" + rfieldKey,
                                    "onFieldChange": function(event) {
                                        that.trigger('change:dueDate',event);
                                    },
                                    "dependencies": {}
                                };
                                schema.properties['actions_Data'].items.properties["value2" + rfieldKey] = {
                                    "dependencies": rsourceKey,
                                    "type": "string",
                                    "label": lang.actionAttrValueLabel,
                                    "default": lang.days,
                                    "enum": [lang.days, lang.weeks, lang.months, lang.years]
                                };
                                options.fields['actions_Data'].fields.item.fields["value2" + rfieldKey] = {
                                    "type": "select",
                                    "order": 17,
                                    "fieldClass": "value2" + rfieldKey,
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].dependencies[rsourceKey] = "evtInitDay";
                                options.fields['actions_Data'].fields.item.fields["value1" + rfieldKey].dependencies[rsourceKey] = "evtInitDay";
                                options.fields['actions_Data'].fields.item.fields["value2" + rfieldKey].dependencies[rsourceKey] = "evtInitDay";
                            } else if (rfieldKey === 'ReminderAssigneeFrom') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = "ReminderEventAction.Add A Reminder_fields";
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 7;
                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": [key + "_fields"],
                                    "type": "string",
                                    "enum": [null, "eventProp", "initObj", "pWorkspace"]
                                };

                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "select",
                                    "placeholder": lang.rulesFieldPlaceholder,
                                    "order": 8,
                                    "helper": lang.selectSourceForAssignee,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "removeDefaultNone":true,
                                    "dependencies": {},
                                    "optionLabels": [lang.rulesFieldPlaceholder, lang.eventPropLabel, lang.reminderInitLabel, lang.workspaceLabel]
                                };
                            } else if (rfieldKey === 'ReminderAssigneeEvtProp') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 9;
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = assigneeKey;
    
                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": assigneeKey,
                                    "label": lang.actionAttrValueLabel,
                                    "type": "string",
                                    "enum": reminderProperties
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "select",
                                    "placeholder": lang.rulesFieldPlaceholder,
                                    "order": 10,
                                    "removeDefaultNone":true,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey].dependencies[assigneeKey] = "eventProp";
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].dependencies[assigneeKey] = "eventProp";
                            } else if (rfieldKey === 'ReminderAssigneeCategoryAttr') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 9;
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = assigneeKey;
                                
                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": assigneeKey,
                                    "type": "string",
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "text",
                                    "order": 10,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "validator": function(callback) {
                                        var value = this.getValue();
                                        if( value.length > 0 ) {
                                            that.validateValue("category", value).done(function(response) {
                                                if ( !!response.results && !response.results.ok ) {
                                                    callback({
                                                        "status": false,
                                                        "message": response.results.errMsg
                                                    });
                                                    that.trigger("field:invalid");
                                                } else {
                                                    callback({
                                                        "status": true
                                                    });
                                                }
                                            })
                                        }
                                    },
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].dependencies[assigneeKey] = "initObj";
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey].dependencies[assigneeKey] = "initObj";
                            } else if (rfieldKey === 'ReminderAssigneePWMetadata') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 9;
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = assigneeKey;
    
                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": assigneeKey,
                                    "label": lang.actionAttrValueLabel,
                                    "type": "string",
                                    "enum": [null, "Role", "CategoryAttr"]
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "select",
                                    "placeholder": lang.rulesFieldPlaceholder,
                                    "order": 10,
                                    "removeDefaultNone":true,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "dependencies": {},
                                    "optionLabels": [lang.rulesFieldPlaceholder, lang.roleLabel, lang.categoryAttrLabel]
                                };
                                
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey].dependencies[assigneeKey] = "pWorkspace";
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].dependencies[assigneeKey] = "pWorkspace";
                            } else if (rfieldKey === 'ReminderAssigneePWRole') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 11;
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = metadataKey;
                                
                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": metadataKey,
                                    "type": "string",
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "text",
                                    "order": 12,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "validator": function(callback) {
                                        var value = this.getValue();
                                        if( value.length > 0 ) {
                                            that.validateValue("role", value).done(function(response) {
                                                if ( !!response.results && !response.results.ok ) {
                                                    callback({
                                                        "status": false,
                                                        "message": response.results.errMsg
                                                    });
                                                    that.trigger("field:invalid");
                                                } else {
                                                    callback({
                                                        "status": true
                                                    });
                                                }
                                            })
                                        }
                                    },
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].dependencies[metadataKey] = "Role";
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey].dependencies[metadataKey] = "Role";
                            } else if (rfieldKey === 'ReminderAssigneePWCategoryAttr') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 11;
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = metadataKey;
                                
                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": metadataKey,
                                    "type": "string",
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "text",
                                    "order": 12,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "validator": function(callback) {
                                        var value = this.getValue();
                                        if( value.length > 0 ) {
                                            that.validateValue("category", value).done(function(response) {
                                                if ( !!response.results && !response.results.ok ) {
                                                    callback({
                                                        "status": false,
                                                        "message": response.results.errMsg
                                                    });
                                                    that.trigger("field:invalid");
                                                } else {
                                                    callback({
                                                        "status": true
                                                    });
                                                }
                                            })
                                        }
                                    },
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].dependencies[metadataKey] = "CategoryAttr";
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey].dependencies[metadataKey] = "CategoryAttr";
                            }  else if (rfieldKey === 'ReminderEscalationTo') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = "ReminderEventAction.Add A Reminder_fields";
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 18;
                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": [key + "_fields"],
                                    "type": "string",
                                    "enum": [null, "eventProp", "initObj", "pWorkspace"],
                                };

                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "select",
                                    "placeholder": lang.rulesFieldPlaceholder,
                                    "order": 19,
                                    "helper": lang.selectSourceForEscalation,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "removeDefaultNone":true,
                                    "dependencies": {},
                                    "optionLabels": [lang.rulesFieldPlaceholder, lang.eventPropLabel, lang.reminderInitLabel, lang.workspaceLabel]
                                };
                            } else if (rfieldKey === 'ReminderEscalationToEvtProp') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 20;
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = rescalationKey;

                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": rescalationKey,
                                    "label": lang.actionAttrValueLabel,
                                    "type": "string",
                                    "enum": reminderProperties
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "select",
                                    "order": 21,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "dependencies": {},
                                    "removeDefaultNone":true,
                                    "placeholder": lang.rulesFieldPlaceholder
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey].dependencies[rescalationKey] = "eventProp";
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].dependencies[rescalationKey] = "eventProp";
                            } else if (rfieldKey === 'ReminderEscalationToCategoryAttr') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 20;
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = rescalationKey;

                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": rescalationKey,
                                    "type": "string",
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "text",
                                    "order": 21,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "validator": function(callback) {
                                        var value = this.getValue();
                                        if( value.length > 0 ) {
                                            that.validateValue("category", value).done(function(response) {
                                                if ( !!response.results && !response.results.ok ) {
                                                    callback({
                                                        "status": false,
                                                        "message": response.results.errMsg
                                                    });
                                                    that.trigger("field:invalid");
                                                } else {
                                                    callback({
                                                        "status": true
                                                    });
                                                }
                                            })
                                        }
                                    },
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].dependencies[rescalationKey] = "initObj";
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey].dependencies[rescalationKey] = "initObj";
                            } else if (rfieldKey === 'ReminderEscalationToPWMetadata') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 20;
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = rescalationKey;

                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": rescalationKey,
                                    "label": lang.actionAttrValueLabel,
                                    "type": "string",
                                    "enum": [null, "Role", "CategoryAttr"]
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "select",
                                    "placeholder": lang.rulesFieldPlaceholder,
                                    "order": 21,
                                    "removeDefaultNone": true,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "dependencies": {},
                                    "optionLabels": [lang.rulesFieldPlaceholder, lang.roleLabel, lang.categoryAttrLabel]
                                };

                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey].dependencies[rescalationKey] = "pWorkspace";
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].dependencies[rescalationKey] = "pWorkspace";
                            } else if (rfieldKey === 'ReminderEscalationToPWRole') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 22;
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = rescalationMetadata;

                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": rescalationMetadata,
                                    "type": "string",
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "text",
                                    "order": 23,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "validator": function(callback) {
                                        var value = this.getValue();
                                        if( value.length > 0 ) {
                                            that.validateValue("role", value).done(function(response) {
                                                if ( !!response.results && !response.results.ok ) {
                                                    callback({
                                                        "status": false,
                                                        "message": response.results.errMsg
                                                    });
                                                    that.trigger("field:invalid");
                                                } else {
                                                    callback({
                                                        "status": true
                                                    });
                                                }
                                            })
                                        }
                                    },
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].dependencies[rescalationMetadata] = "Role";
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey].dependencies[rescalationMetadata] = "Role";
                            }
                            else if (rfieldKey === 'ReminderEscalationToPWCategoryAttr') {
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].default = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].label = ReminderAttributes[l].name;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].order = 22;
                                schema.properties['actions_Data'].items.properties["actionattrname" + rfieldKey].dependencies = rescalationMetadata;

                                schema.properties['actions_Data'].items.properties["value" + rfieldKey] = {
                                    "dependencies": rescalationMetadata,
                                    "type": "string",
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey] = {
                                    "type": "text",
                                    "order": 23,
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "value" + rfieldKey,
                                    "validator": function(callback) {
                                        var value = this.getValue();
                                        if( value.length > 0 ) {
                                            that.validateValue("category", value).done(function(response) {
                                                if ( !!response.results && !response.results.ok ) {
                                                    callback({
                                                        "status": false,
                                                        "message": response.results.errMsg
                                                    });
                                                    that.trigger("field:invalid");
                                                } else {
                                                    callback({
                                                        "status": true
                                                    });
                                                }
                                            })
                                        }
                                    },
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].dependencies[rescalationMetadata] = "CategoryAttr";
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey].dependencies[rescalationMetadata] = "CategoryAttr";
                            }
                            if(rfieldKey === 'ReminderEscalationTo'){
                                options.fields['actions_Data'].fields.item.fields["value" + rfieldKey].hidden = true;
                                options.fields['actions_Data'].fields.item.fields["actionattrname" + rfieldKey].hidden = true;
                            }
                        }     
                    }
                } else {

                    properties["actionattributes"] = {
                        "type": "object",
                        "properties": {
                            "parametername": {
                                "readonly": true,
                                "required": false,
                                "type": "text",
                                "default": lang.actionAttrParameterNameLabel
                            },
                            "sourcelabel": {
                                "readonly": true,
                                "required": false,
                                "type": "text",
                                "default": lang.actionAttrSourceLabel
                            },
                            "valuelabel": {
                                "readonly": true,
                                "required": false,
                                "type": "text",
                                "default": lang.actionAttrValueLabel
                            }
                        }
                    };

                    fields["actionattributes"] = {
                        "type": "object",
                        "fields": {
                            "parametername": {
                                "type": "text",
                                "label": lang.actionAttrParameterNameLabel,
                                "readonly": true
                            },
                            "sourcelabel": {
                                "type": "text",
                                "label": lang.actionAttrSourceLabel,
                                "readonly": true
                            },
                            "valuelabel": {
                                "type": "text",
                                "label": lang.actionAttrValueLabel,
                                "readonly": true
                            }
                        }
                    };
                    actionProperties = schema.properties['actions_Data'].items.properties[key + "_fields"].properties["actionattributes"].properties;
                    actionFields = options.fields['actions_Data'].fields.item.fields[key + "_fields"].fields["actionattributes"].fields;
                    if (eacDefaultPlans.models[k].get('actions_attributes').length > 0 && (eacDefaultPlans.models[k].get("action_key") !== "ReminderEventAction.Add A Reminder" ||
                        (eacDefaultPlans.models[k].get("action_key") === "ReminderEventAction.Add A Reminder" && formModel))) {
                        var actionAttributes = eacDefaultPlans.models[k].get('actions_attributes');
                        
                        // ordering attributes in the required order in case of generate document action
                        if ( key === "DocGenEventAction.Generate Document" ) {
                          actionAttributes = this.orderActionAttributes(key, actionAttributes);
                        }

                        for (var i = 0; i < actionAttributes.length; i++) {
                            var requiredField = actionAttributes[i].required,
                                fieldKey = actionAttributes[i].key,
                                sourceKey = "source" + fieldKey,
                                fieldTypeDetails = this.getFieldTypeForAttr(key, fieldKey);

                            actionProperties['key' + i] = {
                                "required": false,
                                "type": "text",
                                "hidden": true,
                                "label": lang.actionAttrParameterNameLabel,
                                "default": fieldKey
                            };
                            actionFields["key" + i] = {
                                "type": "text",
                                "label": lang.actionAttrParameterNameLabel,
                                "hidden": true
                            };
                            schema.properties['actions_Data'].items.properties["actionattrname" + fieldKey] = {
                                "helper": eacDefaultPlans.models[k].attributes.actions_attributes[i].name,
                                "label": lang.actionAttrParameterLabel,
                                "required": eacDefaultPlans.models[k].attributes.actions_attributes[i].required,
                                "type": "text",
                                "default": eacDefaultPlans.models[k].attributes.actions_attributes[i].name,
                                "dependencies": key + "_fields"
                            };
                            options.fields['actions_Data'].fields.item.fields["actionattrname" + fieldKey] = {
                                "type": "text",
                                "label": eacDefaultPlans.models[k].attributes.actions_attributes[i].name,
                                "dependencies": key + "_fields"
                            };
                            // considering default type to show dropdown with values of content server object, event property, result from previos action
                            if (fieldTypeDetails.fieldType === "default") {

                                schema.properties['actions_Data'].items.properties["source" + fieldKey] = {
                                    "type": "string",
                                    "enum": ["csObj", "evtProp", "prevAct"],
                                    "dependencies": [key + "_fields"]
                                };
                                options.fields['actions_Data'].fields.item.fields["source" + fieldKey] = {
                                    "type": "select",
                                    "fieldClass": "source" + fieldKey,
                                    "label": lang.sourceLabel,
                                    "optionLabels": [lang.csObjLabel, lang.evtPropLabel, lang.prevActLabel],
                                    "onFieldChange": function(event) {       
                                        that.trigger('update:field',event);   
                                    },
                                    "dependencies": [key + "_fields"]
                                };
    
                                schema.properties['actions_Data'].items.properties["csObj_field" + fieldKey] = {
                                    "dependencies": sourceKey,
                                    "type": "string",
                                };
                                schema.properties['actions_Data'].items.properties["evtProp_field" + fieldKey] = {
                                    "dependencies": sourceKey,
                                    "type": "string",
                                    "enum": planProperties
                                };
                                schema.properties['actions_Data'].items.properties["prevAct_field" + fieldKey] = {
                                    "dependencies": sourceKey,
                                    "type": "string",
                                };
                                options.fields['actions_Data'].fields.item.fields["csObj_field" + fieldKey] = {
                                    "type": "otcs_node_picker",
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "csObj_field" + fieldKey,
                                    "type_control": {
                                        "parameters": {
                                            "startLocations": [
                                                "csui/dialogs/node.picker/start.locations/current.location",
                                                "csui/dialogs/node.picker/start.locations/enterprise.volume",
                                                "csui/dialogs/node.picker/start.locations/personal.volume",
                                                "csui/dialogs/node.picker/start.locations/favorites",
                                                "csui/dialogs/node.picker/start.locations/recent.containers",
                                                "csui/dialogs/node.picker/start.locations/category.volume",
                                                "csui/dialogs/node.picker/start.locations/perspective.assets.volume",
                                                "recman/dialogs/node.picker/start.locations/classifications.volume", "xecmpf/dialogs/node.picker/start.locations/extended.ecm.volume.container"
                                            ]
                                        }
                                    },
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["evtProp_field" + fieldKey] = {
                                    "type": "select",
                                    "label": lang.actionAttrValueLabel,
                                    "fieldClass": "evtProp_field" + fieldKey,
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["prevAct_field" + fieldKey] = {
                                    "fieldClass": "prevAct_field" + fieldKey,
                                    "label": lang.actionAttrValueLabel,
                                    "type": "text",
                                    "dependencies": {}
                                };
                                options.fields['actions_Data'].fields.item.fields["csObj_field" + fieldKey].dependencies[sourceKey] = "csObj";
                                options.fields['actions_Data'].fields.item.fields["evtProp_field" + fieldKey].dependencies[sourceKey] = "evtProp";
                                options.fields['actions_Data'].fields.item.fields["prevAct_field" + fieldKey].dependencies[sourceKey] = "prevAct";
                                // adding required flag to source field based on action attributes info 
                                if ( key === "DocGenEventAction.Generate Document" ) {
                                    schema.properties['actions_Data'].items.properties["source" + fieldKey].required = eacDefaultPlans.models[k].attributes.actions_attributes[i].required;
                                }
                            } else {
                                schema.properties['actions_Data'].items.properties["value" + fieldKey] = {
                                    "type": fieldTypeDetails.fieldType,
                                    "dependencies": [key + "_fields"]
                                };
                                options.fields['actions_Data'].fields.item.fields["value" + fieldKey] = {
                                    "type": fieldTypeDetails.fieldType,
                                    "fieldClass": "value" + fieldKey,
                                    "label": lang.actionAttrValueLabel,
                                    "onFieldChange": function(event) {       
                                        that.trigger('update:field',event);   
                                    },
                                    "dependencies": [key + "_fields"]
                                };
                                if (fieldTypeDetails.fieldType === "select") {
                                  _.extend(schema.properties['actions_Data'].items.properties["value" + fieldKey], fieldTypeDetails.schema);
                                  _.extend(options.fields['actions_Data'].fields.item.fields["value" + fieldKey], fieldTypeDetails.options);
                                }
                            }
                            
                        }
                    }
                }

            }
            attributes.schema.properties["actions_Data"].items.properties["action"].enum = actionFieldEnum;
            attributes.options.fields['actions_Data'].fields.item.fields['action'].optionLabels = actionFieldLabels;
            this.set(attributes);
        },

        /**
         * @desc - returns type of the field based on action and field name
         * @param { attrKey: String } - action name
         * @param { attrName: String } - field name
         * @returns { details: Object } - field details (type and values) 
         */
        getFieldTypeForAttr: function (attrKey, attrName) {
            var details = { fieldType: "default" }
            if ( attrKey === "DocGenEventAction.Generate Document" ) {
                if (attrName === "PdContext") {
                    details.fieldType = "select";
                    details.schema = {
                      enum: ["User", "Candidate","JobApplication"]
                    };
                    details.options = {
                      optionLabels: ["User", "Candidate","Job Application"]
                    };
                } 
            }
            return details;
        },

        /**
         * @desc - reordering action attributes
         * @param { attrKey: String } - action name
         * @param { actionAttributes: Array } - action attributes
         * @returns { details: Object } - field details (type and values) 
         */
        orderActionAttributes: function (attrKey, actionAttributes) {
          var attributesOrder = ["DocumentType", "UserId", "PdContext", "EffectiveDate", "BoType_CreateDoc", "BoKey_CreateDoc"];
          if ( attrKey === "DocGenEventAction.Generate Document" ) {
              return actionAttributes.sort(function(attr1, attr2) {
                return attributesOrder.indexOf(attr1.key) - attributesOrder.indexOf(attr2.key);
              });
          }
          return actionAttributes;
        },      

        getFormData: function (collection, eacDefaultPlans) {
            var formData = [],
              actionAttrMappings,
              clientId = null;
            if (collection.models && collection.models.length > 0) {
                formData = collection.models.map(function (modelObj, index) {
                    var actionKey = modelObj.get("action_key"),
                        dependsOn = modelObj.get("depends_on");
                        if (dependsOn === 1) {
                            dependsOn = true;
                        } else {
                            dependsOn = false;
                        }
                    var modelObjItem = {
                            action: actionKey,
                            valueDependsOn: dependsOn
                        };
                    
                    // in case of CreateOrUpdateCentral Workspace action, considering no value as false while rendering already saved details
                    if ( actionKey === "CreateOrUpdateCentralWorkspace.Create Or Update Central Workspace" ) {
                      actionAttrMappings = CentralWorkspace.validateCentralWorkspaceActionAttributes (modelObj.get('attribute_mappings'));
                      modelObj.set('attribute_mappings', actionAttrMappings);
                    }

                    eacDefaultPlans.models.forEach(function (eacDefaultPlanModel) {
                        var keyName = eacDefaultPlanModel.get('action_key') + '_fields';
                        var obj = {};
                        var objAttach = {};
                        modelObjItem[keyName] = {
                            'actionattributes': {
                                'parametername': lang.actionAttrParameterNameLabel,
                                'sourcelabel': lang.actionAttrSourceLabel,
                                'valuelabel': lang.actionAttrValueLabel
                            }
                        };
                        eacDefaultPlanModel.get("actions_attributes").filter(function (actionAttr) {
                            modelObjItem[keyName][actionAttr.key] = {
                                'actionattrname': '',
                                'source': '',
                                'value': '',
                                'csObj_field': '',
                                'evtProp_field': '',
                                'prevAct_field': ''
                            }
                            if (actionAttr.key === 'WorkflowAttribute') {
                                modelObjItem['value' + actionAttr.key] = [];
                                obj["Attribute"] = "";
                            } else if (actionAttr.key === 'WorkflowAttributeValueFrom') {
                                obj['actionattrname' + actionAttr.key] = "";
                                obj['value' + actionAttr.key] = "";
                            } else if (actionAttr.key === 'WorkflowAttributeEvtProp') {
                                obj['actionattrname' + actionAttr.key] = "";
                                obj['value' + actionAttr.key] = "";
                            } else if (actionAttr.key === 'WorkflowAttributeCSObject') {
                                obj['actionattrname' + actionAttr.key] = "";
                                obj['value' + actionAttr.key] = "";
                            } else if (actionAttr.key === 'WorkflowAttributeUserInput') {
                                obj['actionattrname' + actionAttr.key] = "";
                                obj['value' + actionAttr.key] = "";
                            } else if (actionAttr.key === 'WorkflowAttributeFromPreviousAction') {
                                obj['actionattrname' + actionAttr.key] = "";
                                obj['value' + actionAttr.key] = "";
                            } else if (actionAttr.key === 'WorkflowAttachmentsValueFrom') {
                                modelObjItem['value' + actionAttr.key] = [];
                                objAttach["Attachments"] = "";
                            } else if (actionAttr.key === 'WorkflowAttachmentsValueFromCSObject') {
                                objAttach['actionattrname' + actionAttr.key] = "";
                                objAttach['value' + actionAttr.key] = "";
                            } else if (actionAttr.key === 'WorkflowAttachmentsValueFromDesktop') {
                                objAttach['actionattrname' + actionAttr.key] = "";
                                objAttach['value' + actionAttr.key] = "";
                            } else if (actionAttr.key === 'WorkflowAttachmentsValueFromAddShortcut') {
                                objAttach['actionattrname' + actionAttr.key] = "";
                                objAttach['value' + actionAttr.key] = "";
                            } else if (actionAttr.key === 'WorkflowAttachmentsFromPreviousAction') {
                                objAttach['actionattrname' + actionAttr.key] = "";
                                objAttach['value' + actionAttr.key] = "";
                            } else {
                                modelObjItem['actionattrname' + actionAttr.key] = '';
                                modelObjItem['source' + actionAttr.key] = '';
                                modelObjItem['csObj_field' + actionAttr.key] = '';
                                modelObjItem['evtProp_field' + actionAttr.key] = '';
                                modelObjItem['prevAct_field' + actionAttr.key] = '';
                                modelObjItem['value' + actionAttr.key] = '';
                            }
                        });
                        if (modelObjItem['valueWorkflowAttribute']) {
                            modelObjItem['valueWorkflowAttribute'].push(obj);
                        }
                        if (modelObjItem['valueWorkflowAttachmentsValueFrom']) {
                            modelObjItem['valueWorkflowAttachmentsValueFrom'].push(objAttach);
                        }
                        if (eacDefaultPlanModel.get('action_key') === actionKey) {
                            var i, j, attributeDetails;
                            modelObj.get('attribute_mappings').forEach(function (attribute) {

                                var attributeInfo = eacDefaultPlanModel.get("actions_attributes").filter(function (actionAttr) {
                                    return (actionAttr.key === attribute.mappingAttributeName);
                                }),
                                    source = '',
                                    value = '',
                                    propVal = '',
                                    csObj_propVal = '',
                                    evtProp_propVal = '';

                                if (attribute.hasOwnProperty('WorkflowAttributes')) {
                                    if (modelObjItem['valueWorkflowAttribute']) {
                                        modelObjItem['valueWorkflowAttribute'].pop();
                                    }
                                    for (i = 0; i < attribute.WorkflowAttributes.length; i++) {
                                        var objAttr = {};
                                        for (j = 0; j < attribute.WorkflowAttributes[i].length; j++) {
                                            attributeDetails = eacDefaultPlanModel.get("actions_attributes").filter(function (actionAttr) {
                                                return (actionAttr.key === attribute.WorkflowAttributes[i][j].mappingAttributeName);
                                            });
                                            if (attribute.WorkflowAttributes[i][j].mappingAttributeName === 'WorkflowAttribute') {
                                                objAttr["Attribute"] = attribute.WorkflowAttributes[i][j].mappingData;
                                            } else if (attributeDetails.length) {
                                                objAttr["actionattrname" + attributeDetails[0].key] = attributeDetails[0].name;
                                                objAttr["value" + attributeDetails[0].key] = attribute.WorkflowAttributes[i][j].mappingData;
                                            } else {
                                                objAttr["actionattrname" + attribute.WorkflowAttributes[i][j].mappingAttributeName] = attribute.WorkflowAttributes[i][j].mappingMethod;
                                                objAttr["value" + attribute.WorkflowAttributes[i][j].mappingAttributeName] = attribute.WorkflowAttributes[i][j].mappingData;
                                            }
                                        }
                                        modelObjItem['valueWorkflowAttribute'].push(objAttr);
                                    }
                                } else if (attribute.hasOwnProperty('WorkflowAttachments')) {
                                    if (modelObjItem['valueWorkflowAttachmentsValueFrom']) {
                                        modelObjItem['valueWorkflowAttachmentsValueFrom'].pop();
                                    }
                                    for (i = 0; i < attribute.WorkflowAttachments.length; i++) {
                                        var attachmentObj = {};
                                        for (j = 0; j < attribute.WorkflowAttachments[i].length; j++) {
                                            attributeDetails = eacDefaultPlanModel.get("actions_attributes").filter(function (actionAttr) {
                                                return (actionAttr.key === attribute.WorkflowAttachments[i][j].mappingAttributeName);
                                            });
                                            if (attribute.WorkflowAttachments[i][j].mappingAttributeName === 'WorkflowAttachmentsValueFrom') {
                                                attachmentObj["Attachments"] = attribute.WorkflowAttachments[i][j].mappingData;
                                            } else if (attributeDetails.length) {
                                                attachmentObj["actionattrname" + attributeDetails[0].key] = attributeDetails[0].name;
                                                attachmentObj["value" + attributeDetails[0].key] = attribute.WorkflowAttachments[i][j].mappingData;
                                            } else {
                                                attachmentObj["actionattrname" + attribute.WorkflowAttachments[i][j].mappingAttributeName] = attribute.WorkflowAttachments[i][j].mappingMethod;
                                                attachmentObj["value" + attribute.WorkflowAttachments[i][j].mappingAttributeName] = attribute.WorkflowAttachments[i][j].mappingData;
                                            }
                                        }
                                        modelObjItem['valueWorkflowAttachmentsValueFrom'].push(attachmentObj);
                                    }
                                } else {
                                    attributeInfo = attributeInfo.length > 0 ? attributeInfo[0] : attributeInfo;
                                    source = attribute.mappingMethod;
                                    propVal = attribute.mappingData;

                                    if (source === 'Content Server Object') {
                                        source = "csObj";
                                        csObj_propVal = propVal;
                                    } else if (source === 'Event Property') {
                                        source = "evtProp";
                                        evtProp_propVal = propVal;
                                    } else if (source === 'Result from previous Action') {
                                        source = "prevAct";
                                    } else if (source === 'NA') {
                                        value = (attributeInfo.key === "WorkflowUser" || attributeInfo.key === "Reminder_client" || attributeInfo.key === "Reminder_type") ? parseInt(propVal) : propVal;
                                    }
                                    modelObjItem[actionKey + '_fields'][attribute.mappingAttributeName] = {
                                        "actionattrname": attributeInfo.name,
                                        "source": source,
                                        "value": value,
                                        "csObj_field": csObj_propVal,
                                        "evtProp_field": evtProp_propVal,
                                        "prevAct_field": "Result from previous action"
                                    };
                                    if (attributeInfo.key === "ReminderDueDateCompleteIn") {
                                        modelObjItem["actionattrname" + attributeInfo.key] = attributeInfo.name;
                                        modelObjItem["value1" + attributeInfo.key] = value.split(',')[0];
                                        modelObjItem["value2" + attributeInfo.key] = value.split(',')[1];
                                    } else if (attributeInfo.key === "Reminder_type") {
                                        modelObjItem["actionattrname" + attributeInfo.key] = attributeInfo.name;
                                        modelObjItem["value" + attributeInfo.key + modelObjItem["valueReminder_client"]] = value;
                                    }
                                    else {
                                        modelObjItem["actionattrname" + attributeInfo.key] = attributeInfo.name;
                                        modelObjItem["source" + attributeInfo.key] = source;
                                        modelObjItem["csObj_field" + attributeInfo.key] = csObj_propVal;
                                        modelObjItem["evtProp_field" + attributeInfo.key] = evtProp_propVal;
                                        modelObjItem["prevAct_field" + attributeInfo.key] = "Result from previous action";
                                        modelObjItem["value" + attributeInfo.key] = value;
                                    }
                                    modelObjItem[actionKey + '_fields']["actionattributes"]["key" + (attribute.position - 1)] = attributeInfo.key
                                }
                            });
                        }
                    });
                    return modelObjItem;
                });
            } else {
                var emptyModel = {
                    action: '',
                    valueDependsOn: ''
                };
                eacDefaultPlans.models.forEach(function (eacPlan) {
                    var keyName = eacPlan.get('action_key') + '_fields';
                    var obj = { Attribute: "" };
                    var objAttach = { Attachments: "" };
                    emptyModel[keyName] = {
                        'actionattributes': {
                            'parametername': lang.actionAttrParameterNameLabel,
                            'sourcelabel': lang.actionAttrSourceLabel,
                            'valuelabel': lang.actionAttrValueLabel
                        }
                    };
                    eacPlan.get("actions_attributes").filter(function (actionAttr) {
                        emptyModel[keyName][actionAttr.key] = {
                            'actionattrname': '',
                            'source': '',
                            'value': '',
                            'csObj_field': '',
                            'evtProp_field': '',
                            'prevAct_field': ''
                        }
                        emptyModel['actionattrname' + actionAttr.key] = '';
                        emptyModel['source' + actionAttr.key] = '';
                        emptyModel['csObj_field' + actionAttr.key] = '';
                        emptyModel['evtProp_field' + actionAttr.key] = '';
                        emptyModel['prevAct_field' + actionAttr.key] = '';
                        if (actionAttr.key === 'WorkflowAttribute') {
                            emptyModel['value' + actionAttr.key] = [];

                        } else if (actionAttr.key === 'WorkflowAttributeValueFrom') {
                            obj['actionattrname' + actionAttr.key] = "";
                            obj['value' + actionAttr.key] = "";
                        } else if (actionAttr.key === 'WorkflowAttributeEvtProp') {
                            obj['actionattrname' + actionAttr.key] = "";
                            obj['value' + actionAttr.key] = "";
                        } else if (actionAttr.key === 'WorkflowAttributeCSObject') {
                            obj['actionattrname' + actionAttr.key] = "";
                            obj['value' + actionAttr.key] = "";
                        } else if (actionAttr.key === 'WorkflowAttributeUserInput') {
                            obj['actionattrname' + actionAttr.key] = "";
                            obj['value' + actionAttr.key] = "";
                        } else if (actionAttr.key === 'WorkflowAttributeFromPreviousAction') {
                            obj['actionattrname' + actionAttr.key] = "";
                            obj['value' + actionAttr.key] = "";
                        } else if (actionAttr.key === 'WorkflowAttachmentsValueFrom') {
                            emptyModel['value' + actionAttr.key] = [];
                        } else if (actionAttr.key === 'WorkflowAttachmentsValueFromCSObject') {
                            objAttach['actionattrname' + actionAttr.key] = "";
                            objAttach['value' + actionAttr.key] = "";
                        } else if (actionAttr.key === 'WorkflowAttachmentsValueFromDesktop') {
                            objAttach['actionattrname' + actionAttr.key] = "";
                            objAttach['value' + actionAttr.key] = "";
                        } else if (actionAttr.key === 'WorkflowAttachmentsValueFromAddShortcut') {
                            objAttach['actionattrname' + actionAttr.key] = "";
                            objAttach['value' + actionAttr.key] = "";
                        } else {
                            emptyModel['actionattrname' + actionAttr.key] = '';
                            emptyModel['value' + actionAttr.key] = '';
                        }
                    });
                    if (emptyModel['valueWorkflowAttribute']) {
                        emptyModel['valueWorkflowAttribute'].push(obj);
                    }
                    if (emptyModel['valueWorkflowAttachmentsValueFrom']) {
                        emptyModel['valueWorkflowAttachmentsValueFrom'].push(objAttach);
                    }
                });
                formData.push(emptyModel);
            }
            return {
                actions_Data: formData
            };
        },        
        getPlaceholder: function(value, collection){
            //TO DO: need to remove once LPAD-88277 is fixed
            if (!collection.includes(value)) {
                collection.splice(0, 0, value);
            }
         },

        validateValue: function(type, value) {
            var deferred        = $.Deferred(),
            connector       = this.formModel.connector,
            url             = connector.getConnectionUrl().getApiBase('v2')+ '/eventactioncenter/validateformfields?field_type=' + type + '&field_value=' + value;

            $.ajax(connector.extendAjaxOptions({
                url: url,
                type: "GET",
                contentType: false,
                crossDomain: true,
                processData: false,
                success: function (response, status, jXHR) {
                  deferred.resolve(response);
                },
                error: function (xhr, status, text) {
                  var error = new base.RequestErrorMessage(xhr);
                  deferred.reject(xhr, status, error.toString());
                }
            }));

            return deferred.promise();   
        },

        updateAttributeValues: function (attributes, hasValue, id, ele) {
            var i, promises, schema = attributes.schema, options = attributes.options, $el = ele,
                that = this, rawWhen = $.when, deferred = $.Deferred();
            $.whenAll = function (promise) {
                if ($.isArray(promise)) {
                    var dfd = $.Deferred();
                    rawWhen.apply($, promise).done(function () {
                        dfd.resolve(Array.prototype.slice.call(arguments));
                    }).fail(function () {
                        dfd.reject(Array.prototype.slice.call(arguments));
                    });
                    return dfd.promise();
                }
                else {
                    return rawWhen.apply($, arguments);
                }
            };
            promises = attributes.data.actions_Data.map(function (actions_Data) {
                if (actions_Data.valueWorkflow && hasValue) {
                    that.attrModel.set('workflow_id', actions_Data.valueWorkflow);
                    return that.attrModel.fetch();
                } else if (!(hasValue) && id) {
                    that.attrModel.set('workflow_id', id);
                    return that.attrModel.fetch();
                }
            });
            $.whenAll(promises)
                .then(function (values) {
                    var j;
                    for (j = 0; j < values.length; j++) {
                        if (!!values[j]) {
                            var enumarray = [], labelsarray = [], results;
                            if (values[j].results) {
                                results = values[j].results;
                            } else {
                                results = values[j][0].results;
                            }
                            for (i = 0; i < results.length; i++) {
                                enumarray.push(results.data[i].name);
                                labelsarray.push(results.data[i].name);
                            }
                            schema.properties['actions_Data'].items.properties["valueWorkflowAttribute"].items.maxItems = results.length;
                            if (enumarray.length) {
                                schema.properties['actions_Data'].items.properties["valueWorkflowAttribute"].items.properties["Attribute"].enum = enumarray;
                                options.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["Attribute"].optionLabels = labelsarray;
                            } else {
                                schema.properties['actions_Data'].items.properties["valueWorkflowAttribute"].items.properties["Attribute"].enum = '';
                                options.fields['actions_Data'].fields.item.fields["valueWorkflowAttribute"].fields.item.fields["Attribute"].optionLabels = '';
                            }
                            that.trigger('update:attributeValue', $el, results);
                            deferred.resolve(true);
                        }
                    }
                });
        },

        updateTypeValues: function(attributes){
            var i, promises, schema = attributes.schema, options = attributes.options,
                that = this, rawWhen = $.when, deferred = $.Deferred();
            $.whenAll = function (promise) {
                if ($.isArray(promise)) {
                    var dfd = $.Deferred();
                    rawWhen.apply($, promise).done(function () {
                        dfd.resolve(Array.prototype.slice.call(arguments));
                    }).fail(function () {
                        dfd.reject(Array.prototype.slice.call(arguments));
                    });
                    return dfd.promise();
                }
                else {
                    return rawWhen.apply($, arguments);
                }
            };

            promises = attributes.data.actions_Data.map(function (actions_Data) {
                if (actions_Data.valueReminder_client) {
                    that.escModel.set('id', actions_Data["valueReminder_type" + actions_Data.valueReminder_client]);
                    that.escModel.set('client_id', actions_Data.valueReminder_client);
                    return that.escModel.fetch();
                }
            });
            $.whenAll(promises)
                .then(function (values) {
                    if (!!values[0]) {
                        var  enumarray, labelsarray, model;
                        for (i = 0; i < values.length; i++) {
                            if (!!values[i]) {
                                model = !!values[i].forms ? values[i].forms[0] : (!!values[i][0] && !!values[i][0].forms ? values[i][0].forms[0] : undefined);
                            }
                            if (model) {
                                enumarray = model.schema.properties.followup_type_name.enum;
                                labelsarray = model.options.fields.followup_type_name.optionLabels;
                                schema.properties['actions_Data'].items.properties["valueReminder_type" + model.data.followup_client_name].enum = '';
                                options.fields['actions_Data'].fields.item.fields["valueReminder_type" + model.data.followup_client_name].optionLabels = '';
                                if (enumarray[0] != null) {
                                    that.getPlaceholder(null, enumarray);
                                    that.getPlaceholder(lang.reminderTypePlaceholder, labelsarray);
                                }
                                schema.properties['actions_Data'].items.properties["valueReminder_type" + model.data.followup_client_name].enum = enumarray;
                                options.fields['actions_Data'].fields.item.fields["valueReminder_type" + model.data.followup_client_name].optionLabels = labelsarray;
                                if (model.data.escalation_alert) {
                                    attributes.data.actions_Data[i].escalation = true;
                                    options.fields.actions_Data.fields.item.fields.actionattrnameReminderEscalationTo.hidden = false;
                                    options.fields.actions_Data.fields.item.fields.valueReminderEscalationTo.hidden = false;

                                }
                            }
                        }
                        deferred.resolve(true);
                    }
                });
        }

    });

    return EACActionsFormModel;

});

csui.define('xecmpf/widgets/eac/impl/actionplan.actions/impl/actionplan.Attachments.FromDesktop',['module',
  'require',
  'csui/lib/underscore',
  'csui/lib/jquery',
  'csui/utils/commands/add',
  'csui/dialogs/file.open/file.open.dialog'
], function (module, require, _, $, AddCommand, FileOpenDialog) {
  'use strict';
  var AddFromFileSystem = AddCommand.extend({
    _selectFilesForUpload: function (status, options) {
      var deferred = $.Deferred(),
        fileOpenDialog = new FileOpenDialog({ multiple: true });
      fileOpenDialog
        .on('add:files', function (files) {
          csui.require(['csui/controls/fileupload/fileupload'
          ], function (fileUploadHelper) {
            var uploadController = fileUploadHelper.newUpload(status, options);
            uploadController.addFilesToUpload(files, {
              collection: status.collection
            }).done(function (res) {
              deferred.resolve(res);
            });
          });
        })
        .on('cancel', function () {
          deferred.reject();
        })
        .show();
      return deferred.promise();
    }
  });

  return AddFromFileSystem;

});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/eac/impl/actionplan.actions/impl/actionplan.actions',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div>\r\n    <div class=\"xecmpf-eac-actions-header-wrapper binf-col-md-12 xecmpf-eac-header\">\r\n        <h4 class=\"xecmpf-eac-actions-header\" title=\"{{options.actionsLabel}}\" aria-label=\"{{options.actionsLabel}}\">{{options.actionsLabel}}</h4>\r\n    </div>\r\n    <div class=\"xecmpf-eac-actions-container-wrapper\">\r\n        <div class=\"binf-row\">\r\n            <div class=\"xecmpf-eac-actions-container binf-col-md-12 csui-form-set-array-wrapper\">\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n";
}});
Handlebars.registerPartial('xecmpf_widgets_eac_impl_actionplan.actions_impl_actionplan.actions', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/eac/impl/actionplan.actions/impl/actionplan.actions',[],function(){});
csui.define('xecmpf/widgets/eac/impl/actionplan.actions/actionplan.actions.view',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/backbone', 'csui/lib/marionette',
    'csui/utils/contexts/factories/connector', 'csui/controls/form/form.view', 'csui/controls/progressblocker/blocker',
    'csui/controls/globalmessage/globalmessage',
    'csui/models/node/node.model',
    'xecmpf/widgets/eac/impl/actionplan.actions/impl/actionplan.actions.form.model',
    'xecmpf/widgets/eac/impl/actionplan.actions/impl/actionplan.Attachments.FromDesktop',
    'hbs!xecmpf/widgets/eac/impl/actionplan.actions/impl/actionplan.actions',
    'i18n!xecmpf/widgets/eac/impl/nls/lang',
    'css!xecmpf/widgets/eac/impl/actionplan.actions/impl/actionplan.actions',
], function (_, $, Backbone, Marionette, ConnectorFactory, FormView, BlockingView,
    GlobalMessage, NodeModel, EACActionFormModel, AddFromFileSysCommand, template, lang) {

    var EACActionsView = FormView.extend({

        className: function () {
            var computedClassName = FormView.prototype.className.call(this);
            computedClassName += ' xecmpf-eac-actions xecmpf-eac-actions-read xecmpf-eac-actions-hide-validation-errors';
            return computedClassName;
        },

        constructor: function (options) {
            options || (options = {});
            var actionPlanActionsModels,
                actions = options.eventModel && (options.eventModel.get('data') ? options.eventModel.get('data').actions : options.eventModel.get('actions')) || [];
            actionPlanActionsModels = actions.map(function (action, index) {
                return new Backbone.Model({
                    sequence: index + 1,
                    depends_on: action.dependsOn,
                    action_key: action.actionKey,
                    attribute_mappings: action.actionAttributeMappings
                });
            });
            var actionPlanId = options.eventModel.attributes.event_def_id;
            this.container = new NodeModel({ id: actionPlanId }, { connector: options.context.getModel(ConnectorFactory) });
            this.addFromFileSysCommand = new AddFromFileSysCommand();
            this.collection = new Backbone.Collection();
            this.collection.add(actionPlanActionsModels);
            options.model = new EACActionFormModel(undefined, {
                context: options.context,
                eventModel: options.eventModel,
                collection: this.collection
            });
            options.mode = 'update';
            options.layoutMode = 'doubleCol';
            options.breakFieldsAt = 3;
            FormView.prototype.constructor.call(this, options);
            this.listenTo(this, 'change:field', this._ValidateActions);
            this.listenTo(this.model, 'update:error', this.updateError);
            this.listenTo(this.model, 'update:field', this._updateActions);
            this.listenTo(this.model, 'change:client', this.OnClientChange);
            this.listenTo(this.model, 'change:type', this.OnTypeChange);
            this.listenTo(this.model, "change:dueDate", this.onChangeDuedate);
            this.listenTo(this, 'render:form', this._getDetails);
            this.listenTo(this.model, 'field:invalid', this.disableSave);
            this.listenTo(this.model, 'change:parameter', this.OnChangeParameter);
            this.listenTo(this.model, 'update:parameter', this.RemoveParameter);
            this.listenTo(this.model, 'update:attributeValue', this.UpdateAttribute);
            this.listenTo(this.model, 'update:valueFromDesktop', this.attachmentFromDesktop);
        },


        formTemplate: template,

        events: {
            "click .inline-edit-icon": "_doEditActions",
            "focusout .xecmpf-eac-actions-container-wrapper": "onFocusout",
            "focusout .xecmpf-eac-actions-container .cs-pull-left": "showInReadMode"
        },

        attachmentFromDesktop: function (event) {
            if (event.target.innerText.trim() === 'From desktop') {
                var that = this;
                var status = {
                    originatingView: this,
                    context: this.options.context,
                    container: this.container,
                    data: 144
                };
                var fileSysOptions = {
                    context: this.options.context,
                    addableType: 144,
                    addableTypeName: "document"
                };
                this.addFromFileSysCommand.execute(status, fileSysOptions).done(function (fileInfo) {
                    if (fileInfo && fileInfo.node) {
                        var currentAction = that.form.childrenByPropertyId.actions_Data.children.map(function (child) {
                            var attrField = child.childrenByPropertyId.valueWorkflowAttachmentsValueFrom.children.filter(function (e) {
                                return e.id === event.currentTarget.parentNode.getAttribute('data-alpaca-container-item-parent-field-id');
                            })
                            return attrField;
                        })
                        var i;
						for (i = 0; i < currentAction.length; i++) {
							if (currentAction[i].length > 0) {
								currentAction[0] = currentAction[i];
							}
						}
                        currentAction[0][0].childrenByPropertyId["valueWorkflowAttachmentsValueFromDesktop"].fieldView.setValue(fileInfo.node.get('id'), true);
                        currentAction[0][0].childrenByPropertyId["valueWorkflowAttachmentsValueFromDesktop"].fieldView.node.set(fileInfo.node.attributes);
                    }
                });
            }
        },

        UpdateAttribute: function (event, response) {
            var result = response, that = this, j;
            if (response.length && this.form) {
                var currentAction = this.form.childrenByPropertyId.actions_Data.children.filter(function (e) {
                    return e.id === $(event.containerItemEl).closest(".alpaca-field").attr('data-alpaca-field-id');
                })
                var typeArray = [], i, k;
                for (i = 0; i < currentAction[0].childrenByPropertyId["valueWorkflowAttribute"].children.length; i++) {
                    if (currentAction[0].childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["Attribute"].fieldView.collection.findWhere({ 'id': null })) {
                        typeArray.push(currentAction[0].childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["Attribute"].fieldView.collection.findWhere({ 'id': null }));
                    }
                    currentAction[0].childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["Attribute"].fieldView.collection.reset();
                    for (k = 0; k < response.length; k++) {
                        typeArray.push(new Backbone.Model({ 'id': response.data[k].name, 'name': response.data[k].name }));
                    }
                    currentAction[0].childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["Attribute"].fieldView.collection.reset(typeArray);
                }
            }
            if (response.length && this.model) {
                for (j = 0; j < response.length; j++) {
                    if ((response.data[j].type_name === 'Integer') && (response.data[j].persona === '')) {
                        this.options.model.attributes.options.fields.actions_Data.fields.item.fields.valueWorkflowAttribute.fields.item.fields.valueWorkflowAttributeUserInputinteger.dependencies["Attribute"] = response.data[j].name;
                        this.options.model.attributes.options.fields.actions_Data.fields.item.fields.valueWorkflowAttribute.fields.item.fields.actionattrnameWorkflowAttributeUserInputinteger.dependencies["Attribute"] = response.data[j].name;
                    } else if (response.data[j].type_name === 'String') {
                        this.options.model.attributes.options.fields.actions_Data.fields.item.fields.valueWorkflowAttribute.fields.item.fields.valueWorkflowAttributeUserInputtext.dependencies["Attribute"] = response.data[j].name;
                        this.options.model.attributes.options.fields.actions_Data.fields.item.fields.valueWorkflowAttribute.fields.item.fields.actionattrnameWorkflowAttributeUserInputtext.dependencies["Attribute"] = response.data[j].name;
                    } else if (response.data[j].type_name === 'Date') {
                        this.options.model.attributes.options.fields.actions_Data.fields.item.fields.valueWorkflowAttribute.fields.item.fields.valueWorkflowAttributeUserInputdate.dependencies["Attribute"] = response.data[j].name;
                        this.options.model.attributes.options.fields.actions_Data.fields.item.fields.valueWorkflowAttribute.fields.item.fields.actionattrnameWorkflowAttributeUserInputdate.dependencies["Attribute"] = response.data[j].name;
                    } else if (response.data[j].type_name === 'Boolean') {
                        this.options.model.attributes.options.fields.actions_Data.fields.item.fields.valueWorkflowAttribute.fields.item.fields.valueWorkflowAttributeUserInputcheckbox.dependencies["Attribute"] = response.data[j].name;
                        this.options.model.attributes.options.fields.actions_Data.fields.item.fields.valueWorkflowAttribute.fields.item.fields.actionattrnameWorkflowAttributeUserInputcheckbox.dependencies["Attribute"] = response.data[j].name;
                    } else if ((response.data[j].type_name === 'Integer') && (response.data[j].persona === 'user')) {
                        this.options.model.attributes.options.fields.actions_Data.fields.item.fields.valueWorkflowAttribute.fields.item.fields.valueWorkflowAttributeUserInputotcs_user_picker.dependencies["Attribute"] = response.data[j].name;
                        this.options.model.attributes.options.fields.actions_Data.fields.item.fields.valueWorkflowAttribute.fields.item.fields.actionattrnameWorkflowAttributeUserInputotcs_user_picker.dependencies["Attribute"] = response.data[j].name;
                    }
                }
                this.listenTo(this.model, 'update:valueField', function (event) {
                    var k;
                    for (k = 0; k < result.length; k++) {
                        if (result.data[k].name === event.target.innerText) {
                            that.enableValueField(event, result.data[k].type_name, result.data[k].persona);
                        }
                    }
                });
            }
        },

        enableValueField: function (event, type, persona) {
            var currentAction = this.form.childrenByPropertyId.actions_Data.children.map(function (child) {
                var attrField = child.childrenByPropertyId.valueWorkflowAttribute.children.filter(function (e) {
                    return e.id === event.currentTarget.parentNode.getAttribute('data-alpaca-container-item-parent-field-id');
                })
                return attrField;
            })
            var i, that = this;
            for (i = 0; i < currentAction.length; i++) {
                if (currentAction[i].length > 0) {
                    currentAction[0] = currentAction[i];
                }
            }
            this.listenTo(this.model, 'update:userInput', function (event) {
                if (event.target.innerText === 'User Input') {
                    that.displayUserInputField(currentAction, type, persona);
                } else {
                    this.hideDependentUserInputFields(currentAction);
                }
            });
            if (currentAction[0][0].childrenByPropertyId["valueWorkflowAttributeValueFrom"].fieldView.getEditValue().attributes.name === 'User Input') {
                that.displayUserInputField(currentAction, type, persona);
            } else {
                this.hideDependentUserInputFields(currentAction);
            }
            currentAction[0][0].childrenByPropertyId["Attribute"].containerItemEl.removeClass('cs-worflow-error');
            currentAction[0][0].childrenByPropertyId["actionattrnameWorkflowAttributeValueFrom"].containerItemEl.css('display', 'block');
            currentAction[0][0].childrenByPropertyId["valueWorkflowAttributeValueFrom"].containerItemEl.css('display', 'block');
        },

        hideDependentUserInputFields: function (currentAction, text) {
            var types = ["text", "date", "integer", "checkbox", "otcs_user_picker"];
            types.forEach(function (value) {
                if (value !== text) {
                    currentAction[0][0].childrenByPropertyId["valueWorkflowAttributeUserInput" + value].containerItemEl.css('display', 'none');
                    currentAction[0][0].childrenByPropertyId["actionattrnameWorkflowAttributeUserInput" + value].containerItemEl.css('display', 'none');
                }
            })
        },

        showUserInputField: function (currentAction, text) {
            if (text) {
                currentAction[0][0].childrenByPropertyId["valueWorkflowAttributeUserInput" + text].field.removeClass('binf-hidden');
                currentAction[0][0].childrenByPropertyId["actionattrnameWorkflowAttributeUserInput" + text].field.removeClass('binf-hidden');
                currentAction[0][0].childrenByPropertyId["actionattrnameWorkflowAttributeUserInput" + text].containerItemEl.removeClass('binf-hidden');
                currentAction[0][0].childrenByPropertyId["valueWorkflowAttributeUserInput" + text].containerItemEl.removeClass('binf-hidden');
                currentAction[0][0].childrenByPropertyId["valueWorkflowAttributeUserInput" + text].containerItemEl.css('display', 'block');
                currentAction[0][0].childrenByPropertyId["actionattrnameWorkflowAttributeUserInput" + text].containerItemEl.css('display', 'block');
            }
        },
        enableUserInputField: function (currentAction) {
            if (!!currentAction.childrenByPropertyId["valueWorkflowAttributeUserInputcheckbox"].data) {
                currentAction.childrenByPropertyId["actionattrnameWorkflowAttributeUserInputcheckbox"].field.removeClass('binf-hidden');
                currentAction.childrenByPropertyId["actionattrnameWorkflowAttributeUserInputcheckbox"].containerItemEl.css('display', 'block');
                currentAction.childrenByPropertyId["valueWorkflowAttributeUserInputcheckbox"].field.removeClass('binf-hidden');
                currentAction.childrenByPropertyId["valueWorkflowAttributeUserInputcheckbox"].containerItemEl.css('display', 'block');
            } else if (!!currentAction.childrenByPropertyId["valueWorkflowAttributeUserInputdate"].data) {
                currentAction.childrenByPropertyId["actionattrnameWorkflowAttributeUserInputdate"].field.removeClass('binf-hidden');
                currentAction.childrenByPropertyId["actionattrnameWorkflowAttributeUserInputdate"].containerItemEl.css('display', 'block');
                currentAction.childrenByPropertyId["valueWorkflowAttributeUserInputdate"].field.removeClass('binf-hidden');
                currentAction.childrenByPropertyId["valueWorkflowAttributeUserInputdate"].containerItemEl.css('display', 'block');
            } else if (!!currentAction.childrenByPropertyId["valueWorkflowAttributeUserInputinteger"].data) {
                currentAction.childrenByPropertyId["actionattrnameWorkflowAttributeUserInputinteger"].field.removeClass('binf-hidden');
                currentAction.childrenByPropertyId["actionattrnameWorkflowAttributeUserInputinteger"].containerItemEl.css('display', 'block');
                currentAction.childrenByPropertyId["valueWorkflowAttributeUserInputinteger"].field.removeClass('binf-hidden');
                currentAction.childrenByPropertyId["valueWorkflowAttributeUserInputinteger"].containerItemEl.css('display', 'block');
            } else if (!!currentAction.childrenByPropertyId["valueWorkflowAttributeUserInputotcs_user_picker"].data) {
                currentAction.childrenByPropertyId["actionattrnameWorkflowAttributeUserInputotcs_user_picker"].field.removeClass('binf-hidden');
                currentAction.childrenByPropertyId["actionattrnameWorkflowAttributeUserInputotcs_user_picker"].containerItemEl.css('display', 'block');
                currentAction.childrenByPropertyId["valueWorkflowAttributeUserInputotcs_user_picker"].field.removeClass('binf-hidden');
                currentAction.childrenByPropertyId["valueWorkflowAttributeUserInputotcs_user_picker"].containerItemEl.css('display', 'block');
            } else if (!!currentAction.childrenByPropertyId["valueWorkflowAttributeUserInputtext"].data) {
                currentAction.childrenByPropertyId["actionattrnameWorkflowAttributeUserInputtext"].field.removeClass('binf-hidden');
                currentAction.childrenByPropertyId["actionattrnameWorkflowAttributeUserInputtext"].containerItemEl.css('display', 'block');
                currentAction.childrenByPropertyId["valueWorkflowAttributeUserInputtext"].field.removeClass('binf-hidden');
                currentAction.childrenByPropertyId["valueWorkflowAttributeUserInputtext"].containerItemEl.css('display', 'block');
            }
        },
        displayUserInputField: function (currentAction, type, persona) {
            var text;
            if (type === "String") {
                text = 'text';
                this.hideDependentUserInputFields(currentAction, text);
                this.showUserInputField(currentAction, text);
            } else if (type === "Integer" && persona === '') {
                text = 'integer';
                this.hideDependentUserInputFields(currentAction, text);
                this.showUserInputField(currentAction, text);
            } else if (type === "Date") {
                text = 'date';
                this.hideDependentUserInputFields(currentAction, text);
                this.showUserInputField(currentAction, text);
            } else if (type === "Boolean") {
                text = 'checkbox';
                this.hideDependentUserInputFields(currentAction, text);
                this.showUserInputField(currentAction, text);
            } else if (type === "Integer" && persona === 'user') {
                text = 'otcs_user_picker';
                this.hideDependentUserInputFields(currentAction, text);
                this.showUserInputField(currentAction, text);
            }
        },

        enableParameters: function (event) {
            var currentField;
            currentField = this.form.childrenByPropertyId.actions_Data.children.filter(function (e) {
                return e.id === event.currentTarget.closest('.csui-field-checkbox').getAttribute('data-alpaca-container-item-parent-field-id');
            })
            currentField[0].childrenByPropertyId["valueWebreportParameters"].fieldView.setValue(event.currentTarget.checked, true);
        },

        enableAttribute: function (event) {
            var currentField;
            currentField = this.form.childrenByPropertyId.actions_Data.children.filter(function (e) {
                return e.id === event.currentTarget.closest('.csui-field-checkbox').getAttribute('data-alpaca-container-item-parent-field-id');
            })
            currentField[0].childrenByPropertyId["valueWorkflowAttributes"].fieldView.setValue(event.currentTarget.checked, true);
        },

        enableAttachments: function (event) {
            var currentField;
            currentField = this.form.childrenByPropertyId.actions_Data.children.filter(function (e) {
                return e.id === event.currentTarget.closest('.csui-field-checkbox').getAttribute('data-alpaca-container-item-parent-field-id');
            })
            currentField[0].childrenByPropertyId["valueWorkflowAttachments"].fieldView.setValue(event.currentTarget.checked, true);
        },

        onChangeDuedate: function (event) {
            var currentAction, value, len;
            currentAction = this.form.childrenByPropertyId.actions_Data.children.filter(function (e) {
                return e.id === event.currentTarget.parentNode.getAttribute('data-alpaca-container-item-parent-field-id');
            })
            this.completeInField = currentAction[0].childrenByPropertyId["value1ReminderDueDateCompleteIn"];
            this.completeInDaysField = currentAction[0].childrenByPropertyId["value2ReminderDueDateCompleteIn"];
            len = this.completeInField.fieldView.getEditValue().length;
            value = parseInt(this.completeInField.fieldView.getEditValue());
            if (len > 1) {
                this.completeInField.containerItemEl.addClass("eac-action-completeIn-Field");
                this.completeInDaysField.containerItemEl.addClass("eac-action-completeIn-Field");
            } else {
                this.completeInField.containerItemEl.removeClass("eac-action-completeIn-Field");
                this.completeInDaysField.containerItemEl.addClass("eac-action-completeIn-Field");
            }
            if (this.completeInField.fieldView.getEditValue() === '' || (value !== parseInt(value, 10))) {
                this.completeInField.containerItemEl.addClass("eac-action-completeIn-Field");
            } else {
                this.completeInField.containerItemEl.removeClass("eac-action-completeIn-Field");
            }
        },

        disableSave: function () {
            this.$el.closest(".xecmpf-actionpan-details-view").find(".xecmpf-eac-save-actionplan").prop("disabled", true);
        },

        showErrorMsg: function (cancelAction) {
            var reminderField = ["valueReminderAssigneeCategoryAttr", "valueReminderAssigneePWCategoryAttr", "valueReminderAssigneePWRole", "valueReminderDueDateCategoryAttr",
                "valueReminderDueDatePWCategoryAttr", "valueReminderEscalationToCategoryAttr", "valueReminderEscalationToPWCategoryAttr", "valueReminderEscalationToPWRole"];
            if (this.options.model.attributes.data.actions_Data) {
                var data, actionLength, setAttributes;
                var that = this;
                if (cancelAction) {
                    actionLength = this.form.data.actions_Data.length;
                } else {
                    actionLength = this.options.model.attributes.data.actions_Data.length;
                }
                for (var i = 0; i < actionLength && (this.form.data.actions_Data[i].action === "ReminderEventAction.Add A Reminder" || this.options.model.attributes.data.actions_Data[i].action === "ReminderEventAction.Add A Reminder"); i++) {
                    for (var j = 0; j < reminderField.length; j++) {
                        if (cancelAction) {
                            data = this.form.childrenByPropertyId["actions_Data"].children[i].data[reminderField[j]];
                        } else {
                            data = this.options.model.attributes.data.actions_Data[i][reminderField[j]];
                        }
                        if (!!data) {
                            setAttributes = this.form.childrenByPropertyId["actions_Data"].children[i].childrenByPropertyId[reminderField[j]];
                            !!setAttributes && setAttributes.fieldView.alpacaField.refreshValidationState(false, function () {
                                if (that.$el.find(".binf-has-error").is(":visible")) {
                                    if (that.$el.find('.csui-bulk-edit-actions_Data') && !cancelAction) {
                                        that.$el.find('.csui-bulk-edit-actions_Data').trigger('click');
                                    }
                                }
                            });
                        }
                    }
                }
            }
        },

        showInReadMode: function (event) {
            if (!event.currentTarget.contains(event.target) && event.relatedTarget == null) {
                this.$el.removeClass("xecmpf-eac-actions-write");
                this.$el.addClass("xecmpf-eac-actions-read");
            }
        },

        OnChangeParameter: function (event) {
            var oldValue, containerItem, dropdownText, multivalueContainer, val, firstChild, isEvent, element, target, i, j,
                currentAction, elementValue, duplicateEvent = false, count = 0, that = this, latestcount = 0;
            if (!!event && !!event.currentTarget) {
                multivalueContainer = $(event.currentTarget).closest(".csui-multivalue-container");
                val = multivalueContainer.children().length;
                currentAction = this.form.childrenByPropertyId.actions_Data.children.filter(function (e) {
                    return e.id === $(event.currentTarget).closest(".csui-field-array").attr('data-alpaca-container-item-parent-field-id');
                });
                element = $(event.currentTarget);
                target = event.target;
                isEvent = true;
            } else {
                multivalueContainer = $(this.paramField[0]).find(".csui-multivalue-container");
                val = multivalueContainer.children().length;
                currentAction = this.form.childrenByPropertyId.actions_Data.children.filter(function (e) {
                    return e.id === that.paramField.closest(".csui-field-array").attr('data-alpaca-container-item-parent-field-id');
                });
                element = this.paramField;
                target = this.paramField.find('.binf-dropdown-toggle');
            }
            this.parameterField = currentAction[0].childrenByPropertyId["valueWebreportParametersList"];
            for (i = 0; i < this.parameterField.children.length; i++) {
                if (this.parameterField.children[i].containerItemEl.is(element.closest(".cs-form-multi-action-container"))) {
                    oldValue = this.parameterField.children[i].fieldView.getOldValue().id;
                }
            }
            //The below code gets executed only when any parameter is removed and count of parameters is 2
            if (!isEvent && val === 2) {
                for (j = 0; j < val; j++) {
                    containerItem = multivalueContainer.children('[data-alpaca-container-item-index="' + j + '"]');
                    if (containerItem.find('.binf-text-danger').length) {
                        containerItem.find('.binf-text-danger').remove();
                    }
                }
            }
            for (j = 0; j < val; j++) {
                containerItem = multivalueContainer.children('[data-alpaca-container-item-index="' + j + '"]');
                dropdownText = containerItem.find(".binf-dropdown-toggle").text().trim();
                elementValue = isEvent ? ($(event.target).text().trim()) : $($(this.event.relatedTarget.parentElement.parentElement.parentElement.children[0]).find('.binf-dropdown-toggle')[0]).text().trim();
                if (isEvent) {
                    if ((elementValue === dropdownText) && !(containerItem.has(target).length)) {
                        duplicateEvent = true;
                    }
                } else  if(val>2){
                    //The below code gets executed only when any parameter is removed and count of parameters is > 2
                    if (containerItem.find('.alpaca-array-actionbar')[0] !== $(this.event.relatedTarget).parent()[0]) {
                        if ((elementValue === dropdownText)) {
                            latestcount++;
                            if (latestcount === 1) {
                                firstChild = containerItem;
                            }
                            duplicateEvent = true;
                        }
                        
                    }

                }
                if (oldValue === dropdownText) {
                    count++;
                    if (count === 1) {
                        firstChild = containerItem;
                    }
                }
            }
            if (duplicateEvent) {
                if (!(element.find(".binf-text-danger").length)) {
                    $('<div class="binf-text-danger"><span class="csui-text-danger">' + lang.selectDifferentParameter + '</span></div>')
                        .appendTo(element.find('.binf-col-sm-9'));
                }
            } else {
                    if (isEvent && element.find(".binf-text-danger").length) {
                        element.find(".binf-text-danger").remove();
                    }
            }
            if ((latestcount === 1 || count === 1) && firstChild.find(".binf-text-danger").length) {
                firstChild.find(".binf-text-danger").remove();
            }
        },

        OnClientChange: function (event) {
            if (!!event.currentTarget) {
                this.initializeField(event);
                if (!!this.EscalationToField && this.EscalationToSelectField && this.followuptypefield) {
                    this.listenTo(this.followuptypefield.fieldView, "selection:changed", this.updateEscalationModel);
                }
                this.updateFormViewModel();
            }
        },

        initializeField: function (event) {
            var currentAction = this.form.childrenByPropertyId.actions_Data.children.filter(function (e) {
                return e.id === event.currentTarget.parentNode.getAttribute('data-alpaca-container-item-parent-field-id');
            })
            this.currentAction = currentAction[0];
            this.followupClientField = currentAction[0].childrenByPropertyId["valueReminder_client"];
            this.EscalationToField = currentAction[0].childrenByPropertyId["actionattrnameReminderEscalationTo"];
            this.EscalationToSelectField = currentAction[0].childrenByPropertyId["valueReminderEscalationTo"];
            this.followuptypefield = currentAction[0].childrenByPropertyId["valueReminder_type"+this.followupClientField.data];
            //Changes to hide role/category depedent fields of escalation field
            if (!!currentAction[0].childrenByPropertyId["valueReminderEscalationToPWMetadata"] && currentAction[0].childrenByPropertyId["valueReminderEscalationToPWMetadata"].data === 'Role') {
                this.model.escModel.set('role', true);
            } else {
                this.model.escModel.set('role', false);
            }
        },

        OnTypeChange: function (event) {
            if (!!event.currentTarget) {
                this.initializeField(event);
                this.updateEscalationModel();
            }
        },

        updateError: function (event) {
            if (event.target.innerText.trim() === "Add a reminder") {
                if (!!this.EscalationToField && this.followuptypefield.isEscalation) {
                    this.EscalationToField.containerItemEl.removeClass("binf-hidden")
                    this.EscalationToSelectField.containerItemEl.removeClass("binf-hidden");
                    this.EscalationToField.field.removeClass('binf-hidden');
                    this.EscalationToSelectField.field.removeClass('binf-hidden');
                    this.EscalationToSelectField.field.parent().find('.binf-help-block-standalone').removeClass('binf-hidden');
                }
                if (!!this.options.model.formModel.error) {
                    $('<div class="csui-inlineform-group csui-inlineform-group-error">' + '<div class="binf-text-danger"><span class="csui-text-danger">' + lang.noReminderTypes + '</span></div></div>')
                        .appendTo($(event.currentTarget).find('.binf-col-sm-9'));
                }
            } else {
                $(event.currentTarget).find(".csui-inlineform-group-error").remove();
            }
            if (event.target.innerText.trim() === "Start webreport") {
                this.updateBooleanField();
            }
            if (event.target.innerText.trim() === "Start workflow") {
                this.updateAttributeField();
                this.updateAttachmentsField();
            }
            this.updateDependsOnField();
            this._updateActions();
        },

        updateDependsOnField: function () {
            if (!!this.form.children) {
                this.form.childrenByPropertyId["actions_Data"].children[0].childrenByPropertyId["actionattrnameDependsOn"].containerItemEl.addClass("binf-hidden");
                this.form.childrenByPropertyId["actions_Data"].children[0].childrenByPropertyId["valueDependsOn"].containerItemEl.addClass("binf-hidden");
            }
        },

        updateBooleanField: function () {
            var length, l;
            if (!!this.form.children) {
                length = this.form.children[0].children.length;
                for (l = 0; l < length; l++) {
                    var inputField = this.form.childrenByPropertyId["actions_Data"].children[l].childrenByPropertyId["valueWebreportParameters"].fieldView.ui.flagWriteField;
                    inputField.on("switchChange.binfSwitch", _.bind(this.enableParameters, this));
                }
            }
        },

        updateAttributeField: function () {
            var length, l;
            if (!!this.form.children) {
                length = this.form.children[0].children.length;
                for (l = 0; l < length; l++) {
                    var inputField = this.form.childrenByPropertyId["actions_Data"].children[l].childrenByPropertyId["valueWorkflowAttributes"].fieldView.ui.flagWriteField;
                    inputField.on("switchChange.binfSwitch", _.bind(this.enableAttribute, this));
                }
            }
        },

        updateAttachmentsField: function () {
            var length, l;
            if (!!this.form.children) {
                length = this.form.children[0].children.length;
                for (l = 0; l < length; l++) {
                    var inputField = this.form.childrenByPropertyId["actions_Data"].children[l].childrenByPropertyId["valueWorkflowAttachments"].fieldView.ui.flagWriteField;
                    inputField.on("switchChange.binfSwitch", _.bind(this.enableAttachments, this));
                }
            }
        },

        updateEscalationModel: function () {
            var client_idValue = this.followupClientField.fieldView.getEditValue().id;
            var type_idValue = this.followuptypefield.fieldView.getEditValue().id;
            if (!!client_idValue && !!type_idValue) {
                this.options.model.escModel.set("client_id", client_idValue);
                this.options.model.escModel.set("id", type_idValue);
                this.followuptypefield.fieldView.setValue(this.followuptypefield.fieldView.getEditValue());
                this.options.model.escModel.fetch().done(_.bind(function (response) {
                    if (response.forms[0].data.escalation_alert) {
                        this.options.model.escModel.set('escalationData',this.EscalationToSelectField.data);
                        this.hideDependentFields(false);
                        this._updateActions();
                    } else if (!response.forms[0].data.escalation_alert) {
                        this.options.model.escModel.set('escalationData',this.EscalationToSelectField.data);
                        this.hideDependentFields(true);
                    }
                }, this));
            }
        },

        onFocusout: function (event) {
            var invalidField = this.$el.find('.cs-formfield.cs-formfield-invalid');
            if (invalidField.length) {
                invalidField.removeClass('cs-formfield-invalid');
            }
        },

        _doEditActions: function () {
            var that = this;
            if (this.form.childrenByPropertyId["actions_Data"].children.length > 0) {
                this.$el.addClass("xecmpf-eac-actions-write");
                this.$el.removeClass("xecmpf-eac-actions-read");
                $(document).on('click.' + this.cid, {view: this}, this._documentClick);
                this.$el.off('tab:content:field:changed');
            } else {
                this.$el.removeClass("xecmpf-eac-actions-write");
                this.$el.addClass("xecmpf-eac-actions-read");
                $(document).off('click.' + this.cid, {view: this}, this._documentClick);
                this.$el.on('tab:content:field:changed', function (event) {
                    if ($(event.target).find(".csui-bulk-edit-cancel").length) {
                        that.updateDependsOnField();
                        that.showErrorMsg(true);
                        that._Validate("actions_Data");
                        that.form.childrenByPropertyId.actions_Data.children.filter(function (e) {
                            if (e.childrenByPropertyId["action"].data === "StartWorkflowEventAction.Start workflow") {
                                that.currentAction = e;
                                if (that.currentAction.childrenByPropertyId["valueWorkflowAttributes"].data === 'true' || that.currentAction.childrenByPropertyId["valueWorkflowAttributes"].data === true) {
                                    for (var i = 0; i < that.currentAction.childrenByPropertyId["valueWorkflowAttribute"].children.length; i++) {
                                        if (that.currentAction.childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["valueWorkflowAttributeValueFrom"].data !== '') {
                                            that.currentAction.childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["actionattrnameWorkflowAttributeValueFrom"].field.removeClass('binf-hidden');
                                            that.currentAction.childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["actionattrnameWorkflowAttributeValueFrom"].containerItemEl.css('display', 'block');
                                            that.currentAction.childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["valueWorkflowAttributeValueFrom"].field.removeClass('binf-hidden');
                                            that.currentAction.childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["valueWorkflowAttributeValueFrom"].containerItemEl.css('display', 'block');
                                            switch (that.currentAction.childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["valueWorkflowAttributeValueFrom"].data) {
                                                case 'csObj':
                                                    that.currentAction.childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["valueWorkflowAttributeCSObject"].field.removeClass('binf-hidden');
                                                    that.currentAction.childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["valueWorkflowAttributeCSObject"].containerItemEl.css('display', 'block');

                                                    break;
                                                case 'evtProp':
                                                    that.currentAction.childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["valueWorkflowAttributeEvtProp"].field.removeClass('binf-hidden');
                                                    that.currentAction.childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["valueWorkflowAttributeEvtProp"].containerItemEl.css('display', 'block');
                                                    break;
                                                case 'UserInput':
                                                    that.enableUserInputField(that.currentAction.childrenByPropertyId["valueWorkflowAttribute"].children[i]);
                                                    break;
                                            }
                                        }
                                    }
                                }
                                that.currentAction.childrenByPropertyId["valueWorkflowAttribute"].children[0].childrenByPropertyId["actionattrnameWorkflowAttributeValueFrom"].field.removeClass('binf-hidden');
                                that.currentAction.childrenByPropertyId["valueWorkflowAttribute"].children[0].childrenByPropertyId["actionattrnameWorkflowAttributeValueFrom"].containerItemEl.css('display', 'block')
                            }
                            if (e.childrenByPropertyId["action"].data === "ReminderEventAction.Add A Reminder") {
                                that.currentAction = e;
                                that.EscalationToField = e.childrenByPropertyId["actionattrnameReminderEscalationTo"];
                                that.EscalationToSelectField = e.childrenByPropertyId["valueReminderEscalationTo"];
                                that.followuptypefield = e.childrenByPropertyId["valueReminder_type" + e.childrenByPropertyId["valueReminder_client"].data];
                                that.followuptypefield.fieldView.collection.add(new Backbone.Model({ 'id': null, 'name': lang.reminderTypePlaceholder }), { at: 0 })
                                if (that.model.escModel.get('escalation' + that.followuptypefield.data)) {
                                    that.options.model.escModel.set('escalationData', that.EscalationToSelectField.data);
                                    that.hideDependentFields(false);
                                }
                                else {
                                    that.options.model.escModel.set('escalationData', that.EscalationToSelectField.data);
                                    that.hideDependentFields(true);
                                }
                            }
                        })
                    }
                });
            }
        },

        _documentClick: function (event) {
            var self = event.data.view,
                element = $(event.target);
            if (!self.$el.find('.xecmpf-eac-actions-container').has(event.target).length && !element.hasClass('csui-perfect-scrolling')) {
                self.$el.removeClass("xecmpf-eac-actions-write");
                self.$el.addClass("xecmpf-eac-actions-read");
            }
        },
        _Validate: function (name) {
            var i, j, k, l, len, setAttributes, attrLen, attrName;
            len = this.form.children[0].children.length;
            for (i = 0; i < len; i++) {
                setAttributes = this.form.childrenByPropertyId[name].children[i].children,
                    attrLen = setAttributes.length;
                for (j = 1; j < attrLen; j++) {
                    if ( (setAttributes[j].name.search('valueWorkflowAttribute') !== -1)) {
                        if(!!setAttributes[j].children && setAttributes[j].children.length >= 1){
                          for(k=0;k<setAttributes[j].children.length;k++){
                            for(l=0 ;l<setAttributes[j].children[k].children.length;l++) {
                              if(setAttributes[j].children[k].children[l].containerItemEl.css('display') === 'none' && setAttributes[j].children[k].children[l].name.search("valueWorkflowAttributeUserInput") !== -1 && setAttributes[j].children[k].children[l].field.hasClass('binf-has-error'))
                              {
                                setAttributes[j].children[k].children[l].field.removeClass('binf-has-error');
                              }
                            }
                          }
                        }
                    
                    }
                    if ( (setAttributes[j].name.search('valueWorkflowAttachmentsValueFrom') !== -1)) {
                      for(k=0;k<setAttributes[j].children.length;k++){
                        
                          if(setAttributes[j].children[k].children[0].field.hasClass('binf-has-error'))
                          {
                            setAttributes[j].children[k].children[0].field.removeClass('binf-has-error');
                          }
                        
                      }
                  
                  
                  }
                    if (!setAttributes[j].isHidden()) {
                        if ((setAttributes[j].name.search('Workflow') !== -1) && ((setAttributes[j].data === '') || (setAttributes[j].data === null) || (setAttributes[j].data && setAttributes[j].data.name === ''))) {
                            setAttributes[j].getFieldEl().addClass('binf-has-error');
                            setAttributes[j].displayMessage(lang.requiredField);
                            attrName = setAttributes[j].name.substr(setAttributes[j].name.search('value'));
                            if (!!this.form.schema.properties.actions_Data.items.properties[attrName]) {
                                this.form.schema.properties.actions_Data.items.properties[attrName].required = true;
                            }
                        }
                        else if ((setAttributes[j].name.search('Webreport') !== -1) && setAttributes[j].children) {
                            var length;
                            length = setAttributes[j].children.length;
                            for (k = 0; k < length; k++) {
                                if (setAttributes[j].children[k].data === "Select value" || (setAttributes[j].children[k].fieldView && setAttributes[j].children[k].fieldView.getEditValue().id === "Select value")) {
                                    setAttributes[j].getFieldEl().addClass('binf-has-error');
                                    setAttributes[j].displayMessage(lang.requiredField);
                                    attrName = setAttributes[j].name.substr(setAttributes[j].name.search('value'));
                                    if (!!this.form.schema.properties.actions_Data.items.properties[attrName]) {
                                        this.form.schema.properties.actions_Data.items.properties[attrName].required = true;
                                    }
                                }
                            }
                        }
                        else if (this.isActionPlanFieldRequired(setAttributes[j].name) &&
                                 ((setAttributes[j].fieldView &&
                                   setAttributes[j].fieldView.getEditValue() &&
                                   setAttributes[j].fieldView.getEditValue().id === null) ||
                                 setAttributes[j].data === '')) {
                            setAttributes[j].getFieldEl().addClass('binf-has-error');
                            setAttributes[j].displayMessage(lang.requiredField);
                            if (!!this.form.schema.properties.actions_Data.items.properties[setAttributes[j].options.fieldClass]) {
                                this.form.schema.properties.actions_Data.items.properties[setAttributes[j].options.fieldClass].required = true;
                            }
                        }
                        else if (setAttributes[j].options.fieldClass) {
                            if (!!this.form.schema.properties.actions_Data.items.properties[setAttributes[j].options.fieldClass]) {
                                this.form.schema.properties.actions_Data.items.properties[setAttributes[j].options.fieldClass].required = false;
                            }
                        }
                    }
                }
            }
            this.updateDependsOnField();
            this.updateBooleanField();
            this.updateAttributeField();
            this.updateAttachmentsField();
        },
        
        /**
         * isActionPlanFieldRequired method is used to check whether a action plan field is mandatory or not
         * @param {*} name name of the action plan field
         * Returns: True/False whether the action plan field required or not
         */
        isActionPlanFieldRequired: function (name){
            var actionPlanFields = ["sourceEffectiveDate", "valuePdContext", "sourceBoKey_CreateDoc", "sourceBoType_CreateDoc", "central_workspace_templateId"];
            return actionPlanFields.every(function (field){
                return name.indexOf(field) === -1;
            });
        },

        _ValidateActions: function (args) {
            this.$el.removeClass("xecmpf-eac-actions-write");
            this.$el.addClass("xecmpf-eac-actions-read");
            var emptyCheck, name;
            emptyCheck = args.targetField.value[0] ? args.targetField.value[0].action :
                args.targetField.value.action,
                name = args.parentField.name;
            if (emptyCheck.length > 0) {
                this._Validate(name);
            }
        },

        _updateActions: function () {
            var Id, k, l, len, setAttributes, attrLen;
            len = this.form.children[0].children.length;
            for (k = 0; k < len; k++) {
                setAttributes = this.form.childrenByPropertyId["actions_Data"].children[k].children,
                    attrLen = setAttributes.length;
                for (l = 1; l < attrLen; l++) {
                    if (!setAttributes[l].isHidden() && setAttributes[l].type === 'select' && setAttributes[l].fieldView) {
                        Id = setAttributes[l].fieldView.getEditValue().id;
                        if (Id === undefined) {
                            setAttributes[l].fieldView.setValue(setAttributes[l].fieldView.collection.findWhere({ 'id': null }));
                        }
                    }
                }
            }
        },

        formTemplateHelpers: function () {
            return {
                actionsLabel: lang.actionsTabLabel
            };
        },
        _getLayout: function () {
            var retVal = FormView.prototype._getLayout.call(this);
            var template = this.getOption('formTemplate'),
                html = template.call(this, {
                    data: this.alpaca.data,
                    mode: this.mode
                }),
                bindings = this._getBindings(),
                view = {
                    parent: 'bootstrap-csui',
                    layout: {
                        template: html,
                        bindings: bindings
                    }
                };
            return view;
        },

        _getBindings: function () {
            return {
                actions_Data: '.xecmpf-eac-actions-container'
            };
        },

        /**
         * Function: getSubmitData
         * Returns: Rules form data if formView is available
         */
        getSubmitData: function () {
            var data = this.getValues().actions_Data;
            return data;
        },
        /**
         * Function: updateFormViewModel
         * Returns: Rules updated reminder type dropdown based on client selection
         */
        updateFormViewModel: function () {
            var cliend_idValue = this.followupClientField.fieldView.getEditValue().id,
                that = this, model;
            this.options.model.formModel.set("client_id", cliend_idValue);
            this.previousValues = this.getValues().actions_Data;
            this.options.model.formModel.fetch().done(function (response) {
                var typeArray = [], i,
                    enumarray = response.forms[0].schema.properties.followup_type_name.enum,
                    labelsarray = response.forms[0].options.fields.followup_type_name.optionLabels;
                if (that.followuptypefield.fieldView.collection.findWhere({ 'id': null })) {
                    typeArray.push(that.followuptypefield.fieldView.collection.findWhere({ 'id': null }));
                }
                that.followuptypefield.fieldView.collection.reset();
                for (i = 0; i < enumarray.length; i++) {
                    typeArray.push(new Backbone.Model({ 'id': enumarray[i], 'name': labelsarray[i] }));
                }
                that.followuptypefield.fieldView.collection.reset(typeArray);
                that.model.attributes.schema.properties.actions_Data.items.properties["valueReminder_type"+that.followupClientField.data].enum = enumarray;
                that.model.attributes.options.fields.actions_Data.fields.item.fields["valueReminder_type"+that.followupClientField.data].optionLabels = labelsarray;
                if (!!that.followuptypefield.fieldView.getValue() && that.followuptypefield.fieldView.getValue().attributes.id) {
                    for (model in typeArray) {
                        if (typeArray[model].get('id') === that.followuptypefield.fieldView.getValue().attributes.id) {
                            that.followuptypefield.fieldView.setValue(typeArray[model]);
                        }
                    }
                } else {
                    that.followuptypefield.fieldView.setValue(typeArray[0]);
                }
                if( !!that.currentAction && (that.currentAction.childrenByPropertyId["valueReminder_typenull"].getFieldEl().hasClass('binf-has-error') || that.currentAction.childrenByPropertyId["valueReminderEscalationTo"].getFieldEl().hasClass('binf-has-error'))){
                  that.currentAction.childrenByPropertyId["valueReminder_typenull"].getFieldEl().removeClass('binf-has-error');
                  that.currentAction.childrenByPropertyId["valueReminderEscalationTo"].getFieldEl().removeClass('binf-has-error');
                }
                that.updateEscalationModel();
            });
        },
        hideDependentFields: function (hide) {
            if (hide) {
                if(!!this.followuptypefield ){
                    this.options.model.escModel.set('escalation' + this.followuptypefield.data, false);
                    this.followuptypefield.isEscalation = false;
                  }
                this.EscalationToField.containerItemEl.addClass("binf-hidden");
                this.EscalationToSelectField.containerItemEl.addClass("binf-hidden");
                this.EscalationToField.field.addClass('binf-hidden');
                this.EscalationToSelectField.field.addClass('binf-hidden');
                this.options.model.attributes.options.fields.actions_Data.fields.item.fields.actionattrnameReminderEscalationTo.hidden = true;
                this.options.model.attributes.options.fields.actions_Data.fields.item.fields.valueReminderEscalationTo.hidden = true;
                switch (this.options.model.escModel.get('escalationData')) {
                    case 'eventProp':
                        this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToEvtProp"].field.addClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToEvtProp"].containerItemEl.addClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["valueReminderEscalationToEvtProp"].containerItemEl.addClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["valueReminderEscalationToEvtProp"].field.addClass("binf-hidden");
                        break;
                    case 'initObj':
                        this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToCategoryAttr"].containerItemEl.addClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["valueReminderEscalationToCategoryAttr"].containerItemEl.addClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToCategoryAttr"].field.addClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["valueReminderEscalationToCategoryAttr"].field.addClass("binf-hidden");
                        break;
                    case 'pWorkspace':
                        this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToPWMetadata"].containerItemEl.addClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["valueReminderEscalationToPWMetadata"].containerItemEl.addClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToPWMetadata"].field.addClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["valueReminderEscalationToPWMetadata"].field.addClass("binf-hidden");
                        if (this.options.model.escModel.get('role')) {
                            this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToPWRole"].containerItemEl.addClass("binf-hidden");
                            this.currentAction.childrenByPropertyId["valueReminderEscalationToPWRole"].containerItemEl.addClass("binf-hidden");
                            this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToPWRole"].field.addClass("binf-hidden");
                            this.currentAction.childrenByPropertyId["valueReminderEscalationToPWRole"].field.addClass("binf-hidden");
                        } else {
                            this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToPWCategoryAttr"].containerItemEl.addClass("binf-hidden");
                            this.currentAction.childrenByPropertyId["valueReminderEscalationToPWCategoryAttr"].containerItemEl.addClass("binf-hidden");
                            this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToPWCategoryAttr"].field.addClass("binf-hidden");
                            this.currentAction.childrenByPropertyId["valueReminderEscalationToPWCategoryAttr"].field.addClass("binf-hidden");
                        }
                        break;
                }
            } else {
                if(!!this.followuptypefield ){
                    this.options.model.escModel.set('escalation' + this.followuptypefield.data, true);
                    this.followuptypefield.isEscalation = true;
                  }
                this.EscalationToField.containerItemEl.removeClass("binf-hidden")
                this.EscalationToSelectField.containerItemEl.removeClass("binf-hidden");
                this.EscalationToField.field.removeClass('binf-hidden');
                this.EscalationToSelectField.field.removeClass('binf-hidden');
                this.EscalationToSelectField.field.parent().find('.binf-help-block-standalone').removeClass('binf-hidden');
                this.options.model.attributes.options.fields.actions_Data.fields.item.fields.actionattrnameReminderEscalationTo.hidden = false;
                this.options.model.attributes.options.fields.actions_Data.fields.item.fields.valueReminderEscalationTo.hidden = false;
                switch (this.options.model.escModel.get('escalationData')) {
                    case 'eventProp':
                        this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToEvtProp"].field.removeClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToEvtProp"].containerItemEl.removeClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["valueReminderEscalationToEvtProp"].containerItemEl.removeClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["valueReminderEscalationToEvtProp"].field.removeClass("binf-hidden");
                        break;
                    case 'initObj':
                        this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToCategoryAttr"].containerItemEl.removeClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["valueReminderEscalationToCategoryAttr"].containerItemEl.removeClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToCategoryAttr"].field.removeClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["valueReminderEscalationToCategoryAttr"].field.removeClass("binf-hidden");
                        break;
                    case 'pWorkspace':
                        this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToPWMetadata"].containerItemEl.removeClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["valueReminderEscalationToPWMetadata"].containerItemEl.removeClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToPWMetadata"].field.removeClass("binf-hidden");
                        this.currentAction.childrenByPropertyId["valueReminderEscalationToPWMetadata"].field.removeClass("binf-hidden");
                        if (this.options.model.escModel.get('role')) {
                            this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToPWRole"].containerItemEl.removeClass("binf-hidden");
                            this.currentAction.childrenByPropertyId["valueReminderEscalationToPWRole"].containerItemEl.removeClass("binf-hidden");
                            this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToPWRole"].field.removeClass("binf-hidden");
                            this.currentAction.childrenByPropertyId["valueReminderEscalationToPWRole"].field.removeClass("binf-hidden");
                        } else {
                            this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToPWCategoryAttr"].containerItemEl.removeClass("binf-hidden");
                            this.currentAction.childrenByPropertyId["valueReminderEscalationToPWCategoryAttr"].containerItemEl.removeClass("binf-hidden");
                            this.currentAction.childrenByPropertyId["actionattrnameReminderEscalationToPWCategoryAttr"].field.removeClass("binf-hidden");
                            this.currentAction.childrenByPropertyId["valueReminderEscalationToPWCategoryAttr"].field.removeClass("binf-hidden");
                        }
                        break;
                }
              
            }
            this.options.model.escModel.set('escalationData','');
        },

        showUserField: function (currentAction, text) {
            currentAction.childrenByPropertyId["actionattrname" + text].containerItemEl.removeClass("binf-hidden");
            currentAction.childrenByPropertyId["actionattrname" + text].field.removeClass("binf-hidden");
            currentAction.childrenByPropertyId["value" + text].containerItemEl.removeClass("binf-hidden");
            currentAction.childrenByPropertyId["value" + text].field.removeClass("binf-hidden");
            currentAction.childrenByPropertyId["value" + text].containerItemEl.css('display', 'block');
            currentAction.childrenByPropertyId["actionattrname" + text].containerItemEl.css('display', 'block');
        },

        _getDetails: function () {
            var i, text,
                that = this,
                typeArray = [],
                length = !!this.model.attributes.data.actions_Data ? this.model.attributes.data.actions_Data.length : 0;
            for (i = 0; i < length; i++) {
                if (this.model.attributes.data.actions_Data[i].action === "ReminderEventAction.Add A Reminder" && !that.options.model.formModel.error) {
                    that.currentAction = that.form.childrenByPropertyId["actions_Data"].children[i];
                    that.followupClientField = that.currentAction.childrenByPropertyId["valueReminder_client"];
                    that.EscalationToField = that.currentAction.childrenByPropertyId["actionattrnameReminderEscalationTo"];
                    that.EscalationToSelectField = that.currentAction.childrenByPropertyId["valueReminderEscalationTo"];
                    var client_Value = !!that.followupClientField.data ? that.followupClientField.data : null;
                    that.followuptypefield = that.currentAction.childrenByPropertyId["valueReminder_type" + client_Value];
                    //Handle the reminder client and type delete scenario
                    if (!that.followuptypefield) {
                        if (!that.model.attributes.schema.properties.actions_Data.items.properties.valueReminder_client.enum.includes(client_Value)) {
                            that.model.attributes.data.actions_Data[i].valueReminder_client = "";
                            if (that.model.attributes.schema.properties.actions_Data.items.properties.valueReminder_client.enum[0] === that.model.attributes.schema.properties.actions_Data.items.properties.valueReminder_client.enum[1]) {
                                that.model.attributes.schema.properties.actions_Data.items.properties.valueReminder_client.enum.shift(0);
                                that.model.attributes.options.fields.actions_Data.fields.item.fields.valueReminder_client.optionLabels.shift(0);
                            }
                            typeArray.push(new Backbone.Model({ 'id': that.model.attributes.schema.properties.actions_Data.items.properties.valueReminder_client.enum[0], 'name': that.model.attributes.options.fields.actions_Data.fields.item.fields.valueReminder_client.optionLabels[0] }));
                            that.followupClientField.fieldView.setValue(typeArray[0]);
                            that.followupClientField.getFieldEl().addClass('binf-has-error');
                            that.followupClientField.displayMessage(lang.requiredField);
                            typeArray.pop();
                        }
                        typeArray.push(new Backbone.Model({ 'id': that.model.attributes.schema.properties.actions_Data.items.properties.valueReminder_typenull.enum[0], 'name': that.model.attributes.options.fields.actions_Data.fields.item.fields.valueReminder_typenull.optionLabels[0] }));
                        that.followuptypefield = that.currentAction.childrenByPropertyId["valueReminder_typenull"];
                        that.followuptypefield.fieldView.setValue(typeArray[0]);
                        that.followuptypefield.getFieldEl().addClass('binf-has-error');
                        that.followuptypefield.displayMessage(lang.requiredField);
                    } else if (!that.followuptypefield.getEnum().includes(that.followuptypefield.data)) {
                        typeArray.push(new Backbone.Model({ 'id': that.model.attributes.schema.properties.actions_Data.items.properties.valueReminder_typenull.enum[0], 'name': that.model.attributes.options.fields.actions_Data.fields.item.fields.valueReminder_typenull.optionLabels[0] }));
                        that.followuptypefield.fieldView.setValue(typeArray[0]);
                        that.followuptypefield.getFieldEl().addClass('binf-has-error');
                        that.followuptypefield.displayMessage(lang.requiredField);
                    }
                    // end
                    if (this.model.attributes.data.actions_Data[i].escalation) {
                        if (!!that.model.attributes.data.actions_Data[i].valueReminderEscalationToPWMetadata && that.model.attributes.data.actions_Data[i].valueReminderEscalationToPWMetadata === 'Role') {
                            that.model.escModel.set('role', true);
                        } else {
                            that.model.escModel.set('role', false);
                        }
                        that.model.escModel.set('escalationData', that.model.attributes.data.actions_Data[i].valueReminderEscalationTo
                        );
                        that.hideDependentFields(false);
                    } else {
                        that.hideDependentFields(true);
                    }
                }
                for (var j = 0; j < this.form.data.actions_Data[i].valueWorkflowAttribute.length; j++) {
                    if (this.form.data.actions_Data[i].valueWorkflowAttribute[j].Attribute) {
                        if (this.form.data.actions_Data[i].valueWorkflowAttribute[j].valueWorkflowAttributeUserInputtext) {
                            text = "WorkflowAttributeUserInputtext";
                            that.showUserField(this.form.childrenByPropertyId.actions_Data.children[i].childrenByPropertyId["valueWorkflowAttribute"].children[j], text);
                        } else if (this.form.data.actions_Data[i].valueWorkflowAttribute[j].valueWorkflowAttributeUserInputinteger) {
                            text = "WorkflowAttributeUserInputinteger";
                            that.showUserField(this.form.childrenByPropertyId.actions_Data.children[i].childrenByPropertyId["valueWorkflowAttribute"].children[j], text);
                        } else if (this.form.data.actions_Data[i].valueWorkflowAttribute[j].valueWorkflowAttributeUserInputdate) {
                            text = "WorkflowAttributeUserInputdate";
                            that.showUserField(this.form.childrenByPropertyId.actions_Data.children[i].childrenByPropertyId["valueWorkflowAttribute"].children[j], text);
                        } else if (this.form.data.actions_Data[i].valueWorkflowAttribute[j].valueWorkflowAttributeUserInputcheckbox) {
                            text = "WorkflowAttributeUserInputcheckbox";
                            that.showUserField(this.form.childrenByPropertyId.actions_Data.children[i].childrenByPropertyId["valueWorkflowAttribute"].children[j], text);
                        } else if (this.form.data.actions_Data[i].valueWorkflowAttribute[j].valueWorkflowAttributeUserInputotcs_user_picker) {
                            text = "WorkflowAttributeUserInputotcs_user_picker";
                            that.showUserField(this.form.childrenByPropertyId.actions_Data.children[i].childrenByPropertyId["valueWorkflowAttribute"].children[j], text);
                        }

                        this.form.childrenByPropertyId.actions_Data.children[i].childrenByPropertyId["valueWorkflowAttribute"].children[j].childrenByPropertyId["valueWorkflowAttributeValueFrom"].containerItemEl.css('display', 'block');
                        this.form.childrenByPropertyId.actions_Data.children[i].childrenByPropertyId["valueWorkflowAttribute"].children[j].childrenByPropertyId["actionattrnameWorkflowAttributeValueFrom"].containerItemEl.css('display', 'block');
                        if (this.form.childrenByPropertyId.actions_Data.children[i].childrenByPropertyId["valueWorkflowAttribute"].children[j].childrenByPropertyId["Attribute"].fieldView.getValue().attributes.name === undefined) {
                            var enumArray = [];
                            enumArray.push(this.form.childrenByPropertyId.actions_Data.children[i].childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["Attribute"].fieldView.collection.findWhere({ 'id': null }));
                            this.form.childrenByPropertyId.actions_Data.children[i].childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["Attribute"].fieldView.setValue(enumArray[0]);
                            this.form.childrenByPropertyId.actions_Data.children[i].childrenByPropertyId["valueWorkflowAttribute"].children[i].childrenByPropertyId["Attribute"].containerItemEl.addClass('cs-worflow-error');
                            this.form.childrenByPropertyId.actions_Data.children[i].childrenByPropertyId["valueWorkflowAttribute"].children[j].childrenByPropertyId["Attribute"].getFieldEl().addClass('binf-has-error');
                            this.form.childrenByPropertyId.actions_Data.children[i].childrenByPropertyId["valueWorkflowAttribute"].children[j].childrenByPropertyId["Attribute"].displayMessage(lang.requiredField);
                        }
                    }
                }
            }
            this.updateDependsOnField();
            this.updateBooleanField();
            this.updateAttributeField();
            this.updateAttachmentsField();
            this.showErrorMsg();
        },
        RemoveParameter: function (fieldParent) {
            if (!!event && !!event.relatedTarget && $(event.relatedTarget).attr('data-alpaca-array-actionbar-action') === 'remove') {
                this.paramParent = fieldParent;
                this.paramField = fieldParent.field;
                this.event = event;
                this.OnChangeParameter();
            }
        }

    });

    return EACActionsView;

});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/eac/impl/actionplan.tab.content/impl/actionplan.empty.view',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"xecmpf-actionplan-empty-content\">\r\n    <div class=\"xecmpf-actionplan-emptyContent-icon\"></div>\r\n    <div class=\"xecmpf-actionplan-emptyContent-msg\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"emptyContentMsg") || (depth0 != null ? lookupProperty(depth0,"emptyContentMsg") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"emptyContentMsg","hash":{},"loc":{"start":{"line":3,"column":59},"end":{"line":3,"column":78}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"emptyContentMsg") || (depth0 != null ? lookupProperty(depth0,"emptyContentMsg") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"emptyContentMsg","hash":{},"loc":{"start":{"line":3,"column":80},"end":{"line":3,"column":99}}}) : helper)))
    + "</div>\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_widgets_eac_impl_actionplan.tab.content_impl_actionplan.empty.view', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/eac/impl/actionplan.tab.content/impl/actionplan.empty.view',[],function(){});
csui.define('xecmpf/widgets/eac/impl/actionplan.tab.content/actionplan.empty.content.view',['csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/marionette',
  'hbs!xecmpf/widgets/eac/impl/actionplan.tab.content/impl/actionplan.empty.view',
  'i18n!xecmpf/widgets/eac/impl/nls/lang',
  'css!xecmpf/widgets/eac/impl/actionplan.tab.content/impl/actionplan.empty.view'
], function (_, $, Marionette, emptyContentTemplate, lang) {


  var EmptyContentView = Marionette.ItemView.extend({

    constructor: function EmptyContentView() {
      Marionette.ItemView.prototype.constructor.apply(this, arguments);
    },

    className: 'xecmpf-actionplan-emptyContent-view',

    template: emptyContentTemplate,

    templateHelpers: function() {
      return {
        emptyContentMsg: lang.configureActionPlanText
      };
    }

  });

  return EmptyContentView;

});

csui.define('xecmpf/widgets/eac/impl/actionplan.tab.content/actionplan.tab.content.view',['csui/lib/underscore', 'csui/lib/jquery',
    'csui/lib/backbone',
    'csui/utils/base', 
    'csui/utils/contexts/factories/connector',
    'csui/controls/tab.panel/tab.panel.view',
    'csui/controls/tab.panel/tab.links.ext.view',
    'csui/controls/tab.panel/tab.links.ext.scroll.mixin',
    'csui/models/form', 
    'csui/controls/form/form.view',
    'csui/controls/globalmessage/globalmessage',
    'csui/widgets/metadata/metadata.properties.view',
    'csui/controls/progressblocker/blocker',
    'csui/controls/tile/behaviors/perfect.scrolling.behavior',
    'xecmpf/widgets/eac/impl/actionplan.processmode/actionplan.processmode.view',
    'xecmpf/widgets/eac/impl/actionplan.processmode/impl/actionplan.processmode.form.model',
    'xecmpf/widgets/eac/impl/actionplan.rules/impl/actionplan.rules.form.model',
    'xecmpf/widgets/eac/impl/actionplan.rules/actionplan.rules.view',
    'xecmpf/widgets/eac/impl/actionplan.actions/actionplan.actions.view',
    'xecmpf/widgets/eac/impl/actionplan.tab.content/actionplan.empty.content.view',
    'i18n!xecmpf/widgets/eac/impl/nls/lang'
], function(_, $, Backbone, base, ConnectorFactory, TabPanelView, TabLinkCollectionViewExt,
    TabLinksScrollMixin, FormModel, FormView, GlobalMessage, MetaDataPropertiesView, BlockingView, PerfectScrollingBehavior, ProcessModeView, ProcessModeFormModel, EACRuleFormModel, RulesView, ActionsView, EmptyContentView, lang) {
    // constants of content view
    var ACTIONPLAN_CONTENT_VIEW_CONST = {
        ERROR_ACTION_PLAN_CREATION: lang.genericWarningMsgOnDeletion
    };
    var ActionPlanContentView = TabPanelView.extend({

        className: (base.isTouchBrowser() ? 'cs-touch-browser ' : '') +
            'cs-metadata-actionplan-content cs-metadata-properties binf-panel binf-panel-default',

        contentView: function(model) {
            var contentView = FormView;
            var panel = _.findWhere(this._propertyPanels, {
                model: model
            });
            if (panel) {
                return panel.contentView || FormView;
            } 
            if (!this.options.isAddActionPlan) {
                switch (model.get('role_name')) {
                    case 'rules':
                        contentView = RulesView;                    
                    break;
                    case 'actions':
                        contentView = ActionsView;
                    break;
                    case 'processMode':
                        contentView = ProcessModeView;
                    break;
                }
            } else {
                this.$el.addClass("eac-newactionplan-content");
                contentView = EmptyContentView;
            }
            return contentView;
        },

        contentViewOptions: function(model) {
            var eventModel = this.options.node;
            var options = {
                    eventModel: eventModel,
                    context: this.options.context
                },
                panel = _.findWhere(this._propertyPanels, {
                    model: model
                });

            switch (model.get('role_name')) {
                case 'rules':
                    var actionPlanRuleModels,
                        actionPlanRulescollection = new Backbone.Collection(),
                        actionPlanRules = [{}];
                    if (!!eventModel && !!eventModel.get('data') && !!eventModel.get('data').ruleConditions && eventModel.get('data').ruleConditions.length > 0) {
                        actionPlanRules = eventModel.get('data').ruleConditions;
                    }
                    actionPlanRuleModels = actionPlanRules.map(function(rule, index) {
                        return new Backbone.Model({
                            sequence: index + 1,
                            operand: rule.operand || '',
                            operator: rule.operation || '',
                            to: rule.value || '',
                            conjunction: rule.logicalConnective || '',
                            categoryDetails: rule.categoryDetails || ''
                        });
                    });
                    actionPlanRulescollection.set(actionPlanRuleModels);
                    this.eacRuleFormModel = new EACRuleFormModel(undefined, {
                        context: this.options.context,
                        eventModel: eventModel,
                        collection: actionPlanRulescollection
                    });
                    _.extend(options, {
                        mode: 'update',
                        model: this.eacRuleFormModel,
                        isNewActionPlan: !eventModel.get('plan_id')
                    }); 
                break;
                case 'actions':
                    _.extend(options, {
                        summary: false
                    });
                break;
                case 'processMode':
                    var processModeModel = new ProcessModeFormModel(undefined, {
                        context: this.options.context,
                        eventModel: eventModel
                    });
                    _.extend(options, {
                        mode: 'create',
                        model: processModeModel
                    });
            }
            if (panel) {
                _.extend(options, panel.contentViewOptions);
            }            
            return options;
        },

        // specific implementation for TabableRegionBehavior
        isTabable: function() {
            if (this.options.notTabableRegion === true) {
                return false;
            }
            return true; // this view can be reached by tab
        },

        constructor: function ActionPlanContentView(options) {
            options || (options = {});

            _.defaults(options, {
                tabType: 'binf-nav-pills',
                mode: 'spy',
                extraScrollTopOffset: 3,
                formMode: 'update',
                toolbar: true,
                contentView: this.getContentView,
                TabLinkCollectionViewClass: TabLinkCollectionViewExt,
                tabContentAccSelectors: 'a[href], area[href], input:not([disabled]),' +
                    ' select:not([disabled]), textarea:not([disabled]),' +
                    ' button:not([disabled]), iframe, object, embed,' +
                    ' *[tabindex], *[cstabindex], *[contenteditable]'
            });

            // Prepare an empty collection to be populated by tabs/forms later
            options.collection = new Backbone.Collection();
            var tabItemsCollection = new Backbone.Collection();
            var tabItems = [{
                role_name: "rules",
                title: lang.rulesTabLabel
            }, {
                role_name: "actions",
                title: lang.actionsTabLabel,
                required: true
            }, {
                role_name: 'processMode',
                title: lang.processModeTabLabel,
                required: true
            }];
            tabItems.forEach(function(tabItem) {
                tabItemsCollection.push(new Backbone.Model(tabItem));
            });
            this.eacEventActionPlans = tabItemsCollection;            

            TabPanelView.prototype.constructor.apply(this, arguments);

            // saving connector from context
            this.connector = this.options.context.getObject(ConnectorFactory);

            if (this.options.blockingParentView) {
                BlockingView.delegate(this, this.options.blockingParentView);
            } else {
              BlockingView.imbue(this);
            }

            this.listenTo(this.eacEventActionPlans, "request", this.blockActions)
                .listenTo(this.eacEventActionPlans, "request", this._checkFormFetching)
                .listenTo(this.eacEventActionPlans, "sync", this._syncForms)
                .listenTo(this.eacEventActionPlans, "sync", this.unblockActions)
                .listenTo(this.eacEventActionPlans, "destroy", this.unblockActions)
                .listenTo(this.eacEventActionPlans, "error", this.unblockActions)
                // If tab panel re-renders itself when the tab collection changes, it
                // has to prevent tab links and tab content from doing the same,
                // because these two views are destroyed during tab panel re-rendering
                .listenTo(this.collection, "reset", this.render);

            this.eacEventActionPlans.trigger('sync');

            // If the collection has been fetched before passing it to the view
            // and the operation is still ongoing, turn on the blocking view right
            // away and wait for the finishing event to turn it off
            if (this.eacEventActionPlans.fetching) {
                this.blockActions();
            }

            $(window).on('resize', _.bind(this._onWindowResize, this));

            // Perform after-rendering steps after blocking view renders inside
            // into this view; it registers for the render event earlier
            this.listenTo(this, 'render', this.onRendered);
        },
        behaviors: {
            PerfectScrolling: {
                behaviorClass: PerfectScrollingBehavior,
                contentParent: '> .binf-tab-content',
                suppressScrollX: true,
                // like bottom padding of container, otherwise scrollbar is shown always
                scrollYMarginOffset: 15
            }
        },
        onBeforeDestroy: function() {
            $(window).off('resize', this._onWindowResize);
        },

        render: function() {            
            TabPanelView.prototype.render.apply(this);
            this._initializeOthers();
            return this;
        },

        onRendered: function() {
            this._setTablinksAttributes();
            // work around for the dialog fade-in delay
            // delay this call a bit since the initial dialog fade in makes the tab to be hidden
            // calling _setTabLinksAttributes() the second time here fixes the dialog fade-in delay
            // but does not have any effect if the first call already works
            setTimeout(_.bind(this._setTablinksAttributes, this), 300);

            // If tab panel re-renders itself when the tab collection changes, it
            // has to prevent tab links and tab content from doing the same,
            // because these two views are destroyed during tab panel re-rendering
            this.tabLinks.stopListening(this.collection, 'reset');
            this.tabContent.stopListening(this.collection, 'reset');
            this.tabLinks.$el.addClass('binf-hidden');
            this.tabContent.$el.addClass('binf-hidden');

            this.blockActions();

            var allFormsRendered = [],
                self = this;
            this.tabContent.children.each(_.bind(function(childView) {
                var formRendered = $.Deferred();
                allFormsRendered.push(formRendered.promise());
                if (childView.content instanceof FormView) {
                    this.listenTo(childView.content, 'render:form', function() {
                        formRendered.resolve();
                    });
                } else {
                    formRendered.resolve();
                }
            }, this));
            $.when.apply($, allFormsRendered).done(function() {
                self.unblockActions();
                self.tabLinks.$el.removeClass('binf-hidden');
                self.tabContent.$el.removeClass('binf-hidden');
                self._initializeOthers();
                self.triggerMethod('render:forms', this);

                // event for keyboard navigation
                var event = $.Event('tab:content:render');
                self.$el.trigger(event);

                self.trigger('update:scrollbar');

            });
        },

        onPanelActivated: function() {
            // delay this a bit since the fade-in may make the tabs to be hidden
            setTimeout(_.bind(function() {
                this._setTablinksAttributes();
                this._enableToolbarState('.tab-links .tab-links-bar > ul li');
            }, this), 300);
        },

        _setTablinksAttributes: function() {
            var i, limit = 5;
            var siblings, parent = this.$el.parent();
            for (i = 0; i < limit; i++) {
                siblings = parent.siblings('.cs-tab-links.binf-dropdown');
                if (siblings.length > 0) {
                    var width = $(siblings[0]).width();
                    if (width > 15) {
                        var newWidth = width - 12,
                            widForEle = newWidth + "px",
                            dirForEle = this.rtlEnabled ? "margin-right" : "margin-left",
                            tabLinksEle = this.$el.find('.tab-links');

                        tabLinksEle.css({
                            "width": function() {
                                return "calc(100% - " + widForEle + ")";
                            }
                        });

                        tabLinksEle.css(dirForEle, widForEle);
                    }
                    break;
                }
                parent = parent.parent();
            }
        },

        _syncForms: function() {
            this._fetchingForms = false;
            var panelModels = this.eacEventActionPlans.where({
                role_name: 'rules'
            });
            panelModels = _.union(panelModels, this.eacEventActionPlans.where({
                role_name: 'actions'
            }));
            panelModels = _.union(panelModels, this.eacEventActionPlans.where({
                role_name: 'processMode'
            }));

            this.panelModelsLength = panelModels.length;
            this._normalizeModels(panelModels);
            // TODO: Warn here, if not all of the pre-fetched forms were
            // handled by extensions or were categories handled here
            this.collection.reset(panelModels);
        },

        _normalizeModels: function(models) {
            _.each(models, function(model) {
                // If the view shows a form and the form has a title, which is
                // not empty, this title should be used for the tab too
                if (model instanceof FormModel) {
                    var schema = model.get('schema');
                    if (schema && schema.title) {
                        model.set('title', schema.title);
                    }
                }
                // Make sure, that the model has always an ID.  The scroll-spy
                // used within the tab control puts these IDs to the a@href on
                // the  tab links.  It could not recognize the particular link
                // to navigate to otherwise.
                if (model.get('id') == null) {
                    model.set('id', model.cid);
                }
                // When models are added to a collection, their model.collection
                // property will not be updated, if it was already set - if they
                // were already added to some other collection earlier.  Here,
                // we're creating a new collection of property panel models, which
                // should own them - they have to be removed from their previous
                // collections, which fetched them.
                if (model.collection) {
                    model.collection.remove(model);
                }
            });
        },

        // private
        _initializeOthers: function() {
            var options = {
                gotoPreviousTooltip: '',
                gotoNextTooltip: ''
            };
            this._initializeToolbars(options);
            this._listenToTabEvent();

            // delay this a bit since the initial dialog fade in makes the tab to be hidden
            setTimeout(_.bind(this._enableToolbarState, this), 300);
        },

        _onWindowResize: function() {
            if (this.resizeTimer) {
                clearTimeout(this.resizeTimer);
            }
            this.resizeTimer = setTimeout(_.bind(function() {
                this._setTablinksAttributes();
                this._enableToolbarState();
            }, this), 200);
        },

        /**
         * Function: saveActionPlanContent
         * Internally calls methods to validate forms and make service call
         */
        saveActionPlanContent: function() {
            if (this.isAllFormsValid()) { // validate forms
               return this.makeActionPlanServiceCall();
            } else {
                return $.Deferred().reject('FORM_NOT_VALID');
            }
        }, 

        /**
         * Function: isAllFormsValid
         * Validates three content views and returns boolean flag. All content views should implement isFormValid method to validate the forms.
         * if content view does not implement isFormValid method, it verifies whether content view is formview and calls its validate method
         * Returns: {formIsValid|boolean} - true when all forms are valid or false
         */
        isAllFormsValid: function() {
            var formIsValid = true;
            this.tabContent.children.forEach(function(childView) {
                var roleName = childView.model.get('role_name');                
                if (childView.content.isFormValid) {
                    if (!childView.content.isFormValid()) {
                        formIsValid = false;
                    }
                } else if (childView.content instanceof FormView) {
                    if (!childView.content.validate() && roleName !== 'actions') {
                        formIsValid = false;
                    }
                } 
            });
            return formIsValid;
        },

        /**
         * Function: getFormsData
         * Prepares formsData from all content views. all content views should implement getSubmitData method to return form data
         * Returns: { formsData | json} - forms data. 
         */
        getFormsData: function() {
            // rules, actions, summary
            var formsData = {};
            this.tabContent.children.forEach(function(childView) {
                var roleName = childView.model.get('role_name');
                // TODO: make change in os to avoid this conversion after complete implementation (savePlan data key should be summary)                
                roleName = roleName === 'processMode'? 'summary' : roleName;   

                if (childView.content.getSubmitData) {
                    formsData[roleName] = childView.content.getSubmitData(); 
                } else if (childView.content instanceof FormView) {
                    formsData[roleName] = childView.content.getValues();
                } 
            });
            return formsData;
        },

        /**
         * Function: getGeneralInformation - prepares general information from the action plan model
         * Returns: { generalInfo | json} - It contains general information
         */
        getGeneralInformation: function() {
            var generalInfo = {};
            var actionPlanModel = this.options.node,
                eventName = !!actionPlanModel.get('event_name') ? actionPlanModel.get('event_name') : 
                            (!!this.options.context.viewStateModel ? this.options.context.viewStateModel.get('back_to_title') : undefined),
                            namespace = !!actionPlanModel.get('namespace')? actionPlanModel.get('namespace') :actionPlanModel.namespace;
            generalInfo['event_def_id'] = !!this.options.node.get('id') ? actionPlanModel.get('parent_id') : actionPlanModel.get('event_def_id');
            generalInfo['event_id'] = actionPlanModel.get('eventType');
            generalInfo['namespace'] = !!actionPlanModel.get('data') ? actionPlanModel.get('data').systemName : namespace;
            generalInfo['event_name'] = !!actionPlanModel.get('data') ? actionPlanModel.get('data').eventName : eventName;
            generalInfo['rule_id'] = !!actionPlanModel.get('data') ? actionPlanModel.get('data').ruleID : actionPlanModel.get('rule_id');
            generalInfo['plan_id'] = actionPlanModel.get('id');
            return generalInfo;
        },              

        /**
         * Function: makeActionPlanServiceCall - Makes service call to update action plan
         *  generate request data and make service call.
         *  On creation/failure of action plan error message is shown on screen
         */
        makeActionPlanServiceCall: function() {
            var i, k, actionModel, actionAttributeCount, actionModelCollection, fromValue, toValue, operatorValue, propType, that = this, action_key, action_source, action_actionattrname,action_value, action_field,
                expValue, alpacaFieldTypeMap,
                actionPlanUrl = this.connector.getConnectionUrl().getApiBase('v2') + '/nodes', 
                actionPlanDetailsUrl = this.connector.getConnectionUrl().getApiBase('v2') + '/eventactioncenter/actionplan',               
                actionPlanRequestData = new FormData(),
                actionPlanDetailsRequestData = new FormData(),
                actionPlanData = new FormData(),
                requestData = this.getFormsData(),
                $deferred = $.Deferred();
            //As the form model is changed , the way the data is stored is also changed, aligning the formaData as the rest call expects     
            if (!!requestData.rules) {
                for (i = 0; i < requestData.rules.length; i++) {
                    fromValue = requestData.rules[i].from;
                    if (!!fromValue) {
                        toValue = requestData.rules[i]["value" + fromValue];
                        propType = !!fromValue && this.eacRuleFormModel.eacPropertiesCollection.findWhere({ name: fromValue }).get('type');
                        if (propType === "Classification") {
                            switch (toValue) {
                                case "Unclassified":
                                    toValue = 0;
                                    break;
                                case "Any":
                                    toValue = 1;
                                    break;
                                case "Custom":
                                    toValue = requestData.rules[i]["to2" + fromValue];
                                    break;
                            }
                        }
                        if (fromValue === "Category Attribute") {
                          propType = this.eacRuleFormModel.categoryResponse.typeName
                          alpacaFieldTypeMap = {
                            'Date': 'date',
                            'Integer': 'integer',
                            'User': 'otcs_user_picker',
                            'StringField': '',
                            'Boolean': 'checkbox'
                          } 
                          expValue = requestData.rules[i][ "to2" + fromValue + alpacaFieldTypeMap[propType] ];    
                          requestData.rules[i].expValue = expValue;
                        }
                        operatorValue = requestData.rules[i]["operator" + fromValue];
                        requestData.rules[i].operator = operatorValue;
                        requestData.rules[i].to = toValue;
                    } else {
                        requestData.rules[i] = {};
                    }
                }
            }
            if (!!requestData.actions) {
                for (i = 0; i < requestData.actions.length; i++) {
                    actionModel = requestData.actions[i];
                    if (requestData.actions[i].valueDependsOn) {
                        requestData.actions[i].valueDependsOn = 1;
                    } else {
                        requestData.actions[i].valueDependsOn = 0;
                    }
                    actionModelCollection =  !!this.options.node.actionAttributeCollection && this.options.node.actionAttributeCollection.findWhere({action_key:actionModel.action});
                    actionAttributeCount = !!actionModelCollection ? actionModelCollection.attributes.actions_attribute_count : 0;
                    for (k = 0; k < actionAttributeCount; k++) {
                        if( actionModel.action === 'ReminderEventAction.Add A Reminder' || actionModel.action === 'DocGenEventAction.Generate Document' || actionModel.action === 'CreateOrUpdateCentralWorkspace.Create Or Update Central Workspace' || actionModel.action === 'StartWorkflowEventAction.Start workflow') {
                            action_key = actionModelCollection.attributes.actions_attributes[k].key
                        }
                        else {
                            action_key = actionModel[actionModel.action + "_fields"]['actionattributes']['key' + k];
                        } 
                        action_source = actionModel["source" + action_key];
                        action_field = actionModel[action_source + '_field' + action_key];
                        if (!!action_key) {
                            action_actionattrname = actionModel["actionattrname" + action_key];
                            if (actionModel.action === 'ReminderEventAction.Add A Reminder' || actionModel.action === 'StartWorkflowEventAction.Start workflow' || actionModel.action === 'StartWebreportEventAction.Start webreport' || actionModel.action === 'CreateOrUpdateCentralWorkspace.Create Or Update Central Workspace') {
                                if( action_key === 'ReminderDueDateCompleteIn' && !!actionModel["value1" + action_key] ) {
                                    var dueDateVal =  actionModel["value1" + action_key].toString(),
                                    dueDateUnit = actionModel["value2" + action_key];
                                    actionModel[actionModel.action + '_fields'][action_key] = {
                                        "actionattrname": action_actionattrname,
                                        "value": dueDateVal.concat(',', dueDateUnit)
                                    }
                                } else if (action_key === 'Reminder_type') {
                                    action_value = actionModel["value" + action_key + actionModel["valueReminder_client"]];
                                    actionModel[actionModel.action + '_fields'][action_key] = {
                                        "actionattrname": action_actionattrname,
                                        "value": action_value
                                    }
                                } else if (action_key === 'WorkflowAttribute') {
                                    action_value = actionModel["value" + action_key];
                                    if (action_value && action_value.length) {
                                        var j;
                                        for (j = 0; j < action_value.length; j++) {
                                            if (action_value[j]["valueWorkflowAttributeValueFrom"] === 'prevAct') {
                                                action_value[j]["valueWorkflowAtrributeFromPreviousAction"] = true;
                                            }
                                            //To remove userinput fields values
                                            if (action_value[j]["valueWorkflowAttributeValueFrom"] === "evtProp" || action_value[j]["valueWorkflowAttributeValueFrom"] === "csObj") {
                                                action_value[j]["valueWorkflowAttributeUserInput"+action_value[j]["Attribute"]] = '';
                                            }
                                        }
                                    }
                                    actionModel[actionModel.action + '_fields'][action_key] = action_value;
                                } else if (action_key === 'WorkflowAttachmentsValueFrom') {
                                    action_value = actionModel["value" + action_key];
                                    if (action_value && action_value.length) {
                                        var n;
                                        for (n = 0; n < action_value.length; n++) {
                                            if (action_value[n]["Attachments"] === 'prevAct') {
                                                action_value[n]["valueWorkflowAttachmentsFromPreviousAction"] = true;
                                            }
                                        }
                                    }
                                    actionModel[actionModel.action + '_fields'][action_key] = action_value;
                                }
                                else {
                                    action_value = actionModel["value" + action_key];
                                    actionModel[actionModel.action + '_fields'][action_key] = {
                                        "actionattrname": action_actionattrname,
                                        "value": action_value
                                    }
                                }
                                if (actionModel[actionModel.action + '_fields'][action_key]) {
                                    actionModel[actionModel.action + '_fields'][action_key][action_source + '_field'] = action_field;
                                }
                            } else if ( actionModel.action === 'DocGenEventAction.Generate Document' ) { 
                                if ( ["PdContext"].indexOf(action_key) !== -1 ) {
                                    action_value = actionModel["value" + action_key];
                                    actionModel[actionModel.action + '_fields'][action_key] = {
                                        "actionattrname": action_actionattrname,
                                        "value": action_value
                                    }
                                } else {
                                    actionModel[actionModel.action + '_fields'][action_key] = {
                                        "actionattrname": action_actionattrname,
                                        "source": action_source
                                    }
                                    actionModel[actionModel.action + '_fields'][action_key][action_source + '_field'] = action_field;
                                }
                            } else {
                                actionModel[actionModel.action + '_fields'][action_key] = {
                                    "actionattrname": action_actionattrname,
                                    "source": action_source
                                }
                                actionModel[actionModel.action + '_fields'][action_key][action_source + '_field'] = action_field;
                            }
                        }
                    }
                }
            }

            actionPlanRequestData.append('name', this.options.node.attributes.name );
            actionPlanRequestData.append('type', 875 );
            actionPlanRequestData.append('parent_id', this.options.node.attributes.event_def_id );

            requestData['gen_information'] = that.getGeneralInformation(); // general information
            requestData.mode = requestData.gen_information.rule_id === '' ? 'Create' : 'Update';
            requestData.actionPlanName = that.options.node.attributes.name;
            requestData.actionPlanId = requestData.gen_information.plan_id;
            requestData.eventDefinitionId = requestData.gen_information.event_def_id               
            actionPlanDetailsRequestData.append('action_plan_items', JSON.stringify(requestData));

            this.blockActions();
            if( requestData.mode === 'Create' ) {
                this.connector.makeAjaxCall({
                    type: "Post",
                    url: actionPlanUrl,
                    data: actionPlanRequestData,
                    processData: false,
                    contentType: false
                 }).then(function (response) {
                    // on action plan creation success
                    if (!!response.results.data) {
                        that.options.node.set('plan_id', response.results.data.properties.id, { silent: true });
                        that.options.node.set('id', response.results.data.properties.id, { silent: true });
                        that.options.node.set('name', response.results.data.properties.name, { silent: true });  
                        requestData.gen_information.plan_id = response.results.data.properties.id;
                        requestData.actionPlanId = requestData.gen_information.plan_id;
                        actionPlanData.append('action_plan_items', JSON.stringify(requestData));                      
    
                        that.connector.makeAjaxCall({
                            type: "PUT",
                            url: actionPlanDetailsUrl,
                            data: actionPlanData,
                            processData: false,
                            contentType: false
                        }).then(function(response) {
                            // on action plan details successfully saved
                            if (response.results.statusCode === 200 && response.results.ok) {
                                GlobalMessage.showMessage('success', response.results.msg);
                                var eventInfo = {
                                    planID: response.results.data.planID,
                                    operation: requestData.gen_information.plan_id !== ''? 'update' : 'create',
                                    event_def_id: requestData.gen_information.event_def_id
                                };
                                that.trigger('refresh:current:action:plan:item', eventInfo); // Only current action plan item should be refreshed
                                $deferred.resolve(); // saved
                            } else {
                                $deferred.reject('FORM_NOT_SAVED'); // not saved
                            }
            
                        }, function(xhr) {
                            // on action plan details save unsuccessful, delete the action plan.
                            that.options.node.destroy();
                            var messageToShow = (xhr.responseJSON && (xhr.responseJSON.errorDetail || xhr.responseJSON.error)) || ACTIONPLAN_CONTENT_VIEW_CONST.ERROR_ACTION_PLAN_CREATION;
                            GlobalMessage.showMessage('error', messageToShow);
                            $deferred.reject('FORM_NOT_SAVED'); // not saved
                        }).always(function() {
                            // works as finally block
                            that.unblockActions();
                        });
    
                    }
                }, function (xhr) {
                    // on action plan creation failure
                    var messageToShow = (xhr.responseJSON && (xhr.responseJSON.errorDetail || xhr.responseJSON.error));
                    that.setErrorMessage(messageToShow, 'create');
                })
            }
            else {
                that.connector.makeAjaxCall({
                    type: "PUT",
                    url: actionPlanDetailsUrl,
                    data: actionPlanDetailsRequestData,
                    processData: false,
                    contentType: false
                }).then(function(response) {
                    // on action plan details successfully saved
                    if (response.results.statusCode === 200 && response.results.ok) {
                        GlobalMessage.showMessage('success', response.results.msg);
                        var eventInfo = {
                            planID: response.results.data.planID,
                            operation: requestData.gen_information.plan_id !== ''? 'update' : 'create',
                            event_def_id: requestData.gen_information.event_def_id
                        };
                        that.trigger('refresh:current:action:plan:item', eventInfo); // Only current action plan item should be refreshed
                        $deferred.resolve(); // saved
                    } else {
                        $deferred.reject('FORM_NOT_SAVED'); // not saved
                    }
    
                }, function(xhr) {
                    // on action plan details save unsuccessful, delete the action plan.
                    var messageToShow = (xhr.responseJSON && (xhr.responseJSON.errorDetail || xhr.responseJSON.error)) || ACTIONPLAN_CONTENT_VIEW_CONST.ERROR_ACTION_PLAN_CREATION;
                    GlobalMessage.showMessage('error', messageToShow);
                    $deferred.reject('FORM_NOT_SAVED'); // not saved
                }).always(function() {
                    // works as finally block
                    that.unblockActions();
                });
            }
                  
            return $deferred.promise();
        }

    });

    _.extend(ActionPlanContentView.prototype, TabLinksScrollMixin);

    return ActionPlanContentView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/eac/impl/actionplan.tab.content/impl/actionplan.tabbed.view',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"xecmpf-eac-actionplan-content\"></div>\r\n<div class=\"xecmpf-eac-actionplan-footer-container\">\r\n    <div class=\"xecmpf-eac-actionplan-footer binf-right\">\r\n        <button title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"save") || (depth0 != null ? lookupProperty(depth0,"save") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"save","hash":{},"loc":{"start":{"line":4,"column":23},"end":{"line":4,"column":31}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"save") || (depth0 != null ? lookupProperty(depth0,"save") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"save","hash":{},"loc":{"start":{"line":4,"column":45},"end":{"line":4,"column":53}}}) : helper)))
    + "\" class=\"binf-btn binf-btn-primary xecmpf-eac-save-actionplan\">\r\n            "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"save") || (depth0 != null ? lookupProperty(depth0,"save") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"save","hash":{},"loc":{"start":{"line":5,"column":12},"end":{"line":5,"column":20}}}) : helper)))
    + "</button>\r\n        <button title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"cancel") || (depth0 != null ? lookupProperty(depth0,"cancel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"cancel","hash":{},"loc":{"start":{"line":6,"column":23},"end":{"line":6,"column":33}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"cancel") || (depth0 != null ? lookupProperty(depth0,"cancel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"cancel","hash":{},"loc":{"start":{"line":6,"column":47},"end":{"line":6,"column":57}}}) : helper)))
    + "\" class=\"cancel-btn binf-btn binf-btn-default xecmpf-eac-cancel-actionplan\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"cancel") || (depth0 != null ? lookupProperty(depth0,"cancel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"cancel","hash":{},"loc":{"start":{"line":6,"column":133},"end":{"line":6,"column":143}}}) : helper)))
    + "</button>\r\n    </div>\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_widgets_eac_impl_actionplan.tab.content_impl_actionplan.tabbed.view', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/eac/impl/actionplan.tab.content/impl/actionplan.tabbed.view',[],function(){});
csui.define('xecmpf/widgets/eac/impl/actionplan.tab.content/actionplan.tabbed.view',['csui/lib/underscore', 'csui/lib/jquery',
    'csui/lib/backbone',
    'csui/lib/marionette',
    'csui/controls/mixins/view.events.propagation/view.events.propagation.mixin',
    'csui/utils/page.leaving.blocker',
    'xecmpf/widgets/eac/impl/actionplan.tab.content/actionplan.tab.content.view',
    'i18n!xecmpf/widgets/eac/impl/nls/lang',
    'hbs!xecmpf/widgets/eac/impl/actionplan.tab.content/impl/actionplan.tabbed.view',
    'css!xecmpf/widgets/eac/impl/actionplan.tab.content/impl/actionplan.tabbed.view'
], function(_, $, Backbone, Marionette, ViewEventsPropagationMixin, PageLeavingBlocker, ActionPlanContentView, lang, template) {

    var ActionPlanTabbedView = Marionette.ItemView.extend({

        className: 'metadata-inner-wrapper xecmpf-eac-actionplan-tabbed-inner-wrapper',

        template: template,

        templateHelpers: function() {
            return {
                // show create label in case of new action plan otherwise show save label
                save: !!(!!this.model.get('data')?this.model.get('data').ruleID:this.model.get('rule_id'))? lang.saveLabel : lang.createLabel,
                cancel: lang.closeLabel
            }
        },

        events: {
            'click .xecmpf-eac-save-actionplan': 'saveEventActionPlan',
            'click .xecmpf-eac-cancel-actionplan': 'cancelEventActionPlan'
        },

        constructor: function ActionPlanTabbedView(options) {
            options || (options = {});
            Marionette.ItemView.prototype.constructor.call(this, options);

            var tabOptions = {
                context: this.options.context,
                node: this.options.model,
                eventname: this.options.eventname,
                namespace: this.options.namespace,
                actionplanSettingsView: this,
                isAddActionPlan: this.options.isAddActionPlan
            }

            this.actionPlanContentView = new ActionPlanContentView(tabOptions);
            this.propagateEventsToViews(this.actionPlanContentView);
        },
        onRender: function() {
            var that = this;
            var childTabView = this.actionPlanContentView.render();
            Marionette.triggerMethodOn(childTabView, 'before:show', childTabView, this);
            this.$el.find('.xecmpf-eac-actionplan-content').append(childTabView.el);
            Marionette.triggerMethodOn(childTabView, 'show', childTabView, this);
            this.listenTo(this.actionPlanContentView, 'refresh:current:action:plan:item', function(data) {
                that.trigger('refresh:current:action:plan:item', data);
            });
            
            /* 
            @desc:_tabbedViewContainsChanges - private variable, tabbedViewContainsChanges - view variable
            setting property tabbedViewContainsChanges to true makes save button enable and to false makes it disable
            created this accessor property to have a single source of truth to disable save button and to show alert while 
            navigation from one action plan to another action plan
            */
           var _tabbedViewContainsChanges = null;
            Object.defineProperty(this, 'tabbedViewContainsChanges', {
                get: function() {
                    return _tabbedViewContainsChanges;
                },
                set: function(containsChanges) {
                    _tabbedViewContainsChanges = containsChanges;
                    that.updateSaveButtonDisableStatus(!containsChanges);
                    that.$el.find('.cs-nodepicker .cs-field-read a').on('click.' + that.cid, function(event){
                        var ele = $(event.currentTarget);
                        event.preventDefault();
                        event.stopPropagation();
                        that.trigger('actionplan:click:link', ele, that);
                    });
                    if (containsChanges && !PageLeavingBlocker.isEnabled()) {
                        PageLeavingBlocker.enable(lang.warningMsgOnActionPlanNavigation);
                    } else if (!containsChanges) {
                        PageLeavingBlocker.disable();
                    }
                }
            });

           
            this.tabbedViewContainsChanges = false;

            if (this.options.isAddActionPlan || this.model.get('create')) {
                this.updateSaveButtonDisableStatus(true);
            }

            // expecting every conent view extends form view directly
            this.actionPlanContentView.tabContent.children.forEach(function (tabContentView) {
                tabContentView.content.$el.on('focusout keydown', function (event) { 
                    if (that.$el.find(".binf-has-error").is(':visible') || that.$el.find(".binf-text-danger").is(':visible') || (event.keyCode === 13 && event.target.value === "")) {
                        that.updateSaveButtonDisableStatus(true);
                    }
                });
                that.listenTo(tabContentView.content, 'change:field', function (eventInfo) {
                    this.model.set('data',this.options.apData);
                    var mode = this.model.get('data') ? this.model.get('data').ruleID : this.model.get('rule_id');
                    if(!mode){
                        that.rulesContainsChanges = true;
                    }
                    if (eventInfo.name === 'rulesSet') {
                        that.dataChange = false;
                        that.rulesHasData = false;
                        that.checkChanges(eventInfo.view.form.children[0].children);
                        if (eventInfo.value.length === 1 && eventInfo.value[0].from === "") {
                            that.rulesContainsChanges = true;
                        }
                        else if ((!mode || eventInfo.value.length !== that.model.get('data').ruleConditions.length ||
                            that.dataChange) && eventInfo.view.isFormValid()) {
                            that.rulesContainsChanges = true;
                            that.rulesHasData = true;
                        }
                        else {
                            that.rulesContainsChanges = false;
                        }
                    }
                    else if (eventInfo.name === 'actions_Data') {
                        that.dataChange = false;
                        that.checkChanges(eventInfo.view.form.children[0].children);
                        if ((!mode || that.dataChange || eventInfo.value.length !== that.model.get('data').actions.length)
                            && !(that.$el.find(".binf-has-error").is(':visible'))) {
                            that.actionsContainsChanges = true;
                        }
                        else {
                            that.actionsContainsChanges = false;
                        }
                    }else if(eventInfo.name === 'run_as' || eventInfo.name === 'process_mode') {
                        that.dataChange = false;
                        that.checkChanges(eventInfo.view.form.children);
                        that.processContainsChanges = that.dataChange;
                    }
                    // some field values changed on child view
                    if (this.model.attributes.planCreated && (that.rulesContainsChanges && that.actionsContainsChanges && that.processContainsChanges)) {
                        that.tabbedViewContainsChanges = true;
                    }
                    else if (!mode && that.rulesContainsChanges && that.actionsContainsChanges && that.processContainsChanges) {
                        that.tabbedViewContainsChanges = true;
                    }
                    else if (mode && (((that.model.get('data').ruleConditions[0] || that.rulesHasData) && (that.rulesContainsChanges || that.actionsContainsChanges || that.processContainsChanges)) || that.actionsContainsChanges || that.processContainsChanges)) {
                        that.tabbedViewContainsChanges = true;
                    }
                    else {
                        that.tabbedViewContainsChanges = false;
                    }
                });
            });

        },

        checkChanges: function (elements) {
            var that = this;
            $.each(elements, function (index, ele) {
                if (!!ele.fieldView) {
                    if ((ele.fieldView.alpacaField.type === 'otcs_node_picker' || ele.fieldView.alpacaField.type === 'otcs_user') && ele.fieldView.getValue()) {
                        that.dataChange = true;
                        return (false);
                    } else if (ele.fieldView.alpacaField.type === 'date' && ele.fieldView.getOldValue() !== ele.fieldView.getEditValue()) {
                        that.dataChange = true;
                        return (false);
                    }
                    else if (!!ele.fieldView.getOldValue() && ele.fieldView.getOldValue().id !== ele.fieldView.getEditValue().id && ele.fieldView.getOldValue().id !== "") {
                        that.dataChange = true;
                        return (false);
                    }
                }
                else if (!!ele.children) {
                    that.checkChanges(ele.children);
                }
            });
        },
        
        /**
         * Function: saveEventActionPlan
         * It calls saveActionPlanContent method in the content view to save data
         */
        saveEventActionPlan: function() {
            var that = this;
            this.actionPlanContentView.saveActionPlanContent().then(function() {
                // saved
                that.tabbedViewContainsChanges = false; 
            }, function(errMsg) {
                // Not saved
            });
        },

        cancelEventActionPlan: function() {
            this.trigger('actionplan:click:back');
        },

        /**
         * Function: updateSaveButtonDisableStatus
         * Description: disable or enable save button based on parameter value
         */
        updateSaveButtonDisableStatus: function(disableIt) {
            var $saveBtn = this.$el.find('.xecmpf-eac-save-actionplan');
            $saveBtn.prop('disabled', disableIt);
        },
        /**
         * disabling pageleaving blocker
         */
        onDestroy: function() {
            if (PageLeavingBlocker.isEnabled()) {
                PageLeavingBlocker.disable();
            }
        }
    });

    _.extend(ActionPlanTabbedView.prototype, ViewEventsPropagationMixin);

    return ActionPlanTabbedView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/eac/impl/actionplan.details/impl/actionplan.details',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class=\"xecmpf-actionplan-header-view\"></div>\r\n<div class=\"xecmpf-actionplan-master-view\">\r\n  <div class=\"xecmpf-actionplan-list-view\"></div>\r\n  <div class=\"xecmpf-actionpan-details-view\"></div>\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_widgets_eac_impl_actionplan.details_impl_actionplan.details', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/eac/impl/actionplan.details/impl/actionplan.details',[],function(){});
csui.define('xecmpf/widgets/eac/impl/actionplan.details/actionplan.details.view',["module",
  "csui/lib/jquery",
  "csui/lib/underscore",
  "csui/lib/backbone",
  "csui/lib/marionette",
  'csui/models/node/node.model',
  'csui/utils/contexts/factories/node',
  'csui/behaviors/default.action/default.action.behavior',
  "csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin",
  'csui/dialogs/modal.alert/modal.alert',
  'csui/utils/url',
  'csui/models/nodechildren',
  'csui/utils/contexts/factories/connector',
  'csui/controls/globalmessage/globalmessage',
  'csui/controls/progressblocker/blocker',
  "xecmpf/widgets/eac/impl/actionplan.list/actionplan.list.view",
  "xecmpf/widgets/eac/impl/actionplan.header/actionplan.header.view",
  "xecmpf/widgets/eac/impl/actionplan.tab.content/actionplan.tabbed.view",
  "hbs!xecmpf/widgets/eac/impl/actionplan.details/impl/actionplan.details",
  "i18n!xecmpf/widgets/eac/impl/nls/lang",
  "css!xecmpf/widgets/eac/impl/actionplan.details/impl/actionplan.details"
], function (module, $, _, Backbone, Marionette, NodeModel, NodeModelFactory, DefaultActionBehavior, LayoutViewEventsPropagationMixin, ModalAlert, Url, NodeChildrenCollection, ConnectorFactory, GlobalMessage, BlockingView, 
    ActionPlanListView, ActionPlanHeaderView, ActionPlanTabbedView, template, lang) {
  'use strict';

  var ActionPlanDetailsView = Marionette.LayoutView.extend({

    className: 'xecmpf-actionplan-details',
    template: template,

    regions: {
      headerRegion: '.xecmpf-actionplan-header-view',
      actionPlanListRegion: '.xecmpf-actionplan-list-view',
      actionPlanDetailsRegion: '.xecmpf-actionpan-details-view'
    },
    behaviors: {
      DefaultAction: {
        behaviorClass: DefaultActionBehavior
      }
    },
    initialize: function (options) {
      this.options.connector = this.options.context.getModel(ConnectorFactory);
      this.options.model = this.options.context.model ?
        this.options.context.model : options.context.getModel(NodeModelFactory);
      var that = this;
      that.children = new NodeChildrenCollection(undefined, {
        node: that.options.model,
        commands: 'rename,delete,addToWarehouse',
      });
      that.children.fetch().done(function () {
        that.setHeaderView();
        that.setActionPlanListView();
        that.onShow();
      });
    },

    constructor: function ActionPlanDetailsView(options) {
      options || (options = {});
      Marionette.LayoutView.prototype.constructor.call(this, options);
      this.propagateEventsToRegions(); // propagate dom:refresh to child views
    },
    onShow: function () {
      if (this.children.fetched) {
        var that = this;

        this.listenTo(this.actionPlanListView, 'actionplan:click:item', function (eventSrc) {
          // checks for any form changes before navigating
          this.isContentViewCanbeUpdated(eventSrc.model).then(function () {
            that.updateContentView(eventSrc);
          });
        });

        this.listenTo(this.actionPlanListView, 'click:add:actionplan', function (eventSrc) {
          // checks for any form changes before navigating
          this.isContentViewCanbeUpdated(eventSrc.model).then(function () {
            that.updateContentView(eventSrc, true);
          });
        });

        this.listenTo(this.actionPlanListView, 'actionplan:add:item', function (eventSrc) {
          // checks for any form changes before adding any new item
          this.isContentViewCanbeUpdated().then(function () {
            // to avoid multiple confirmations on addition of action plan
            if (!!that.actionplanTabbedView) { that.actionplanTabbedView.destroy(); }
            that.actionPlanListView.addNewActionPlan(); // adds new action plan
          });
        });

        this.listenTo(this.actionPlanListView, 'actionplan:click:delete', function (eventSrc) {
          this.deleteActionPlan(eventSrc);
        });

        this.listenTo(this.actionPlanListView, 'actionplan:click:rename', function (eventSrc) {

        });

        this.listenTo(this.actionPlanListView, 'actionplan:click:renamecancel', function (eventSrc) {
          this.deleteActionPlan(eventSrc);
        });
        this.listenTo(this.actionPlanListView, 'keydown:action:rename', function (eventSrc) {
          that.updateContentView(this.actionPlanListView);
        });

        this.actionPlanListRegion.on('show', _.bind(this.onActionPlanListShown, this));

        this.headerRegion.show(this.headerView);
        this.actionPlanListRegion.show(this.actionPlanListView);
      }
    },

    /**
     * Function: isContentViewCanbeUpdated, asks for user confirmation if there are any changes before navigation
     * Parameters: { nextModel - optional }
     * Returns: boolean flag to indicate whether content view can be updated with new action plan
     */
    isContentViewCanbeUpdated: function( nextModel ) {
      var $deferred = $.Deferred(),
        currentModel = null,
        isPlanId = nextModel ? nextModel.get("plan_id") !== "": true;
      if (this.actionplanTabbedView && !this.actionplanTabbedView.isDestroyed) {
        // if user clicks on the currently active link again
        this.currentModel = this.actionplanTabbedView.options.model;
        this.hasNewActionPlanModel = this.currentModel.get('plan_id') === '';
        if (currentModel === nextModel) {
          $deferred.reject();
        } else if ((this.actionplanTabbedView.tabbedViewContainsChanges || this.hasNewActionPlanModel) && isPlanId) {
          // asks for user confirmation
          ModalAlert.confirmQuestion( lang.warningMsgOnActionPlanNavigation, 
            lang.actionPlanNavigationDialogTitle, { buttons: ModalAlert.OkCancel })
            .done(_.bind(function () {
              if (this.currentModel.attributes.plan_id && !this.currentModel.attributes.rule_id) {
                var that = this,
                actionPlanUrl = this.options.connector.getConnectionUrl().getApiBase('v2') + '/nodes/' + this.currentModel.attributes.plan_id;
                this.options.connector.makeAjaxCall({
                  type: "Delete",
                  url: actionPlanUrl,
                  processData: false,
                  contentType: false
                }).then(function (response) {
                  that.actionPlanListView.actionPlanListItemCollectionView.collection.remove(that.currentModel);
                  $deferred.resolve();
                }, function (xhr) {
                  $deferred.reject();
                })
              }
              else {
                if(this.currentModel.attributes.plan_id === ''){
                this.actionPlanListView.actionPlanListItemCollectionView.collection.remove(this.currentModel);
                }
                $deferred.resolve();
              }

            }, this))
          .fail(function() {
            $deferred.reject();
          });
        } else {
          $deferred.resolve();  
        }
      } else {
        $deferred.resolve();
      }
      return $deferred.promise();
    },

    /**
     * Function: updateContentView
     * Updates content view with selected action plan details, after updating tab content it adds active class to selected action plan item
     */
    updateContentView: function(eventSrc, isAddActionPlan) {
      // removes active class on all list items and add active class for current element
      if (!this.actionPlanListView.$el.find('.binf-active').hasClass("xecmpf-new-eac-action-plan-list-item")) {
        this.actionPlanListView.$el.find('.binf-active').removeClass('binf-active');
        var actionPlanActive = this.actionPlanListView.actionPlanListItemCollectionView.children.findByModel(eventSrc.model);
        actionPlanActive.$el.addClass('binf-active');
      }
      this.setActionPlanTabbedView(eventSrc.model, isAddActionPlan);
      if (!eventSrc.model.attributes.plan_id) {
        eventSrc.model.set('create', true);
      }
      else {
        eventSrc.model.set('create', false);
        eventSrc.model.set('hideCheckBox', false);
        eventSrc.model.trigger('show:inline:action:bar');
      }
    },

    setHeaderView: function () {
      this.headerView = new ActionPlanHeaderView(this.options);
      this.listenTo(this.headerView, "actionplan:click:back", function () {
        // checks for any form changes before navigating back to new screen
        this.isContentViewCanbeUpdated().then((function() {
          history.back();
        }).bind(this));
      });
    },
    setActionPlanListView: function () {
      this.options.connector = this.options.context.getObject(ConnectorFactory);
      var that = this;
      var item = that.children.models.filter(function (Item) {
        return Item.attributes.type !== 144;
      });
      that.children.models = item;
      that.children.totalCount = item.length;
      that.children.length = item.length;
      that.options.model.collection = that.children;
      that.actionPlanListView = new ActionPlanListView({
        showAddActionPlan: true,
        context: that.options.context,
        model: that.options.model,
        originatingView: that,
        connector: that.options.connector,
        isAddActionPlan: that.options.isAddActionPlan
      }
      );
    },
    setActionPlanTabbedView: function (model, isAddActionPlan) { 
      var that = this,
        emptymodel = this.actionPlanListView.actionPlanListItemCollectionView.collection.findWhere({ 'isAddActionPlan': true });
      if (isAddActionPlan && !model.get('id')) {
        model.set('isAddActionPlan', isAddActionPlan);
      }
      if (this.actionplanTabbedView && !emptymodel) {
        this.actionplanTabbedView.destroy();
      }
      if (!model.get('isAddActionPlan') && !model.get('planCreated') && !emptymodel) {
        var ajaxOptions = {
          type: 'GET',
          url: this.options.connector.getConnectionUrl().getApiBase('v2') + '/eventactioncenter/actionplandetails?action_plan_id=' + model.get('id')
        };
        this.options.connector.makeAjaxCall(ajaxOptions)
          .done(function (response, statusText, jqxhr) {
            if (response) {
              if (response.results.data) {
                model.set('data', response.results.data);
                model.set('event_def_id', model.get('parent_id'));
                model.set('eventType', response.results.data.eventType);
                that.actionplanTabbedView = new ActionPlanTabbedView({
                  context: that.options.context,
                  model: model,
                  eventname: that.options.eventname,
                  apData: response.results.data,
                  namespace: that.options.namespace,
                  originatingView: that.options.originatingView,
                  isAddActionPlan: model.get('isAddActionPlan')
                });
                that.actionPlanDetailsRegion.show(that.actionplanTabbedView);
                that.listenTo(that.actionplanTabbedView, "actionplan:click:back", function () {
                  that.isContentViewCanbeUpdated().then((function () {
                    history.back();
                  }).bind(this));
                });
                that.listenTo(that.actionplanTabbedView, 'actionplan:click:link', function (ele, self) {
                  // checks for any form changes before navigating
                  that.isContentViewCanbeUpdated().then(function () {
                    ele.off('click.' + self.cid);
                    ele.trigger('click');
                  });
                });
                that.listenTo(that.actionplanTabbedView, "refresh:current:action:plan:item", function (data) {
                  that.actionPlanListView.refreshCurrentActionPlanItem(data).then(function (actionPlanListItem) {
                    that.updateContentView(actionPlanListItem);
                  });
                });
              }
            }
          })
          .fail(function (jqXHR, statusText, error) {

            // show failure message
          });
      }
      else {
        model.set('event_def_id', this.options.model.attributes.id);
        that.actionplanTabbedView = new ActionPlanTabbedView({
          context: that.options.context,
          model: model,
          eventname: that.options.eventname,
          namespace: that.options.namespace,
          originatingView: that.options.originatingView,
          isAddActionPlan: model.get('isAddActionPlan')
        });
        that.actionPlanDetailsRegion.show(that.actionplanTabbedView);
        that.listenTo(that.actionplanTabbedView, "actionplan:click:back", function () {
          that.isContentViewCanbeUpdated().then((function () {
            history.back();
          }).bind(this));
        });
        that.listenTo(that.actionplanTabbedView, 'actionplan:click:link', function (ele, self) {
          // checks for any form changes before navigating
          that.isContentViewCanbeUpdated().then(function () {
            ele.off('click.' + self.cid);
            ele.trigger('click');
          });
        });
        that.listenTo(that.actionplanTabbedView, "refresh:current:action:plan:item", function (data) {
          that.actionPlanListView.refreshCurrentActionPlanItem(data).then(function (actionPlanListItem) {
            that.updateContentView(actionPlanListItem);
          });
        });
      }
    },
    /**
     * Function: onActionPlanListShown
     * Parameter: actionPlanListView  - ActionPlanListView
     * trigger click event on first action plan list item 
     */
    onActionPlanListShown: function(actionPlanListView) {      
      var firstActionPlan = actionPlanListView.actionPlanListRegion.currentView.children.findByIndex(0),
      emptymodel =  actionPlanListView.actionPlanListItemCollectionView.collection.findWhere({'plan_id':''});
      if (firstActionPlan && !emptymodel) {
        if (this.options.model.get('isAddActionPlan')) {
          firstActionPlan.trigger('click:actionplan');
        } else {
          firstActionPlan.trigger('click:actionplan:item');
        }
      }  
      this.actionPlanListView.$el.find('.xecmpf-eac-action-plan-list-item-input').trigger('focus'); 
    },
    
   /**
    * This method is used to delete the Action Plan.
    * Function: deleteActionPlan
    * Parameter: eventSrc  - ActionPlanListItemView
    * 
    */
    deleteActionPlan: function(eventSrc) {
      this.updateActionPlanSelection(eventSrc);
    },

   /*
    * Function: updateActionPlanSelection
    * Parameter: actionPlan  - ActionPlanListItemView
    * trigger click event on next action plan list item 
    * To select the next/previous Action Plan when the Action Plan is deleted
    * 
    */
    updateActionPlanSelection: function(actionPlan) {
      var actionPlanCollectionView = this.actionPlanListView.actionPlanListItemCollectionView;
      var actionPlanListChildren = actionPlanCollectionView.children;
      var index = actionPlan._index;
      var nextView = actionPlanListChildren.findByIndex(index + 1);
      var prevView = actionPlanListChildren.findByIndex(index - 1);
      var nextActiveView = nextView ? nextView : (prevView ? prevView : undefined);
      var isActive = actionPlan.$el.hasClass('binf-active');
      if (nextActiveView && actionPlan._hasFocus) {
        actionPlanCollectionView._changeTabIndexesAndSetFocus(actionPlan, nextActiveView, false);
      }
      this.actionPlanListView.actionPlanListItemCollectionView.collection.remove(actionPlan.model);
      if (isActive === true) {
        this.actionplanTabbedView.destroy(); // destroying tab view as corresponding model is already destroyed
        if (nextActiveView) {
          nextActiveView.trigger('click:actionplan:item');
        }
      }
    }
  });

  _.extend(ActionPlanDetailsView.prototype, LayoutViewEventsPropagationMixin);

  return ActionPlanDetailsView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/table/cells/impl/actionplan',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "    <a href=\"\" class = \"action-plan-edit\"> "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"count") || (depth0 != null ? lookupProperty(depth0,"count") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"count","hash":{},"loc":{"start":{"line":3,"column":43},"end":{"line":3,"column":52}}}) : helper)))
    + " "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"actionPlan") || (depth0 != null ? lookupProperty(depth0,"actionPlan") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"actionPlan","hash":{},"loc":{"start":{"line":3,"column":53},"end":{"line":3,"column":67}}}) : helper)))
    + "</a>\r\n";
},"3":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "    <button class=\"action-plan-add\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"addActionPlan") || (depth0 != null ? lookupProperty(depth0,"addActionPlan") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"addActionPlan","hash":{},"loc":{"start":{"line":5,"column":36},"end":{"line":5,"column":53}}}) : helper)))
    + "</button>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div>\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"count") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"loc":{"start":{"line":2,"column":2},"end":{"line":6,"column":9}}})) != null ? stack1 : "")
    + "</div>";
}});
Handlebars.registerPartial('xecmpf_controls_table_cells_impl_actionplan', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/controls/table/cells/impl/actionplan',[],function(){});
csui.define('xecmpf/controls/table/cells/eac.actionplan.view',['csui/lib/jquery', 'csui/lib/underscore', 'csui/lib/backbone', 'csui/lib/marionette',
  'csui/controls/table/cells/templated/templated.view',
  'csui/controls/table/cells/cell.registry', 'csui/utils/contexts/factories/node',
  'csui/controls/dialog/dialog.view',
  'xecmpf/models/eac/eventactionplans.model',
  'xecmpf/widgets/eac/impl/actionplan.details/actionplan.details.view',
  'hbs!xecmpf/controls/table/cells/impl/actionplan',
  'i18n!xecmpf/widgets/eac/impl/nls/lang',
  'css!xecmpf/controls/table/cells/impl/actionplan'
], function ($, _, Backbone, Marionette, TemplatedCellView, cellViewRegistry, NodeFactory,
    DialogView, EACEventActionPlans, ActionPlanDetailsView, template, lang) {

  var ActionPlanCellView = TemplatedCellView.extend({

        template: template,
        className: 'csui-nowrap',

        triggers: {
          'click .action-plan-add': 'click:ActionPlanAdd'
        },

        events: {
          'click .action-plan-edit': 'editActionPlan'
        },

        getValueData: function () {
          var node  = this.model,
              count = node.get('action_plans').length;
          return {
            count: count,
            actionPlan: lang.actionPlan,
            addActionPlan: lang.addActionPlan
          };
        },

        onClickActionPlanAdd: function () {
          // passing a flag for showing empty view until action plan name is entered
          this.showActionPlanDetailsView(true);
        },

        //edit action plan
        editActionPlan: function (event) {
          event.preventDefault();
          event.stopPropagation();
          this.showActionPlanDetailsView();
        },

        /**
         * Function: showActionPlanDetailsView
         * Opens new EAC screen to show action plans
         */
        showActionPlanDetailsView: function (isAddActionPlan) {
          // replace the originatingView with sliding left/right animation
          var actionPlanDetailsView = new ActionPlanDetailsView({
                context: this.options.context,
                model: this.options.model,
                isAddActionPlan: isAddActionPlan
              }),
              tableView             = this.options.tableView,
              originatingView       = tableView.options.originatingView,
              $originatingView      = tableView.options.originatingView.$el,
              actionPlanWrapper;

          $originatingView.parent().append(
              "<div class='xecmpf-actionplan-details-wrapper'></div>");
          actionPlanWrapper = $(
              $originatingView.parent().find('.xecmpf-actionplan-details-wrapper')[0]);
          actionPlanWrapper.hide();

          actionPlanDetailsView.render();
          Marionette.triggerMethodOn(actionPlanDetailsView, 'before:show');
          actionPlanWrapper.append(actionPlanDetailsView.el);
          originatingView.actionPlanDetailsView = actionPlanDetailsView;

          $originatingView.hide('blind', {
            direction: 'left',
            complete: function () {
              actionPlanWrapper.show('blind',
                  {
                    direction: 'right',
                    complete: function () {
                      Marionette.triggerMethodOn(actionPlanDetailsView, 'show');
                    }
                  }, 100);
            }
          }, 100);

          var _showOriginatingView = function () {
            var that = this;
            actionPlanWrapper.hide('blind', {
              direction: 'right',
              complete: function () {
                originatingView.$el.show('blind', {
                  direction: 'left',
                  complete: function () {
                    originatingView.actionPlanDetailsView &&
                    originatingView.actionPlanDetailsView.destroy();
                    originatingView.blockActions();
                    that.options.tableView.collection.fetch({reload: true})
                        .fail(function () {
                          //handle the fail condition
                        })
                        .always(function () {
                          originatingView.triggerMethod('dom:refresh');
                          originatingView.unblockActions();
                        });
                  }
                }, 100);
                actionPlanDetailsView.destroy();
                actionPlanWrapper.remove();
              }
            }, 100);
          };
          this.listenTo(actionPlanDetailsView, "actionplan:close",
              _.bind(_showOriginatingView, this));
        }

      },
      {
        hasFixedWidth: true,
        columnClassName: 'xecmpf-table-cell-action-plan'
      });

  cellViewRegistry.registerByColumnKey('action_plan', ActionPlanCellView);

  return ActionPlanCellView;
});

csui.define('xecmpf/controls/table/cells/location.cell.view',[
	'csui/controls/table/cells/cell.registry',
	'csui/controls/table/cells/parent/parent.view',
], function (cellViewRegistry, ParentCellView) {
	'use strict';
	var locationCellView = ParentCellView.extend({
		constructor: function locationCellView(options) {

			if (options.model.get('location_id') !== 0) {
				var locationPath = options.model.get('location_id_expand');
				options.model.set('parent_id_expand', locationPath, { silent: true });
			}
			locationCellView.__super__.constructor.apply(this, arguments);
		},

		onRender: function () {
			if (this.model.get('location_id') === 0) {
				this.parentIconView.remove();
			}
		}
	});

	cellViewRegistry.registerByColumnKey('location_name', locationCellView);

	return locationCellView;
});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/table/cells/impl/statusicon',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"fileupload-status-column\">\r\n    <span class=\"csui-icon fileuplaod-cell-statusicon "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"statusIcon") || (depth0 != null ? lookupProperty(depth0,"statusIcon") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"statusIcon","hash":{},"loc":{"start":{"line":3,"column":54},"end":{"line":3,"column":68}}}) : helper)))
    + "\"></span>\r\n    <span class=\"csui-icon fileuplaod-cell-statustext "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"statusLabel") || (depth0 != null ? lookupProperty(depth0,"statusLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"statusLabel","hash":{},"loc":{"start":{"line":4,"column":54},"end":{"line":4,"column":69}}}) : helper)))
    + "\"> "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"statusLabel") || (depth0 != null ? lookupProperty(depth0,"statusLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"statusLabel","hash":{},"loc":{"start":{"line":4,"column":72},"end":{"line":4,"column":87}}}) : helper)))
    + "</span>\r\n</div>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"statusIcon") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"loc":{"start":{"line":1,"column":0},"end":{"line":6,"column":7}}})) != null ? stack1 : "");
}});
Handlebars.registerPartial('xecmpf_controls_table_cells_impl_statusicon', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/controls/table/cells/impl/statusicon',[],function(){});
csui.define('xecmpf/controls/table/cells/statusicon.view',[
  'csui/lib/underscore', 'csui/controls/table/cells/templated/templated.view',
  'csui/controls/table/cells/cell.registry',
  'hbs!xecmpf/controls/table/cells/impl/statusicon',
  'css!xecmpf/controls/table/cells/impl/statusicon'
], function (_, TemplatedCellView,
  cellViewRegistry, template) {
  'use strict';

  var TypeIconCellView = TemplatedCellView.extend({

    template: template,

    getValueData: function () {
      var statusIcon = this.model.get("icon"),
        statusLabel = this.model.get("label");
      return { 'statusLabel': statusLabel, 'statusIcon': statusIcon };
    }
  });

  cellViewRegistry.registerByColumnKey('label', TypeIconCellView);

  return TypeIconCellView;
});

// this file is copied from //products/main/pkg/CS_CORE_UI/src/controls/dialog/impl/footer.view.js
// We use it unchanged. Please do not change it, as we want to use it from csui, when they have
// moved it from the impl directory to a public location.
csui.define('xecmpf/controls/bosearch/searchform/impl/footer.view',['csui/lib/marionette',
  'csui/behaviors/keyboard.navigation/tabable.region.behavior'
], function ( Marionette, TabableRegion) {

  var ButtonView = Marionette.ItemView.extend({

    tagName: 'button',

    className: 'binf-btn',

    template: false,

    triggers: {
      'click': 'click'
    },

    behaviors: {
      TabableRegion: {
        behaviorClass: TabableRegion
      }
    },

    constructor: function ButtonView(options) {
      Marionette.View.prototype.constructor.apply(this, arguments);
    },

    isTabable: function () {
      return this.$el.is(':not(:disabled)') && this.$el.is(':not(:hidden)');
    },
    currentlyFocusedElement: function () {
      if (this.$el.prop('tabindex') === -1){
        this.$el.prop('tabindex', 0);
      }
      return this.$el;
    },
    onRender: function () {
      var button = this.$el,
          attributes = this.model.attributes;
      button.text(attributes.label);
      button.addClass(attributes['default'] ? 'binf-btn-primary' : 'binf-btn-default');
      if (attributes.toolTip) {
        button.attr('title', attributes.toolTip);
      }
      if (attributes.separate) {
        button.addClass('cs-separate');
      }
      this.updateButton(attributes);
    },

    updateButton: function (attributes) {


      var $button = this.$el;


      attributes || (attributes = {});
      if (attributes.hidden !== undefined) {
        if (attributes.hidden) {
          $button.addClass('binf-hidden');
        } else {
          $button.removeClass('binf-hidden');
        }
      }
      if (attributes.disabled !== undefined) {
        $button.prop('disabled', attributes.disabled);
      }
    }

  });

  var DialogFooterView = Marionette.CollectionView.extend({

    childView: ButtonView,

    constructor: function DialogFooterView(options) {
      Marionette.CollectionView.prototype.constructor.apply(this, arguments);
    },
    onDomRefresh: function(){
      this.children.each(function(buttonView){
        buttonView.trigger('dom:refresh');
      });
    },

    getButtons: function() {
      return this.children.toArray();
    },

    updateButton: function (id, attributes) {
      var button = this.collection.get(id);
      if (button) {
        this.children
            .findByModel(button)
            .updateButton(attributes);
      } else {
        // If the footer comes from the dialog template including the buttons,
        // the collection of dynamically created buttons is empty.
        // The template has to provide correct initial classes for the buttons
        // and their identifiers must be present in the "data-cs-id" attribute.
        ButtonView.updateButton(this.$('[data-cs-id="' + id + '"]'), attributes);
      }
    }

  });

  return DialogFooterView;
});

csui.define('xecmpf/controls/bosearch/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});

csui.define('xecmpf/controls/bosearch/impl/nls/root/lang',{
  boSearchFormTitle: 'Search {0}',
  boSearchFormButtonSearch: 'Search',
  boSearchFormButtonCancel: 'Cancel',
  boResultListButtonAttach: 'Attach',
  noBusinessObjectsFound: 'No business objects found.',
  resultListBannerMessage: 'Search for {0}',
  resultListRefineMessage: "More results are available but result limit has been reached. Refine your search.",
  zeroSearchFields: 'No search fields configured in the business application',
  labelBusinessObjectId: 'ID',
  ERR_COLUMNS_CHANGED: 'Configuration has changed during your search. Close the search and start a new one.',
  errorGettingSearchForm: 'Error getting form for business object search.',
  errorSearchingBusinessObjects: 'Error searching for business objects.'
});



/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/bosearch/searchform/impl/bosearchform',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"conws-bosearchform-body csui-content-without-footer\">\r\n  <div class=\"conws-bosearchheader\">\r\n    <div class=\"conws-bosearchheader-title\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"search_form_title") || (depth0 != null ? lookupProperty(depth0,"search_form_title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"search_form_title","hash":{},"loc":{"start":{"line":3,"column":51},"end":{"line":3,"column":72}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"search_form_title") || (depth0 != null ? lookupProperty(depth0,"search_form_title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"search_form_title","hash":{},"loc":{"start":{"line":3,"column":74},"end":{"line":3,"column":95}}}) : helper)))
    + "</div>\r\n    <div class=\"conws-spacer\"></div>\r\n  </div>\r\n  <div class=\"conws-bosearchfields csui-normal-scrolling  csui-no-scroll-x\">\r\n  </div>\r\n  <div style=\"display:none;\" class=\"conws-bosearchfields-zero\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"zero_fields_title") || (depth0 != null ? lookupProperty(depth0,"zero_fields_title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"zero_fields_title","hash":{},"loc":{"start":{"line":8,"column":70},"end":{"line":8,"column":91}}}) : helper)))
    + "\">\r\n      \""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"zero_fields_title") || (depth0 != null ? lookupProperty(depth0,"zero_fields_title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"zero_fields_title","hash":{},"loc":{"start":{"line":9,"column":7},"end":{"line":9,"column":28}}}) : helper)))
    + "\"\r\n  </div>\r\n</div>\r\n<div class=\"conws-bosearchform-footer binf-modal-footer\">\r\n</div>\r\n<div class=\"conws-right-shadow\"></div>\r\n";
}});
Handlebars.registerPartial('xecmpf_controls_bosearch_searchform_impl_bosearchform', t);
return t;
});
/* END_TEMPLATE */
;
/**
 * Created by stefang on 05.04.2016.
 */
csui.define('xecmpf/controls/bosearch/searchform/bosearchform.view',['require',
  'csui/lib/jquery',
  'csui/lib/underscore',
  'csui/lib/backbone',
  'csui/lib/marionette',
  'csui/utils/base',
  'csui/utils/log',
  'csui/controls/form/form.view',
  'csui/utils/contexts/factories/connector',
  'csui/dialogs/modal.alert/modal.alert',
  'xecmpf/controls/bosearch/searchform/impl/footer.view',
  'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',
  'csui/behaviors/keyboard.navigation/tabable.region.behavior',
  'csui/controls/tab.panel/behaviors/tab.contents.keyboard.behavior',
  'xecmpf/controls/bosearch/searchform/bosearchform.model',
  'i18n!xecmpf/controls/bosearch/impl/nls/lang',
  'hbs!xecmpf/controls/bosearch/searchform/impl/bosearchform'
], function (require, $, _, Backbone, Marionette, base, log,
    FormView,
    ConnectorFactory,
    ModalAlert,
    DialogFooterView,
    LayoutViewEventsPropagationMixin,
    TabableRegionBehavior,
    TabContentKeyboardBehavior,
    BoSearchFormModel,
    lang,
    template
) {

  var BoSearchFieldsFormView = FormView.extend({

    events: {
      'keydown': 'onKeyDown'
    },

    behaviors: {
      TabableRegionBehavior: {
        behaviorClass: TabableRegionBehavior
      },
      TabContentKeyboardBehavior: {
        behaviorClass: TabContentKeyboardBehavior
      },
    },

    defaults: {
      tabContentAccSelectors: 'a[href], area[href], input:not([disabled]),' +
                              ' select:not([disabled]), textarea:not([disabled]),' +
                              ' button:not([disabled]), iframe, object, embed,' +
                              ' *[tabindex], *[cstabindex], *[contenteditable]'
    },

    onKeyDown: function (event) {
      // handle tab, space, enter
      if (event.keyCode === 9 || event.keyCode === 32 || event.keyCode === 13) {
        var elem = this.onKeyInView(event);
        if (elem) {
          event.preventDefault();
          event.stopPropagation();
          // this.trigger('changed:focus', this);
          elem.prop("tabindex", "0");
          elem.trigger("focus");
        }
      }
    },

    onDomRefresh: function(){
      this.trigger("refresh:tabable:elements");
    },
    constructor: function BoSearchFieldsFormView(options) {
      _.defaults(options, this.defaults);
      options.searchTabContentForTabableElements = true;
      FormView.prototype.constructor.apply(this, arguments);
    }

  });

  var BusinessObjectSearchFormView = Marionette.LayoutView.extend({

    events: {
      'keydown': 'onKeyDown'
    },

    className: 'conws-bosearchform',
    template: template,

    triggers: {
      "click .binf-btn.search" : "bosearchform:search",
      "click .binf-btn.cancel": "bosearchform:cancel"
    },

    regions: {
      searchFields: '.conws-bosearchfields',
      footer: '.binf-modal-footer'
    },

    ui: {
      footer: '.binf-modal-footer'
    },

    constructor: function BusinessObjectSearchForm(options) {
      _.defaults(options, this.defaults);
      Marionette.LayoutView.prototype.constructor.call(this, options);
      this.propagateEventsToRegions();
      this.listenTo(this, "bosearchform:search", this._triggerSearch);
      this.listenTo(this, "bosearchform:cancel", this._triggerCancel);
      this.listenTo(this.model, "change:bo_type_name", this._updateTitle);
      this.searchFormModel = new BoSearchFormModel(
          {
            id: this.model.get("bo_type_id"),
            name: this.model.get("bo_type_name")
          },
          {connector: this.options.context.getObject(ConnectorFactory)}
      );
      this.listenTo(this.searchFormModel, "change:name", function() {
        this.model.set("bo_type_name",this.searchFormModel.get("name"));
      });
      this.listenTo(this.searchFormModel, "change", function() {
        this.model.set("bus_att_metadata_mapping",this.searchFormModel.get("bus_att_metadata_mapping"));
      });
      this.listenTo(this.searchFormModel, "error", function(model, response, options) {
        var errmsg = response && (new base.Error(response)).message || lang.errorGettingSearchForm;
        log.error("Fetching the search forms failed: {0}",errmsg) && console.error(log.last);
        ModalAlert.showError(errmsg);
      });
      // SAPRM-9295:
      // Reference Search: when search form is empty a message should be displayed
      this.listenTo(this.searchFormModel, "sync", function() {
        var data = this.searchFormModel.get("data");
        if ( $.isEmptyObject(data) ) {
          this._updateFormFieldsZero(true);

          //SAPRM-10221: focus should be in 'search' button if there are no form fields
          this.focusOnSearchButton();

        }
        else {
          this._updateFormFieldsZero(false);

          //SAPRM-10221: focus should be in first form field if there are form fields
          this.listenToOnce(this.searchForm, "render", function() {
            this.focusOnFirstFormField();
          });

        }
      });
    },

    templateHelpers: function () {
      return {
        search_form_title: this._getTitle(),
        search_button_text: lang.boSearchFormButtonSearch,
        cancel_button_text: lang.boSearchFormButtonCancel,
        zero_fields_title: lang.zeroSearchFields
      };
    },

    onKeyDown: function (event) {
      //ctrl-enter from search form field -> set focus on search button
      if (event.keyCode === 13 && event.ctrlKey) { //ctrl-enter
       // check if ctrl-enter is from a search form field, and not from search/cancel button
       if( this.searchForm.$el.has(event.originalEvent.srcElement).length > 0 ){
             this.focusOnSearchButton();
        }
      }
    },

    _getTitle: function () {
      return _.str.sformat(lang.boSearchFormTitle,this.model.get("bo_type_name"));
    },

    _updateTitle: function () {
      var titleEl = this.$el.find(".conws-bosearchheader-title"),
          title = this._getTitle();
      titleEl.text(title);
      titleEl.attr({title:title});
    },

    _updateFormFieldsZero: function (zero) {
      var elem_fields      = this.$el.find(".conws-bosearchfields");
      var elem_fields_zero = this.$el.find(".conws-bosearchfields-zero");

      if (zero) {
        elem_fields.css({"display": "none"});
        elem_fields_zero.css({"display": ""});
      }
      else {
        elem_fields.css({"display": ""});
        elem_fields_zero.css({"display": "none"});
      }
    },

    //SAPRM-10221: focus should be in 'search' button
    focusOnSearchButton: function() {
      var btnviews = this.footerView.getButtons();
      btnviews && btnviews[0] && btnviews[0].$el.trigger("focus");
    },

    //SAPRM-10221: focus should be in first form field
    focusOnFirstFormField:function() {
      var firstField = this.searchFields.$el.find('.alpaca-container-item-first input');
      if ( firstField ) {
        firstField.trigger("focus");
      }
    },

    onRender: function () {
      // LayoutView destroys views on rendering, so we must create them every time on rendering
      this.searchForm = new BoSearchFieldsFormView({model: this.searchFormModel,mode:"create",layoutMode:"singleCol"});
      this.searchForm.model.fetch();

      var buttons = [
        {
          default: true,
          label: lang.boSearchFormButtonSearch,
          click: _.bind(this._triggerSearch, this)
        },
        {
          label: lang.boSearchFormButtonCancel,
          click: _.bind(this._triggerCancel, this)
        }
      ];
      this.footerView = new DialogFooterView({
        collection: new Backbone.Collection(buttons)
      });

      this.listenTo(this.footerView, 'childview:click', this.onClickButton);

      this.searchFields.show(this.searchForm);
      this.footer.show(this.footerView);

      var btnviews = this.footerView.getButtons();
      btnviews && btnviews[0] && btnviews[0].$el.addClass("search");
      btnviews && btnviews[1] && btnviews[1].$el.addClass("cancel");

    },


    
    onClickButton: function (view) {
      var attributes = view.model.attributes;
      if (attributes.click) {
        attributes.click();
      }
    },

    _triggerSearch: function() {
      log.debug("trigger bosearch:search") && console.log(log.last);
      // get values from form and trigger search
      // var valid = this.searchForm.validate();
      // if (valid) {
      var formData = this.searchForm.getValues(),
          formSchema = {
            data: this.searchFormModel.get("data"),
            options: this.searchFormModel.get("options"),
            schema: this.searchFormModel.get("schema")
          };
      this.model.trigger("bosearch:search",{searchParams:formData,searchForms:formSchema});
      // }
    },

    _triggerCancel: function() {
      log.debug("trigger bosearch:cancel") && console.log(log.last);
      this.model.trigger("bosearch:cancel");
    }

  });

  _.extend(BusinessObjectSearchFormView.prototype, LayoutViewEventsPropagationMixin);

  return BusinessObjectSearchFormView;
});




/**
 * Created by stefang on 06.06.2016.
 */
csui.define('xecmpf/controls/bosearch/resultlist/boresult.collection',["csui/lib/jquery", "csui/lib/underscore", "csui/lib/backbone", "csui/utils/base",
  "csui/utils/log",
  "csui/models/mixins/resource/resource.mixin",
  "csui/models/browsable/browsable.mixin",
  "i18n!xecmpf/controls/bosearch/impl/nls/lang"
], function ($, _, Backbone, base, log,
    ResourceMixin, BrowsableMixin, lang) {

  function mapobj(obj,iteratee,context) {
    return _.object(_.map(_.pairs(obj),function(keyval) {
      return _.iteratee(iteratee, context)(keyval);
    }));
  }

  var BoResultTableColumnModel = Backbone.Model.extend({

    idAttribute: "key",

    defaults: {
      key: null,  // key from the resource definitions
      sequence: 0 // smaller number moves the column to the front
    },

    constructor: function BoResultTableColumnModel(attributes, options) {
      Backbone.Model.prototype.constructor.apply(this, arguments);
    }

  });

  var BoResultTableColumnCollection = Backbone.Collection.extend({

    model: BoResultTableColumnModel,
    comparator: "sequence",

    constructor: function BoResultTableColumnCollection(models, options) {
      Backbone.Collection.prototype.constructor.apply(this, arguments);
    }

  });

  var BoResultColumn = Backbone.Model.extend({

    idAttribute: "column_key",

    constructor: function BoResultColumn(attributes, options) {
      Backbone.Model.prototype.constructor.apply(this, arguments);
    }

  });

  var BoResultColumnCollection = Backbone.Collection.extend({

    model: BoResultColumn,

    constructor: function BoResultColumnCollection(models, options) {
      Backbone.Collection.prototype.constructor.apply(this, arguments);
    }

  });

  var BoResultModel = Backbone.Model.extend({
    constructor: function BoResultModel(attributes, options) {
      Backbone.Model.prototype.constructor.apply(this, arguments);
    },
    get: function() {
      return Backbone.Model.prototype.get.apply(this, arguments);
    }
  });

  var csui_width = 120, csui_px = 14, csui_pad = 32, max_abbrev = 4;
  // csui uses 120px as average field length, including two times 8px left and right padding
  // when using a 14px font.
  // these values should be derived from the actual settings on the page. but we cannot.
  // thus we assume the standard values.

  // as csui uses an average field width that displays about 12 characters,
  // we use according maximum and minimum field lengths.
  function getLeveledLength(fieldLength,headerText,labelLength) {
    var length = Math.max(fieldLength||0,(headerText&&headerText.length)||0,labelLength||0,max_abbrev);
    length = Math.min(length,60);
    return length;
  }

  function getMinFactor(smallestLength,averageLength,longestLength) {
    // avg_width: average width per letter, for shortest text. varies: for texts of few characters
    // only, we assume abbreviations with more capital letters and we use larger value.
    var avg_width = smallestLength>max_abbrev ? 0.53 : 0.6;
    // csui_average: how many characters of the shortest text, can be placed in a average column
    var csui_average = (csui_width - csui_pad) / (csui_px * avg_width);
    // factor: set the min factor equal to the ratio of the smallest length to the average length,
    // so when scaled accordingly by the table view the smallest column has mostly no ellipsis.
    var factor = smallestLength / csui_average;
    log.debug("csui_average {0}",csui_average) && console.log(log.last)
    return Math.min(factor,0.8);
  }

  var BoResultCollection = Backbone.Collection.extend({

    model: BoResultModel,

    constructor: function BusinesObjectResultCollection(models, options) {
      Backbone.Collection.prototype.constructor.apply(this, arguments);
      this.makeResource(options);
      this.makeBrowsable(options);
      this.boSearchModel = options.boSearchModel;
      this.searchParams = options.searchParams;
      this.labelToKey = {},
      this.nameToKey = {},
      this.columns = new BoResultColumnCollection();
      this.tableColumns = new BoResultTableColumnCollection();
      this.totalCount = 0;
      this.skipCount = 0;
      this.topCount = options.pageSize || 100;
      this.maxCount = options.maxRowCount;
      this.options = options;
    }
  },
  {
    // errors
    ERR_COLUMNS_CHANGED: "ERR_COLUMNS_CHANGED"
  });

  ResourceMixin.mixin(BoResultCollection.prototype);
  BrowsableMixin.mixin(BoResultCollection.prototype);

  var defaults = _.defaults({},BoResultCollection.prototype);

  _.extend(BoResultCollection.prototype, {

    fetch: function (options) {
      // do server call only if we have search params and
      // if either we didn't yet scroll to the end (length<maxCount)
      // or we have a reset request
      var reset = options && options.reset;
      if (this.searchParams && (reset || this.maxCount===undefined || this.length < this.maxCount)) {
        reset && (options.url = this.url(options));
        return defaults.fetch.apply(this, arguments);
      } else {
        return $.Deferred().resolve().promise();
      }
    },

    url: function (options) {
      //var path = 'forms/nodes/create',
      var path = 'businessobjects',
          skipCount = (options && options.reset) ? 0 : (this.skipCount || 0),
          params = _.omit(
              _.defaults(
                  {
                    bo_type_id: this.boSearchModel.get("bo_type_id"),
                    limit: this.topCount,
                    page: this.topCount ? Math.floor(skipCount / this.topCount) + 1 : undefined
                  },
                  mapobj(this.searchParams, function (keyval) {
                    return ["where_" + keyval[0], keyval[1]];
                  }, this)), function (value) {
                return value === null || value === '';
              }),
          resource = path + '?' + $.param(params),
          baseurl  = this.connector.getConnectionUrl().getApiBase('v2');
      //var url = base.Url.combine(baseurl, resource);
      var url = base.Url.combine(baseurl, resource);
      return url;
    },

    parse: function (response,options) {
      function parcmp(pnew,cnew) {
        var result;
        if (cnew) {
          var pcount = 0;
          for (var ii = 0; ii<cnew.length; ii++) {
            var celnew = cnew[ii];
            pcount += (pnew[celnew.fieldName]!==undefined) ? 1 : 0;
          }
          if (pcount===0) {
            result = "incompatible";
          }
        }
        return result;
      }
      function colcmp(cold,cnew) {
        var result;
        if (cnew) {
          for (var ii = 0; ii<cnew.length; ii++) {
            var celnew = cnew[ii], celold = cold[ii];
            if (!celold || celold.fieldName!==celnew.fieldName) {
              return "incompatible";
            } else if (celold.fieldLabel!==celnew.fieldLabel
                       || celold.position!==celnew.position
                       || celold.length!==celnew.length) {
              result = "significant";
            }
          }
        }
        return result;
      }
      //this.response = response;
      delete this.errorMessage;
      var rows = [];
      if (this.searchParams && response && response.results) {
        var columnDescriptions = response.results.column_descriptions,
            pardiff = ( $.isEmptyObject(this.searchParams)|| $.isEmptyObject(columnDescriptions) ) ? "significant" : parcmp(this.searchParams,columnDescriptions),
            coldiff,
            ok = (pardiff!=="incompatible");
        if (ok && !options.reset && this.columnDescriptions) {
          coldiff = colcmp(this.columnDescriptions, columnDescriptions);
          ok = (coldiff!=="incompatible");
        }
        if (!ok) {
          // raise an error, if old and new columns and mapped values are incompatible
          this.errorMessage = BoResultCollection.ERR_COLUMNS_CHANGED;
        } else {
          if (!columnDescriptions || !columnDescriptions.length) {
            // if column descriptions are undefined or empty use businessobjectid as default column.
            columnDescriptions = [{
                  fieldLabel: "Business Object ID",
                  fieldName: "businessObjectId",
                  keyField: "",
                  length: 15,
                  position: 1
                }];
          }
          var searchedParams = _.extend({}, this.searchParams);
          var searchedForms = _.extend({}, this.searchForms);
          var mappedValues = {};
          // rebuild columns on reset, first fetch or if column descriptions have any difference
          // column differences must be compatible at that point, as this was checked above.
          if (options.reset || !this.columnDescriptions || pardiff==="significant" || coldiff==="significant") {
            var normDescrs  = [],
                labelToKey  = {},
                nameToKey   = {},
                totalLength = 0,
                columnCount = 0,
                smallestLength,
                longestLength;
            _.each(columnDescriptions, function (attributes, index) {
              // input_attributes_are_like: {
              //   fieldLabel: "Ct",
              //   fieldName: "ATTYP",
              //   keyField: "",
              //   length: 2,
              //   position: 1
              // },
              // var column_key = attributes.fieldName || attributes.fieldLabel;
              // column_key = column_key && column_key.replace(/[^a-z-_A-Z0-9]/g,"_");
              var column_key = "conws_col_" + index,
                  labelLength = 0;
              // build value map if given and also use the mapped values for field length calculation
              if (searchedForms
                  && searchedForms.options
                  && searchedForms.options.fields
                  && searchedForms.options.fields[attributes.fieldName]
                  && searchedForms.options.fields[attributes.fieldName].optionLabels
                  && searchedForms.schema
                  && searchedForms.schema.properties
                  && searchedForms.schema.properties[attributes.fieldName]
                  && searchedForms.schema.properties[attributes.fieldName].enum
                  && searchedForms.options.fields[attributes.fieldName].optionLabels.length
                     === searchedForms.schema.properties[attributes.fieldName].enum.length) {
                var labels = searchedForms.options.fields[attributes.fieldName].optionLabels,
                    values = searchedForms.schema.properties[attributes.fieldName].enum,
                    map = mappedValues[column_key] = {};
                _.each(labels, function (label, mapidx) {
                  map[values[mapidx]] = label;
                  if (label.length>labelLength) {
                    labelLength = label.length
                  }
                }, this);
              }
              var normalized = _.extend({
                align: "left",
                name: attributes.fieldLabel,
                persona: "",
                sort: true,
                type: -1 /* for string*/,
                width_weight: 0
              }, attributes, {
                correctedLength: getLeveledLength(attributes.length,attributes.fieldLabel,labelLength),
                column_key: column_key
              });
              if (normalized.correctedLength) {
                // only if length or field label is set use length for average calculation
                // columns with unset length are assumed to get average length
                totalLength += normalized.correctedLength;
                columnCount += 1;
                if (smallestLength===undefined || normalized.correctedLength<smallestLength) {
                  smallestLength = normalized.correctedLength;
                }
                if (longestLength===undefined || normalized.correctedLength>longestLength) {
                  longestLength = normalized.correctedLength;
                }
              }
              normDescrs.push(normalized);
              labelToKey[normalized.fieldLabel] = normalized.column_key;
              nameToKey[normalized.fieldName] = normalized.column_key;
            }, this);
            // set width factors according corrected length (depending on length AND field label)
            // so variation of length is not too wide, in order to avoid truncated fields.
            var defaultKey, lowestSequence,
                tableColumns = _.map(normDescrs,function (column) {
                  var key      = column.column_key,
                      sequence = column.position + 1;
                  if (sequence !== undefined) {
                    if (lowestSequence === undefined || sequence < lowestSequence) {
                      lowestSequence = sequence;
                      defaultKey = key;
                    }
                  }
                  defaultKey || (defaultKey = key);
                  return {key: key, sequence: sequence};
                });

            if (columnCount>1
                && smallestLength && smallestLength>0
                && longestLength && longestLength>smallestLength) {
              // ensure, that smallest length is not smaller than minimal factor of average length.
              // compute a correction length accordingly and apply it on all column lengths.
              // This is done to avoid truncated headers while reflecting the expected field lengths.
              var averageLength = totalLength/columnCount,
                  minFactor = getMinFactor(smallestLength,averageLength,longestLength),
                  minLength = averageLength * minFactor,
                  correctionLength = smallestLength<minLength ? (minFactor*averageLength-smallestLength)/(1-minFactor) : 0,
                  widthFactorSum = 0,
                  maxWidthFactor = 0,
                  maxWidthFactorIndex = 0;
              log.debug("minFactor {0}",minFactor) && console.log(log.last)
              averageLength += correctionLength;
              _.each(normDescrs,function(normalized,index){
                // now set width factors. length = 0 is assumed to have average Length.
                normalized.correctedLength = normalized.correctedLength ? normalized.correctedLength+correctionLength : averageLength;
                var widthFactor = normalized.correctedLength / averageLength;
                log.debug("widthFactor {0}",widthFactor) && console.log(log.last)
                tableColumns[index].widthFactor =  widthFactor;
                widthFactorSum += widthFactor;
                if (widthFactor>=maxWidthFactor) {
                  maxWidthFactor = widthFactor;
                  maxWidthFactorIndex = index;
                }
              }, this);
              log.debug("widthFactorSum {0}",widthFactorSum) && console.log(log.last)
              var widthFactorRest = columnCount - widthFactorSum;
              log.debug("widthFactorRest {0}",widthFactorRest) && console.log(log.last)
              if (widthFactorRest!==0) {
                maxWidthFactor += widthFactorRest;
                widthFactorSum += widthFactorRest;
                tableColumns[maxWidthFactorIndex].widthFactor = maxWidthFactor;
                log.debug("widthFactorSum {0}",widthFactorSum) && console.log(log.last)
              }
            }

            this.orderByDefaultKey = defaultKey;
            this.mappedValues = mappedValues;
            this.labelToKey = labelToKey;
            this.nameToKey = nameToKey;
            this.columns.reset(normDescrs, {silent: true});
            this.tableColumns.reset(tableColumns);
            this.columnDescriptions = response.results.column_descriptions;
          }

          this.searchedParams = searchedParams;
          this.searchedForms = searchedForms;

          if (response.results.result_rows) {
            var needCount = this.maxCount===undefined ? this.topCount : Math.min(this.topCount, this.maxCount - this.length);
            for (var rowindex = 0; rowindex < needCount; rowindex++) {
              if (rowindex >= response.results.result_rows.length) {
                break;
              }
              var attributes = response.results.result_rows[rowindex];
              var row = _.extend(mapobj(attributes, function (keyval) {
                var key = this.labelToKey[keyval[0]] || this.nameToKey[keyval[0]] || keyval[0],
                    map = this.mappedValues[key],
                    val = (map && map[keyval[1]]) || keyval[1];
                return [key, val];
              }, this), {
                id: attributes.rowId
              });
              rows.push(row);
            }
          }

          this.totalCount = response && response.paging && response.paging.total_count;
          if (options.reset) {
            this.skipCount = 0;
          }
          this.maxRowsExceeded = response && response.results && response.results.max_rows_exceeded;

        }
      }
      return rows;
    }

  });

  return BoResultCollection;

});

/**
 * Created by stefang on 05.04.2016.
 */
csui.define('xecmpf/controls/bosearch/resultlist/botable.view',['require', 'csui/lib/jquery', 'csui/lib/underscore', 'csui/utils/log',
  "csui/lib/backbone", 'csui/lib/marionette',
  'csui/controls/table/table.view',
  "csui/lib/jquery.dataTables.tableTools/js/dataTables.tableTools",
  'xecmpf/controls/bosearch/resultlist/boresult.collection',
  'i18n!xecmpf/controls/bosearch/impl/nls/lang'
], function (require, $, _, log,
    Backbone, Marionette,
    TableView,
    TableTools,
    BoResultCollection,
    lang
) {

  function getOption(property) {
    var options = this.options || {};
    var value = options[property];
    return _.isFunction(value) ? options[property].call(this.view) : value;
  }

  var InfiniteTableScrollingBehavior = Marionette.Behavior.extend({

    defaults: {
      content: null,
      contentParent: null,
      fetchMoreItemsThreshold: 95
    },

    constructor: function InfiniteTableScrollingBehavior(options, view) {
      Marionette.Behavior.prototype.constructor.apply(this, arguments);
      view.infiniteScrollingBehavior = this;
      this.listenTo(view, 'render', this._bindScrollingEvents);
      this.listenTo(view, 'before:destroy', this._unbindScrollingEvents);
    },

    _scrollToPosition: function (scrollPosition,where) {
      // if possible, scroll given position to "middle", "top" or "bottom" of visible area
      // otherwise scroll to the nearest visible position without triggering an additional fetch.
      var contentParent = getOption.call(this, 'contentParent'),
          parentHeight = this._contentParent.height(),
          content = getOption.call(this, 'content'),
          contentEl = content ? this.view.$(content) :
                      contentParent ? this._contentParent.children().first() :
                      this.view.$el,
          contentHeight = _.reduce(contentEl, function(sum,el){return sum+$(el).height()},0);
      if (contentHeight<parentHeight) {
        scrollPosition = 0
      } else {
        if (where==="middle") {
          scrollPosition = scrollPosition - parentHeight / 2;
        } else if (where==="bottom") {
          scrollPosition =  scrollPosition - parentHeight;
        }
        scrollPosition =  Math.floor(scrollPosition);
        if (scrollPosition < 0) {
          scrollPosition = 0
        } else {
          var fetchMoreItemsThreshold = getOption.call(this, 'fetchMoreItemsThreshold'),
              scrollableHeight = Math.floor((contentHeight-parentHeight)*(fetchMoreItemsThreshold/100.0));
          if (scrollPosition>=scrollableHeight) {
            scrollPosition = scrollableHeight-1; // ensure, that no fetch is triggered
          }
        }
      }
      this._contentParent.scrollTop(scrollPosition);
    },

    scrollTop: function (scrollPosition) {
      this._scrollToPosition(scrollPosition,"top");
    },

    scrollMiddle: function (scrollPosition) {
      this._scrollToPosition(scrollPosition,"middle");
    },

    scrollBottom: function (scrollPosition) {
      this._scrollToPosition(scrollPosition,"bottom");
    },

    _bindScrollingEvents: function () {
      this._unbindScrollingEvents();
      var contentParent = getOption.call(this, 'contentParent');
      this._contentParent = contentParent ? this.view.$(contentParent) : this.view.$el;
      this._contentParent.on('scroll.' + this.view.cid, _.bind(this._checkScrollPosition, this));
    },

    _checkScrollPosition: function () {
      var contentParent = getOption.call(this, 'contentParent'),
          content = getOption.call(this, 'content'),
          contentEl = content ? this.view.$(content) :
                      contentParent ? this._contentParent.children().first() :
                      this.view.$el,
          fetchMoreItemsThreshold = getOption.call(this, 'fetchMoreItemsThreshold'),
          contentHeight = _.reduce(contentEl, function(sum,el){return sum+$(el).height()},0),
          scrollableHeight = contentHeight - this._contentParent.height(),
          lastScrollPosition = this._contentParent.scrollTop(),
          scrollablePercentage = lastScrollPosition * 100 / scrollableHeight;
      this.view.lastScrollPosition = lastScrollPosition;
      if (scrollablePercentage >= fetchMoreItemsThreshold) {
        this._checkScrollPositionFetch();
      }
    },

    _checkScrollPositionFetch: function () {
      var collection = this.view.collection;
      if (collection.length < collection.totalCount && !collection.fetching &&
          collection.skipCount < collection.length) {
        log.debug('fetching from {0}', collection.length) && console.log(log.last);
        var oldSkip = collection.skipCount;
        collection.setSkip(collection.length, false);
        var contentParent = getOption.call(this, 'contentParent');
        // to fix CWS-1546, just send a mouseup event to the scrollbar, so the drag
        // operation ends and element is sensitive again. And: sending this event obviously
        // does not harm the other scenarios, for example when scrolling with the mouse wheel.
        // if one finds a beter solution, for exampletirggering this mouseup only if a drag
        // operation is in progress, then feel free to update the code here.
        this.$(".ps-scrollbar-y-rail").trigger("mouseup");
        collection.fetch({
          reset: false,
          remove: false,
          merge: false,
          silent: true,
          success: _.bind(function () {
            if (collection.errorMessage && collection.errorMessage===BoResultCollection.ERR_COLUMNS_CHANGED) {
              collection.setSkip(oldSkip,false);
              if (this.view.lastScrollPosition>0) {
                this.view.$(contentParent).scrollTop(this.view.lastScrollPosition-1);
              }
            } else {
              this.view.render();
            }
          }, this)
        });
      }
    },

    _unbindScrollingEvents: function () {
      if (this._contentParent) {
        this._contentParent.off('scroll.' + this.view.cid);
      }
    }

  });

  var InfiniteScrollingTableView = TableView.extend({

    events: {
      'keydown': 'onKeyDown'
    },

    behaviors: _.defaults({
          InfiniteScrolling: {
            behaviorClass: InfiniteTableScrollingBehavior,
            contentParent: 'tbody',
            content: 'tbody>tr:visible',
            fetchMoreItemsThreshold: 100
          }
        },
        TableView.prototype.behaviors),

    constructor: function InfiniteScrollingTableView() {
      TableView.prototype.constructor.apply(this, arguments);
      this.listenTo(this,"clicked:cell", this._clickedCell);
      // this.listenTo(this,"row:clicked", this._clickedRow);
      if (this.options.disableItemsWithWorkspace){
          this.listenTo(this, "tableRowRendered", this._disableRow);  
      }

      this.listenTo(this.collection, "request", function(model,xhr,options) {
        // clear scroll position when fetch with reset:true is triggered
        if (options.reset) {
          delete this.lastScrollPosition;
        }
      });
    },

    _disableRow: function(event){
        var eventTarget = event.target;
        var node = event.node;
        if (node.get("has_workspace")){
            var row = $(eventTarget); 
            row.addClass("conws-boresulttable-disabled-row");
            row.off("pointerenter"); //disable pointer events to avoid highlighting the rows
            row.off("pointerleave");
            row.find("td").not('.csui-table-cell-_toggledetails').off("click"); // disable cell click except for the expand/collapse details button.
        }
   },

    onKeyDown: function (event) {
      // handle tab, space, enter only for selectRows single
      if (this.options && this.options.selectRows === 'single') {
        if (event.keyCode === 32 || event.keyCode === 13) {
          var btoggleDetails = event.target.classList.contains('csui-table-cell-_toggledetails');
          if (!btoggleDetails) { // it's  not a toggle cell
            event.preventDefault();
            event.stopPropagation();
            event.target.click();
          }
        }
      }
    },

    _clickedCell: function(cellEventInfo) {
      if (!this.ignoreSelectEvents) {
        var selectedRow = {
          model: cellEventInfo.model,
          // index: cellEventInfo.rowIndex,
          target: this.table.row(cellEventInfo.rowIndex).node()
        };
        this.lastSelectedRow = selectedRow;
        this.trigger("row:selected",selectedRow);
      }
    },

    // _clickedRow: function(rowEventInfo) {
    //   if (!this.ignoreSelectEvents) {
    //     var selectedRow = {
    //       model: rowEventInfo.node,
    //       // index: rowEventInfo.node.get("rowId")-1;
    //       target: rowEventInfo.target
    //     };
    //     this.lastSelectedRow = selectedRow;
    //     this.trigger("row:selected",selectedRow);
    //   }
    // },

    setSelection: function(selectedNodesById,selected) {

      this.ignoreSelectEvents = true;

      selected = selected || selected===undefined;
      function getTableTools() {
        return this.tableTools ||
               (this.tableTools = TableTools.fnGetInstance(this.table.table().node()));
      }
      function selectRowsByNodeIds(selectedNodesById) {
        if (this.table && selectedNodesById) {
          _.each(selectedNodesById,function(id) {
            var node = this.collection.get(id),
                position = this.collection.indexOf(node),
                tt = getTableTools.call(this),
                trNode = this.table.row(position).node();
            if (selected) {
              tt.fnSelect(trNode);
            } else {
              tt.fnDeselect(trNode);
            }
          },this);
        }
      }
      selectRowsByNodeIds.call(this,selectedNodesById);
      delete this.lastSelectedRow;
      if (this.table && selectedNodesById && selectedNodesById.length>0 && selected) {
        var id = selectedNodesById[0],
            node = this.collection.get(id),
            position = this.collection.indexOf(node),
            trNode = this.table.row(position).node();
        this.lastSelectedRow = {
          model: node,
          // index: position,
          target: $(trNode)
        };
      }

      if (this.lastSelectedRow && this.infiniteScrollingBehavior) {
        var lastSelectedMiddle = this.lastSelectedRow.target.position().top + this.lastSelectedRow.target.height()/2;
        this.infiniteScrollingBehavior.scrollMiddle(lastSelectedMiddle);
      }

      delete this.ignoreSelectEvents;

    },

    clearSelection: function() {

      this.ignoreSelectEvents = true;

      // forget last selected row
      delete this.lastSelectedRow;

      // clear selection state in rows
      this.clearChildrenSelection();

      if (this.lastScrollPosition!==undefined && this.infiniteScrollingBehavior) {
        this.infiniteScrollingBehavior.scrollTop(this.lastScrollPosition);
      }

      delete this.ignoreSelectEvents;

    }

  });

  return InfiniteScrollingTableView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/bosearch/resultlist/impl/boresultlist',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "      <div class=\"conws-boresultbanner-container\">\r\n        <div class=\"conws-boresultbanner\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"banner_message") || (depth0 != null ? lookupProperty(depth0,"banner_message") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"banner_message","hash":{},"loc":{"start":{"line":5,"column":42},"end":{"line":5,"column":60}}}) : helper)))
    + "</div>\r\n      </div>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"conws-boresultlist-body\">\r\n  <div class=\"conws-boresulttable\">\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"banner_message") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"loc":{"start":{"line":3,"column":4},"end":{"line":7,"column":11}}})) != null ? stack1 : "")
    + "  </div>\r\n  <div class=\"conws-boresultfooter\">\r\n    <div class=\"conws-boresultfooter-message-container  binf-modal-footer\">\r\n      <div class=\"conws-boresultfooter-message\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"footer_message") || (depth0 != null ? lookupProperty(depth0,"footer_message") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"footer_message","hash":{},"loc":{"start":{"line":11,"column":48},"end":{"line":11,"column":66}}}) : helper)))
    + "</div>\r\n    </div>\r\n    <div class=\"conws-boresultfooter-attach-container  binf-modal-footer\">\r\n      <button type=\"button\" disabled class=\"binf-btn binf-btn-default attach\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"attach_button_text") || (depth0 != null ? lookupProperty(depth0,"attach_button_text") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"attach_button_text","hash":{},"loc":{"start":{"line":14,"column":78},"end":{"line":14,"column":100}}}) : helper)))
    + "</button>\r\n    </div>\r\n  </div>\r\n</div>\r\n";
}});
Handlebars.registerPartial('xecmpf_controls_bosearch_resultlist_impl_boresultlist', t);
return t;
});
/* END_TEMPLATE */
;
/**
 * Created by stefang on 05.04.2016.
 */
csui.define('xecmpf/controls/bosearch/resultlist/boresultlist.view',['require', 'csui/lib/jquery', 'csui/lib/underscore',
  "csui/lib/backbone", 'csui/lib/marionette',
  'csui/utils/base', 'csui/utils/log',
  'csui/utils/contexts/factories/connector',
  'csui/dialogs/modal.alert/modal.alert',
  'xecmpf/controls/bosearch/resultlist/botable.view',
  'xecmpf/controls/bosearch/resultlist/boresult.collection',
  'hbs!xecmpf/controls/bosearch/resultlist/impl/boresultlist',
  'i18n!xecmpf/controls/bosearch/impl/nls/lang'
], function (require, $, _,
    Backbone, Marionette,
    base, log,
    ConnectorFactory,
    ModalAlert,
    InfiniteScrollingTableView,
    BoResultCollection,
    template, lang
) {

  var BusinessObjectResultListView = Marionette.LayoutView.extend({

    className: 'conws-boresultlist',
    template: template,

    regions: {
      tableRegion: '.conws-boresulttable'
    },

    triggers: {
      "click .binf-btn.attach": "attach:clicked"
    },

    constructor: function BusinessObjectResultListView(options) {

      options || (options = {});

      Marionette.LayoutView.prototype.constructor.call(this, options);

      this.listenTo(this.model, "change:bo_type_name", this._updateBanner);
      this.listenTo(this.model, "bosearch:search", this._triggerSearch);
      this.listenTo(this, "attach:clicked", this._triggerAttach);
    },

    _triggerSearch : function(searchEventInfo) {
      // get form data, set in result collection and trigger fetch.

      // first create empty collection and table view
      if (!this.collection) {
        this.collection = new BoResultCollection(undefined,
            {
              connector: this.options.context.getObject(ConnectorFactory),
              boSearchModel: this.options.model,
              autoreset: true
            });
        this.render();
        this.listenTo(this.collection,"sync",this._updateFooter);
        this.listenTo(this.collection,"sync",this._showSyncError);
        this.listenTo(this.collection,"error",this._showSearchError);
      }
      // then do search and table view renders triggered by model events and shows busy indicator
      this.collection.searchParams = searchEventInfo ? searchEventInfo.searchParams : undefined;
      this.collection.searchForms = searchEventInfo ? searchEventInfo.searchForms : undefined;

      // focus on first row in result list
      var that = this;
      this.collection.fetch({reset: true}).then(function(){
        var curFocus = that.resultTable.currentlyFocusedElement();
        if (curFocus) {
          curFocus.trigger("focus");
        }
      });


      // After search selected:
      // show attach button
      // SAPRM-9320: if metadata mapping is enabled for bus. attachments then nevertheless
      //             no attach button is shown but a single select table is displayed
      var bus_att_metadata_mapping = this.model.get("bus_att_metadata_mapping");
      if (this.options.multipleSelect && !bus_att_metadata_mapping ){
        var elem = this.$el.find(".conws-boresultfooter>.conws-boresultfooter-attach-container");
        if (elem) {
          elem.css({"display": "block"});
          // Reset attach button to disabled as no item is selected after search
          var attBtn = elem.children();
          if ( attBtn ) {
            attBtn[0].disabled = true;
          }
        }
        // here is the best place to add space for attach button
        this.$el.addClass('conws-with-attachbtn');
      }
    },

    _selectedRow: function(selectedRow) {
      log.debug("trigger reference:clicked") && console.log(log.last);
      this.listenToOnce(this.model,"reference:selected",function() {
        $(selectedRow.target).trigger("mouseleave"); // remove hover style at end of selection process
      });
      this.model.trigger("boresult:select",{selectedItems:[selectedRow.model]});
    },

    _enableAttachBtn: function(selectedRow){
      if ( selectedRow.nodes.length > 0 ){
        var selChilds = this.resultTable.getSelectedChildren();
        if ( selChilds.length > 0 ) {
          var elem = this.$el.find(".conws-boresultfooter .binf-btn.binf-btn-default.attach");
          if (elem) {
            elem[0].disabled = false;
          }
        }
      }
    },

    _disableAttachBtn: function(selectedRow){
      if ( selectedRow.nodes.length > 0 ){
        var selChilds = this.resultTable.getSelectedChildren();
        if ( selChilds.length === 0 ) {
          var elem = this.$el.find(".conws-boresultfooter .binf-btn.binf-btn-default.attach");
          if (elem) {
            elem[0].disabled = true;
          }
        }
      }
    },

    templateHelpers: function () {
      return {
        banner_message: this._getBannerMessage(),
        footer_message: this._getFooterMessage(),
        attach_button_text: lang.boResultListButtonAttach,
      };
    },

    _updateBanner: function () {
      var msg = this._getBannerMessage();
      if (msg) {
        this.$el.find(".conws-boresultbanner").text(this._getBannerMessage());
      }
    },

    _getBannerMessage: function () {
      return this.collection ? undefined : _.str.sformat(lang.resultListBannerMessage,this.model.get("bo_type_name"));
    },

    _updateFooter: function() {
      var msg = this._getFooterMessage();
      if (msg) {
        this.$el.find(".conws-boresultfooter-message").text(msg);
        this.$el.addClass("conws-with-footer");
      } else {
        this.$el.removeClass("conws-with-footer");
      }
    },

    _getFooterMessage: function () {
      return (this.collection && this.collection.maxRowsExceeded) ? lang.resultListRefineMessage : undefined;
    },

    _showSyncError: function () {
      if (this.collection.errorMessage && this.collection.errorMessage===BoResultCollection.ERR_COLUMNS_CHANGED) {
        ModalAlert.showError(lang[this.collection.errorMessage]||this.collection.errorMessage);
      }
    },

    _showSearchError: function (model, response, options) {
      var errmsg = response && (new base.Error(response)).message || lang.errorSearchingBusinessObjects;
      log.error("Searching for business objects failed: {0}",errmsg) && console.error(log.last);
      ModalAlert.showError(errmsg);
    },

    _triggerAttach : function() {
      // SAPRM-9320: together with this topic the events are aligned
      // log.debug("trigger reference:selected") && console.log(log.last);
      // this.model.trigger("reference:selected",{selectedItems:this.resultTable.getSelectedChildren()});
      log.debug("trigger boresult:select") && console.log(log.last);
      this.model.trigger("boresult:select",{selectedItems:this.resultTable.getSelectedChildren()});
    },

    onRender: function() {
      this._updateFooter();

      if (this.collection) {
        var selectRows = "single";
        var selectColumn = false;
        // SAPRM-9320: if metadata mapping is enabled for bus. attachments then nevertheless
        //             no attach button is shown but a single select table is displayed
        var bus_att_metadata_mapping = this.model.get("bus_att_metadata_mapping");
        if ( this.options.multipleSelect && ! bus_att_metadata_mapping ) {
          selectRows = "multiple";
          selectColumn = true;
        }
        var enableSorting = true;
		
        if (this.options.enableSorting !== undefined){
          enableSorting = this.options.enableSorting;
        }
        
        this.resultTable = new InfiniteScrollingTableView({
          context: this.options.context,
          connector: this.options.context.getObject(ConnectorFactory),
          collection: this.collection,
          columns: this.collection.columns,
          tableColumns: this.collection.tableColumns,
          selectRows: selectRows,
          selectColumn: selectColumn,
          enableSorting: enableSorting,
          //orderBy: this.collection.orderByDefaultKey && (this.collection.orderByDefaultKey + ' asc'),
          nameEdit: false,
          haveDetailsRowExpandCollapseColumn: true,
          disableItemsWithWorkspace: this.options.disableItemsWithWorkspace,
          //columnsWithSearch: columns,
          tableTexts: {
            zeroRecords: lang.noBusinessObjectsFound
          }
        });
        // SAPRM-9320: if metadata mapping is enabled for bus. attachments then nevertheless
        //             no attach button is shown but a single select table is displayed
        if (!this.options.multipleSelect || bus_att_metadata_mapping) {
          this.listenTo(this.resultTable,"row:selected", this._selectedRow);
        }
        else {
          this.listenTo(this.resultTable,"tableRowSelected", this._enableAttachBtn);
          this.listenTo(this.resultTable,"tableRowUnselected", this._disableAttachBtn);
        }
        this.tableRegion.show(this.resultTable);
      } else if (this.resultTable) {
        this.stopListening(this.resultTable);
        delete this.resultTable;
      }
    }

  });

  return BusinessObjectResultListView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/bosearch/impl/bosearch',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"conws-bosearch-wrapper\">\r\n  <div class=\"conws-bosearch-panel\">\r\n    <div class=\"conws-bosearch-title\">\r\n      "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"bosearch_title") || (depth0 != null ? lookupProperty(depth0,"bosearch_title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"bosearch_title","hash":{},"loc":{"start":{"line":4,"column":6},"end":{"line":4,"column":24}}}) : helper)))
    + "\r\n    </div>\r\n    <div class=\"conws-bosearch-form\">\r\n    </div>\r\n    <div class=\"conws-bosearch-result\">\r\n    </div>\r\n  </div>\r\n</div>\r\n";
}});
Handlebars.registerPartial('xecmpf_controls_bosearch_impl_bosearch', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/controls/bosearch/impl/bosearch',[],function(){});
/**
 * Created by stefang on 05.04.2016.
 */
csui.define('xecmpf/controls/bosearch/bosearch.view',['require',
  'csui/lib/jquery',
  'csui/lib/underscore',
  'csui/lib/marionette',
  'csui/widgets/metadata/metadata.view',
  'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',
  'csui/controls/progressblocker/blocker',
  'xecmpf/controls/bosearch/searchform/bosearchform.view',
  'xecmpf/controls/bosearch/resultlist/boresultlist.view',
  'hbs!xecmpf/controls/bosearch/impl/bosearch',
  'css!xecmpf/controls/bosearch/impl/bosearch'
], function (require, $, _,
    Marionette,
    MetadataView /* load metadata.css to have the styles and the same load order always */,
    LayoutViewEventsPropagationMixin,
    BlockingView,
    BoSearchFormView,
    BoResultListView,
    template
) {

  var BusinessObjectSearchView = Marionette.LayoutView.extend({

    className: 'conws-bosearch csui-metadata-overlay',
    template: template,

    regions: {
      searchRegion: '.conws-bosearch-form',
      resultRegion: '.conws-bosearch-result'
    },

    constructor: function BusinessObjectSearchView(options) {
      Marionette.LayoutView.prototype.constructor.apply(this, arguments);
      this.propagateEventsToRegions();
      this.listenTo(this.model,"reference:search",this._referenceSearchOpen);
      if (this.options.blockingParentView) {
        BlockingView.delegate(this, this.options.blockingParentView);
      } else {
        BlockingView.imbue(this);
      }
      this.listenTo(this.model, "boresult:select", function () {
        this.blockActions();
      })
      .listenTo(this.model, "reference:selected", function () {
        this.unblockActions();
      })
      .listenTo(this.model, "reference:rejected", function () {
        this.unblockActions();
      });
    },

    templateHelpers: function () {
      return {
        bosearch_title: this.options.title
      };
    },

    onRender: function () {
      // LayoutView destroys views on rendering, so we must create them every time on rendering
      this.searchView = new BoSearchFormView({model: this.model, context: this.options.context});
      this.resultView = new BoResultListView({
        model: this.model, context: this.options.context,
        multipleSelect: this.options.multipleSelect,
        enableSorting:  false,
        disableItemsWithWorkspace: this.options.disableItemsWithWorkspace
      });

       if (this.options.title){
         this.$el.addClass("display-title");
       }

      this.searchRegion.show(this.searchView);
      this.resultRegion.show(this.resultView);
    },

    _referenceSearchOpen: function() {
      // TODO: where to place this code? seems a little bit tricky here, to do ALL these things.
      // TODO: do this before the animation and not during it, to have a smooth slide-in.
      var bosearchview = this;
      if (bosearchview.searchView && bosearchview.searchView.searchForm) {
        bosearchview.searchView.searchForm.$el.hide();
        var old_id = bosearchview.searchView.searchForm.model.get("id"),
            new_id = bosearchview.searchView.model.get("bo_type_id");
        if (old_id!==new_id) {
          if (bosearchview.resultView && bosearchview.resultView.collection) {
            delete bosearchview.resultView.collection;
            bosearchview.resultView.render();
          }
        }
        // be sure to use bo_type_id in model of search view also for the search form
        bosearchview.searchView.searchForm.model.set({
          "id": new_id,
          "name": bosearchview.searchView.model.get("bo_type_name")
        });
        bosearchview.searchView.searchForm.model
            .fetch({reset:true,silent:true})
            .then(function() {
              if (bosearchview.resultView
                  && bosearchview.resultView.collection
                  && bosearchview.resultView.collection.searchedParams) {
                // if we already have a result, get values for search fields from there
                var searchData = bosearchview.searchView.searchForm.model.get("data"),
                    keysSearchData = _.keys(searchData),
                    searchedParams = bosearchview.resultView.collection.searchedParams,
                    nsearchData = keysSearchData.length,
                    nsearchedParams = _.keys(searchedParams).length,
                    matchKeyCount = _.reduce(searchData,function(count,val,key){
                      return (key in searchedParams) ? count + 1 : count;
                    },0);
                // but do this only if at least half of the keys from last search exist in new
                // search form as well. Otherwise we consider both as too different and showing
                // the last result for the new search form looks strange.
                // but in case of zero search fields we have to check the plain difference between
                // last and current search fields
                if (( matchKeyCount>0 && matchKeyCount>=keysSearchData.length/2 ) || ( nsearchData === nsearchedParams) ) {
                  // extend search data an render search form with it
                  _.extend(searchData,_.pick(searchedParams,keysSearchData));
                  if (bosearchview.resultView.resultTable) {
                    var row_id = bosearchview.model.get("row_id");
                    if (row_id && bosearchview.resultView.resultTable.collection.get(row_id)) {
                      bosearchview.resultView.resultTable.setSelection([row_id]);
                    } else {
                      bosearchview.resultView.resultTable.clearSelection();
                    }
                  }
                } else {
                     var oColl = bosearchview.resultView.collection;
                     delete bosearchview.resultView.collection;
                     if (oColl){
                       oColl.stopListening();
                       bosearchview.resultView.stopListening(oColl);
                     }
                  bosearchview.resultView.render();
                }
              }
              bosearchview.searchView.searchForm.render();
              bosearchview.searchView.searchForm.$el.show();
            }, function() {
              bosearchview.searchView.searchForm.$el.show();
            });
      }
    }

  });

  _.extend(BusinessObjectSearchView.prototype, LayoutViewEventsPropagationMixin);

  return BusinessObjectSearchView;
});




/**
 * Created by stefang on 05.04.2016.
 */
csui.define('xecmpf/controls/bosearch/bosearch.dialog.controller',['csui/lib/jquery',
  'csui/lib/underscore',
  'csui/lib/marionette',
  'xecmpf/controls/bosearch/bosearch.view'
], function ($, _,
  Marionette,
  BoSearchView
) {

  var BoSearchDialogController = Marionette.Controller.extend({

    constructor: function BoSearchDialogController(options) {
      Marionette.Controller.prototype.constructor.apply(this, arguments);

      this.listenTo(this.options.boSearchModel, "reference:search", this._referenceSearchOpen);
      this.listenTo(this.options.boSearchModel, "boresult:select", this._boresultSelect);
      this.listenTo(this.options.boSearchModel, "reference:selected", this._referenceSelected);
      this.listenTo(this.options.boSearchModel, "reference:rejected", this._referenceRejected);
      this.listenTo(this.options.boSearchModel, "bosearch:cancel", this._referenceSearchCanceled);
    },

    _transitionEnd: _.once(
      function () {
        var transitions = {
            transition: 'transitionend',
            WebkitTransition: 'webkitTransitionEnd',
            MozTransition: 'transitionend',
            OTransition: 'oTransitionEnd otransitionend'
          },
          element = document.createElement('div'),
          transition;
        for (transition in transitions) {
          if (typeof element.style[transition] !== 'undefined') {
            return transitions[transition];
          }
        }
      }
    ),

    _referenceSearchOpen: function () {
      this._showSearchView();
    },

    _boresultSelect: function () {
      this._showModalContent(); // also shows blocking circle
    },

    _referenceSelected: function () {
      this._hideSearchView();
    },

    _referenceRejected: function () {
      this._hideModalContent();
    },

    _referenceSearchCanceled: function () {
      this._showModalContent();
      this._hideSearchView();
    },

    _hideSearchView: function () {
      if (this.options.mode === "workspace_reference_create") {
        if (this.options.containerType === "side-panel" && this.options.sidePanel) {
          this.options.sidePanel.$el.find('.csui-sidepanel-container').removeClass('xecmpf-bosearch-opened');
        }
      }
      if (this.options.mode === "workspace_reference_edit") {
        this.bosearchview.$el.parent().removeClass('cs-item-action-metadata');
      }
      if (this.options.mode === "business_attachment_add") {
        this.bosearchview.$el.parent().removeClass('cs-item-action-metadata');
      }
      this.modalcontent.removeClass('conws-bosearch-showing');
      this.bosearchview.$el.detach();
    },

    _showModalContent: function () {
      if (this.options.mode === "workspace_reference_create") {
        if (this.options.containerType === "dialog") {
          this.modalcontent.find(">.binf-modal-header .cs-close").show();
          this.modalcontent.find(">.binf-modal-body").show();
          this.modalcontent.find(">.binf-modal-footer").show();
        }
      }
      if (this.options.mode === "workspace_reference_edit") {
        this.modalcontent.find(">.metadata-content-wrapper").show();
        this.modalcontent.find(">.metadata-wrapper .metadata-sidebar .cs-content").show();
        this.modalcontent.find(">.metadata-wrapper .metadata-content .metadata-content-wrapper").show();
      }
      if (this.options.mode === "business_attachment_add") {
        this.modalcontent.find(">.metadata-content-wrapper").show();
        this.modalcontent.find(">.metadata-wrapper .metadata-sidebar .cs-content").show();
        this.modalcontent.find(">.metadata-wrapper .metadata-content .metadata-content-wrapper").show();
      }
    },

    _hideModalContent: function () {
      if (this.options.mode === "workspace_reference_create") {
        if (this.options.containerType === "dialog") {
          this.modalcontent.find(">.binf-modal-header .cs-close").hide();
          this.modalcontent.find(">.binf-modal-body").hide();
          this.modalcontent.find(">.binf-modal-footer").hide();
        }
      }
      if (this.options.mode === "workspace_reference_edit") {
        this.modalcontent.find(">.metadata-content-wrapper").hide();
        this.modalcontent.find(">.metadata-wrapper .metadata-sidebar .cs-content").hide();
        this.modalcontent.find(">.metadata-wrapper .metadata-content .metadata-content-wrapper").hide();
      }
      if (this.options.mode === "business_attachment_add") {
        this.modalcontent.find(">.metadata-content-wrapper").hide();
        this.modalcontent.find(">.metadata-wrapper .metadata-sidebar .cs-content").hide();
        this.modalcontent.find(">.metadata-wrapper .metadata-content .metadata-content-wrapper").hide();
      }
    },

    _showSearchView: function () {
      var options = this.options || {};

      this.modalcontent = $(this.options.htmlPlace);
      this.modalcontent.addClass('conws-bosearch-beforeshow');

      //if (this.bosearchview) {
        // in order to show last search result, after it was already searched for in the dialog,
        // do not delete view, just show it. it is registered on the event too and updates itself.
        // this.bosearchview.destroy();
        // delete this.bosearchview;
      //}
      if (!this.bosearchview) {
        this.bosearchview = new BoSearchView({
          model: this.options.boSearchModel,
          context: this.options.context,
          multipleSelect: this.options.multipleSelect,
          disableItemsWithWorkspace: this.options.disableItemsWithWorkspace,
          title: this.options.title
        });
        this.bosearchview.render();
        this.bosearchview.$el.addClass(this.options.mode);
        if (this.options.mode === "workspace_reference_create") {
          if (options.containerType === "dialog") {
            this.bosearchview.$el.addClass('csui-content-without-header');
          }
        }
        if (this.options.mode === "workspace_reference_edit") {
          this.bosearchview.$el.addClass('csui-content-without-header');
          this.bosearchview.$el.find('.conws-bosearch-wrapper').addClass('binf-modal-content');
        }
        if (this.options.mode === "business_attachment_add") {
          this.bosearchview.$el.addClass('csui-content-without-header');
          this.bosearchview.$el.find('.conws-bosearch-wrapper').addClass('binf-modal-content');
          // SAPRM-9320:
          // space for attach button is dependent from metadata mapping of bus. attachment
          //this.bosearchview.$el.find('.conws-boresultlist').addClass('conws-with-attachbtn');
        }
      }

      this.modalcontent.append(this.bosearchview.$el);
      if (this.options.mode === "workspace_reference_create") {
        if (options.containerType === "side-panel" && options.sidePanel) {
          options.sidePanel.$el.find('.csui-sidepanel-container').addClass('xecmpf-bosearch-opened');
        }
      }
      if (this.options.mode === "workspace_reference_edit") {
        this.bosearchview.$el.parent().addClass('cs-item-action-metadata');
      }
      if (this.options.mode === "business_attachment_add") {
        this.bosearchview.$el.parent().addClass('cs-item-action-metadata');
      }

      // read a property, so browser updates DOM and element is at start position
      this.bosearchview.$el.position();

      this.bosearchview.triggerMethod('dom:refresh');

      var that = this;
      this.bosearchview.$el.one(this._transitionEnd(), function () {
        that.modalcontent.removeClass("conws-bosearch-animating");
        that.modalcontent.addClass('conws-bosearch-showing');
        that._hideModalContent();
      });
      this.modalcontent.addClass('conws-bosearch-animating');
      this.modalcontent.removeClass('conws-bosearch-beforeshow');
    }

  });

  return BoSearchDialogController;
});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/property.panels/reference/impl/reference.panel',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"bo_id") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.program(4, data, 0),"loc":{"start":{"line":10,"column":4},"end":{"line":16,"column":11}}})) != null ? stack1 : "");
},"2":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "      <div class=\"conws-reference-override-note\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"change_note") || (depth0 != null ? lookupProperty(depth0,"change_note") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"change_note","hash":{},"loc":{"start":{"line":11,"column":49},"end":{"line":11,"column":64}}}) : helper)))
    + "\r\n        <span>"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"remove_note") || (depth0 != null ? lookupProperty(depth0,"remove_note") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"remove_note","hash":{},"loc":{"start":{"line":12,"column":14},"end":{"line":12,"column":29}}}) : helper)))
    + "</span>\r\n      </div>\r\n";
},"4":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "      <div class=\"conws-reference-override-note\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"add_note") || (depth0 != null ? lookupProperty(depth0,"add_note") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"add_note","hash":{},"loc":{"start":{"line":15,"column":49},"end":{"line":15,"column":61}}}) : helper)))
    + "</div>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"conws-reference-panel binf-row alpaca-field\" id=\"xecmpf-reference-panel\">\r\n  <div class=\"alpaca-container-label\">\r\n    <h3>"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"title") || (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"title","hash":{},"loc":{"start":{"line":3,"column":8},"end":{"line":3,"column":17}}}) : helper)))
    + "</h3>\r\n  </div>\r\n  <div class=\"conws-reference-initial\">\r\n  </div>\r\n  <div class=\"conws-reference-replace\">\r\n  </div>\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"change_reference") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"loc":{"start":{"line":9,"column":2},"end":{"line":17,"column":9}}})) != null ? stack1 : "")
    + "</div>";
}});
Handlebars.registerPartial('xecmpf_controls_property.panels_reference_impl_reference.panel', t);
return t;
});
/* END_TEMPLATE */
;

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/property.panels/reference/impl/reference.panel-initial',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "  <div class=\"conws-label-search\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"search_button_label") || (depth0 != null ? lookupProperty(depth0,"search_button_label") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"search_button_label","hash":{},"loc":{"start":{"line":2,"column":34},"end":{"line":2,"column":57}}}) : helper)))
    + "</div>\r\n  <button type=\"button\" class=\"binf-btn binf-btn-default search\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"search_button_title") || (depth0 != null ? lookupProperty(depth0,"search_button_title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"search_button_title","hash":{},"loc":{"start":{"line":3,"column":65},"end":{"line":3,"column":88}}}) : helper)))
    + "</button>\r\n";
},"3":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "  <div  class=\"conws-reference-override-note\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"cannot_complete_business_reference") || (depth0 != null ? lookupProperty(depth0,"cannot_complete_business_reference") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"cannot_complete_business_reference","hash":{},"loc":{"start":{"line":5,"column":46},"end":{"line":5,"column":84}}}) : helper)))
    + "</div>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"complete_reference") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"loc":{"start":{"line":1,"column":0},"end":{"line":6,"column":7}}})) != null ? stack1 : "");
}});
Handlebars.registerPartial('xecmpf_controls_property.panels_reference_impl_reference.panel-initial', t);
return t;
});
/* END_TEMPLATE */
;

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/property.panels/reference/impl/reference.panel-replace',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "  <div class=\"conws-reference-buttons\">\r\n    <div class=\"conws-label-buttons\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"reference_buttons_label") || (depth0 != null ? lookupProperty(depth0,"reference_buttons_label") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"reference_buttons_label","hash":{},"loc":{"start":{"line":4,"column":37},"end":{"line":4,"column":64}}}) : helper)))
    + "</div>\r\n\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"allow_remove_reference_from_create") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"loc":{"start":{"line":7,"column":4},"end":{"line":9,"column":11}}})) != null ? stack1 : "")
    + "\r\n    <button type=\"button\" class=\"binf-btn binf-btn-default replace\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"replace_button_title") || (depth0 != null ? lookupProperty(depth0,"replace_button_title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"replace_button_title","hash":{},"loc":{"start":{"line":11,"column":68},"end":{"line":11,"column":92}}}) : helper)))
    + "</button>\r\n\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"allow_remove_reference_from_edit") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"loc":{"start":{"line":15,"column":4},"end":{"line":17,"column":11}}})) != null ? stack1 : "")
    + "\r\n  </div>\r\n";
},"2":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "      <button type=\"button\" class=\"binf-btn binf-btn-default remove\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"remove_button_title") || (depth0 != null ? lookupProperty(depth0,"remove_button_title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"remove_button_title","hash":{},"loc":{"start":{"line":8,"column":69},"end":{"line":8,"column":92}}}) : helper)))
    + "</button>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"conws-reference-metadata\"></div>\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"change_reference") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"loc":{"start":{"line":2,"column":0},"end":{"line":20,"column":7}}})) != null ? stack1 : "");
}});
Handlebars.registerPartial('xecmpf_controls_property.panels_reference_impl_reference.panel-replace', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/controls/property.panels/reference/impl/reference.panel',[],function(){});
csui.define('xecmpf/controls/property.panels/reference/impl/reference.panel.view',[
  'csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/backbone',
  'csui/lib/marionette',
  'csui/utils/log',
  'csui/controls/form/form.view',
  'csui/utils/base',
  'csui/dialogs/modal.alert/modal.alert',
  'xecmpf/controls/bosearch/bosearch.model',
  'xecmpf/controls/bosearch/bosearch.dialog.controller',
  'csui/behaviors/keyboard.navigation/tabable.region.behavior',
  'csui/controls/globalmessage/globalmessage',
  'hbs!xecmpf/controls/property.panels/reference/impl/reference.panel',
  'hbs!xecmpf/controls/property.panels/reference/impl/reference.panel-initial',
  'hbs!xecmpf/controls/property.panels/reference/impl/reference.panel-replace',
  'i18n!xecmpf/controls/property.panels/reference/impl/nls/lang',
  'css!xecmpf/controls/property.panels/reference/impl/reference.panel'
], function (_, $, Backbone, Marionette, log, FormView,
  base, ModalAlert,
  BoSearchModel,
  BoSearchDialogController,
  TabableRegionBehavior, GlobalMessage, template, initialtmpl, replacetmpl, lang) {
  'use strict';

  var ReferenceInitialView = Marionette.ItemView.extend({

    className: "conws-reference reference-initial",

    template: initialtmpl,

    constructor: function ReferenceInitialView(options) {
      Marionette.ItemView.prototype.constructor.apply(this, arguments);
    },

    ui: {
      searchButton: '.binf-btn.search'
    },

    triggers: {
      "click .binf-btn.search": "referencetab:search"
    },

    templateHelpers: function () {
      var bo_ref = this.options.actionContext.workspaceReference,
        bo_type_name = bo_ref && bo_ref.get("bo_type_name"),
        ext_system_name = bo_ref && bo_ref.get("ext_system_name");
      return {
        search_button_label: _.str.sformat(lang.referenceSearchButtonLabel, bo_type_name, ext_system_name),
        search_button_title: lang.referenceSearchButtonTitle,
        complete_reference: bo_ref.get("complete_reference"),
        cannot_complete_business_reference: lang.cannotCompleteBusinessReference
      };
    }
  });

  var ReferenceReplaceView = Marionette.LayoutView.extend({

    className: "conws-reference reference-replace",

    template: replacetmpl,

    constructor: function ReferenceReplaceView(options) {
      Marionette.LayoutView.prototype.constructor.apply(this, arguments);
    },

    ui: {
      replaceButton: '.binf-btn.replace'
    },

    triggers: {
      "click .binf-btn.remove": "referencetab:remove",
      "click .binf-btn.replace": "referencetab:replace"
    },

    regions: {
      metadataRegion: '.conws-reference-metadata'
    },

    templateHelpers: function () {
      var bo_ref = this.options.actionContext.workspaceReference,
        bo_type_name = bo_ref && bo_ref.get("bo_type_name"),
        ext_system_name = bo_ref && bo_ref.get("ext_system_name");
      return {
        allow_remove_reference_from_create: this.options.actionContext.mode === "workspace_reference_create",
        allow_remove_reference_from_edit: this.options.actionContext.mode === "workspace_reference_edit",
        remove_button_title: lang.referenceRemoveButtonTitle,
        replace_button_title: lang.referenceReplaceButtonTitle,
        reference_buttons_label: _.str.sformat(lang.referenceSearchButtonLabel, bo_type_name, ext_system_name),
        change_reference: bo_ref.get("change_reference")
      };
    },

    onRender: function () {
      var formData, formOptions, formSchema;
      if (this.options.actionContext.mode === "workspace_reference_create") {
        formData = this.options.actionContext.workspaceReference.get("data") || {};
        formOptions = this.options.actionContext.workspaceReference.get("options") || {};
        formSchema = this.options.actionContext.workspaceReference.get("schema") || {};
      }
      if (this.options.actionContext.mode === "workspace_reference_edit") {
        formData = {
          BOID: this.options.actionContext.workspaceReference.get("bo_id")
        };
        formOptions = {
          fields: {
            BOID: {}
          }
        };
        formSchema = {
          properties: {
            BOID: {
              readonly: true,
              required: false,
              title: lang.businessObjectIdLabel,
              type: "string"
            }
          }
        };
      }
      if (formData && formOptions && formSchema) {
        this.formModel = new Backbone.Model({
          data: formData,
          options: formOptions,
          schema: formSchema
        });
        this.metdataForm = new FormView({
          model: this.formModel,
          context: this.options.context
        });
        this.metadataRegion.show(this.metdataForm);
      }
    }
  });

  var ReferencePanelView = Marionette.LayoutView.extend({

    className: 'conws-reference reference-panel cs-form cs-form-create',

    template: template,

    regions: {
      initialRegion: '.conws-reference-initial',
      replaceRegion: '.conws-reference-replace'
    },

    behaviors: {
      TabableRegion: {
        behaviorClass: TabableRegionBehavior
      }
    },

    constructor: function ReferencePanelView(options) {
      Marionette.LayoutView.prototype.constructor.apply(this, arguments);

      this.options.actionContext.referencePanelView = this;
      this.actionContext = _.clone(this.options.actionContext); // Avoid sharing actionContext from sidePanel

      var viewContext, anchor, containerType;
      if (this.options.mode === "create") {
        this.actionContext.mode = "workspace_reference_create";
        viewContext = this.options.metadataView;
        var forms = options && options.fetchedModels,
          formCollection = forms && forms.formCollection,
          formOptions = formCollection && formCollection.options,
          addItemController = formOptions && formOptions.metadataAddItemController,
          sidePanel = addItemController && addItemController.sidePanel;
        // as agreed with csui team get dialog from controller and from there get the overlay area
        if (addItemController.dialog) {
          containerType = 'dialog';
          anchor = addItemController.dialog.$(".binf-modal-content");
        } else if (addItemController.sidePanel) {
          containerType = 'side-panel';
          anchor = addItemController.sidePanel.$(".csui-sidepanel-body");
        }
      } else if (this.options.mode === "update") {
        this.actionContext.mode = "workspace_reference_edit";
        if (this.options.metadataView && this.options.metadataView.options.metadataNavigationView) {
          viewContext = this.options.metadataView.options.metadataNavigationView;
        } else {
          viewContext = this.options.metadataView;
        }
        // SAPRM-9072. Removed .cs-perspective-panel from css selector. This panel is not available
        // in integration scenarios.
        anchor = ".cs-metadata:has(> .metadata-content-wrapper)";
      }
      if (viewContext !== this.actionContext.viewContext) {
        delete this.actionContext.boSearchModel;
        delete this.actionContext.boSearchDialogController;
        this.actionContext.viewContext = viewContext;
      }

      var bo_ref = this.actionContext.workspaceReference;
      if (!this.actionContext.boSearchModel) {
        this.actionContext.boSearchModel = new BoSearchModel({
          bo_type_id: bo_ref.get("bo_type_id"),
          bo_type_name: bo_ref.get("bo_type_name"),
          row_id: bo_ref.get("row_id")
        });
      } else {
        this.actionContext.boSearchModel.set({
          bo_type_id: bo_ref.get("bo_type_id"),
          bo_type_name: bo_ref.get("bo_type_name"),
          row_id: bo_ref.get("row_id")
        });
      }

      if (!this.actionContext.boSearchDialogController) {
        this.actionContext.boSearchDialogController = new BoSearchDialogController({
          mode: this.actionContext.mode,
          context: this.options.context,
          htmlPlace: anchor,
          containerType: containerType,
          sidePanel: sidePanel,
          boSearchModel: this.actionContext.boSearchModel,
          disableItemsWithWorkspace: true
        });
      } else {
        this.actionContext.boSearchDialogController.options.mode = this.actionContext.mode;
        this.actionContext.boSearchDialogController.options.htmlPlace = anchor;
      }

      this.listenTo(this.actionContext.boSearchModel, "boresult:select", this._replaceReference);
      this.listenTo(this.actionContext.boSearchModel, "bosearch:cancel", this._cancelSearch);
      this.listenTo(this.actionContext.boSearchModel, "change:bo_type_name", _.bind(function () {
        this.actionContext.workspaceReference.set("by_type_name", this.actionContext.boSearchModel.get("bo_type_name"));
        this.render();
      }, this));

      this.listenTo(this.actionContext.workspaceReference, "error", function (model, response, options) {
        var isRemoveError = (options && options.invoker && options.invoker === 'remove_bo_ref');
        var errmsg;
        if (isRemoveError) {
          errmsg = response && (new base.Error(response)).message || lang.errorRemovingWorkspaceReference;
          log.error("Removing the workspace reference failed: {0}", errmsg) && console.error(log.last);
        } else {
          errmsg = response && (new base.Error(response)).message || lang.errorUpdatingWorkspaceReference;
          log.error("Updating the workspace reference failed: {0}", errmsg) && console.error(log.last);
        }
        ModalAlert.showError(errmsg);
      });

      this.listenTo(options.originatingView, "render:forms", this._formsRendered);
      if (this.actionContext.mode === "workspace_reference_create") {
        this.actionContext.scrollToPanel = true;
        this.actionContext.focusButton = true;
      }

      // we want to reuse the action context from a previous panel
      _.extend(this.options.actionContext, this.actionContext);
    },

    onDestroy: function () {
      //console.log("ReferencePanelView destroy called ",this.cid);
      if (this === this.actionContext.referencePanelView) {
        delete this.actionContext.referencePanelView;
      }
    },

    templateHelpers: function () {
      return {
        title: lang.referenceTabTitle,
        bo_id: this.actionContext.workspaceReference.get("bo_id"),
        add_note: lang.referencePanelAddNote,
        change_note: lang.referencePanelChangeNote,
        remove_note: lang.referencePanelRemoveNote,
        change_reference: this.actionContext.workspaceReference.get("change_reference")
      };
    },

    currentlyFocusedElement: function () {
      //console.log("currently focused element of",this.cid,"count",this.$el.find('button').length);
      //return this.$el.find('button');
      var el;
      if (this.actionContext.workspaceReference.get("bo_id")) {
        el = this.replaceView && this.replaceView.ui.replaceButton;
      } else {
        el = this.initialView && this.initialView.ui.searchButton;
      }
      if (el && el.attr && el.prop) {
        log.debug("currently focused element of {0} count {1} class {2}", this.cid, el ? el.length : "no el", el.attr('class')) && console.log(log.last);
        return el;
      } else {
        return undefined;
      }
    },

    // The view is rendered whenever the model changes.
    onRender: function () {
      // LayoutView destroys views on rendering, so we must create them every time on rendering
      if (this.actionContext.workspaceReference.get("bo_id")) {
        delete this.initialView;
        this.replaceView = new ReferenceReplaceView(this.options);
        this.listenTo(this.replaceView, "referencetab:remove", this._removeReference);
        this.listenTo(this.replaceView, "referencetab:replace", this._triggerSearch);
        this.replaceRegion.show(this.replaceView);
      } else {
        delete this.replaceView;
        this.initialView = new ReferenceInitialView(this.options);
        this.listenTo(this.initialView, "referencetab:search", this._triggerSearch);
        this.initialRegion.show(this.initialView);
      }
    },

    _triggerSearch: function () {
      log.debug("trigger reference:search") && console.log(log.last);
      this.actionContext.boSearchModel.trigger("reference:search");
    },

    _removeReference: function () {
      log.debug("clear reference") && console.log(log.last);
      if (this.actionContext.mode === "workspace_reference_create") {
        this._refetchForms({
          "data": undefined,
          "options": {},
          "schema": {},
          "bo_id": undefined,
          "row_id": undefined
        });
      } else if (this.actionContext.mode === "workspace_reference_edit") {
        var self = this;
        var deferred = $.Deferred();
        // Ask if the user agrees to proceed right now or not
        ModalAlert.confirmQuestion(_.str.sformat(lang.removeBOReferenceAlertDescription, this.actionContext.workspaceReference.get('bo_id')),
            lang.removeBOReferenceAlertTitle)
          .done(function (result) {
            var bo_ref = self.actionContext.workspaceReference;
            bo_ref.destroy({
                wait: true,
                invoker: 'remove_bo_ref'
              })
              .done(function (data, status) {
                GlobalMessage.showMessage('success', lang.removeBOReferenceSuccessMessage);
                if (self.options.hasMetadataProperties === false) { // XECMPF-4045, when reference panel is rendered solely
                  bo_ref.set("bo_id", undefined);
                  bo_ref.fetch().then(function () {
                    self.render();
                  });
                } else {
                  self.actionContext.viewContext.triggerMethod("metadata:close");
                }
                deferred.resolve();
              })
              .fail(function (data, status, error) {
                deferred.reject(data.responseJSON.error);
              });
            return deferred.promise();
          });
      }
    },

    _cancelSearch: function () {
      this._focusButton({
        cancelSearch: true
      });
    },

    _replaceReference: function (selectEventInfo) {
      log.debug("set reference") && console.log(log.last);
      if (selectEventInfo && selectEventInfo.selectedItems &&
        selectEventInfo.selectedItems.length > 0 &&
        selectEventInfo.selectedItems[0]) {
        var selectedObject = selectEventInfo.selectedItems[0];
        var formData = {},
          formFields = {},
          formProperties = {},
          collection = selectedObject.collection,
          columnDefinitions = collection.columns,
          tableColumns = collection.tableColumns,
          sortedColumns = tableColumns.toArray().sort(function (a, b) {
            return a.get("sequence") - b.get("sequence");
          });
        _.each(sortedColumns, function (tc) {
          var key = tc.get("key"),
            col = columnDefinitions.get(key),
            name = col.get("fieldName");
          formData[name] = selectedObject.get(key);
          formFields[name] = {};
          formProperties[name] = {
            readonly: true,
            required: false,
            title: col.get("fieldLabel"),
            type: "string"
          };
        });
        this._refetchForms({
          "data": formData,
          "options": {
            fields: formFields
          },
          "schema": {
            properties: formProperties
          },
          "bo_id": selectedObject.get("businessObjectId"),
          "row_id": selectedObject.get("id")
        }, "select");
      } else {
        this.render();
        this.actionContext.boSearchModel.trigger("reference:selected");
        this._scrollToPanel();
        this._focusButton();
      }
    },

    _getAllValues: function () {

      var data = {},
        metadataView = this.options && this.options.metadataView;
      if (metadataView) {
        data = {
          "name": metadataView.metadataHeaderView.getNameValue(),
          "type": metadataView.options.model.get('type'),
          "parent_id": metadataView.options.model.get('parent_id')
        };
        var formsValues = metadataView.metadataPropertiesView.getFormsValues();
        _.extend(data, formsValues);
      }

      return data;
    },

    _refetchForms: function (attributes, mode) {
      // and refetch all forms from server to get default values depending on bo_id
      var self = this,
        bo_ref = this.actionContext.workspaceReference,
        bo_id = attributes.bo_id,
        actionContext = this.actionContext,
        originatingView = this.options.originatingView,
        forms = this.options.fetchedModels;
      if (actionContext.mode === "workspace_reference_create") {
        var formCollection = forms.formCollection;
        if (bo_id) {
          formCollection.bo_type_id = bo_ref.get("bo_type_id");
          formCollection.bo_id = bo_id;
        } else {
          delete formCollection.bo_type_id;
          delete formCollection.bo_id;
        }
        formCollection.formsValues = this._getAllValues();
        formCollection.formsSchema = formCollection.serverForms;
        forms.fetch().then(function () {
            // on success, set attributes and options for actions after rendering
            bo_ref.set(attributes);
            if (mode === "select") {
              originatingView.once("render:forms", function () {
                self.actionContext.boSearchModel.trigger("reference:selected");
              });
            }
            actionContext.scrollToPanel = true;
            actionContext.focusButton = true;
          },
          function () {
            //in case of error do not set attributes. bo_ref.set(attributes);
            if (mode === "select") {
              self.actionContext.boSearchModel.trigger("reference:rejected");
            }
          }
        );
      } else if (actionContext.mode === "workspace_reference_edit") {
        var bo_id_old = bo_ref.get("bo_id"),
          node = this.options.node;
        bo_ref.set("bo_id", bo_id);
        bo_ref.save({}, {
            wait: true
          })
          .then(function () {
            node.fetch().then(function () {
                if (forms) {
                  forms.fetch().then(function () {
                      bo_ref.set(attributes);
                      if (mode === "select") {
                        originatingView.once("render:forms", function () {
                          self.actionContext.boSearchModel.trigger("reference:selected");
                        });
                      }
                      actionContext.scrollToPanel = true;
                      actionContext.focusButton = true;
                    },
                    function () {
                      //in case of error do not set attributes. bo_ref.set(attributes);
                      bo_ref.set("bo_id", bo_id_old);
                      if (mode === "select") {
                        self.actionContext.boSearchModel.trigger("reference:rejected");
                      }
                    });
                } else if (self.options.hasMetadataProperties === false) { // XECMPF-4045, when reference panel is rendered solely
                  bo_ref.set(attributes);
                  self.actionContext.boSearchModel.trigger("reference:selected");
                  bo_ref.fetch().then(function () {
                    self.render();
                  });
                }
              },
              function () {
                //in case of error do not set attributes. bo_ref.set(attributes);
                bo_ref.set("bo_id", bo_id_old);
                if (mode === "select") {
                  self.actionContext.boSearchModel.trigger("reference:rejected");
                }
              });
          }, function () {
            // on error: restore to state before save
            bo_ref.set("bo_id", bo_id_old);
            if (mode === "select") {
              self.actionContext.boSearchModel.trigger("reference:rejected");
            }
          });
      } else {
        bo_ref.set(attributes);
        this.render();
        if (mode === "select") {
          self.actionContext.boSearchModel.trigger("reference:selected");
        }
        this._scrollToPanel();
        this._focusButton();
      }
    },

    // scroll panel to be visible
    _scrollToPanel: function () {
      var originatingView = this.options && this.options.originatingView,
        tabLinks = originatingView && originatingView.tabLinks;
      if (tabLinks) {
        var refLink;
        tabLinks.children.each(function (tabLink) {
          if (tabLink.model.id === "conws-reference") {
            refLink = tabLink;
          }
        });
        if (refLink) {
          refLink.activate();
        }
      }
    },

    // set focus on buttton, if desired
    _focusButton: function (eventOptions) {
      var metadataView = this.options && this.options.metadataView,
        headerView = metadataView && metadataView.metadataHeaderView,
        nameView = headerView && headerView.metadataItemNameView;
      if (!nameView || nameView.readonly || nameView.model && nameView.model.get("name") ||
        (eventOptions && eventOptions.cancelSearch)) {
        if (this.actionContext.workspaceReference.get("bo_id")) {
          var butn;
          if (this.replaceView) {
            butn = $(this.replaceView.ui.replaceButton);
            butn.trigger("focus");
          }
        } else {
          if (this.initialView) {
            butn = $(this.initialView.ui.searchButton);
            butn.trigger("focus");
          }
        }
        var originatingView = this.options.originatingView, href;
        if ( originatingView !== undefined ) {
          href = originatingView.$el.find("div[id='conws-reference']");
        }
        if (href && href.length > 0) {
          var hrefTop = href[0].offsetTop;
          if (butn && butn.length > 0) {
            var butnTop = butn[0].offsetTop;
            var butnHeight = butn.height();
            var panelHeight = originatingView.tabContent.$el.height();
            // adjust only, if button is not visible anyway
            if (butnTop + butnHeight > hrefTop + panelHeight) {
              var extraTopOffset = Math.max(originatingView.getOption('extraScrollTopOffset') || 0, 5);
              var scrollTop = butnTop + butnHeight - panelHeight + extraTopOffset;
              // var curScrollTop = originatingView.tabContent.$el.scrollTop();
              // console.log("changing scrollTop from "+curScrollTop+" to "+scrollTop);
              originatingView.tabContent.$el.animate({
                scrollTop: scrollTop
              }, 300);
            }
          }
        }
      } else {
        nameView.setEditModeFocus();
      }
    },

    _formsRendered: function () {
      if (this.actionContext.scrollToPanel) {
        delete this.actionContext.scrollToPanel;
        this._scrollToPanel();
      }
      if (this.actionContext.focusButton) {
        delete this.actionContext.focusButton;
        this._focusButton();
      }
    },

    // This view is displayed also during the node creation;
    // because a form view is expected, this view implements a partial FormView interface too

    validate: function () {
      return true;
    },

    getValues: function () {
      // These values will be merged into the creational object posted
      // to the server; if the model has 'role_name' property defined,
      // the properties will be posted nested in that role

      return {
        bo_id: this.actionContext.workspaceReference.get("bo_id"),
        bo_type_id: this.actionContext.workspaceReference.get("bo_type_id")
      };
    },

    hideNotRequired: function (hide) {
      return true;
    }

  });

  return ReferencePanelView;

});
csui.define('xecmpf/widgets/boattachments/impl/boattachments.factory',['module', 'csui/lib/underscore',  'csui/lib/jquery', 'csui/lib/backbone',
    'csui/utils/contexts/factories/factory',
    'csui/utils/contexts/factories/node',
    'xecmpf/widgets/boattachments/impl/boattachments.model',
    'xecmpf/models/boattachmentcontext/attachmentcontext.busobjinfo.factory'

], function (module, _, $, Backbone,
             CollectionFactory,
             NodeModelFactory,
             BOAttachmentCollection,
             AttachmentContextBusinessObjectInfoFactory) {

    var BOAttachmentCollectionFactory = CollectionFactory.extend({

        propertyPrefix: 'boAttachments',

        constructor: function BOAttachmentCollectionFactory(context, options) {
            CollectionFactory.prototype.constructor.apply(this, arguments);

            var boAttachments = this.options.boAttachments || {},
                commands = boAttachments.options
                    && boAttachments.options.commands;
            if (!(boAttachments instanceof Backbone.Collection)) {

                this.property = new BOAttachmentCollection(boAttachments.models, _.extend({
                    context: context,
                    node: context.getModel(NodeModelFactory, options),
                }, boAttachments.options, module.config().options, {
                    autoreset: true,
                    commands: commands.getAllSignatures()
                }, options));
            }
        },

        fetch: function (options) {
            return this.property.fetch(options);
        }

    });

    return BOAttachmentCollectionFactory;

});


csui.define('xecmpf/widgets/boattachments/impl/boattachment.table/toolbaritems',[
    'module',
    'csui/lib/underscore',
    'csui/controls/toolbar/toolitem.model',
    'csui/controls/toolbar/toolitems.factory',
    'i18n!xecmpf/widgets/boattachments/impl/nls/lang',
    'i18n!csui/controls/tabletoolbar/impl/nls/localized.strings',
    'csui-ext!xecmpf/widgets/boattachments/toolbaritems'
], function (module, _, ToolItemModel, ToolItemsFactory, lang, _lang, extraToolItems) {

    var toolbarItems = {

        tableHeaderToolbar: new ToolItemsFactory({
                main: [
                    {signature: "Snapshot", name: lang.CommandSnapshot}
                ]
            },
            {
                maxItemsShown: 15,
                dropDownIcon: "icon icon-toolbar-more",
                lazyActions: true
            })
    };

    if (extraToolItems) {
        _.each(extraToolItems, function (moduleToolItems) {
          _.each(moduleToolItems, function (toolItems, key) {
            var targetToolbar = toolbarItems[key];
            if (!targetToolbar && key === 'otherToolbar') {
              targetToolbar = toolbarItems['tableHeaderToolbar'];
            }
            if (!targetToolbar) {
              throw new Error('Invalid target toolbar: ' + key);
            }
            _.each(toolItems, function (toolItem) {
              toolItem = new ToolItemModel(toolItem);
              targetToolbar.addItem(toolItem);
            });
          });
        });
    }

    return toolbarItems;

});

csui.define('xecmpf/widgets/boattachments/impl/boattachment.table/boattachments.columns',["csui/lib/backbone",
    "i18n!xecmpf/widgets/boattachments/impl/nls/lang"], function (Backbone, lang) {

    var TableColumnModel = Backbone.Model.extend({

        defaults: {
            key: null,  // key from the resource definitions
            sequence: 0 // smaller number moves the column to the front
        }

    });

    var TableColumnCollection = Backbone.Collection.extend({

        model: TableColumnModel,
        comparator: "sequence",
        // modelId: "key",

        getColumnKeys: function () {
            return this.pluck('key');
        },

        deepClone: function () {
            return new TableColumnCollection(
                this.map(function (column) {
                    return column.attributes;
                }));
        }

    });

    // sequence:
    // 1-100: Fixed columns
    // 500-600: Dynamic columns (custom columns in widget configuration)
    // 900-1000: Special columns at the end (favorite, like, comment)
    // Hint: if the sequence of 'name' column is changed, the focused column in workspacestable.view
    // should be also adapted with the new id.
    // Current state is tableView.accFocusedState.body.column = 1

    var tableColumns = new TableColumnCollection([
        {
            key: 'type',
            permanentColumn: true,
            sequence: 10
        },
        {
            key: 'name',
            permanentColumn: true,
            sequence: 20
        },
        {
            key: 'parent_id',
            title: lang.parent_id,
            permanentColumn: true,
            sequence: 30
        },
        {
            key: 'reserved',
            sequence: 40,
            noTitleInHeader: true,
            permanentColumn: true,
        },
        {
            key: 'modify_date',
            permanentColumn: true,
            sequence: 50
        },
        {
            key: 'version',
            sequence: 60
        },
        {
            key: 'size',
            sequence: 70
        },
        {
            key: 'create_date',
            sequence: 80
        },
        {
            key: 'createdby',
            sequence: 90
        },
        {
            key: 'modifiedby',
            sequence: 100
        },
        {
            key: 'favorite',
            sequence: 910,
            noTitleInHeader: true, // don't display a column header
            permanentColumn: true // don't wrap column due to responsiveness into details row
        }
    ]);

    return tableColumns;

});

/**
 * Created by giddamr on 3/23/2018.
 */
csui.define('xecmpf/widgets/boattachments/impl/headertoolbaritems',[
  'csui/controls/toolbar/toolitems.factory',
  'i18n!xecmpf/widgets/boattachments/impl/nls/lang'
], function (ToolItemsFactory, lang) {

  var headerToolbarItems = {
    AddToolbar: new ToolItemsFactory({
          main: [
            {
              signature: "BOAttachmentsCreate",
              name: lang.addBusinessAttachment,
              icon: "icon icon-toolbarAdd"
            }
          ]
        },
        {
          maxItemsShown: 1,
          dropDownIcon: "icon icon-toolbar-more"
        })
  };

  return headerToolbarItems;

});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/dialogheader/impl/dialogheader',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "  <div class=\"cs-close\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"dialogCloseButtonTooltip") || (depth0 != null ? lookupProperty(depth0,"dialogCloseButtonTooltip") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"dialogCloseButtonTooltip","hash":{},"loc":{"start":{"line":6,"column":31},"end":{"line":6,"column":59}}}) : helper)))
    + "\">\r\n    <div class=\"icon circular "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"iconRight") || (depth0 != null ? lookupProperty(depth0,"iconRight") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"iconRight","hash":{},"loc":{"start":{"line":7,"column":30},"end":{"line":7,"column":43}}}) : helper)))
    + "\" tabindex=\"0\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"ariaDialogClose") || (depth0 != null ? lookupProperty(depth0,"ariaDialogClose") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"ariaDialogClose","hash":{},"loc":{"start":{"line":7,"column":70},"end":{"line":7,"column":89}}}) : helper)))
    + "\"\r\n         role=\"button\"></div>\r\n  </div>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"left-section\"></div>\r\n<div class=\"center-section\"></div>\r\n<div class=\"right-section\"></div>\r\n\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"hideDialogClose") : depth0),{"name":"if","hash":{},"fn":container.noop,"inverse":container.program(1, data, 0),"loc":{"start":{"line":5,"column":0},"end":{"line":10,"column":7}}})) != null ? stack1 : "");
}});
Handlebars.registerPartial('xecmpf_controls_dialogheader_impl_dialogheader', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/controls/dialogheader/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});

csui.define('xecmpf/controls/dialogheader/impl/nls/root/lang',{
  dialogCloseButtonTooltip: 'Close',
  ariaDialogClose: 'Close dialog'
});



csui.define('css!xecmpf/controls/dialogheader/impl/dialogheader',[],function(){});
csui.define('xecmpf/controls/dialogheader/dialogheader.view',[
  'csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/backbone',
  'csui/lib/marionette',
  'csui/behaviors/keyboard.navigation/tabable.region.behavior',
  'hbs!xecmpf/controls/dialogheader/impl/dialogheader',
  'i18n!xecmpf/controls/dialogheader/impl/nls/lang',
  'css!xecmpf/controls/dialogheader/impl/dialogheader'
], function (_, $, Backbone, Marionette, TabableRegion, template, lang) {

  var DialogHeaderView = Marionette.LayoutView.extend({

    className: 'xecmpf-header',
    template: template,

    behaviors: {
      TabableRegion: {
        behaviorClass: TabableRegion
      }
    },

    regions: {
      LeftRegion: '.left-section',
      CenterRegion: '.center-section',
      RightRegion: '.right-section'
    },

    events: {
      'keydown': 'onKeyInView'
    },

    templateHelpers: function () {
      return {
        iconRight: !!this.options.iconRight ? this.options.iconRight : 'cs-icon-cross',
        dialogCloseButtonTooltip: lang.dialogCloseButtonTooltip,
        ariaDialogClose: lang.ariaDialogClose,
        hideDialogClose: this.options.hideDialogClose ? this.options.hideDialogClose : false
      };
    },

    constructor: function DialogHeaderView(options) {
      Marionette.LayoutView.prototype.constructor.apply(this, arguments);
    },

    onRender: function (){
      var leftView = this.options.leftView,
          centerView = this.options.centerView,
          rightView = this.options.rightView;

      if (leftView) {
        this.LeftRegion.show(leftView);
      }

      if (centerView) {
        this.CenterRegion.show(centerView);
      }

      if (rightView) {
        this.RightRegion.show(rightView);
      }
    },

    isTabable: function () {
      return this.$('*[tabindex]').length > 0;
    },

    currentlyFocusedElement: function (event) {
      var tabElements = this.$('*[tabindex]');
      if (tabElements.length) {
        tabElements.prop('tabindex', 0);
      }
      if (!!event && event.shiftKey) {
        return $(tabElements[tabElements.length - 1]);
      } else {
        return $(tabElements[0]);
      }
    },

    onLastTabElement: function (shiftTab, event) {
      // return true if focus is on last tabable element else false.
      return (shiftTab && event.target === this.$('*[tabindex]')[0]);
    },

    onKeyInView: function (event) {
      var keyCode = event.keyCode;

      //Enter/space
      if (keyCode === 13 || keyCode === 32) {
        $(event.target).trigger("click");
      }
    }

  });

  return DialogHeaderView;

});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/headertoolbar/impl/headertoolbar',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class=\"filter-toolbar\"></div>\r\n<div class=\"add-toolbar\"></div>\r\n<div class=\"other-toolbar\"></div>";
}});
Handlebars.registerPartial('xecmpf_controls_headertoolbar_impl_headertoolbar', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/controls/headertoolbar/impl/headertoolbar',[],function(){});
csui.define('xecmpf/controls/headertoolbar/headertoolbar.view',[
  'csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/backbone',
  'csui/lib/marionette',
  'csui/controls/toolbar/toolitems.filtered.model',
  'csui/controls/toolbar/toolbar.view',
  'csui/controls/toolbar/toolbar.command.controller',
  'hbs!xecmpf/controls/headertoolbar/impl/headertoolbar',
  'css!xecmpf/controls/headertoolbar/impl/headertoolbar'
], function (_, $, Backbone, Marionette, FilteredToolItemsCollection, ToolbarView,
    ToolbarCommandController, template) {

  var HeaderToolbarView = Marionette.LayoutView.extend({
    className: 'xecmpf-header-toolbar',

    template: template,

    regions: {
      FilterToolbarRegion: '.filter-toolbar',
      AddToolbarRegion: '.add-toolbar',
      OtherToolbarRegion: '.other-toolbar'
    },

    constructor: function HeaderToolbarView(options) {
      this.commands = options.commands;
      this.commandController = options.commandController ? options.commandController :
                               new ToolbarCommandController({
                                 commands: this.commands
                               });
      this.originatingView = options.originatingView ? options.originatingView : this;

      this.context = options.context;
      this.nodes = options.selectedNodes;
      this.container = options.container;
      this.collection = options.collection;
      this.addableTypes = options.addableTypes;

      this.toolbarNames = ['Filter', 'Add', 'Other'];
      this.toolbarItems = options.toolbarItems || [];

      Marionette.LayoutView.prototype.constructor.apply(this, arguments);
    },

    initialize: function (options) {
      var status = {
        context: this.context,
        nodes: this.selectedNodes,
        container: this.container,
        collection: this.collection,
        originatingView: this.originatingView,
        data: {
          addableTypes: this.addableTypes
        }
      };

      _.each(this.toolbarNames, function (toolbarName) {
        var fullToolbarName = toolbarName + 'Toolbar',
            toolItemFactory = this.toolbarItems[fullToolbarName];

        // create toolbar only if toolbar items (toolItemFactory) is defined
        if (toolItemFactory) {
          _.any(toolItemFactory.collection.models, function (model) {
            if (model.attributes.signature === 'disabled') {
              toolItemFactory.collection.remove(model);
              return true;
            }
          });

          var filteredCollection = new FilteredToolItemsCollection(
              toolItemFactory, {
                status: status,
                commands: this.commandController.commands
              });

          // create toolbar view
          var toolbarView = new ToolbarView(_.extend({
            collection: filteredCollection,
            toolbarName: toolbarName,
            originatingView: this.originatingView
          }, toolItemFactory.options));
          this[toolbarName + 'ToolbarView'] = toolbarView;

          // attach event listener for clicked toolbar items
          this.listenTo(toolbarView, 'childview:toolitem:action',
              this._toolbarItemClicked);
        }
      }, this);

    },

    onRender: function () {
      // call show on each toolbar region with the associated view
      _.each(this.toolbarNames, function (toolbarName) {
        // call show of view in region if view is instantiated
        if (this[toolbarName + 'ToolbarView']) {
          this[toolbarName + 'ToolbarRegion'].show(this[toolbarName + 'ToolbarView']);
        }
      }, this);
    },

    // This method is triggered as a nested 'childview:...' event; such
    // events always get the childView as the first argument.
    _toolbarItemClicked: function (toolItemView, args) {
      this.options.toolItemView = toolItemView;
      this.commandController.toolitemClicked(args.toolItem, this.options);
    }

  });

  return HeaderToolbarView;

});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/title/impl/title',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "  <div class=\"tile-type-icon\">\r\n    <span class=\"icon title-icon "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"icon") || (depth0 != null ? lookupProperty(depth0,"icon") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"icon","hash":{},"loc":{"start":{"line":3,"column":33},"end":{"line":3,"column":41}}}) : helper)))
    + "\" aria-hidden=\"true\"></span>\r\n  </div>\r\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"imageUrl") : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"loc":{"start":{"line":6,"column":2},"end":{"line":12,"column":9}}})) != null ? stack1 : "");
},"4":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "    <div class=\"tile-type-image "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"imageClass") || (depth0 != null ? lookupProperty(depth0,"imageClass") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"imageClass","hash":{},"loc":{"start":{"line":7,"column":32},"end":{"line":7,"column":46}}}) : helper)))
    + "\">\r\n      <span class=\"tile-type-icon tile-type-icon-img\">\r\n        <img src=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"imageUrl") || (depth0 != null ? lookupProperty(depth0,"imageUrl") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"imageUrl","hash":{},"loc":{"start":{"line":9,"column":18},"end":{"line":9,"column":30}}}) : helper)))
    + "\" alt=\"\" aria-hidden=\"true\">\r\n      </span>\r\n    </div>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"icon") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"loc":{"start":{"line":1,"column":0},"end":{"line":13,"column":7}}})) != null ? stack1 : "")
    + "\r\n<div class=\"title-name\">\r\n  <h4 class=\"title-name-block\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"title") || (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"title","hash":{},"loc":{"start":{"line":16,"column":38},"end":{"line":16,"column":47}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"title") || (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"title","hash":{},"loc":{"start":{"line":16,"column":49},"end":{"line":16,"column":58}}}) : helper)))
    + "</h4>\r\n</div>\r\n";
}});
Handlebars.registerPartial('xecmpf_controls_title_impl_title', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/controls/title/impl/title',[],function(){});
csui.define('xecmpf/controls/title/title.view',[
  'csui/lib/underscore', 'csui/lib/jquery',
  'csui/lib/backbone', 'csui/lib/marionette',
  'hbs!xecmpf/controls/title/impl/title',
  'css!xecmpf/controls/title/impl/title'
], function (_, $, Backbone, Marionette, template) {

  var TitleView = Marionette.ItemView.extend({

    className: 'title-wrapper',
    template: template,

    templateHelpers: function () {
      return {
        icon: this.options.icon,
        imageUrl: this.options.imageUrl,
        imageClass: this.options.imageClass,
        title: this.options.title
      }
    },

    constructor: function TitleView() {
      Marionette.ItemView.prototype.constructor.apply(this, arguments);
    }

  });

  return TitleView;

});



/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/boattachments/impl/boattachment.table/boattachmentstable',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class=\"xecmpf-boattachmentstable\">\r\n    <div class=\"xecmpf-alternating-toolbars\">\r\n        <div class=\"xecmpf-widget-table-header\"></div>\r\n        <div id=\"botabletoolbar\" class=\"xecmpf-rowselection-toolbar\"></div>\r\n    </div>\r\n    <div id=\"botableview\"></div>\r\n    <div id=\"bopaginationview\"></div>\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_widgets_boattachments_impl_boattachment.table_boattachmentstable', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/boattachments/impl/boattachment.table/boattachmentstable',[],function(){});
csui.define('xecmpf/widgets/boattachments/impl/boattachment.table/boattachmentstable.view',['module', 'csui/lib/jquery', 'csui/lib/underscore',
    'csui/lib/backbone', 'csui/lib/marionette', 'csui/utils/base',
    'csui/behaviors/default.action/default.action.behavior',
    'csui/utils/contexts/factories/connector',
    'csui/controls/table/table.view', 'csui/controls/pagination/nodespagination.view',
    'csui/dialogs/modal.alert/modal.alert',
    'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',
    'csui/utils/commands', 'csui/controls/table/rows/description/description.view',
    'csui/controls/globalmessage/globalmessage',
    'csui/utils/log',
    'xecmpf/widgets/boattachments/impl/boattachment.table/toolbaritems',
    'xecmpf/widgets/boattachments/impl/boattachment.table/boattachments.columns',
    'xecmpf/widgets/boattachments/impl/headertoolbaritems',
    'xecmpf/controls/dialogheader/dialogheader.view',
    'xecmpf/controls/headertoolbar/headertoolbar.view',
    'xecmpf/controls/title/title.view',
    'xecmpf/behaviors/toggle.header/toggle.header.behavior',
    'i18n!xecmpf/widgets/boattachments/impl/nls/lang',
    'hbs!xecmpf/widgets/boattachments/impl/boattachment.table/boattachmentstable',
    'css!xecmpf/widgets/boattachments/impl/boattachment.table/boattachmentstable'
], function (module, $, _, Backbone, Marionette, base,
    DefaultActionBehavior,
    ConnectorFactory,
    TableView, PaginationView,
    ModalAlert,
    LayoutViewEventsPropagationMixin,
    commands, DetailsRowView,
    GlobalMessage, log,
    toolbarItems,
    AttachmentsColumns,
    HeaderToolbarItems,
    HeaderView,
    HeaderToolbarView,
    TitleView,
    ToggleHeaderBehavior,
    lang, template) {

    var config = module.config();

    _.defaults(config, {
        defaultPageSize: 30,
        orderBy: {
            sortColumn: '{name}',
            sortOrder: 'asc'
        }
    });

    var BOAttachmentTableView = Marionette.LayoutView.extend({

        className: 'xecmpf-boattachments-table',

        template: template,

        regions: {
            tableHeaderRegion: '.xecmpf-widget-table-header',
            tableRegion: '#botableview',
            paginationRegion: '#bopaginationview'
        },

        behaviors: {
            DefaultAction: {
                behaviorClass: DefaultActionBehavior
            },
            ToggleHeader: {
                behaviorClass: ToggleHeaderBehavior,
                tableHeader: '.xecmpf-widget-table-header',
                alternatingTableContainer: '.xecmpf-alternating-toolbars',
                tableToolbar: '.xecmpf-rowselection-toolbar'
            }
        },

        constructor: function BOAttachmentTableView(options) {
            options || (options = {});

            _.defaults(options, {
                data: {},
                pageSize: config.defaultPageSize,
                // toolbarItems and toolbarItemsMasks are required by ToggleHeaderBehavior
                toolbarItems: toolbarItems,
                toolbarItemsMasks: {
                    toolbars: {}
                }
            });

            _.defaults(options.data, {
                pageSize: config.defaultPageSize,
                orderBy: config.orderBy
            });

            this.context = options.context;
            this.collection = options.collection;
            this.titleBarIcon = options.titleBarIcon;
            this.title = options.title;
            this.extId = options.extId;
            this.boId = options.boId;
            this.boType = options.boType;

            Marionette.LayoutView.prototype.constructor.apply(this, arguments);
            this.propagateEventsToRegions();

            this.listenTo(this.collection, 'error', function () {
                GlobalMessage.showMessage('info', this.collection.error.message);
            });

            this.listenTo(this.collection, 'sync', function () {
                this.setHeaderView();
                this.tableHeaderRegion.show(this.headerView);
            });

            // order By column configuration => object with column and order
            if (this.options &&
                this.options.data &&
                this.options.data.expandedView &&
                this.options.data.expandedView.orderBy) {
                if (this.options.data.expandedView.orderBy.sortColumn) {
                // check sort column format
                var parameterPlaceholder = /{([^:}]+)(:([^}]+))?}/g;
                var match = parameterPlaceholder.exec(this.options.data.expandedView.orderBy.sortColumn);
                    if (!match) {
                        log.error(lang.errorOrderByMissingBraces) && console.log(log.last);
                        GlobalMessage.showMessage('info', lang.errorOrderByMissingBraces);
                    }
                }
            }
        },

        initialize: function (options) {
            this.setHeaderView();
            this.setTableView();
            this.setPagination();

            if (options.collection) {
                this.collection.fetched = false;
            }
        },

        setTableView: function () {
            this.columns = this.collection.columns;
            this.connector = (this.collection.node && this.collection.node.connector) ||
                this.context.getObject(ConnectorFactory);

            // For all columns where sort is true, search must be possible
            var columnsWithSearch = [''];
            _.each(this.columns.models, function (model) {
                // Enable sorting only for string types (e.g. StringField, StringMultiLine, StringPopup)
                // This is required for now, since server does not support other types
                if (model.get('sort') === true && model.get('type') === -1) {
                    columnsWithSearch.push(model.get('column_key'));
                }
            });

            // Add custom columns from widget configuration to displayed columns
            // Don't change WorkspacesColumns!
            var tableColumns = AttachmentsColumns.clone();

            this.tableView = new TableView({
                context: this.options.context,
                haveDetailsRowExpandCollapseColumn: true,
                descriptionRowView: DetailsRowView,
                descriptionRowViewOptions: {
                    firstColumnIndex: 2,
                    lastColumnIndex: 2,
                    showDescriptions: true,
                    collapsedHeightIsOneLine: true
                },
                connector: this.connector,
                collection: this.collection,
                columns: this.columns,
                tableColumns: tableColumns,
                columnsWithSearch: columnsWithSearch,
                selectColumn: true,
                pageSize: this.options.data.pageSize,
                orderBy: this.collection.options.boAttachments.attributes.sortExpanded || this.collection.orderBy,
                nameEdit: false,
                tableTexts: {
                    zeroRecords: lang.noAttachmentsFound
                },
                maxColumnsDisplayed: 10
            });

            this.listenTo(this.tableView, 'execute:defaultAction', function (node) {
                var args = {
                    node: node
                };
                this.trigger('before:defaultAction', args);
                if (!args.cancel) {
                    this.defaultActionController.executeAction(node, {
                        context: this.options.context,
                        originatingView: this
                    }).done(function () {
                        this.trigger('executed:defaultAction', args);
                    }.bind(this));
                }
            });
        },

        setPagination: function () {
            this.paginationView = new PaginationView({
                collection: this.collection,
                pageSize: this.options.data.pageSize
            });
        },

        onRender: function () {
            this.collection.fetch({
                reload: true
            });
            this.tableHeaderRegion.show(this.headerView);
            this.tableRegion.show(this.tableView);
            this.paginationRegion.show(this.paginationView);
        },

        onBeforeShow: function () {
            // place overlay
            this._renderTitleIconWaterMark();
        },

        _renderTitleIconWaterMark: function () {
            var titleImgEl = this.$el.find('.tile-type-image img')[0];
      
            if (titleImgEl) {
                $(titleImgEl).after('<span class="csui-icon xecmpf-icon-boattachment-overlay" ' +
                    'title="' + lang.businessAttachments + '"></span>');
            }
        },

        setHeaderView: function () {
            var headerToolbarView = new HeaderToolbarView({
              commands: commands,
              originatingView: this,
              context: this.context,
              collection: this.collection,
              toolbarItems: HeaderToolbarItems,
              data: {
                extId: this.extId,
                boType: this.boType,
                boid: this.boId
              }
            });

            var titleIcon = this.titleBarIcon;
            var titleView = new TitleView({
              imageUrl: titleIcon.src,
              imageClass: titleIcon.cssClass,
              title: this.title
            });

            this.headerView = new HeaderView({
              iconRight: 'icon-tileCollapse',
              leftView: headerToolbarView,
              centerView: titleView
            });
        }
    });

    _.extend(BOAttachmentTableView.prototype, LayoutViewEventsPropagationMixin);

    return BOAttachmentTableView;
});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/boattachments/impl/boattitem',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "              <span class=\"xecmpf-value\">"
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? lookupProperty(stack1,"value") : stack1), depth0))
    + "</span>\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"reserved_by") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"loc":{"start":{"line":9,"column":14},"end":{"line":11,"column":21}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"reserved_by_other") : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"loc":{"start":{"line":12,"column":14},"end":{"line":14,"column":21}}})) != null ? stack1 : "");
},"2":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "                  <span class=\"csui-icon icon-reserved_self\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"reserved_by") || (depth0 != null ? lookupProperty(depth0,"reserved_by") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"reserved_by","hash":{},"loc":{"start":{"line":10,"column":68},"end":{"line":10,"column":83}}}) : helper)))
    + "\"></span>\r\n";
},"4":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "                  <span class=\"csui-icon icon-reserved_other\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"reserved_by_other") || (depth0 != null ? lookupProperty(depth0,"reserved_by_other") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"reserved_by_other","hash":{},"loc":{"start":{"line":13,"column":69},"end":{"line":13,"column":90}}}) : helper)))
    + "\"></span>\r\n";
},"6":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "            <span class=\"xecmpf-label\">"
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? lookupProperty(stack1,"label") : stack1), depth0))
    + "</span>\r\n";
},"8":function(container,depth0,helpers,partials,data) {
    return "            <!-- add element to get proper distance to description -->\r\n            <div class=\"xecmpf-description-spacer\"></div>\r\n";
},"10":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "          <div class=\"xecmpf-right\">\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"topRight") : depth0)) != null ? lookupProperty(stack1,"value") : stack1),{"name":"if","hash":{},"fn":container.program(11, data, 0),"inverse":container.noop,"loc":{"start":{"line":27,"column":12},"end":{"line":33,"column":19}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"topRight") : depth0)) != null ? lookupProperty(stack1,"label") : stack1),{"name":"if","hash":{},"fn":container.program(14, data, 0),"inverse":container.noop,"loc":{"start":{"line":34,"column":12},"end":{"line":36,"column":19}}})) != null ? stack1 : "")
    + "          </div>\r\n";
},"11":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "              <span class=\"xecmpf-value\">"
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"topRight") : depth0)) != null ? lookupProperty(stack1,"value") : stack1), depth0))
    + "</span>\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"topRight") : depth0)) != null ? lookupProperty(stack1,"label") : stack1),{"name":"if","hash":{},"fn":container.program(12, data, 0),"inverse":container.noop,"loc":{"start":{"line":29,"column":14},"end":{"line":32,"column":21}}})) != null ? stack1 : "");
},"12":function(container,depth0,helpers,partials,data) {
    return "                <!-- add element to get proper distance to value -->\r\n                <div class=\"xecmpf-spacer\"></div>\r\n";
},"14":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "              <span class=\"xecmpf-label\">"
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"topRight") : depth0)) != null ? lookupProperty(stack1,"label") : stack1), depth0))
    + "</span>\r\n";
},"16":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "          <div class=\"xecmpf-body\">"
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"description") : depth0)) != null ? lookupProperty(stack1,"value") : stack1), depth0))
    + "</div>\r\n";
},"18":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "          <div class=\"xecmpf-left\">\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"bottomLeft") : depth0)) != null ? lookupProperty(stack1,"label") : stack1),{"name":"if","hash":{},"fn":container.program(19, data, 0),"inverse":container.noop,"loc":{"start":{"line":50,"column":12},"end":{"line":56,"column":19}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"bottomLeft") : depth0)) != null ? lookupProperty(stack1,"value") : stack1),{"name":"if","hash":{},"fn":container.program(21, data, 0),"inverse":container.noop,"loc":{"start":{"line":57,"column":12},"end":{"line":59,"column":19}}})) != null ? stack1 : "")
    + "          </div>\r\n";
},"19":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "              <span class=\"xecmpf-label\">"
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"bottomLeft") : depth0)) != null ? lookupProperty(stack1,"label") : stack1), depth0))
    + "</span>\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"bottomLeft") : depth0)) != null ? lookupProperty(stack1,"value") : stack1),{"name":"if","hash":{},"fn":container.program(12, data, 0),"inverse":container.noop,"loc":{"start":{"line":52,"column":14},"end":{"line":55,"column":21}}})) != null ? stack1 : "");
},"21":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "              <span class=\"xecmpf-value\">"
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"bottomLeft") : depth0)) != null ? lookupProperty(stack1,"value") : stack1), depth0))
    + "</span>\r\n";
},"23":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "          <div class=\"xecmpf-right\">\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"bottomRight") : depth0)) != null ? lookupProperty(stack1,"label") : stack1),{"name":"if","hash":{},"fn":container.program(24, data, 0),"inverse":container.noop,"loc":{"start":{"line":64,"column":12},"end":{"line":70,"column":19}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"bottomRight") : depth0)) != null ? lookupProperty(stack1,"value") : stack1),{"name":"if","hash":{},"fn":container.program(26, data, 0),"inverse":container.noop,"loc":{"start":{"line":71,"column":12},"end":{"line":73,"column":19}}})) != null ? stack1 : "")
    + "          </div>\r\n";
},"24":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "              <span class=\"xecmpf-label\">"
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"bottomRight") : depth0)) != null ? lookupProperty(stack1,"label") : stack1), depth0))
    + "</span>\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"bottomRight") : depth0)) != null ? lookupProperty(stack1,"value") : stack1),{"name":"if","hash":{},"fn":container.program(12, data, 0),"inverse":container.noop,"loc":{"start":{"line":66,"column":14},"end":{"line":69,"column":21}}})) != null ? stack1 : "");
},"26":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "              <span class=\"xecmpf-value\">"
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"bottomRight") : depth0)) != null ? lookupProperty(stack1,"value") : stack1), depth0))
    + "</span>\r\n";
},"28":function(container,depth0,helpers,partials,data) {
    return "  <div class=\"xecmpf-attachmentitem-divider\"></div>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"xecmpf-attachmentitem-action-area\">\r\n  <a class=\"xecmpf-nostyle\" href=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"defaultActionUrl") || (depth0 != null ? lookupProperty(depth0,"defaultActionUrl") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"defaultActionUrl","hash":{},"loc":{"start":{"line":2,"column":34},"end":{"line":2,"column":54}}}) : helper)))
    + "\">\r\n    <div class=\"xecmpf-attachmentitem-border\">\r\n        <div class=\"xecmpf-attachmentitem-top\">\r\n            <span class=\"csui-type-icon "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"icon") || (depth0 != null ? lookupProperty(depth0,"icon") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"icon","hash":{},"loc":{"start":{"line":5,"column":40},"end":{"line":5,"column":48}}}) : helper)))
    + "\" aria-hidden=\"true\"></span>\r\n            <div class=\"xecmpf-title xecmpf-left\">\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? lookupProperty(stack1,"value") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"loc":{"start":{"line":7,"column":10},"end":{"line":15,"column":17}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? lookupProperty(stack1,"label") : stack1),{"name":"if","hash":{},"fn":container.program(6, data, 0),"inverse":container.noop,"loc":{"start":{"line":16,"column":10},"end":{"line":18,"column":17}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"description") : depth0)) != null ? lookupProperty(stack1,"value") : stack1),{"name":"if","hash":{},"fn":container.program(8, data, 0),"inverse":container.noop,"loc":{"start":{"line":19,"column":10},"end":{"line":22,"column":17}}})) != null ? stack1 : "")
    + "        </div>\r\n\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"topRight") : depth0),{"name":"if","hash":{},"fn":container.program(10, data, 0),"inverse":container.noop,"loc":{"start":{"line":25,"column":8},"end":{"line":38,"column":15}}})) != null ? stack1 : "")
    + "      </div>\r\n\r\n      <div class=\"xecmpf-attachmentitem-center\">\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"description") : depth0)) != null ? lookupProperty(stack1,"value") : stack1),{"name":"if","hash":{},"fn":container.program(16, data, 0),"inverse":container.noop,"loc":{"start":{"line":42,"column":8},"end":{"line":44,"column":15}}})) != null ? stack1 : "")
    + "      </div>\r\n\r\n      <div class=\"xecmpf-attachmentitem-bottom\">\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"bottomLeft") : depth0),{"name":"if","hash":{},"fn":container.program(18, data, 0),"inverse":container.noop,"loc":{"start":{"line":48,"column":8},"end":{"line":61,"column":15}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"bottomRight") : depth0),{"name":"if","hash":{},"fn":container.program(23, data, 0),"inverse":container.noop,"loc":{"start":{"line":62,"column":8},"end":{"line":75,"column":15}}})) != null ? stack1 : "")
    + "      </div>\r\n    </div>\r\n  </a>\r\n</div>\r\n\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"notLastItem") : depth0),{"name":"if","hash":{},"fn":container.program(28, data, 0),"inverse":container.noop,"loc":{"start":{"line":81,"column":0},"end":{"line":83,"column":7}}})) != null ? stack1 : "");
}});
Handlebars.registerPartial('xecmpf_widgets_boattachments_impl_boattitem', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/boattachments/impl/boattitem',[],function(){});
// Shows a list of workspaces related to the current one
csui.define('xecmpf/widgets/boattachments/impl/boattitem.view',['module', 'csui/lib/underscore',
    'csui/lib/marionette',
    'csui/lib/jquery',
    'csui/behaviors/default.action/default.action.behavior',
    'csui/utils/base',
    'csui/lib/numeral',
    'csui/utils/contexts/factories/user',
    'xecmpf/widgets/boattachments/impl/boattachmentutil',
    'i18n!xecmpf/widgets/boattachments/impl/nls/lang',
    'hbs!xecmpf/widgets/boattachments/impl/boattitem',
    'css!xecmpf/widgets/boattachments/impl/boattitem'
], function (module, _, Marionette, $,
             DefaultActionBehavior,
             base,
             numeral,
             UserModelFactory,
             BOAttachmentUtil,
             lang,
             itemTemplate) {

    var AttachmentItemView = Marionette.ItemView.extend({

        behaviors: {
            DefaultAction: {
                behaviorClass: DefaultActionBehavior
            }
        },

        constructor: function AttachmentItemView(options) {
            Marionette.ItemView.prototype.constructor.apply(this, arguments);
            this.user = this.options.context.getModel(UserModelFactory);
        },

        triggers: {
            'click .xecmpf-attachmentitem-border': 'click:item'
        },

        onClickItem: function () {
            this.triggerMethod('execute:defaultAction', this.model);
        },

        className: 'xecmpf-attachmentitem-object clearfix',
        template: itemTemplate,
        _checkValue: function(obj) {
            return (!_.isUndefined(obj.value) && !_.isNull(obj.value)?true:false)
        },
        _convValueToString: function(obj) {
            !_.isString(obj.value) && (obj.value = obj.value+"");
            return obj;
        },
        serializeData: function () {
            var allval = this._getObject(this.options.data || {});

            // prepare values
            var values = {};

            // take only values we want
            allval.title && (values.title = allval.title);
            allval.description && (values.description = allval.description);
            allval.topRight && this._checkValue(allval.topRight) && (values.topRight = this._convValueToString(allval.topRight));
            allval.bottomLeft && this._checkValue(allval.bottomLeft) && (values.bottomLeft = this._convValueToString(allval.bottomLeft));
            allval.bottomRight && this._checkValue(allval.bottomRight) && (values.bottomRight = this._convValueToString(allval.bottomRight));

            // default values if still no value is set
            values.title || (values.title = {value: this.model.get('name')});
            values.name || (values.name = this.model.get('name'));
            values.id || (values.id = this.model.get('id'));
            values.defaultActionUrl = DefaultActionBehavior.getDefaultActionNodeUrl(this.model);

            // provide property to indicate that this is not the last item
            if (this.model.get("id") !==
                this.model.collection.models[this.model.collection.models.length - 1].get("id")) {
                values.notLastItem = true;
            }

            if (this.model.get("reserved_user_id")) {
                var reservedBy = lang.reservedBy.replace("%1", this.model.get("reserved_user_id_expand").name_formatted);
                if (this.user.get("id")  === this.model.get("reserved_user_id")) {
                    values.reserved_by = reservedBy;
                } else {
                    values.reserved_by_other = reservedBy;
                }
            }

            return values;
        },

        templateHelpers: function (data) {
            return data;
        },

        // Loop over configuration and set proper content that should be displayed
        _getObject: function (object) {
            return _.reduce(object, function (result, expression, name) {
                if (typeof expression !== 'object') {
                    expression = this.self._getValue(expression);
                } else if (typeof expression === 'object') {
                    if (name === 'value' || name === 'label') {
                        var exp = base.getClosestLocalizedString(expression);
                        expression = this.self._getValue(exp);
                    }
                    else {
                        expression = this.self._getObject(expression);
                    }
                }
                result[name] = expression;

                return result;
            }, {}, {"self": this});
        },

        _getValue: function (expression) {
            // Replace the {} parameter placeholders
            var parameterPlaceholder = /{([^:}]+)(:([^}]+))?}/g,
                match, propertyName, placeholder, value, valueFormat, result = expression;
            // Go over every parameter placeholder found
            // Don't change expression while doing this, because exec remembers position of last matches
            while ((match = parameterPlaceholder.exec(expression))) {
                placeholder = match[0];
                propertyName = match[1];
                valueFormat = match[3];
                // Format the value according to his type
                if (this.model.collection.columns.models) {
                    value = this._formatPlaceholder(propertyName, valueFormat, this.model.attributes,
                        this.model.collection.columns.models);
                }

                // Replace the placeholder with the value found
                result = result.replace(placeholder, value);
            }
            return result;
        },

        // returns a type specifically formatted model value.
        _formatPlaceholder: function (propertyName, valueFormat, attributes, columnModels) {
            var value, column, type, suffix = "_expand", orgPropertyName = propertyName;

            column = _.find(columnModels, function (obj) {
                return obj.get("column_key") === propertyName;
            });
            type = column && column.get("type") || undefined;

            // If exist use expanded property
            propertyName = attributes[propertyName + suffix] ? propertyName + suffix : propertyName;
            value = !_.isUndefined(attributes[propertyName])?attributes[propertyName]: "";

            switch (type) {
                case -7:
                    if (propertyName === 'modify_date' || propertyName === 'modified' ) {
                        value = attributes['modified'] || attributes['modify_date'];
                    }
                    value = base.formatDate(value);
                    break;
                case 5:
                    // Type 5 is a boolean and in this case format properly
                    value = attributes[propertyName + "_formatted"];
                    if (value === null || value === undefined) {
                        value = '';
                    }
                    break;
                case 2:
                case 14:
                    if (propertyName === 'size' || propertyName === 'modifiedby' || propertyName === 'createdby') {
                        value = attributes[propertyName + '_formatted'];
                    }
                    else if (propertyName.indexOf(suffix, this.length - suffix.length) !== -1 &&
                        (attributes[propertyName].type_name === "User" || attributes[propertyName].type_name === "Group")) {
                        value = base.formatMemberName(value);
                    }
                // No break because it must also be checked for default!
                /* falls through */
                default:
                    // Allow currency to applied for different types, e.g. also a string can be
                    // formatted as currency
                    if (valueFormat === 'currency') {
                        // FIXME: format properly if csui provide formating currencies, for now use default
                        value = numeral(value).format();
                    }

                    // In case the value is still expanded object (e.g. user property is undefined, ...)
                    // Set value the not expanded property
                    if (typeof value === 'object') {
                        value = attributes[orgPropertyName] || "";
                    }
            }
            return value;
        }
    });

    return AttachmentItemView;

});


csui.define('css!xecmpf/widgets/boattachments/impl/boattachments',[],function(){});
/**
 * The business attachment view shows a list of documents linked to a business object
 * Provides:
 *   - infinite scrolling
 *   - Empty view in case no business attachments to show
 *   - Title icon
 */
csui.define('xecmpf/widgets/boattachments/boattachments.view',['csui/lib/marionette', 'module', 'csui/lib/underscore', 'csui/lib/backbone',
  'csui/lib/jquery',
  'csui/utils/base',
  'csui/controls/list/list.view',
  'csui/utils/nodesprites',
  'csui/behaviors/limiting/limiting.behavior',
  'csui/behaviors/expanding/expanding.behavior',
  'csui/behaviors/keyboard.navigation/tabable.region.behavior',
  'csui/controls/list/behaviors/list.view.keyboard.behavior',
  'csui/controls/tile/behaviors/infinite.scrolling.behavior',
  'csui/utils/contexts/factories/node',
  'csui/controls/progressblocker/blocker',
  'csui/utils/log',
  'csui/controls/node-type.icon/node-type.icon.view',
  'csui/utils/commands',
  'csui/behaviors/collection.error/collection.error.behavior',
  'csui/controls/globalmessage/globalmessage',

  'xecmpf/widgets/boattachments/impl/boattachments.factory',
  'xecmpf/widgets/boattachments/impl/boattachment.table/boattachmentstable.view',
  'xecmpf/widgets/boattachments/impl/boattitem.view',
  'xecmpf/models/boattachmentcontext/attachmentcontext.factory',
  'xecmpf/widgets/boattachments/impl/boattachmentutil',
  'xecmpf/models/boattachmentcontext/attachmentcontext.busobjinfo.factory',

  'xecmpf/widgets/boattachments/impl/boattachment.table/toolbaritems',

  'i18n!xecmpf/widgets/boattachments/impl/nls/lang',
  'css!xecmpf/widgets/boattachments/impl/boattachments'
], function (Marionette, module, _, Backbone, $, base, ListView, NodeSpriteCollection,
  LimitingBehavior, ExpandingBehavior, TabableRegionBehavior, ListViewKeyboardBehavior,
  InfiniteScrollingBehavior, NodeModelFactory, BlockingView,
  log,
  NodeTypeIconView,
  allCommands,
  CollectionErrorBehavior,
  GlobalMessage,
  BusinessAttachmentsCollectionFactory,
  BusinessAttachmentsTableView,
  AttachmentItemView,
  AttachmentContextFactory,
  attachmentUtil,
  BusinessObjectInfoFacory,
  toolbarItems,
  lang, css) {

  var config = module.config();

  var BOAttachmentsView = ListView.extend({

    constructor: function BOAttachmentsView(options) {
      this.viewClassName = 'xecmpf-businessattachments';
      if (!options || !options.context) {
        throw new Error('Context required to create AttachmentsView');
      }

      // get business attachment context => triggers fetchg from outside
      if (!options.businessAttachmentContext) {
        options.businessAttachmentContext = options.context.getObject(AttachmentContextFactory,
          options.data);
        options.businessAttachmentContext.setAttachmentSpecific(
          BusinessAttachmentsCollectionFactory);
      }

      options.data || (options.data = {});
      options.data.businessattachment || (options.data.businessattachment = {});
      _.defaults(options.data.businessattachment.properties, {
        busObjectId: "",
        busObjectType: "",
        extSystemId: ""
      });
      // business object info returns icon info
      this.busobjinfo = options.businessAttachmentContext.getModel(BusinessObjectInfoFacory, {
        data: options.data.businessattachment.properties,
        attributes: options.data.businessattachment.properties
      });

      ListView.prototype.constructor.apply(this, arguments);

      if (this.options.blockingParentView) {
        BlockingView.delegate(this, this.options.blockingParentView);
      } else {
        BlockingView.imbue(this);
      }

      this.options.data.pageSize = config.defaultPageSize || 30;

      this.configOptionsData = _.clone(options.data);

      // Prepare server side filter
      this.lastFilterValue = "";

      // Per default show expand icon if more than 0 attachments are displayed
      this.limit = 0;

      // Render attachment icon
      this.listenTo(this.collection, "sync", this._renderBusinessAttachmentTitleIcon);
      // show default workspace icon
      this.listenTo(this.collection, "error", this._renderBusinessAttachmentTitleIcon);
      // business object key is empty
      this.listenTo(this.busobjinfo, "missing:busobj:info", this._missingBusObjInfo);

      // Node model changed
      this.nodeModel = this.getContext().getObject(NodeModelFactory, options.context.options);
      this.listenTo(this.nodeModel, 'change:id', this._reset);

      // Note on this.messageOnError
      // Display general or error specific message

      // Loading animation
      this.listenTo(this.collection, "request", this.blockActions)
        .listenTo(this.collection, "sync", function () {
          this.messageOnError = undefined;
          this.unblockActions.apply(this, arguments);
        })
        .listenTo(this.collection, "destroy", this.unblockActions)
        .listenTo(this.collection, "error", function () {
          this.unblockActions.apply(this, arguments);
        });
      // No empty view in case of loading animation
      this.listenTo(this.collection, "request", this.destroyEmptyView)
      // order By column configuration => object with column and order
      if (this.options &&
        this.options.data &&
        this.options.data.collapsedView &&
        this.options.data.collapsedView.orderBy) {

        if (_.isString(this.options.data.collapsedView.orderBy)) {
          log.error(lang.errorOrderByMustNotBeString) && console.log(log.last);
          GlobalMessage.showMessage('info', lang.errorOrderByMustNotBeString);
        } else if (this.options.data.collapsedView.orderBy.sortColumn) {
          // check sort column format
          var parameterPlaceholder = /{([^:}]+)(:([^}]+))?}/g;
          var match = parameterPlaceholder.exec(this.options.data.collapsedView.orderBy.sortColumn);
          if (!match) {
            log.error(lang.errorOrderByMissingBraces) && console.log(log.last);
            GlobalMessage.showMessage('info', lang.errorOrderByMissingBraces);
          }
        }
      }
      // metadata field configuration
      if (this.options &&
        this.options.data &&
        this.options.data.collapsedView) {
        var errors = [],
          that = this;
        ["title", "description", "topRight", "bottomLeft", "bottomRight"].forEach(function (n) {
          if (that.options.data.collapsedView[n] && that.options.data.collapsedView[n].format) {
            errors.push(n);
          }
        });
        // should not happen
        if (errors.length > 0) {
            GlobalMessage.showMessage('info', _.str.sformat(lang.errorFieldFormatTagUnrecognized, errors.join(", ")));
        }
      }

    },

    getContext: function () {
      return this.options.businessAttachmentContext;
    },

    initialize: function () {
      // Limiting behaviour needs complete collection, but other behaviours expect collection ...
      this.collection = this.completeCollection;
    },

    onRender: function () {
      // Load initially only one page
      this._resetInfiniteScrolling();
      ListView.prototype.onRender.call(this);
    },

    onClickHeader: function (target) {
      this.triggerMethod('expand');
    },

    _resetInfiniteScrolling: function () {
      // reset infinite scrolling in case filter is changed
      this.collection.setLimit(0, this.options.data.pageSize, false);
    },

    templateHelpers: function () {
      return {
        title: this._getTitle(),
        imageUrl: this._getTitleIcon().src,
        imageClass: 'xecmpf-attachmentstitleicon',
        searchPlaceholder: this._getSearchPlaceholder()
      };
    },

    childEvents: {
      'render': 'onRenderItem',
      'before:destroy': 'onBeforeDestroyItem'
    },

    className: function () {
      var className = this.viewClassName,
        parentClassName = _.result(ListView.prototype, 'className');
      if (parentClassName) {
        className = className + ' ' + parentClassName;
      }
      return className;
    },

    /**
     * Reset the current model/query and filter
     * Needed that it's not reused in in case widget is accessed again
     * on same perspective but with different node.
     *
     * @private
     */
    _reset: function () {
      // reset paging due to infinite scrolling
      // Page have to be reset in case wiget is accessed again
      if (this.collection) {
        this.collection.resetLimit();
      }

      // Reset filter
      if (this.ui.searchInput && this.ui.searchInput.val() !== "") {
        if (this.collection) {
          this.collection.clearFilter(false);
        }
        this.ui.searchInput.val('');
      }

      // Call search clicked if search is visible, this will cause the search box to slide out
      if (this.ui.searchInput && this.ui.searchInput.is(':visible')) {
        this.searchClicked(new CustomEvent(''));
      }
    },
    dialogClassName: 'xecmpf-businessattachments',
    behaviors: {

      // Limits the rendered collection length with a More link to expand it
      LimitedList: {
        behaviorClass: LimitingBehavior,
        // Show expand if more than 0 attachments are displayed
        limit: function () {
          return this.limit;
        },
        completeCollection: function () {
          return this.getContext().getCollection(BusinessAttachmentsCollectionFactory, {
            attributes: this._getCollectionAttributes(),
            options: {
              data: this.options.data,
              query: this._getCollectionUrlQuery(),
              delayRestCommands: true,
              commands:  this._getCommands()
            }
          })

        }
      },

      ExpandableList: {
        behaviorClass: ExpandingBehavior,
        expandedView: BusinessAttachmentsTableView,
        expandedViewOptions: function () {
          return {
            title: this._getTitle(),
            titleBarIcon: this._getTitleIcon(),
            data: _.clone(this.configOptionsData),
            collection: this._getExpandedViewCollection(true), //for expand view new collection is required always for default filters & sorting.
            context: this.getContext(),
            extId: this.busobjinfo.get('extSystemId'),
            boType: this.busobjinfo.get('busObjectType'),
            boId: this.busobjinfo.get('busObjectKey')
          };
        },
        dialogClassName: function () {
          return this.dialogClassName;
        }
      },

      InfiniteScrolling: {
        behaviorClass: InfiniteScrollingBehavior,
        // selector for scrollable area
        content: '.binf-list-group',
        contentParent: '.tile-content',
        fetchMoreItemsThreshold: 80
      },

      TabableRegion: {
        behaviorClass: TabableRegionBehavior
      },

      ListViewKeyboardBehavior: {
        behaviorClass: ListViewKeyboardBehavior
      },

      BusinessAttachmentsCollectionError: {
        behaviorClass: CollectionErrorBehavior,
        collection: function () {
          return this.completeCollection;
        }
      },

      BusinessObjectInfoCollectionError: {
        behaviorClass: CollectionErrorBehavior,
        collection: function () {
          return this.busobjinfo;
        }
      }
    },

    _getCommands: function () {
      function getSignatures(toolItems) {
        var sigArray = [];
        _.mapObject(toolItems, function (val, key) {
          sigArray = _.union(sigArray, _.without(val.collection.pluck('signature'), 'disabled'));
        });
        return sigArray;
      }

      // Get only signatures of BOAttachments toolbar commands
      var signatures = getSignatures.call(this, toolbarItems);

      // Reduce the commands to only those supported by the NodesTable
      var boCommands = allCommands.clone();
      var commandsToRemove = [];
      boCommands.each(function (command) {
        if (signatures.indexOf(command.get('signature')) === -1) {
          commandsToRemove.push(command);
        }
      });
      boCommands.remove(commandsToRemove, {silent: true});

      return boCommands;
    },

    _getExpandedViewCollection: function (freshCollection) {
      if (!!freshCollection) {
        this.expandViewCollection = this.completeCollection ?
          this.completeCollection.clone() : this.collection.clone();
        // clone won't add the bo actions
        this.expandViewCollection.businessObjectActions = this.completeCollection.businessObjectActions || this.collection.businessObjectActions;
        this.expandViewCollection.columns = this.completeCollection.columns || this.collection.columns;
        this.listenTo(this.expandViewCollection, {
          'add': function (model) {
            this.collection.add(model, {
              at: 0
            });
          }
        });
      }
      return this.expandViewCollection;
    },

    filterChanged: function (event) {
      if (event && event.type === 'keyup' && event.keyCode === 27) {
        // Hitting Esc should get rid of the filtering control; it resets
        // the filter value automatically
        this.searchClicked();
      }

      var filterValue = this.ui.searchInput.val();
      // lastFilterValue => server filter

      if (this.lastFilterValue !== filterValue) {
        this.lastFilterValue = filterValue;
        // Wait 1 second to execute
        if (this.filterTimeout) {
          clearTimeout(this.filterTimeout);
        }
        this.filterTimeout = setTimeout(function (self) {
          self.filterTimeout = undefined;
          // reset infinite scrolling because in case filter is changed only first page should be fetched
          self._resetInfiniteScrolling();
          // reset collection that only the returned attachments are displayed
          // if not reset also old attachments are displayed ...
          self.collection.reset();
          // execute server side filtering
          var propertyName;
          if (self._getFilterPropertyName) {
            propertyName = self._getFilterPropertyName();
          }
          var filterOptions = {};
          filterOptions[propertyName || "name"] = filterValue;
          if (self.collection.setFilter(filterOptions, {
              fetch: false
            })) {
            self.messageOnError = lang.errorFilteringFailed;
            self.collection.fetch();
          }
        }, 1000, this);
      }
    },
    /**
     * Get the title icon for the widget.
     * Initially an invisible icon is returned until the rest call returns.
     * In case the rest call provides an title image this is returned as src, otherwise
     * the default workspace title image is returned as css.
     */
    _getTitleIcon: function () {
      // Set transparent gif that it can be replaced later with proper image
      var icon = {
        src: 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==',
        cssClass: undefined
      };

      if (this.busobjinfo.get("titleIcon")) {
        // For each workspace type one icon exist
        icon.src = this.busobjinfo.get("titleIcon");
        icon.cssClass = 'csui-icon';
      } else {
        // Need to return as class, because URL would not point to proper image
        // icon.cssClass = NodeSprites.findClassByNode(this.collection.node);

        icon.cssClass = 'xecmpf-attachmentstitleicondefault ' +
          NodeSpriteCollection.findClass('equals', 'type', 848);
      }
      return icon;
    },

    _missingBusObjInfo: function () {
      this.emptyViewOptions = { text: lang.emptyBusinessObjectKey };
      this.showEmptyView();
    },

    /**
     * Render attachment icon after rest call returns.
     * Depending on what and if rest call returns an icon,
     * set icon as class (default icon) or the configured one as src.
     * Icons are set via DOM manipulation.
     */
    _renderBusinessAttachmentTitleIcon: function () {
      var titleDivEl = this.$el.find('.tile-type-image')[0],
        titleImgEl = titleDivEl && this.$el.find('.tile-type-image').find("img")[0];
      if (titleImgEl) {
        var icon = this._getTitleIcon();
        if ($(titleImgEl).attr('src') !== icon.src) {
          $(titleImgEl).attr('src', icon.src);
        }

        if (icon.cssClass) {
          // Set via dom proper class that shows icon
          if ($(titleImgEl).attr('class') !== icon.cssClass) {
            $(titleImgEl).attr('class', icon.cssClass);
          }
        }

        // BITV 1.1.c: no information icon, Empty alt
        // attributes for layout graphics
        // WCAG20: H67
        $(titleImgEl).attr('alt', '');

        $(titleImgEl).after('<span class="csui-icon xecmpf-icon-boattachment-overlay" ' +
          'title="' + lang.businessAttachments + '"></span>');

      }
    },

    _getTitle: function () {
      var ret = lang.dialogTitle;

      if (this.options.data.title) {
        ret = base.getClosestLocalizedString(this.options.data.title, lang.dialogTitle);
      }

      return ret;
    },

    _getSearchPlaceholder: function () {
      return lang.searchPlaceholder.replace("%1", this._getTitle());
    },

    childView: AttachmentItemView,

    childViewOptions: function () {
      // at least bo attachment name is displayed
      _.defaults(this.options.data, {
        collapsedView: {
          title: {
            value: "{name}"
          }
        }
      });
      _.defaults(this.options.data.collapsedView.title, {
        value: "{name}"
      });

      if (_.isEmpty(this.options.data.collapsedView.title) ||
        _.isEmpty(this.options.data.collapsedView.title.value)) {
        this.options.data.collapsedView.title = {
          value: "{name}"
        }
      }

      return {
        context: this.options.context,
        data: this.options.data.collapsedView
      };
    },

    emptyViewOptions: {
      templateHelpers: function () {
        var noBusObj = this._parent.busobjinfo.invalidConfigurationShown ?
          this._parent.busobjinfo.invalidErrorMessage : '';
        return {
          text: this._parent._getNoResultsPlaceholder() + noBusObj

        };
      }
    },
    // Attributes identify collection/models for widget
    // In case two widgets has returns same attributes here, they share the collection!!
    _getCollectionAttributes: function () {
      var boAttachmentProps = (this.options.data.busObjectId && this.options.data) ||
        (this.options.data && this.options.data.businessattachment &&
          this.options.data.businessattachment.properties) || {};
      return {
        busObjectType: (boAttachmentProps && boAttachmentProps.busObjectType),
        extSystemId: (boAttachmentProps && boAttachmentProps.extSystemId),
        busObjectId: (boAttachmentProps && boAttachmentProps.busObjectId),
        sortExpanded: this.options.data.expandedView &&
          attachmentUtil.orderByAsString(this.options.data.expandedView.orderBy) ||
          this._getDefaultSortOrder() || undefined,
        sortCollapsed: this.options.data.collapsedView &&
          attachmentUtil.orderByAsString(this.options.data.collapsedView.orderBy) ||
          this._getDefaultSortOrder() || undefined
      };

    },

    // Get the default sort order in case no sort order is defined
    _getDefaultSortOrder: function () {
      return this._getFilterPropertyName() ? this._getFilterPropertyName() + ' asc' : undefined;
    },

    _getCollectionUrlQuery: function () {
      var options = this.options,
        query = {};
      var orderByAsString;

      if (options.data.collapsedView) {
        orderByAsString = attachmentUtil.orderByAsString(options.data.collapsedView.orderBy);
      }
      if (!orderByAsString) {
        orderByAsString = this._getDefaultSortOrder();
      }
      if (orderByAsString) {
        query.sort = orderByAsString;
      }

      return query;
    },

    // get first placeholder from string with mix of column references and free text.
    _getFirstPlaceholder: function (expression) {
      var parameterPlaceholder = /{([^:}]+)(:([^}]+))?}/g,
        match, propertyName, placeholder, result;
      // Go over every parameter placeholder found
      // Don't change expression while doing this, because exec remembers position of last matches
      while ((match = parameterPlaceholder.exec(expression))) {
        placeholder = match[0];
        propertyName = match[1];
        if (propertyName) {
          result = match;
          break;
        }
      }
      return result;
    },

    // Get property name to use for filtering
    _getFilterPropertyName: function () {
      var propertyName;
      if (this.options && this.options.data && this.options.data.collapsedView &&
        this.options.data.collapsedView.title && this.options.data.collapsedView.title.value) {
        var placeHolder = this._getFirstPlaceholder(this.options.data.collapsedView.title.value);
        if (placeHolder) {
          propertyName = placeHolder[1];
        }
      }
      return propertyName;
    },

    // return the jQuery list item element by index for keyboard navigation use
    getElementByIndex: function (index) {
      if (isNaN(index) || (index < 0)) {
        return null;
      }
      var $item = this.$(_.str.sformat(
        '.xecmpf-attachmentitem-object:nth-child({0}) .xecmpf-attachmentitem-border', index + 1));
      return this.$($item[0]);
    },
    _getNoResultsPlaceholder: function () {
      var ret = this.options.data &&
        this.options.data.collapsedView &&
        this.options.data.collapsedView.noResultsPlaceholder;

      if (ret) {
        ret = base.getClosestLocalizedString(ret, lang.noResultsPlaceholder);
      } else {
        ret = lang.noResultsPlaceholder;
      }

      return ret;
    },

    // To use default empty view from ListView, the following functions are needed
    collectionEvents: {
      'reset': 'onCollectionSync'
    },

    onCollectionSync: function () {
      this.synced = true;
    },

    isEmpty: function () {
      return this.synced && (this.collection.models.length === 0);
    },

    onRenderItem: function (childView) {
      childView._nodeIconView = new NodeTypeIconView({
        el: childView.$('.csui-type-icon').get(0),
        node: childView.model
      });
      childView._nodeIconView.render();
    },

    onBeforeDestroyItem: function (childView) {
      if (childView._nodeIconView) {
        childView._nodeIconView.destroy();
      }
    }
  });

  return BOAttachmentsView;
});

csui.define('css!xecmpf/widgets/workspaces/controls/tile/impl/tile',[],function(){});
csui.define('xecmpf/widgets/workspaces/controls/tile/tile.view',['module', 'csui/lib/jquery', 'csui/lib/underscore',
    'csui/lib/backbone',
    'csui/lib/marionette', 'csui/utils/log',
    'csui/utils/base',
    'csui/controls/tile/tile.view',
    'css!xecmpf/widgets/workspaces/controls/tile/impl/tile'

], function (module, $, _, Backbone, Marionette, log, base,
             TileView_
) {

    var TileView = TileView_.extend({
        constructor: function TileView(options) {
            TileView_.prototype.constructor.apply(this, arguments);
        }
    });
    return TileView;
});

csui.define('xecmpf/widgets/workspaces/factories/workspace.factory',['module', 'csui/lib/underscore', 'csui/lib/backbone',
    'csui/utils/contexts/factories/factory',
    'xecmpf/widgets/workspaces/models/workspace.collection',
    'csui/utils/contexts/factories/connector',
    'csui/utils/commands',
], function (module, _, Backbone,
             CollectionFactory,
             WorkspaceCollection,
             ConnectorFactory,
             allCommands) {
    'use strict';

    var WorkspaceCollectionFactory = CollectionFactory.extend({

        propertyPrefix: 'workspaces',

        constructor: function WorkspaceCollectionFactory(context, options) {
            options || (options = {});

            CollectionFactory.prototype.constructor.apply(this, arguments);
            var workspaces = this.options.workspaces || {};

            if (!(workspaces instanceof Backbone.Collection)) {
                workspaces = new WorkspaceCollection(workspaces.models, _.extend({},
                    this.options.workspaces, {
                    // Prefer refreshing the entire table to rendering one row after another.
                    autoreset: true,
                    // Ask the server to check for permitted actions V2
                    commands: allCommands.getAllSignatures(),
                    // Do not request the v1 actions, which are sent by default
                    includeActions: false,
                    connector: context.getObject(ConnectorFactory)
                }));
            }
            this.property = workspaces;
        },

        fetch: function (options) {
            return this.property.fetch(options);
        }

    });

    return WorkspaceCollectionFactory;

});

csui.define('xecmpf/widgets/workspaces/factories/workspace.types.factory',['module', 'csui/lib/underscore', 'csui/lib/backbone',
    'csui/utils/contexts/factories/factory',
    'xecmpf/widgets/workspaces/models/workspace.types.collection',
    'csui/utils/contexts/factories/connector',
], function (module, _, Backbone,
             CollectionFactory,
             WorkspaceTypesCollection,
             ConnectorFactory) {

    var WorkspaceTypesCollectionFactory = CollectionFactory.extend({

        propertyPrefix: 'workspaceTypes',

        constructor: function WorkspaceTypesCollectionFactory(context, options) {

            CollectionFactory.prototype.constructor.apply(this, arguments);
            var workspaceTypes = new WorkspaceTypesCollection(undefined, {
                // Prefer refreshing the entire table to rendering one row after another.
                autoreset: true,
                config: this.options.workspaceTypes,
                connector: context.getObject(ConnectorFactory)
            });
            this.property = workspaceTypes;
        },

        fetch: function (options) {
            return this.property.fetch(options);
        }

    });

    return WorkspaceTypesCollectionFactory;

});

csui.define('xecmpf/widgets/workspaces/controls/workspaces.table/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});

csui.define('xecmpf/widgets/workspaces/controls/workspaces.table/impl/nls/root/lang',{
    NodeTableNoFilteredItems: 'There are no early workspaces to display.',
    createNew: "Create new",
    createNewTooltip: 'Create business workspace'
});


csui.define('xecmpf/widgets/workspaces/controls/workspaces.table/tabletoolbar.view',['module', 'require', 'csui/lib/jquery', 'csui/lib/underscore',
    'csui/lib/backbone', 'csui/lib/marionette', 'csui/utils/log', 'csui/utils/base',
    'csui/controls/toolbar/toolitem.model',
    // 'csui/controls/toolbar/impl/toolitems.filtered.model',
    'csui/controls/toolbar/toolitems.filtered.model',
    'csui/controls/toolbar/toolbar.view',
    'csui/utils/commands',
    'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',
    'csui/controls/tabletoolbar/tabletoolbar.view',
    "csui/utils/url",
    'xecmpf/widgets/workspaces/factories/workspace.types.factory',
    'i18n!xecmpf/widgets/workspaces/controls/workspaces.table/impl/nls/lang'
], function (module, require, $, _, Backbone, Marionette, log, base,
             ToolItemModel, FilteredToolItemsCollection,
             ToolbarView,
             Commands,
             LayoutViewEventsPropagationMixin,
             TableToolbarView,
             Url,
             WorkspaceTypeCollectionFactory,
             lang) {
    'use strict';

    var AddWorkspaceToolbarView = ToolbarView.extend({

            cssPrefix: "binf-",
            ui: {
                dropdown: '.binf-dropdown-toggle'
            },
            events: {
                'click @ui.dropdown': 'adjustDropdown'
            },

            _makeDropDown: function () {
                var e = '<a href="#" class="' + this.cssPrefix + 'dropdown-toggle csui-acc-focusable"  data-binf-toggle="dropdown" aria-expanded="true"';
                if (this.options.dropDownText) {
                    e += ' title="' + this.options.dropDownText + '">';
                } else {
                    e += '>';
                }
                if (this.options.dropDownIcon) {
                    e += '<span class="' + this.options.dropDownIcon + '"></span>';
                } else {
                    if (this.options.dropDownText) {
                        e += this.options.dropDownText;
                    }
                }
                e += "<span class='toolbarlabel'>" + lang.createNew + "</span></a>";
                return e;
            },
            adjustDropdown: function (event) {
                if (this.collection.length <= 1) {
                    // hide drop down
                    this.$el.find("." + this.cssPrefix + "dropdown-menu").css("display", "none");
                    var args = {toolItem: this.collection.at(0)};
                    this.children.first().triggerMethod("before:toolitem:action", args);
                    this.children.first().triggerMethod("toolitem:action", args);
                }
            }
        })
        ;
    var AddWorkspaceTableToolbarView = TableToolbarView.extend({

        constructor: function TableToolbarView(options) {
            Marionette.LayoutView.prototype.constructor.apply(this, arguments); // sets this.options

            this.context = this.options.context;
            this.commands = this.options.commands || Commands;
            this.toolbarNames = ['add'];

            // create toolbar with filtered commands
            var addToolbarFactory = this.options.toolbarItems['addToolbar'],
                toolbarView = this['addToolbarView'] = new AddWorkspaceToolbarView(_.extend({
                    // filter entries in toolbar
                    collection: new FilteredToolItemsCollection(
                        addToolbarFactory, {
                            status: {},  // must be set
                            commands: this.commands,
                            delayedActions: false
                        }), // <=  filter toolbar items (actions) for add toolbar
                    toolbarName: "add"
                }, addToolbarFactory.options));

            this
                .listenTo(toolbarView, 'childview:toolitem:action',
                    function (toolItemView, args) {
                        this.trigger('toolbarItem:clicked', args.toolItem.attributes.commandData);
                    }
                )
                .listenTo(toolbarView, 'dom:refresh', function () {
                    this.triggerMethod('refresh:tabindexes');
                });
            this._updateAddToolbar();
            this.propagateEventsToRegions();
        },
        // called from nodestable.view when the selection of nodes changed -> update the toolbars
        updateForSelectedChildren: function (selectedNodes) {
            // skip
        },

        _addMenuItems: function (toolItems, businessWorkspaceTypes) {
            businessWorkspaceTypes.models.forEach(function (bwtype) {
                // note: signature of toolbar item must match with a command or indicates entry as separator

                if (!_.isEmpty(bwtype.get("templates"))) {
                    _.each(bwtype.get("templates"), function (tmpl) {
                        var toolItem = new ToolItemModel({
                            signature: "AddConnectedWorkspace", // must match with filteredToolItemCollection
                            icon: 'icon icon-toolbarAdd',
                            svgId: 'themes--carbonfiber--image--generated_icons--action_add32',
                            name: lang.createNewTooltip,
                            group: 'conws',
                            commandData: {
                                wksp_type_name: bwtype.get("wksp_type_name"), //. props.wksp_type_name,
                                wksp_type_id: bwtype.get("wksp_type_id"), // props.wksp_type_id,
                                template: tmpl,
                                type: tmpl.subType,
                                rm_enabled: bwtype.get("rm_enabled")
                            }
                        });
                        toolItems.push(toolItem);
                    });
                }
            });
        },

        onBeforeShow: function () {
            this.options.toolbarItems.addToolbar.reset(this.toolbarItems);
        },
        _updateAddToolbar: function () {
            // build toolbar
            this.toolbarItems = [];
            this.workspaceTypesCollection = this.options.context.getCollection(
                WorkspaceTypeCollectionFactory, {
                    busObjectType: this.options.data.busObjectType,
                    extSystemId: this.options.data.extSystemId
                });

            this._addMenuItems(this.toolbarItems, this.workspaceTypesCollection);
        }
    });

    _.extend(AddWorkspaceTableToolbarView.prototype, LayoutViewEventsPropagationMixin);

    return AddWorkspaceTableToolbarView;

});


csui.define('xecmpf/widgets/workspaces/controls/workspaces.table/table.columns',["csui/lib/backbone"], function (Backbone) {

    var TableColumnModel = Backbone.Model.extend({

        idAttribute: "key",

        defaults: {
            key: null,  // key from the resource definitions
            sequence: 0 // smaller number moves the column to the front
        }

    });

    var TableColumnCollection = Backbone.Collection.extend({

        model: TableColumnModel,
        comparator: "sequence",

        getColumnKeys: function () {
            return this.pluck('key');
        },

        deepClone: function () {
            return new TableColumnCollection(
                this.map(function (column) {
                    return column.attributes;
                }));
        }

    });
    var tableColumns = new TableColumnCollection([
        {
            key: 'name',
            sequence: 1,
            permanentColumn: true // don't wrap column due to responsiveness into details row
        },
        {
            key: 'modify_date',
            sequence: 2,
            permanentColumn: true // don't wrap column due to responsiveness into details row
        }
    ])
    return tableColumns;

});

csui.define('xecmpf/widgets/workspaces/controls/workspaces.table/toolbaritems',['csui/lib/underscore', 'csui/utils/base',
    'csui/controls/toolbar/toolitems.factory',
    'i18n!xecmpf/widgets/workspaces/controls/workspaces.table/impl/nls/lang',
], function (_, base, ToolItemsFactory, lang ) {

    var toolbarItems = {

        addToolbar: new ToolItemsFactory({
                add: []
            },
            {
                maxItemsShown: 0, // force toolbar to immediately start with a drop-down list
                dropDownIcon: "icon icon-toolbarAdd",
                dropDownText: lang.createNewTooltip,
                dropDownSvgId: "themes--carbonfiber--image--generated_icons--action_add32",
                addTrailingDivider: false
            })

    };

    return toolbarItems;

});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/workspaces/controls/workspaces.table/impl/workspacestable',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div id=\"tabletoolbar\"></div>\r\n<div id=\"tableview\"></div>\r\n<div id=\"paginationview\"></div>\r\n";
}});
Handlebars.registerPartial('xecmpf_widgets_workspaces_controls_workspaces.table_impl_workspacestable', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/workspaces/controls/workspaces.table/impl/workspacestable',[],function(){});
csui.define('xecmpf/widgets/workspaces/controls/workspaces.table/workspaces.table.view',['module', 'csui/lib/jquery', 'csui/lib/underscore',
    'csui/lib/backbone',
    'csui/lib/marionette',
    'csui/utils/log',
    'csui/utils/base',

    'csui/utils/contexts/factories/connector',
    'csui/controls/progressblocker/blocker',
    'csui/controls/table/cells/name/name.view',
    'csui/behaviors/default.action/default.action.behavior',
    'xecmpf/widgets/workspaces/factories/workspace.factory',
    'csui/utils/contexts/factories/columns',
    'csui/controls/table/table.view',
    'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',

    'xecmpf/widgets/workspaces/controls/workspaces.table/tabletoolbar.view',
    'xecmpf/widgets/workspaces/controls/workspaces.table/table.columns',
    'xecmpf/widgets/workspaces/controls/workspaces.table/toolbaritems',
    'csui/controls/pagination/nodespagination.view',

    'i18n!xecmpf/widgets/workspaces/controls/workspaces.table/impl/nls/lang',
    'hbs!xecmpf/widgets/workspaces/controls/workspaces.table/impl/workspacestable',
    'css!xecmpf/widgets/workspaces/controls/workspaces.table/impl/workspacestable'
], function (module, $, _, Backbone,
             Marionette, log, base,
             ConnectorFactory,
             BlockingView,
             NameCellView,
             DefaultActionBehavior,
             WorkspacesCollectionFactory,
             ColumnCollectionFactory,
             TableView,
             LayoutViewEventsPropagationMixin,
             TableToolbarView,
             TableColumns,
             ToolbarItems,
             PaginationView,
             lang, template, css) {

    var config = module.config();

    _.defaults(config, {
        defaultPageSize: 30,
        clearFilterOnChange: true,
        resetOrderOnChange: false,
        resetLimitOnChange: true,
        fixedFilterOnChange: false
    });

    NameCellView.prototype.getValueData = function () {

        var column = this.options.column,
            node = this.model,
            name = node.get(column.name);

        return {
            defaultAction: 'displayWorkspace',
            defaultActionUrl: '',
            contextualMenu: column.contextualMenu,
            name: name,
            inactive: node.get('inactive')
        };
    };

    var WorkspacesTableView = Marionette.LayoutView.extend({
        template: template,
        className: 'xecmpf_workspacestable',
        regions: {
            tableToolbarRegion: '#tabletoolbar',
            tableRegion: '#tableview',
            paginationRegion: '#paginationview'
        },
        ui: {
            outerTableContainer: '#outertablecontainer',
            innerTableContainer: '#innertablecontainer',
            tableView: '#tableview',
            paginationView: '#paginationview'
        },
        behaviors: {
            DefaultAction: {
                behaviorClass: DefaultActionBehavior
            }
        },

        constructor: function WorkspacesTableView(options) {
            options || (options = {});
            _.defaults(options, {
                data: {},
                pageSize: config.defaultPageSize,
                toolbarItems: ToolbarItems,
                defaultPageSize: config.defaultPageSize,
                clearFilterOnChange: config.clearFilterOnChange,
                resetOrderOnChange: config.resetOrderOnChange,
                resetLimitOnChange: config.resetLimitOnChange,
                fixedFilterOnChange: config.fixedFilterOnChange
            });

            this.context = options.context;
            this.connector = this.context.getObject(ConnectorFactory);

            var height = options.data.height || options.height;
            if (height) {
                this.$el.height(height);
            }

            // Inheritors of this object start blocking actions in initialize().
            // Initializing of the blocking view has to happen before the parent
            // constructor gets called, or better, before initialize() is executed.
            // This is a result of breaking two rules:
            // 1. Nobody should inherit from widgets.
            // 2. constructor should not be overridden together with initialize.
            BlockingView.imbue(this);
            // calls initialize
            Marionette.LayoutView.prototype.constructor.apply(this, arguments); // sets this.options

            this.collection = this.options.collection = this.context.getCollection(
                WorkspacesCollectionFactory, {
                    attributes: 'early'
                });
            this.columns = this.collection.columns;
            this.tableColumns = TableColumns.deepClone();
            this._setToolBar(ToolbarItems);
            this.defaultActionController.executeAction = function (node) {
                return $.Deferred().resolve();
            }

            this._setTableView();
            this._setPagination();
            this.propagateEventsToRegions();
        },

        _setTableView: function () {

            this.tableView = new TableView({
                selectRows: "none",
                context: this.options.context,
                connector: this.connector,
                collection: this.collection,
                columns: this.columns,
                selectColumn: false,
                tableColumns: this.tableColumns,
                pageSize: this.options.data.pageSize,
                originatingView: this,
                columnsWithSearch: ["name"],
                orderBy: this.options.orderBy,
                filterBy: this.options.filterBy,
                blockingParentView: this,
                tableTexts: {
                    zeroRecords: lang.NodeTableNoFilteredItems
                }
            });


            // FIXME: Computing maximum column count (_adjustColumnsAfterWindowResize)
            // does not return the same value as set by rebuilding the table (rebuild)
            // unless an extra div  is appended to the table.  Why?
            this.listenTo(this.tableView, 'render', function () {
                this.tableView.$el.append($('<div>')[0]);
            });

            this._setTableViewEvents();
        },
        _setTableViewEvents: function () {

            this.listenTo(this.tableView, 'dom:refresh', function () {
                $('.csui-nodetable')[0] && !$('.csui-not-ready')[0]  && $('.csui-nodetable').trigger("focus");
                // $('.csui-addToolbar')[0] && !$('.csui-addToolbar')[0]  && $('.csui-addToolbar').focus();
            });

            this.listenTo(this.tableView, 'execute:defaultAction', function (node) {
                var args = {node: node};
                this.trigger('before:defaultAction', args);
                if (!args.cancel) {
                    var self = this;
                    this.defaultActionController
                        .executeAction(node, {
                            context: this.options.context,
                            originatingView: this
                        })
                        .done(function () {
                            self.trigger('executed:defaultAction', args);
                        });
                }
            });

            return true;
        },
        _setToolBar: function (toolItems) {
            // toolbarItems is an object with several TooItemFactories in it (for each toolbar one)
            this.tableToolbarView = new TableToolbarView(
                _.defaults(this.options, {
                    context: this.options.context,
                    toolbarItems: toolItems,
                    collection: this.collection,
                    originatingView: this,
                }));

            this.listenTo(this.tableToolbarView, 'before:execute:command', this._beforeExecuteCommand);
            this.listenTo(this.tableToolbarView, 'after:execute:command', this._toolbarActionTriggered);
            this.listenTo(this.tableToolbarView, 'toolbarItem:clicked',
                function (args) {
                    this.trigger('toolbarItem:clicked', args);
                }
            );

            return true;
        },

        _setPagination: function () {
            this.paginationView = new PaginationView({
                collection: this.collection,
                pageSize: this.options.data.pageSize || this.options.pageSize,
                defaultDDList: this.options.ddItemsList,
                // this.options.ddItemsList,
                externalWidget: this.options.externalWidget
            });

            return true;
        },
        onShow: function () {
            _.each(this.regionManager._regions, function (region) {
                if (region.currentView) {
                    region.currentView.triggerMethod('show');
                }
            });
        },

        onAfterShow: function () {
            _.each(this.regionManager._regions, function (region) {
                if (region.currentView) {
                    region.currentView.triggerMethod('after:show');
                }
            });
        },
        onRender: function () {
            this.tableToolbarRegion.show(this.tableToolbarView);
            this.tableRegion.show(this.tableView);
            this.paginationRegion.show(this.paginationView);
        }
    });
    _.extend(WorkspacesTableView.prototype, LayoutViewEventsPropagationMixin);
    return WorkspacesTableView;
});


csui.define('xecmpf/widgets/workspaces/pages/select.workspace/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});

csui.define('xecmpf/widgets/workspaces/pages/select.workspace/impl/nls/root/lang',{
  pageTitle: 'Create or complete business workspace'
});



/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/workspaces/pages/select.workspace/impl/select.workspace',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div id=\"content\"></div>\r\n\r\n";
}});
Handlebars.registerPartial('xecmpf_widgets_workspaces_pages_select.workspace_impl_select.workspace', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/workspaces/pages/select.workspace/impl/select.workspace',[],function(){});
csui.define('xecmpf/widgets/workspaces/pages/select.workspace/select.workspace.view',['module', 'csui/lib/jquery', 'csui/lib/underscore',
    'csui/lib/backbone',
    'csui/lib/marionette', 'csui/utils/log', 'csui/utils/base',
    'xecmpf/widgets/workspaces/controls/tile/tile.view',
    'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',
    "xecmpf/widgets/workspaces/controls/workspaces.table/workspaces.table.view",
    "i18n!xecmpf/widgets/workspaces/pages/select.workspace/impl/nls/lang",
    'hbs!xecmpf/widgets/workspaces/pages/select.workspace/impl/select.workspace',
    'css!xecmpf/widgets/workspaces/pages/select.workspace/impl/select.workspace',

], function (module, $, _, Backbone, Marionette, log, base,
             TileView,
             LayoutViewEventsPropagationMixin,
             WorkspacesTableView,
             lang,
             template,
             css) {


    var SelectWorkspaceView = Marionette.LayoutView.extend({
            tagName: "div",
            id: "xecmpf-select_wksp",
            className: "xecmpf-page",

            template: template,
            regions: {
                content: "#content"
            },
            constructor: function SelectWorkspaceView(options) {
                Marionette.LayoutView.prototype.constructor.apply(this, arguments); // sets this.options
                this.context = this.options.context;
                this.propagateEventsToRegions();
            },
            _getController: function () {
                return this.options.status.wksp_controller;
            },
            onBeforeShow: function () {
                var options = this.options;
                this.tileView = new TileView({
                    title: lang.pageTitle,
                    contentView: WorkspacesTableView,
                    contentViewOptions: options
                });

                this.getRegion('content').show(this.tileView);
                this.listenTo(this.tileView.contentView, 'toolbarItem:clicked', function (workspaceType) {
                    // workspace template selected
                    _.defaults(options.status, {
                        workspaceType: new Backbone.Model(workspaceType)
                    });

                    this._getController().createWorkspace(options);
                    return $.Deferred().resolve();
                });
                this.listenTo(this.tileView.contentView, 'executed:defaultAction', function (args) {
                    options.status || (options.status = {});
                    // set selected workspace
                    options.status.workspace = args.node;
                    this._getController().updateWorkspace(options);
                });
            }
        })
        ;

    _.extend(SelectWorkspaceView.prototype, LayoutViewEventsPropagationMixin);

    return SelectWorkspaceView;
})
;


csui.define('css!xecmpf/widgets/workspaces/controls/footer/impl/footer',[],function(){});
csui.define('xecmpf/widgets/workspaces/controls/footer/footer.view',['csui/lib/marionette',
    'csui/lib/underscore',
    'csui/lib/jquery',
    'csui/behaviors/keyboard.navigation/tabable.region.behavior',
    'csui/behaviors/keyboard.navigation/tabables.behavior',
    'css!xecmpf/widgets/workspaces/controls/footer/impl/footer'
], function (Marionette, _, $, TabableRegion) {

    var ButtonView = Marionette.ItemView.extend({

        tagName: 'button',
        className: 'binf-btn',
        template: false,
        triggers: {
            'click': 'click'
        },
        behaviors: {
            TabableRegion: {
                behaviorClass: TabableRegion
            }
        },

        constructor: function ButtonView(options) {
            Marionette.ItemView.prototype.constructor.apply(this, arguments);
        },

        isTabable: function () {
            return this.$el.is(':not(:disabled)') && this.$el.is(':not(:hidden)');
        },
        currentlyFocusedElement: function () {
            if (this.$el.prop('tabindex') === -1) {
                this.$el.prop('tabindex', 0);
            }
            return this.$el;
        },
        onRender: function () {
            var $button = this.$el;
            $button.text(this.model.get("label"));
            $button.addClass(this.model.get('primary') ? 'binf-btn-primary' : 'binf-btn-default');
            $button.attr('title', (this.model.get("toolTip") ? this.model.get("toolTip") : ""));

            if (this.model.get("separate")) {
                $button.addClass('cs-separate');
            }
            this.updateButton(this.model);
        },

        updateButton: function (model) {
            var $button = this.$el;

            if (model.get("hidden") !== undefined) {
                if (model.get("hidden")) {
                    $button.addClass('hidden');
                } else {
                    $button.removeClass('hidden');
                }
            }

            if (model.get("primary") === true) {
                $button.removeClass('binf-btn-default');
                $button.addClass('binf-btn-primary');
            } else {
                $button.addClass('binf-btn-default');
            }

            if (model.get("disabled") !== undefined) {
                $button.prop('disabled', model.get("disabled"));
            }
        }

    });

    var FooterView = Marionette.CollectionView.extend({
        id: "wksp_footer",
        tagName: "div",
        className: "binf-modal-footer",
        childView: ButtonView,

        constructor: function FooterView(options) {
            Marionette.CollectionView.prototype.constructor.apply(this, arguments);
            this.listenTo(this, 'childview:click', this.onClickButton);
        },
        onDomRefresh: function () {
            this.children.each(function (buttonView) {
                buttonView.trigger('dom:refresh');
            });
        },
        onClickButton: function (buttonView) {
            // button collection model attribute
            buttonView.$el.prop('disabled', true);

            if (buttonView.model.get("click")) {
                buttonView.model.get("click")().fail(function () {
                        buttonView.$el.prop('disabled', false);
                    }
                )
            }
        },
        update: function () {
            var self = this;
            this.collection.models.forEach(function (buttonModel) {
                self.children
                    .findByModel(buttonModel)
                    .updateButton(buttonModel);
            });
        }
    });

    return FooterView;
});
csui.define('xecmpf/widgets/workspaces/pages/create.workspace/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});

csui.define('xecmpf/widgets/workspaces/pages/create.workspace/impl/nls/root/lang',{
    pageTitle: 'Create business workspace',
    createWorkspace: 'Create',
    cancel: 'Cancel',
    failedToCreateItem: 'Failed to create the new item.',
    nameIsGeneratedAutomatically: 'Workspace name is generated automatically.',
    errorGettingCreateForm: 'Error getting form for workspace creation.',
    businessWorkspaceTypeName: 'Business Workspace',
    createWorkspaceTooltip: 'Create business workspace'
});



/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/workspaces/pages/create.workspace/impl/create.workspace',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div id=\"content\" class=\"cs-properties-wrapper\"></div>\r\n<div id=\"footer\"></div>\r\n";
}});
Handlebars.registerPartial('xecmpf_widgets_workspaces_pages_create.workspace_impl_create.workspace', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/workspaces/pages/create.workspace/impl/create.workspace',[],function(){});
/**
 * Created by cknoblic on 08.09.2016.
 */
csui.define('xecmpf/widgets/workspaces/pages/create.workspace/create.workspace.view',['module', 'csui/lib/jquery', 'csui/lib/underscore', 'csui/lib/backbone',
    'csui/lib/marionette', 'csui/utils/log', 'csui/utils/base',
    'csui/utils/namedsessionstorage',
    'xecmpf/widgets/workspaces/controls/tile/tile.view',
    'xecmpf/widgets/workspaces/controls/footer/footer.view',
    'csui/widgets/metadata/metadata.add.item.controller',
    'csui/widgets/metadata/metadata.action.one.item.properties.view',
    'conws/models/workspacecreateforms',
    'conws/models/metadata.controller',
    "csui/models/node/node.model",
    'conws/models/metadata.controller',
    'csui/utils/contexts/factories/connector',
    'csui/dialogs/modal.alert/modal.alert',
    'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',
    'csui/behaviors/keyboard.navigation/tabables.behavior',
    'csui/widgets/metadata/metadata.properties.view',
    'csui/utils/url',
    "i18n!xecmpf/widgets/workspaces/pages/create.workspace/impl/nls/lang",
    'hbs!xecmpf/widgets/workspaces/pages/create.workspace/impl/create.workspace',
    'css!xecmpf/widgets/workspaces/pages/create.workspace/impl/create.workspace'

], function (module, $, _, Backbone, Marionette, log, base,
             NamedSessionStorage,
             TileView,
             FooterView,
             MetadataAddItemController,
             MetadataActionOneItemPropertiesView,
             WorkspaceCreateFormCollection,
             WorkspaceMetadataController,
             NodeModel,
             MetadataController,
             ConnectorFactory,
             ModalAlert,
             LayoutViewEventsPropagationMixin,
             TabablesBehavior,
             MetadataPropertiesView,
             Url,
             lang,
             template,
             css) {


    var CreateWorkspaceView = Marionette.LayoutView.extend({
        tagName: "div",
        id: "xecmpf-create_wksp",
        className: "xecmpf-page",
        template: template,
        regions: {
            content: "#content",
            footer: "#footer"
        },
        behaviors: {
            TabablesBehavior: {
                behaviorClass: TabablesBehavior,
                recursiveNavigation: true,
                containTabFocus: true
            }
        },

        constructor: function CreateWorkspaceView(options) {
            Marionette.LayoutView.prototype.constructor.apply(this, arguments); // sets this.options
            var self = this;
            this.context = this.options.context || {};
            this.buttonCollecion = new Backbone.Collection(),

            this.propagateEventsToRegions();
            // FIXME keyboard keydown event is registered twice see LPAD-54770
            this.on('dom:refresh', function () {
                if ($._data) {
                    var events = $._data( this.el, "events");
                    if (events &&  events.keydown && events.keydown.length > 1) {
                        var eventName = !_.isEmpty(events.keydown[1].namespace)?
                            events.keydown[1].type  +'.' + events.keydown[1].namespace:events.keydown[1].type;
                        eventName && events.keydown[1].handler && self.$el.off( eventName, events.keydown[1].handler)
                    }
                }
            });
            // FIXME Disable classifcations
            csui.require(['classifications/widgets/metadata/general.fields/classifications/metadata.general.form.field.controller',
                    'classifications/utils/commands/add.classifications'],
                    function(MetadataClassificationsGeneralFormFieldController, MetadataAddClassificationController) {
                        MetadataClassificationsGeneralFormFieldController.prototype.getGeneralFormFieldsForCreate = function() {
                            return null;
                        }
                        MetadataAddClassificationController.prototype.enabled = function() {
                            return false;
                        };

                    }, function() {
                        // not installed?
                    })
        },

        _getController: function () {
            return this.options.status.wksp_controller;
        },
        _create: function (options) {
            var namedSessionStorage = new NamedSessionStorage("create_complete_wksp");
            var data = this.metadataAddItemPropView.getValues(),
                dfd = $.Deferred();
            if (!_.isEmpty(data)) {
                data.bo_id = this.options.data.busObjectId;
                data['type'] = 848;

                this.metadataController.createItem(this.node, data)
                    .done(_.bind(function (resp) {
                        if (resp) {
                            var responseData = resp.results && resp.results.data;
                            var nodeId = responseData && responseData.properties && responseData.properties.id;
                            _.extend(options.status, {
                                workspaceNode: new NodeModel({
                                    id: nodeId,
                                    container: true
                                }),
                                viewMode: {
                                    mode: options.data.viewMode ? options.data.viewMode.mode : 'folderBrowse'
                                }
                            });
                            namedSessionStorage.set(options.data.busObjectType+'-'+options.data.busObjectId,nodeId);
                            this._getController().displayWorkspace(options);
                        }
                    }, this))
                    .fail(function (resp) {

                        var error = lang.failedToCreateItem;
                        if (resp) {
                            if (resp.responseJSON && resp.responseJSON.error) {
                                error = resp.responseJSON.error;
                            } else if (resp.responseText) {
                                error = resp.responseText;
                            }
                            ModalAlert.showError(error);
                        }
                        dfd.reject();
                    });
            } else {
                // user entered invalid values
                dfd.reject();
            }
            return dfd.promise()
        },
        _createFormCollection: function () {

            var options = this.options || {},
                status = options.status || {},
                context = options.context || {},
                workspaceType = status.workspaceType,
                self = this;

            // options required by constructor
            this.formCollection = new WorkspaceCreateFormCollection(undefined,
                _.defaults(options, {
                    type: workspaceType.get("type"),
                    wsType: workspaceType.get("wksp_type_id"),
                    node: new NodeModel({}, {
                            // node model collection needs connector
                            connector: context.getObject(ConnectorFactory)
                        }
                    ),
                    actionContext: {
                        mode: "create"
                    }
                }));

            // bo_id is set externally
            this.formCollection.bo_id = options.data.busObjectId;
            // overwrite url calculation
            this.formCollection.url = function () {
                //var path = 'forms/nodes/create',
                var path = 'forms/businessworkspaces/create',
                    params = {
                        //     template_id: workspaceType.get("template").id,
                        bo_id: options.data.busObjectId,
                        bo_type: options.data.busObjectType,
                        ext_system_id: options.data.extSystemId
                    },
                    resource = path + '?' + $.param(_.omit(params, function (value) {
                            return value === null || value === undefined || value === '';
                        })),
                    url = context.getObject(ConnectorFactory).getConnectionUrl().getApiBase('v2');
                return Url.combine(url, resource);
            };

            this.formCollection.on("error", function (model, response, options) {
                var errmsg = response && (new base.Error(response)).message || lang.errorGettingCreateForm;
                log.error("Fetching the create forms failed: {0}", errmsg) && console.error(log.last);
                ModalAlert.showError(errmsg);
                if (_.isEmpty(status.mode)) {
                    self.buttonCollecion.length>=2 && self.buttonCollecion.at(1).set('disabled', false);
                }
                // SAPRM-9249
                self.tileView.contentView.metadataHeaderView.metadataItemNameView.remove( );
                // End of SAPRM-9249
                self.footerView && self.footerView.update();
            });

            this.formCollection.on("sync", function () {
                self._updateNameAndView(self.node, self.formCollection)
            });

        },
        _updateNameAndView: function (nodeModel, formCollection) {
            // we have special behavior for the name field, depending on the forms result.
            // so we put the code here, where we have access to the name field in the dialog header.
            var general = formCollection.at(0);

            var data = general.get("data");
            if (data) {
                var name = data.name;
                log.debug("name fetched and used: {0}", name) && console.log(log.last);
                nodeModel.set({name: name});
            } else {
                // if no server data object is set, then we set an empty name.
                log.debug("name set to empty.") && console.log(log.last);
                nodeModel.set({name: ""});
            }

            var metadataView = this.tileView.contentView,
                headerView = metadataView && metadataView.metadataHeaderView,
                nameView = headerView && headerView.metadataItemNameView;
            if (nameView) {
                var gs = general.get("schema"),
                    isReadOnly = (gs && gs.properties && gs.properties.name && gs.properties.name.readonly) ? true : false,
                    placeHolder = isReadOnly ? lang.nameIsGeneratedAutomatically : undefined;
                nameView.setPlaceHolder(placeHolder);
                if ((isReadOnly ? true : false) !== (nameView.readonly ? true : false)) {
                    nameView.setReadOnly(isReadOnly);
                }
            }
        },
        render: function () {

            var self = this,
                options = this.options || {},
                context = options.context || {},
                status = this.options.status || {};

            Marionette.LayoutView.prototype.render.apply(this, arguments);

            this.buttonCollecion.add({
                click: _.bind(this._create, this, this.options),
                disabled: true, primary: false,
                label: lang.createWorkspace, toolTip: lang.createWorkspaceTooltip
            });

            // in direct create mode there is no cancel/switch back
            // to early workspace selection
            if (_.isEmpty(status.mode)) {
                this.buttonCollecion.add({
                    click: _.bind(function () {
                        var dfd = $.Deferred();
                        this._getController().selectWorkspace();
                        dfd.resolve();
                        return dfd.promise();
                    }, this, this.options),
                    disabled: true, primary: false, toolTip: lang.cancel,
                    label: lang.cancel, separate: false
                });
            }

            this.footerView = new FooterView({
                collection: this.buttonCollecion
            });

            // created/result node
            this.node = new NodeModel({
                type_name: lang.businessWorkspaceTypeName,
                type: 848,
                container: true,
                rm_enabled: this.options.status.workspaceType.get('rm_enabled'), 
                name: "" // start with empty name
            }, {
                connector: context.getObject(ConnectorFactory)
            });

            this._createFormCollection();
            this.metadataController = new WorkspaceMetadataController(undefined, {
            });

            var CreatePropertiesView = MetadataActionOneItemPropertiesView.extend({
                    constructor: function CreatePropertiesView(options) {
                        MetadataActionOneItemPropertiesView.prototype.constructor.apply(this, arguments);
                        if (this.metadataPropertiesView !== undefined) {
                            this.metadataPropertiesView.stopListening(this);
                        }

                        this.metadataPropertiesView = new MetadataPropertiesView({
                            node: self.node,
                            context: self.options.context,
                            formMode: 'create',
                            action: 'create',
                            metadataView: this,
                            formCollection: self.formCollection
                        });
                        this.listenTo(this.metadataPropertiesView, 'render:forms', function () {
                            self.buttonCollecion.at(0).set('disabled', false);
                            // in direct create there is only one button
                            if (_.isEmpty(status.mode)) {
                                self.buttonCollecion.at(1).set('disabled', false);
                                self.buttonCollecion.at(0).set('primary', true);
                            } else {
                                self.buttonCollecion.at(0).set('primary', true);
                            }

                            self.footerView.update();
                        });

                        this.listenTo(this.metadataPropertiesView, 'before:render', function () {
                            // remove conws reference panel
                            var conwsRef = this.metadataPropertiesView.collection.findWhere({id: "conws-reference"});
                            if (conwsRef) {
                                this.metadataPropertiesView.collection.remove(conwsRef, {silent: true});
                            }
                        });
                    }
                }
            );

            this.tileView = new TileView({
                title: lang.pageTitle,
                contentView: CreatePropertiesView,
                contentViewOptions: {
                    model: this.node,
                    context: context,
                    action: 'create',
                    formCollection: this.formCollection
                }
            });

        },
        onBeforeShow: function () {
            this.content.show(this.tileView);
            this.footer.show(this.footerView);
            this.metadataAddItemPropView = this.tileView.contentView;
        }
    });

    _.extend(CreateWorkspaceView.prototype, LayoutViewEventsPropagationMixin);
    return CreateWorkspaceView;
});



csui.define('xecmpf/widgets/workspaces/pages/display.workspace/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});

csui.define('xecmpf/widgets/workspaces/pages/display.workspace/impl/nls/root/lang',{
    failedAuthentication: 'Authentication failed.'
});



/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/workspaces/pages/display.workspace/impl/display.workspace',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div id=\"display_wksp_content\">\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_widgets_workspaces_pages_display.workspace_impl_display.workspace', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/workspaces/pages/display.workspace/impl/display.workspace',[],function(){});
csui.define('xecmpf/widgets/workspaces/pages/display.workspace/display.workspace.view',['csui/lib/jquery', 'csui/lib/underscore',
  'csui/lib/marionette', 'csui/lib/radio',
  'csui/integration/folderbrowser2/folderbrowser2.widget',
  'csui/utils/contexts/factories/connector',
  'csui/behaviors/keyboard.navigation/tabables.behavior',
  'xecmpf/utils/commands/folderbrowse/open.full.page.workspace',
  'csui-ext!xecmpf/widgets/workspaces/pages/display.workspace/display.workspace.view',
  'csui/dialogs/modal.alert/modal.alert',
  'i18n!xecmpf/widgets/workspaces/pages/display.workspace/impl/nls/lang',
  'hbs!xecmpf/widgets/workspaces/pages/display.workspace/impl/display.workspace',
  'css!xecmpf/widgets/workspaces/pages/display.workspace/impl/display.workspace'
], function ($, _, Marionette, Radio, FolderBrowser2Widget,
  ConnectorFactory, TabablesBehavior, OpenFullPageWorkspaceView, ExtensionItems, ModalAlert, lang, template) {

  var channel = Radio.channel('xecmpf-workspace');
  var DisplayWorkspaceView = Marionette.LayoutView.extend({
    template: template,
    tagName: "div",
    id: "xecmpf-display_wksp",
    className: "xecmpf-page",
    regions: {
      content: "#display_wksp_content",
    },
    constructor: function DisplayWorkspaceView(options) {
      options || (options = {});
      Marionette.LayoutView.prototype.constructor.apply(this, arguments); // sets this.options
    },
    behaviors: {
      TabablesBehavior: {
         behaviorClass: TabablesBehavior
      }
    },
    // SAPRM-10672: authenticate with xecmauth before using /xecm-handler:
    authenticateXecm: function (cgiUrl, deferred) {
      var that = this;
      deferred = deferred || $.Deferred();
      if (!!this.connector.connection.session && !!this.connector.connection.session.ticket) {
        var xhr = new XMLHttpRequest();
        var openFullView = new OpenFullPageWorkspaceView();
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              deferred.resolve();
            } else {
              deferred.reject(lang.failedAuthentication + new Error(xhr.statusText));
            }
          }
        };
        openFullView.authenticate(xhr, cgiUrl, this.connector);

      } else {
        this.options.context.once("sync", function () {
          that.authenticateXecm(cgiUrl, deferred);
        });
      }
      return deferred.promise();
    },

    onShow: function () {
      this.connector = this.options.context.getObject(ConnectorFactory);
      var options = this.options || {},
        status = options.status || {};

      // SAPRM-8688: Improve navigation by a back button
      var require = window.csui && window.csui.require || window.require,
        commands = options.data && options.data.folderBrowserWidget &&
        options.data.folderBrowserWidget.commands || {},
        goToNodeHistory = commands['back.to.last.fragment'] || {},
        goToNodeHistoryEnabled = !_.isUndefined(goToNodeHistory.enabled) ?
        goToNodeHistory.enabled : true,

        openFullPageWorkspace = commands['open.full.page.workspace'] || {},
        openFullPageWorkspaceEnabled = !_.isUndefined(openFullPageWorkspace.enabled) ?
        openFullPageWorkspace.enabled : true,
        fullPageOverlayEnabled = !_.isUndefined(openFullPageWorkspace.fullPageOverlay) ?
        openFullPageWorkspace.fullPageOverlay : true,
        // SAPRM-9805
        // if viewMode is not set we show folderBrowserWidget ( = default )
        // if viewMode is 'fullPage' we show the perspective ( = page ) view
        viewMode = options.data.viewMode ? options.data.viewMode.mode :
        'folderBrowse',
        searchContainer = commands['search.container'] || {},
        searchContainerEnabled = !_.isUndefined(searchContainer.enabled) ?
        searchContainer.enabled : true;

      if (viewMode === 'fullPage') {

        this.cgiUrl = this.connector && this.connector.connection && this.connector.connection.url ?
          this.connector.connection.url.replace('/api/v1', '') : '';
        var that = this;
        this.authenticateXecm(this.cgiUrl)
          .done(function () {
            csui.require(['xecmpf/widgets/integration/folderbrowse/full.page.workspace.view',
                'csui/utils/url'
              ],
              function (FullPageWorkspaceView, Url) {
                var fullPageNoIFrameOptions = _.extend(that.options, {
                  nodeID: that.options.status.workspaceNode.get('id'),
                  connector: that.connector
                });
                var fullPageWorkspace = new FullPageWorkspaceView(fullPageNoIFrameOptions);
                that.content.show(fullPageWorkspace);
              });
          })
          .fail(function (error) {
            ModalAlert.showError(error.toString());
            console.error(error);
          });
      } else {
        if (ExtensionItems !== undefined && ExtensionItems.length > 0) {
          // At the moment, only the first extension item is given priority and others are ignored
          var extensionItem = new ExtensionItems[0](options);
          if (!this.connector.connection.session) {
            var self = this;
            this.options.context.once("sync", function () {
              self.content.show(extensionItem);
            });
          } else {
            this.content.show(extensionItem);
          }
        } else {
          csui.require.config({
            config: {
              'csui/utils/commands/back.to.last.fragment': {
                enabled: goToNodeHistoryEnabled
              },
              // SAPRM-8746: SAP users wants to search from here
              // SAPRM-8752: SAP users wants to open the full page workspace
              'xecmpf/utils/commands/folderbrowse/search.container': {
                enabled: searchContainerEnabled
              },
              'xecmpf/utils/commands/folderbrowse/open.full.page.workspace': {
                enabled: openFullPageWorkspaceEnabled,
                fullPageOverlay: fullPageOverlayEnabled
              }
            }
          });

          this.$el.addClass("binf-widgets xecm-page-widget");

          this.browser = new FolderBrowser2Widget({
            breadcrumb: !goToNodeHistoryEnabled,
            connection: this.connector.connection,
            start: {
              id: status.workspaceNode.attributes.id
            }
          });
          _.extend(this.browser.options.context.options, {
            suppressReferencePanel: true,
            viewMode: this.options.data.viewMode || this.options.status.viewMode,
            initialWkspId: this.options.status.workspaceNode.get('id'),
            navigateMode: this.options.data.navigateMode,
            enableWorkspaceNavigation: false
          });
          self = this;
          this.listenTo(channel, 'xecm:delete:workspace', function () {
            channel.trigger('xecm:close:fullpage:overlay'); // closes the full page overlay if open
            _.defaults(self.options.data, {
              deletecallback: true
            });
            self.options.status.wksp_controller.selectWorkspace(self.options);
          });
          // TODO: Remove the below line to add class 'csui-folderbrowser'
          // after it is taken care by the csui folderbrowser2.widget
          this.$el.find("#display_wksp_content").addClass('csui-folderbrowser');
          // Display the widget.
          this.browser.show({
            // Placeholder is mandatory, but can be passed to the show
            // method first, because it is needed first for rendering.
            placeholder: "#display_wksp_content"
          });
        }
      }
    },

    onDestroy: function () {
      if (this.browser) {
        this.browser.destroy();
      }
    }
  });
  return DisplayWorkspaceView;
});
csui.define('xecmpf/widgets/workspaces/pages/update.workspace/impl/nls/lang',{
    // Always load the root bundle for the default locale (en-us)
    "root": true,
    // Do not load English locale bundle provided by the root bundle
    "en-us": false,
    "en": false
});

csui.define('xecmpf/widgets/workspaces/pages/update.workspace/impl/nls/root/lang',{
    pageTitle: 'Complete workspace',
    completeWorkspace: 'Complete',
    completeWorkspaceTooltip: 'Complete workspace',
    failedToUpdateItem: 'Failed to update the item.',
    cancel: 'Cancel',
    nameIsGeneratedAutomatically: 'Workspace name is generated automatically.',
    errorGettingCreateForm: 'Error getting form for workspace creation.'
});



/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/workspaces/pages/update.workspace/impl/update.workspace',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div id=\"content\" class=\"cs-properties-wrapper\"></div>\r\n<div id=\"footer\"></div>\r\n\r\n";
}});
Handlebars.registerPartial('xecmpf_widgets_workspaces_pages_update.workspace_impl_update.workspace', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/workspaces/pages/update.workspace/impl/update.workspace',[],function(){});
/**
 * Created by cknoblic on 08.09.2016.
 */
csui.define('xecmpf/widgets/workspaces/pages/update.workspace/update.workspace.view',['module', 'csui/lib/jquery', 'csui/lib/underscore',
    'csui/lib/backbone',
    'csui/lib/marionette',
    'csui/utils/log',
    'csui/utils/base',
    'csui/utils/namedsessionstorage',
    'xecmpf/widgets/workspaces/controls/tile/tile.view',
    'xecmpf/widgets/workspaces/controls/footer/footer.view',
    "csui/widgets/metadata/metadata.properties.view",
    'csui/widgets/metadata/metadata.action.one.item.properties.view',
    'csui/models/node/node.model',
    'csui/utils/contexts/factories/connector',
    'csui/dialogs/modal.alert/modal.alert',
    'csui/controls/progressblocker/blocker',
    'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',
    'csui/behaviors/keyboard.navigation/tabables.behavior',
    'csui/utils/url',
    'csui/utils/commands',
    'conws/models/workspacecreateforms',
    'i18n!xecmpf/widgets/workspaces/pages/update.workspace/impl/nls/lang',
    'hbs!xecmpf/widgets/workspaces/pages/update.workspace/impl/update.workspace',
    'css!xecmpf/widgets/workspaces/pages/update.workspace/impl/update.workspace'

], function (module, $, _, Backbone, Marionette, log, base,
             NamedSessionStorage,
             TileView,
             FooterView,
             MetadataPropertiesView,
             MetadataActionOneItemPropertiesView,
             NodeModel,
             ConnectorFactory,
             ModalAlert,
             BlockingView,
             LayoutViewEventsPropagationMixin,
             TabablesBehavior,
             Url,
             commands,
             WorkspaceCreateFormCollection,
             lang,
             template,
             css) {

    // XECMPF-1532: Remove all commands for early workspace
    //              In integration scenarios categories/classifications etc. should be set
    //              automatically by template configuration
    var propCmds = commands.clone();
    propCmds.reset();

    var UpdateWorkspaceView = Marionette.LayoutView.extend({

        tagName: "div",
        id: "xecmpf-update_wksp",
        className: "xecmpf-page",

        template: template,
        regions: {
            content: "#content",
            footer: "#footer"
        },

        behaviors: {
            TabablesBehavior: {
                behaviorClass: TabablesBehavior,
                recursiveNavigation: true,
                containTabFocus: true
            }
        },

        constructor: function UpdateWorkspaceView(options) {
            var self = this;
            Marionette.LayoutView.prototype.constructor.apply(this, arguments);
            this.context = this.options.context || {};
            this.propagateEventsToRegions();
            this.readOnlyCats = {};
            this.readOnlyCatVals = {};
            // FIXME keyboard keydown event is registered twice see LPAD-54770
            this.on('dom:refresh', function () {
                if ($._data) {
                    var events = $._data(this.el, "events");
                    if (events && events.keydown && events.keydown.length > 1) {
                        var eventName = !_.isEmpty(events.keydown[1].namespace) ?
                            events.keydown[1].type + '.' + events.keydown[1].namespace : events.keydown[1].type;
                        eventName && events.keydown[1].handler && self.$el.off(eventName, events.keydown[1].handler)
                    }
                }
            });
            var readOnlyCats = this.readOnlyCats,
                readOnlyCatVals = this.readOnlyCatVals;

            this._saveField = function (args) {
                // This view is shared for both creation and editing scenarios.
                // Do not save immediately in the creation mode.  The creation dialog
                // has a button to get all field values and perform the action.
                if (this.mode === 'create') {
                    return;
                }


                // _.chain(this.model.get('schema').properties['52238_2'].properties)

                // Optimizing the payload to send a part of the category, which has to
                // be complete, is complicated.  The classic UI sends all data anyway.
                // Until we have PATCH behaviour in the REST API, it doesn't pay off.
                var values = this.getValues(),
                    self = this,
                    originalCategories = this.originalCategories;

                if (this.isCancelButton) {
                    _.each(values, function (value, key) {
                        if (typeof value !== 'object' || value instanceof Array) {
                            values[key] = originalCategories[key];
                        }
                        else if (typeof value === 'object') {
                            _.chain(value).each(function (setFieldDef, setFieldKey) {
                                if (setFieldKey !== 'metadata_token') {
                                    values[key][setFieldKey] = originalCategories[key][setFieldKey];
                                }
                            });
                        }
                    });
                }

                // Savechanges should be invoked only for the current category which is being edited. 
                // Hence take the current category id into a var and compare while setting the attribute values.
                var currentId = this.model.get("id");

                // this.model.get('schema')
                _.chain(readOnlyCats).each(function (readOnlyCatModel, id) { // => id = 'catgpory => 52238'

                    // if the category being edited is not the workspace category, 
                    //continue the loop without processing.

                    //compare only the values of id and currentId - ignore the datatypes.

                    if (currentId !== undefined && (!isNaN(Number(id)) && currentId !== Number(id))) {
                        return true;
                    }

                    // check readonly fields in category
                    _.chain(readOnlyCatModel.properties).each(function (schemaDef, key) { // key =>52238_2
                        if (schemaDef.type === 'object') {
                            // id == Cat Id => sets
                            _.chain(schemaDef.properties).each(function (setFieldDef, setFieldKey) { // setFieldKey => "52238_2_1_6"
                                if (setFieldDef.readonly === true) {
                                    values[key][setFieldKey] = readOnlyCatVals[id + ':' + key + ':' + setFieldKey];
                                }
                            })
                        } else if (schemaDef.type === 'array' && _.has(schemaDef, 'items')) {
                            var tabProps = schemaDef.items.properties;
                            _.chain(tabProps).each(
                                function (tabField, tabKey) { //  tabkey => 34359_9_x_10
                                    if (tabField.readonly === true) {
                                        _.chain(values[key]).each(function (tableRow, index) {
                                            var readOnlyVal = readOnlyCatVals[id + ':' + key + ':' +  index + ':' + tabKey];
                                            if (!_.isUndefined(readOnlyVal)) {
                                                tableRow[tabKey] = readOnlyVal;
                                            }
                                        });
                                    }
                                })

                        } else if (schemaDef.readonly === true) { // simple or array type
                            values[key] = readOnlyCatVals[id + ':' + key];
                        }
                    })
                })

                return this._saveChanges(values);
            }
        },
        _getController: function () {
            return this.options.status.wksp_controller;
        },
        _createFormCollection: function () {
            var self = this,
                options = this.options || {},
                context = options.context,
                status = options.status,
                workspace = status.workspace;

            // options required by constructor
            this.formCollection = new WorkspaceCreateFormCollection(undefined,
                _.defaults(options, {
                    type: workspace.get("type"),
                    wsType: workspace.get("wnf_wksp_type_id"),
                    node: new NodeModel(undefined, {
                            // node model collection needs connector
                            connector: context.getObject(ConnectorFactory)
                        }
                    )
                }));

            // bo_id is set externally
            this.formCollection.bo_id = options.data.busObjectId;
            this.formCollection.url = function () {

                var path = 'forms/businessworkspaces/create',
                    params = {
                        template_id: workspace.get("wnf_wksp_template_id"),
                        parent_id: workspace.get("parent_id"),
                        ext_system_id: options.data.extSystemId,
                        bo_type: options.data.busObjectType,
                        bo_id: options.data.busObjectId,
                        completeWorkspace: true
                    },
                    resource = path + '?' + $.param(_.omit(params, function (value) {
                            return value === null || value === undefined || value === '';
                        })),
                    url = context.getObject(ConnectorFactory).getConnectionUrl().getApiBase('v2');
                return Url.combine(url, resource);
            };

            this.formCollection.on("error", function (model, response, options) {
                var errmsg = response && (new base.Error(response)).message || lang.errorGettingCreateForm;
                log.error("Fetching the create forms failed: {0}", errmsg) && console.error(log.last);
                ModalAlert.showError(errmsg);
            });

        },
        _updateWorkspaceReference: function (model, formsValues) {
            // FormData available (IE10+, WebKit)
            var formData = new FormData();
            formData.append('body', JSON.stringify(formsValues));

            var options = {
                type: 'PUT',
                url: Url.combine(model.connector.getConnectionUrl().getApiBase('v2'),
                    'businessworkspaces', model.get("id"), 'workspacereferences'),
                data: formData,
                contentType: false,
                processData: false
            };
            return model.connector.makeAjaxCall(options);
        },
        _complete: function (options) {
            var namedSessionStorage = new NamedSessionStorage("create_complete_wksp");
            var self = this,
                data = this.tileView.contentView.getValues(),
                dfd = $.Deferred();

            if (!_.isEmpty(data)) {
                var context = options.context || {},
                    status = options.status,
                    workspace = status.workspace;
                var nodeId = workspace.get("id");

                self._updateWorkspaceReference(
                    new NodeModel({
                        id: nodeId
                    }, {
                        // node model collection needs connector
                        connector: context.getObject(ConnectorFactory)
                    }),
                    {
                        bo_type: self.getOption("data").busObjectType,
                        bo_id: self.getOption("data").busObjectId,
                        ext_system_id: self.getOption("data").extSystemId
                    }).done(_.bind(function (resp) {
                    dfd.resolve();
                    if (resp) {
                        _.extend(status, {
                            workspaceNode: new NodeModel({
                                id: nodeId,
                                container: true
                            }),
                            viewMode: {
                                mode: options.data.viewMode ? options.data.viewMode.mode : 'folderBrowse'
                            }
                        });
                        namedSessionStorage.set(options.data.busObjectType+'-'+options.data.busObjectId,nodeId);
                        self._getController().displayWorkspace(options);
                    }
                }, this))
                    .fail(function (resp) {
                        var error = lang.failedToUpdateItem;
                        if (resp) {
                            if (resp.responseJSON && resp.responseJSON.error) {
                                error = resp.responseJSON.error;
                            } else if (resp.responseText) {
                                error = resp.responseText;
                            }
                            ModalAlert.showError(error);
                        }
                        dfd.reject();
                    });
            }
            else {
                // Position to field with error message
                $('.binf-has-error') && $('.binf-has-error')[0].scrollIntoView()
                dfd.reject();
            }
            
            return dfd.promise();
        },
        _setHeader: function (model) {
            // we have special behavior for the name field, depending on the forms result.
            // so we put the code here, where we have access to the name field in the dialog header.
            var general = this.formCollection.at(0);
            var data = general.get("data");
            if (data) {
                var name = data.name,
                    self = this;
                log.debug("name fetched and used: {0}", name) && console.log(log.last);
                this.node.set("name", name);
            } else {
                // if no server data object is set, then we set an empty name.
                log.debug("name set to empty.") && console.log(log.last);
                this.node.set("name", "");
            }

            var headerView = this.tileView.contentView.metadataHeaderView,
                nameView = headerView && headerView.metadataItemNameView;

            if (nameView) {
                var gs = general.get("schema"),
                    isReadOnly = (gs && gs.properties && gs.properties.name && gs.properties.name.readonly) ? true : false,
                    placeHolder = isReadOnly ? lang.nameIsGeneratedAutomatically : undefined;
                nameView.setPlaceHolder(placeHolder);
                if ((isReadOnly ? true : false) !== (nameView.readonly ? true : false)) {
                    nameView.setReadOnly(isReadOnly);
                }
                nameView.stopListening(this.node);
            }
        },
        _updateModel: function (model) {
            var self = this;
            this._setHeader(model);
            if (model) {
                // each form model represents a tab e.g. 'general', 'categories' (with all categories) or 'classifications'
                // model is 'general' or applied category form (with ONE category)
                this.formCollection.models.forEach(function (formModel) {
                    // each form model consist
                    var formData = formModel.get("data"),
                        formSchema = formModel.get("schema");

                    // formSchema: 51806, 52238 (all categories)
                    if (_.has(formSchema.properties, model.get("id"))) { // =>52238

                        // get schema def from create form
                        var modelId = model.get("id"),  // =>52238
                            origModelSchema = model.get("schema"),
                            formSchemaDef = formSchema.properties[modelId];

                        formModel = formData[modelId];
                        // check all form model fields against original model
                        _.chain(formSchemaDef.properties).each(
                            function (field, key, list) { // key =>52238_2

                                // check  form model field against original model
                                if (_.has(origModelSchema.properties, key)) {  // 'catgpory => 52238'  key =>52238_2
                                    var formProps = field.properties,
                                        // no data in model? Should not happen?
                                        origModelData = model.get("data")[key],
                                        origModelFieldSchema = origModelSchema.properties[key],
                                        formModelData = formModel[key];

                                    // sets
                                    if (field.type === 'object') {
                                        var origModelSetSchema = origModelFieldSchema.properties;
                                        _.chain(formProps).each(
                                            function (setField, setFieldKey) { //  setFieldKey => "52238_2_1_6"
                                                if (setField.readonly === true) {
                                                    origModelSetSchema[setFieldKey].readonly = setField.readonly;
                                                    self.readOnlyCatVals[modelId + ':' + key + ':' + setFieldKey] = origModelData[setFieldKey];
                                                    self.readOnlyCats[modelId] = origModelSchema;
                                                    origModelData[setFieldKey] = formModelData[setFieldKey];
                                                }
                                            })
                                    }
                                    else if (!field.readonly && field.type === 'array' && _.has(field, 'items')) {
                                        var formTabularProps = field.items.properties,
                                            origModelTabSchema = origModelFieldSchema.items.properties;

                                        _.chain(formTabularProps).each(
                                            function (tabField, tabKey) { //  tabkey => 34359_9_x_10
                                                if (tabField.readonly === true) {
                                                    origModelTabSchema[tabKey].readonly = tabField.readonly;

                                                    _.chain(formModelData).each(function (tableRow, index) {
                                                        // orig model can have less entries
                                                        origModelData[index] || (origModelData[index] = {});
                                                        self.readOnlyCatVals[modelId + ':' + key + ':' + index + ':' + tabKey] =
                                                            origModelData[index][tabKey];
                                                        origModelData[index][tabKey] = tableRow[tabKey]
                                                    });

                                                    self.readOnlyCats[modelId] = origModelSchema;
                                                }
                                            })


                                    }
                                    else if (field.readonly) { // simple/array field type string
                                        origModelFieldSchema.readonly = field.readonly;
                                        self.readOnlyCatVals[modelId + ':' + key] = origModelData;
                                        self.readOnlyCats[modelId] = origModelSchema;
                                        model.get("data")[key] = formModelData;
                                    }
                                }
                            }
                        );
                    }
                });
            }
        },
        fetchForm: function () {
            this._createFormCollection();
            return this.formCollection.fetch();
        },
        revertAllModifiedCategories: function () {
            var children = [];
            this.tileView.contentView.metadataPropertiesView.tabContent.children.each(function(child, key) {
                children.push(child);
            });
            this.updateCategoriesOnCancel(children);
        },
        updateCategoriesOnCancel: function (children) {

            if (children.length > 0) {
                if (children[0].model.get('role_name') === 'categories' || children[0].model.get('id') === 'general') {
                    children[0].content.isCancelButton = true;
                    var promise = children[0].content._saveField();
                    // promise is returned after updating the category values
                    if (promise) {
                        promise.always(_.bind(function () {
                            children.shift();
                            this.updateCategoriesOnCancel(children);
                        }, this));
                        // promise is not returned after updating the values of "general" tab
                    } else {
                        children.shift();
                        this.updateCategoriesOnCancel(children);
                    }
                }
            } else {
                this.trigger('categories:reverted');
            }
        },
        render: function () {
            var self = this,
                status = this.options.status,
                workspace = status.workspace,
                buttonCollecion = new Backbone.Collection([
                    {
                        click: _.bind(this._complete, this, this.options),
                        disabled: true, primary: false,
                        label: lang.completeWorkspace, toolTip: lang.completeWorkspaceTooltip
                    },
                    {
                        click: _.bind(function () {
                            var dfd = $.Deferred();
                            this.listenTo(this, 'categories:reverted', function() {
                                this._getController().selectWorkspace();
                            });
                            this.revertAllModifiedCategories();
                            dfd.resolve();
                            return dfd.promise();
                        }, this, this.options),
                        disabled: true, primary: false, toolTip: lang.cancel,
                        label: lang.cancel, separate: false
                    }
                ]);

            Marionette.LayoutView.prototype.render.apply(this, arguments);

            this.node = new NodeModel({
                    type_name: workspace.get("type_name"),
                    type: workspace.get("type"),
                    name: workspace.get("name"),
                    id: workspace.get("id"),
                    container: true,
                    wksp_type_name: this.options.wksp_type_name
                },
                {
                    connector: this.context.getObject(ConnectorFactory)
                }
            );

            // adjust model with data from business object
            var CompleteMetadataPropertiesView = MetadataPropertiesView.extend({
                contentViewOptions: function (model) {
                    self._updateModel(model)
                    return MetadataPropertiesView.prototype.contentViewOptions.apply(this, arguments);
                }
            });

            var UpdatePropertiesView = MetadataActionOneItemPropertiesView.extend({
                    constructor: function UpdatePropertiesView(options) {
                        MetadataActionOneItemPropertiesView.prototype.constructor.apply(this, arguments);
                        if (this.options.blockingParentView) {
                            BlockingView.delegate(this, this.options.blockingParentView);
                          } else {
                            BlockingView.imbue(this);
                          }
                        if (this.metadataPropertiesView !== undefined) {
                            this.metadataPropertiesView.stopListening(this);
                        }
                        this.metadataPropertiesView = new CompleteMetadataPropertiesView({
                            node: self.node,
                            commands: propCmds,
                            context: self.options.context,
                            formMode: 'update',
                            action: 'update',
                            metadataView: this
                        });


                        this.listenTo(this.metadataPropertiesView, 'render:forms', function () {
                            buttonCollecion.at(0).set('disabled', false);
                            buttonCollecion.at(1).set('disabled', false);
                            buttonCollecion.at(0).set('primary', true);
                            self.footerView.update();
                            this.metadataPropertiesView.tabContent.children.each(function(child, key) {
                                if (child.model.get('role_name') === 'categories' ||  child.model.get('id') === 'general') {
                                    // remove change field connected to prototype
                                    child.content.off('change:field');
                                    child.content._saveField = function(args) {
                                        return self._saveField.apply(this,args);
                                    }
                                    child.content.listenTo(child.content, 'change:field', child.content._saveField);
                                    var initialData = _.deepClone(child.model.get('data'));
                                    child.content.originalCategories = initialData
                                    self.childContent = child;
                                }
                            })
                        });

                        // remove conws reference panel
                        this.listenTo(this.metadataPropertiesView, 'before:render',
                            function () {
                                var conwsRef = this.metadataPropertiesView.collection.findWhere({id: "conws-reference"});
                                if (conwsRef) {
                                    this.metadataPropertiesView.collection.remove(conwsRef, {silent: true});
                                }
                            });
                    }
                }
            );

            // must be displayed immediately
            this.footerView = new FooterView({
                collection: buttonCollecion
            });

            this.tileView = new TileView({
                title: lang.pageTitle,
                contentView: UpdatePropertiesView,
                contentViewOptions: {
                    model: this.node,
                    context: this.options.context,
                    action: 'update'
                }
            });


        },
        onBeforeShow: function () {
            this.content.show(this.tileView);
            this.footer.show(this.footerView);
        }
    });
    _.extend(UpdateWorkspaceView.prototype, LayoutViewEventsPropagationMixin);
    return UpdateWorkspaceView;
});


csui.define('xecmpf/widgets/workspaces/controllers/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});

csui.define('xecmpf/widgets/workspaces/controllers/impl/nls/root/lang',{
    errorGettingBusinessWorkspaceType: 'Cannot get business workspace type.'
});


csui.define('xecmpf/widgets/workspaces/controllers/dialog.controller',['require',
    'csui/lib/jquery',
    'csui/lib/underscore',
    'csui/lib/marionette',
    'csui/lib/backbone',
    'csui/utils/namedsessionstorage',
    'xecmpf/widgets/workspaces/pages/select.workspace/select.workspace.view',
    'xecmpf/widgets/workspaces/pages/create.workspace/create.workspace.view',
    'xecmpf/widgets/workspaces/pages/display.workspace/display.workspace.view',
    'xecmpf/widgets/workspaces/pages/update.workspace/update.workspace.view',
    'xecmpf/widgets/workspaces/factories/workspace.factory',
    'xecmpf/widgets/workspaces/factories/workspace.types.factory',
    "csui/models/node/node.model",
    'csui/dialogs/modal.alert/modal.alert',
    'i18n!xecmpf/widgets/workspaces/controllers/impl/nls/lang'
], function (require, $, _,
    Marionette, Backbone,
    NamedSessionStorage,
    SelectWorkspaceView,
    CreateWorkspaceView,
    DisplayWorkspaceView,
    UpdateWorkspaceView,
    WorkspacesCollectionFactory,
    WorkspaceTypeCollectionFactory,
    NodeModel,
    ModalAlert,
    lang) {

    var DialogController = Marionette.Object.extend({

        constructor: function DialogController(options) {
            options = options || {};
            this.options = options;
            this.context = this.options.context || {};
            this.region = this.options.region;
        },
        updateWorkspace: function (options) {
            options || (options = this.options);
            this._showUpdateWorkspaceView(options);
        },
        displayWorkspace: function (options) {
            options || (options = this.options);
            this._showDisplayWorkspaceView(options);
        },
        createWorkspace: function (options) {
            options || (options = this.options);
            this._showCreateWorkspaceView(options);
        },
        selectWorkspace: function (options) {
            options || (options = this.options);
            options.status || (options.status = {});

            var context = options.context,
                data = options.data,
                that = this,
                promises = [];

            this._getBOWorkspace(context, data)
                .done(function (boWorkspace) {
                    if (boWorkspace) {
                        _.defaults(options.status, {
                            workspaceNode: boWorkspace,
                            viewMode: {
                                mode: data.viewMode ? data.viewMode.mode : 'folderBrowse'
                            }
                        });
                        that.displayWorkspace(options);
                    } else {
                        promises.push(that._getBOEarlyWorkspaces(context, data));
                        promises.push(that._getBOWorkspaceType(context, data));
                        $.when.apply($, promises)
                            .done(function (boEarlyWorkspaces, boWorkspaceType) {
                                if (boEarlyWorkspaces && !!boEarlyWorkspaces.length) {
                                    that._showSelectWorkspaceView(options);
                                } else {
                                    _.defaults(options.status, {
                                        workspaceType: new Backbone.Model({
                                            wksp_type_name: boWorkspaceType.get('wksp_type_name'),
                                            wksp_type_id: boWorkspaceType.get('wksp_type_id'),
                                            rm_enabled: boWorkspaceType.get('rm_enabled'),
                                            template: boWorkspaceType.get('templates')[0],
                                            type: 848
                                        }),
                                        mode: 'directCreate'
                                    });
                                    that._showCreateWorkspaceView(options);
                                }
                            })
                            .fail(function (jqXHR, statusText, error) {
                                if (jqXHR) {
                                    if (jqXHR.responseJSON && jqXHR.responseJSON.error) {
                                        ModalAlert.showError(lang.errorGettingBusinessWorkspaceType + ' ' + jqXHR.responseJSON.error);
                                    } else {
                                        ModalAlert.showError(lang.errorGettingBusinessWorkspaceType);
                                    }
                                }
                            });
                    }
                    // remove deletion flag for special handling in _getBOWorkspace() and
                    // _getBOEarlyWorkspaces() after business workspace was deleted
                    delete data.deletecallback;

                })
                .fail(function (jqXHR, statusText, error) {
                    if (jqXHR) {
                        if (jqXHR.responseJSON && jqXHR.responseJSON.error) {
                            ModalAlert.showError(lang.errorGettingBusinessWorkspaceType + ' ' + jqXHR.responseJSON.error);
                        } else {
                            ModalAlert.showError(lang.errorGettingBusinessWorkspaceType);
                        }
                    }
                });
        },

        _showCreateWorkspaceView: function (options) {
            this.region.show(new CreateWorkspaceView(options));
        },
        _showDisplayWorkspaceView: function (options) {
            var new_nodeId;
            var data = {};
            // for refresh:
            // after CreateWorkspaceView
            if (options.region.currentView instanceof CreateWorkspaceView ||
                options.region.currentView instanceof UpdateWorkspaceView) {
                this.region.show(new DisplayWorkspaceView(options));
            }
            // folderBrowse <-> folderBrowse
            else if (this.region.currentView &&
                this.region.currentView.browser &&
                this.options.data.viewMode.mode === 'folderBrowse') {
                new_nodeId = this.options.status.workspaceNode.get('id');

                csui.require.config({
                    config: {
                        'csui/integration/folderbrowser2/container.enforcer': {
                            enabled: true
                        }
                    }
                });
                this.region.currentView.browser.setStartId(new_nodeId);
            }
            // fullPage <-> fullPage
            else if (this.region.currentView &&
                this.region.currentView.browser === undefined &&
                $('.xecm-full-page-workspace.xecm-no-iframe-wrap').length > 0 &&
                this.options.data.viewMode.mode === 'fullPage') {
                new_nodeId = this.options.status.workspaceNode.get('id');
                data.action = 'enterContainer';
                data.id = new_nodeId;
                this.trigger('xecm:change:fullPage', data);
            }
            // folderBrowse <-> fullPage
            else {
                this.region.show(new DisplayWorkspaceView(options));
            }
        },
        _showUpdateWorkspaceView: function (options) {
            var updateView = new UpdateWorkspaceView(options),
                self = this;
            updateView.fetchForm().done(function (data, textStatus, jqXHR) {
                updateView.options.wksp_type_name = data.forms[0].data.wksp_type_name;
                self.region.show(updateView);
            });
        },
        _showSelectWorkspaceView: function (options) {
            this.region.show(new SelectWorkspaceView(options));
        },

        _getBOWorkspace: function (context, data) {
            var deferred = $.Deferred();
            var boWorkspace = false;
            var namedSessionStorage = new NamedSessionStorage("create_complete_wksp");
            var wkspDeleted = (this.options.deletecallback || data.deletecallback);

            var collection = context.getCollection(WorkspacesCollectionFactory, {
                attributes: data.busObjectId,
                busObjectId: data.busObjectId,
                busObjectType: data.busObjectType,
                extSystemId: data.extSystemId,
                detached: false // fetching manually
            });
            //if workspace is deleted, navigate to 'Create or Complete Business Workspace widget'
            if (wkspDeleted) {
                namedSessionStorage.remove(data.busObjectType + "-" + data.busObjectId);
                // force fetching if bus. object ID is requested again for refresh
                collection.fetched = false;
                // after workspace is deleted remove workspaceNodeId as nodeId will then be set again
                // from return of collection.fetch()
                delete this.options.data.workspaceNodeId;
                deferred.resolve(boWorkspace);
            }

            // workspace not just deleted, but already checked:
            else if (namedSessionStorage.get(data.busObjectType + "-" + data.busObjectId) && !(wkspDeleted)) {
                var workspaceNodeId = namedSessionStorage.get(data.busObjectType + "-" + data.busObjectId);
                boWorkspace = new NodeModel({
                    id: workspaceNodeId,
                    container: true
                })
                deferred.resolve(boWorkspace);
            }
            // SAPRM-12772:
            // if 'workspaceNodeId' property is present, the existance of CS workspace for the BO
            // is already checked from the outer application e.g. by SAP or by fiori/odata
            else if (!!data['workspaceNodeId']) {
                boWorkspace = new NodeModel({
                    id: data.workspaceNodeId,
                    container: true
                })
                deferred.resolve(boWorkspace);
            }

            // else check the existance of CS workspace for the BO
            else {

                collection.ensureFetched()
                    .done(function () {
                        if (collection.length === 1) {
                            var nodeId = collection.at(0).get('id');
                            boWorkspace = new NodeModel({
                                id: nodeId,
                                container: true
                            });
                            namedSessionStorage.set(data.busObjectType + '-' + data.busObjectId, nodeId);
                        }

                        deferred.resolve(boWorkspace);
                    })
                    .fail(function () {
                        deferred.reject.apply(deferred, arguments);
                    });
            }
            return deferred;
        },
        _getBOEarlyWorkspaces: function (context, data) {
            var deferred = $.Deferred();
            var collection = context.getCollection(WorkspacesCollectionFactory, {
                attributes: 'early',
                early: true,
                busObjectType: data.busObjectType,
                extSystemId: data.extSystemId,
                detached: true // fetching manually
            });

            var promise;
            // if BO Workspace is deleted, then fetch the early workspaces from server again
            if (data.deletecallback || this.options.deletecallback) {
                promise = collection.fetch();
            } else {
                promise = collection.ensureFetched();
            }

            promise
                .done(function () {
                    deferred.resolve(collection);
                })
                .fail(function () {
                    deferred.reject.apply(deferred, arguments);
                });
            return deferred;
        },
        _getBOWorkspaceType: function (context, data) {
            var deferred = $.Deferred();
            var boWorkspaceType = false;
            var collection = context.getCollection(WorkspaceTypeCollectionFactory, {
                busObjectType: data.busObjectType,
                extSystemId: data.extSystemId,
                detached: true // fetching manually
            });
            collection.ensureFetched()
                .done(function () {
                    if (collection.at(0).get('templates').length === 1) {
                        boWorkspaceType = collection.at(0);
                    }
                    deferred.resolve(boWorkspaceType);
                })
                .fail(function () {
                    deferred.reject.apply(deferred, arguments);
                });

            return deferred;
        }
    });

    return DialogController;
});
/**
 * Created by cknoblic on 04.10.2016.
 */

csui.define('xecmpf/widgets/workspaces/utils/urlhelper',['module',
    'csui/lib/jquery',
    'csui/lib/underscore',
    'csui/utils/log',
    'csui/utils/base'
], function (module, $, _, log, base) {

    var UrlHelper = {

        getParams: function (location) {
            return location.search.replace('?', '').split('&').reduce(
                function (s, c) {
                    var t = c.split('=');
                    s[t[0].toLowerCase()] = t[1];
                    return s;
                },
                {});
        },
    }
    return UrlHelper;
});

/**
 * Created by cknoblic on 28.09.2016.
 */

csui.define('xecmpf/widgets/workspaces/workspaces.widget',["csui/lib/underscore",
  "csui/lib/marionette",
  "csui/lib/backbone",
  'xecmpf/widgets/workspaces/controllers/dialog.controller',
  'xecmpf/widgets/workspaces/utils/urlhelper',
  'csui/utils/contexts/factories/user',
  'xecmpf/widgets/workspaces/pages/select.workspace/select.workspace.view'
], function (_, Marionette,
  Backbone,
  DialogController,
  UrlHelper,
  UserModelFactory,
  SelectWorkspaceView) {

  var SlideTransitionRegion = Backbone.Marionette.Region.extend({

    show: function (view) {
      this._ensureElement();
      view.render();
      this.close(function () {
        this.currentView = view;
        this.open(view, function () {
          if (view instanceof SelectWorkspaceView) {
            Marionette.triggerMethodOn(view, 'show');
          }
        });
      });

    },
    // slide out
    close: function (cbOpen) {
      var view = this.currentView,
        that = this;

      delete this.currentView;
      // there is only one view  ==> display it
      if (!view) {
        if (cbOpen) {
          cbOpen.call(this);
        }
        return;
      }
      // close "old" view
      view.$el.hide('slide', {
        direction: 'left',
        complete: function () {

          if (view.destroy) {
            view.destroy();
          }
          // ==> display new view
          if (cbOpen) {
            cbOpen.call(that);
          }
        }
      }, 250);

    },
    // slide in
    open: function (view, cbDomRefresh) {
      var that = this;
      this.$el.hide();

      this.$el.html(view.$el);

      Marionette.triggerMethodOn(view, 'before:show');
      Marionette.triggerMethodOn(view, 'show');
      Marionette.triggerMethodOn(view, 'dom:refresh');

      this.$el.show('slide', {
        direction: 'right',
        complete: function () {
          if (cbDomRefresh) {
            cbDomRefresh.call(that);
          }
        }

      }, 250);
    }
  });

  function CompleteCreateWorkspaceWidget(options) {
    options || (options = {});
    var params = UrlHelper.getParams(window.location);
    if (_.isEmpty(options.data) && !_.isEmpty(params)) {
      this.options = _.defaults({}, options, {
        data: {
          busObjectId: params.busobjectid,
          busObjectType: params.busobjecttype,
          extSystemId: params.extsystemid
        }
      });
    } else {
      this.options = options;
    }

    this.options.context.user = this.options.context.getModel(UserModelFactory);
  }

  _.extend(CompleteCreateWorkspaceWidget.prototype, {

    refresh: function (options) {

      if (options.data.busObjectId && options.data.busObjectType && options.data.extSystemId) {
        // remove former workspace, so it can be reset in dialog.controller in selectWorkspace
        // with _.default() after refetch
        if (this.options.status.workspaceNode) {
          delete this.options.status.workspaceNode;
        }

        if (this.options.data.workspaceNodeId) {
          delete this.options.data.workspaceNodeId;
        }

        // Point to new bus. object
        this.options.data.busObjectType = options.data.busObjectType;
        this.options.data.extSystemId = options.data.extSystemId;
        this.options.data.busObjectId = options.data.busObjectId;
      }

      // reset viewMode folderBrowse/fullPage
      if (options.data.viewMode) {
        if (this.options.data.viewMode === undefined) {
          this.options.data.viewMode = {};
        }
        this.options.data.viewMode.mode = options.data.viewMode;
      }

      if (options.data.navigateMode) {
        this.options.data.navigateMode = options.data.navigateMode;
      }

      this.show(this.options);

    },

    show: function (options) {
      this.showView(this, options);
    },

    showView: function (self, options) {
      if (!self.region) {
        self.region = new SlideTransitionRegion({
          el: options.placeholder
        });
      }
      _.defaults(self.options, options, {
        region: self.region
      });
      self.options.status = self.options.status || {};
      // dialog controller
      _.defaults(self.options.status, {
        wksp_controller: new DialogController(self.options)
      });
      self.options.status.wksp_controller.selectWorkspace(self.options);
    },

    close: function () {
      // Allow calling this method multiple times without error
      if (this.region && this.region.currentView) {
        // Destroy the application widget
        if (this.region.currentView.content) {
          this.region.currentView.content.destroy();
        }
        if (this.region.currentView.browser) {
          this.region.currentView.browser.destroy()
        }
        this.region.currentView.destroy();
        this.region.destroy();
        this.region = null;
      }
      return this;
    }

  });

  CompleteCreateWorkspaceWidget.version = '1.0';
  return CompleteCreateWorkspaceWidget;
});
// Lists explicit locale mappings and fallbacks
csui.define('xecmpf/widgets/myattachments/nls/myattachments.lang',{
    // Always load the root bundle for the default locale (en-us)
    "root": true,
    // Do not load English locale bundle provided by the root bundle
    "en-us": false,
    "en": false,    
});

//define({ "root": true });

// Defines localizable strings in the default language (English)
csui.define('xecmpf/widgets/myattachments/nls/root/myattachments.lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false,
  "attachmentsTabTitle": "Business Objects",
  "ErrorLoadingAddItemMenu": 'Cannot load business object types to the Add menu.',
  "DetachBusinessAttachment": "Detach",
  "GoToWorkspace":            "Go to Workspace",
  "OpenSapObject":            "Display",
  "AddBusinessAttachment":    "Add Business Object",
  "ErrorCreatingBusAttachment":  "Cannot create business attachment.",
  "BOSearchTitle":             "Search business objects",
  "noBusinessAttachmentsAvailable": "Add business objects to this Content Server item.",
  "tableColumnSearchNoResult": "No results found."
});


csui.define('xecmpf/utils/commands/myattachments/detach_myattachment',['module', 'csui/models/command',
    'csui/utils/commandhelper',
    'csui/lib/jquery',
    'csui/lib/underscore',
    'csui/utils/commands/confirmable',
    'csui/utils/command.error',
    'i18n!xecmpf/utils/commands/nls/localized.strings'
], function (module, CommandModel, CommandHelper, $, _, ConfirmableCommand, CommandError, lang) {
    'use strict';

    var messageHelper;
    var globalMessage;
    var base;
    var globals = {};

    // Dependencies initialized during execution

    var DetachAttachmentCommand = CommandModel.extend({

        defaults: {
            signature: 'detach_business_attachment',
            command_key: ['detach_business_attachment'],
            name: lang.CommandNameDetach,
            pageLeavingWarning: lang.DetachPageLeavingWarning,
            scope: 'multiple',
            doneVerb: lang.CommandDoneVerbDetached,
            successMessages: {
                formatForNone: lang.DetachBusAttsNoneMessage,
                formatForOne: lang.DetachOneBusAttSuccessMessage,
                formatForTwo: lang.DetachSomeBusAttsSuccessMessage,
                formatForFive: lang.DetachManyBusAttsSuccessMessage
            },
            errorMessages: {
                formatForNone: lang.DetachBusAttsNoneMessage,
                formatForOne: lang.DetachOneBusAttFailMessage,
                formatForTwo: lang.DetachSomeBusAttsFailMessage,
                formatForFive: lang.DetachManyBusAttsFailMessage
            }
        },

        _getConfirmTemplate: function (status, options) {
            return _.template("<span class='msgIcon WarningIcon'><%- message %></span>");
        },

        _getConfirmData: function (status, options) {
            var nodes = CommandHelper.getAtLeastOneNode(status);
            return {
                title: lang.DetachBusAttsCommandConfirmDialogTitle,
                message: nodes.length === 1 ?
                    _.str.sformat(lang.DetachBusAttsCommandConfirmDialogSingleMessage,
                        nodes.at(0).get('name')) :
                    _.str.sformat(lang.DetachBusAttsCommandConfirmDialogMultipleMessage, nodes.length)
            };
        },

        enabled: function (status, options) {
            var node = CommandHelper.getJustOneNode(status),
			signature = 'delete_business_attachment',
			action = this._getNodeActionForSignature(node, signature);
			if (action) {
				return true;
			} else {
				return false;
			}
        },

        // Perform the detach action. Return a promise, which is resolved with the detached node if
        // successful or rejected with the error.
        // Note, that the node is used later to display the name of the detached item.
        _performAction: function (model, options) {
            var self = this;
            var node = model.node;
            var d = $.Deferred();
            var collection = node.collection;
            if (collection) {
                var jqxhr = node.destroy({
                    wait: true
                })
                    .done(function () {
                        model.set('count', 1);
                        model.deferred.resolve(model);
                        d.resolve(node);
                    })
                    .fail(function (error) {
                        var cmdError = error ? new CommandError(error, node) : error;
                        model.deferred.reject(model, cmdError);
                        if (!error) {
                            jqxhr.abort();
                        }
                        d.reject(cmdError);
                    });
                return d.promise();
            }
            else {
                return d.reject(
                    new CommandError(_.str.sformat(lang.CommandFailedSingular, node.get('name'),
                        lang.CommandVerbDetach), {errorDetails: "collection is undefined"}));
            }
        },

        startGlobalMessage: function (uploadCollection) {
            globalMessage.showProgressPanel(uploadCollection, {
                oneFileTitle: lang.DetachingOneBusAtt,
                oneFileSuccess: lang.DetachOneBusAttSuccessMessage,
                multiFileSuccess: lang.DetachManyBusAttsSuccessMessage,
                oneFilePending: lang.DetachingOneBusAtt,
                multiFilePending: lang.DetachBusAtts,
                oneFileFailure: lang.DetachOneBusAttFailMessage,
                multiFileFailure: lang.DetachManyBusAttsFailMessage2,
                someFileSuccess: lang.DetachSomeBusAttsSuccessMessage,
                someFilePending: lang.DetachingSomeBusAtts,
                someFileFailure: lang.DetachSomeBusAttsFailMessage2,
                enableCancel: false
            });

        },

        _removeBusAtt: function (model) {
            // this.collection.destroy(model);
            return (model.destroy({wait: true}));
        },

        _getRespError: function (resp) {
            var error = '';
            if (resp && resp.responseJSON && resp.responseJSON.error) {
                error = resp.responseJSON.error;
            } else if (base.messageHelper.hasMessages()) {
                error = $(base.messageHelper.toHtml()).text();
                base.messageHelper.clear();
            }
            return error;
        },

        _announceStart: function (status) { //, PageLeavingBlocker) {
            var originatingView = status.originatingView;
            if (originatingView && originatingView.blockActions) {
                originatingView.blockActions();
            }
            var pageLeavingWarning = this.get('pageLeavingWarning');
            if (pageLeavingWarning) {
                this.PageLeavingBlocker.enable(pageLeavingWarning);
            }
        },

        _announceFinish: function (status) {
            var pageLeavingWarning = this.get('pageLeavingWarning');
            if (pageLeavingWarning) {
                this.PageLeavingBlocker.disable();
            }
            var originatingView = status.originatingView;
            if (originatingView && originatingView.unblockActions) {
                originatingView.unblockActions();
            }
        }
    });

    _.extend(DetachAttachmentCommand.prototype, ConfirmableCommand, {
        execute: function (status, options) {
            var nodes    = CommandHelper.getAtLeastOneNode(status),
                node     = nodes.length === 1 && nodes.first(),
                deferred = $.Deferred(),
                commandData = status.data || {};
            var showProgressDialog = (commandData.showProgressDialog != null)? commandData.showProgressDialog: true;
            this.showProgressDialog = showProgressDialog;
            // avoid messages from handleExecutionResults
            status.suppressFailMessage = true;
            status.suppressSuccessMessage = true;
            status.suppressMultipleFailMessage = true;
            ConfirmableCommand.execute
                .apply(this, arguments)
                .done(function (results) {
                    showProgressDialog && globalMessage.hideFileUploadProgress();
                    deferred.resolve(results);
                })
                .fail(function (args) {
                    //only return a result if there is at least one successful delete.
                    //This way the waiting CommandHelper in the tabletoolbar.view will trigger
                    //an execute complete event.
                    var oneSuccess = args && _.find(args, function (result) {
                            return !(result instanceof CommandError);
                        });
                    var rejectResults = oneSuccess ? oneSuccess: args;
                    deferred.reject(rejectResults);
                });
            return deferred.promise();
        },

        _performActions: function (status, options) {
            var deferred = $.Deferred(),
                self = this;
            csui.require(['csui/utils/taskqueue', 'csui/utils/page.leaving.blocker', 'csui/models/fileuploads',
                    "csui/utils/commands/multiple.items",
                    'csui/controls/globalmessage/globalmessage',
                    'csui/utils/messagehelper',
                    'csui/utils/base'
                ], function (TaskQueue, PageLeavingBlocker, UploadFileCollection, MultipleItemsCommand, GlobalMessage, MessageHelper, base) {
                    messageHelper = MessageHelper;
                    globalMessage = GlobalMessage;
                    base = base;
                    self.PageLeavingBlocker = arguments[1];

                    var busAtts = CommandHelper.getAtLeastOneNode(status);
                    var models = busAtts.models;
                    // var models = status.nodes.models;
                    var nodes = _.map(models, function (node) {
                        return {
                            name: node.get('name'),
                            state: 'pending',
                            count: 0,
                            total: 1,
                            node: node
                        };
                    });
                    var connector = models && models[0] && models[0].connector;
                    var uploadCollection = new UploadFileCollection(nodes, {connector: connector});
                    var newStatus = _.defaults({nodes: uploadCollection}, status);
                    // TODO: Make the progressbar a reusable component; do not
                    // misuse the file-upload-progressbar for other scenarios.
                    // TODO: Handle this in the multi-item command to be consistent
                    // with other commands; do not override the detach command only.
                    uploadCollection.each(function (fileUpload) {
                        // Replace the new node in the file upload model with the existing
                        // one to be able to destroy it; sync and destroy events will be
                        // triggered on it and the parent collection and view will see them.
                        var node = fileUpload.get('node');
                        fileUpload.node = node;
                        fileUpload.unset('node');
                    });
                    self.startGlobalMessage(uploadCollection);
                    MultipleItemsCommand._performActions.call(self, newStatus, options)
                        .done(function (results) {
                            globalMessage.hideFileUploadProgress();
                            deferred.resolve(results);
                        })
                        .fail(function (errors) {
                            deferred.reject(errors);
                        });
                },
                function (error) {
                    console.log(error);
                    deferred.reject(error);
                });
            return deferred.promise();

        }
        
    });
    
    return DetachAttachmentCommand;

});


csui.define('xecmpf/utils/commands/myattachments/go_to_workspace',['module', 'csui/models/command',
    'csui/utils/commandhelper',
    'csui/lib/underscore',
    'csui/lib/jquery',
    'i18n!xecmpf/utils/commands/nls/localized.strings'
], function (module, CommandModel, CommandHelper, _, $, lang) {
    'use strict';
    //
    // var config = _.defaults({}, module.config(), {
    //     openInNewTab: false
    // });

    var GoToWorkspaceCommand = CommandModel.extend({

        defaults: {
            signature: 'go_to_workspace',
            command_key: ['go_to_workspace'],
            name: lang.CommandNameGoToWorkspace, 
            scope: 'single'
        },

        enabled: function (status) {
            var node = CommandHelper.getJustOneNode(status),
			signature = this.get('command_key'),
			action = this._getNodeActionForSignature(node, signature);
			if (action) {
				return true;
			} else {
				return false;
			}
        },

        execute: function (status, options) {
            var busAtt = CommandHelper.getJustOneNode(status);
            return this._navigateTo(busAtt, status, options);
        },

        // openInNewTab: function () {
        //     return config.openInNewTab;
        // },

        _navigateTo: function (busAtt, status, options) {
            var deferred = $.Deferred(),
                context = status.context || status.originatingView.options.context,
                wkspNodeId = busAtt.get('wksp_id'); // Get BWs ID from the business attachment
            // Require additional modules dynamically, which needed
            // for the command execution only
            csui.require(['csui/lib/backbone', 'csui/utils/contexts/factories/connector',
                'csui/models/node/node.model', 'csui/utils/commands/browse'
            ], function (Backbone, ConnectorFactory, NodeModel, BrowseCommand) {
                var connector = context.getObject(ConnectorFactory),
                    otherNode = new NodeModel({id: wkspNodeId}, {connector: connector}),
                    browseCommand = new BrowseCommand();
                browseCommand
                    .execute({
                        nodes: new Backbone.Collection([otherNode]),
                        context: context
                    });
            }, function(error) {
                console.log(error);
                deferred.reject();
            });
            return deferred.promise();
        }

    });

    return GoToWorkspaceCommand;

});

csui.define('xecmpf/utils/commands/myattachments/open_sap_object',['module', 'csui/models/command',
    'csui/utils/commandhelper',
    'csui/lib/underscore',
    'csui/lib/jquery',
    'i18n!xecmpf/utils/commands/nls/localized.strings'
], function (module, CommandModel, CommandHelper, _, $, lang) {
    'use strict';

    var config = _.defaults({}, module.config(), {
        openInNewTab: true
    });

    var OpenSapObjectCommand = CommandModel.extend({

        defaults: {
            signature: 'open_sap_object',
            command_key: ['open_sap_object'],
            name: lang.CommandNameOpenSapObject,
            scope: 'single'
        },

        enabled: function (status) {
            var node = CommandHelper.getJustOneNode(status),
			signature = this.get('command_key'),
			action = this._getNodeActionForSignature(node, signature);
			if (action) {
				var currAction = node.actions && node.actions.findRecursively(signature);
				if (currAction.get('href')) {
					return true;
				} else {
					return false;
				}
			} else {
				return false;
			}
        },

        execute: function (status, options) {
            var busAtt = CommandHelper.getJustOneNode(status);
            return this._navigateTo(busAtt, options);
        },

        openInNewTab: function () {
            return config.openInNewTab;
        },

        _navigateTo: function (busAtt, options) {
            var action = busAtt.actions.findRecursively(this.attributes.signature);
            var url = action.get('href');

            if (this.openInNewTab() === true) {
                var browserTab = window.open(url, '_blank');
                browserTab.focus();
            } else {
                location.href = url;
            }

            return $.Deferred().resolve().promise();
        }

    });

    return OpenSapObjectCommand;

});

csui.define('xecmpf/utils/commands/myattachments/add_myattachment',['require', 'csui/models/command',
    'csui/utils/commandhelper',
    'csui/lib/jquery',
    'csui/lib/underscore',
    'csui/utils/commands/confirmable',
    'i18n!xecmpf/utils/commands/nls/localized.strings'
], function (require, CommandModel, CommandHelper, $, _, ConfirmableCommand, lang) {
    'use strict';

    var AttachmentModel;
    var messageHelper;
    var globalMessage;
    var commandError;
    var base;
    var globals = {};

    var AddAttachmentCommand = CommandModel.extend({

        defaults: {
            signature: 'add_business_attachment',
            command_key: ['add_business_attachment'],
            name: lang.CommandNameAttach,
            scope: 'multiple',
            doneVerb: lang.CommandDoneVerbAttached,
            successMessages: {
                formatForNone: lang.AttachBusAttsNoneMessage,
                formatForOne:  lang.AttachOneBusAttSuccessMessage,
                formatForTwo:  lang.AttachSomeBusAttsSuccessMessage,
                formatForFive: lang.AttachManyBusAttsSuccessMessage
            },
            errorMessages: {
                formatForNone: lang.AttachBusAttsNoneMessage,
                formatForOne:  lang.AttachOneBusAttFailMessage,
                formatForTwo:  lang.AttachSomeBusAttsFailMessage,
                formatForFive: lang. AttachManyBusAttsFailMessage
            }
        },

        _getConfirmTemplate: function (status, options) {
            return _.template(lang.AttachBusAttsCommandConfirmDialogHtml);
        },

        _getConfirmData: function (status, options) {
            var nodes = CommandHelper.getAtLeastOneNode(status);
            return {
                title: lang.AttachBusAttsCommandConfirmDialogTitle,
                message: nodes.length === 1 ?
                         _.str.sformat(lang.AttachBusAttsCommandConfirmDialogSingleMessage,
                             nodes.at(0).get('name')) :
                         _.str.sformat(lang.AttachBusAttsCommandConfirmDialogMultipleMessage, nodes.length)
            };
        },

        enabled: function (status) {
            if (status.container.busatts.actions) {
                var add = _.has(status.container.busatts.actions.data, this.defaults.signature);
                if (add) {
                    return true;
                }
                else {

                    return false;
                }
            }
            return false;
        },
    });

    _.extend( AddAttachmentCommand.prototype, ConfirmableCommand, {
        execute: function (status, options) {

            return (this._referenceSearchOpen(status, options));

        },

        _referenceSearchOpen: function (status, options) {
            var deferred = $.Deferred();
            var self = this;
            csui.require([
                    'csui/utils/contexts/factories/connector',
                    'i18n!xecmpf/widgets/myattachments/nls/myattachments.lang',
                    'xecmpf/widgets/myattachments/metadata.attachment.model',
                    'xecmpf/controls/bosearch/bosearch.model',
                    'xecmpf/controls/bosearch/bosearch.dialog.controller',
                    'csui/utils/command.error',
                ], function (ConnectorFactory, lang, AttachmentModelLocal,
                             BoSearchModel, BOSearchDialogController, CommandError) {
                    AttachmentModel = AttachmentModelLocal;
                    commandError = CommandError;
                    self.connector = options.context.getObject(ConnectorFactory);
                    self.collection = status.data.collection;

                    self.boSearchModel = new BoSearchModel(status.data.boType, {
                        connector: self.connector
                    });

                    // Check whether the bus. att. control is executed w/o sidebar
                    var htmlPlace;
                    htmlPlace = ".cs-metadata:has(> .metadata-content-wrapper)";

                    self.boSearchDialogController = new BOSearchDialogController({
                        context: options.context,
                        htmlPlace: htmlPlace,
                        multipleSelect: true,
                        mode: 'business_attachment_add',
                        boSearchModel: self.boSearchModel,
                        title: lang.BOSearchTitle
                    });
                    self.status = status;
                    // SAPRM-9320: together with this topic the events are aligned
                    //self.listenTo(self.boSearchModel, "reference:selected", self._referenceSearchAttach);
                    self.listenTo(self.boSearchModel, "boresult:select", self._referenceSearchAttach);
                    // End of SAPRM-9320
                    self.boSearchModel.trigger("reference:search");
                    deferred.resolve();
                },
                function (error) {
                    console.log(error);
                    deferred.reject(error);
                });
            return deferred.promise();
        },

        _referenceSearchAttach: function (selected) {
            var deferred = $.Deferred(),
                self = this;
            csui.require(['csui/utils/page.leaving.blocker',
                    'csui/models/fileuploads',
                    "csui/utils/commands/multiple.items",
                    'csui/controls/globalmessage/globalmessage',
                    'csui/utils/messagehelper',
                    'csui/utils/command.error',
                    'csui/utils/base'
                ], function (PageLeavingBlocker, UploadFileCollection, MultipleItemsCommand, GlobalMessage, MessageHelper, CommandError, base) {
                    messageHelper = MessageHelper;
                    globalMessage = GlobalMessage;
                    commandError = CommandError;
                    base = base;
                    var options;
                    self.PageLeavingBlocker = arguments[1];
                    // SAPRM-9320:
                    // close the bo search dialog
                    self.boSearchModel.trigger("reference:selected");
                    if (selected.selectedItems) {
                        var models = selected.selectedItems;
                        var nodes = _.map(models, function (node) {
                            return {
                                name: node.get('businessObjectId'),
                                state: 'pending',
                                count: 0,
                                total: 1,
                                node: node
                            };
                        });
                        var connector = models && models[0] && models[0].connector;
                        var uploadCollection = new UploadFileCollection(nodes, {connector: connector});
                        var newStatus = _.defaults({nodes: uploadCollection}, status);
                        // prevent multiple messages:
                        newStatus.suppressMultipleFailMessage = true;
                        // TODO: Make the progressbar a reusable component; do not
                        // misuse the file-upload-progressbar for other scenarios.
                        // TODO: Handle this in the multi-item command to be consistent
                        // with other commands; do not override the attach command only.
                        uploadCollection.each(function (fileUpload) {
                            // Replace the new node in the file upload model with the existing
                            // one to be able to destroy it; sync and destroy events will be
                            // triggered on it and the parent collection and view will see them.
                            var node = fileUpload.get('node');
                            fileUpload.node = node;
                            fileUpload.unset('node');
                        });
                        self.startGlobalMessage(uploadCollection);
                        MultipleItemsCommand._performActions.call(self, newStatus, options)
                            .done(function (results) {
                                globalMessage.hideFileUploadProgress();
                                deferred.resolve(results);
                            })
                            .fail(function (errors) {
                                deferred.reject(errors);
                            });
                    }
                },
                function (error) {
                    console.log(error);
                    deferred.reject(error);
                });
            return deferred.promise();

        },

        startGlobalMessage: function (uploadCollection) {
            globalMessage.showProgressPanel(uploadCollection, {
                oneFileTitle: lang.AttachingOneBusAtt,
                oneFileSuccess: lang.AttachOneBusAttSuccessMessage,
                multiFileSuccess: lang.AttachManyBusAttsSuccessMessage,
                oneFilePending: lang.AttachingOneBusAtt,
                multiFilePending: lang.AttachBusAtts,
                oneFileFailure: lang.AttachOneBusAttFailMessage,
                multiFileFailure: lang.AttachManyBusAttsFailMessage2,
                someFileSuccess: lang.AttachSomeBusAttsSuccessMessage,
                someFilePending: lang.AttachingSomeBusAtts,
                someFileFailure: lang.AttachSomeBusAttsFailMessage2,
                enableCancel: false
            });

        },

        // Perform the attach action. Return a promise, which is resolved with the attached node if
        // successful or rejected with the error.
        // Note, that the node is used later to display the name of the attached item.
        _performAction: function (model, options) {
            var node = model.node;
            var d = $.Deferred();
            var self = this;
            if (this.collection) {
                var ext_system_id = this.boSearchModel.get('ext_system_id'),
                    bo_type = this.boSearchModel.get('bo_type'),
                    comment = '';

                var bo_id = node.get('businessObjectId');
                var id = ext_system_id + bo_type + bo_id;
                var obody = {
                    "ext_system_id": ext_system_id,
                    "bo_type": bo_type,
                    "bo_id": bo_id,
                    "comment": comment
                };
                var busAttModel = new AttachmentModel(obody, { collection: this.collection, connector: this.connector});
                busAttModel.isLocallyCreated = true;

                busAttModel.save({wait: true, silent: true})
                    .done(function (args) {
                        self.collection.add(busAttModel, {at: 0});
                        model.set('count', 1);
                        model.deferred.resolve(model);
                        d.resolve(node);
                    })
                    .fail(function (error) {
                        var cmdError = error ? new commandError(error, node) : error;
                        model.deferred.reject(model, cmdError);
                        d.reject(cmdError);
                    });
                return d.promise();
            }
            else {
                return d.reject(
                    new commandError(_.str.sformat(lang.CommandFailedSingular, node.get('name'),
                        lang.CommandVerbAttach), {errorDetails: "collection is undefined"}));
            }
        },


        _announceStart: function (status) {
            var originatingView = status.originatingView;
            if (originatingView && originatingView.blockActions) {
                originatingView.blockActions();
            }
            var pageLeavingWarning = this.get('pageLeavingWarning');
            if (pageLeavingWarning) {
                this.PageLeavingBlocker.enable(pageLeavingWarning);
            }
        },

        _announceFinish: function (status) {
            if (this.get('pageLeavingWarning')) {
                this.PageLeavingBlocker.disable();
            }
            var originatingView = status.originatingView;
            if (originatingView && originatingView.unblockActions) {
                originatingView.unblockActions();
            }
        }

    });


    return AddAttachmentCommand;

})
;

csui.define('xecmpf/utils/commands/myattachments',['csui/lib/underscore', 'csui/models/commands',
    'xecmpf/utils/commands/myattachments/detach_myattachment',
    'xecmpf/utils/commands/myattachments/go_to_workspace',
    'xecmpf/utils/commands/myattachments/open_sap_object',
    'xecmpf/utils/commands/myattachments/add_myattachment'
], function (_, CommandCollection,
             DetachAttachmentCommand,
             GoToWorkspaceCommand,
             OpenSapCommand,
             AddAttachmentCommand
) {
    'use strict';

    var commands = new CommandCollection([
        new DetachAttachmentCommand(),
        new GoToWorkspaceCommand(),
        new OpenSapCommand(),
        new AddAttachmentCommand()
    ]);

    return commands;

});
csui.define('xecmpf/widgets/myattachments/metadata.attachments.columns',["csui/lib/backbone"],
    function (Backbone) {

        var TableColumnModel = Backbone.Model.extend({

            idAttribute: "key",

            defaults: {
                key: null,  // key from the resource metadata
                sequence: 0 // smaller number moves the column to the front
            }

        });

        var TableColumnCollection = Backbone.Collection.extend({

            model: TableColumnModel,
            comparator: "sequence",

            getColumnKeys: function () {
                return this.pluck('key');
            },

            deepClone: function () {
                return new TableColumnCollection(
                    this.map(function (column) {
                        return column.attributes;
                    }));
            }
        });

        // Fixed (system) columns have sequence number < 100, dynamic columns
        // have sequence number > 1000

        var tableColumns = new TableColumnCollection([

            {
                key: 'bo_id',
                sequence: 10
            },
            {
                key: 'name',
                sequence: 20
            },
            {
                key: 'ext_system_name',
                sequence: 30
            },
            {
                key: 'create_date',
                sequence: 40
            },
            {
                key: 'created_by_name',
                sequence: 50
            },
            {
                key: 'comment',
                sequence: 60
            }
        ]);

        return tableColumns;

    });


csui.define('css!xecmpf/widgets/myattachments/metadata.attachments',[],function(){});
csui.define('xecmpf/widgets/myattachments/metadata.attachments.toolbaritems',['csui/lib/underscore',
    'i18n!xecmpf/widgets/myattachments/nls/myattachments.lang',
    'csui/controls/toolbar/toolitems.factory',
    'css!xecmpf/widgets/myattachments/metadata.attachments'
], function (_, lang, ToolItemsFactory) {

    var toolbarItems = {
        addToolbar: new ToolItemsFactory({
                add: [
                    //{signature: "AddFolder", name: lang.ToolbarItemAddFolder},
                    //{signature: "AddDocument", name: lang.ToolbarItemAddDocument}
                ]
            },
            {
                maxItemsShown: 0, // force toolbar to immediately start with a drop-down list
                dropDownIcon: "icon icon-toolbarAdd",
                dropDownText: lang.AddBusinessAttachment,
                dropDownSvgId: "themes--carbonfiber--image--generated_icons--action_add32",
                addTrailingDivider: false

            }),

        otherToolbar: new ToolItemsFactory(
            {
                main: [
                    {
                        signature: "detach_business_attachment",
                        name: lang.DetachBusinessAttachment,
                        //  icon: "icon icon-toolbar-metadata",
                        scope: "multiple",
                        verb: "detach_business_attachment"
                    },
                    {
                        signature: "open_sap_object",
                        name: lang.OpenSapObject
                    },
                    {
                        signature: "go_to_workspace",
                        name: lang.GoToWorkspace
                    }
                ]
            },
            {
                maxItemsShown: 5,
                dropDownIcon: "icon icon-toolbar-more"
            }),
        // inline action bar
        inlineActionbar: new ToolItemsFactory({
                other: [
                    {
                        signature: "detach_business_attachment",
                        name: lang.DetachBusinessAttachment,
                        verb: "detach_business_attachment",
                        icon: "icon icon-toolbar-detach"
                    },
                    {
                        signature: "open_sap_object",
                        name: lang.OpenSapObject,
                        icon: "icon icon-toolbar-preview"
                    },
                    {
                        signature: "go_to_workspace",
                        name: lang.GoToWorkspace,
                        icon: "icon icon-toolbar-workspace"
                    }
                ]
            },
            {
                maxItemsShown: 5,
                dropDownText: lang.ToolbarItemMore,
                dropDownIcon: "icon icon-toolbar-more"
            })
    };

    return toolbarItems;

});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/myattachments/metadata.attachments',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class=\"csui-metadata-myattachments\">\r\n  <div id=\"att-tabletoolbar\"></div>\r\n  <div id=\"att-tableview\"></div>\r\n  <div id=\"att-paginationview\"></div>\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_widgets_myattachments_metadata.attachments', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/widgets/myattachments/metadata.attachments.view',["module", "csui/lib/jquery", "csui/lib/underscore", 'csui/lib/marionette',
    'csui/controls/tabletoolbar/tabletoolbar.view',
    'csui/controls/tableactionbar/tableactionbar.view',
    'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',
    'csui/controls/table/table.view', 'csui/controls/pagination/nodespagination.view',
    'xecmpf/utils/commands/myattachments', 'csui/models/columns',
    'xecmpf/widgets/myattachments/metadata.nodeattachments.model', 'xecmpf/widgets/myattachments/metadata.attachment.model',
    'xecmpf/widgets/myattachments/metadata.attachments.columns',
    'xecmpf/widgets/myattachments/metadata.attachments.toolbaritems',
    'hbs!xecmpf/widgets/myattachments/metadata.attachments',
    'csui/controls/toolbar/toolitem.model',
    'csui/controls/globalmessage/globalmessage',
    'csui/controls/toolbar/toolbar.command.controller',
    'csui/utils/url',
    'csui/utils/base',
    'i18n!xecmpf/widgets/myattachments/nls/myattachments.lang',
    'css!xecmpf/widgets/myattachments/metadata.attachments'

], function (module, $, _, Marionette,
             TableToolbarView,
             TableActionBarView,
             LayoutViewEventsPropagationMixin,
             TableView,
             PaginationView,
             commands,
             NodeColumnCollection,
             NodeAttachmentsCollection,
             AttachmentModel,
             metadataAttachmentsColumns,
             toolbarItems,
             template,
             ToolItemModel,
             GlobalMessage,
             ToolbarCommandController,
             Url,
             base,
             lang) {
    'use strict';

    var config = module.config();
    _.defaults(config, {
        defaultPageSize: 30,
        showInlineActionBarOnHover: !base.isTouchBrowser(),
        forceInlineActionBarOnClick: false,
        inlineActionBarStyle: "csui-table-actionbar-bubble",
        clearFilterOnChange: true,
        resetOrderOnChange: false,
        resetLimitOnChange: true,
        fixedFilterOnChange: false
    });


    var MetadataAttachmentsTableView = Marionette.LayoutView.extend({

        className: 'metadata-inner-wrapper',
        template: template,

        ui: {
            tableView: '#att-tableview',
            childContainer: '#att-tableview',
            paginationView: '#att-paginationview'
        },

        regions: {
            tableToolbarRegion: '#att-tabletoolbar',
            tableRegion: '#att-tableview',
            paginationRegion: '#att-paginationview'
        },

        constructor: function MetadataAttachmentsTableView(options) {
            MetadataAttachmentsTableView.__super__.constructor.call(this, options);

            this.options.data || (this.options.data = {});
            _.defaults(this.options.data, {
                pageSize: config.defaultPageSize || 30,
            });

            this.commands = commands;
            this.collection = new NodeAttachmentsCollection(undefined, {
                node: this.options.model,
                autoreset: true,
                expand: "user",
                commands: this.commands,
                onlyClientSideDefinedColumns: true  // ignore columns sent by server
            });

            // SAPRM-8811: for pagination we need an additonal collection.fetch after
            //             detaching all items of a page
            this.commandController = new ToolbarCommandController({commands: this.commands});
            this.listenTo(this.commandController, 'after:execute:command', this._toolbarActionTriggered);


            this.options.model.busatts = this.collection;  // connect bus.attachment collection with node

            this._setToolBar();
            this._setTableView();
            this._setPagination();

            this.setActionBarEvents();

            this.collection.fetch({error: this.handleError.bind(this)});

            // Cause the show events triggered on the parent view re-triggered
            // on the views placed in the inner regions
            this.propagateEventsToRegions();
        },

        handleError: function (response) {
            if (response.error && response.error.message ) {
             var displayMsgEle = this.ui.tableView.find('.csui-no-result-message').get(0);
             if(displayMsgEle) {
                displayMsgEle.innerHTML = response.error.message;
                displayMsgEle.setAttribute('title', response.error.message);
                
             }
          }
      
        },

        onRender: function () {
            this.tableToolbarRegion.show(this.tableToolbarView);
            this.tableRegion.show(this.tableView);
            this.paginationRegion.show(this.paginationView);
        },

        // controller for the toolbar actions
        _toolbarActionTriggered: function (toolbarActionContext) {
            if (toolbarActionContext) {
                switch (toolbarActionContext.commandSignature) {
                case 'detach_business_attachment':
                    this.collection.fetch({error: this.handleError.bind(this)});
                    break;
                }
            }
        },

        _buildToolbarItems: function () {
            var deferred = $.Deferred();
            var getBoTypesUrl = Url.combine(this.model.connector.getConnectionUrl().getApiBase('v2'), 'nodes', this.model.get('id'), 'addablebotypes');
            var ajaxOptions = {
                type: 'GET',
                url: getBoTypesUrl
            };

            var that = this;
            this.model.connector.makeAjaxCall(ajaxOptions)
                .done(function (response, statusText, jqxhr) {
                    var toolItems = [];
                    if (response && response.results && response.results.length > 0) {                        
                        response.results.forEach(function (boTypeRes) {
                            var toolItem = new ToolItemModel({
                                signature: 'add_business_attachment',
                                icon: 'icon icon-toolbarAdd',
                                svgId: 'themes--carbonfiber--image--generated_icons--action_add32',
                                name: boTypeRes.data.properties.bo_type_name,
                                type: 123, //addType,
                                group: 'add',
                                commandData: {
                                    boType: boTypeRes.data.properties,
                                    node_id: that.model.get('id'),
                                    collection: that.collection
                                }
                            });
                            toolItems.push(toolItem);
                        });

                        // sort toolbarItems
                        if (toolItems.length > 0) {
                            toolItems.sort(function (a, b) {
                                var aname = a.get("name"),
                                    bname = b.get("name"),
                                    result = base.localeCompareString(aname, bname, {usage: "sort"});
                                return result;
                            });
                        }                        
                    }
                    toolbarItems.addToolbar.reset(toolItems);
                    deferred.resolve.apply(deferred, arguments);
                })
                .fail(function (jqXHR, statusText, error) {

                    // show failure message
                    var linesep = "\r\n",
                        lines = [];
                    if (statusText !== "error") {
                        lines.push(statusText);
                    }
                    if (jqXHR.responseText) {
                        var respObj = JSON.parse(jqXHR.responseText);
                        if (respObj && respObj.error) {
                            lines.push(respObj.error);
                        }
                    }
                    if (error) {
                        lines.push(error);
                    }
                    var errmsg = lines.length > 0 ? lines.join(linesep) : undefined;
                    GlobalMessage.showMessage("error", lang.ErrorLoadingAddItemMenu, errmsg);
                    deferred.reject.apply(deferred, arguments);
                });
        },

        _setToolBar: function () {
            var originatingView = this;
            // for metadata of bus. attachments, try to pass the parent originating view if found
            if (this.options && this.options.metadataView && this.options.metadataView.options &&
                this.options.metadataView.options.metadataNavigationView) {
                originatingView = this.options.metadataView.options.metadataNavigationView;
            }

            // Get business object types
            this._buildToolbarItems();

            this.tableToolbarView = new TableToolbarView({
                context: this.options.context,
                commands: commands,
                toolbarItems: toolbarItems,
                collection: this.collection,
                originatingView: originatingView,
                toolbarCommandController: this.commandController
                // addableTypes: this.addableTypes
            });
        },

        _updateToolItems: function () {
            if (this.tableToolbarView) {
                this.tableToolbarView.updateForSelectedChildren(this.tableView.getSelectedChildren());
            }
        },

        _setTableView: function () {
            this.options || (this.options = {});

            var args = _.extend({
                tableColumns: metadataAttachmentsColumns,
                context: this.options.context,
                connector: this.model.connector,
                collection: this.collection,
                columns: this.collection.columns,
                pageSize: this.options.data.pageSize,
                columnsWithSearch: ['name', 'bo_id'],
                orderBy: "bo_id asc",
                commands: commands,
                customLabels: {
                    zeroRecordsMsg: lang.noBusinessAttachmentsAvailable,
                    emptySearchTable: lang.tableColumnSearchNoResult
                }
            }, this.options);

            this.tableView = new TableView(args);

            // Events

            this.listenTo(this.tableView, "tableRowSelected", this._updateToolItems);
            this.listenTo(this.tableView, "tableRowUnselected", this._updateToolItems);
            this.listenTo(this.collection, "reset", this._updateToolItems);
            this.listenTo(this.collection, "change", this._updateToolItems);
            this.listenTo(this.collection, "remove", this._updateToolItems);

            // rebuild toolbar items because of possible metadata option (SAPRM-8812)
            this.listenTo(this.collection, "add", this._buildToolbarItems);
            this.listenTo(this.collection, "remove", this._buildToolbarItems);
        },

        _setPagination: function () {
            this.paginationView = new PaginationView({
                collection: this.collection,
                pageSize: this.options.data.pageSize
            });

            //this.listenTo(this.paginationView, 'render:complete', _.bind(this._setTableViewHeight, this));
            return true;
        },

        setActionBarEvents: function () {
            if (config.forceInlineActionBarOnClick) {
                this.listenTo(this.tableView, 'row:clicked', function (args) {
                    if (this.tableActionBarView) {
                        var oldModelId = this.tableActionBarView.model.get('id');
                        var newModelId = args.node.get('id');
                        if (oldModelId === newModelId) {
                            return;
                        }
                    }
                    this._destroyOldAndCreateNewActionBarWithoutDelay(args);
                });
            } else {
                if (config.showInlineActionBarOnHover) {
                    this.listenTo(this.tableView, 'enterTableRow', this._showActionBarWithDelay);
                    this.listenTo(this.tableView, 'leaveTableRow', this._actionBarShouldDestroy);
                }
            }
            this.listenTo(this.collection, "reset", this._destroyActionBar);
            if (this.collection.node) {
                this.listenTo(this.collection.node, 'change:id', this._destroyActionBar);
            }
        },

        _showActionBar: function (args) {
            var selectedItems = this.tableView.getSelectedChildren();
            if (selectedItems.length > 0) {
                // no action bar if items are selected
                return;
            }
            if (this.tableActionBarView) {
                this._savedHoverEnterArgs = args;
                // ignore until action bar removed itself
            } else {
                this._savedHoverEnterArgs = null;

                this.tableActionBarView = new TableActionBarView(_.extend({
                        context: this.options.context,
                        commands: /*this.defaultActionController.*/commands,
                        collection: toolbarItems.inlineActionbar,
                        delayedActions: this.collection.delayedActions,
                        container: this.collection.node,
                        model: args.node,
                        originatingView: this
                    }, toolbarItems.inlineActionbar.options, {
                        inlineActionBarStyle: config.inlineActionBarStyle
                    })
                );
                this.tableActionBarView.render();
                this.listenToOnce(this.tableActionBarView, 'destroy', function () {
                    //Even though we are listening to tableActionBar 'destroy' even once, that event listener is not
                    //being removed after the fact. To ensure memory cleanup, the event listener if forcibly removed.
                    if (this.tableActionBarView) {
                        this.stopListening(this.tableActionBarView);
                    }
                    if (this._savedHoverEnterArgs) {
                        this._showActionBarWithDelay(this._savedHoverEnterArgs);
                    }
                }, this);
                var abEl = this.tableActionBarView.$el;

                var nameCell = this.tableView.getNameCell(args.target);
                if (nameCell && nameCell.length === 1) {
                    var actionBarDiv = nameCell.find('.csui-table-cell-name-appendix');
                    actionBarDiv.append(abEl);
                    actionBarDiv.addClass('csui-table-cell-name-appendix-full');
                    this.tableActionBarView.triggerMethod("after:show");
                }
            }
        },

        _showActionBarWithDelay: function (args) {
            if (this._showActionbarTimeout) {
                clearTimeout(this._showActionbarTimeout);
            }
            var self = this;
            this._showActionbarTimeout = setTimeout(function () {
                self._showActionbarTimeout = null;
                if (!self.tableView.lockedForOtherContols) {
                    // don't show the action bar control if the table view is locked because a different
                    // control is already open
                    self._showActionBar.call(self, args);
                }
            }, 200);
        },

        _destroyOldAndCreateNewActionBarWithoutDelay: function (args) {
            this._actionBarShouldDestroy();
            if (!this.tableView.lockedForOtherContols) {
                // don't show the action bar control if the table view is locked because a different
                // control is already open
                this._showActionBar.call(this, args);
            }
        },

        _actionBarShouldDestroy: function () {
            if (this._showActionbarTimeout) {
                clearTimeout(this._showActionbarTimeout);
                this._showActionbarTimeout = null;
            }
            this._destroyActionBar();
        },

        _destroyActionBar: function () {
            if (this.tableActionBarView) {
                var actionBarDiv = this.tableActionBarView.$el.parent();
                actionBarDiv.removeClass('csui-table-cell-name-appendix-full');

                this.tableActionBarView.destroy();
                this.tableActionBarView = null;
            }
        },

    });

    // Add the mixin functionality to the target view
    _.extend(MetadataAttachmentsTableView.prototype, LayoutViewEventsPropagationMixin);

    return MetadataAttachmentsTableView;

});

// Lists explicit locale mappings and fallbacks
csui.define('xecmpf/widgets/workflows/nls/workflows.lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false,
});


// Defines localizable strings in the default language (English)
csui.define('xecmpf/widgets/workflows/nls/root/workflows.lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false,
  "name": "Workflows",
  "title": "Workflows",
  "emptyTableText": "No workflows",
  
  // table columns
  "workflowTitle": "Name",
  "workflowStatus": "Status",
  "lastModified": "LastModified",
  "initiatedDate": "Created",
  "initiatedBy": "Initiator"

});


csui.define('xecmpf/widgets/workflows/impl/metadata.workflow.columns',["csui/lib/backbone", "i18n!xecmpf/widgets/workflows/nls/workflows.lang"],
    function (Backbone, lang) {

      var workflowTableColumnModel = Backbone.Model.extend({

        idAttribute: "key",

        defaults: {
          key: null,  // key from the resource metadata
          sequence: 0 // smaller number moves the column to the front
        }

      });

      var workflowTableColumnCollection = Backbone.Collection.extend({

        model: workflowTableColumnModel,
        comparator: "sequence",

        getColumnKeys: function () {
          return this.pluck('key');
        },

        deepClone: function () {
          return new workflowTableColumnCollection(
              this.map(function (column) {
                return column.attributes;
              }));
        }
      });

      // Fixed (system) columns have sequence number < 100, dynamic columns
      // have sequence number > 1000

      var tableColumns = new workflowTableColumnCollection([

        {
          key: 'WorkflowTitle',
          title: lang.workflowTitle,
          isNaming: true,
          widthFactor: 3,
          sequence: 10
        },
        {
          key: 'WorkflowStatusName',
          title: lang.workflowStatus,
          sequence: 20
        },
        {
          key: 'ModifiedByName',
          title: lang.lastModified,
          sequence: 30
        },
        {
          key: 'InitiatedDate',
          title: lang.initiatedDate,
          sequence: 40
        },
        {
          key: 'InitiatedByName',
          title: lang.initiatedBy,
          sequence: 50
        }
      ]);

      return tableColumns;

    });


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/workflows/impl/metadata.workflows',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class=\"csui-metadata-workflows\">\r\n  <div id=\"workflow-tableview\"></div>\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_widgets_workflows_impl_metadata.workflows', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/workflows/impl/metadata.workflows',[],function(){});
csui.define('xecmpf/widgets/workflows/impl/metadata.workflows.view',['csui/lib/underscore', 'csui/lib/marionette',
  'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',
  'csui/controls/table/table.view', 'csui/utils/contexts/factories/connector',
  'xecmpf/models/workflows/metadata.workflow.collection',
  'xecmpf/utils/commands/workflows',
  'csui/utils/commandhelper',
  'csui/models/actionitems',
  'xecmpf/widgets/workflows/impl/metadata.workflow.columns',
  'csui/behaviors/default.action/default.action.behavior',
  'hbs!xecmpf/widgets/workflows/impl/metadata.workflows',
  'i18n!xecmpf/widgets/workflows/nls/workflows.lang',
  'css!xecmpf/widgets/workflows/impl/metadata.workflows'

], function (_, Marionette,
    LayoutViewEventsPropagationMixin,
    TableView,
    ConnectorFactory,
    workflowModelCollection,
    commands,
    CommandHelper,
    ActionItems,
    workflowColumns,
    DefaultActionBehavior,
    template,
    lang) {

  'use strict';

  var MetadataWorkflowsTableView = Marionette.LayoutView.extend({

    className: 'metadata-inner-wrapper',
    template: template,

    ui: {
      tableView: '#workflow-tableview',
      workflowName: '#workflow-tableview .binf-table tbody tr [data-csui-attribute="WorkflowTitle"]'
    },

    regions: {
      tableRegion: '#workflow-tableview'
    },

    behaviors: {
      DefaultAction: {
        behaviorClass: DefaultActionBehavior
      }
    },

    constructor: function MetadataWorkflowsTableView(options) {
      options || (options = {});
      this.commands = commands;
      MetadataWorkflowsTableView.__super__.constructor.call(this, options);

      this.collection.fetch();
      // events triggered on the parent view re-triggered
      // on the views placed in the inner regions
      this.propagateEventsToRegions();
    },

    initialize: function () {

      this.collection = new workflowModelCollection(undefined, {
        connector: this.options.context.getObject(ConnectorFactory),
        node: this.options.model,
        commands: commands.getAllSignatures(),
        autoreset: true,
        status: 'all'
      });

      this._setTableView();

    },

    onRender: function () {
      this.tableRegion.show(this.tableView);
    },

    _setTableView: function () {
      this.options || (this.options = {});
      var self = this,
        args = _.extend({

        connector: this.model.connector,
        tableColumns: workflowColumns,
        collection: this.collection,
        orderBy: "InitiatedDate desc",
        selectColumn: false,
        selectRows: false,
        actionItems: this.defaultActionItems,
        customLabels: {
          emptyTableText: lang.emptyTableText,
        },
        focusView: 'tableHeader',
        originatingView: this.options.originatingView,
        commands: commands
      }, this.options);

      this.tableView = new TableView(args);

      var cmdOption = {context: this.options.context, originatingView: this};

      if (this.tableView.collection && this.tableView.collection.length === 0 && this.collection.fetched) {
        this.tableView._showEmptyViewText = true;
      }

      this.listenTo(this.tableView, 'execute:defaultAction', function (node) {
        self.previousFocusElm = document.activeElement;
        var status  = {nodes: new workflowModelCollection([node])},
            command = commands.get('WorkflowOpen');
        var promise = command.execute(status, cmdOption);
        CommandHelper.handleExecutionResults(
            promise, {
              command: command,
              suppressSuccessMessage: "Error Eecuting command",
              suppressFailMessage: "Fecting commands data failed"
            });
      });

    },

  });

  // Add the mixin functionality to the target view
  _.extend(MetadataWorkflowsTableView.prototype, LayoutViewEventsPropagationMixin);

  return MetadataWorkflowsTableView;

});

csui.define('xecmpf/widgets/workflows/metadata.workflows.view',["module", "csui/lib/jquery", "csui/lib/underscore",
  'csui/lib/backbone',
  'csui/lib/marionette',
  'xecmpf/widgets/workflows/impl/metadata.workflows.view'
], function (module, $, _, Backbone, Marionette, MetadataWorkflowTableView) {
  'use strict';

  var config = module.config();
  _.defaults(config, {
    isAIBConfigured: false
  });

  var MetadataWorkflowView = MetadataWorkflowTableView.extend({

        constructor: function MetadataWorkflowView(options) {
          MetadataWorkflowTableView.prototype.constructor.apply(this, arguments);
        }
      },
      {
        enabled: function (options) {
          return !!config.isAIBConfigured;
        }
      }
  );
  return MetadataWorkflowView;

});
csui.define('xecmpf/widgets/myattachments/metadata.property.panels',['i18n!xecmpf/widgets/myattachments/nls/myattachments.lang',
  "xecmpf/widgets/myattachments/metadata.attachments.view",
  "xecmpf/widgets/workflows/metadata.workflows.view",
  "i18n!xecmpf/widgets/workflows/nls/workflows.lang"
], function (lang, MyAttachmentsView, workflowTableView, workflowLang) {

  return [

    {
      title: lang.attachmentsTabTitle,
      sequence: 40,
      contentView: MyAttachmentsView
    },

    {
      title: workflowLang.title,
      sequence: 50,
      name: workflowLang.name,
      contentView: workflowTableView
    }

  ];

});

csui.define('xecmpf/widgets/dossier/impl/dossier.factory',['module', 'csui/lib/underscore', 'csui/lib/backbone',
  'csui/utils/contexts/factories/factory', 'csui/utils/contexts/factories/connector',
  'csui/utils/contexts/factories/node',
  'xecmpf/widgets/dossier/impl/dossier.model'
], function (module, _, Backbone,
    CollectionFactory, ConnectorFactory, NodeModelFactory,
    DossierCollection) {

  var DossierCollectionFactory;

  DossierCollectionFactory = CollectionFactory.extend({

    propertyPrefix: 'dossierCollection',

    constructor: function DossierFactory(context, options) {
      CollectionFactory.prototype.constructor.apply(this, arguments);
      var dossierCollection = this.options.dossierCollection || {};
      if (!(dossierCollection instanceof Backbone.Collection)) {
        var connector = context.getObject(ConnectorFactory, options),
            config    = module.config();
        dossierCollection = new DossierCollection(dossierCollection.models, _.extend({
          connector: connector
        }, dossierCollection.options, config.options, {
          autofetch: true
        }, options));
      }
      this.property = dossierCollection;
    },

    fetch: function (options) {
      return this.property.fetch(options);
    }
  });

  return DossierCollectionFactory;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/behaviors/scroll.controls/impl/scroll.controls',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return "glyphicon glyphicon-chevron-left";
},"3":function(container,depth0,helpers,partials,data) {
    return "glyphicon glyphicon-chevron-right";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"cs-scroll-control cs-scroll-control-left\">\r\n  <span class=\""
    + ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"leftControlIconClass") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"loc":{"start":{"line":2,"column":15},"end":{"line":2,"column":90}}})) != null ? stack1 : "")
    + "\r\n  cs-scroll-control-icon cs-scroll-control-icon-left "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"leftControlIconClass") || (depth0 != null ? lookupProperty(depth0,"leftControlIconClass") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"leftControlIconClass","hash":{},"loc":{"start":{"line":3,"column":53},"end":{"line":3,"column":77}}}) : helper)))
    + "\"></span>\r\n</div>\r\n<div class=\"cs-scroll-control cs-scroll-control-right\">\r\n  <span class=\""
    + ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"rightControlIconClass") : depth0),{"name":"unless","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"loc":{"start":{"line":6,"column":15},"end":{"line":6,"column":92}}})) != null ? stack1 : "")
    + "\r\n  cs-scroll-control-icon cs-scroll-control-icon-right "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"rightControlIconClass") || (depth0 != null ? lookupProperty(depth0,"rightControlIconClass") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"rightControlIconClass","hash":{},"loc":{"start":{"line":7,"column":54},"end":{"line":7,"column":79}}}) : helper)))
    + "\"></span>\r\n</div>\r\n";
}});
Handlebars.registerPartial('xecmpf_behaviors_scroll.controls_impl_scroll.controls', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/behaviors/scroll.controls/impl/scroll.controls',[],function(){});
csui.define('xecmpf/behaviors/scroll.controls/scroll.controls.behavior',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/marionette',
  'hbs!xecmpf/behaviors/scroll.controls/impl/scroll.controls',
  'css!xecmpf/behaviors/scroll.controls/impl/scroll.controls'
], function (_, $, Marionette, template, css) {
  "use strict";

  var ScrollControlsBehavior;

  ScrollControlsBehavior = Marionette.Behavior.extend({

    defaults: {
      contentParent: null,
      controlsContainer: null,
      scrollableWidth: null, //px
      animateDuration: 400 //ms
    },

    ui: {
      leftControl: '.cs-scroll-control-left',
      rightControl: '.cs-scroll-control-right'
    },

    triggers: {
      'mousedown @ui.leftControl': 'scroll:left',
      'mousedown @ui.rightControl': 'scroll:right'
    },

    constructor: function ScrollControlsBehavior(options, view) {
      Marionette.Behavior.prototype.constructor.apply(this, arguments);
      this.listenTo(view, 'render', this._renderControls)
          .listenTo(view, 'dom:refresh', this._updateScrollControls)
          .listenTo(view, 'update:scroll:controls', this._updateScrollControls)
          .listenTo(view, 'scroll:left', this._scrollLeft)
          .listenTo(view, 'scroll:right', this._scrollRight)
          .listenTo(view, 'before:destroy', this._unbindUpdateControlsEvents);
    },

    _renderControls: function () {
      var controlsContainerSelector = getOption.call(this, 'controlsContainer');
      this._controlsContainer = controlsContainerSelector ?
                                this.view.$(controlsContainerSelector) : this.view.$el;

      var contentParentSelector = getOption.call(this, 'contentParent');
      this._contentParent = contentParentSelector ?
                            this.view.$(contentParentSelector) : this.view.$el;
      this._bindControlsUpdatingEvents();

      this.animateDuration = getOption.call(this, 'animateDuration');

      var data = {
        leftControlIconClass: getOption.call(this, 'leftControlIconClass'),
        rightControlIconClass: getOption.call(this, 'rightControlIconClass')
      };

      this._controlsContainer.append(template(data));
      this.view._bindUIElements.call(this);
    },

    _updateScrollControls: function () {
      if (this._contentParent && this._contentParent instanceof $) {
        var currentPos         = this._contentParent.scrollLeft(),
            scrollWidth        = this._contentParent.get(0).scrollWidth,
            contentParentWidth = this._contentParent.width();

        // for left control
        currentPos === 0 ? this.ui.leftControl.hide(100) : this.ui.leftControl.show(100);

        // for right control
        currentPos === (scrollWidth - contentParentWidth) ?
        this.ui.rightControl.hide(100) : this.ui.rightControl.show(100);
      }
    },

    _scrollLeft: function () {
      if (this._contentParent && this._contentParent instanceof $) {
        var scrollableWidth = getOption.call(this, 'scrollableWidth') ||
                              this._contentParent.innerWidth();
        var currentPos = this._contentParent.scrollLeft();
        this._contentParent
            .trigger("focus")
            .filter(':not(:animated)')
            .animate({scrollLeft: currentPos - scrollableWidth}, this.animateDuration, 'swing',
                $.proxy(function () {this.view.triggerMethod('update:scroll:controls')}, this));
      }
    },

    _scrollRight: function () {
      if (this._contentParent && this._contentParent instanceof $) {
        var scrollableWidth = getOption.call(this, 'scrollableWidth') ||
                              this._contentParent.innerWidth();
        var currentPos = this._contentParent.scrollLeft();
        this._contentParent
            .trigger("focus")
            .filter(':not(:animated)')
            .animate({scrollLeft: currentPos + scrollableWidth}, this.animateDuration, 'swing',
                $.proxy(function () {this.view.triggerMethod('update:scroll:controls')}, this));
      }
    },

    _bindControlsUpdatingEvents: function () {
      if (this._contentParent && this._contentParent instanceof $) {
        //Add 'tabindex=1' to div element to enable the capturing of the key events
        this._contentParent.attr('tabindex', 1);
        this._contentParent.on('keydown', $.proxy(function (e) {
          switch (e.which) {
          case 37:  // left arrow key
            this.view.triggerMethod('scroll:left');
            break;
          case 39:  // right arrow key
            this.view.triggerMethod('scroll:right');
            break;
          }
        }, this));

        $(window).on('resize', $.proxy(function () {this._updateScrollControls();}, this));
      }
    },

    _unbindUpdateControlsEvents: function () {
      if (this._contentParent && this._contentParent instanceof $) {
        this._contentParent.off('keydown');
        $(window).off('resize');
      }
    }
  });

  function getOption(property, source) {
    var options = source || this.options || {};
    var value = options[property];
    return _.isFunction(value) ? options[property].call(this.view) : value;
  }

  return ScrollControlsBehavior;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/utils/document.thumbnail/impl/document.thumbnail',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "  <div class=\"document-thumbnail-caption\">\r\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"disableIcon") : depth0),{"name":"unless","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"loc":{"start":{"line":7,"column":4},"end":{"line":9,"column":15}}})) != null ? stack1 : "")
    + "    <span class=\"document-name\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"name") || (depth0 != null ? lookupProperty(depth0,"name") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"name","hash":{},"loc":{"start":{"line":10,"column":39},"end":{"line":10,"column":47}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"name") || (depth0 != null ? lookupProperty(depth0,"name") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"name","hash":{},"loc":{"start":{"line":10,"column":49},"end":{"line":10,"column":57}}}) : helper)))
    + "</span>\r\n  </div>\r\n";
},"2":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "      <span class=\"csui-type-icon "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"icon") || (depth0 != null ? lookupProperty(depth0,"icon") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"icon","hash":{},"loc":{"start":{"line":8,"column":34},"end":{"line":8,"column":42}}}) : helper)))
    + "\" aria-hidden=\"true\"></span>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"document-thumbnail-wrapper\">\r\n  <div><a href=\"#\" class=\"thumbnail_not_loaded thumbnail_empty\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"title") || (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"title","hash":{},"loc":{"start":{"line":2,"column":71},"end":{"line":2,"column":80}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"document_name") || (depth0 != null ? lookupProperty(depth0,"document_name") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"document_name","hash":{},"loc":{"start":{"line":2,"column":94},"end":{"line":2,"column":111}}}) : helper)))
    + "\"></a></div>\r\n  <button class=\"wrapper\"><img src=\"\" class=\"img-doc-preview binf-hidden\" alt=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"title") || (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"title","hash":{},"loc":{"start":{"line":3,"column":79},"end":{"line":3,"column":88}}}) : helper)))
    + "\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"title") || (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"title","hash":{},"loc":{"start":{"line":3,"column":97},"end":{"line":3,"column":106}}}) : helper)))
    + "\" /></button>\r\n</div>\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"enableCaption") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"loc":{"start":{"line":5,"column":0},"end":{"line":12,"column":7}}})) != null ? stack1 : "");
}});
Handlebars.registerPartial('xecmpf_utils_document.thumbnail_impl_document.thumbnail', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/utils/document.thumbnail/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});


// Defines localizable strings in the default language (English)
csui.define('xecmpf/utils/document.thumbnail/impl/nls/root/lang',{
  open: 'Open',
  toOpen:'to open '
});



csui.define('css!xecmpf/utils/document.thumbnail/impl/document.thumbnail',[],function(){});
csui.define('xecmpf/utils/document.thumbnail/document.thumbnail.view',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/marionette', 'csui/utils/url',
  'csui/utils/contexts/factories/connector',
  'csui/utils/nodesprites', 'csui/controls/node-type.icon/node-type.icon.view',
  'csui/behaviors/default.action/default.action.behavior',
  'hbs!xecmpf/utils/document.thumbnail/impl/document.thumbnail',
  'i18n!xecmpf/utils/document.thumbnail/impl/nls/lang',
  'css!xecmpf/utils/document.thumbnail/impl/document.thumbnail'
], function (_, $, Marionette, Url,
    ConnectorFactory, NodeSpriteCollection, NodeTypeIconView, DefaultActionBehavior,
    template, lang) {

  var DocumentThumbnailView = Marionette.ItemView.extend({

    className: function () {
      var className = 'xecmpf-document-thumbnail';
      if (this.noAccessToItem) {
        className += ' no-contents-permission';
      }
      return className;
    },

    constructor: function DocumentThumbnailView(options) {
      options || (options = {});
      options.model || (options.model = options.node);
      if ( options.model.get('actions').length === 0 ) {
        this.noAccessToItem = true;
      }
      Marionette.ItemView.prototype.constructor.apply(this, arguments);

      if (!this.model) {
        throw new Error('node is missing in the constructor options.');
      }
    },

    behaviors: {
      DefaultAction: {
        behaviorClass: DefaultActionBehavior
      }
    },

    template: template,

    templateHelpers: function () {
      return {
        title: this.options.title || lang.open,
        document_name:lang.toOpen + this.options.model.get('name'),
        enableCaption: this.options.enableCaption
      };
    },

    ui: {
      thumbnailNotLoadedEl: '.thumbnail_not_loaded',
      imgEl: '.img-doc-preview',
      iconEl: '.csui-type-icon',
      buttonToHide:'.document-thumbnail-wrapper > button'
    },
    
    events:{
        'keydown .thumbnail_not_loaded': function(event){
            if (event.keyCode === 13 || event.keyCode === 32){
            var activeEl = this.$el.find(document.activeElement);
			$(activeEl).trigger("click");
            }
        },
        'keydown button.wrapper': function(event){
            if (event.keyCode === 13 || event.keyCode === 32){
            var activeEl = this.$el.find(document.activeElement);
			$(activeEl).trigger("click");
            }
        }
        
    },

    _showThumbnail: function () {
      // show thumbnail empty svg and hide img tag
      var loadUrl = Url.combine(this.model.connector.connection.url, '/nodes',
                      this.model.get('id'), 'thumbnails/medium/content'),
          that = this, url;

      this.ui.thumbnailNotLoadedEl
          .addClass('thumbnail_empty')
          .removeClass('binf-hidden thumbnail_missing');
      this.ui.imgEl.addClass('binf-hidden');

      if (!that.noAccessToItem) {
        this.model.connector
          .makeAjaxCall({ url: loadUrl, dataType: 'binary' })
          .then(function (response) {
            if(!that.isDestroyed){
              that.url = url = URL.createObjectURL(response);
              that.ui.imgEl.one('error', function () {
                that.addMissingThumbnailClass();
              });
  
              that.ui.imgEl
                .attr('src', url)
                .one('load', function (evt) {
                  if (evt.target.clientHeight >= evt.target.clientWidth) {
                    that.ui.imgEl.addClass('cs-form-img-vertical');
                  } else {
                    that.ui.imgEl.addClass('cs-form-img-horizontal');
                  }

                  // hide the thumbnail background span and show the real img
                  that.ui.thumbnailNotLoadedEl.addClass('binf-hidden');
                  that.ui.imgEl
                      .removeClass('binf-hidden')
                      .addClass('cs-form-img-border');
                });

              that._attachDefaultAction();
            }
          },function () {
            if(!that.isDestroyed){
              that._attachDefaultAction();
              that.addMissingThumbnailClass();
            }
          });
      } else {
        that.addMissingThumbnailClass();
      }      
    },

    /**
     * This method is used to add the default action to the thumbnail
     */
    _attachDefaultAction: function(){
      var that = this;
      this.ui.imgEl.parent().parent().on('click', function () {
        var args = {
          model: that.model,
          abortDefaultAction: false
        };
        that.triggerMethod('before:defaultAction', args);
        if (args.abortDefaultAction === false) {
          that.triggerMethod('execute:DefaultAction', that.model);
        }
        that.triggerMethod('after:defaultAction', args);
      });
    },

    /**@desc- adds thumbnail missing class to anchor tag*/
    addMissingThumbnailClass: function () {
      // show thumbnail missing svg and hide img tag
      var className = NodeSpriteCollection.findClassByNode(this.model) || 'thumbnail_missing';
      this.ui.thumbnailNotLoadedEl.removeClass('binf-hidden thumbnail_empty').addClass(className);
      this.ui.imgEl.addClass('binf-hidden');
      this.ui.buttonToHide.addClass('binf-hidden');
    },
    _renderNodeTypeIconView: function () {
      this._nodeIconView = new NodeTypeIconView({
        el: this.ui.iconEl,
        node: this.model
      });
      this._nodeIconView.render();
    },

    onRender: function () {
      this._renderNodeTypeIconView();
      this._showThumbnail();
    },

    onBeforeDestroy: function () {
      if (this._nodeIconView) {this._nodeIconView.destroy();}
      if (this.url) {URL.revokeObjectURL(this.url);}
    }
  });

  return DocumentThumbnailView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/dossier/impl/documentslistitem/impl/metadata',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<td class=\"label\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"label") || (depth0 != null ? lookupProperty(depth0,"label") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"label","hash":{},"loc":{"start":{"line":1,"column":25},"end":{"line":1,"column":34}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"label") || (depth0 != null ? lookupProperty(depth0,"label") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"label","hash":{},"loc":{"start":{"line":1,"column":36},"end":{"line":1,"column":45}}}) : helper)))
    + "</td>\r\n<td class=\"value\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"value") || (depth0 != null ? lookupProperty(depth0,"value") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"value","hash":{},"loc":{"start":{"line":2,"column":25},"end":{"line":2,"column":34}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"value") || (depth0 != null ? lookupProperty(depth0,"value") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"value","hash":{},"loc":{"start":{"line":2,"column":36},"end":{"line":2,"column":45}}}) : helper)))
    + "</td>";
}});
Handlebars.registerPartial('xecmpf_widgets_dossier_impl_documentslistitem_impl_metadata', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/widgets/dossier/impl/documentslistitem/impl/metadata.view',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/backbone', 'csui/lib/marionette',
  'csui/utils/base', 'hbs!xecmpf/widgets/dossier/impl/documentslistitem/impl/metadata'
], function (_, $, Backbone, Marionette, base,
    template) {

  var MetadataItemView = Marionette.ItemView.extend({

    tagName: 'tr',

    constructor: function MetadataItemView(options) {
      Marionette.ItemView.prototype.constructor.apply(this, arguments);
    },

    template: template,

    templateHelpers: function () {
      var value = this.model.get('value');
      return {
        value: this.model.get('type') === 'Date' ? base.formatFriendlyDate(value) : value
      }
    }
  });

  var MetadataView = Marionette.CollectionView.extend({

    tagName: 'table',

    constructor: function MetadataView(options) {
      Marionette.CollectionView.prototype.constructor.apply(this, arguments);
    },

    childView: MetadataItemView
  });

  return MetadataView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/dossier/impl/documentslistitem/impl/documentslistitem',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "    <div class=\"document-favorite\">\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"favorite") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.program(4, data, 0),"loc":{"start":{"line":6,"column":6},"end":{"line":14,"column":13}}})) != null ? stack1 : "")
    + "    </div>\r\n";
},"2":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "           <a href=\"#\" class=\"socialFav selected\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"removeFav") || (depth0 != null ? lookupProperty(depth0,"removeFav") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"removeFav","hash":{},"loc":{"start":{"line":7,"column":57},"end":{"line":7,"column":70}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"removeFav") || (depth0 != null ? lookupProperty(depth0,"removeFav") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"removeFav","hash":{},"loc":{"start":{"line":7,"column":84},"end":{"line":7,"column":97}}}) : helper)))
    + "\">\r\n          <span class=\"icon icon-socialFav\"></span>\r\n        </a>\r\n";
},"4":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "        <a href=\"#\" class=\"socialFav notselected\" tabindex=\"0\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"addFav") || (depth0 != null ? lookupProperty(depth0,"addFav") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"addFav","hash":{},"loc":{"start":{"line":11,"column":70},"end":{"line":11,"column":80}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"addFav") || (depth0 != null ? lookupProperty(depth0,"addFav") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"addFav","hash":{},"loc":{"start":{"line":11,"column":94},"end":{"line":11,"column":104}}}) : helper)))
    + "\">\r\n          <span class=\"icon icon-socialFavOpen\"></span>\r\n        </a>\r\n";
},"6":function(container,depth0,helpers,partials,data) {
    return "    <div class=\"document-category-attributes\"></div>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"xecmpf-document-preview\"></div>\r\n\r\n<div class=\"xecmpf-document-metadata\">\r\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"hideFavorite") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"loc":{"start":{"line":4,"column":2},"end":{"line":16,"column":13}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"hideMetadata") : depth0),{"name":"unless","hash":{},"fn":container.program(6, data, 0),"inverse":container.noop,"loc":{"start":{"line":17,"column":2},"end":{"line":19,"column":13}}})) != null ? stack1 : "")
    + "</div>\r\n";
}});
Handlebars.registerPartial('xecmpf_widgets_dossier_impl_documentslistitem_impl_documentslistitem', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/widgets/dossier/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});

csui.define('xecmpf/widgets/dossier/impl/nls/root/lang',{
  searchPlaceholder: 'Search groups.',
  emptyListText: 'No documents.',
  groupByLabel: 'Group by',
  classificationLabel: 'Classification',
  createDateLabel: 'Creation date',
  documentTypeLabel: 'Document type',
  tilesLabel: 'group(s)',
  documentsLabel: 'document(s)',
  addFav: 'Add to favorite',
  removeFav: 'Remove from favorite',
  selectByClassificationLabel:'Select group by Classification',
  selectByCreatedateLabel:'Select group by Created Date'
});



csui.define('css!xecmpf/widgets/dossier/impl/documentslistitem/impl/documentslistitem',[],function(){});
csui.define('xecmpf/widgets/dossier/impl/documentslistitem/documentslistitem.view',['csui/lib/jquery', 'csui/lib/underscore', 'csui/lib/backbone', 'csui/lib/marionette',
  'conws/models/favorite.model',
  'xecmpf/utils/document.thumbnail/document.thumbnail.view',
  'xecmpf/widgets/dossier/impl/documentslistitem/impl/metadata.model',
  'xecmpf/widgets/dossier/impl/documentslistitem/impl/metadata.view',
  'hbs!xecmpf/widgets/dossier/impl/documentslistitem/impl/documentslistitem',
  'i18n!xecmpf/widgets/dossier/impl/nls/lang',
  'css!xecmpf/widgets/dossier/impl/documentslistitem/impl/documentslistitem'
], function ($, _, Backbone, Marionette,
    FavoriteModel, DocumentThumbnailView, MetadataCollection, MetadataView,
    template, lang) {

  var DocumentsListItem;

  DocumentsListItem = Marionette.ItemView.extend({

    tagName: 'li',

    className: function () {
      var className = 'xecmpf-document-list-item';
      if (this.noAccessToItem) {
        className += ' no-contents-permission';
      }
      return className;
    },

    constructor: function DocumentsListItem(options) {
      options || (options = {});
      if ( options.model.get('actions').length === 0 ) {
        this.noAccessToItem = true;
      }
      Marionette.ItemView.prototype.constructor.apply(this, arguments);

      this.favModel = new FavoriteModel({
            selected: this.model.get('favorite')
          },
          {
            connector: this.model.connector,
            node: this.model
          });
      this.listenTo(this.favModel, 'change:selected', this.render);
    },

    template: template,

    templateHelpers: function () {
      return {
        enableIcon: true,
        hideMetadata: this.options.hideMetadata,
        hideFavorite: this.options.hideFavorite,
        addFav: lang.addFav + this.options.model.get('name'),
        removeFav: lang.removeFav + this.options.model.get('name')
      }
    },

    ui: {
      thumbnailEL: '.xecmpf-document-preview',
      metadataEl: '.document-category-attributes'
    },

    triggers: {
      'click a.socialFav.selected': 'remove:favorite',
      'click a.socialFav.notselected': 'add:favorite'

    },
    events: {
      'keydown a.socialFav.selected': function (event) {
        if (event.keyCode === 13 || event.keyCode === 32) {
          this.triggerMethod('remove:favorite');
        }
      },

      'keydown a.socialFav.notselected': function (event) {
        if (event.keyCode === 13 || event.keyCode === 32) {
          this.triggerMethod('add:favorite');
        }
      }
    },

    onRemoveFavorite: function (e) {
      if (!this.noAccessToItem) {
        this.favModel.remove();
        this.model.set('favorite', false);
        // Show directly that favorite was removed
        this.render();
      }      
    },

    onAddFavorite: function (e) {
      if (!this.noAccessToItem) {
        this.favModel.add();
        this.model.set('favorite', true);
        // Show directly that favorite was added
        this.render();
      }      
    },

    _renderMetadata: function () {
      var metadata_categories = this.model.get('metadata_categories');
      if (!_.isEmpty(metadata_categories)) {
        var metadataCollection = new MetadataCollection(undefined, {
          data: metadata_categories,
          hideEmptyFields: this.options.hideEmptyFields,
          catsAndAttrs: this.options.catsAndAttrs
        });
        this._metadataView = new MetadataView({collection: metadataCollection});
        this.ui.metadataEl.html(this._metadataView.render().el);
      }
    },

    _renderThumbnail: function () {
      this._documentThumbnailView = new DocumentThumbnailView({
        context: this.options.context,
        model: this.model,
        enableCaption: true
      });
      this.ui.thumbnailEL.html(this._documentThumbnailView.render().el);
    },

    onRender: function () {
      this._renderThumbnail();
      if (this.options.hideMetadata !== true) {
        this._renderMetadata();
      }
    },

    onBeforeDestroy: function () {
      this._documentThumbnailView.destroy();
      if (this._metadataView) {this._metadataView.destroy();}
    }
  });

  return DocumentsListItem;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/dossier/impl/documentslist/impl/documentslist',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<ul class=\"xecmpf-document-list-group\"></ul>";
}});
Handlebars.registerPartial('xecmpf_widgets_dossier_impl_documentslist_impl_documentslist', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/dossier/impl/documentslist/impl/documentslist',[],function(){});
csui.define('xecmpf/widgets/dossier/impl/documentslist/documentslist.view',['csui/lib/jquery', 'csui/lib/underscore', 'csui/lib/backbone', 'csui/lib/marionette',
  'csui/controls/tile/behaviors/infinite.scrolling.behavior',
  'csui/controls/tile/behaviors/perfect.scrolling.behavior',
  'csui/controls/tile/behaviors/blocking.behavior',
  'csui/controls/tile/tile.view',
  'csui/controls/list/emptylist.view',
  'xecmpf/widgets/dossier/impl/documentslist/impl/documents.model',
  'xecmpf/widgets/dossier/impl/documentslistitem/documentslistitem.view',
  'i18n!xecmpf/widgets/dossier/impl/nls/lang',
  'hbs!xecmpf/widgets/dossier/impl/documentslist/impl/documentslist',
  'css!xecmpf/widgets/dossier/impl/documentslist/impl/documentslist'
], function ($, _, Backbone, Marionette,
    InfiniteScrollingBehavior, PerfectScrollingBehavior, BlockingBehavior,
    TileView, EmptyListView, DocumentsCollection, DocumentsListItem,
    lang, template) {

  var DocumentsListView, DocumentsTileView;

  DocumentsListView = Marionette.CompositeView.extend({

    className: 'list-group-container',

    constructor: function DocumentsListView(options) {
      options || (options = {});
      Marionette.CompositeView.prototype.constructor.apply(this, arguments);
    },

    template: template,

    behaviors: {
      PerfectScrolling: {
        behaviorClass: PerfectScrollingBehavior,
        suppressScrollX: true,
        scrollYMarginOffset: 15
      },

      InfiniteScrolling: {
        behaviorClass: InfiniteScrollingBehavior,
        content: '>ul.xecmpf-document-list-group',
        fetchMoreItemsThreshold: 80
      }
    },

    childViewContainer: '>ul.xecmpf-document-list-group',

    childView: DocumentsListItem,

    childViewOptions: function () {
      return {
        context: this.options.context,
        workspaceContext: this.options.workspaceContext,
        nodeModel: this.options.nodeModel,
        hideMetadata: this.options.hideMetadata,
        hideEmptyFields: this.options.hideEmptyFields,
        hideFavorite: this.options.hideFavorite,
        catsAndAttrs: this.options.catsAndAttrs
      }
    },

    emptyView: EmptyListView,

    emptyViewOptions: {
      text: lang.emptyListText || 'No documents.'
    },

    onRender: function () {
      // this is important to make the perfect scrolling work.
      this.$el.one('mouseenter', $.proxy(function () {
        this.triggerMethod("dom:refresh");
      }, this))
    }
  });

  DocumentsTileView = TileView.extend({

    className: function () {
      var className       = 'xecmpf-documents-tile',
          parentClassName = _.result(TileView.prototype, 'className');
      if (parentClassName) {
        className += ' ' + parentClassName;
      }
      return className;
    },
    _focusedChild: undefined,
    _activeChild: undefined,
    constructor: function DocumentsTileView(options) {
      options || (options = {});
      TileView.prototype.constructor.apply(this, arguments);
      this.childrens = DocumentsListView
    },

    templateHelpers: function () {
      var title = this.model && this.model.get('name');
      return {
        title: title,
        icon: false
      };
    },

    behaviors: {
      Blocking: {
        behaviorClass: BlockingBehavior
      }
    },
    _accSelector: '.thumbnail_not_loaded',

    currentlyFocusedElement: function () {
      return this.$(this._accSelector);
    },

    getActiveChild: function () {
      return this._activeChild;
    },
    toggleFocus: function (on) {
      this.ui.listItem.prop('tabindex', on === true ? '0' : '-1'); // set or remove tabstop
      if (on) {
        this.ui.listItem.trigger("focus"); // if tabstop then set focus too
      }
      // this._focusOnTree = false;
    },
    contentView: DocumentsListView,

    contentViewOptions: function () {
      var queryParams = _.extend(this.options.model && this.options.model.get('query_params'), {
            metadata_categories: this.options.metadata_categories
          }),
          models      = this.options.model && this.options.model.get('documents'),
          paging      = this.options.model && this.options.model.get('paging');

      var collection = new DocumentsCollection(models, {
        nodeModel: this.options.nodeModel,
        query: queryParams,
        paging: paging
      });

      // Loading animation
      this.listenTo(collection, "request", this.blockActions)
          .listenTo(collection, "sync", this.unblockActions)
          .listenTo(collection, "error", this.unblockActions);

      return {
        collection: collection,
        context: this.options.context,
        workspaceContext: this.options.workspaceContext,
        nodeModel: this.options.nodeModel,
        hideMetadata: this.options.hideMetadata,
        hideEmptyFields: this.options.hideEmptyFields,
        hideFavorite: this.options.hideFavorite,
        catsAndAttrs: this.options.catsAndAttrs
      }
    },

    _renderTileProperties: function () {
      var docsCount = (this.model && this.model.get('paging').total_count) || '0',
          $tilePropEl, $docsCountLabel;

      this.$docsCountEl = $('<span></span>')
          .addClass('count docs-count')
          .text(docsCount);
      $docsCountLabel = $('<span></span>')
          .addClass('count-label')
          .text(lang.documentsLabel || 'document(s)');

      $tilePropEl = $('<div></div>')
          .addClass('tile-properties')
          .append(this.$docsCountEl).append($docsCountLabel);

      this.$('>.tile-header').append($tilePropEl);
    },

    onRender: function () {
      this._renderTileProperties();
    },

    onBeforeShow: function () {
      this.listenTo(this.contentView, 'execute:defaultAction', function (node) {
        this.triggerMethod('execute:defaultAction', node);
      });
    }
  });

  return DocumentsTileView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/dropdown/impl/dropdownitem',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"#\" tabindex=\"-1\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"name") || (depth0 != null ? lookupProperty(depth0,"name") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"name","hash":{},"loc":{"start":{"line":1,"column":26},"end":{"line":1,"column":34}}}) : helper)))
    + "</a>";
}});
Handlebars.registerPartial('xecmpf_controls_dropdown_impl_dropdownitem', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/controls/dropdown/dropdownitem.view',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/backbone', 'csui/lib/marionette',
  'hbs!xecmpf/controls/dropdown/impl/dropdownitem'
], function (_, $, Backbone, Marionette,
    template) {

  var DropdownItemView;

  DropdownItemView = Marionette.ItemView.extend({

    className: 'dropdown-menu-item',

    tagName: 'li',

    constructor: function DropdownItemView(options) {
      Marionette.ItemView.prototype.constructor.apply(this, arguments);
    },

    template: template,

    triggers: {
      'click': 'click:item'
    },

    modelEvents: {
      'change': 'render'
    }
  });

  return DropdownItemView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/dropdown/impl/dropdown',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"binf-dropdown-toggle csui-acc-focusable\" role=\"button\"\r\n        data-binf-toggle=\"dropdown\" aria-expanded=\"false\" tabindex=\"-1\">\r\n  <span class=\"dropdown-label\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"dropdownLabel") || (depth0 != null ? lookupProperty(depth0,"dropdownLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"dropdownLabel","hash":{},"loc":{"start":{"line":3,"column":31},"end":{"line":3,"column":48}}}) : helper)))
    + "</span>\r\n  <span class=\"csui-button-icon icon-expandArrowDown\"></span>\r\n</a>\r\n<ul class=\"binf-dropdown-menu\" role=\"menu\"></ul>\r\n";
}});
Handlebars.registerPartial('xecmpf_controls_dropdown_impl_dropdown', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/controls/dropdown/impl/dropdown',[],function(){});
csui.define('xecmpf/controls/dropdown/dropdown.view',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/backbone', 'csui/lib/marionette',
  'csui/lib/binf/js/binf',
  'xecmpf/controls/dropdown/dropdownitem.view',
  'hbs!xecmpf/controls/dropdown/impl/dropdown',
  'css!xecmpf/controls/dropdown/impl/dropdown'
], function (_, $, Backbone, Marionette, BinfJS,
    DropdownItemView, template, css) {

  var DropdownView;

  DropdownView = Marionette.CompositeView.extend({

    className: 'xecmpf-dropdown binf-dropdown',

    constructor: function DropdownView(options) {
      options || (options = {});
      Marionette.CompositeView.prototype.constructor.apply(this, arguments);
      this.label = this.options.label;
    },

    template: template,

    templateHelpers: function () {
      return {
        dropdownLabel: this.label || 'Dropdown'
      }
    },

    ui: {
      control: '.binf-dropdown-toggle',
      label: '.dropdown-label'
    },

    childView: DropdownItemView,

    childViewContainer: 'ul.binf-dropdown-menu',

    childEvents: {
      'render': 'onRenderChild',
      'click:item': 'onClickItem'
    },

    onRenderChild: function (childView) {
      var currModel = childView.model;
      if (currModel.get('active') === true) {
        childView.$el
            .addClass('binf-active')
            .siblings().removeClass('binf-active');
        this.currModel = currModel;
      }
      if (currModel.get('hide') === true) {
        childView.$el.addClass('binf-hidden');
      }
    },

    onClickItem: function (childView) {
      if (!childView.$el.hasClass('binf-active')) {
        var newModel = childView.model,
            args     = {
              currModel: this.currModel,
              newModel: newModel
            };
        this.triggerMethod('change:dropdown:item', args);
        if (args.change !== false) {
          childView.$el
              .addClass('binf-active')
              .siblings().removeClass('binf-active');
          this.currModel = newModel;
        }
        this.hideDropdownMenu();
      }
    },

    showDropdownMenu: function () {
      this.$el.addClass('binf-open');
      this.ui.control.attr('aria-expanded', true);
    },

    hideDropdownMenu: function () {
      this.$el.removeClass('binf-open');
      this.ui.control.attr('aria-expanded', false);
    },

    updateLabel: function (newLabel) {
      if (newLabel && typeof newLabel === 'string') {
        this.ui.label.text(newLabel);
      }
    },

    setModelActive: function (model) {
      if (model instanceof Backbone.Model) {
        model.unset('active', {silent: true});
        model.set('active', true);
      }
    },

    setModelHide: function (model) {
      if (model instanceof Backbone.Model) {
        model.unset('hide', {silent: true});
        model.set('hide', true);
      }
    },

    onRender: function () {
      this.ui.control.binf_dropdown();
    }
  });

  return DropdownView;
});

csui.define('xecmpf/widgets/dossier/impl/dropdown.items',['module', 'csui/lib/backbone', 'i18n!xecmpf/widgets/dossier/impl/nls/lang'
], function (module, Backbone, lang) {
  var config = module.config(),
      DropdownItemModel,
      DropdownItemCollection,
      dropdownItems;

  DropdownItemModel = Backbone.Model.extend({

    idAttribute: "value",

    defaults: {
      value: null,
      name: null,
      sequence: 0 // smaller number moves up
    }
  });

  DropdownItemCollection = Backbone.Collection.extend({

    model: DropdownItemModel,
    comparator: 'sequence',

    getItemValues: function () {
      return this.pluck('value');
    },

    deepClone: function () {
      return new DropdownItemCollection(
          this.map(function (item) {
            return item.attributes;
          }));
    }

  });

  dropdownItems = new DropdownItemCollection([
    {
      value: 'classification',
      name: config.groupByDocumentType ?
            lang.documentTypeLabel : lang.classificationLabel,
      sequence: 10
    },
    {
      value: 'create_date',
      name: lang.createDateLabel,
      sequence: 20
    }
  ]);

  return dropdownItems;
});


csui.define('css!xecmpf/widgets/dossier/impl/dossier',[],function(){});
csui.define('xecmpf/widgets/dossier/dossier.view',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/backbone', 'csui/lib/marionette',
  'csui/utils/contexts/factories/node', 'conws/models/workspacecontext/workspacecontext.factory',
  'xecmpf/widgets/dossier/impl/dossier.factory',
  'csui/controls/tile/behaviors/blocking.behavior', 'csui/behaviors/limiting/limiting.behavior',
  'csui/controls/tile/behaviors/perfect.scrolling.behavior',
  'xecmpf/behaviors/scroll.controls/scroll.controls.behavior',
  'csui/controls/list/behaviors/list.view.keyboard.behavior',
  'csui/dialogs/modal.alert/modal.alert',
  'csui/controls/list/list.view', 'xecmpf/widgets/dossier/impl/documentslist/documentslist.view',
  'xecmpf/controls/dropdown/dropdown.view',
  'xecmpf/widgets/dossier/impl/dropdown.items',
  'i18n!xecmpf/widgets/dossier/impl/nls/lang',
  'css!xecmpf/widgets/dossier/impl/dossier'
], function (_, $, Backbone, Marionette,
    NodeModelFactory, WorkspaceContextFactory, DossierFactory,
    BlockingBehavior, LimitingBehavior, PerfectScrollingBehavior,
    ScrollControlsBehavior, ListViewKeyboardBehavior, ModalAlert,
    ListView, DocumentsListView, DropdownView,
    dropdownMenuItems, lang) {

  var DossierView;

  DossierView = ListView.extend({

    id: 'xecmpf-dossier',

    constructor: function DossierView(options) {
      options || (options = {});
      options = options.data ? _.extend(options, options.data) : options;
      if (!options.workspaceContext) {
        if (options.context) {
          options.workspaceContext = options.context.getObject(WorkspaceContextFactory);
        } else {
          throw new Error('Context is missing in the constructor options!');
        }
      }

      // to trigger search only if there is a change in search term
      this.lastFilterValue = "";

      options.workspaceContext.setWorkspaceSpecific(DossierFactory);
      ListView.prototype.constructor.apply(this, arguments);

      this.listenTo(this.completeCollection, 'request', this.blockActions)
          .listenTo(this.completeCollection, 'error', this.unblockActions)
          .listenTo(this.completeCollection, 'sync', this.onCompleteCollectionSync);

      this.synced = false;
    },

    templateHelpers: function () {
      return {
        icon: undefined,
        title: undefined,
        searchPlaceholder: lang.searchPlaceholder
      };
    },

    events: {
      'focus span[title="Search"]': function () {
        var dropdown = this.$el.find('.xecmpf-dropdown');
        dropdown.removeClass('binf-open');
      },

      'keydown .clearer': function () {
        var searchInput = this.$('.search');
        searchInput.val('');
        searchInput.trigger("focus");
        this.filterChanged();
      },

      'keydown li.dropdown-menu-item': function () {
        if (event.keyCode === 13 || event.keyCode === 32) {
          $('.dropdown-menu-item').trigger("click");
          var dropdown = this.$el.find('.xecmpf-dropdown');
          dropdown.removeClass('binf-open');
        }
      },
      'keydown .dossier-dropdown': 'getDossierViewFilter',
      'keydown .tile-header span[title="Search"]': function (event) {
        if (event.keyCode === 13 || event.keyCode === 32) {
          $('.tile-header span[title="Search"]').trigger("click");
        }
      },
      'keydown .tile-header input[class="search"]': function (event) {
        if (event.keyCode === 27) {
          $('.tile-header span[title="Hide"]').trigger("click");
          $('.tile-header span[title="Hide"]').trigger("focus");
        }
      }
    },
    behaviors: {
      LimitedList: {
        behaviorClass: LimitingBehavior,
        // never show expand icon
        limit: undefined,
        completeCollection: function () {
          this.nodeModel = this.options.workspaceContext.getObject(NodeModelFactory);
          this.groupBy = this.options.groupBy;

          (function (metadata, ctx) {
            metadata || (metadata = []);
            ctx.metadata_categories = '';
            ctx.catsAndAttrs = [];
            if (metadata.length > 0) {
              var categories = '', catsAndAttrs = [];
              metadata.forEach(function (item) {
                if (item.attributeId) {
                  categories += item.categoryId + ',';
                  catsAndAttrs.push(item.categoryId + '_' + item.attributeId);
                } else if (item.categoryId) {
                  categories += item.categoryId + ',';
                  catsAndAttrs.push(item.categoryId);
                }
              });
              ctx.metadata_categories = categories.substr(0, categories.length - 1);
              ctx.catsAndAttrs = catsAndAttrs;
            }
          })(this.options.metadata, this);
          return this.options.workspaceContext.getCollection(DossierFactory, {
            options: {
              nodeModel: this.nodeModel,
              query: {
                group_by: this.groupBy,
                metadata_categories: this.metadata_categories
              }
            }
          });
        }
      },

      PerfectScrolling: {
        behaviorClass: PerfectScrollingBehavior,
        // disable the PerfectScrolling because ScrollControlsBehavior will be used for scrolling.
        scrollingDisabled: true
      },

      ScrollControls: {
        behaviorClass: ScrollControlsBehavior,
        controlsContainer: '>.tile-content',
        contentParent: '>.tile-content>.binf-list-group',
        animateDuration: 500, //ms
        scrollableWidth: function () { //px
          var contentParentWidth = this.$('>.tile-content').innerWidth(),
              // tileWidth: width of a tile including border, padding and margin.
              tileWidth          = this.$('>.tile-content>.binf-list-group>.tile').outerWidth(true),
              // tilesInView: number of completely visible tiles.
              tilesInView        = Math.floor(contentParentWidth / tileWidth),
              // scrollableWidth: width of completely visible tiles.
              scrollableWidth    = (tilesInView * tileWidth) || tileWidth;
          return scrollableWidth;
        },
        leftControlIconClass: 'caret-left',
        rightControlIconClass: 'caret-right'
      },

      Blocking: {
        behaviorClass: BlockingBehavior
      }

    },

    getDossierViewFilter: function (e) {
      switch (e.keyCode) {
      case 13:  // enter

      case 32:  // space

        var dropdown = this.$el.find('.xecmpf-dropdown');
        dropdown.hasClass('binf-open') ? dropdown.removeClass('binf-open') :
        dropdown.addClass('binf-open');

        break;

          //xecmpf-dropdown binf-dropdown
      }
    },

    childView: DocumentsListView,

    childViewOptions: function () {
      return {
        context: this.options.context,
        workspaceContext: this.options.workspaceContext,
        nodeModel: this.nodeModel,
        hideMetadata: this.options.hideMetadata,
        hideEmptyFields: this.options.hideEmptyFields,
        metadata_categories: this.metadata_categories,
        hideFavorite: this.options.hideFavorite,
        catsAndAttrs: this.catsAndAttrs
      }
    },

    onRenderTemplate: function () {
      if (this.options.hideGroupByCriterionDropdown !== true) {
        this._renderGroupByDropdownView();
      }
      this._renderDossierProperties();
    },

    onRenderCollection: function () {
      this.triggerMethod('update:scroll:controls');
    },

    onCompleteCollectionSync: function () {
      this.synced = true;
      this._updateDossierProperties();
      this.unblockActions();
    },

    isEmpty: function () {
      return (this.synced === true) && (this.collection.models.length === 0);
    },

    emptyViewOptions: {
      text: lang.emptyListText || "No documents."
    },

    _renderGroupByDropdownView: function () {
      var $dropdownEl = $('<div></div>')
          .addClass('dossier-dropdown-wrapper');
      var $dropdownLabel = $('<span></span>')
          .addClass('dossier-dropdown-label')
          .text(lang.groupByLabel);
      var $dropdown = $('<div></div>')
          .addClass('dossier-dropdown');
      $dropdownEl
          .append($dropdownLabel)
          .append($dropdown);

      this.$('>.tile-header>.tile-controls').prepend($dropdownEl);

      var dropdownRegion = new Marionette.Region({el: $dropdown});

      this.groupBydropdownView = new DropdownView({
        label: this._getGroupByDropdownLabel(dropdownMenuItems),
        collection: dropdownMenuItems
      });

      this.listenTo(this.groupBydropdownView, 'change:dropdown:item', function (args) {
        // re-fetch the completeCollection according to the selected group_by criterion.
        var value = args.newModel.get('value'),
            that  = this;
        this.synced = false;
        this.completeCollection
            .fetch({
              query: {
                group_by: value,
                metadata_categories: this.metadata_categories
              }
            })
            .done(function (response, status, jqXHR) {
              that.groupBy = value;
              that.groupBydropdownView.updateLabel(that._getGroupByDropdownLabel(args.newModel));
              // move the scroll to initial position
              var $scrollEl = that.$('>.tile-content>.binf-list-group');
              $scrollEl.scrollLeft(0);
              that.triggerMethod('update:scroll:controls');
              that._setGroupByDropdownModelActive(that.groupBydropdownView.collection);
            })
            .fail(function (jqXHR, status, error) {
              var errMsg = jqXHR.responseJSON ? jqXHR.responseJSON.error :
                           'Internal Server Error!';
              ModalAlert
                  .showError(errMsg)
                  .always(function () {
                    that._setGroupByDropdownModelActive(args.currModel);
                  });
            });
      });
      dropdownRegion.show(this.groupBydropdownView);
      this._setGroupByDropdownModelActive(dropdownMenuItems);
    },

    _getGroupByDropdownLabel: function (arg) {
      var label = /*lang.groupByLabelPrefix +*/ ' ',
          dropdownActiveModel;
      if (arg instanceof Backbone.Model) {
        dropdownActiveModel = arg;
      } else if (arg instanceof Backbone.Collection) {
        dropdownActiveModel = this._getGroupByDropdownActiveModel(arg);
      }

      if (dropdownActiveModel) {
        label += dropdownActiveModel.get('name');
      }
      return label;
    },

    _getGroupByDropdownActiveModel: function (collection) {
      if (collection instanceof Backbone.Collection) {
        return collection.find($.proxy(function (model) {
          return model.get('value') === this.groupBy;
        }, this));
      }
    },

    _setGroupByDropdownModelActive: function (arg) {
      var activeModel;
      if (arg instanceof Backbone.Model) {
        activeModel = arg;
      } else if (arg instanceof Backbone.Collection) {
        activeModel = this._getGroupByDropdownActiveModel(arg);
      }

      if (activeModel) {
        this.groupBydropdownView.setModelActive(activeModel);
      }
    },

    _renderDossierProperties: function () {
      var tilesCount = this.completeCollection.length || '0',
          docsCount  = this.completeCollection.total_documents || '0',
          $dossierPropEl, $tilesCountLabel, $docsCountLabel;

      this.$tilesCountEl = $('<span></span>')
          .addClass('count tiles-count')
          .text(tilesCount);
      $tilesCountLabel = $('<span></span>')
          .addClass('count-label')
          .text(lang.tilesLabel || 'group(s)');

      this.$docsCountEl = $('<span></span>')
          .addClass('count docs-count')
          .text(docsCount);
      $docsCountLabel = $('<span></span>')
          .addClass('count-label')
          .text(lang.documentsLabel || 'document(s)');

      $dossierPropEl = $('<div></div>')
          .addClass('dossier-properties')
          .append(this.$tilesCountEl).append($tilesCountLabel)
          .append(this.$docsCountEl).append($docsCountLabel);

      var _dropdownElement = this.$('.dossier-dropdown .csui-acc-focusable').get(0);
      _dropdownElement.setAttribute('tabindex', '0');
      var groupBy = this.groupBy;
      var toolTop
      if (groupBy === 'create_date') {
        toolTop = lang.selectByClassificationLabel;
      } else {
        toolTop = lang.selectByCreatedateLabel;
      }
      _dropdownElement.setAttribute('aria-label', toolTop);
      this.$('>.tile-header>.tile-title').remove();
      this.$('>.tile-header').prepend($dossierPropEl);

      var searchButton = this.$('>.tile-header span[title="Search"]');
      $(searchButton).addClass('csui-acc-focusable');
      $(searchButton).attr('tabindex', '0');

    },

    _updateDossierProperties: function () {
      var activeTiles = _.filter(this.completeCollection.models, function (model) {
        return model.attributes.documents;
      });
      var tilesCount = activeTiles.length,
          docsCount  = this.completeCollection.total_documents;
      this.$tilesCountEl.text(tilesCount);
      this.$docsCountEl.text(docsCount);
    },

    filterChanged: function () {
      var filterValue = this.ui.searchInput.val().trim();
      // trigger search if there is a change in search term
      if (this.lastFilterValue !== filterValue) {
        this.lastFilterValue = filterValue;
        ListView.prototype.filterChanged.apply(this, arguments);
      }
    }
  });

  return DossierView;
});

csui.define('xecmpf/widgets/header/impl/completenesscheck/impl/models/outdatedocuments.model',[
    'csui/lib/underscore',
    'csui/lib/backbone',
    'csui/models/mixins/connectable/connectable.mixin',
    'csui/utils/url'
], function (_, Backbone, ConnectableMixin, Url) {

    var OutdatedDocumentModel = Backbone.Model.extend({

        idAttribute: 'id',

        constructor: function OutdatedDocumentModel(attributes, options) {
            options || (options = {});
            Backbone.Model.prototype.constructor.apply(this, arguments);
            this.makeConnectable(options);
        },

        parse: function (response) {
            return response;
        }

    });
    ConnectableMixin.mixin(OutdatedDocumentModel.prototype);

    var OutdatedDocumentCollection = Backbone.Collection.extend({

        model: OutdatedDocumentModel,

        constructor: function OutdatedDocumentCollection(models, options) {
            this.options = options || {};
            Backbone.Collection.prototype.constructor.apply(this, arguments);
            this.makeConnectable(options);
        },

        url: function () {
            var wrkspceId = this.options.node.get('id');
            return Url.combine(new Url(this.connector.connection.url).getApiBase('v2'),
                '/businessworkspaces/' + wrkspceId + '/outdateddocuments');
        },

        parse: function (response) {
            return response.results.data;
        },

        fetch: function () {
            return Backbone.Collection.prototype.fetch.apply(this, arguments);
        }
    });

    ConnectableMixin.mixin(OutdatedDocumentCollection.prototype);

    return OutdatedDocumentCollection;

});
csui.define('xecmpf/widgets/header/impl/completenesscheck/impl/outdatedocuments.factory',[
    'module',
    'csui/lib/underscore',
    'csui/lib/backbone',
    'csui/utils/contexts/factories/factory',
    'csui/utils/contexts/factories/connector',
    'csui/utils/contexts/factories/node',
    'xecmpf/widgets/header/impl/completenesscheck/impl/models/outdatedocuments.model'
], function (module, _, Backbone,
    CollectionFactory,
    ConnectorFactory,
    NodeFactory,
    OutdateDocumentsCollection) {
    var OutdateDocumentsFactory = CollectionFactory.extend({
        propertyPrefix: 'outdateDocumentsCollection',
        constructor: function OutdateDocumentsFactory(context, options) {
            CollectionFactory.prototype.constructor.apply(this, arguments);
            var outdatedDocumentsCollection = this.options.outdatedDocumentsCollection || {};
            if (!(outdatedDocumentsCollection instanceof Backbone.Collection)) {
                var connector = context.getObject(ConnectorFactory, options),
                    node = context.getModel(NodeFactory, options),
                    config = module.config();
                outdatedDocumentsCollection = new OutdateDocumentsCollection(outdatedDocumentsCollection.models, _.extend(
                    {
                        connector: connector,
                        node: node,
                        reportType: 'outdatedDocuments'
                    }, outdatedDocumentsCollection.options, config.options, {
                    autofetch: true
                }));
            }
            this.property = outdatedDocumentsCollection;
        },
        fetch: function (options) {
            return this.property.fetch(options);
        }
    });
    return OutdateDocumentsFactory;
});

csui.define('xecmpf/widgets/header/impl/previewpane/impl/previewpane.list.keyboard.behavior',['module', 'csui/lib/underscore', 'csui/lib/jquery', 'csui/utils/log', 'csui/lib/marionette'
], function (module, _, $, log, Marionette) {
  'use strict';

  // This behavior implements a default keyboard navigation for the simple list (fly-out)
  // in xecmpf header widget.

  var TabPosition = {
    none: -1,
    list: 1
  };

  var PreviewPaneListKeyboardBehavior = Marionette.Behavior.extend({

    constructor: function PreviewPaneListKeyboardBehavior(options, view) {
      Marionette.Behavior.prototype.constructor.apply(this, arguments);

      view.keyboardBehavior = this;
      this.tabableElements = [];

      var self = this;

      this.listenTo(view, 'show', function () {
        self.refreshTabableElements(view);
      });
      this.listenTo(view, 'click:item', function (item) {
        // clear the currently focused element
        var selIndex = view.selectedIndex;
        var selectedElem = view.selectedIndexElem(selIndex);
        selectedElem && selectedElem.prop('tabindex', '-1');
        // set the new element tabindex
        view.currentTabPosition = TabPosition.list;
        view.selectedIndex = view.collection.indexOf(item.model);
      });

      _.extend(view, {


        _focusList: function () {
          if (this.selectedIndex < 0 || this.selectedIndex === undefined) {
            this.selectedIndex = this.getSelectedIndex();
          }
          this.currentTabPosition = TabPosition.list;
          return this.getSelectedItem().$el;
        },

        _setFocus: function () {

            return this._focusList();
        },

        _listIsInFocus: function () {
          var inFocus = false;
          var i;
          for (i = 0; i < this.collection.length; i++) {
            var $elem = this.selectedIndexElem(i);
            if ($elem && $elem.is(":focus")) {
              inFocus = true;
              break;
            }
          }

          return inFocus;
        },

        _checkFocusAndSetCurrentTabPosition: function () {
          if (this._listIsInFocus()) {
            this.currentTabPosition = TabPosition.list;
          } else {
            this.currentTabPosition = TabPosition.none;
          }
        },

        // handle scenario that currentlyFocusedElement does not have event param for shiftTab
        _setFirstAndLastFocusable: function () {
          this.getSelectedItem() && this.getSelectedItem().$el.prop('tabindex', '0');
        },

        currentlyFocusedElement: function (event) {
          this._checkFocusAndSetCurrentTabPosition();
          this._setFirstAndLastFocusable();
          if (event && event.shiftKey) {
            return this._focusList();
          }
          // maintain old position
          if (this.currentTabPosition === TabPosition.list) {
            return this._focusList();
          } else {
            return this._setFocus();
          }
        },

        _resetFocusedListElem: function () {
          // workaround the general behaviors that it keeps the old focus
          // reset focus back to the active list item before moving out of the region
          var selIndex, selectedElem;

          // clear the currently focused element
          selIndex = this.selectedIndex;
          selectedElem = this.selectedIndexElem(selIndex);
          selectedElem && selectedElem.prop('tabindex', '-1');

          // set to the active element
          selIndex = this.getSelectedIndex();
          selectedElem = this.selectedIndexElem(selIndex);
          if (selectedElem) {
            selectedElem.prop('tabindex', '0');
            this.selectedIndex = selIndex;
          }
        },

        _moveTo: function (event, $elem, $preElem) {
          event.preventDefault();
          event.stopPropagation();
          setTimeout(_.bind(function () {
            $preElem && $preElem.prop('tabindex', '-1');
            $elem.prop('tabindex', '0');
            $elem.trigger("focus");
          }, this), 50);
        },

        onKeyInView: function (event) {
          this._checkFocusAndSetCurrentTabPosition();
          if (event.keyCode === 9) {
            // tab
            if (event.shiftKey) {  // shift tab -> activate previous region
              setTimeout(_.bind(function () {
                this._resetFocusedListElem();
              }, this), 50);
              // }
            }
          } else if (event.keyCode === 32 || event.keyCode === 13) {
            // space(32) or enter(13)
            if (this.currentTabPosition === TabPosition.list) {
              event.preventDefault();
              event.stopPropagation();
              this.selectAt(this.selectedIndex);
            }
          }
          else if (event.keyCode === 27) { // escape
            if (this.previewPane) {
              this.previewPane.hide();
              // reset focus to button of missing documents/displayUrl
              var but = this.previewPane.parent.$el.find('button');
              if (but){
                but.trigger("focus");
              }
            }
         }

        },

        onKeyDown: function (event) {
          if (this.config.debug === true) {
            console.log('preview-behavior: onKeydown - keyCode:' + event.which );
          }
          this._checkFocusAndSetCurrentTabPosition();
          if (this.currentTabPosition !== TabPosition.list) {
            this.onKeyInView(event);
            return;
          }

          var selIndex = this.selectedIndex;
          if (selIndex < 0 || selIndex === undefined) {
            selIndex = this.getSelectedIndex();
          }
          var $preElem = this.selectedIndexElem(selIndex);

          switch (event.which) {
          case 33: // page up
            this._moveTo(event, this._selectFirst(), $preElem);
            break;
          case 34: // page down
            this._moveTo(event, this._selectLast(), $preElem);
            break;
          case 38: // up
            this._moveTo(event, this._selectPrevious(), $preElem);
            break;
          case 40: // down
            this._moveTo(event, this._selectNext(), $preElem);
            break;
          default:
            this.onKeyInView(event);
            return; // exit this handler for other keys
          }
        },

        _selectFirst: function () {
          this.selectedIndex = 0;
          return this.selectedIndexElem(this.selectedIndex);
        },

        _selectLast: function () {
          this.selectedIndex = this.collection.length - 1;
          return this.selectedIndexElem(this.selectedIndex);
        },

        _selectNext: function () {
          if (this.selectedIndex < 0 || this.selectedIndex === undefined) {
            this.selectedIndex = this.getSelectedIndex();
          }
          if (this.selectedIndex < this.collection.length - 1) {
            this.selectedIndex++;
          }
          return this.selectedIndexElem(this.selectedIndex);
        },

        _selectPrevious: function () {
          if (this.selectedIndex < 0 || this.selectedIndex === undefined) {
            this.selectedIndex = this.getSelectedIndex();
          }
          if (this.selectedIndex > 0) {
            this.selectedIndex--;
          }
          return this.selectedIndexElem(this.selectedIndex);
        },

        selectAt: function (index) {
          if (index >= this.collection.length || index < 0) {
            return;
          }
          var $elem = this.selectedIndexElem(index);
          $elem && $elem.trigger("click");
        }

      });

    }, // constructor

    refreshTabableElements: function (view) {
      log.debug('PreviewPaneListKeyboardBehavior::refreshTabableElements ' +
                view.constructor.name) &&
      console.log(log.last);
      this.view.currentTabPosition = TabPosition.none;
      this.view.selectedIndex = -1;
    }

  });

  return PreviewPaneListKeyboardBehavior;
});

/**
 * Created by mtanwar on 26-07-2016.
 */

csui.define('xecmpf/widgets/header/impl/previewpane/impl/previewpane.list.view',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/backbone', 'csui/lib/marionette',
  'csui/controls/list/simplelist.view', 'csui/controls/node-type.icon/node-type.icon.view',
  'xecmpf/widgets/header/impl/previewpane/impl/previewpane.list.keyboard.behavior',
  'csui/dialogs/modal.alert/modal.alert'

], function (_, $, Backbone, Marionette,
  SimpleListView, NodeTypeIconView, PreviewPaneListKeyboardBehavior, ModalAlert) {

  var PreviewPaneListView = SimpleListView.extend({

    constructor: function PreviewPaneListView(options) {
      SimpleListView.prototype.constructor.apply(this, arguments);
    },

    behaviors: {
      PreviewPaneListKeyboardBehavior: {
        behaviorClass: PreviewPaneListKeyboardBehavior
      }
    },

    events: {
      'keydown': 'onKeyDown'
    },

    initialize: function (options) {
      options || (options = {});
      this.enableIcon = options.enableIcon;
      this.enableDescription = options.enableDescription;
      // for preview pane list keyboard behavior:
      this.previewPane = options.previewPane;
      // for debugging option
      this.config = options.config;

      this.listenTo(this, 'childview:render', this.onRenderItem);
      this.listenTo(this, 'childview:before:destroy', this.onBeforeDestroyItem);
      this.listenTo(this, 'click:item', this.onClickListItem);
    },

    childViewOptions: function (childViewModel) {
      var docTypeName = childViewModel.get('name'),
        reportType = childViewModel.get('reportType');
      if (reportType === "outdatedDocuments") {
        docTypeName = childViewModel.get('classification_name');
      }
      return {
        templateHelpers: function () {
          return {
            enableIcon: this.enableIcon,
            enableDescription: this.enableDescription,
            name: docTypeName
          };
        }.bind(this)
      };
    },

    onClickListItem: function (src) {
      var url = src.model.get('displayUrl'),
        error = src.model.get('displayUrlError');
      if (error) {
        ModalAlert.showError(error);
      } else if (url) {
        var browserTab = window.open(url, '_blank');
        browserTab.focus();
      }
    },

    onRenderItem: function (childView) {
      childView._nodeIconView = new NodeTypeIconView({
        el: childView.$('.csui-type-icon').get(0),
        node: childView.model
      });
      childView._nodeIconView.render();
      if (this.options && childView.model
        && childView.model.attributes
        && childView.model.attributes.name
        && this.options.enableDescription) {
        var locHTML = '<div class="SLITitleDiv"><div class="SLITitle"><span title="' +
          _.escape(childView.model.attributes.name)
          + '">' +
          _.escape(childView.model.attributes.name)
          + '</span></div><div class="SLIDescription"><span title="' +
          _.escape(childView.model.attributes.classification_name)
          + '">' +
          _.escape(childView.model.attributes.classification_name)
          + '</span></div></div>';
        childView.$('.list-item-title').replaceWith(locHTML);
      }
      var displayUrl = childView.model.get('displayUrl');
      if (displayUrl) {
        var a = childView.$el[0];
        a.href = displayUrl;
      }
    },

    onBeforeDestroyItem: function (childView) {
      if (childView._nodeIconView) {
        childView._nodeIconView.destroy();
      }
    }
  });

  return PreviewPaneListView;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/header/impl/previewpane/impl/previewpane',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "\r\n<div class=\"binf-panel-body xecmpf-preview-body csui-normal-scrolling  csui-no-scroll-x\"></div>\r\n\r\n<div class=\"binf-panel-footer xecmpf-preview-footer\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"info") || (depth0 != null ? lookupProperty(depth0,"info") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"info","hash":{},"loc":{"start":{"line":4,"column":53},"end":{"line":4,"column":61}}}) : helper)))
    + "</div>\r\n";
}});
Handlebars.registerPartial('xecmpf_widgets_header_impl_previewpane_impl_previewpane', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/header/impl/previewpane/impl/previewpane',[],function(){});
csui.define('xecmpf/widgets/header/impl/previewpane/previewpane.view',['csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/marionette',
  'csui/utils/base',
  'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',
  'xecmpf/widgets/header/impl/previewpane/impl/previewpane.list.view',
  'hbs!xecmpf/widgets/header/impl/previewpane/impl/previewpane', 'i18n',
  'css!xecmpf/widgets/header/impl/previewpane/impl/previewpane'
], function (_, $, Marionette,
    base, LayoutViewEventsPropagationMixin,
    PreviewListView, template, i18n) {

  var PreviewPaneView = Marionette.LayoutView.extend({

    className: 'xecmpf-preview binf-panel binf-panel-default',

    constructor: function PreviewPaneView(options) {
      Marionette.LayoutView.prototype.constructor.call(this, options);
      options || (options = {});
      this.config = options.config;

      if (this.config) {
        // the related item view to show the preview for
        this.parent = options.parent;
        this.config.readonly = true;

        this.docsCollection = options.collection;
        this.headerTitle = options.headerTitle;
        this.footerInfoText = options.info;

        //---------------------------------------------------------------
        // setup binf-popover
        //---------------------------------------------------------------
        this.direction = i18n.settings.rtl ? 'left' : 'right';
        options.parent.$el.binf_popover({
          content: this.$el,
          placement: "auto " + this.direction,
          trigger: 'manual',
          container: $.fn.binf_modal.getDefaultContainer(),
          html: true,
          // html accessiblity check: no empty headings are allowed
          // -> use pop-over title instead of our own missing documents header
          title: options.headerTitle
        });

        var $tip = this.parent.$el.data('binf.popover');
        var $pop = $tip.tip();
        var customPopoverClass = !options.customPopoverClass ? options.customPopoverClass : "";
        $pop.addClass('xecmpf-previewpane-popover').addClass(options.customPopoverClass);
        //Added a background colour to the header to match the colour of the MissingDocument/Outdated/InProcess icon
        if (options && options.headerColor) {
          if (this.config.debug === true) {
            console.log('add headerColor ' + options.headerColor + ' to ' +
                        $pop.find('.binf-popover-title'));
          }
          $pop.find('.binf-popover-title').addClass(options.headerColor);
        }

        //---------------------------------------------------------------
        // setup event handlers for binf-popover and its associated item view
        //---------------------------------------------------------------
        // SAPRM-11635:
        this.parent.$el.off('click').on('click', $.proxy(function () {
          if (this.config.debug === true) {
            console.log('Preview : Keyboard enter item');
          }
          this.show();
          // we have to set focus in simple list else keyboard navigation is
          // not working:
          var index = 0;
          var nthChildSel = _.str.sformat('div a:nth-child({0})', index + 1);
          var $item = this.docsListView.$(nthChildSel);
          $item.first().trigger("focus");
        }, this));

        this.parent.$el.off('mouseenter').on('mouseenter', $.proxy(function () {
          if (this.config.debug === true) {
            console.log('Preview : Mouseenter item');
          }
          this.show();
        }, this));

        this.parent.$el.off('keydown').on('keydown', $.proxy(function () {
          if(event.keyCode === 13 || event.keyCode === 32  )
          {
            this.show();
          }
          if (event.keyCode === 27 && this.isRendered ){
          this._delayedHide();	
          }
        }, this));

        this.toggle = 0;
        this.parent.$el.on('touchend', $.proxy(function () {
          if (this.config.debug === true) {
            console.log('Preview : touchend item');
          }

          if (!this.$el.is(":visible")) {
            this.toggle = 0;
          }

          if (this.toggle === 0) {
            this.show();
          } else if (this.toggle === 1) {
            this._delayedHide();
          }
        }, this));

        this.parent.$el.off('mouseleave').on('mouseleave', $.proxy(function () {
          if (this.config.debug === true) {
            console.log('Preview : Mouseleave item');
          }
          this._delayedHide();
        }, this));

        $pop.off('mouseenter').on('mouseenter', $.proxy(function () {
          if (this.config.debug === true) {
            console.log('Preview : Mouseenter binf-popover');
          }
          this.show();
        }, this));

        $pop.off('keydown').on('keydown', $.proxy(function (event) {
          if(event.keyCode === 27){this._delayedHide();}
                  }, this));

        $pop.off('mouseleave').on('mouseleave', $.proxy(function () {
          if (this.config.debug === true) {
            console.log('Preview : Mouseleave binf-popover');
          }
          this._delayedHide();
        }, this));

        this.propagateEventsToRegions();
        this.listenTo(this, 'dom:refresh', function () {
          this.options.parent.$el.binf_popover('show');
        });
      }
    },

    template: template,

    regions: {
      contentRegion: '.xecmpf-preview-body',
      footerRegion: '.xecmpf-preview-footer'
    },

    templateHelpers: function () {
      return {
        title: this.headerTitle,
        info: this.footerInfoText
      };
    },


    onBeforeDestroy: function (e) {
      if (this.config) {
        this.parent.$el.binf_popover('destroy');
      }
    },

    show: function () {
      if (this.config) {
        var that = this;

        if (this.config.debug === true) {
          console.log('Preview : Preparing show');
        }

        // clear hide timeout if there is one
        if (this.hideTimeout) {
          clearTimeout(this.hideTimeout);
          if (this.config.debug === true) {
            console.log('Preview : Cleared hide timeout');
          }
          this.hideTimeout = null;
        }

        // nothing to do if already visible
        if (this.$el.is(":visible")) {
          if (this.config.debug === true) {
            console.log('Preview : Already visible');
          }
          return;
        }

        this.showCancelled = false;

        this.$el.hide();
        this.render();

        if (this.docsListView) {
          this.docsListView.destroy()
        }

        this.docsListView = new PreviewListView({
          collection: this.docsCollection,
          enableIcon: this.options.enableIcon,
          enableDescription: this.options.enableDescription,
          // for hiding in preview pane list keyboard behaviour
          previewPane: this,
          // for logging in preview pane list keyboard behaviour
          config: this.config
        });

        this.listenTo(this.docsListView, 'before:DefaultAction', function (args) {
          args.cancelDefaultAction = this.options.cancelDefaultAction
        });

        if (!this.showCancelled) {
          // in case of keyboard navigation this
          // closes every second time the popup
          // mouse hover is nevetheless working fine
          // therefore commented out
          // close all other preview popovers
          // $(".xecmpf-previewpane-popover").each(function (i, el) {
          //   var popoverId = $(el).attr('id');
          //   $("[aria-describedby^='" + popoverId + "']").binf_popover('hide');
          // });

          if (this.config.debug === true) {
            console.log('Preview : Showing');
          }

          // prepare and show binf-popover for this item
          this.contentRegion.show(this.docsListView, {
            render: true
          });
          this.$el.show();
          this.triggerMethod('before:show', this);
          this.toggle = 1;
          this.options.parent.$el.binf_popover('show');
          this.triggerMethod('show', this);

          // adding the popover id to the actual buttons to support screen reader
          var popoverId = this.parent.$el.data('binf.popover') && this.parent.$el.data('binf.popover').tip().attr('id');
          this.parent.$el.find('button').attr('aria-describedby', popoverId );

          if (this.config.debug === true) {
            console.log("Viewport height: " + $(window).height());
            console.log("document height: " + $(document).height());
            console.log("body     height: " + $('body').height());
            console.log("binf-popover  height: " + this.$el.height());
            console.log("list     height: " +
                        this.$el.find('.xecmpf-preview-body').height());
          }
        } else if (this.config.debug === true) {
          console.log('Preview : Show was cancelled');
        }
      }
    },

    hide: function () {
      if (this.config.debug === true) {
        console.log('Preview : Going to hide');
      }

      if (this.config && !this.config.debugNoHide) {
        if (this.config.debug === true) {
          console.log('Preview : Hidden');
        }
        this.toggle = 0;
        this.options.parent.$el.binf_popover('hide');
        this.hideTimeout = null;
      } else {
        if (this.config.debug === true) {
          console.log('Preview : Leaving visible');
        }
      }

      this.showCancelled = true;
      this.hideTimeout = null;
      this.parent.$el.find('button').removeAttr('aria-describedby');
    },

    _delayedHide: function () {
      if (this.config.debug === true) {
        console.log('Preview : Setting hide timeout');
      }
      this.hideTimeout = window.setTimeout($.proxy(this.hide, this), 200);
    },

    onShow: function () {
      /**
       * to make the PerfectScrollingBehavior works for the simplelist.view,
       * the height needs to be set
       */
      this.$('.cs-simplelist.binf-panel').css('height',
          this.$('.binf-panel-body.xecmpf-preview-body').height());

      if (!this.footerInfoText) {
        $(this.regions.footerRegion).hide()
      }
    }
  });

  _.extend(PreviewPaneView.prototype, LayoutViewEventsPropagationMixin);

  return PreviewPaneView;
});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/header/impl/completenesscheck/impl/completenesscheckitem',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "  <span class=\"csui-icon "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"icon") || (depth0 != null ? lookupProperty(depth0,"icon") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"icon","hash":{},"loc":{"start":{"line":2,"column":25},"end":{"line":2,"column":33}}}) : helper)))
    + "\"></span>\r\n  <button class=\"count binf-btn binf-btn-default xecmpf-docscount-without-text\" data-binf-toggle=\"popover\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"docsCountWithText") || (depth0 != null ? lookupProperty(depth0,"docsCountWithText") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"docsCountWithText","hash":{},"loc":{"start":{"line":3,"column":119},"end":{"line":3,"column":140}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"docsCount") || (depth0 != null ? lookupProperty(depth0,"docsCount") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"docsCount","hash":{},"loc":{"start":{"line":3,"column":142},"end":{"line":3,"column":155}}}) : helper)))
    + "</button>\r\n  <button class=\"count binf-btn binf-btn-default xecmpf-docscount-with-text\" data-binf-toggle=\"popover\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"docsCountWithText") || (depth0 != null ? lookupProperty(depth0,"docsCountWithText") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"docsCountWithText","hash":{},"loc":{"start":{"line":4,"column":116},"end":{"line":4,"column":137}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"docsCountWithText") || (depth0 != null ? lookupProperty(depth0,"docsCountWithText") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"docsCountWithText","hash":{},"loc":{"start":{"line":4,"column":139},"end":{"line":4,"column":160}}}) : helper)))
    + "</button>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"docsCount") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"loc":{"start":{"line":1,"column":0},"end":{"line":5,"column":7}}})) != null ? stack1 : "");
}});
Handlebars.registerPartial('xecmpf_widgets_header_impl_completenesscheck_impl_completenesscheckitem', t);
return t;
});
/* END_TEMPLATE */
;

/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/header/impl/completenesscheck/impl/completenesscheck',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return "  <div class=\"missing-docs-check\"></div>\r\n  <div class=\"outdated-docs-check\"></div>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"hideMissingDocsCheck") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"loc":{"start":{"line":1,"column":0},"end":{"line":4,"column":11}}})) != null ? stack1 : "");
}});
Handlebars.registerPartial('xecmpf_widgets_header_impl_completenesscheck_impl_completenesscheck', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/widgets/header/impl/completenesscheck/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});


csui.define('xecmpf/widgets/header/impl/completenesscheck/impl/nls/root/lang',{
  missingDocsTitle: "Missing documents",
  dialogTitle: "Reports",
  recentReportName: "Last 10 added documents",
  addedReportName: "Documents you added",
  missingReportName: "{0} missing",
  emptyMessage: "No documents to display",
  outdatedDocsTitle: "Outdated documents",
  outdatedReportName: "{0} outdated"
});



csui.define('css!xecmpf/widgets/header/impl/completenesscheck/impl/completenesscheck',[],function(){});
csui.define('xecmpf/widgets/header/impl/completenesscheck/completenesscheck.view',[
    'csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/backbone', 'csui/lib/marionette',
    'conws/models/workspacecontext/workspacecontext.factory',
    'xecmpf/widgets/header/impl/completenesscheck/impl/missingdocuments.factory',
    'xecmpf/widgets/header/impl/completenesscheck/impl/outdatedocuments.factory',
    //Load and register external views document items.
    'csui-ext!xecmpf/widgets/header/completenesscheck/completenesscheck.factory',
    'xecmpf/widgets/header/impl/previewpane/previewpane.view',
    'hbs!xecmpf/widgets/header/impl/completenesscheck/impl/completenesscheckitem',
    'hbs!xecmpf/widgets/header/impl/completenesscheck/impl/completenesscheck',
    'i18n!xecmpf/widgets/header/impl/completenesscheck/impl/nls/lang',
    'css!xecmpf/widgets/header/impl/completenesscheck/impl/completenesscheck'
], function (_, $, Backbone, Marionette, WorkspaceContextFactory,
    MissingDocumentsFactory, OutdatedDocuments, extraItems,
    PreviewPaneView, itemTemplate, layoutTemplate, lang) {

        var INPROCESS_DOCUMENT_FACTORY = "selfserviceQueuedCollection";

        var DocsCheckItemView = Marionette.ItemView.extend({

            className: 'docs-check-list-item',

            constructor: function DocsCheckItemView(options) {
                options || (options = {});
                Marionette.ItemView.prototype.constructor.apply(this, arguments);

                this.listenTo(this.options.collection, 'change', this.render);

                if (this.options && this.options.preview) {
                    this.previewPane = new PreviewPaneView({
                        parent: this,
                        context: this.options.workspaceContext,
                        config: this.options.preview,
                        collection: this.options.collection,
                        headerTitle: this.options.title,
                        enableIcon: this.options.enableIcon,
                        headerColor: options.headerColor,
                        enableDescription: options.enableDescription,
                        info: this.options.info,
                        cancelDefaultAction: this.options.cancelDefaultAction,
                        customPopoverClass: this.options.customPopoverClass
                    });
                }
            },

            template: itemTemplate,

            templateHelpers: function () {
                return {
                    icon: this.options.icon,
                    docsCount: this.options.collection.length,
                    docsCountWithText: _.str.sformat(this.options.label, this.options.collection.length)
                }
            },

            onBeforeDestroy: function () {
                if (this.previewPane) {
                    this.previewPane.destroy();
                    delete this.previewPane;
                }
            }
        });

        var CompletenessCheckView = Marionette.LayoutView.extend({

            className: 'xecmpf-completenesscheck',

            constructor: function CompletenessCheckView(options) {
                options || (options = {});
                Marionette.LayoutView.prototype.constructor.apply(this, arguments);

                if (!options.workspaceContext) {
                    options.workspaceContext = options.context.getObject(WorkspaceContextFactory);
                }
                options.workspaceContext.setWorkspaceSpecific(MissingDocumentsFactory);

                this.missingDocsCollection = !options.hideMissingDocsCheck ?
                    options.workspaceContext.getCollection(MissingDocumentsFactory) :
                    undefined;

                options.workspaceContext.setWorkspaceSpecific(OutdatedDocuments);

                this.outdatedDocsCollection = !options.hideOutdatedDocsCheck ?
                    options.workspaceContext.getCollection(OutdatedDocuments) :
                    undefined;


            },

            template: layoutTemplate,

            templateHelpers: function () {
                return {
                    hideMissingDocsCheck: this.options.hideMissingDocsCheck
                }
            },

            onRender: function () {
                this.showCompletenessCheck({
                    collection: this.missingDocsCollection,
                    title: lang.missingDocsTitle,
                    label: lang.missingReportName,
                    icon: 'missing-icon',
                    index: 0,
                    enableIcon: false,
                    region: this.missingDocsRegion,
                    enableDescription: false,
                    cancelDefaultAction: true,
                    customPopoverClass: 'xecmpf-missing-docs-check'
                });

                this.showCompletenessCheck({
                    collection: this.outdatedDocsCollection,
                    title: lang.outdatedDocsTitle,
                    label: lang.outdatedReportName,
                    icon: 'outdated-icon',
                    index: 1,
                    enableIcon: false,
                    region: this.outdatedDocsRegion,
                    enableDescription: false,
                    cancelDefaultAction: true,
                    customPopoverClass: 'xecmpf-outdated-docs-check'
                });
                
                //Getting the external items
                this.showExternalViews(this.options);
            },

            regions: {
                missingDocsRegion: '.missing-docs-check',
                outdatedDocsRegion: '.outdated-docs-check'
            },

            showCompletenessCheck: function (options) {
                if (options.collection) {
                    if (options.collection.fetched === true && options.collection.length > 0) {
                        this._showCompletenessCheck(options);
                        this._completenessCheckAvailable();
                    }
                    this.listenToOnce(options.collection, 'sync', function () {
                        if (options.collection.length > 0) {
                            options.collection.fetched = true;
							
							// Read the options once the collection is synced. This helps to set the icon, label, title and popover class dynamically using the response from server.
                            options.title = (options.collection.options && options.collection.options.name) ?
											options.collection.options.name : options.title;
                            options.label = (options.collection.options && options.collection.options.label) ?
											options.collection.options.label : options.label;
                            options.icon = (options.collection.options && options.collection.options.iconClass) ?
											options.collection.options.iconClass : options.icon;
                            options.customPopoverClass = (options.collection.options &&
														 options.collection.options.customPopoverClass ) ?
														options.collection.options.customPopoverClass :
														options.customPopoverClass;
														 
                            this._showCompletenessCheck(options);
                            this._completenessCheckAvailable();
                        }
                    });
                }
            },

            _completenessCheckAvailable: function () {
                this.trigger('completeness:check:available');
                if (this.options.originatingView) {
                    this.options.originatingView.trigger('completeness:check:available');
                }
            },

            _showCompletenessCheck: function (options) {
                this.showRegion = true;
                if (!options.region) {
                    var regionClass0 = this.regionManager.completenesscheck_view0;
                    var regionClass1 = this.regionManager.completenesscheck_view1;
                    if ((regionClass0 && options.index === 0) || (regionClass1 && options.index === 1)) {
                        this.showRegion = false;
                    } else {
                        var newRegion = 'completenesscheck_view' + options.index;
                        this.addRegion(newRegion);
                        options.region = this.regionManager[newRegion]
                    }
                }
                if (this.showRegion) {
                    options.region.show(new DocsCheckItemView({
                        workspaceContext: this.options.workspaceContext,
                        collection: options.collection,
                        preview: { debug: false },
                        title: options.title,
                        label: options.label,
                        icon: options.icon,
                        headerColor: options.headerColor,
                        enableIcon: options.enableIcon,
                        enableDescription: options.enableDescription,
                        cancelDefaultAction: options.cancelDefaultAction,
                        customPopoverClass: options.customPopoverClass
                    }));
                }
            },
            showExternalViews: function (options) {
                if (extraItems && extraItems.length > 0) {
                    var collection,
                        that = this;
                    _.each(extraItems, function (item, index) {
                        if (options.hideInProcessDocsCheck &&
                            item.prototype.propertyPrefix === INPROCESS_DOCUMENT_FACTORY) { return; }
                        if (!options.workspaceContext) {
                            options.workspaceContext = options.context.getObject(WorkspaceContextFactory);
                        }
                        options.workspaceContext.setWorkspaceSpecific(item);
                        collection = options.workspaceContext.getCollection(item);
                        that.showCompletenessCheck({
                            collection: collection,
                            title: collection.options.name,
                            label: collection.options.label ? collection.options.label : collection.options.name,
                            icon: collection.options.iconClass,
                            headerColor: collection.options.headerColor,
                            enableIcon: collection.options.enableIcon,
                            enableDescription: collection.options.enableDescription,
                            index: index,
                            cancelDefaultAction: collection.options.cancelDefaultAction,
                            customPopoverClass: collection.options.customPopoverClass
                        });

                    });
                }
            },
            addRegion: function (regionName) {
                if (!this.regionManager) {
                    this.regionManager = {};
                }
                var that = this;
                var $el = $(this.el);
                $el.append($('<div></div>').attr({ class: regionName }));
                // Manipulate the template - add the new region to the end.
                /* For SAPSSF-4393 - JQuery Migrate - selector property removed in jQuery 3.0. Earlier jQuery object used to have selector property but in jQuery 3.0 that property has been removed and that was causing an exception in the buildRegion method. Hence making syntactic changes to send the el option */
                var temRegion = Marionette.Region.buildRegion({ el: $el.find('.' + regionName) }, Marionette.Region);
                temRegion.getEl = function (selector) {
                    return that.$(selector);
                };
                this.regionManager[regionName] = temRegion;
            }
        });
        return CompletenessCheckView;
    });

/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/header/impl/displayUrl/impl/displayUrlItem',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "  <a class=\"xecmpf-displayUrl-icon conws-quick_link "
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"displayUrlError") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"loc":{"start":{"line":2,"column":52},"end":{"line":3,"column":35}}})) != null ? stack1 : "")
    + "\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"displayUrlTooltip") || (depth0 != null ? lookupProperty(depth0,"displayUrlTooltip") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"displayUrlTooltip","hash":{},"loc":{"start":{"line":3,"column":44},"end":{"line":3,"column":65}}}) : helper)))
    + "\"\r\n     aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"ariaLabelBusApplText") || (depth0 != null ? lookupProperty(depth0,"ariaLabelBusApplText") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"ariaLabelBusApplText","hash":{},"loc":{"start":{"line":4,"column":17},"end":{"line":4,"column":41}}}) : helper)))
    + "\" "
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"displayUrlError") : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.program(6, data, 0),"loc":{"start":{"line":4,"column":43},"end":{"line":5,"column":49}}})) != null ? stack1 : "")
    + "></a>\r\n";
},"2":function(container,depth0,helpers,partials,data) {
    return "\r\n    xecmpf-displayUrl-error ";
},"4":function(container,depth0,helpers,partials,data) {
    return "  href=\"#\"  ";
},"6":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "\r\n     href=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"displayUrl") || (depth0 != null ? lookupProperty(depth0,"displayUrl") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"displayUrl","hash":{},"loc":{"start":{"line":5,"column":11},"end":{"line":5,"column":25}}}) : helper)))
    + "\" target=\"_blank\"";
},"8":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "  <button class=\"xecmpf-displayUrl-icon conws-quick_link binf-btn binf-btn-default\"\r\n          aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"ariaLabelBusApplText") || (depth0 != null ? lookupProperty(depth0,"ariaLabelBusApplText") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"ariaLabelBusApplText","hash":{},"loc":{"start":{"line":8,"column":22},"end":{"line":8,"column":46}}}) : helper)))
    + "\"></button>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"displayUrl") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(8, data, 0),"loc":{"start":{"line":1,"column":0},"end":{"line":9,"column":7}}})) != null ? stack1 : "");
}});
Handlebars.registerPartial('xecmpf_widgets_header_impl_displayUrl_impl_displayUrlItem', t);
return t;
});
/* END_TEMPLATE */
;

/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/header/impl/displayUrl/impl/displayUrl',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return "  <div id=\"displayUrl-check\"></div>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"bDisplayUrl") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"loc":{"start":{"line":1,"column":0},"end":{"line":3,"column":7}}})) != null ? stack1 : "");
}});
Handlebars.registerPartial('xecmpf_widgets_header_impl_displayUrl_impl_displayUrl', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/widgets/header/impl/displayUrl/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});


csui.define('xecmpf/widgets/header/impl/displayUrl/impl/nls/root/lang',{
  displayUrlTooltip: "Business application",
  displayUrlTitle: "Business applications",
  ariaLabelBusApplText: "Go to business application"
});



csui.define('css!xecmpf/widgets/header/impl/displayUrl/impl/displayUrl',[],function(){});
csui.define('xecmpf/widgets/header/impl/displayUrl/displayUrl.view',[
  'csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/backbone', 'csui/lib/marionette',
  'csui/dialogs/modal.alert/modal.alert',
  'xecmpf/widgets/header/impl/previewpane/previewpane.view',
  'hbs!xecmpf/widgets/header/impl/displayUrl/impl/displayUrlItem',
  'hbs!xecmpf/widgets/header/impl/displayUrl/impl/displayUrl',
  'i18n!xecmpf/widgets/header/impl/displayUrl/impl/nls/lang',
  'css!xecmpf/widgets/header/impl/displayUrl/impl/displayUrl'
], function (_, $, Backbone, Marionette, ModalAlert, PreviewPaneView, itemTemplate,
    layoutTemplate, lang) {

  var DisplayUrlItemView = Marionette.ItemView.extend({

    className: 'xecmpf-displayUrl-item',

    constructor: function DisplayUrlItemView(options) {
      options || (options = {});
      this.options = options;
      Marionette.ItemView.prototype.constructor.apply(this, arguments);
      this.listenTo(this.options.collection, 'change', this.render);

      if (this.options && this.options.preview &&
          // only in case of more than 1 display url:
          options.collection.length > 1
      ) {
        this.previewPane = new PreviewPaneView({
          parent: this,
          config: {debug: true},
          collection: options.collection,
          headerTitle: lang.displayUrlTitle,
          headerColor: options.headerColor
        });
      }
    },

    events: {
      "click .xecmpf-displayUrl-error": 'showError'
    },

    template: itemTemplate,

    templateHelpers: function () {
      // displayUrl: the display Url if bus. wksp. is assigned to exactly 1 bus. appl.
      var displayUrl = (this.options.collection.length === 1) ?
                       this.options.collection.models[0].get('displayUrl') : false;

      var displayUrlError = (this.options.collection.length === 1) ?
                            this.options.collection.models[0].get('displayUrlError') : "";

      // in case wksp. is assigned to exactly 1 bus. appl.:
      // aria label: lang.ariaLabelBusApplText + external system name
      // in case wksp. is assigned to several bus. appls.:
      // aria label: lang.ariaLabelBusApplText
      var ariaLabelBusApplText = lang.ariaLabelBusApplText + (displayUrl ?
                                 ' ' +
                                 this.options.collection.models[0].get('external_system_name') :
                                                              '');

      // Tooltip only useful exactly 1 bus. appl.
      var displayUrlTooltip = displayUrl ? lang.displayUrlTooltip : '';

      return {
        ariaLabelBusApplText: ariaLabelBusApplText,
        displayUrlTooltip: displayUrlTooltip,
        displayUrl: displayUrl,
        displayUrlError: displayUrlError
      }
    },

    onBeforeDestroy: function () {
      if (this.previewPane) {
        this.previewPane.destroy();
        delete this.previewPane;
      }
    },

    showError: function () {
      ModalAlert.showError(this.options.collection.models[0].get('displayUrlError'));
    }

  });

  var DisplayUrlView = Marionette.LayoutView.extend({

    className: 'xecmpf-displayUrlcheck',

    constructor: function DisplayUrlView(options) {
      options || (options = {});
      this.model = options.model;
      this.options.headerColor = 'xecmpf-displayUrl-header-background';
      Marionette.LayoutView.prototype.constructor.apply(this, arguments);
    },

    template: layoutTemplate,

    templateHelpers: function () {
      // bDisplayUrl: whether the link should be displayed at all:
      var bDisplayUrl = (this.model.display_urls && (this.model.display_urls.length > 0)) ?
                        true : false;
      return {
        bDisplayUrl: bDisplayUrl
      }
    },

    regions: {
      displayUrlRegion: '#displayUrl-check'
    },

    onRender: function () {
      var collection;
      if (this.model.display_urls && this.model.display_urls.length >= 1) {
        var displayUrlArray = _.map(this.model.display_urls, function (item) {
          var name = item.business_object_type_name + ' (' + item.external_system_name +
                     ')';
          return {
            name: name,
            displayUrl: item.displayUrl,
            external_system_name: item.external_system_name,
            displayUrlError: item.errMsg
          }
        });
        collection = new Backbone.Collection();
        collection.add(displayUrlArray);

        this.displayUrlRegion.show(new DisplayUrlItemView({
          collection: collection,
          preview: {debug: true},
          headerColor: this.options.headerColor
        }));
      }
    }
  });

  return DisplayUrlView;

});

// Lists explicit locale mappings and fallbacks

csui.define('xecmpf/widgets/header/impl/nls/header.lang',{
    // Always load the root bundle for the default locale (en-us)
    "root": true,
    // Do not load English locale bundle provided by the root bundle
    "en-us": false,
    "en": false
  });
// Defines localizable strings in the default language (English)

csui.define('xecmpf/widgets/header/impl/nls/root/header.lang',{
    noMetadataMessage: 'No data to display.',
    CollapsePageOverlay: "Close"
  });

csui.define('xecmpf/widgets/header/impl/metadata.view',[
  'csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/marionette',
  'csui/lib/handlebars',
  'csui/controls/list/emptylist.view',
  'conws/models/workspacecontext/workspacecontext.factory',
  'conws/models/selectedmetadataform/selectedmetadataform.factory',
  'conws/controls/selectedmetadataform/selectedmetadataform.view',
  'i18n!xecmpf/widgets/header/impl/nls/header.lang'
], function (_, $, Marionette, Handlebars,
    EmptyListView, WorkspaceContextFactory, SelectedMetadataFormFactory, SelectedMetadataFormView, lang) {

  var MetadataView = Marionette.ItemView.extend({
    className: 'xecmpf-form-metadata',

    attributes: {
      style: 'height: 100%'
    },

    template: false,

    constructor: function MetadataView(options) {
      options || (options = {});
      if (!options.context) {
        throw new Error('Context is missing in the constructor options');
      }

      // get workspace context
      if (!options.workspaceContext) {
        options.workspaceContext = options.context.getObject(WorkspaceContextFactory);
      }
      options.workspaceContext.setWorkspaceSpecific(SelectedMetadataFormFactory);

      // get model collection from the model factory
      options.model = options.workspaceContext.getObject(SelectedMetadataFormFactory, {
        metadataConfig: options.data,
        unique: true
      });

      this.noMetadataMessage = lang.noMetadataMessage;

      Marionette.ItemView.prototype.constructor.call(this, options);

      this.listenTo(options.model, 'change', this.render);
    },


    onRender: function () {
      this.formRegion = new Marionette.Region({el: this.$el});
      if (!_.isEmpty(this.model.attributes.data)) {
        this.$el.addClass('csui-normal-scrolling');
        this.$el.addClass('csui-no-scroll-x');
        // Code to remove the null values in the data
        this.noDataFound = false;
        var metadata = this.model.attributes.data;
        var colOptions = this.options.data.colOptions;
        var fields = this.model.attributes.options.fields;
        _.each(_.keys(metadata), function (key) {
          if (metadata[key] === "null") {
            metadata = _.omit(metadata, key);
            fields[key].hidden = true;
          }
        });
        this.model.attributes.data = metadata;
        this.model.attributes.options.fields = fields;

        // XECMPF-422
        if(colOptions === "doubleCol") {
          var count = _.size(_.filter(_.keys(fields), function(key){
            return fields[key].hidden !== undefined && fields[key].hidden === false;
          }));
          colOptions = count > 5 ? "doubleCol" : "singleCol";
        }

        this.formView = new SelectedMetadataFormView({
          model: this.model,
          context: this.options.context,
          layoutMode: !!colOptions && colOptions === 'singleCol' ? colOptions : 'doubleCol',
          breakFieldsAt: 5
        });
        this.formRegion.show(this.formView);
        this.triggerMethod("xecmpf:metadata:config");
      } else {
        this.noDataFound = true;
        this.formView = new EmptyListView({text: this.noMetadataMessage});
        this.formRegion.show(this.formView);
        this.triggerMethod("xecmpf:metadata:config");
      }
      this.listenTo(this.formView, 'render:form', function () {
        this.triggerMethod("dom:refresh");
      });
    }
  });

  return MetadataView;
});


csui.define('css!xecmpf/widgets/header/impl/header',[],function(){});
// Workspace Header View
csui.define('xecmpf/widgets/header/header.view',['module',
  'csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/marionette',
  'csui/lib/handlebars',
  'conws/widgets/header/header.view',
  'conws/models/selectedmetadataform/selectedmetadataform.factory',
  'xecmpf/widgets/header/impl/completenesscheck/completenesscheck.view',
  'xecmpf/widgets/header/impl/displayUrl/displayUrl.view',
  'esoc/widgets/activityfeedwidget/activityfeedfactory',
  'esoc/widgets/activityfeedwidget/activityfeedcontent',
  'xecmpf/widgets/header/impl/metadata.view',
  'conws/controls/description/description.view',
  'css!xecmpf/widgets/header/impl/header'
], function (module, _, $, Marionette, Handlebars,
    ConwsHeaderView, MetadataFactory,
    CompletenessCheckView, DisplayUrlView,
    ActivityFeedFactory, ActivityFeedContent,
    MetadataView, DescriptionView) {

  // activity feed widget
  var constants = {'activityfeedwidget': 'esoc/widgets/activityfeedwidget'};
  var moduleConfig = module.config();
  var HeaderView = ConwsHeaderView.extend({

    id: 'xecmpf-header',

    constructor: function HeaderView(options) {
      options || (options = {});
      options.data || (options.data = {});
      options.data.widget || (options.data.widget = {});
      options.data.widget.type || (options.data.widget.type = 'metadata');
      options.hideToolbar = !!moduleConfig.hideToolbar;
      options.hideActivityFeed = !!moduleConfig.hideActivityFeed;
      options.hideMetadata = !!moduleConfig.hideMetadata || !(options.data.metadataSettings &&
                                                              options.data.metadataSettings.metadata &&
                                                              !options.data.metadataSettings.hideMetadata);
      options.toolbarBlacklist = [];
      options.extensionToolbarBlacklist = [];
      options.delayedToolbarBlacklist = [];
      options.extensionToolbarDelayedActionsBlacklist = [];
      options.enableCollapse = !!moduleConfig.enableCollapse;

      var toolbarBlacklist = moduleConfig.toolbarBlacklist;
      if (Array.isArray(toolbarBlacklist) && toolbarBlacklist.length > 0) {
        options.toolbarBlacklist = toolbarBlacklist;
      }
      var delayedToolbarBlacklist = moduleConfig.delayedToolbarBlacklist;
      if (Array.isArray(delayedToolbarBlacklist) && delayedToolbarBlacklist.length > 0) {
        options.delayedToolbarBlacklist = delayedToolbarBlacklist;
      }
      var extensionToolbarBlacklist = moduleConfig.extensionToolbarBlacklist;
      if (Array.isArray(extensionToolbarBlacklist) && extensionToolbarBlacklist.length > 0) {
        options.extensionToolbarBlacklist = extensionToolbarBlacklist;
      }

      var extensionToolbarDelayedActionsBlacklist = moduleConfig.extensionToolbarDelayedActionsBlacklist;
      if (Array.isArray(extensionToolbarDelayedActionsBlacklist) &&
          extensionToolbarDelayedActionsBlacklist.length > 0) {
        options.extensionToolbarDelayedActionsBlacklist = extensionToolbarDelayedActionsBlacklist;
      }

      if (options.data && options.data.favoriteSettings &&
          options.data.favoriteSettings.hideFavorite) {
        if (!options.toolbarBlacklist['Favorite2']) {
          options.toolbarBlacklist.push('Favorite2');
        }
        if (!options.extensionToolbarBlacklist['Favorite2']) {
          options.extensionToolbarBlacklist.push('Favorite2');
        }
      }

      if (!options.extensionToolbarBlacklist['CompletenessCheck']) {
        options.extensionToolbarBlacklist.push('CompletenessCheck');
      }
      var cCConfig      = options.data.completenessCheckSettings,
          cCViewOptions = {
            context: options.context,
            workspaceContext: options.workspaceContext,
            hideMissingDocsCheck: cCConfig && cCConfig.hideMissingDocsCheck,
            hideOutdatedDocsCheck: cCConfig && cCConfig.hideOutdatedDocsCheck,
            hideInProcessDocsCheck: cCConfig && cCConfig.hideInProcessDocsCheck
          };

      options.cCViewOptions = cCViewOptions;
      options.statusIndicatorsView = CompletenessCheckView;
      options.statusIndicatorsViewOptions = _.extend(cCViewOptions, {originatingView: this});

      ConwsHeaderView.prototype.constructor.call(this, options);
      if (options.workspaceContext) {
        options.workspaceContext.setWorkspaceSpecific(MetadataFactory);
        options.workspaceContext.setWorkspaceSpecific(ActivityFeedFactory);
      }
    },

    initialize: function (options) {
      options || (options = {});
      if (options.data) {

        var headerwidgetConfigValue = options.data.headerwidget ? (options.data.headerwidget.type ?
                                                                   options.data.headerwidget.type :
                                                                   "metadata" ) : "metadata";
        this.headerwidgetConfigValue = headerwidgetConfigValue;

        if (headerwidgetConfigValue === 'metadata'
            && (options.data.widget.type === 'metadata') && !this.options.hideMetadata) {
          var mConfig = options.data.metadataSettings;
          var metadata = this._makeMetadataReadOnly(mConfig.metadata);
          var mViewOptions = {
            context: options.context,
            workspaceContext: options.workspaceContext,
            data: {
              hideEmptyFields: mConfig.hideEmptyFields,
              metadata: metadata,
              readonly: true,
              colOptions: options.data.metadataSettings.metadataInColumns
            }
          };
          this.metadataView = new MetadataView(mViewOptions);
          this.listenTo(this.metadataView, 'xecmpf:metadata:config', function () {
            if (this.metadataView.noDataFound) {
              this.$el.parent().addClass('xecmpf-metadata-configured-nodata').removeClass(
                  'xecmpf-metadata-configured');
            } else {
              this.$el.parent().addClass('xecmpf-metadata-configured').removeClass(
                  'xecmpf-metadata-configured-nodata');
            }
          });
        }
        if (this.headerwidgetConfigValue === 'activityfeed' && !this.options.hideActivityFeed) {
          options.data.widget.type = constants.activityfeedwidget;
          options.data.widget.options || (options.data.widget.options = {});
        }

        if (!moduleConfig.pageWidget) {
          var cCViewOptions = _.extend(options.cCViewOptions,
              {workspaceContext: options.workspaceContext});
          if (!cCViewOptions.hideMissingDocsCheck || !cCViewOptions.hideOutdatedDocsCheck ||
              !cCViewOptions.hideInProcessDocsCheck) {
            this.options.hasMetadataExtension = true;
            this.completenessCheckView = new CompletenessCheckView(cCViewOptions);
          }
        }

        var displayUrlViewOptions = {
          model: this.model,
          logging: {debug: false}
        };
        this.displayUrlView = new DisplayUrlView(displayUrlViewOptions);

        this.listenTo(this.completenessCheckView, 'completeness:check:available', function () {
          this.$el.parent().addClass('xecmpf-completenesscheck-available');
          options.expandDescription = false;
          if (!this.options.hideDescription && !this.hasEmptyDescription()) {
            var data = {
              view: this,
              complete_desc: this.resolveProperty('description'),
              expandDescription: options.expandDescription
            };
            this.descriptionView = new DescriptionView(data);
            this.descriptionRegion.show(this.descriptionView);
            this.$el.parent().addClass('conws-description-available');
            this.listenToDescriptionView();
          }
        });

       this.listenTo(this, 'render', function () {
          if (this.model.fetched) {
            this.showChildViews();
          }
        });
      }
    },

    ui: function () {
      return _.extend({
        completenessCheckRegion: '.conws-header-metadata-extension',
        metadataRegion: '#conws-header-childview',
        displayUrlRegion: '.conws-header-child-displayUrl'
      }, ConwsHeaderView.prototype.ui);
    },

    _makeMetadataReadOnly: function (arr) {
      var metadata = arr || [];
      metadata.forEach(function (obj) {
        obj['readOnly'] = true;
      });
      return metadata;
    },

    showChildViews: function () {
      if (this.completenessCheckView) {
        this.completenessCheckRegion = new Marionette.Region({el: this.ui.completenessCheckRegion});
        this.completenessCheckRegion.show(this.completenessCheckView);
        this.listenToDescriptionView();
      }
      if (this.metadataView) {
        this.metadataRegion = new Marionette.Region({el: this.ui.metadataRegion});
        this.metadataRegion.show(this.metadataView);
      }
      if (this.displayUrlView) {
        this.displayUrlRegion = new Marionette.Region({el: this.ui.displayUrlRegion});
        this.displayUrlRegion.show(this.displayUrlView);
      }
      this.listenTo(this, 'completeness:check:available', function () {
        // since status indicator is having an indirect dependency with completeness check via header, 
        // instead of dependending on just the events, maintain the value within the instance variable 
        // so that it can be used incase required..mostly when the reinitialize is called for all regions.
        this.headerToolbarView.triggerMethod("status:indicator:available");
      });
    },

    listenToDescriptionView: function () {
      if (this.descriptionView) {
        this.listenTo(this.descriptionView, "show:more:description", function () {
          this.toggleCompletenessCheckView(false);
        });
        this.listenTo(this.descriptionView, "show:less:description", function () {
          this.toggleCompletenessCheckView(true);
        });
      }
    },

    toggleCompletenessCheckView: function (toggle) {
      if (toggle) {
        this.completenessCheckView.$el.removeClass("xecmpf-completenesscheck-hidden").addClass(
            "xecmpf-completenesscheck-shown");
      } else {
        this.completenessCheckView.$el.removeClass("xecmpf-completenesscheck-shown").addClass(
            "xecmpf-completenesscheck-hidden");
      }
    },

    hasChildView: function () {
      var isChildWidgetConfigured = (this.options.data && this.options.data.widget &&
                                     this.options.data.widget.type &&
                                     this.options.data.widget.type !== "none");
      if (this.headerwidgetConfigValue === 'activityfeed') {
        return !this.options.hideActivityFeed && isChildWidgetConfigured;
      } else if (this.headerwidgetConfigValue === 'metadata') {
        return !this.options.hideMetadata && isChildWidgetConfigured;
      }
    },

    onDomRefresh: function () {
      this.addActivityFeedClass();
      if (this.completenessCheckView) {
        this.toggleCompletenessCheckView(true);
      }

      if (!!this.descriptionView &&
          this.descriptionView.$el.find(this.descriptionView.ui.readMore).is(':hidden') &&
          this.descriptionView.$el.find(this.descriptionView.ui.showLess).is(':visible')) {
        this.descriptionView.ui.showLess.trigger("click");
        this.currentlyFocusedElement().trigger('focus');
      }

      this.isTabable() ? this.currentlyFocusedElement().attr("tabindex", "0") :
      this.currentlyFocusedElement().attr("tabindex", "-1");

      // line clamping
      this._clampTexts();

      if (!this.options.hideToolbar) {
        this.headerToolbarView.triggerMethod('dom:refresh');
      }

    },

    onBeforeDestroy: function () {
      if (this.metadataView) {
        this.metadataView.destroy();
      }
      if (this.displayUrlView) {
        this.displayUrlView.destroy();
      }
    }
  });

  return HeaderView;
});
csui.define('xecmpf/widgets/scan/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});

csui.define('xecmpf/widgets/scan/impl/nls/root/lang',{
  title: 'Scan barcode',
  defaultTextForDesktop:'Only dispayed on mobile devices.'
});



csui.define('css!xecmpf/widgets/scan/impl/scan',[],function(){});
csui.define('xecmpf/widgets/scan/scan.content.view',['csui/lib/underscore',
"csui/controls/list/simplelist.view",
  "csui/controls/listitem/listitemstandard.view",
  'csui/utils/nodesprites',
  'i18n!xecmpf/widgets/scan/impl/nls/lang',
  'css!xecmpf/widgets/scan/impl/scan'
], function (_,  SimpleListView, StandardListItem, NodeSpriteCollection, Lang) {

  var ScanListView = SimpleListView.extend({
    constructor: function ScanListView(options) {
      if (!options) {
        options = {};
      }
      SimpleListView.prototype.constructor.apply(this, arguments);
    },

    className: 'xecmpf-scan-list',
    templateHelpers: function () {
      return {        
        hideSearch: true,
      };
    },

    emptyViewOptions: {
      text: Lang.defaultTextForDesktop
    },

    childView: StandardListItem,

    childViewOptions: function () {
      return {
        templateHelpers: function () {
          return {
            name: this.model.get('name'),
            icon:  NodeSpriteCollection.findClassByNode(this.model),
            enableIcon: true
          };
        }
      }
    }

  });
  return ScanListView;
});
csui.define('xecmpf/widgets/scan/scan.view',['csui/lib/underscore', 'csui/lib/jquery',
  "csui/lib/backbone",
  'csui/controls/tile/tile.view',
  'xecmpf/widgets/scan/scan.content.view',
  'csui/utils/perspective/perspective.util',
  'csui/utils/contexts/factories/node',
  'i18n!xecmpf/widgets/scan/impl/nls/lang',
  'csui/models/node/node.model',
  'css!xecmpf/widgets/scan/impl/scan'
], function (_, $, Backbone, TileView, ScanContentView, PerspectiveUtil,
  NodeModelFactory, Lang, NodeModel) {

  var ScanCollection = Backbone.Collection.extend({
    constructor: function (models, options) {
      options || (options = {});
      _.defaults(options, {
        model: NodeModel
      });
      this.options = options;
      Backbone.Collection.prototype.constructor.call(this, models, options);
    }
  });

  var ScanView = TileView.extend({
    constructor: function ScanView(options) {
      TileView.prototype.constructor.call(this, options);
    },
    contentView: ScanContentView,
    title: Lang.title,
    
    initialize: function () {
      if (this.options.perspectiveMode === PerspectiveUtil.MODE_EDIT_PERSPECTIVE) {
        this.scanItemsCollection = new ScanCollection([]);

        this._getScanItems().always(_.bind(function () {
          this.scanItemsCollection.reset(this.items);
        }, this));
      }
    },

    _getScanItems: function () {
      var businessObjectTypes = this.options.data.businessobjecttypes;
      var self = this;
      this.items = _.map(businessObjectTypes, function (item) {
        if (item.id) {
          var model = self.options.context.getModel(NodeModelFactory, {
            attributes: {
              id: item.id,
              type: 889
            }
          });
          return model;
        }
      });
      this.items = _.compact(this.items); // to remove any undefined/null items

      var modelPromises = _.map(this.items, function (model) {
        return model.fetch({ suppressError: true });
      });

      var result = $.whenAll.apply($, modelPromises);
      result.always(function () {
        _.each(businessObjectTypes, function (item, index) {
          item.node = self.items[index];
        });
      });
      return result;
    },
    contentViewOptions: function () {
      this.scanItemsCollection = new ScanCollection(this.items);
      var viewoptions = {
        showTitleIcon: false,
        hideSearch: true,
        collection: this.scanItemsCollection
      }
      return viewoptions;
    }
  });
  return ScanView;
});

/**
 * @desc - It makes /fileupload service call to fetch documents information
 */
 csui.define('xecmpf/widgets/fileupload/impl/models/fileupload.model',['csui/lib/underscore',
 'csui/lib/backbone',
 'csui/utils/url',
 'csui/models/mixins/connectable/connectable.mixin',
 'csui/models/mixins/fetchable/fetchable.mixin'],
 function (_, Backbone, Url, ConnectableMixin, FetchableMixin) {

   var FileUploadModel = Backbone.Model.extend({
     /**
      * @desc - creating model and making it connectable and fetchable
      */
     constructor: function FileUploadModel(attributes, options) {
       options = options || {};
       this.options = options;
       Backbone.Model.prototype.constructor.apply(this, arguments);
       this.makeConnectable(options);
       this.makeFetchable(options);
     },
     
     /**
      * @desc - generates api url
      */
     url: function (options) {
       return Url.combine(this.connector.getConnectionUrl().getApiBase('v2'), '/businessworkspaces/', this.options.node.get('id'), '/fileupload')
     },

     /**
      * @desc - parses response from service and creates a collection for data attribute in the model
      */
     parse: function (response) {
       var result = response.results;
       result.data = new Backbone.Collection(result.data);
       return result;
     }
   });
   ConnectableMixin.mixin(FileUploadModel.prototype);
   FetchableMixin.mixin(FileUploadModel.prototype);

   return FileUploadModel;

 });


/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/fileupload/impl/fileupload.content/fileupload.info/fileupload.info.item',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"xecmpf-fileupload-doc-info-icon csui-type-icon "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"icon") || (depth0 != null ? lookupProperty(depth0,"icon") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"icon","hash":{},"loc":{"start":{"line":1,"column":59},"end":{"line":1,"column":67}}}) : helper)))
    + "\"></div>\r\n<div title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"label") || (depth0 != null ? lookupProperty(depth0,"label") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"label","hash":{},"loc":{"start":{"line":2,"column":12},"end":{"line":2,"column":21}}}) : helper)))
    + " "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"count") || (depth0 != null ? lookupProperty(depth0,"count") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"count","hash":{},"loc":{"start":{"line":2,"column":22},"end":{"line":2,"column":31}}}) : helper)))
    + "\" class=\"xecmpf-fileupload-doc-info-text list-item-title\" role=\"link\" key=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"key") || (depth0 != null ? lookupProperty(depth0,"key") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"key","hash":{},"loc":{"start":{"line":2,"column":106},"end":{"line":2,"column":113}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"label") || (depth0 != null ? lookupProperty(depth0,"label") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"label","hash":{},"loc":{"start":{"line":2,"column":127},"end":{"line":2,"column":136}}}) : helper)))
    + " "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"count") || (depth0 != null ? lookupProperty(depth0,"count") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"count","hash":{},"loc":{"start":{"line":2,"column":137},"end":{"line":2,"column":146}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"label") || (depth0 != null ? lookupProperty(depth0,"label") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"label","hash":{},"loc":{"start":{"line":2,"column":148},"end":{"line":2,"column":157}}}) : helper)))
    + "<span class=\"xecmpf-item-count\">&nbsp;("
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"count") || (depth0 != null ? lookupProperty(depth0,"count") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"count","hash":{},"loc":{"start":{"line":2,"column":196},"end":{"line":2,"column":205}}}) : helper)))
    + ")</span></div>\r\n";
}});
Handlebars.registerPartial('xecmpf_widgets_fileupload_impl_fileupload.content_fileupload.info_fileupload.info.item', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/fileupload/impl/fileupload.content/fileupload.info/fileupload.info',[],function(){});
/**
 * @desc - collection view to show categorized information based on model data
 */
csui.define('xecmpf/widgets/fileupload/impl/fileupload.content/fileupload.info/fileupload.info.view',['csui/lib/underscore',
  'csui/lib/marionette',
  'csui/controls/list/list.view',
  'hbs!xecmpf/widgets/fileupload/impl/fileupload.content/fileupload.info/fileupload.info.item',
  'css!xecmpf/widgets/fileupload/impl/fileupload.content/fileupload.info/fileupload.info'], function (_, Marionette, ListView, FileUploadInfoItemTemplate) {

    var FileUploadInfoItemView = Marionette.ItemView.extend({
      className: 'xecmpf-fileupload-doc-info',
      constructor: function FileUploadInfoItemView(options) {
        Marionette.ItemView.prototype.constructor.call(this, options);
      },
      template: FileUploadInfoItemTemplate,
      onRender: function (){
        var areaLabel = this.options.model.get('count') +" "+ this.options.model.get('label'); 
        this.$el.attr('role', "label" ).attr('tabindex', 0).attr('aria-label', areaLabel);
      }
    });

    return Marionette.CollectionView.extend({
      className: 'xecmpf-fileupload-info-list',
      constructor: function (options) {
        options = options || {};
        Marionette.CollectionView.prototype.constructor.call(this, options);
      },
      childView: FileUploadInfoItemView
    });

  });
csui.define('xecmpf/controls/draganddrop/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});

csui.define('xecmpf/controls/draganddrop/impl/nls/root/lang',{
  dropMessage: 'Drop your file(s).',
  dropNotPermitted: 'No files can be dropped here.',
  dropInvalid: 'Only files can be dropped here.'
});



/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/draganddrop/impl/draganddrop',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"xecmpf-messageBox\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"message") || (depth0 != null ? lookupProperty(depth0,"message") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"message","hash":{},"loc":{"start":{"line":1,"column":32},"end":{"line":1,"column":43}}}) : helper)))
    + "</span>";
}});
Handlebars.registerPartial('xecmpf_controls_draganddrop_impl_draganddrop', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/controls/draganddrop/impl/draganddrop',[],function(){});
csui.define('xecmpf/controls/draganddrop/draganddrop.view',['module', 'csui/lib/jquery', 'csui/lib/underscore', 'csui/lib/marionette',
  'i18n!xecmpf/controls/draganddrop/impl/nls/lang',
  'hbs!xecmpf/controls/draganddrop/impl/draganddrop',
  'css!xecmpf/controls/draganddrop/impl/draganddrop'
], function (module, $, _, Marionette, lang, template) {

  var config = _.defaults({}, module.config(), {
    detectLeaveDelay: 100
  });

  var DragAndDropView = Marionette.ItemView.extend({

    template: template,
    className: "xecmpf-dropMessage",

    ui: {
      message: '.xecmpf-messageBox'
    },

    templateHelpers: function () {
      return {
        message: lang.dropMessage
      };
    },

    constructor: function DragAndDropView(options) {
      Marionette.ItemView.prototype.constructor.call(this, options);

      this.addableTypes = options.addableTypes;
      this.wantDragAndDrop = true;
      this.context = options.context;
      this.visible = false;
      this.parentView = options.originatingView || options.parentView;
    },

    setDragParentView: function (parentView, selector) {
      this.parentView = parentView;
      // Accept a selector within the parent view, a jQuery object,
      // a HTML DOM element, or default to the parent view itself,
      // when choosing the drop-active area
      this._parentEl = _.isString(selector) && parentView.$(selector) ||
                       selector.length !== undefined && selector ||
                       selector && $(selector) ||
                       parentView.$el;
      this.render();
      this._parentEl.append(this.el);
      if (this.shouldDragAndDrop()) {
        this.disable();
        this._setDragEvents();
      }
      return true;
    },

    onDestroy: function () {
      if (this.shouldDragAndDrop()) {
        if (this._parentEl) {
          this._parentEl
              .off("dragover", this.dragOver)
              .off("dragleave", this.dragLeave)
              .off("drop", this.dragDrop);
        }
      }
    },

    _setDragEvents: function () {
      this.dragOver = _.bind(this.onOverView, this);
      this.dragLeave = _.bind(this.onLeaveView, this);
      this.dragDrop = _.bind(this.onDropView, this);
      this._parentEl
          .on("dragover", this.dragOver)
          .on("dragleave", this.dragLeave)
          .on("drop", this.dragDrop);
    },

    enable: function (triggerEvent) {
      if (!this.visible) {
        if (triggerEvent !== false) {
          this.trigger('drag:over');
        }
        this.$el.show();
        this.visible = true;
      }
    },

    disable: function (currentEvent) {
      this.$el.hide();
      this.trigger('drag:leave');
      this.visible = false;
    },

    shouldDragAndDrop: function () {
      // Check browser support
      var browserSupported = false,
          sampleDiv        = document.createElement('div');

      // Check to see if this browser supports drag and drop
      if ((window.File && window.FileReader && window.FileList && window.Blob) &&
          (('draggable' in sampleDiv) ||
           ('ondragstart' in sampleDiv && 'ondrop' in sampleDiv))) {
        browserSupported = true;
      }

      return browserSupported && this.wantDragAndDrop;
    },

    canAdd: function () {
      return this.addableTypes === '144';
    },

    onOverView: function (currentEvent) {
      currentEvent.preventDefault();
      currentEvent.stopPropagation();

      if (this.leaveViewTimeout) {
        clearTimeout(this.leaveViewTimeout);
        this.leaveViewTimeout = undefined;
      }
      else {
        this.enable(false);
      }

      // MIME type is not reliable - it is guessed just by the file extension
      // and thus often empty - and more about the dragged object cannot be
      // learnt from security reasons
      var dataTransfer   = currentEvent.originalEvent &&
                           currentEvent.originalEvent.dataTransfer,
          items          = dataTransfer.items,
          validItems     = items && items.length && _.all(items, function (item) {
                return item.kind === 'file';
              }),
          types          = dataTransfer && dataTransfer.types,
          // Firefox contains both 'Files' and application/x-moz-file;
          // it is covered by items above, this is for IE11
          validTypes     = types && types.length && _.any(types, function (type) {
                return type.toLowerCase() === 'files';
              }),
          invalidMessage = lang.dropInvalid;
      this.valid = items && validItems || validTypes;
      dataTransfer.dropEffect = 'copy';

      if (!this.canAdd()) {
        this.valid = false;
        invalidMessage = lang.dropNotPermitted;
      }

      if (this.valid) {
        if (this.$el.hasClass('csui-disabled')) {
          this._restMessage();
          this.$el.removeClass('csui-disabled');
        }
        this.trigger('drag:over', this, {disabled: false});
      } else {
        if (!this.$el.hasClass('csui-disabled')) {
          this.ui.message.text(invalidMessage);
          this.$el.addClass('csui-disabled');
        }
        this.trigger('drag:over', this, {disabled: true});
      }
    },

    onLeaveView: function (currentEvent) {
      currentEvent.preventDefault();
      currentEvent.stopPropagation();
      if (!this.leaveViewTimeout) {
        this.leaveViewTimeout = setTimeout(_.bind(function () {
          this.leaveViewTimeout = undefined;
          this.disable();
        }, this), config.detectLeaveDelay);
      }
    },

    onDropView: function (currentEvent) {
      currentEvent.preventDefault();
      currentEvent.stopPropagation();
      var self         = this,
          dataTransfer = currentEvent.originalEvent &&
                         currentEvent.originalEvent.dataTransfer ||
              {
                files: currentEvent.originalEvent &&
                       currentEvent.originalEvent.target &&
                       currentEvent.originalEvent.target.files || []
              };
      this.checkFiles(dataTransfer).always(function (files) {
        files = _.reject(files, function (file) {
          return file instanceof Error;
        });
        console.log("Dropped files length", files.length);
        // onDrop can handled by the view
        self.parentView.onDrop && self.parentView.onDrop(files);
      });
      this.disable();
    },

    checkFiles: function (dataTransfer) {
      // IE11 branch: check the non-zero .files elements by trying to load a slice of them
      var files = dataTransfer.files;
      if (files) {
        return $.whenAll
            .apply($, _.map(files, _.bind(checkFile, this)))
            .then(function (results) {
              return results;
            }, function (files) {
              return $
                  .Deferred()
                  .reject(files)
                  .promise();
            });
      }

      // Bail out if no files were dropped
      return $
          .Deferred()
          .reject([])
          .promise();

      function checkFile(file) {
        var reader   = new FileReader(),
            deferred = $.Deferred(),
            aborted;

        if (file.size === 0) {
          var errorS0 = new Error('size is 0');
          errorS0.file = file;
          return deferred.reject(errorS0);
        }
        reader.addEventListener('load', function () {
          deferred.resolve(file);
          // The abort event comes after the error event
          aborted = true;
          reader.abort();
        });
        reader.addEventListener('error', function () {
          if (!aborted) {
            var error = new Error('No file');
            error.file = file;
            deferred.reject(error);
          }
        });
        try {
          var sz = Math.min(file.size, 512);
          var slice = file.slice(0, sz);
          reader.readAsArrayBuffer(slice);
        } catch (err) {
          //In IE edge browser, when we drag and drop folders(unsupported types) filereader does not
          // triggered an 'error' event and UI freezes. so catching unexpected errors.
          var error = new Error(err.message);
          error.file = file;
          deferred.reject(error);
        }
        return deferred.promise();
      }
    },

    _restMessage: function () {
      if (this._isRendered) {
        this.ui.message.text(this._getDropPossibleMessage());
      }
    },

    _getDropPossibleMessage: function () {
      return lang.dropMessage;
    }

  });

  return DragAndDropView;

});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.info/fileuploaditem',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class='xecmpf-file-upload-item-icon'>\r\n  <span class=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"iconClass") || (depth0 != null ? lookupProperty(depth0,"iconClass") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"iconClass","hash":{},"loc":{"start":{"line":2,"column":15},"end":{"line":2,"column":28}}}) : helper)))
    + "\"></span>\r\n</div>\r\n<div class=\"xecmpf-file-upload-item-info\">\r\n  <p class=\"xecmpf-file-upload-item-info-name\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"name") || (depth0 != null ? lookupProperty(depth0,"name") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"name","hash":{},"loc":{"start":{"line":5,"column":54},"end":{"line":5,"column":62}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"name") || (depth0 != null ? lookupProperty(depth0,"name") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"name","hash":{},"loc":{"start":{"line":5,"column":64},"end":{"line":5,"column":72}}}) : helper)))
    + "</p>\r\n  <p class=\"xecmpf-file-upload-item-info-size\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"sizeLabel") || (depth0 != null ? lookupProperty(depth0,"sizeLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"sizeLabel","hash":{},"loc":{"start":{"line":6,"column":54},"end":{"line":6,"column":67}}}) : helper)))
    + " "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"size") || (depth0 != null ? lookupProperty(depth0,"size") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"size","hash":{},"loc":{"start":{"line":6,"column":68},"end":{"line":6,"column":76}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"sizeLabel") || (depth0 != null ? lookupProperty(depth0,"sizeLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"sizeLabel","hash":{},"loc":{"start":{"line":6,"column":78},"end":{"line":6,"column":91}}}) : helper)))
    + " "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"size") || (depth0 != null ? lookupProperty(depth0,"size") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"size","hash":{},"loc":{"start":{"line":6,"column":92},"end":{"line":6,"column":100}}}) : helper)))
    + "</p>\r\n</div>\r\n<div class=\"xecmpf-file-upload-item-delete\">\r\n  <span aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"deleteItemTitle") || (depth0 != null ? lookupProperty(depth0,"deleteItemTitle") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"deleteItemTitle","hash":{},"loc":{"start":{"line":9,"column":20},"end":{"line":9,"column":39}}}) : helper)))
    + " "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"name") || (depth0 != null ? lookupProperty(depth0,"name") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"name","hash":{},"loc":{"start":{"line":9,"column":40},"end":{"line":9,"column":48}}}) : helper)))
    + "\" role=\"button\" tabindex=\"0\" class=\"xecmpf-file-upload-item-delete-icon\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"deleteItemTitle") || (depth0 != null ? lookupProperty(depth0,"deleteItemTitle") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"deleteItemTitle","hash":{},"loc":{"start":{"line":9,"column":128},"end":{"line":9,"column":147}}}) : helper)))
    + "\"></span>\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_controls_fileuploadpanel_impl_fileuploadpanel.info_fileuploaditem', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/controls/fileuploadpanel/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  "en-us": false,
  "en": false
});
csui.define('xecmpf/controls/fileuploadpanel/impl/nls/root/lang',{
  panelTitle: 'Upload documents',
  filesLabel: 'Files',
  sizeLabel: 'Size',
  deleteItemTitle: 'Delete item',
  uploadItemLabel: 'Upload file',
  continueButtonLabel: 'Continue',
  submitButtonLabel: 'Submit',
  cancelButtonLabel: 'Cancel',
  fileSizeByte: 'Bytes',
  fileSizeKByte: 'KB',
  fileSizeMByte: 'MB',
  fileSizeGByte: 'GB',
  stopUploadConfirmation: 'Stop uploading files?',
  yesLabel: 'Stop',
  noLabel: 'Cancel',
  docTypeLabel: 'Document type',
  previewError: 'Unable to load the preview for selected document at this point of time.',
  detailsMissing: 'Mandatory fields are not filled',
  uploadFailed: 'Upload failed.'
});


csui.define('css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.info/fileuploaditem',[],function(){});
/**
 * @desc - It represents single file item uploaded and contains provision to delete it
 */
csui.define('xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.info/fileuploadpanel.info.item.view',[
  'csui/lib/marionette',
  'hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.info/fileuploaditem',
  'i18n!xecmpf/controls/fileuploadpanel/impl/nls/lang',
  'css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.info/fileuploaditem',
], function (Marionette, fileItemTemplate, lang) {
  "use strict";

  var FileInfoItemView = Marionette.ItemView.extend({
    className: 'xecmpf-file-upload-item',
    tagName: 'li',
    template: fileItemTemplate,
    ui: {
      deleteBtn: '.xecmpf-file-upload-item-delete .xecmpf-file-upload-item-delete-icon'
    },
    initialize: function () {
      this.$el.attr('role', 'listitem').attr('tabindex', -1);
    },
    events: {
      'click @ui.deleteBtn': 'deleteUploadItem',
      'keydown @ui.deleteBtn': 'doClickOnEnter'
    },
    templateHelpers: function () {
      return {
        name: this.model.get('name'),
        size: this.formatFilzeSize(this.model.get('size')),
        iconClass: this.model.get('iconClass'),
        sizeLabel: lang.sizeLabel,
        deleteItemTitle: lang.deleteItemTitle
      }
    },

    /**
     * @desc - It returns back size in text with specific format
     * @param { size | Number } - size in bytes
     */
    formatFilzeSize: function (size) {
      if (size) {
        var filesSize = lang.fileSizeByte;
        if (size > 1024) {
          filesSize = lang.fileSizeKByte;
          size = size / 1024;
          if (size > 1024) {
            filesSize = lang.fileSizeMByte;
            size = size / 1024;
            if (size > 1024) {
              filesSize = lang.fileSizeGByte;
              size = size / 1024;
            }
          }
        }
        return Math.ceil(size) + ' ' + filesSize;
      }
      return size;
    },

    /**
     * @desc - It simulates click on enter
     * @param { event | Event } - keyboard event
     */
    doClickOnEnter: function (event) {
      if (event.keyCode === 32 || event.keyCode === 13) {
        event.preventDefault();
        event.stopPropagation();
        this.trigger('delete:uploaded:item', this.model, { keyBoardEvent: true });
      }
    },

    /**
     * @desc - It triggers method on click on delete icon and pass model as data
     */
    deleteUploadItem: function () {
      this.trigger('delete:uploaded:item', this.model);
    }
  });
  return FileInfoItemView;
});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.info/fileuploadpanel.info',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class='xecmpf-file-upload-panel-info-control'>\r\n  <span aria-label='"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"filesLabel") || (depth0 != null ? lookupProperty(depth0,"filesLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"filesLabel","hash":{},"loc":{"start":{"line":2,"column":20},"end":{"line":2,"column":34}}}) : helper)))
    + " "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"totalFiles") || (depth0 != null ? lookupProperty(depth0,"totalFiles") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"totalFiles","hash":{},"loc":{"start":{"line":2,"column":35},"end":{"line":2,"column":49}}}) : helper)))
    + "' role=\"label\" tabindex=\"0\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"filesLabel") || (depth0 != null ? lookupProperty(depth0,"filesLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"filesLabel","hash":{},"loc":{"start":{"line":2,"column":77},"end":{"line":2,"column":91}}}) : helper)))
    + " (<span id='xecmpf-file-upload-panel-info-count'>"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"totalFiles") || (depth0 != null ? lookupProperty(depth0,"totalFiles") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"totalFiles","hash":{},"loc":{"start":{"line":2,"column":140},"end":{"line":2,"column":154}}}) : helper)))
    + "</span>)</span>\r\n  <div title='"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"uploadItemLabel") || (depth0 != null ? lookupProperty(depth0,"uploadItemLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"uploadItemLabel","hash":{},"loc":{"start":{"line":3,"column":14},"end":{"line":3,"column":35}}}) : helper)))
    + "' aria-label='"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"uploadItemLabel") || (depth0 != null ? lookupProperty(depth0,"uploadItemLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"uploadItemLabel","hash":{},"loc":{"start":{"line":3,"column":49},"end":{"line":3,"column":70}}}) : helper)))
    + "' tabindex='0' role='button' class='binf-btn xecmpf-file-upload-btn' id='xecmpf-file-upload-btn'>\r\n      <span class='icon icon-toolbarAdd'></span>\r\n  </div>\r\n</div>\r\n<ul class='xecmpf-file-upload-panel-list-section'></ul>";
}});
Handlebars.registerPartial('xecmpf_controls_fileuploadpanel_impl_fileuploadpanel.info_fileuploadpanel.info', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.info/fileuploadpanel.info',[],function(){});
/**
 * @desc - This view represents initial slide in the side panel view where it contains provision to upload files and 
 * also show uploaded files information.
 */
csui.define('xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.info/fileuploadpanel.info.view',[
  'csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/marionette',
  'csui/controls/side.panel/side.panel.view',
  'csui/controls/tile/behaviors/blocking.behavior',
  'csui/controls/tile/behaviors/perfect.scrolling.behavior',
  'csui/dialogs/file.open/file.open.dialog',
  'xecmpf/controls/draganddrop/draganddrop.view',
  'xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.info/fileuploadpanel.info.item.view',
  'hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.info/fileuploadpanel.info',
  'i18n!xecmpf/controls/fileuploadpanel/impl/nls/lang',
  'css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.info/fileuploadpanel.info',
], function (_, $, Marionette, SidePanelView, BlockingBehavior, PerfectScrollingBehavior, FileOpenDialog, DragAndDrop, FileInfoItemView, fileUploadInfoTemplate, lang) {
  "use strict";

  var FileUploadPanelInfoView = Marionette.CompositeView.extend({
    className: 'xecmpf-file-upload-panel-info',
    template: fileUploadInfoTemplate,
    selectedIndex: 0,
    constructor: function FileUploadPanelInfoView(options) {
      Marionette.CompositeView.prototype.constructor.call(this, options);
    },
    initialize: function (options) {
      // initializing drag and drop support
      this.dragNDrop = new DragAndDrop({
        addableTypes: '144',
        context: this.options.context,
        connector: this.options.connector,
        originatingView: this
      });
    },
    onRender: function () {
      // setting drag and drop parent view and updating tab index of first item for tab navigation
      this.dragNDrop.setDragParentView(this, '.xecmpf-file-upload-panel-list-section');
      this.$el.find('.xecmpf-file-upload-panel-list-section .xecmpf-file-upload-item:first-child').attr('tabindex', 0);
    },
    behaviors: {
      PerfectScrolling: {
        behaviorClass: PerfectScrollingBehavior,
        contentParent: '.xecmpf-file-upload-panel-list-section',
        suppressScrollX: true,
        // like bottom padding of container, otherwise scrollbar is shown always
        scrollYMarginOffset: 15
      },
      Blocking: {
        behaviorClass: BlockingBehavior
      }
    },
    childViewContainer: '.xecmpf-file-upload-panel-list-section',
    childView: FileInfoItemView,
    childEvents: {
      'delete:uploaded:item': 'deleteUploadedItem'
    },
    templateHelpers: function () {
      return {
        totalFiles: this.options.collection.length,
        filesLabel: lang.filesLabel,
        uploadItemLabel: lang.uploadItemLabel
      }
    },
    ui: {
      fileUploadBtn: '#xecmpf-file-upload-btn',
      listSection: '.xecmpf-file-upload-panel-list-section',
      listItem: '.xecmpf-file-upload-panel-list-section .xecmpf-file-upload-item'
    },
    events: {
      'click @ui.fileUploadBtn': 'openFileDialog',
      'keydown @ui.fileUploadBtn': 'doClickOnEnter',
      'keydown @ui.listSection': 'doArrowNavigate',
      'focusin @ui.listItem': 'showDeleteIcon',
    },

    /**
     * @desc - Open file upload dialog and updates collection after files upload
     */
    openFileDialog: function () {
      var fileOpenDialog = new FileOpenDialog({ multiple: true }),
        that = this;
      fileOpenDialog.listenTo(fileOpenDialog, 'add:files', (function (files) {
        that.collection.addUploadedItems(files);
        that.onItemsUpdate();
        fileOpenDialog.destroy();
      }).bind(this))
        .show();
    },

    /**
     * @desc - This would be triggered once files uploaded through drag & drop.
     * It updates collection after files upload
     */
    onDrop: function (files) {
      this.collection.addUploadedItems(files);
      this.onItemsUpdate();
    },

    /**
     * @desc - It removes uploaded file item from list by deleting file item model from collection. 
     * @param { src | Marionette.View } - child view from where this event triggered
     * @param { model | Backbone.Model } - Backbone model representing file item
     */
    deleteUploadedItem: function (src, model, data) {
      this.collection.removeUploadedItem(model);
      this.onItemsUpdate(data && data.keyBoardEvent ? true: false);
    },

    /**
     * @desc - It updates files length when new file updated or existing files deleted and also updates tab indexes
     */
    onItemsUpdate: function (focusItem) {
      document.querySelector('#xecmpf-file-upload-panel-info-count').innerText = this.collection.length;
      document.querySelector('.xecmpf-file-upload-panel-info-control > span').setAttribute('aria-label', lang.filesLabel + ' ' + this.collection.length);
      this.$el.find('.xecmpf-file-upload-panel-list-section .xecmpf-file-upload-item:first-of-type').attr('tabindex', 0);
      this.selectedIndex = 0;
      if (focusItem) {
        this.$el.find('.xecmpf-file-upload-panel-list-section .xecmpf-file-upload-item:first-of-type').focus();
      }
    },

    /**
     * @desc - It trigger click event on press of space or tab
     */
    doClickOnEnter: function (event) {
      if (event.keyCode === 32 || event.keyCode === 13) {
        event.preventDefault();
        event.stopPropagation();
        event.target.click();
      }
    },

    /**
     * @desc - It enables up/down arrow navigation for file items list
     */
    doArrowNavigate: function (e) {
      var $preElem = this.currentlyFocusedElement();
      switch (e.keyCode) {        
        case 38: // up
          this._moveTo(e, this._selectPrevious(), $preElem);
          break;
        case 40: // down
          this._moveTo(e, this._selectNext(), $preElem);
          break;
        case 33: // page up
          this._moveTo(e, this._selectFirst(), $preElem);
          break;
        case 34: // page down
          this._moveTo(e, this._selectLast(), $preElem);
          break;
        case 46: // delete
          $(e.target).find('.xecmpf-file-upload-item-delete .xecmpf-file-upload-item-delete-icon').trigger('click');
          this.$el.find('.xecmpf-file-upload-panel-list-section .xecmpf-file-upload-item:first-of-type').focus();
          break;
      }
    },

    /**
     * @desc - It returns currently focused list item
     */
    currentlyFocusedElement: function () {
      var collection = this.collection;
      if ((this.selectedIndex !== 0) && (this.selectedIndex >= collection.length)) {
        this.selectedIndex = collection.length - 1;
      }
      // find the element at the current index and return
      var $item = this.$(".xecmpf-file-upload-panel-list-section .xecmpf-file-upload-item:nth-of-type(" + (this.selectedIndex + 1) + ")");
      var elementOfFocus = ($item.length !== 0) ? this.$($item[0]) : null;
      return elementOfFocus;
    },

    /**
     * @desc - It triggers focus on the given element and updates its tabindex
     */
    _moveTo: function (event, $elem, $preElem) {
      event.preventDefault();
      event.stopPropagation();
      setTimeout(_.bind(function () {
        $preElem && $preElem.prop('tabindex', '-1');
        $elem.prop('tabindex', '0');
        $elem.trigger('focus');
      }, this), 50);
    },

    /**
     * @desc - It returns next element which needs to get focus while doing arrow navigation
     */
    _selectNext: function () {
      var collection = this.model || this.collection;
      if (this.selectedIndex < collection.length - 1) {
        this.selectedIndex++;
      }
      return this.currentlyFocusedElement();
    },

    /**
     * @desc - It returns previous element which needs to get focus while doing arrow navigation
     */
    _selectPrevious: function () {
      if (this.selectedIndex > 0) {
        this.selectedIndex--;
      }
      return this.currentlyFocusedElement();
    },

    /**
     * @desc - It returns first element 
     */
    _selectFirst: function () {
      this.selectedIndex = 0;
      return this.currentlyFocusedElement();
    },

    /**
     * @desc - It returns last element 
     */
    _selectLast: function () {
      this.selectedIndex = this.collection.length - 1;
      return this.currentlyFocusedElement();
    },

    /**
     * @desc - It shows delete icon when file item entry got focus
     */
    showDeleteIcon: function (event) {
      this.$el.find('.xecmpf-file-upload-item-delete-icon').removeClass('show');
      $(event.currentTarget).find('.xecmpf-file-upload-item-delete-icon').addClass('show');
    }
  });

  return FileUploadPanelInfoView;

});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.list/impl/fileuploadpanel.capture.list.item',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class='xecmpf-file-upload-capture-item-validation-icon'>\r\n  <span class=\"csui-icon xecmpf-file-upload-valid\"></span>\r\n  <span class=\"csui-icon xecmpf-file-upload-invalid\"></span>\r\n</div>\r\n<div class='xecmpf-file-upload-capture-item-icon'>\r\n  <span class=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"iconClass") || (depth0 != null ? lookupProperty(depth0,"iconClass") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"iconClass","hash":{},"loc":{"start":{"line":6,"column":15},"end":{"line":6,"column":28}}}) : helper)))
    + "\"></span>\r\n</div>\r\n<div class=\"xecmpf-file-upload-capture-item-info\">\r\n  <p class=\"xecmpf-file-upload-capture-item-info-name\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"name") || (depth0 != null ? lookupProperty(depth0,"name") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"name","hash":{},"loc":{"start":{"line":9,"column":67},"end":{"line":9,"column":75}}}) : helper)))
    + "\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"name") || (depth0 != null ? lookupProperty(depth0,"name") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"name","hash":{},"loc":{"start":{"line":9,"column":84},"end":{"line":9,"column":92}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"name") || (depth0 != null ? lookupProperty(depth0,"name") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"name","hash":{},"loc":{"start":{"line":9,"column":94},"end":{"line":9,"column":102}}}) : helper)))
    + "</p>\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_controls_fileuploadpanel_impl_fileuploadpanel.capture_impl_fileuploadpanel.capture.list_impl_fileuploadpanel.capture.list.item', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.list/impl/fileuploadpanel.capture.list.item',[],function(){});
/**
 * @desc - It shows list item with status icons
 */
csui.define('xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.list/fileuploadpanel.capture.list.item.view',[
  'csui/lib/marionette',
  'hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.list/impl/fileuploadpanel.capture.list.item',
  'i18n!xecmpf/controls/fileuploadpanel/impl/nls/lang',
  'css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.list/impl/fileuploadpanel.capture.list.item',
], function (Marionette, fileUploadCaptureListItemTemplate, lang) {
  "use strict";

  var FileUploadPanelCaptureListItemView = Marionette.ItemView.extend({
    className: function () {
      var clsName = 'xecmpf-file-upload-capture-list-item';
      if (this.model.get('upload_err')) {
        clsName += ' xecmpf-file-upload-disabled-item';
      }
      return clsName;
    },
    template: fileUploadCaptureListItemTemplate,
    constructor: function (options) {
      Marionette.ItemView.prototype.constructor.apply(this, arguments);
      this.model.on('change', (function () {
        if (this.model.hasChanged('upload_err')) {
          if (this.model.get('upload_err')) {
            this.$el.addClass('xecmpf-file-upload-disabled-item');
          } else {
            this.$el.removeClass('xecmpf-file-upload-disabled-item');
          }
        }
      }).bind(this));
    },
    templateHelpers: function () {
      return {
        name: this.model.get('name'),
        iconClass: this.model.get('iconClass')
      }
    },
    triggers: {
      'click': 'click:item'
    },
    /**
     * @desc - It updates form status icon
     */
    updateFormStatus: function (valid) {
      var validIcon = this.$el.find('.xecmpf-file-upload-capture-item-validation-icon span.xecmpf-file-upload-valid'),
        invalidIcon = this.$el.find('.xecmpf-file-upload-capture-item-validation-icon span.xecmpf-file-upload-invalid');
      if (valid) {
        invalidIcon.removeClass('show-status-icon');
        validIcon.addClass('show-status-icon');
      } else {
        validIcon.removeClass('show-status-icon');
        invalidIcon.addClass('show-status-icon');
      }
    }
  });

  return FileUploadPanelCaptureListItemView;

});
/**
 * @desc - It shows list of selected documents
 */
csui.define('xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.list/fileuploadpanel.capture.list.view',[
  'csui/lib/underscore',
  'csui/lib/marionette',
  'csui/controls/tile/behaviors/perfect.scrolling.behavior',
  'xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.list/fileuploadpanel.capture.list.item.view',
  'i18n!xecmpf/controls/fileuploadpanel/impl/nls/lang',
], function (_, Marionette, PerfectScrollingBehavior, FileUploadPanelCaptureListItemView, lang) {
  "use strict";

  var FileUploadPanelCaptureListView = Marionette.CollectionView.extend({
    className: 'xecmpf-file-upload-capture-list',
    childView: FileUploadPanelCaptureListItemView,
    constructor: function FileUploadPanelCaptureListView(options) {
      Marionette.CollectionView.prototype.constructor.call(this, options);

      // listening for update form status event and updating status symbol in the list
      this.listenTo(this, 'update:form:status', (function (args) {
        var dataId = args.dataId,
          valid = args.valid;
        this.children.forEach(function (view) {
          if (view.model.get('dataId') === dataId) {
            view.updateFormStatus(valid);
          }
        });
      }).bind(this));

      this.selectedIndex = 0;
    },
    behaviors: {
      PerfectScrolling: {
        behaviorClass: PerfectScrollingBehavior,
        suppressScrollX: true,
        scrollYMarginOffset: 15
      }
    },
    onRender: function () {
      if (this.children.length > 0) {
        this.children.findByIndex(0).$el.prop('tabindex', '0');
      }
    },
    childEvents: {
      'click:item': 'onClickItem'
    },

    /**
     * @desc - On clicking on list item, triggering events to fetch current form status and to show current document form
     */
    onClickItem: function (childView) {
      if (!childView.model.get('upload_err')) {
        this.children.forEach((function (view) {
          if (view.$el.hasClass('selected')) {
            view.$el.removeClass('selected');
            this.trigger('get:form:status', view.model.get('dataId'));
          }
        }).bind(this));
        childView.$el.addClass('selected');
        this.trigger('on:document:select', childView.model.get('dataId'));
      }
    },
    events: {
      'keydown .xecmpf-file-upload-capture-list-item': 'doClickOnEnter',
      'keydown': 'doArrowNavigate'
    },

    /**
     * @desc - It trigger click event on press of space or tab
     */
    doClickOnEnter: function (event) {
      if (event.keyCode === 32 || event.keyCode === 13) {
        event.preventDefault();
        event.stopPropagation();
        event.target.click();
      }
    },

    /**
     * @desc - It enables up/down arrow navigation for file items list
     */
    doArrowNavigate: function (e) {
      var $preElem = this.currentlyFocusedElement();
      switch (e.keyCode) {
        case 38: // up
          this._moveTo(e, this._selectPrevious(), $preElem);
          break;
        case 40: // down
          this._moveTo(e, this._selectNext(), $preElem);
          break;
        case 33: // page up
          this._moveTo(e, this._selectFirst(), $preElem);
          break;
        case 34: // page down
          this._moveTo(e, this._selectLast(), $preElem);
          break;
      }
    },

    /**
     * @desc - It returns currently focused list item
     */
    currentlyFocusedElement: function () {
      var collection = this.collection;
      if ((this.selectedIndex !== 0) && (this.selectedIndex >= collection.length)) {
        this.selectedIndex = collection.length - 1;
      }
      // find the element at the current index and return
      var $item = this.$el.find(".xecmpf-file-upload-capture-list-item:nth-of-type(" + (this.selectedIndex + 1) + ")");
      var elementOfFocus = ($item.length !== 0) ? this.$($item[0]) : null;
      return elementOfFocus;
    },

    /**
     * @desc - It triggers focus on the given element and updates its tabindex
     */
    _moveTo: function (event, $elem, $preElem) {
      event.preventDefault();
      event.stopPropagation();
      setTimeout(_.bind(function () {
        $preElem && $preElem.prop('tabindex', '-1');
        $elem.prop('tabindex', '0');
        $elem.trigger('focus');
      }, this), 50);
    },

    /**
     * @desc - It returns next element which needs to get focus while doing arrow navigation
     */
    _selectNext: function () {
      var collection = this.model || this.collection;
      if (this.selectedIndex < collection.length - 1) {
        this.selectedIndex++;
      }
      return this.currentlyFocusedElement();
    },

    /**
     * @desc - It returns previous element which needs to get focus while doing arrow navigation
     */
    _selectPrevious: function () {
      if (this.selectedIndex > 0) {
        this.selectedIndex--;
      }
      return this.currentlyFocusedElement();
    },

    /**
     * @desc - It returns first element 
     */
    _selectFirst: function () {
      this.selectedIndex = 0;
      return this.currentlyFocusedElement();
    },

    /**
     * @desc - It returns last element 
     */
    _selectLast: function () {
      this.selectedIndex = this.collection.length - 1;
      return this.currentlyFocusedElement();
    }
  });

  return FileUploadPanelCaptureListView;

});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.doctype/impl/fileuploadpanel.doctype',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class='xecmpf-file-upload-doctype-view'>\r\n    <div class=\"xecmpf-file-upload-doctype-header\">\r\n        <h4 title=\"{{options.docTypeLabel}}\" aria-label=\"{{options.docTypeLabel}}\">{{options.docTypeLabel}}</h4>\r\n    </div>\r\n    <div class=\"xecmpf-file-upload-doctype-form\">\r\n        <div class=\"xecmpf-file-upload-doctype\" id=\"xecmpf-file-upload-doctype\"></div>\r\n    </div>\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_controls_fileuploadpanel_impl_fileuploadpanel.doctype_impl_fileuploadpanel.doctype', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.doctype/impl/fileuploadpanel.doctype',[],function(){});
/**
 * @desc - View to show document type dropdown
 */
csui.define('xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.doctype/fileuploadpanel.doctype.view',[
  'csui/controls/form/form.view',
  'hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.doctype/impl/fileuploadpanel.doctype',
  'i18n!xecmpf/controls/fileuploadpanel/impl/nls/lang',
  'css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.doctype/impl/fileuploadpanel.doctype'
], function (FormView, formTemplate, lang) {

  var FileUploadPanelDocTypeView = FormView.extend({

    constructor: function FileUploadPanelDocTypeView(options) {
      FormView.prototype.constructor.call(this, options);
    },

    formTemplate: formTemplate,

    formTemplateHelpers: function () {
      return {
        docTypeLabel: lang.docTypeLabel
      };
    },

    _getLayout: function () {
      var template = this.getOption('formTemplate'),
        html = template.call(this, {
          data: this.alpaca.data,
          mode: this.mode
        }),
        bindings = this._getBindings(),
        view = {
          parent: 'bootstrap-csui',
          layout: {
            template: html,
            bindings: bindings
          }
        };
      return view;
    },

    _getBindings: function () {
      return {
        doc_type: 'xecmpf-file-upload-doctype'
      };
    }

  });

  return FileUploadPanelDocTypeView;
});

csui.define('css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.category/impl/fileuploadpanel.category',[],function(){});
/**
 * @desc - Form view to capture category information
 */
csui.define('xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.category/fileuploadpanel.category.view',[
  'csui/controls/form/form.view',
  'i18n!xecmpf/controls/fileuploadpanel/impl/nls/lang',
  'css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.category/impl/fileuploadpanel.category'
], function (FormView, formTemplate, lang) {

  var FileUploadPanelCategoryView = FormView.extend({

    constructor: function FileUploadPanelCategoryView(options) {
      FormView.prototype.constructor.call(this, options);
    }

  });

  return FileUploadPanelCategoryView;
});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.preview/impl/fileuploadpanel.preview.error',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"title") || (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"title","hash":{},"loc":{"start":{"line":1,"column":15},"end":{"line":1,"column":24}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"title") || (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"title","hash":{},"loc":{"start":{"line":1,"column":26},"end":{"line":1,"column":35}}}) : helper)))
    + "</p>\r\n<span class=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"iconClass") || (depth0 != null ? lookupProperty(depth0,"iconClass") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"iconClass","hash":{},"loc":{"start":{"line":2,"column":13},"end":{"line":2,"column":26}}}) : helper)))
    + "\"></span>\r\n";
}});
Handlebars.registerPartial('xecmpf_controls_fileuploadpanel_impl_fileuploadpanel.preview_impl_fileuploadpanel.preview.error', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.preview/impl/fileuploadpanel.preview.error',[],function(){});
/**
 * @desc - Error view to show error message when preview fails to load
 */
csui.define('xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.preview/fileuploadpanel.preview.error.view',[
  'csui/lib/marionette',
  'hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.preview/impl/fileuploadpanel.preview.error',
  'i18n!xecmpf/controls/fileuploadpanel/impl/nls/lang',
  'css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.preview/impl/fileuploadpanel.preview.error'
],
  function (Marionette, PreviewErrorTemplate, lang) {
    var FileUploadPreviewError = Marionette.ItemView.extend({
      className: 'xecmpf-file-upload-preview-error',
      templateHelpers: function () {
        return { title: lang.previewError, 'iconClass': this.model.get('iconClass') }
      },
      template: PreviewErrorTemplate
    });
    return FileUploadPreviewError;
  });

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.preview/impl/fileuploadpanel.preview',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class='xecmpf-file-upload-preview-viewer'></div>";
}});
Handlebars.registerPartial('xecmpf_controls_fileuploadpanel_impl_fileuploadpanel.preview_impl_fileuploadpanel.preview', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.preview/impl/fileuploadpanel.preview',[],function(){});
/**
 * @desc - this view is used to show the preview of the document.
 */

csui.define('xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.preview/fileuploadpanel.preview.view',[
  'require',
  'csui/lib/marionette',
  'csui/utils/commands/open.plugins/open.plugins',
  'csui/models/node/node.model',
  'xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.preview/fileuploadpanel.preview.error.view',
  'hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.preview/impl/fileuploadpanel.preview',
  'i18n!xecmpf/controls/fileuploadpanel/impl/nls/lang',
  'css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.preview/impl/fileuploadpanel.preview',
], function (require, Marionette, OpenPlugins, NodeModel, FileUploadPreviewError, PreviewTemplate, lang) {

  var FileUploadPanelPreviewView = Marionette.LayoutView.extend({

    className: 'xecmpf-file-upload-preview',
    attributes: {
      contenteditable: 'false'
    },
    regions: {
      viewer: '.xecmpf-file-upload-preview-viewer'
    },
    constructor: function FileUploadPanelPreviewView(options) {
      this.options = options || {};
      Marionette.LayoutView.prototype.constructor.apply(this, this.options);
    },
    initialize: function () {
      this.previewLoaded = false;
      Marionette.LayoutView.prototype.initialize.apply(this, arguments);
    },
    template: PreviewTemplate,
    
    /**
     * @desc - It finds suitable plugin to open the document and loads preview of the document. 
     * It loads error view in case of any error
     */
    showPreview: function () {
      var docNodeDetails,
        docNode,
        plugin,
        widgetView,
        docView;
      if (!this.previewLoaded && this.options.model.get('node')) {
        docNodeDetails = this.options.model.get('node');
        if (docNodeDetails && docNodeDetails.data && docNodeDetails.data.properties) {
          docNode = new NodeModel(docNodeDetails.data.properties, { connector: this.options.connector });
          plugin = OpenPlugins.findByNode(docNode, {});
          widgetView = (plugin && plugin.widgetView) || "";
          require([widgetView], (function (DocumentView) {
            docView = new DocumentView({ data: { id: this.options.model.get('dataId') }, context: this.options.context });
            this.viewer.show(docView);
            this.listenTo(docView, 'destroy', (function () {
              this.viewer.show(new FileUploadPreviewError({ model: this.options.model }));
            }).bind(this));
            this.previewLoaded = true;
          }).bind(this));
        }
      }
    }
  });

  return FileUploadPanelPreviewView;

});




csui.define('xecmpf/controls/fileuploadpanel/impl/models/fileuploadpanel.doctype.form.model',['csui/models/form', 'i18n!xecmpf/controls/fileuploadpanel/impl/nls/lang'], function (FormModel, lang
) {
    var FileUploadPanelDocTypeFormModel = FormModel.extend({
        constructor: function FileUploadPanelDocTypeFormModel(options) {
            this.options = options || (options = {});
            var context = options.context,
                attributes  = {
                  schema: { properties: {} },
                  options: { fields: {} },
                  date: {}
                };
            options.docTypeModel.on('change', (function () {
              if ( options.docTypeModel.hasChanged('docTypes') ) {
                this._setAttributes(options.docTypeModel);
              }
            }).bind(this));
            FormModel.prototype.constructor.call(this, attributes, options);
        },
        initialize: function (attributes, options) {
            this._setAttributes(this.options.docTypeModel);
        },
        _setAttributes: function ( docTypeModel ) {
            var docTypes, values = [], keys = [];
            if ( docTypeModel && docTypeModel.get('docTypes') ) {
              docTypes = docTypeModel.get('docTypes');
              values = docTypes.map(function(val) { return val.classification_id });
              keys = docTypes.map(function(val) { return val.classification_name });
            }
            this.set({
                schema: {
                    properties: {
                        doc_type: {
                            required: true,
                            type: 'select',
                            enum: values
                        }
                    }
                },
                options: {
                    fields: {
                      doc_type: {
                            label: lang.docTypeLabel,
                            type: 'select',
                            optionLabels: keys,
                            'events': {
                              'change': function() {
                                  this.fieldView.formView.trigger('doctype:change', this.getValue());
                              }
                            }
                        }
                    }
                },
                data: {
                  doc_type: ''
                }
            });
        }
    });
    return FileUploadPanelDocTypeFormModel;
});


csui.define('xecmpf/controls/fileuploadpanel/impl/models/fileuploadpanel.category.form.model',['csui/models/form', 'i18n!xecmpf/controls/fileuploadpanel/impl/nls/lang'], function (FormModel, lang) {
    var FileUploadPanelCategoryFormModel = FormModel.extend({
        constructor: function FileUploadPanelDocTypeFormModel(options) {
            this.options = options || (options = {});
            var context = options.context,
                attributes  = {
                  schema: { properties: {} },
                  options: { fields: {} },
                  data: {}
                };
            FormModel.prototype.constructor.call(this, attributes, options);
        },
        resetToEmptyRequiredModel: function() {
          this.set({
            schema: { properties: {} },
            options: { fields: {} },
            data: {}
          });
        }
    });
    return FileUploadPanelCategoryFormModel;
});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.data/impl/fileuploadpanel.capture.data.item',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class=\"xecmf-fileupload-capture-category\">\r\n  <div class=\"xecmf-fileupload-capture-doc-type\"></div>\r\n  <div class=\"xecmf-fileupload-capture-category-info\"></div>\r\n</div>\r\n<div class=\"xecmf-fileupload-capture-preview\"></div>\r\n  ";
}});
Handlebars.registerPartial('xecmpf_controls_fileuploadpanel_impl_fileuploadpanel.capture_impl_fileuploadpanel.capture.data_impl_fileuploadpanel.capture.data.item', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.data/impl/fileuploadpanel.capture.data.item',[],function(){});
/**
 * @desc - It shows data item view which contains doc type view, category view and preview view.
 */
csui.define('xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.data/fileuploadpanel.capture.data.item.view',[
  'csui/lib/marionette',
  'csui/controls/tile/behaviors/blocking.behavior',
  'xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.doctype/fileuploadpanel.doctype.view',
  'xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.category/fileuploadpanel.category.view',
  'xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.preview/fileuploadpanel.preview.view',
  'xecmpf/controls/fileuploadpanel/impl/models/fileuploadpanel.doctype.form.model',
  'xecmpf/controls/fileuploadpanel/impl/models/fileuploadpanel.category.form.model',
  'hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.data/impl/fileuploadpanel.capture.data.item',
  'i18n!xecmpf/controls/fileuploadpanel/impl/nls/lang',
  'css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.data/impl/fileuploadpanel.capture.data.item',
], function (Marionette, BlockingBehavior, FileUploadPanelDocTypeView, FileUploadCategoryView, FileUploadPanelPreviewView, FileUploadPanelDocTypeFormModel, FileUploadPanelCategoryFormModel, FileUploadCaptureCategoryDataItemTemplate, lang) {
  "use strict";

  var FileUploadPanelCaptureCategoryDataItemView = Marionette.LayoutView.extend({
    className: 'xecmpf-file-upload-capture-category-data-item',
    template: FileUploadCaptureCategoryDataItemTemplate,
    regions: {
      docTypeRegion: '.xecmf-fileupload-capture-doc-type',
      previewRegion: '.xecmf-fileupload-capture-preview',
      categoryRegion: '.xecmf-fileupload-capture-category-info'
    },
    onRender: function () {
      var that = this;
      var categoryFormModel = new FileUploadPanelCategoryFormModel({ context: this.options.context, wsNode: this.options.wsNode, connector: this.options.connector });
      var docTypeFormModel = new FileUploadPanelDocTypeFormModel({ context: this.options.context, wsNode: this.options.wsNode, connector: this.options.connector, docTypeModel: this.options.docTypeModel });
      this.docTypeView = new FileUploadPanelDocTypeView({ model: docTypeFormModel, layoutMode: 'singleCol', context: this.options.context, mode: 'create' });
      this.previewView = new FileUploadPanelPreviewView({ model: this.options.model, context: this.options.context, connector: this.options.connector });
      this.categoryView = new FileUploadCategoryView({ model: categoryFormModel, layoutMode: 'singleCol', context: this.options.context, connector: this.options.connector, mode: 'create' });
      this.docTypeRegion.show(this.docTypeView);
      this.previewRegion.show(this.previewView);
      this.categoryRegion.show(this.categoryView);

      // listens for invalid field event on doc type view and triggers event to update submit button
      this.listenTo(this.docTypeView, 'invalid:field', function (event) {
        if (!this.docTypeView.getValues().doc_type) {
          categoryFormModel.resetToEmptyRequiredModel();
        }
        that.trigger('update:submit:button');
      });

      // listens for change field event on doc type view and triggers event to update submit button
      this.listenTo(this.docTypeView, 'doctype:change', function (val) {
          categoryFormModel.resetToEmptyRequiredModel();
          if (val) {
            that.blockActions();
            that.options.docTypeModel.getCategoryFormModel(parseInt(val)).then(function (response) {
              categoryFormModel.set(response);
              that.unblockActions();
              that.trigger('update:submit:button');
            });
          }
      });

      // listens for change:field event on category view and triggers event to update submit button
      this.listenTo(this.categoryView, 'change:field', function (event) {
        this.trigger('update:submit:button');
      });

      // listens for invalid:field event on category view and triggers event to update submit button
      this.listenTo(this.categoryView, 'invalid:field', function (event) {
        this.trigger('update:submit:button');
      });
    },
    behaviors: {
      Blocking: {
        behaviorClass: BlockingBehavior
      }
    }
  });

  return FileUploadPanelCaptureCategoryDataItemView;
});
/**
 * @desc - Collection to hold uploaded files details
 */
csui.define('xecmpf/controls/fileuploadpanel/impl/models/fileuploadpanel.doctype.model',[
  'csui/lib/jquery',
  'csui/lib/backbone',
  'csui/utils/url',
  'csui/models/mixins/connectable/connectable.mixin',
  'csui/models/mixins/fetchable/fetchable.mixin'],
  function ( $, Backbone, Url, ConnectableMixin, FetchableMixin ) {

    var FileUploadPanelDocTypeModel = Backbone.Model.extend({
      constructor: function FileUploadPanelDocTypeModel(options) {
        this.options = options;
        Backbone.Model.prototype.constructor.call(this);
        this.makeConnectable(options);
        this.makeFetchable(options);
      },
      url: function () {
        var query = Url.combineQueryString(
            {
              skip_validation: false,
              document_type_rule: true,
              document_generation_only: false,
              sort_by: 'DocumentType'
            }
        );
        return Url.combine(this.options.connector.getConnectionUrl().getApiBase('v2'),
          '/businessworkspaces/' + this.options.wsId + '/doctypes?' + query);
      },
      parse: function (response) {
        if (response.results) {
          return {
            docTypes: response.results.map(function(val) { return val.data.properties; })
          }
        }
        return undefined;
      },
      getCategoryFormModel: function(docTypeId) {
        var docTypeInfo = this.get('docTypes').filter(function(val) { return val.classification_id === docTypeId }),
            connector = this.options.connector,
            that = this,
            url;
        if ( docTypeInfo && docTypeInfo.length > 0 ) {
          if ( this.get(docTypeInfo[0].category_id ) ) {
            return Promise.resolve(this.get(docTypeInfo[0].category_id ));
          } else {
            url =  Url.combine(connector.getConnectionUrl().getApiBase('v1'),
            '/forms/nodes/categories/create?id=' + this.options.wsId + '&category_id=' + docTypeInfo[0].category_id );
            return new Promise(function(resolve, reject) {
              connector.makeAjaxCall({
                url: url,
                type: 'GET',
                success: function (response, status, xhr) {
                  if ( response && response.forms && response.forms.length > 0 ) {
                    that.set( docTypeInfo[0].category_id, response.forms[0] );
                    resolve(response.forms[0]);
                  }
                },
                error: function() {
                  reject();
                }
              });
            });
          }
        }
        return Promise.reject();
      },
      getCategoryIdForDocType: function( docTypeId ) {
        var categoryId,
            docTypeInfo = this.get('docTypes').filter(function(val) { return val.classification_id === parseInt(docTypeId) });
        if ( docTypeInfo && docTypeInfo.length > 0 ) {
          categoryId = docTypeInfo[0].category_id;
        }
        return categoryId;
      }
    });

    ConnectableMixin.mixin(FileUploadPanelDocTypeModel.prototype);
    FetchableMixin.mixin(FileUploadPanelDocTypeModel.prototype);

    return FileUploadPanelDocTypeModel;

  });
csui.define('xecmpf/controls/fileuploadpanel/impl/models/fileuploadpanel.doctype.factory',['csui/lib/underscore',
  'csui/utils/contexts/factories/factory',
  'xecmpf/controls/fileuploadpanel/impl/models/fileuploadpanel.doctype.model'
], function (_,
    ModelFactory,
    FileUploadPanelDocTypeModel) {

  var FileUploadPanelDocTypeFactory = ModelFactory.extend({

    propertyPrefix: 'fileUploadPanelDocType',

    constructor: function FileUploadPanelDocTypeFactory(context, options) {
      ModelFactory.prototype.constructor.apply(this, arguments);
      this.property = new FileUploadPanelDocTypeModel(options.fileUploadPanelDocType.options);
      this.fetch();
    },

    fetch: function (options) {
      return this.property.fetch(options);
    }

  });

  return FileUploadPanelDocTypeFactory;

});
/**
 * @desc - It shows list of layout views to capture doc type and category information
 */
csui.define('xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.data/fileuploadpanel.capture.data.view',[
  'csui/lib/marionette',
  'csui/controls/tile/behaviors/blocking.behavior',
  'xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.data/fileuploadpanel.capture.data.item.view',
  'xecmpf/controls/fileuploadpanel/impl/models/fileuploadpanel.doctype.factory',
  'i18n!xecmpf/controls/fileuploadpanel/impl/nls/lang'
], function (Marionette, BlockingBehavior, FileUploadPanelCaptureCategoryDataItemView, FileUploadPanelDocTypeFactory, lang) {

  "use strict";

  var FileUploadPanelCaptureCategoryDataView = Marionette.CollectionView.extend({
    className: 'xecmpf-file-upload-capture-category-data-list',
    childView: FileUploadPanelCaptureCategoryDataItemView,
    childViewOptions: function (model) {
      return {
        model: model,
        context: this.options.context,
        wsNode: this.options.wsNode,
        connector: this.options.connector,
        docTypeModel: this.options.docTypeModel
      }
    },
    childEvents: {
      'update:submit:button': 'onUpdateSubmitButton'
    },
    constructor: function FileUploadPanelCaptureCategoryDataView(options) {

      options.docTypeModel = options.context.getModel(FileUploadPanelDocTypeFactory, {
        options: {
          wsId: options.wsNode.get('id'),
          context: options.context,
          connector: options.connector
        }
      });
      Marionette.CollectionView.prototype.constructor.call(this, options);

      // listens for on:document:select event from list view and showing layout view corresponding to the document
      this.listenTo(this, 'on:document:select', (function (dataId) {
        this.children.forEach(function (view) {
          if (view.model.get('dataId') === dataId) {
            view.$el.addClass('selected');
            view.previewView.showPreview();
          } else {
            view.$el.removeClass('selected');
          }
        });
      }).bind(this));

      // listens for get:form:status event from list view and responds back by triggering another event with status
      this.listenTo(this, 'get:form:status', (function (dataId) {
        this.doUpdateFormStatus(dataId);
      }).bind(this));

    },

    // triggers event to update form status for the selected document 
    doUpdateFormStatus: function (dataId) {
      this.children.forEach((function (view) {
        var valid;
        if (view.model.get('dataId') === dataId) {
          valid = view.docTypeView && view.docTypeView.validate() && view.categoryView && view.categoryView.validate() && Object.keys(view.categoryView.getValues()).length > 0;
          this.trigger('update:form:status', { dataId: dataId, valid: valid });
        }
      }).bind(this));
    },

    // trigger event along with validation details to update submit button
    onUpdateSubmitButton: function () {
      var validations = [], valid;
      this.children.forEach((function (view) {
        if (!view.model.get('upload_err')) {
          valid = false;
          try {
            valid = (view.docTypeView && view.docTypeView.validate() && view.categoryView && view.categoryView.validate() && Object.keys(view.categoryView.getValues()).length > 0);
          } catch (e) { }
          validations.push({ selected: view.$el.hasClass('selected'), dataId: view.model.get('dataId'), valid: valid });
        }
      }).bind(this));
      this.trigger('update:submit:button', validations);
    },

    // checks whether all forms information is captured or not. 
    isAllDocumentsInfoCaptured: function () {
      var isAllInfoCaptured = true;
      this.children.forEach((function (view) {
        if (!view.model.get('upload_err')) {
          isAllInfoCaptured = isAllInfoCaptured && (view.docTypeView.validate() && view.categoryView.validate());
        }
      }).bind(this));
      return isAllInfoCaptured;
    },

    // Prepares request payload to send to service
    getRequestPayload: function () {
      var payload = { 'docInfos': [] }, docInfo, that = this;
      this.children.forEach((function (view) {
        if (!view.model.get('upload_err')) {
          docInfo = {
            'docId': view.model.get('dataId'),
            'docType': parseInt(view.docTypeView.getValues().doc_type || '0'),
            'catId': that.options.docTypeModel.getCategoryIdForDocType(view.docTypeView.getValues().doc_type),
            'attrs': view.categoryView.getValues()
          };
          docInfo.attrs.id = docInfo.docId
          payload.docInfos.push(docInfo);
        }
      }).bind(this));
      return payload;
    },

    // validates whether all forms information is captured or not and makes service call with request data
    submitDocumentDetails: function () {
      if (this.isAllDocumentsInfoCaptured()) {
        return this.makeUploadDocsServiceCall();
      } else {
        return Promise.reject(lang.detailsMissing);
      }
    },

    // It makes upload docs service call with required details
    makeUploadDocsServiceCall: function () {
      var that = this,
        promise = new Promise(function (resolve, reject) {
          var connector = that.options.connector,
            url = connector.getConnectionUrl().getApiBase('v2') + '/fileupload/uploaddocs',
            formData = new FormData();
          formData.append('payload', JSON.stringify(that.getRequestPayload()));
          formData.append('ws_id', that.options.wsNode.get('id'));
          connector.makeAjaxCall({
            url: url,
            type: "POST",
            data: formData,
            success: function (response, status, jXHR) {
              resolve(response);
            },
            error: function (xhr, status, text) {
              reject(xhr.responseJSON.error);
            }
          });
        });
      return promise;
    },
    behaviors: {
      Blocking: {
        behaviorClass: BlockingBehavior
      }
    }
  });

  return FileUploadPanelCaptureCategoryDataView;

});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div id='xecmpf-file-upload-capture-list'></div>\r\n<div id='xecmpf-file-upload-capture-category-data'></div>";
}});
Handlebars.registerPartial('xecmpf_controls_fileuploadpanel_impl_fileuploadpanel.capture_impl_fileuploadpanel.capture', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture',[],function(){});
/**
 * @desc - This view renders list view, doc type, category and preview section in the second slide.
 * It also listens and triggers events for communication between list and category views.
 */
csui.define('xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/fileuploadpanel.capture.view',[
  'csui/lib/marionette',
  'xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.list/fileuploadpanel.capture.list.view',
  'xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture.data/fileuploadpanel.capture.data.view',
  'hbs!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture',
  'i18n!xecmpf/controls/fileuploadpanel/impl/nls/lang',
  'css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/impl/fileuploadpanel.capture',
], function (Marionette, FileUploadCaptureListView, FileUploadCaptureCategoryDataView, fileUploadCaptureTemplate, lang) {
  "use strict";

  var FileUploadPanelCaptureView = Marionette.LayoutView.extend({
    className: 'xecmpf-file-upload-capture',
    template: fileUploadCaptureTemplate,
    regions: {
      listRegion: '#xecmpf-file-upload-capture-list',
      categoryDataRegion: '#xecmpf-file-upload-capture-category-data'
    },
    constructor: function FileUploadPanelCaptureView(options) {
      Marionette.LayoutView.prototype.constructor.call(this, options);
    },
    onRender: function () {

      // shows list and category info views
      this.listView = new FileUploadCaptureListView({ collection: this.options.collection, context: this.options.context });
      this.categoryData = new FileUploadCaptureCategoryDataView({ collection: this.options.collection, context: this.options.context, wsNode: this.options.wsNode, connector: this.options.connector });
      this.listRegion.show(this.listView);
      this.categoryDataRegion.show(this.categoryData);

      // listening for document select event in list view and triggering event to category info view
      this.listenTo(this.listView, 'on:document:select', (function (args) {
        this.categoryData.trigger('on:document:select', args);
      }).bind(this));

      // listening for get form status event from list view and propagating that to category view
      this.listenTo(this.listView, 'get:form:status', (function (args) {
        this.categoryData.trigger('get:form:status', args);
      }).bind(this));

      // listening for update form status from category view and propagating that to list view
      this.listenTo(this.categoryData, 'update:form:status', (function (args) {
        this.listView.trigger('update:form:status', args);
      }).bind(this));

      // listening for update submit button event from category view
      this.listenTo(this.categoryData, 'update:submit:button', (function (args) {
        var selectedOne = args.filter(function (val) { return val.selected });
        if (selectedOne.length > 0) {
          this.listView.trigger('update:form:status', selectedOne[0]);
        }
        this.trigger('update:submit:button', args);
      }).bind(this));
    }
  });

  return FileUploadPanelCaptureView;

});
/**
 * @desc - Collection to hold uploaded files details
 */
csui.define('xecmpf/controls/fileuploadpanel/impl/models/fileuploadpanel.model',[
  'csui/lib/jquery',
  'csui/lib/backbone',
  'csui/utils/url',
  'csui/utils/nodesprites'],
  function ($, Backbone, Url, nodesprites) {

    /**
     * @desc - Model represents each uploaded file item
     */
    var FileUploadPanelItem = Backbone.Model.extend({
      defaults: {
        file: null,
        name: '',
        size: 0,
        iconClass: '',
        dataId: null,
        node: null
      }
    });

    /**
     * @desc - collection to hold file item models
     */
    var FileUploadPanelItemsCollection = Backbone.Collection.extend({
      constructor: function FileUploadPanelItemsCollection(options) {
        var index = 0,
          files = options.data,
          length = files.length,
          fileDetails = [];
        for (; index < length; index++) {
          fileDetails.push({
            file: files[index],
            name: files[index].name,
            size: files[index].size,
            iconClass: this.getFileTypeIconClass(files[index].type)
          });
        }
        this.options = options;
        Backbone.Collection.prototype.constructor.call(this, fileDetails);
      },
      model: FileUploadPanelItem,

      /**
       * @desc - adds file items to collection
       * @param { files | Array } - array of files 
       */
      addUploadedItems: function (files) {
        var index = 0,
          length = files.length;
        for (; index < length; index++) {
          this.add({
            file: files[index],
            name: files[index].name,
            size: files[index].size,
            iconClass: this.getFileTypeIconClass(files[index].type)
          });
        }
      },

      /**
       * @desc - removes file item model from collection
       * @param { model | Backbone.Model } - model represents file item 
       */
      removeUploadedItem: function (model) {
        this.remove(model);
      },

      /**
       * @desc - gets icon to represent file based on mime type
       * @param { type | string } - mime type
       */
      getFileTypeIconClass: function (type) {
        return nodesprites.findByNode(new Backbone.Model({ 'mime_type': type })).get('className');
      },
      getParentLocationId: function(wsId) {
        var connector = this.options.connector,
          url = Url.combine(connector.getConnectionUrl().getApiBase('v2'), '/fileupload/createtargetfolder'),
          formData,
          promise,
          that = this;
        if ( this.parentId ) {
          promise = Promise.resolve(this.parentId);
        } else {
          // makes ajax call
          promise = new Promise(function(resolve, reject) {
            
            formData = new FormData();
            formData.append('ws_id',  wsId);
            formData.append('file', that.models[0].get('file'));

            connector.makeAjaxCall({
              url: url,
              type: 'POST',
              data: formData,
              success: function (response, status, xhr) {
                if ( response && response.results.ok === true ) {
                  that.models[0].set( 'dataId', response.results.dataID );
                  that.models[0].set( 'node', response.results.node );
                  that.parentId = response.results.parentID;
                  resolve(that.parentId);
                } else {
                  reject('Upload failed');
                }
              },
              error: function(err) {
                reject((err.responseJSON && err.responseJSON.error) || 'Upload failed');
              }
            });
          });
        }
        return promise;
      },
      uploadFiles: function( wsId, parentId ) {
        var formData,
          promises = [], 
          connector = this.options.connector,
          url = Url.combine(connector.getConnectionUrl().getApiBase('v2'), '/fileupload/preupload'),
          promise;
        parentId = parentId || this.parentId || 0;
        this.models.forEach(function(model) {
          if ( !model.get('dataId') ) {
            formData = new FormData();
            formData.append('parent_id', parentId);
            formData.append('ws_id',  wsId);
            formData.append('file', model.get('file'));
            promise = new Promise(function(resolve, reject){
              connector.makeAjaxCall({
                url: url,
                type: 'POST',
                data: formData,
                success: function (response, status, xhr) {
                  if ( response && response.results.ok === true ) {
                    model.set( 'dataId', response.results.dataID );
                    model.set( 'node', response.results.node );
                  }
                },
                error: function(err) {
                  model.set('upload_err', (err.responseJSON && err.responseJSON.error) || err);
                },
                complete: function (xhr, status) {
                  resolve();
                }
              });
            });
            promises.push(promise);
          }
        });
        return Promise.all(promises);
      },
      deletePreviewDocs: function(wsId, parentId) {
        var connector = this.options.connector,
          url = Url.combine(connector.getConnectionUrl().getApiBase('v2'), '/fileupload/preupload/delete'),
          formData,
          promise,
          that = this;
        // makes ajax call
        promise = new Promise(function(resolve, reject) {
          formData = new FormData();
          formData.append('ws_id',  wsId);
          formData.append('parent_id', parentId);
          connector.makeAjaxCall({
            url: url,
            type: 'POST',
            data: formData,
            success: function (response, status, xhr) {
              if ( response && response.results.ok === true ) {
                resolve();
              } else {
                reject('Deletion failed');
              }
            },
            error: function(err) {
              reject((err.responseJSON && err.responseJSON.error) || 'Deletion failed');
            }
          });
        });
        return promise;
      }
    });
    return FileUploadPanelItemsCollection;

  });

csui.define('css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel',[],function(){});
/**
 * @desc - This view is used to open side panel view with uploaded file details
 */
csui.define('xecmpf/controls/fileuploadpanel/fileuploadpanel.view',[
  'csui/lib/underscore',
  'csui/lib/marionette',
  'csui/controls/side.panel/side.panel.view',
  'csui/dialogs/modal.alert/modal.alert',
  'csui/controls/progressblocker/blocker',
  'csui/utils/page.leaving.blocker',
  'xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.info/fileuploadpanel.info.view',
  'xecmpf/controls/fileuploadpanel/impl/fileuploadpanel.capture/fileuploadpanel.capture.view',
  'xecmpf/controls/fileuploadpanel/impl/models/fileuploadpanel.model',
  'csui/models/fileuploads',
  'csui/controls/globalmessage/globalmessage',
  'csui/utils/contexts/factories/next.node',
  'i18n!xecmpf/controls/fileuploadpanel/impl/nls/lang',
  'css!xecmpf/controls/fileuploadpanel/impl/fileuploadpanel'
], function (_, Marionette, SidePanelView, ModalAlert, BlockingView, PageLeavingBlocker, FileUploadPanelInfoView, FileUploadPanelCaptureView, FileUploadPanelItemsCollection, UploadFileCollection, GlobalMessage, NextNodeModelFactory, lang) {
  "use strict";

  var FileUploadPanelView = Marionette.ItemView.extend({
    className: 'xecmpf-file-upload-panel',
    template: _.template(''),
    constructor: function FileUploadPanelView(options) {
      options || (options = {});
      Marionette.ItemView.prototype.constructor.apply(this, arguments);
    },
    showGlobalMessage: function (progressPanelOptions, collection, sidePanel, uploadCollection) {
      collection.reset();
      sidePanel.hide();
      GlobalMessage.showProgressPanel(uploadCollection, progressPanelOptions);
    },
    /**
     * @desc - opens side panel view with uploaded files info
     * @param { files| List} - List of files uploaded
     */
    showSidePanelView: function (files, onClose) {
      var options = {
        collection: (new FileUploadPanelItemsCollection({ data: files, connector: this.options.connector })),
        connector: this.options.connector,
        context: this.options.context,
        wsNode: this.options.node
      },
        fileUploadInfoView = new FileUploadPanelInfoView(options),
        fileUploadCaptureView = new FileUploadPanelCaptureView(options),
        sidePanel;
      PageLeavingBlocker.enable();
      // confirmation message while hiding side panel view
      sidePanel = new (SidePanelView.extend({
        hide: function () {
          var that = this,
            wsId;
          if (options.collection.models.length > 0) {
            ModalAlert.confirmWarning({
              buttons: {
                labelYes: lang.yesLabel,
                labelNo: lang.noLabel
              },
              showHeader: true,
              showTitleIcon: true,
              title: lang.stopUploadConfirmation
            }).always(function (answer) {
              if (answer) {
                if (options.collection.parentId) {
                  wsId = options.wsNode ? options.wsNode.get("id") : 0;
                  options.collection.deletePreviewDocs(wsId, options.collection.parentId);
                }
                PageLeavingBlocker.disable();
                SidePanelView.prototype.hide.call(that);
                onClose && onClose();
              }
            });
          } else {
            PageLeavingBlocker.disable();
            SidePanelView.prototype.hide.call(that);
            onClose && onClose();
          }
        }
      }))({
        slides: [{
          title: lang.panelTitle,
          content: fileUploadInfoView,
          buttons: [{
            label: lang.continueButtonLabel,
            type: 'action',
            id: 'xecmpf-file-upload-panel-continue-btn',
            className: 'binf-btn binf-btn-primary xecmpf-file-upload-panel-continue-btn',
            disabled: false
          }, {
            type: 'next',
            hidden: true,
            disabled: true
          }],
          containerClass: 'xecmpf-file-upload-panel-slide-one'
        }, {
          title: lang.panelTitle,
          content: fileUploadCaptureView,
          buttons: [{
            label: lang.submitButtonLabel,
            type: 'action',
            id: 'xecmpf-file-upload-panel-submit-btn',
            className: 'binf-btn binf-btn-primary xecmpf-file-upload-panel-submit-btn',
            disabled: true
          }, {
            type: 'back',
            hidden: true,
            disabled: true
          }],
          containerClass: 'xecmpf-file-upload-panel-slide-two'
        }],
        backdrop: "sidepanel-backdrop",
        sidePanelClassName: "xecmpf-file-upload-panel",
        layout: {
          header: true,
          resize: true,
          footer: true,
          mask: true
        }
      });
      sidePanel.listenTo(fileUploadInfoView, "button:click", (function (actionButton) {
        var wsId = this.options.node ? this.options.node.get("id") : 0;
        if (actionButton.id === 'xecmpf-file-upload-panel-continue-btn') {
          fileUploadInfoView.blockActions();
          options.collection.getParentLocationId(wsId).then(function (parentId) {
            options.collection.uploadFiles(wsId, parentId).then(function () {
              fileUploadInfoView.unblockActions();
              var errEntries = options.collection.models.filter(function (model) {
                return model.get('upload_err') || false;
              });
              if (errEntries.length < options.collection.models.length) {
                sidePanel.trigger('click:next');
              } else {
                ModalAlert.showError(lang.uploadFailed);
              }
            }, function () {
              fileUploadInfoView.unblockActions();
            });
          }, function (errMsg) {
            ModalAlert.showError(errMsg);
            fileUploadInfoView.unblockActions();
          });
        }
      }).bind(this));
      
      sidePanel.listenTo(fileUploadCaptureView, "button:click", (function (actionButton) {
        var wsId = this.options.node ? this.options.node.get("id") : 0,
          progressPanelOptions = {
            originatingView: this,
            actionType: 'UPLOAD',
            allowMultipleInstances: true,
            hideGotoLocationSingleSet: true,
            hideGotoLocationMultiSet: true,
            context: this.options.context,
            nextNodeModelFactory: NextNodeModelFactory
          },
          models = options.collection.models,
          nodes = _.map(models, function (node) {
            return {
              name: node.get('name'),
              node: node
            };
          }),
          connector = options.connector,
          uploadCollection = new UploadFileCollection(nodes, { connector: connector });
        if (actionButton.id === 'xecmpf-file-upload-panel-submit-btn') {
          sidePanel.updateButton('xecmpf-file-upload-panel-submit-btn', { disabled: true });
          fileUploadCaptureView.categoryData.blockActions();
          fileUploadCaptureView.categoryData.submitDocumentDetails().then(function (response) {
            fileUploadCaptureView.categoryData.unblockActions();
            sidePanel.updateButton('xecmpf-file-upload-panel-submit-btn', { disabled: false });
            uploadCollection.models.forEach(function (val) {
              if (_.findWhere(response.results.successItems, { docId: val.get('node').get('dataId') })) {
                val.set('state', 'resolved');
              }
              else {
                val.set('state', 'rejected');
                val.set('errorMessage', _.findWhere(response.results.failedItems, { docId: val.get('node').get('dataId') }).errMsg);
              }
            });
          }, function (err) {
            fileUploadCaptureView.categoryData.unblockActions();
            sidePanel.updateButton('xecmpf-file-upload-panel-submit-btn', { disabled: false });
            uploadCollection.models.forEach(function (val) {
              val.set('state', 'rejected');
              val.set('errorMessage', lang.uploadFailed);
            });
          });
           this.showGlobalMessage(progressPanelOptions, options.collection, sidePanel, uploadCollection);
        }
      }).bind(this));

      sidePanel.listenTo(fileUploadCaptureView, "update:submit:button", (function (data) {
        var disableSubmitBtn = data.some(function (val) { return val.valid === false });
        if (disableSubmitBtn) {
          sidePanel.updateButton('xecmpf-file-upload-panel-submit-btn', { disabled: true });
        } else {
          sidePanel.updateButton('xecmpf-file-upload-panel-submit-btn', { disabled: false });
        }
      }).bind(this));

      sidePanel.listenTo(sidePanel, 'shown:slide', function (slide, slideIndex) {
        if (slideIndex === 1) {
          if (fileUploadCaptureView && fileUploadCaptureView.categoryData) {
            fileUploadCaptureView.categoryData.onUpdateSubmitButton();
            fileUploadCaptureView.listView.children.findByIndex(0).$el.click();
          }
        }
      });
      sidePanel.show();
    }
  });

  return FileUploadPanelView;

});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/fileupload/impl/fileupload.content/fileupload.content',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"xecmpf-fileupload-doc-info-section\"></div>\r\n<div class=\"xecmpf-fileupload-doc-upload-section\">\r\n  <div class=\"xecmpf-fileupload-drag-drop\">\r\n    <p title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"dragDropLabel") || (depth0 != null ? lookupProperty(depth0,"dragDropLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"dragDropLabel","hash":{},"loc":{"start":{"line":4,"column":14},"end":{"line":4,"column":31}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"dragDropLabel") || (depth0 != null ? lookupProperty(depth0,"dragDropLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"dragDropLabel","hash":{},"loc":{"start":{"line":4,"column":33},"end":{"line":4,"column":50}}}) : helper)))
    + "</p>\r\n    <div class=\"csui-type-icon xecmpf-fileupload-add-doc\" tabindex=\"0\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"uploadButtonTitle") || (depth0 != null ? lookupProperty(depth0,"uploadButtonTitle") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"uploadButtonTitle","hash":{},"loc":{"start":{"line":5,"column":78},"end":{"line":5,"column":99}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"uploadButtonAria") || (depth0 != null ? lookupProperty(depth0,"uploadButtonAria") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"uploadButtonAria","hash":{},"loc":{"start":{"line":5,"column":113},"end":{"line":5,"column":133}}}) : helper)))
    + "\" role=\"button\"></div>\r\n  </div>\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_widgets_fileupload_impl_fileupload.content_fileupload.content', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/widgets/fileupload/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  "en-us": false,
  "en": false
});
csui.define('xecmpf/widgets/fileupload/impl/nls/root/lang',{
  addDocumentLabel: "Upload document",
  allFilterLabel: 'All',
  addItem: 'Add item',
  backTitle: 'Back',
  dialogTitle: 'File upload',
  documentName: 'Document name',
  documentType: 'Document type',
  dragDropLabel: 'Drag and drop files to upload or click on the icon below',
  emptyListText: 'There are no items to display.',
  expandAria: 'Expand the fileupload widget',
  failedListText: 'Loading fileupload widget failed.',
  loadingListText: 'Loading fileupload widget...',
  locations: 'Locations',
  noDataToDisplay: 'No item to display',
  openFileUploadView: 'Open fileupload view',
  refineBy: 'Refine by',
  showFilterTitle: 'Filter',
  status: 'Status',
  uploadButtonTitle: 'Browse files',
  uploadButtonAria: 'Browse files to upload'  
});


csui.define('css!xecmpf/widgets/fileupload/impl/fileupload.content/fileupload.content',[],function(){});
/**
 * @desc - This is content view which shows categorized document information and provision to upload document
 */
csui.define('xecmpf/widgets/fileupload/impl/fileupload.content/fileupload.content.view',['csui/lib/underscore',
  'csui/lib/marionette',
  'csui/behaviors/item.error/item.error.behavior',
  'csui/controls/tile/behaviors/blocking.behavior',
  'csui/controls/tile/behaviors/perfect.scrolling.behavior',
  'csui/behaviors/keyboard.navigation/tabables.behavior',
  'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',
  'csui/dialogs/file.open/file.open.dialog',
  'xecmpf/widgets/fileupload/impl/models/fileupload.model',
  'xecmpf/widgets/fileupload/impl/fileupload.content/fileupload.info/fileupload.info.view',
  'xecmpf/controls/draganddrop/draganddrop.view',
  'xecmpf/controls/fileuploadpanel/fileuploadpanel.view',
  'hbs!xecmpf/widgets/fileupload/impl/fileupload.content/fileupload.content',
  'i18n!xecmpf/widgets/fileupload/impl/nls/lang',
  'css!xecmpf/widgets/fileupload/impl/fileupload.content/fileupload.content'],
  function (_, Marionette, ItemErrorBehavior, BlockingBehavior, PerfectScrollingBehavior,
    TabablesBehavior, LayoutViewEventsPropagationMixin, FileOpenDialog, FileUploadModel, FileUploadInfoView,
      DragAndDrop, FileUploadPanelView, FileUploadContentViewTemplate, lang) {

    var FileUploadContentView = Marionette.LayoutView.extend({
      className: 'xecmpf-file-upload-content-view',
      constructor: function FileUploadContentView(options) {
        options = options || {};
        options.model = new FileUploadModel({}, options); // initializing model to fetch doc information
        Marionette.LayoutView.prototype.constructor.call(this, options);
        this.propagateEventsToRegions();

        // blocking and unblocking based on service response
        this.listenTo(this.model, "sync", this.renderRegions);
        this.listenTo(this.model, "request", this.blockActions);
        this.listenTo(this.model, "error", this.unblockActions);
        this.model.fetch(); // triggering service call
      },
      initialize: function (options) {
        this.dragNDrop = new DragAndDrop({
          addableTypes: '144',
          context: this.options.context,
          connector: this.model.connector,
          originatingView: this
        });
        this.fileUploadPanelView = new FileUploadPanelView({
          connector: this.options.connector,
          context: this.options.context,
          node: this.options.node
        });
      },
      onRender: function () {
        this.dragNDrop.setDragParentView(this, '.xecmpf-fileupload-drag-drop');             
      },
      behaviors: {
        ItemError: {
          behaviorClass: ItemErrorBehavior
        },
        Blocking: {
          behaviorClass: BlockingBehavior
        },
        PerfectScrolling: {
          behaviorClass: PerfectScrollingBehavior,
          /*contentParent: '.xecmpf-fileupload-doc-info-section',*/ // Todo: needs to get confirmed 
          suppressScrollX: true,
          scrollYMarginOffset: 15
        },
        TabablesBehavior: {behaviorClass: TabablesBehavior,
          recursiveNavigation: true,
          containTabFocus: true
        }
      },
      currentlyFocusedElement: function () {
        return this.$el.find('.xecmpf-fileupload-add-doc');
      },
      template: FileUploadContentViewTemplate,
      templateHelpers: function () {
        return {
          dragDropLabel: lang.dragDropLabel,
          uploadButtonTitle: lang.uploadButtonTitle,
          uploadButtonAria: lang.uploadButtonAria
        }
      },
      regions: {
        docInfoRegion: '.xecmpf-fileupload-doc-info-section'
      },
      events: {
        "click .xecmpf-fileupload-add-doc": "openFileDialog",
        "keydown .xecmpf-fileupload-add-doc": "openFileDilogBykeyboard"
      },

      /**
       * @desc - It renders view in the specific region to show categorized documents (missing, outdated etc..) information
       */
      renderRegions: function () {
        this.docInfoView = new FileUploadInfoView({
          collection: this.model.get('data')
        });
        this.docInfoRegion.show(this.docInfoView);
        this.unblockActions();
      },
      openFileDilogBykeyboard: function (event){

        if (event.keyCode === 32 || event.keyCode === 13) {
          event.preventDefault();
          event.stopPropagation();
          this.openFileDialog(event);
        }
      },
      openFileDialog: function () {
        var fileOpenDialog = new FileOpenDialog({multiple: true}),
            that = this;
        fileOpenDialog.listenTo(fileOpenDialog, 'add:files', function (files) {
              fileOpenDialog.destroy();
              that.fileUploadPanelView.showSidePanelView(files, function() {
                that.model.fetch();
              });
            })
            .show();
      },
      onDrop: function(files) {
        var that = this;
        that.fileUploadPanelView.showSidePanelView(files, function() {
          that.model.fetch();
        });
      }
    });
    
    _.extend(FileUploadContentView.prototype, LayoutViewEventsPropagationMixin);

    return FileUploadContentView;
  });
/**
 * @desc - It makes /fileupload service call to fetch documents information
 */
csui.define('xecmpf/widgets/fileupload/impl/models/fileupload.detail.model',['csui/lib/underscore',
  'csui/lib/backbone',
  'csui/utils/url',
  'csui/models/mixins/connectable/connectable.mixin',
  'csui/models/mixins/fetchable/fetchable.mixin',
  'csui/models/mixins/v2.commandable/v2.commandable.mixin',
  'csui/models/browsable/browsable.mixin',
  'csui/models/browsable/v1.request.mixin',
  'csui/models/browsable/v2.response.mixin',
  'csui/models/mixins/v2.delayed.commandable/v2.delayed.commandable.mixin',
  'csui/models/browsable/client-side.mixin',
  'csui/models/nodechildrencolumn',
  'csui/models/nodechildrencolumns',
  'csui/models/node/node.model',
  'i18n!xecmpf/widgets/fileupload/impl/nls/lang'
], function (_, Backbone, Url, ConnectableMixin, FetchableMixin,
  CommandableV2Mixin,
  BrowsableMixin,
  BrowsableV1RequestMixin,
  BrowsableV2ResponseMixin,
  DelayedCommandableV2Mixin,
  ClientSideMixin,
  NodeChildrenColumnModel,
  NodeChildrenColumnCollection,
  NodeModel,
  lang) {

  'use strict';

  //The whole purpose of this class is to translate the column names that weren't localized on CS side (or didn't come from CS at all)
  var FileUploadColumnModel = NodeChildrenColumnModel.extend({

    constructor: function FileUploadColumnModel(attributes, options) {

      if (attributes && !attributes.title) {
          var columnKey = attributes.column_key;
          attributes.title = lang[columnKey];
      }
      NodeChildrenColumnModel.prototype.constructor.call(this, attributes, options);
    }

  });

  var FileUploadColumnCollection = NodeChildrenColumnCollection.extend({
    model: FileUploadColumnModel,

    constructor: function FileUploadColumnCollection(models, options) {

      if (!models) {
        models = [
          {
            key: 'classification_name',
            type: -1,
            name: lang.documentType
          },
          {
            key: 'label',
            type: -1,
            name: lang.status
          },
          {
            key: 'name',
            type: -1,
            name: lang.documentName
          },
          {
            key: 'location_name',
            type: -1,
            name: lang.locations
          }
        ];

        models.forEach(function (column, index) {
          column.definitions_order = index + 100;
          column.column_key = column.key;
        });
      }
      NodeChildrenColumnCollection.prototype.constructor.call(this, models, options);
    }
  });

  var FileUploadModel = NodeModel.extend({

    cidPrefix: 'fileupload',

    constructor: function FileUploadModel(attributes, options) {
      options || (options = {});
      if (!options.connector) {
        options.connector = options.collection && options.collection.connector || undefined;
      }
      NodeModel.prototype.constructor.apply(this, arguments);
      this.makeConnectable(options);
    }

  });

  var FileUploadCollection = Backbone.Collection.extend({
    /**
      * @desc - creating model and making it connectable and fetchable
      */
    model: FileUploadModel,

    constructor: function FileUploadCollection(attributes, options) {
      options = options || {};
      this.options = options;
      this.wsid = options.wsid ? options.wsid : 0;
      Backbone.Collection.prototype.constructor.apply(this, arguments);

      // Support collection cloning
      if (options) {
        this.options = _.pick(options, ['connector', 'autoreset', 'node',
          'includeResources', 'fields', 'expand', 'commands', 'attributes']);
      }

      this.makeConnectable(options)
          .makeFetchable(options);
      this.columns = new FileUploadColumnCollection();
    },

    clone: function () {
      // Provide the options; they may include connector and other parameters
      var clone = new this.constructor(this.models, this.options);
      // Clone sub-models not covered by Backbone
      if (this.columns) {
        clone.columns.reset(this.columns.toJSON());
      }
     
      return clone;
    },

    /**
     * @desc - generates api url
     */
    url: function (options) {
      
      var url = this.connector.getConnectionUrl().getApiBase('v2'), query = {};
      if (this.status && this.status.length >= 1) {
        query.status = this.status;
      }
      if (this.locations && this.locations.length >= 1) {
        query.locations = this.locations;
      }
      query = Url.combineQueryString(query);

      var path = '/businessworkspaces/' + this.wsid + '/fileupload';

      url = Url.combine(url, path);
      url = Url.appendQuery(url, query);
      
      return url;
      //return Url.combine(this.connector.getConnectionUrl().getApiBase('v2'), '/businessworkspaces/90714/fileupload');
    },

    /**
     * @desc - parses response from service and creates a collection for data attribute in the model
     */
    parse: function (response) {
      var docTypeData = [], index;
      for(index = 0; index < response.results.data.length; index++){
        var docTypeGrp = response.results.data[index].data;
        var key = response.results.data[index].key;
        var icon = response.results.data[index].icon;
        var label = response.results.data[index].label;
        var count = response.results.data[index].count;
        for(var i = 0; i < docTypeGrp.length; i++){
          var docType = docTypeGrp[i];
          docType.key = key;
          docType.icon = icon;
          docType.label = label;
          docType.count = count;
          docTypeData.push(docType);
        }
      }
      return docTypeData;
    },

    fetch: function () {
      return Backbone.Collection.prototype.fetch.apply(this, arguments);
    }
  });

  ConnectableMixin.mixin(FileUploadCollection.prototype);
  FetchableMixin.mixin(FileUploadCollection.prototype);
  BrowsableMixin.mixin(FileUploadCollection.prototype);
  BrowsableV1RequestMixin.mixin(FileUploadCollection.prototype);
  BrowsableV2ResponseMixin.mixin(FileUploadCollection.prototype);
  CommandableV2Mixin.mixin(FileUploadCollection.prototype);
  DelayedCommandableV2Mixin.mixin(FileUploadCollection.prototype);
  ClientSideMixin.mixin(FileUploadCollection.prototype);

  return FileUploadCollection;
});
csui.define('xecmpf/widgets/fileupload/impl/factory/fileupload.collection.factory',['module', 'csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/backbone',
    'csui/utils/contexts/factories/factory', 'csui/utils/contexts/factories/connector',
    'csui/utils/contexts/factories/node',
    'xecmpf/widgets/fileupload/impl/models/fileupload.detail.model'
], function (module, _, $, Backbone, CollectionFactory, ConnectorFactory,
    NodeModelFactory, FileUploadCollection) {
    'use strict';

    var FileUploadCollectionFactory = CollectionFactory.extend({

        propertyPrefix: 'fileupload',

        constructor: function FileUploadCollectionFactory(context, options) {
            CollectionFactory.prototype.constructor.apply(this, arguments);

            var wsid = context.options.wsid;
            var fileupload = this.options.fileupload || {};
            if (!(fileupload instanceof Backbone.Collection)) {
                var connector = context.getObject(ConnectorFactory, options),
                    node = context.getModel(NodeModelFactory, options),
                    config = module.config();                   
                fileupload = new FileUploadCollection(fileupload.models, _.extend({
                    node: node,
                    connector: connector
                }, options, config.options,
                    { autoreset: true, status: status,wsid: context.wsid}));
            }

            this.property = fileupload;
        },

        fetch: function (options) {
            return this.property.fetch(options);
        }

    });

    return FileUploadCollectionFactory;

});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/fileupload/impl/fileuploadexpandicon',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"tile-icon xecmpf-file-upload-expand\" tabindex=\"0\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"expandArea") || (depth0 != null ? lookupProperty(depth0,"expandArea") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"expandArea","hash":{},"loc":{"start":{"line":1,"column":74},"end":{"line":1,"column":88}}}) : helper)))
    + "\" role=\"button\" title="
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"titleExpand") || (depth0 != null ? lookupProperty(depth0,"titleExpand") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"titleExpand","hash":{},"loc":{"start":{"line":1,"column":110},"end":{"line":1,"column":125}}}) : helper)))
    + ">\r\n  "
    + ((stack1 = (lookupProperty(helpers,"icon-v2")||(depth0 && lookupProperty(depth0,"icon-v2"))||container.hooks.helperMissing).call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"icon-v2","hash":{"states":"true","iconName":"csui_action_expand32"},"loc":{"start":{"line":2,"column":2},"end":{"line":2,"column":61}}})) != null ? stack1 : "")
    + "\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_widgets_fileupload_impl_fileuploadexpandicon', t);
return t;
});
/* END_TEMPLATE */
;

csui.define('css!xecmpf/widgets/fileupload/impl/fileupload',[],function(){});
/**
 * @desc - File upload widget shows count of missing and outdated documents and also contains provision to upload 
 * document. It shows other category documents information based on other modules installed.
 */
csui.define('xecmpf/widgets/fileupload/fileupload.view',['csui/lib/underscore',
  'csui/lib/marionette',
  'csui/utils/base',
  'csui/controls/tile/tile.view',
  'csui/utils/contexts/factories/connector',
  'csui/utils/contexts/factories/node',
  'conws/models/workspacecontext/workspacecontext.factory',
  'csui/utils/contexts/factories/application.scope.factory',
  'xecmpf/widgets/fileupload/impl/fileupload.content/fileupload.content.view',
  'xecmpf/widgets/fileupload/impl/factory/fileupload.collection.factory',
  'csui/behaviors/keyboard.navigation/tabables.behavior',
  'hbs!xecmpf/widgets/fileupload/impl/fileuploadexpandicon',
  'i18n!xecmpf/widgets/fileupload/impl/nls/lang',
  'css!xecmpf/widgets/fileupload/impl/fileupload'], function (_, Marionette, base, TileView, ConnectorFactory,
    NodeModelFactory, WorkspaceContextFactory, ApplicationScopeModelFactory, 
    FileUploadContentView, FileUploadFactory, TabablesBehavior, ExpandBtn, lang) {

  var FileUploadView = TileView.extend({
    className: TileView.prototype.className + ' xecmpf-file-upload',
    
    ui: {
      fileuploadExpandViewBtn: ".xecmpf-file-upload-expand" 
    },
    events: {
      'click @ui.fileuploadExpandViewBtn': 'onClickExpand',
      'keydown @ui.fileuploadExpandViewBtn': 'doClickOnEnter'
    },
    constructor: function FileUploadView(options) {
      options = options || {};
      if (!options.context) {
        throw new Error("Context is not available");
      }
      options.title = this._getTitle();
      options.icon = 'xecmpf-fileupload-title-icon';
      options.connector = options.context.getObject(ConnectorFactory);
      if (!options.workspaceContext) {
        options.workspaceContext = options.context.getObject(WorkspaceContextFactory);
      }
      options.node = options.context.getModel(NodeModelFactory);
      options.workspaceContext.setWorkspaceSpecific(FileUploadFactory);
      TileView.prototype.constructor.call(this, options);
      this.applicationScope = options.context.getModel(ApplicationScopeModelFactory);
    },
    contentView: FileUploadContentView,
    contentViewOptions: function () {
      return {
        context: this.options.context,
        connector: this.options.connector,
        node: this.options.node
      };
    },
    behaviors: {
      TabablesBehavior: {behaviorClass: TabablesBehavior,
        recursiveNavigation: true,
        containTabFocus: true
      }
    },
    currentlyFocusedElement: function () {
      return this.$el.find('.xecmpf-file-upload-expand');
    },
    onBeforeShow: function () {
      this.$('.tile-controls').html(ExpandBtn({
        titleExpand: lang.expand || "Expand",
        expandArea: lang.expandArea || "Expand FileUpload Widget"
      }))
    },
    onClickExpand: function (event) {
      event.preventDefault();
      event.stopPropagation();
      this.triggerMethod('expand');
      this.onClickOpenPerspective();
    },
    /**
     * @desc - It trigger click event on press of space or tab
     */
    doClickOnEnter: function (event) {
      if (event.keyCode === 32 || event.keyCode === 13) {
        event.preventDefault();
        event.stopPropagation();
        this.triggerMethod('expand');
        this.onClickOpenPerspective();
      }
    },

    onClickOpenPerspective: function () {

      if( this.options.context ) {
        this.options.context.wsid = this.options.node? this.options.node.get("id") : 0;
      }
      
      this.applicationScope.set('id', 'fileupload');      
      this.trigger('open:fileupload:perspective');
    },

    /**
     * @desc - getting title from perspective data
     */

    _getTitle: function () {
      var title = lang.dialogTitle;
      if (this.options.data && this.options.data.title) {
        title = base.getClosestLocalizedString(this.options.data.title, lang.dialogTitle);
      }
      return title;
    }
  });
  return FileUploadView;
});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.header',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"cs-back-button-container\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"backTitle") || (depth0 != null ? lookupProperty(depth0,"backTitle") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"backTitle","hash":{},"loc":{"start":{"line":1,"column":45},"end":{"line":1,"column":58}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"backTitle") || (depth0 != null ? lookupProperty(depth0,"backTitle") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"backTitle","hash":{},"loc":{"start":{"line":1,"column":72},"end":{"line":1,"column":85}}}) : helper)))
    + "\" tabindex=\"0\" role=\"button\">\r\n    <span class=\"arrow_back cs-go-back action-element\"></span>\r\n</div>\r\n<div class=\"cs-add-icon-container\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"addItem") || (depth0 != null ? lookupProperty(depth0,"addItem") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"addItem","hash":{},"loc":{"start":{"line":4,"column":42},"end":{"line":4,"column":53}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"addItem") || (depth0 != null ? lookupProperty(depth0,"addItem") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"addItem","hash":{},"loc":{"start":{"line":4,"column":67},"end":{"line":4,"column":78}}}) : helper)))
    + "\" tabindex=\"0\" role=\"button\">\r\n    <ul class=\"csui-toolbar binf-nav binf-nav-pills csui-align-left\">\r\n        <li class=\"binf-dropdown csui-wrapper csui-more-dropdown-wrapper\">\r\n            <a href=\"#\" class=\"binf-dropdown-toggle csui-acc-focusable\" data-binf-toggle=\"dropdown\"\r\n                aria-expanded=\"false\" aria-haspopup=\"true\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"addItem") || (depth0 != null ? lookupProperty(depth0,"addItem") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"addItem","hash":{},"loc":{"start":{"line":8,"column":66},"end":{"line":8,"column":77}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"addItem") || (depth0 != null ? lookupProperty(depth0,"addItem") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"addItem","hash":{},"loc":{"start":{"line":8,"column":91},"end":{"line":8,"column":102}}}) : helper)))
    + "\">\r\n                <span class=\"icon icon-toolbarAdd\"></span>\r\n            </a>\r\n            <ul class=\"binf-dropdown-menu csui-more-dropdown-menu\" role=\"menu\">\r\n                <li data-csui-command=\""
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"title") : depth0), depth0))
    + "\" role=\"menuitem\" class=\"xecmpf-fileupload-upload-btn\"><a href=\"#\"\r\n                        class=\"csui-toolitem\" data-cstabindex=\"-1\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"addDocumentLabel") || (depth0 != null ? lookupProperty(depth0,"addDocumentLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"addDocumentLabel","hash":{},"loc":{"start":{"line":13,"column":74},"end":{"line":13,"column":94}}}) : helper)))
    + "\"\r\n                        tabindex=\"-1\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"addDocumentLabel") || (depth0 != null ? lookupProperty(depth0,"addDocumentLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"addDocumentLabel","hash":{},"loc":{"start":{"line":14,"column":38},"end":{"line":14,"column":58}}}) : helper)))
    + "</a>\r\n                </li>\r\n            </ul>\r\n        </li>\r\n    </ul>\r\n</div>\r\n<div class=\"cs-filter-icon-container\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"filterTitle") || (depth0 != null ? lookupProperty(depth0,"filterTitle") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"filterTitle","hash":{},"loc":{"start":{"line":20,"column":45},"end":{"line":20,"column":60}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"filterTitle") || (depth0 != null ? lookupProperty(depth0,"filterTitle") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"filterTitle","hash":{},"loc":{"start":{"line":20,"column":74},"end":{"line":20,"column":89}}}) : helper)))
    + "\" tabindex=\"0\" role=\"button\">\r\n    <span\r\n        class=\"tile-type-action-icon cs-icon-left icon-toolbarFilter tile-filter-icon csui-acc-focusable-active action-element fileupload-filter-icon\"></span>\r\n</div>\r\n<div class=\"cs-title-container\">\r\n    <div class=\"cs-title-inner-container\">\r\n        <span class=\"title-icon "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"icon") || (depth0 != null ? lookupProperty(depth0,"icon") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"icon","hash":{},"loc":{"start":{"line":26,"column":32},"end":{"line":26,"column":40}}}) : helper)))
    + "\"></span>\r\n        <h2 class=\"title\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"title") || (depth0 != null ? lookupProperty(depth0,"title") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"title","hash":{},"loc":{"start":{"line":27,"column":26},"end":{"line":27,"column":35}}}) : helper)))
    + "</h2>\r\n    </div>\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_widgets_fileupload_impl_fileupload.expand_fileupload.header', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.header.view',[
    'csui/lib/underscore',
    'csui/lib/jquery',
    'csui/lib/marionette',
    'csui/controls/perspective.header/perspective.header.view',
    'csui/dialogs/file.open/file.open.dialog',
    'xecmpf/controls/fileuploadpanel/fileuploadpanel.view',
    'hbs!xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.header',
    'i18n!xecmpf/widgets/fileupload/impl/nls/lang',
    'css!xecmpf/widgets/fileupload/impl/fileupload'
], function (_, $, Marionette, PerspectiveHeaderView, FileOpenDialog, FileUploadPanelView, headerTemplate, lang) {

    var FileUploadPerspectiveHeaderView = PerspectiveHeaderView.extend({
        template: headerTemplate,
        templateHelpers: function () {
            return {
                filterTitle: lang.showFilterTitle,
                backTitle: lang.backTitle,
                icon: this.options.icon,
                title: this.options.title,
                addTitle: lang.addTitle,
                addItem: lang.addItem,
                addDocumentLabel: lang.addDocumentLabel
            };
        },
        events: {
          'click .xecmpf-fileupload-upload-btn': 'onUploadBtnClick'
        },
        constructor: function FileUploadPerspectiveHeaderView(options) {
            PerspectiveHeaderView.prototype.constructor.apply(this, arguments);
            this.fileUploadPanelView = new FileUploadPanelView({
              connector: this.options.connector,
              context: this.options.context,
              node: this.options.node
            });
        },
        onKeyInView: function (event) {
            if (event.keyCode === 32 || event.keyCode === 13) {
                $(event.target).find(".action-element").click();
                $(event.target).focus();
            }
        },
        onUploadBtnClick: function () {
          var fileOpenDialog = new FileOpenDialog({multiple: true});
          fileOpenDialog.listenTo(fileOpenDialog, 'add:files', (function (files) {
                // TODO: Actual implementation as part of upload
                console.log("Number of files uploaded ", files.length);
                fileOpenDialog.destroy();
                this.fileUploadPanelView.showSidePanelView(files);
              }).bind(this))
              .show();
        }
    });
    return FileUploadPerspectiveHeaderView;

});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.filter',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "                <span class=\"xecmpf-fileupload-status-missingcount\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"missingCount") || (depth0 != null ? lookupProperty(depth0,"missingCount") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"missingCount","hash":{},"loc":{"start":{"line":24,"column":68},"end":{"line":24,"column":84}}}) : helper)))
    + "</span>\r\n";
},"3":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "                <span class=\"xecmpf-fileupload-status-outdatedcount\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"outDatedCount") || (depth0 != null ? lookupProperty(depth0,"outDatedCount") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"outDatedCount","hash":{},"loc":{"start":{"line":34,"column":69},"end":{"line":34,"column":86}}}) : helper)))
    + "</span>\r\n";
},"5":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "                <span class=\"xecmpf-fileupload-status-inprocesscount\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"inProcessCount") || (depth0 != null ? lookupProperty(depth0,"inProcessCount") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"inProcessCount","hash":{},"loc":{"start":{"line":44,"column":70},"end":{"line":44,"column":88}}}) : helper)))
    + "</span>\r\n";
},"7":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "        <div class=\"location-filter csui-selected-checkbox csui-checkbox-primary\">\r\n            <input id = \""
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "\" name = \""
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\" type=\"checkbox\" class=\"xecmpf-fileupload-location-name\" tabindex=\"-1\" ></input>\r\n            <label for=\""
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "</label>\r\n            <span class=\"fileupload-location-count\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"count") : depth0), depth0))
    + "</span>\r\n        </div>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"filerupload-panel-heading\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"headerFilterTitle") || (depth0 != null ? lookupProperty(depth0,"headerFilterTitle") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"headerFilterTitle","hash":{},"loc":{"start":{"line":1,"column":46},"end":{"line":1,"column":67}}}) : helper)))
    + "\">\r\n    "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"headerFilterTitle") || (depth0 != null ? lookupProperty(depth0,"headerFilterTitle") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"headerFilterTitle","hash":{},"loc":{"start":{"line":2,"column":4},"end":{"line":2,"column":25}}}) : helper)))
    + "\r\n</div>\r\n\r\n<div class=\"fileupload-filter-body\">\r\n\r\n    <div class=\"csui-facet-header fileupload-header-filter\">\r\n        <div class=\"fileupload-status-filter header-label\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"status") || (depth0 != null ? lookupProperty(depth0,"status") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"status","hash":{},"loc":{"start":{"line":8,"column":59},"end":{"line":8,"column":69}}}) : helper)))
    + "</div>\r\n        <div class=\"cs-icon csui-button-icon icon-expandArrowUp fileupload-status-toggle fileupload-status-show\" role=\"button\" title=\"Hide facet\" aria-label=\"Hide facet\" tabindex=\"-1\"></div>\r\n    </div>\r\n    <div class=\"fileupload-status-content\">\r\n        <div class=\"status-filter fileupload-status-header csui-selected-checkbox csui-checkbox-primary\">\r\n            <input id=\"selectAll\" type=\"checkbox\" class=\"All\" tabindex=\"-1\" "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"checkedAll") || (depth0 != null ? lookupProperty(depth0,"checkedAll") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"checkedAll","hash":{},"loc":{"start":{"line":13,"column":76},"end":{"line":13,"column":90}}}) : helper)))
    + "></input>\r\n                <label for=\"selectAll\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"allFilterLabel") || (depth0 != null ? lookupProperty(depth0,"allFilterLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"allFilterLabel","hash":{},"loc":{"start":{"line":14,"column":39},"end":{"line":14,"column":57}}}) : helper)))
    + "</label>\r\n            <span class=\"fileupload-allcount\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"totcalCount") || (depth0 != null ? lookupProperty(depth0,"totcalCount") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"totcalCount","hash":{},"loc":{"start":{"line":15,"column":46},"end":{"line":15,"column":61}}}) : helper)))
    + "</span>\r\n        </div>\r\n\r\n        <div class=\"fileupload-status-body\">\r\n           \r\n            <div class=\"status-filter csui-selected-checkbox csui-checkbox-primary\">\r\n                <input id=\"xecmpf-fileupload-status-missing\" type=\"checkbox\" class=\"fileupload-status\" tabindex=\"-1\" "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"checkedMissing") || (depth0 != null ? lookupProperty(depth0,"checkedMissing") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"checkedMissing","hash":{},"loc":{"start":{"line":21,"column":117},"end":{"line":21,"column":135}}}) : helper)))
    + "></input>\r\n                <label for=\"xecmpf-fileupload-status-missing\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"missing") || (depth0 != null ? lookupProperty(depth0,"missing") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"missing","hash":{},"loc":{"start":{"line":22,"column":62},"end":{"line":22,"column":73}}}) : helper)))
    + "</label>\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"checkedMissing") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"loc":{"start":{"line":23,"column":16},"end":{"line":25,"column":23}}})) != null ? stack1 : "")
    + "            </div>\r\n            \r\n\r\n            \r\n            <div class=\"status-filter csui-selected-checkbox csui-checkbox-primary\">\r\n                <input id=\"xecmpf-fileupload-status-outDated\" type=\"checkbox\" class=\"fileupload-status\" tabindex=\"-1\" "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"checkedOutdated") || (depth0 != null ? lookupProperty(depth0,"checkedOutdated") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"checkedOutdated","hash":{},"loc":{"start":{"line":31,"column":118},"end":{"line":31,"column":137}}}) : helper)))
    + "></input>\r\n                <label for=\"xecmpf-fileupload-status-outDated\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"outDated") || (depth0 != null ? lookupProperty(depth0,"outDated") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"outDated","hash":{},"loc":{"start":{"line":32,"column":63},"end":{"line":32,"column":75}}}) : helper)))
    + "</label>\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"checkedOutdated") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"loc":{"start":{"line":33,"column":16},"end":{"line":35,"column":23}}})) != null ? stack1 : "")
    + "            </div>\r\n            \r\n\r\n            \r\n            <div class=\"status-filter csui-selected-checkbox csui-checkbox-primary\">\r\n                <input id=\"xecmpf-fileupload-status-inprocess\" type=\"checkbox\" class=\"fileupload-status\" tabindex=\"-1\" "
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"checkedInProcess") || (depth0 != null ? lookupProperty(depth0,"checkedInProcess") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"checkedInProcess","hash":{},"loc":{"start":{"line":41,"column":119},"end":{"line":41,"column":139}}}) : helper)))
    + "></input>\r\n                <label for=\"xecmpf-fileupload-status-inprocess\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"inProcess") || (depth0 != null ? lookupProperty(depth0,"inProcess") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"inProcess","hash":{},"loc":{"start":{"line":42,"column":64},"end":{"line":42,"column":77}}}) : helper)))
    + "</label>\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"checkedInProcess") : depth0),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"loc":{"start":{"line":43,"column":16},"end":{"line":45,"column":23}}})) != null ? stack1 : "")
    + "            </div>\r\n          \r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"csui-facet-header fileupload-header-filter\">\r\n        <div class=\"fileupload-locations-filter header-label\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"locations") || (depth0 != null ? lookupProperty(depth0,"locations") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"locations","hash":{},"loc":{"start":{"line":52,"column":62},"end":{"line":52,"column":75}}}) : helper)))
    + "</div>\r\n        <div class=\"cs-icon csui-button-icon icon-expandArrowUp fileupload-locations-toggle fileupload-locations-show\" role=\"button\" title=\"Hide facet\" aria-label=\"Hide facet\" tabindex=\"-1\"></div>\r\n    </div>\r\n    <div class=\"fileupload-location-body\">\r\n"
    + ((stack1 = lookupProperty(helpers,"each").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"locArray") : depth0),{"name":"each","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"loc":{"start":{"line":56,"column":8},"end":{"line":62,"column":17}}})) != null ? stack1 : "")
    + "    </div>\r\n\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_widgets_fileupload_impl_fileupload.expand_fileupload.filter', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.filter.view',[
    'csui/lib/marionette',
    'csui/lib/underscore',
    'csui/lib/jquery',
    'csui/behaviors/keyboard.navigation/tabable.region.behavior',
    'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',
    'xecmpf/widgets/fileupload/impl/factory/fileupload.collection.factory',
    'hbs!xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.filter',
    'i18n!xecmpf/widgets/fileupload/impl/nls/lang',
    'css!xecmpf/widgets/fileupload/impl/fileupload'
], function (Marionette, _, $, TabableRegionBehavior, LayoutViewEventsPropagationMixin,
    FileUploadCollectionFactory, template, lang) {

    'use strict';

    var FileUploadFilterView = Marionette.LayoutView.extend({

        template: template,

        templateHelpers: function () {
            var completeCollection = this.model.models,
                totcalCount = 0, missing = "Missing", missingCount, outDated = "Outdated", outDatedCount,
                inProcess = "In Process", inProcessCount,
                locationID, locName, checkedAll = '', checkedMissing = '', checkedOutdated = '', checkedInProcess = '',
                checked = "checked", grpByLocation = [];
                
            completeCollection.forEach(function (item) {
                var alreadyExists = false;
                switch(item.get('status')) {
                    case "missingDocuments":
                        missing = item.get('label');
                        missingCount = item.get('count')
                        totcalCount = totcalCount + 1;
                        checkedMissing = checked;
                    break;

                    case "outdatedDocuments":
                        outDated = item.get('label');
                        outDatedCount = item.get('count');
                        totcalCount = totcalCount + 1;
                        checkedOutdated = checked;
                    break;

                    case "inprocessDocuments":
                        inProcess = item.get('label');
                        inProcessCount = item.get('count');
                        totcalCount = totcalCount + 1;
                        checkedInProcess = checked;                        
                    break;
                }

                locationID = item.get('location_id');
                locName = item.get('location_name')
                grpByLocation.forEach(function (loc) {
                    if (loc.id === locationID) {
                        alreadyExists = true;
                        loc.count = loc.count + 1;
                        return;
                    }
                });
                if (!alreadyExists) {
                    grpByLocation.push({
                        name: locName,
                        count: 1,
                        id: locationID
                    });
                }
            });
            if ( checkedMissing === checked && checkedOutdated === checked && checkedInProcess === checked){

                checkedAll = checked;
            }
            return {
                headerFilterTitle: lang.refineBy,
                status: lang.status,
                locations: lang.locations,
                totcalCount: totcalCount,
                inProcess: inProcess,
                outDated: outDated,
                missing: missing,
                checkedMissing: checkedMissing,
                checkedOutdated: checkedOutdated,
                checkedInProcess: checkedInProcess,
                allFilterLabel: lang.allFilterLabel,
                inProcessCount: inProcessCount,
                outDatedCount: outDatedCount,
                missingCount: missingCount,
                locArray: grpByLocation,
                checked: checked,
                checkedAll: checkedAll
            };
        },

        constructor: function FileUploadFilterView(options) {
            this.options = options;
            this.completeCollection = this.options.context.getCollection(FileUploadCollectionFactory)
            Marionette.LayoutView.prototype.constructor.apply(this, arguments);
            this.propagateEventsToRegions();
        },

        initialize: function () {
            var self = this;
            this.model = this.options.context.getModel(FileUploadCollectionFactory);
            this.model.on("sync", function () {
                self.render();
            });
        },

        events: {
            'click #selectAll': 'toggleCheckBoxAll',
            'click .fileupload-status': 'toggleSelection',
            'click .xecmpf-fileupload-location-name': 'toggleSelection',
            'keydown': 'onKeyInView',
            'click .fileupload-status-toggle': 'toggleStatus',
            'click .fileupload-locations-toggle': 'toggleLocation'
        },

        behaviors: {
            TabableBehavior: {
                behaviorClass: TabableRegionBehavior
            }
        },

        isTabable: function () {
            return this.$('*[tabindex]').length > 0;
        },

        currentlyFocusedElement: function (event) {
            var tabElements = this.$('*[tabindex]:visible');

            if (tabElements.length) {
                tabElements.prop('tabindex', 0);
            }

            if (!!event && event.shiftKey) {
                return $(tabElements[tabElements.length - 1]);
            }
            else {
                return $(tabElements[0]);
            }
        },

        onKeyInView: function (event) {
            if (event.keyCode === 13 || event.keyCode === 32) {
                event.currentTarget = event.target.parentNode;
                this.toggleSelection(event);
            }
        },

        toggleCheckBoxAll: function (event) {
            var statusList = this.options.extendedView.completeCollection ? this.options.extendedView.completeCollection.status : [];
            
            if (this.$el.find("[id='selectAll']:checked").length === 1) {
                $('.status-filter input:not(:checked)').each(function () {
                    $(this).prop("checked", true).trigger('change');
                    if (this.id === "xecmpf-fileupload-status-missing") {
                        statusList.push("missingDocuments");
                    } else if (this.id === "xecmpf-fileupload-status-outDated") {
                        statusList.push("outdatedDocuments");
                    } else if (this.id === "xecmpf-fileupload-status-inprocess") {
                        statusList.push("inprocessDocuments");
                    }
                    
                });
            } else {
                $('.status-filter input:checked').each(function () {
                    $(this).prop("checked", false).trigger('change');
                });
            }

            var parentView = this.options.extendedView;
            parentView.completeCollection.status = statusList;
            parentView.completeCollection.locations = null;
            parentView.completeCollection.resetLimit();
            parentView.completeCollection.fetch({ reload: true });
            
        },

        toggleStatus: function (event) {
            var statusToggle = $('.fileupload-status-toggle');
            if (statusToggle.hasClass('fileupload-status-show')) {
                $('.fileupload-status-content').hide();
                statusToggle.removeClass('fileupload-status-show');
                statusToggle.addClass('fileupload-status-hide');
                statusToggle.removeClass('icon-expandArrowUp');
                statusToggle.addClass('icon-expandArrowDown');
            } else if (statusToggle.hasClass('fileupload-status-hide')) {
                $('.fileupload-status-content').show();
                statusToggle.removeClass('fileupload-status-hide');
                statusToggle.addClass('fileupload-status-show');
                statusToggle.removeClass('icon-expandArrowDown');
                statusToggle.addClass('icon-expandArrowUp');
            }
        },

        toggleLocation: function (event) {
            var locationTaggle = $('.fileupload-locations-toggle');
            if (locationTaggle.hasClass('fileupload-locations-show')) {
                $('.fileupload-location-body').hide();
                locationTaggle.removeClass('fileupload-locations-show');
                locationTaggle.addClass('fileupload-locations-hide');
                locationTaggle.removeClass('icon-expandArrowUp');
                locationTaggle.addClass('icon-expandArrowDown');
            } else if (locationTaggle.hasClass('fileupload-locations-hide')) {
                $('.fileupload-location-body').show();
                locationTaggle.removeClass('fileupload-locations-hide');
                locationTaggle.addClass('fileupload-locations-show');
                locationTaggle.removeClass('icon-expandArrowDown');
                locationTaggle.addClass('icon-expandArrowUp');
            }
        },

        toggleSelection: function (event) {
            var statusList = [], locationList = [];
            if ($('.fileupload-status-body .csui-selected-checkbox input:not(:checked)').length > 0) {
                $('.fileupload-status-body .csui-selected-checkbox input:checked').each(function () {
                    var id = this.id;
                    if (id === "xecmpf-fileupload-status-missing") {
                        statusList.push("missingDocuments");
                    } else if (id === "xecmpf-fileupload-status-outDated") {
                        statusList.push("outdatedDocuments");
                    } else if (id === "xecmpf-fileupload-status-inprocess") {
                        statusList.push("inprocessDocuments");
                    }
                });
                event.data = statusList;
                $('#selectAll').prop("checked", false).trigger('change');
            } else {
                $('#selectAll').prop("checked", true).trigger('change');
            }

            $('.fileupload-location-body .csui-selected-checkbox input:checked').each(function () {
                if (this.name) {
                    locationList.push(this.name);
                }
            });

            //this.filterTableData({ statusList: statusList, locationList: locationList });
            
            var parentView = this.options.extendedView;
            parentView.completeCollection.status = statusList;
            if(event.currentTarget.className === "xecmpf-fileupload-location-name"){
                parentView.completeCollection.locations = locationList;            
            } else {
                parentView.completeCollection.locations = null;
            }
            parentView.completeCollection.resetLimit();
            parentView.completeCollection.fetch({ reload: true });
            
        },

        filterTableData: function (filterCriteria) {
            var statusList = filterCriteria.statusList;
            var locationList = filterCriteria.locationList, i;
            
            var completeCollection = this.model.models;
            var filteredData = [];

            completeCollection.forEach(function (item) {
                var statusOK = false;
                var locationOK = false;
                var itemStatus = item.get('status');
                var itemLoc = item.get('location_id');
                var i;

                if (statusList && statusList.length > 0) {
                    for (i = 0; i < statusList.length; i++) {
                        if (itemStatus === statusList[i]) {
                            statusOK = true;
                            break;
                        }

                    }
                } else {
                    statusOK = true;
                }

                if (locationList && locationList.length > 0) {
                    for (i = 0; i < locationList.length; i++) {
                        if (itemLoc === locationList[i]) {
                            locationOK = true;
                            break;
                        }
                    }
                } else {
                    locationOK = true;
                }


                if (statusOK && locationOK) {
                    filteredData.push(item);
                }
            });

            return filteredData;
        }
    });

    _.extend(FileUploadFilterView.prototype, LayoutViewEventsPropagationMixin);
    return FileUploadFilterView;
});
csui.define('xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.toolbaritems',['csui/lib/underscore',
  'csui/controls/toolbar/toolitems.factory'
], function (_, ToolItemsFactory) {
  'use strict';
  var toolbarItems = {

    // inline action bar
    inlineActionbar: new ToolItemsFactory({
    
    })
  };

  return toolbarItems;

});

csui.define('xecmpf/widgets/fileupload/impl/factory/fileupload.column.factory',['module', 'csui/lib/underscore', 'csui/lib/backbone',
    'csui/utils/contexts/factories/factory', 
    'xecmpf/widgets/fileupload/impl/factory/fileupload.collection.factory',
], function (module, _, Backbone, CollectionFactory, FileUploadCollectionFactory) {

    "use strict";

    var ColumnsCollectionFactory = CollectionFactory.extend({

        propertyPrefix: 'fileupload_columns',

        constructor: function ColumnsCollectionFactory(context, options) {
            CollectionFactory.prototype.constructor.apply(this, arguments);

            var columns = this.options.columns || {};
            if (!(columns instanceof Backbone.Collection)) {
                var children = context.getCollection(FileUploadCollectionFactory, options);
                columns = children.columns;
            }
            this.property = columns;
        }

    });

    return ColumnsCollectionFactory;

});

csui.define('xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.columns',[
    'csui/lib/backbone',
    'i18n!xecmpf/widgets/fileupload/impl/nls/lang',
], function (Backbone, lang) {

    var TableColumnModel = Backbone.Model.extend({

        idAttribute: 'key',

        defaults: {
            key: null,  // key from the resource definitions
            sequence: 0 // smaller number moves the column to the front
        }

    });

    var TableColumnCollection = Backbone.Collection.extend({

        model: TableColumnModel,

        comparator: 'sequence',

        getColumnKeys: function () {
            return this.pluck('key');
        },

        deepClone: function () {
            return new TableColumnCollection(
                this.map(function (column) {
                    return column.attributes;
                }));
        }
    });

    var tableColumns = new TableColumnCollection([
        {
            key: 'classification_name',
            title: lang.documentType,
            sequence: 10,
            position: 'absolute',
            widthFactor: 0.7
        },
        {
            key: 'label',
            align: 'left',
            title: lang.status,
            sequence: 30,
            widthFactor: 0.7
        },
        {
            key: 'name',
            align: 'left',
            title: lang.documentName,
            sequence: 40,
            widthFactor: 0.7
        },
        {
            key: 'location_name',
            align: 'left',
            title: lang.locations,
            sequence: 50,
            widthFactor: 0.7
        }

    ]);

    return tableColumns;

});
csui.define('xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.table.view',[
    'module', 'csui/lib/jquery', 'csui/lib/underscore',
    'csui/utils/accessibility',
    'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',
    'csui/widgets/nodestable/nodestable.view',
    'csui/controls/mixins/view.state/multi.node.fetch.mixin',
    'xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.toolbaritems',
    'xecmpf/widgets/fileupload/impl/factory/fileupload.column.factory',
    'xecmpf/widgets/fileupload/impl/factory/fileupload.collection.factory',
    'xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.columns',    
    'xecmpf/controls/table/cells/statusicon.view',
    'xecmpf/controls/table/cells/location.cell.view',
	'i18n!xecmpf/widgets/fileupload/impl/nls/lang',
    'css!xecmpf/widgets/fileupload/impl/fileupload'
], function (module, $, _, Accessibility, LayoutViewEventsPropagationMixin,
    NodesTable, MultiNodeFetchMixin, toolbarItems, FileUploadColumnFactory,
    FileUploadCollectionFactory, 
    FileUploadTableColumns, 
    lang) {

    'use strict';

    var accessibleTable = Accessibility.isAccessibleTable();

    var FileUploadTableView = NodesTable.extend({
        constructor: function FileUploadTableView(options) {
            _.defaults(options, {
                toolbarItems: toolbarItems
              });
            NodesTable.prototype.constructor.apply(this, arguments);

            this.propagateEventsToRegions();
        },

        template: _.template(""),

        initialize: function () {
            this.columns = this.context.getCollection(FileUploadColumnFactory);
            this.collection = this.context.getCollection(FileUploadCollectionFactory);
            _.defaults(this.options, {
                orderBy: 'classification_name asc',
                tableColumns: FileUploadTableColumns,
                urlParamsList: []
            });

            this.initSelectionMixin(this.options, this.collection);

            this.setTableView({
                nameEdit: false,
                selectRows: "none",
                selectColumn: false,
                orderBy: this.options.orderBy,
                haveDetailsRowExpandCollapseColumn: true,
                tableColumns: this.options.tableColumns,
                tableTexts: {
                    zeroRecords: lang.noDataToDisplay
                }
            });

            // We need to initialize the selection even so the widget does not use it.
            this.addTableViewSelectionEvents(this.tableView);

            this.setPagination();

            if (this.options.collection) {
                this.collection.fetched = false;
            }
        },

        _resetSortOrderBy: function () {
            // Override the NodesTable's method implementation to not reset the collection orderBy
        },

        getDefaultUrlParameters: function () {
            return [];
        }

    });

    _.extend(FileUploadTableView.prototype, LayoutViewEventsPropagationMixin);
    _.extend(FileUploadTableView.prototype, MultiNodeFetchMixin);

    return FileUploadTableView;
});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.expand',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class=\"csui-perspective-toolbar\"></div>\r\n\r\n<div class=\"csui-facet-table-container\">\r\n  <div class='csui-side-panel csui-sidepanel-hidden'>\r\n    <div class=\"csui-table-facetview csui-facetview-hidden csui-facetview-visibility\"></div>\r\n    <div class=\"csui-table-treeview csui-treeview-hidden csui-treeview-visibility\"></div>\r\n  </div>\r\n  <!--outer div is needed in order to float table contents right to accommodate  facets-->\r\n  <div class=\"csui-outertablecontainer\">\r\n    <!--inner div is needed in order to have tableview sized to remaining height of container-->\r\n    <div class=\"csui-innertablecontainer\">\r\n      <div class=\"csui-table-facetbarview xecmpf-fileupload-filter-view\"></div>\r\n        <div class=\"csui-table-tableview xecmpf-fileupload-table-view\"></div>\r\n        <div id=\"paginationviewMA\"></div>\r\n      <div class=\"cs-thumbnail-wrapper\"></div>\r\n    </div>\r\n  </div>\r\n</div>\r\n ";
}});
Handlebars.registerPartial('xecmpf_widgets_fileupload_impl_fileupload.expand_fileupload.expand', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.expand.view',[
    'csui/lib/marionette',
    'csui/lib/underscore',
    'csui/lib/jquery',
    'csui/controls/mixins/layoutview.events.propagation/layoutview.events.propagation.mixin',
    'csui/utils/accessibility',
    'csui/behaviors/default.action/default.action.behavior',
    'csui/utils/contexts/factories/node',
    'xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.header.view',
    'xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.filter.view',
    'xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.table.view',
    'xecmpf/widgets/fileupload/impl/factory/fileupload.collection.factory',
    'hbs!xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.expand',
    'i18n!xecmpf/widgets/fileupload/impl/nls/lang',
    'css!xecmpf/widgets/fileupload/impl/fileupload'
], function (Marionette, _, $, LayoutViewEventsPropagationMixin, Accessibility,
    DefaultActionBehavior, NodeModelFactory, FileUploadHeaderView, FileUploadFilterView, FileUploadTableView, FileUploadCollectionFactory, template, lang) {
    'use strict';
    var accessibleTable = Accessibility.isAccessibleTable();

    var FileUploadExpandedView = Marionette.LayoutView.extend({
        className: 'csui-nodestable xecmpf-fileupload-expanded-view',

        template: template,

        regions: {
            headerRegion: '.csui-perspective-toolbar',
            filterRegion: '.csui-table-facetview',
            tableRegion: '.xecmpf-fileupload-table-view',
            paginationRegion: '#paginationviewMA'
        },

        behaviors: {
            DefaultAction: {
                behaviorClass: DefaultActionBehavior
            }
        },

        ui: {
            sidePanel: '.csui-side-panel',
            filterView: '.csui-table-facetview',
            paginationView: '.csui-table-paginationview'
        },

        events: {
            'click .fileupload-filter-icon': 'onClickFilter',
            'click .fileupload-add-icon': 'onClickAddItem',
            'click .xecmpf-fileupload-table-view tbody tr': 'onClickItem',
            'click .cs-go-back' : 'onClickBackButton',
            'keyup .xecmpf-fileupload-table-view tbody tr': 'onKeyInView'
        },

        constructor: function FileUploadExpandedView(options) {
            this.options = options;
            this.showFilter = false;
            options.node = options.context.getModel(NodeModelFactory, {
              'node': {
                'attributes': {
                  'id': this.options.context.wsid
                }
              }
            });
            this.completeCollection = this.options.context.getCollection(FileUploadCollectionFactory);
            this.context = this.options.context;
            Marionette.LayoutView.prototype.constructor.apply(this, arguments);
            this.propagateEventsToRegions();
            
        },

        initialize: function () {
            this._setPerspectiveHeaderView();
            this.fileuploadTableView = new FileUploadTableView({
                context: this.options.context,
                collection: this.completeCollection,
                extendedView: this
            });
            this.filterView = new FileUploadFilterView({
                context: this.options.context,
                collection: this.completeCollection,
                extendedView: this
            });
        },

        onRender: function () {
            this.fileuploadHeaderView && this.headerRegion.show(this.fileuploadHeaderView);
            this.tableRegion.show(this.fileuploadTableView.tableView);
            this.filterRegion.show(this.filterView);
            this.paginationRegion.show(this.fileuploadTableView.paginationView);
        },
        
        /**
        * @desc - displays the header view
        */
        _setPerspectiveHeaderView: function () {
            this.fileuploadHeaderView = new FileUploadHeaderView({
                title: lang.dialogTitle,
                icon: 'title-icon xecmpf-fileupload-title-icon',
                context: this.options.context,
                connector: this.completeCollection.connector,
                node: this.options.node,
                extendedView: this
            });
        },

        /**
         * @desc - required actions on click on filter icon
         */
        onClickFilter: function () {
            this.showFilter = !this.showFilter;
            this._ensureFilterPanelViewDisplayed();
            if (this.showFilter) {
                this._showFilterPanelView();
                this.ui.sidePanel.removeClass('csui-sidepanel-hidden');
            } else {
                this._hideFilterPanelView();
                this.ui.sidePanel.addClass('csui-sidepanel-hidden');
            }
        },

        /**
         * @desc - required actions on click on back button
         */
        onClickBackButton: function () {
            var context = this.options.context,
            viewStateModel = context && context.viewStateModel;
            if (viewStateModel) {
                viewStateModel.restoreLastRouter();
            }
        },

        /**
         * @desc - checking if filter view is undefined upon clicking on filter icon
         */_ensureFilterPanelViewDisplayed: function () {
            if (this.filterView === undefined) {
                this._setFilterPanelView();
                this.filterRegion.show(this.filterView);
            }
        },

        /**
         * @desc - shows the filter panel
         */
        _showFilterPanelView: function () {
            this.showFilter = true;
            this.ui.sidePanel.removeClass('csui-sidepanel-hidden');
            this.ui.filterView.removeClass('csui-facetview-visibility');
            $(this.fileuploadHeaderView.el).find(".cs-filter-icon-container").attr("title", lang.hideFilterTitle);
            $(this.fileuploadHeaderView.el).find(".cs-filter-icon-container").attr("aria-label", lang.hideFilterTitle);
            if (accessibleTable) {
                this.ui.filterView.removeClass('csui-facetview-hidden');
                this.triggerMethod('dom:refresh');
            } else {
                this.ui.filterView.one(this._transitionEnd(),
                    function () {
                        this.triggerMethod('dom:refresh');
                    }.bind(this)).removeClass('csui-facetview-hidden');
            }
            this.listenTo(this.filterView, 'dom:refresh', _.bind(function () {
                $(window).trigger('resize.facetview');
            }, this));
        },

        /**
         * @desc - hides the filter panel
         */
        _hideFilterPanelView: function () {
            this.showFilter = false;
            if (accessibleTable) {
                this.ui.filterView.addClass('csui-facetview-hidden');
                this.triggerMethod('dom:refresh');
                this.ui.filterView.hasClass('csui-facetview-hidden') &&
                    this.ui.filterView.addClass('csui-facetview-visibility');
                this._removeFilterPanelView();
            } else {
                this.ui.filterView.one(this._transitionEnd(),
                    function () {
                        this._removeFilterPanelView();
                        this.triggerMethod('dom:refresh');
                        this.ui.filterView.hasClass('csui-facetview-hidden') &&
                            this.ui.filterView.addClass('csui-facetview-visibility');
                    }.bind(this)).addClass('csui-facetview-hidden');
            }
            $(this.fileuploadHeaderView.el).find(".cs-filter-icon-container").attr("title", lang.showFilterTitle);
            $(this.fileuploadHeaderView.el).find(".cs-filter-icon-container").attr("aria-label", lang.showFilterTitle);

            this.listenTo(this.filterView, 'dom:refresh', _.bind(function () {
                $(window).trigger('resize.facetview');
            }, this));
        },

        /**
         * @desc - sets the filter panel
         */
        _setFilterPanelView: function () {
            this.filterView = new FileUploadFilterView({
                context: this.options.context,
                extendedView: this
            });
            this.listenTo(this.filterView, 'remove:filter', this._removeFacetFilter)
                .listenTo(this.filterView, 'remove:all', this._removeAll)
                .listenTo(this.filterView, 'apply:filter', this._checkSelectionAndApplyFilter)
                .listenTo(this.filterView, 'apply:all', this._setFacetFilter);
        },

        /**
         * @desc - removes the filter panel
         */
        _removeFilterPanelView: function () {
            !!this.thumbnailViewState ? this.thumbnail._adjustThumbnailWidth() : '';
            this.filterRegion.empty();
            this.filterView = undefined;
        },

        _transitionEnd: _.once(
            function () {
                var transitions = {
                    transition: 'transitionend',
                    WebkitTransition: 'webkitTransitionEnd',
                    MozTransition: 'transitionend',
                    OTransition: 'oTransitionEnd otransitionend'
                },
                    element = document.createElement('div'),
                    transition;
                for (transition in transitions) {
                    if (typeof element.style[transition] !== 'undefined') {
                        return transitions[transition];
                    }
                }
            }
        ),

        onClickItem: function (e) {
            var requestModel, currentRowEl = $(e.target).closest('tr'),
                index = $(currentRowEl).index();
            requestModel = this.completeCollection.models[index];
            requestModel.connector = this.completeCollection.connector;
            var targetEle = this.$el.find('.highlight-item');
            if (targetEle.length > 0) {
                for (var i = 0; i < targetEle.length; i++) {
                    $(targetEle[i]).removeClass('highlight-item');
                }
            }
            $(currentRowEl).addClass('highlight-item');

        },

        onKeyInView: function (event) {
            if (event.keyCode === 13 || event.keyCode === 32) {
                this.onClickItem(event);
            }
        },

    });

    _.extend(FileUploadExpandedView.prototype, LayoutViewEventsPropagationMixin);
    return FileUploadExpandedView;
});
csui.define('xecmpf/controls/savedquery.node.picker/impl/search.query.factory',['module', 'csui/lib/underscore', 'csui/lib/backbone',
  'csui/utils/contexts/factories/factory'
], function (module, _, Backbone, ModelFactory) {

  var SearchQueryModel = Backbone.Model.extend({

    constructor: function SearchQueryModel(attributes, options) {
      SearchQueryModel.__super__.constructor.apply(this, arguments);
    },

    toJSON: function () {
      return SearchQueryModel.__super__.toJSON.apply(this, arguments);
    }

  });

  var SearchQueryModelFactory = ModelFactory.extend({

    propertyPrefix: 'xecmpfSearchQuery',

    constructor: function SearchQueryModelFactory(context, options) {
      ModelFactory.prototype.constructor.apply(this, arguments);

      var searchQuery = this.options.xecmpfSearchQuery || {};
      if (!(searchQuery instanceof Backbone.Model)) {
        var config = module.config();
        searchQuery = new SearchQueryModel(searchQuery.models, _.extend({},
            searchQuery.options, config.options));
      }
      this.property = searchQuery;
    }

  });

  return SearchQueryModelFactory;
});

csui.define('xecmpf/controls/savedquery.node.picker/impl/search.results.factory',['require', 'module', 'csui/lib/underscore', 'csui/lib/backbone',
  'csui/utils/contexts/factories/factory', 'csui/utils/contexts/factories/connector',
  'csui/models/widget/search.results/search.results.model',
  'csui/utils/commands',
  'csui/utils/base'
], function (require, module, _, Backbone, CollectionFactory, ConnectorFactory,
    SearchResultCollection, commands, base) {

  var SearchResultCollectionFactory = CollectionFactory.extend({

    propertyPrefix: 'xecmpfSearchResults',

    constructor: function SearchResultCollectionFactory(context, options) {
      CollectionFactory.prototype.constructor.apply(this, arguments);

      var searchResults = this.options.xecmpfSearchResults || {};
      if (!(searchResults instanceof Backbone.Collection)) {
        var connector = context.getObject(ConnectorFactory, options),
            query     = options.xecmpfSearchResults.query,
            config    = module.config();
        searchResults = new SearchResultCollection(searchResults.models, _.extend({
          connector: connector,
          query: query,
          // Ask the server to check for permitted actions V2
          commands: commands.getAllSignatures()
        }, searchResults.options, config.options, {
          autofetch: true,
          autoreset: true
        }));
      }
      this.property = searchResults;
    },

    isFetchable: function () {
      return this.property.isFetchable();
    },

    fetch: function (options) {
      this.property.fetch({
        success: _.bind(this._onSearchResultsFetched, this, options),
        error: _.bind(this._onSearchResultsFailed, this, options)
      });
    },

    _onSearchResultsFetched: function (options) {
      //nothing to-do for now upon success.
      return true;
    },

    _onSearchResultsFailed: function (model, request, message) {
      var error = new base.RequestErrorMessage(message);
      csui.require(['csui/dialogs/modal.alert/modal.alert'], function (ModalAlert) {
        ModalAlert.showError(error.toString());
      });
    }

  });

  return SearchResultCollectionFactory;
});


/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/savedquery.node.picker/impl/savedquery.form',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class=\"xecmpf-sq-select-container\"></div>\r\n<div class=\"xecmpf-custom-search-container\"></div>\r\n";
}});
Handlebars.registerPartial('xecmpf_controls_savedquery.node.picker_impl_savedquery.form', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/controls/savedquery.node.picker/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});

csui.define('xecmpf/controls/savedquery.node.picker/impl/nls/root/lang',{
  selectQuery: 'Select Search Query'
});



csui.define('css!xecmpf/controls/savedquery.node.picker/impl/savedquery.form',[],function(){});


csui.define('xecmpf/controls/savedquery.node.picker/impl/savedquery.form.view',['module', 'require', 'csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/marionette',
  'csui/models/node/node.model',
  'csui/utils/contexts/factories/connector',
  'csui/utils/contexts/factories/children2',
  'csui/behaviors/keyboard.navigation/tabables.behavior',
  'xecmpf/controls/savedquery.node.picker/impl/search.query.factory',
  'csui/models/form', 'csui/controls/form/form.view',
  'csui/widgets/search.custom/search.custom.view',
  'hbs!xecmpf/controls/savedquery.node.picker/impl/savedquery.form',
  'i18n!xecmpf/controls/savedquery.node.picker/impl/nls/lang',
  'css!xecmpf/controls/savedquery.node.picker/impl/savedquery.form'
], function (module, require, _, $, Marionette, NodeModel, ConnectorFactory,
    Children2CollectionFactory, TabablesBehavior, SearchQueryModelFactory,
    FormModel, FormView, CustomSearchView,
    template, lang) {

  var config = _.extend({
    csSubTypes: {
      queryVolume: 860,
      query: 258
    }
  }, module.config());

  var SavedQueryFormView = Marionette.LayoutView.extend({

    className: 'xecmpf-savedquery-form',

    template: template,

    regions: {
      querySelectRegion: '.xecmpf-sq-select-container',
      customSearchRegion: '.xecmpf-custom-search-container'
    },

    constructor: function SavedQueryFormView(options) {
      options || (options = {});
      options.query || (options.query = options.context.getModel(SearchQueryModelFactory));

      Marionette.LayoutView.prototype.constructor.apply(this, arguments);
    },

    initialize: function (options) {
      this.query = options.query;
    },

    setQuerySelectField: function () {
      var deferred = $.Deferred();
      this._getQueryCollection()
          .then(function (searchQueryCollection) {
            var map = {};
            searchQueryCollection.each(function (node) {
              // map key is `name` to keep the list sorted by name
              map[node.get('name')] = node.get('id');
            });

            this.query.set('query_id', map[_.keys(map)[0]] || '', {
              silent: true
            });

            var that = this;
            this.querySelectForm = new FormView({
              mode: 'create',
              model: new FormModel({
                data: {
                  searchQueryId: this.query.get('query_id')
                },
                schema: {
                  properties: {
                    searchQueryId: {
                      enum: _.values(map)
                    }
                  }
                },
                options: {
                  fields: {
                    searchQueryId: {
                      label: lang.selectQuery,
                      name: 'searchQueryId',
                      type: 'select',
                      optionLabels: _.keys(map),
                      removeDefaultNone: true,
                      onFieldChange: function () {
                        that.onChangeSavedQuerySelectField(this.getValue());
                      }
                    }
                  }
                }
              })
            });
            deferred.resolve();
          }.bind(this), deferred.reject);

      return deferred;
    },

    onChangeSavedQuerySelectField: function (queryId) {
      this.query.clear({
        silent: true
      }).set('query_id', queryId, {
        silent: true
      });

      this.setCustomSearchView()
          .then(function () {
            this.showChildView('customSearchRegion', this.customSearchView);
          }.bind(this), function (err) {
            console.error('Unable to set custom search form view.');
          });
    },

    _getQueryCollection: function () {
      var searchQueryCollection = this.options.context.getCollection(Children2CollectionFactory, {
        options: _.defaults({
          commands: ['open','default'],
          // use this node model as parent node to get the children
          node: new NodeModel({
            id: config.queryVolumeId,
            type: config.csSubTypes.queryVolume
          }, {
            // node model collection needs connector
            connector: this.options.context.getObject(ConnectorFactory)
          }),
          filter: {
            type: config.csSubTypes.query // fetch only first level queries not query folders
          }
        }),
        // specify id-attribute to give the collection factory in the context a unique key
        attributes: {
          id: config.queryVolumeId
        }
      });

      var deferred = $.Deferred();

      searchQueryCollection
          .ensureFetched()
          .then(function () {
            deferred.resolve(searchQueryCollection);
          }, deferred.reject);

      return deferred;
    },

    setCustomSearchView: function () {
      var deferred = $.Deferred();
      csui.require(['csui/widgets/search.custom/impl/search.object.view'], function (SearchObjectView) {
        this.customSearchView && this.customSearchView.destroy();
        var queryId = this.query.get('query_id');
        this.customSearchView = queryId ?
                                new SearchObjectView({
                                  context: this.options.context,
                                  query: this.options.query,
                                  savedSearchQueryId: queryId
                                }) : new Marionette.View();
        this.customSearchView.model && this.customSearchView.model.ensureFetched();
        deferred.resolve();
      }.bind(this), deferred.reject);
      return deferred;
    },

    onRender: function () {
      this.setQuerySelectField()
          .then(function () {
            this.showChildView('querySelectRegion', this.querySelectForm);
            this.setCustomSearchView()
                .then(function () {
                  this.showChildView('customSearchRegion', this.customSearchView);
                }.bind(this), function (err) {
                  console.error('Unable to set custom search form view.');
                });
          }.bind(this), function (err) {
            console.error('Unable to set saved queries select field.');
          });
    },

    onBeforeDestroy: function () {
      this.customSearchView && this.customSearchView.destroy();
    }

  });

  return SavedQueryFormView;
});

csui.define('css!xecmpf/controls/savedquery.node.picker/impl/savedquery.node.picker',[],function(){});
csui.define('xecmpf/controls/savedquery.node.picker/savedquery.node.picker.view',['csui/lib/underscore', 'csui/lib/jquery',
  'csui/lib/backbone', 'csui/lib/marionette', 'csui/lib/handlebars',
  'xecmpf/controls/savedquery.node.picker/impl/search.query.factory',
  'xecmpf/controls/savedquery.node.picker/impl/search.results.factory',
  'xecmpf/controls/savedquery.node.picker/impl/savedquery.form.view',
  'csui/widgets/search.results/search.results.view',
  'css!xecmpf/controls/savedquery.node.picker/impl/savedquery.node.picker'
], function (_, $, Backbone, Marionette, Handlebars,
  SearchQueryModelFactory, SearchResultsCollectionFactory,
  SearchFormView, SearchResultsView) {

  var SavedQueryNodePickerView = Marionette.Object.extend({

    constructor: function SavedQueryNodePickerView(options) {
      options || (options = {});
      options.query || (options.query = options.context.getModel(SearchQueryModelFactory));
      options.collection ||
      (options.collection = options.context.getCollection(SearchResultsCollectionFactory, _.extend({}, options, {
          // to get a new collection object every time
          unique: true,
          temporary: true,
          detached: true,
          internal: false
      })));
      Marionette.Object.prototype.constructor.apply(this, arguments);
    },

    initialize: function (options) {
      this.searchFormView = new SearchFormView({
        context: options.context,
        query: options.query
      });

      this.searchResultsView = new SearchResultsView({
        context: options.context,
        query: options.query,
        collection: options.collection,
        customSearchView: this.searchFormView,
        toolbarItems: this.options.toolbarItems,
        enableBackButton: this.options.enableBackButton,
        titleView: new Marionette.ItemView({
          tagName: 'h2',
          template: Handlebars.compile('<span>{{title}}</span>')({
            title: this.options.title
          })
        })
      });

      if (!this.options.toolbarItems.inlineToolbar) {
        this.searchResultsView.resultsView.lockedForOtherContols = true;
        this.searchResultsView.resultsView.$el.addClass('xecmpf-sq-np-no-inline-toolbar');
      }

      this.listenTo(this.searchResultsView, {
        'set:picker:result': function (result) {
          this._result = result;
        },
        'close go:back': function () {
          this.triggerMethod('close');
        }
      });
    },

    onBeforeDestroy: function () {
      this.options.query.clear();
      this.searchFormView.destroy();
      this.searchResultsView.destroy();
    },

    show: function () {
      this._deferred = $.Deferred();
      var originatingView = this.options.originatingView,
        containerEl = this.options.containerEl;

      if (originatingView instanceof Backbone.View) {
        var $pickerEl = $('<div/>', {
            class: 'xecmpf-savedquery-node-picker'
          }),
          $originatingView = (_.isString(containerEl) && $(containerEl + '>*')) ||
          originatingView.$el;

        $originatingView.parent().append($pickerEl);

        this.searchResultsView.render();
        Marionette.triggerMethodOn(this.searchResultsView, 'before:show');
        $pickerEl.append(this.searchResultsView.el);

        var that = this;
        $pickerEl.show('blind', {
          direction: 'right',
          complete: function () {
            $originatingView.hide();
            originatingView.isDisplayed = false;
            // SAPRM-12354 BA widget: Upon pressing the add button, Business Attachment form the search form appears blank
            // - if Side panel is hidden, toggle it.  
            if (that.searchResultsView.ui.searchSidePanel.hasClass('csui-is-hidden')) {
              that.searchResultsView.headerView.triggerMethod('toggle:filter', that.searchResultsView);
            }
            Marionette.triggerMethodOn(that.searchResultsView, 'show');
          }
        }, 100);

        this.listenTo(this, 'close', function () {
          $originatingView.show();
          $originatingView.promise()
            .done(function () {
              originatingView.isDisplayed = true;
              $pickerEl.hide('blind', {
                direction: 'right',
                complete: function () {
                  if (that._result) {
                    that._deferred.resolve(that._result);
                  } else if (that._deferred.state() === 'pending') {
                    that._deferred.reject({
                      cancelled: true
                    });
                  }
                  that.destroy();
                  $pickerEl.remove();
                }
              }, 100);
            });
        });
        return this._deferred;
      }
      return this._deferred.reject().promise();
    }
  });

  return SavedQueryNodePickerView;
});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/search.textbox/impl/search.textbox',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"xecmpf-search-bar\" role=\"dialog\">\r\n  <div class=\"xecmpf-search-bar-content\">  \r\n      <span class=\"xecmpf-search-icon-static\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"searchTooltip") || (depth0 != null ? lookupProperty(depth0,"searchTooltip") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"searchTooltip","hash":{},"loc":{"start":{"line":3,"column":53},"end":{"line":3,"column":70}}}) : helper)))
    + "\"\r\n          aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"searchTooltip") || (depth0 != null ? lookupProperty(depth0,"searchTooltip") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"searchTooltip","hash":{},"loc":{"start":{"line":4,"column":22},"end":{"line":4,"column":39}}}) : helper)))
    + "\"></span>  \r\n    <div class=\"xecmpf-search-input-container\">\r\n      <input type=\"text\" class=\"xecmpf-input\" placeholder=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"searchFromHere") || (depth0 != null ? lookupProperty(depth0,"searchFromHere") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"searchFromHere","hash":{},"loc":{"start":{"line":6,"column":59},"end":{"line":6,"column":77}}}) : helper)))
    + "\"\r\n             title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"searchFromHere") || (depth0 != null ? lookupProperty(depth0,"searchFromHere") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"searchFromHere","hash":{},"loc":{"start":{"line":7,"column":20},"end":{"line":7,"column":38}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"searchFromHere") || (depth0 != null ? lookupProperty(depth0,"searchFromHere") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"searchFromHere","hash":{},"loc":{"start":{"line":7,"column":52},"end":{"line":7,"column":70}}}) : helper)))
    + "\">\r\n    </div>\r\n    <a href=\"#\" class=\"xecmpf-clearer formfield_clear\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"clearTextTooltip") || (depth0 != null ? lookupProperty(depth0,"clearTextTooltip") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"clearTextTooltip","hash":{},"loc":{"start":{"line":9,"column":62},"end":{"line":9,"column":82}}}) : helper)))
    + "\"\r\n          aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"clearTextTooltip") || (depth0 != null ? lookupProperty(depth0,"clearTextTooltip") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"clearTextTooltip","hash":{},"loc":{"start":{"line":10,"column":22},"end":{"line":10,"column":42}}}) : helper)))
    + "\"></a>\r\n  </div>\r\n</div>\r\n<div role=\"button\" class=\"xempf-search-close\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"closeSearchTooltip") || (depth0 != null ? lookupProperty(depth0,"closeSearchTooltip") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"closeSearchTooltip","hash":{},"loc":{"start":{"line":13,"column":58},"end":{"line":13,"column":80}}}) : helper)))
    + "\">\r\n  <a href=\"javascript:void(0);\" class=\"icon xecmpf-icon-close xempf-search-hide csui-acc-focusable\"\r\n    title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"closeSearchTooltip") || (depth0 != null ? lookupProperty(depth0,"closeSearchTooltip") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"closeSearchTooltip","hash":{},"loc":{"start":{"line":15,"column":11},"end":{"line":15,"column":33}}}) : helper)))
    + "\" aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"closeSearchTooltip") || (depth0 != null ? lookupProperty(depth0,"closeSearchTooltip") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"closeSearchTooltip","hash":{},"loc":{"start":{"line":15,"column":47},"end":{"line":15,"column":69}}}) : helper)))
    + "\" aria-expanded=\"false\"></a>\r\n</div>";
}});
Handlebars.registerPartial('xecmpf_controls_search.textbox_impl_search.textbox', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/controls/search.textbox/impl/nls/lang',{
    // Always load the root bundle for the default locale (en-us)
    "root": true,
    // Do not load English locale bundle provided by the root bundle
    "en-us": false,
    "en": false
  });
csui.define('xecmpf/controls/search.textbox/impl/nls/root/lang',{
    searchFromHere: 'Search from here',
    closeSearchTooltip: 'Clear all text and hide search',
    clearTextTooltip: 'Clear all text in this field',
    search: 'search'
});
  


csui.define('css!xecmpf/controls/search.textbox/impl/search.textbox',[],function(){});
csui.define('xecmpf/controls/search.textbox/search.textbox.view',[
    'module', 'csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/marionette',
    'csui/utils/contexts/factories/search.query.factory',
    'hbs!xecmpf/controls/search.textbox/impl/search.textbox',
    'i18n!xecmpf/controls/search.textbox/impl/nls/lang',
    'i18n', 'css!xecmpf/controls/search.textbox/impl/search.textbox'
],function(module, _, $, Marionette, SearchQueryModelFactory, 
    template, lang, i18n) {
    "use strict";
    
    var config = _.defaults({}, module.config(), {
        inputValue: '',
        nodeId: '',
        nodeName: ''
    });

    var SearchTextBoxView = Marionette.ItemView.extend({
        className: 'xecmpf-search-text-box',
        template: template,
        
        ui: {
            input: '.xecmpf-input',
            clearer: '.xecmpf-clearer',
            closeSearchBtn: '.xempf-search-hide'
        },

        events: {
			'keyup @ui.input': 'inputTyped',
			'keydown @ui.input': 'inputTyped',
            'paste @ui.input': 'inputChanged',
            'change @ui.input': 'inputChanged',
            'click @ui.clearer': 'clearerClicked',
            'keydown @ui.clearer': 'keyDownOnClear',
            'click @ui.closeSearchBtn': 'closeSearchButtonClicked',
            'keydown @ui.closeSearchBtn': 'KeyDownOnCloseSearchBtn'
        },

        templateHelpers: function () {
            return {
                searchFromHere : lang.searchFromHere,
                clearTextTooltip: lang.clearTextTooltip,
                closeSearchTooltip: lang.closeSearchTooltip,
                searchTooltip: lang.search
            }
        },

        constructor: function SearchTextBoxView(options) {
            options || (options = {});
            options.data = _.defaults({}, options.data, config);
            this.direction = i18n.settings.rtl ? 'left' : 'right';

            var context = options.context;
            if (!options.model) {
                options.model = context.getModel(SearchQueryModelFactory);
            }
            Marionette.ItemView.prototype.constructor.apply(this, arguments);
        },

        onRender: function() {
            var value = this.options.data.inputValue || this.model.get('where');
            if (value) {
                this._setInputValue(value);
            }
        },

        inputTyped: function(event) {
            var value = this.ui.input.val().trim();
            if (event.which === 32) {
                event.stopPropagation();
            } else if (event.which === 13) {
                event.preventDefault();
                event.stopPropagation();
                this._setInputValue(value);
                if (!!value) {
                this.searchIconClicked(event);
                }
                if (this.previousValue !== value) {
                this.previousValue = value;
                }
            } else {
                this.inputChanged(event);
            }
		},
		
        inputChanged: function(event) {
            var value = this.ui.input.val();
            this.ui.clearer.toggle(!!value.length);
        },

        clearerClicked: function(event) {
            event.preventDefault();
            event.stopPropagation();

            this._setInputValue('');
            this.ui.input.trigger("focus");
        },

        keyDownOnClear: function (event) {
            if (event.keyCode === 13) {
                this.clearerClicked(event);
            }
        },

        searchIconClicked: function(event) {
            var value = this.ui.input.val().trim();
            if (!!value) {
                this._setInputValue(value);
                var searchOption = this.options.data.nodeId;

                if (!!value) {
                this._setSearchQuery(value, this.options.sliceString, searchOption, event);
                this._updateInput();
                this.options.data.searchFromHere = true;
                }

                this._triggerSearchResults();
            }    
        },

        _updateInput: function() {
            if (this._isRendered) {
                var value = this.model.get('where') || '';
                this._setInputValue(value);
              }
        },

        _setSearchQuery: function(value, sliceString, searchOption, event) {
            this.model.clear({silent: true});
            var params = {};
            if (!!sliceString) {
                params['slice'] = sliceString;
            }
            if (!!searchOption) {
                params['location_id1'] = searchOption;
            }
            if (value) {
                params['where'] = value;
            }
            this.model.set(params);
        },

        _setInputValue: function(value) {
            this.ui.input.val(value);
            this.ui.clearer.toggle(!!value.length);
        },

        closeSearchButtonClicked: function (event) {
            this.trigger("hide:searchbar");
        },

        KeyDownOnCloseSearchBtn: function(event) {
            if (event.keyCode === 13) {
                event.preventDefault();
		        event.stopPropagation();
                this.trigger("hide:searchbar");
            }
        },

        _triggerSearchResults: function() {
            this.trigger("search:results");
        }

    });

    return SearchTextBoxView;

});
csui.define('xecmpf/controls/property.panels/reference/reference.panel.controller',['require',
  'csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/backbone',
  'csui/lib/marionette',
  'csui/utils/url',
  'csui/utils/log'
], function (require, _, $, Backbone, Marionette, Url, log
) {
  'use strict';

  function getReferencePanel(controller, mode, marker, attributes, addItemController) {
    var deferred = $.Deferred();

    csui.require([
      'xecmpf/controls/bosearch/bosearch.model',
      'xecmpf/controls/bosearch/bosearch.dialog.controller',
      'xecmpf/controls/property.panels/reference/impl/workspace.reference.model',
      'xecmpf/controls/property.panels/reference/impl/reference.panel.model',
      'xecmpf/controls/property.panels/reference/impl/reference.panel.view'
    ], function (
        BoSearchModel,
        BoSearchDialogController,
        WorkspaceReferenceModel,
        ReferencePanelModel,
        ReferencePanelView
    ) {
      // we want to reuse the action context from a previous panel
      // so we attach it as listener to the context and request it when we need it again
      var eventobject = {};
      controller.options.context.trigger("request:actioncontext",eventobject);
      var actionContext = _.extend(eventobject.actionContext||{},{mode: mode});
      controller.options.context.once("request:actioncontext",function(eventobject) {
        eventobject.actionContext = actionContext;
      });

      // determine bo_type_id and bo_id, then display reference section
      if (!actionContext.workspaceReference || (addItemController && addItemController.sidePanel)) {
        actionContext.workspaceReference = new WorkspaceReferenceModel(attributes, {
          node: controller.options.model
        });
      } else {
        actionContext.workspaceReference.node = controller.options.model;
        actionContext.workspaceReference.set(attributes);
      }

      var bo_ref = actionContext.workspaceReference,
          fetch = bo_ref.get("id") ? bo_ref.fetch() : $.Deferred().resolve().promise();
      fetch.then(function(){
        if (marker) {
          // add css class, so we can set styles depending on whether reference tab exists or not.
          if(bo_ref.get("bo_type_id") != null) {
            marker.addClass("conws-reference-showing")
          } else {
            marker.removeClass("conws-reference-showing")
          }
        }

        if(bo_ref.get("bo_type_id") != null) {
          deferred.resolve([
            {
              model: new ReferencePanelModel(),
              contentView: ReferencePanelView,
              contentViewOptions: {
                actionContext: actionContext
              }
            }
          ]);
        } else {
          // there is no reference panel to display.
          deferred.resolve([]);
        }
      },function(error){
        deferred.reject(error);
      });
    }, function (error) {
      deferred.reject(error);
    });
    return deferred.promise();
  }

  var ReferencePanelController = Marionette.Controller.extend({

    constructor: function ReferencePanelController(options) {
      Marionette.Controller.prototype.constructor.apply(this, arguments);
    },

    getPropertyPanels: function (options) {
      // var node = this.options.model,
      //     connector = node.connector,
      //     nodeV1Url = Url.combine(connector.connection.url, 'nodes', node.get('id')),
      //     volumeV1Url = Url.combine(connector.connection.url, 'volumes/198');

      var isWorkspace;

       // first determine, whether a workspace is to be displayed
      isWorkspace = this.options && this.options.model && this.options.model.get("type")===848 &&
          // suppress reference panel for early workspaces => bus. obj. is set automatically
          !this.options.context.options.suppressReferencePanel;
		  

      // if a workspace is about to be displayed and general data is available
      if (isWorkspace) {

        log.debug("getPropertyPanels for business workspace called") && console.log(log.last);
        var mode = "workspace_reference_edit",
            marker = $(".cs-perspective-panel .cs-properties-wrapper .metadata-content .cs-metadata"),
            boattributes = {
              id: this.options.model.get("id"),
              bo_id: undefined,
              bo_type_id: undefined,
              bo_type_name: undefined,
              ext_system_id: undefined,
              ext_system_name: undefined
        };

        return getReferencePanel(this, mode, marker, boattributes);
      }

      return null;
    },

    getPropertyPanelsForCreate: function (options) {

      var generalData, isWorkspace;

      // helper method to remove the add classifications button
      function disableClassificationsAdd(propertiesView,controller) {
        if (propertiesView) {
          controller.listenTo(propertiesView, 'before:render', function () {
            if (propertiesView.addPropertiesView) {
              if (!propertiesView.addPropertiesViewIsXecmRecreated) {
                propertiesView._createAddPropertiesView();
                propertiesView.addPropertiesViewIsXecmRecreated = true;
              }
            }
            if (propertiesView.addPropertiesView && propertiesView.addPropertiesView.collection) {
              if (!propertiesView.addPropertiesView.collection.hasXecmFilterModelsFunction) {
                var filtermodels = propertiesView.addPropertiesView.collection.filterModels;
                propertiesView.addPropertiesView.collection.filterModels = function(models) {
                  // replace the collection in the view with one that always filters classifications
                  // signatures "AddCategory", "AddRMClassification", "AddPropertiesClassifications"
                  arguments[0] = _.filter(models,function(cm){
                    var sig = cm.get("signature");
                    return sig==="AddRMClassification" || sig==="AddCategory";
                  });
                  return filtermodels.apply(this,arguments);
                };
                propertiesView.addPropertiesView.collection.hasXecmFilterModelsFunction = true;
                propertiesView.addPropertiesView.collection.refilter();
              }
            }
          });
          controller.listenTo(propertiesView, 'render', function () {
            if (propertiesView.addPropertiesViewIsXecmRecreated) {
              delete propertiesView.addPropertiesViewIsXecmRecreated;
            }
          });
        }
      }

      // first determine, whether a workspace is to be created
      if (options && options.forms && options.forms.models) {
        _.each(options.forms.models, function (form) {
          if (form.get('id') === 'general') {
            generalData = form.get('data');
            isWorkspace = generalData ? generalData.type===848 : false;
          }
        }, this);
      }
	  isWorkspace = isWorkspace &&
        // suppress reference panel for early workspaces => bus. obj. is set automatically
        !this.options.context.options.suppressReferencePanel;
		
      // if a workspace is about to be created
      if (isWorkspace) {

        log.debug("getPropertyPanelsForCreate for business workspace called") && console.log(log.last);

        // check, if general data is available and then display reference section
        if (generalData) {

          var mode = "workspace_reference_create",
              forms = options && options.forms,
              formCollection = forms && forms.formCollection,
              bo_id = formCollection && formCollection.bo_id,
              formOptions = formCollection && formCollection.options,
              addItemController = formOptions && formOptions.metadataAddItemController,
              dialog = addItemController && addItemController.dialog,
              marker = dialog && dialog.$(".binf-modal-content .binf-modal-body .cs-add-item-metadata-form"),
              boattributes = {
                id: undefined,
                bo_id:bo_id,
                bo_type_id: generalData.bo_type_id,
                bo_type_name: generalData.bo_type_name,
                ext_system_id: generalData.ext_system_id,
                ext_system_name: generalData.ext_system_name,
                change_reference:true,
                complete_reference:true
              },
              metadataView = addItemController && addItemController.metadataAddItemPropView,
              propertiesView = metadataView && metadataView.metadataPropertiesView;

          // in create mode, we disallow adding classifications, so we workaround CWS-2188
          if (propertiesView) {
            disableClassificationsAdd(propertiesView,this);
          }

          return getReferencePanel(this, mode, marker, boattributes, addItemController);

        }
      }

      return null;
    }
  });

  return ReferencePanelController;
});

csui.define('xecmpf/controls/property.panels/reference/reference.panel',[
  'xecmpf/controls/property.panels/reference/reference.panel.controller'
], function (ReferencePanelController) {

  return [{
      sequence  : 10,
      controller: ReferencePanelController
  }];

});

csui.define('xecmpf/dialogs/node.picker/start.locations/businessobjecttypes.container/impl/businessobjecttypes.collection',['module', 'csui/lib/underscore',  'csui/lib/backbone', 'csui/utils/url',
  'csui/models/node/node.model', 'csui/models/mixins/connectable/connectable.mixin',
  'csui/models/mixins/fetchable/fetchable.mixin', 'csui/models/browsable/client-side.mixin',
  'csui/models/browsable/v2.response.mixin'
], function (module, _,  Backbone, Url, NodeModel, ConnectableMixin, FetchableMixin,
  ClientSideBrowsableMixin, BrowsableV2ResponseMixin) {
  "use strict";

  var moduleConfig = module.config() || {};
  var BusinessObjectTypesCollection = Backbone.Collection.extend({

    model: NodeModel,

    constructor: function BusinessObjectTypesCollection(models, options) {
      _.defaults(options, { orderBy: '' });
      Backbone.Collection.prototype.constructor.call(this, models, options);

      this.makeConnectable(options)
        .makeFetchable(options)
        .makeClientSideBrowsable(options)
        .makeBrowsableV2Response(options);
    },

    url: function () {
      var orderBy = '';
      if (this.orderBy) {
        var first = this.orderBy.split(",")[0].split(" ");
        orderBy = (first[1] || 'asc') + "_" + first[0];
      }
      var url = this.connector.getConnectionUrl().getApiBase('v2'),
        query = Url.combineQueryString({
          fields: ['properties'],
          expand: 'properties{original_id}',
          orderBy: orderBy,
          actions: ''
        });
      var queryPart = "/nodes/" + moduleConfig.parentId + "/nodes";
      return Url.appendQuery(Url.combine(url, queryPart), query);
    },

    parse: function (response, options) {
      this.parseBrowsedState(response, options);
      this.parseBrowsedItems(response, options);
      response.results.reverse();
      return response.results;
    }

  });

  ClientSideBrowsableMixin.mixin(BusinessObjectTypesCollection.prototype);
  BrowsableV2ResponseMixin.mixin(BusinessObjectTypesCollection.prototype);
  ConnectableMixin.mixin(BusinessObjectTypesCollection.prototype);
  FetchableMixin.mixin(BusinessObjectTypesCollection.prototype);

  return BusinessObjectTypesCollection;

});

// Lists explicit locale mappings and fallbacks

csui.define('xecmpf/dialogs/node.picker/start.locations/impl/nls/lang',{
    // Always load the root bundle for the default locale (en-us)
    "root": true,
    // Do not load English locale bundle provided by the root bundle
    "en-us": false,    
    "en": false
  });
// Defines localizable strings in the default language (English)

csui.define('xecmpf/dialogs/node.picker/start.locations/impl/nls/root/lang',{
  labelExtendedECMVolume: 'Extended ECM',
  labelBusinessObjectTypes: "Business Object Types"
  });

csui.define('xecmpf/dialogs/node.picker/start.locations/businessobjecttypes.container/businessobjecttypes.container.factory',['csui/lib/underscore', 'csui/lib/jquery',
  'csui/dialogs/node.picker/start.locations/node.base.factory',
  'xecmpf/dialogs/node.picker/start.locations/businessobjecttypes.container/impl/businessobjecttypes.collection',
  'i18n!xecmpf/dialogs/node.picker/start.locations/impl/nls/lang'
], function (_, $, NodeBaseFactory, BusinessObjectTypesCollection,lang) {
  "use strict";
  var BusinessObjectTypesContainerFactory = NodeBaseFactory.extend({
    constructor: function BusinessWorkspaceVolumeFactory(options) {
      options = _.defaults({
        node: {
          type: 888
        }
      }, options);
      NodeBaseFactory.prototype.constructor.call(this, options);
    },
    updateLocationModel: function (model) {
      model.set({
        name: lang.labelBusinessObjectTypes,
        icon: "xecmpf-icon_businessobjecttype"
      });
      return $.Deferred().resolve().promise();
    },
    getLocationParameters: function () {
      var nodes = new BusinessObjectTypesCollection(undefined, {
        connector: this.options.connector,
        autoreset: true,
        expand: ['node']
      });
      return {
        container: null,
        collection: nodes,
        locationName: lang.labelBusinessObjectTypes
      };
    }
  });
  return BusinessObjectTypesContainerFactory;
});


csui.define('xecmpf/dialogs/node.picker/start.locations/extended.ecm.volume.container/extended.ecm.volume.container.factory',['csui/lib/underscore',
  'csui/dialogs/node.picker/start.locations/node.base.factory',
  'i18n!xecmpf/dialogs/node.picker/start.locations/impl/nls/lang'
], function (_, NodeBaseFactory, lang) {
  "use strict";

  var ExtendedECMVolumeFactory = NodeBaseFactory.extend({

    constructor: function ExtendedECMVolumeFactory(options) {
      options = _.defaults({
        node: {
          id: 'volume',
          type: 882
        },
        unselectable : true,
		icon: 'csui-icon-extended-ecm-volume',
        defaultName: lang.labelExtendedECMVolume
      }, options);
      NodeBaseFactory.prototype.constructor.call(this, options);
    }
  });

  return ExtendedECMVolumeFactory;

});

csui.define('xecmpf/controls/form/impl/fields/documenttypepicker/server.adaptor.mixin',[
  'csui/lib/underscore', 'csui/utils/url'
], function (_, Url) {
  'use strict';

  var ServerAdaptorMixin = {
    mixin: function (prototype) {
      return _.extend(prototype, {

        makeServerAdaptor: function (options) {
          return this;
        },

        url: function () {
          var apiUrl = new Url(this.connector.connection.url).getApiBase(2);
          var query = Url.combineQueryString(
              {
                skip_validation: true,
                document_type_rule: false,
                document_generation_only: false,
                sort_by: 'DocumentType'
              }
          );
          return Url.combine(apiUrl, 'businessworkspaces', this.businessWorkspaceId,
              'doctypes?' + query);
        },

        parse: function (response, options) {
          return response.results;
        },

        isFetchable: function () {
          return !!this.options;
        }
      });
    }

  };

  return ServerAdaptorMixin;
});
// writing a new collection for document types
csui.define('xecmpf/controls/form/impl/fields/documenttypepicker/documenttypecollection',['csui/lib/underscore',
  'csui/lib/jquery',
  'csui/lib/backbone',
  'csui/models/mixins/connectable/connectable.mixin',
  'csui/models/mixins/fetchable/fetchable.mixin',
  'xecmpf/controls/form/impl/fields/documenttypepicker/server.adaptor.mixin'
], function (_, $, Backbone, ConnectableMixin, FetchableMixin, ServerAdaptorMixin
) {

  var DocumentTypeModel = Backbone.Model.extend({
    idAttribute: 'classification_id',
    parse: function (response, options) {
      response.data.properties.name = response.data.properties.classification_name;
      return response.data.properties;
    }
  });

  var DocumentTypeCollection = Backbone.Collection.extend({

    model: DocumentTypeModel,

    constructor: function DocumentTypeCollection(models, options) {
      this.options = options || {};
      Backbone.Collection.prototype.constructor.call(this, models, options);

      this.makeConnectable(options)
          .makeFetchable(options)
          .makeServerAdaptor(options);
    }

  });

  ConnectableMixin.mixin(DocumentTypeCollection.prototype);
  FetchableMixin.mixin(DocumentTypeCollection.prototype);
  ServerAdaptorMixin.mixin(DocumentTypeCollection.prototype);

  return DocumentTypeCollection;

});

/* START_TEMPLATE */
csui.define('hbs!xecmpf/controls/form/impl/fields/documenttypepicker/documenttypepicker',['module','hbs','nuc/lib/handlebars'], function( module, hbs, Handlebars ){ 
var t = Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "maxlength=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"maxLength") || (depth0 != null ? lookupProperty(depth0,"maxLength") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"maxLength","hash":{},"data":data,"loc":{"start":{"line":5,"column":34},"end":{"line":5,"column":47}}}) : helper)))
    + "\" ";
},"3":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "placeholder=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"placeholder") || (depth0 != null ? lookupProperty(depth0,"placeholder") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"placeholder","hash":{},"data":data,"loc":{"start":{"line":6,"column":38},"end":{"line":6,"column":53}}}) : helper)))
    + "\"\r\n           ";
},"5":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "placeholder=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"emptyLabel") || (depth0 != null ? lookupProperty(depth0,"emptyLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"emptyLabel","hash":{},"data":data,"loc":{"start":{"line":7,"column":32},"end":{"line":7,"column":46}}}) : helper)))
    + "\"";
},"7":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "size=\""
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"size") : stack1), depth0))
    + "\"";
},"9":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "name=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"name") || (depth0 != null ? lookupProperty(depth0,"name") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"name","hash":{},"data":data,"loc":{"start":{"line":9,"column":24},"end":{"line":9,"column":32}}}) : helper)))
    + "\"";
},"11":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "data-"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"key") || (data && lookupProperty(data,"key"))) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"key","hash":{},"data":data,"loc":{"start":{"line":10,"column":33},"end":{"line":10,"column":41}}}) : helper)))
    + "=\""
    + container.escapeExpression(container.lambda(depth0, depth0))
    + "\"";
},"13":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(((helper = (helper = lookupProperty(helpers,"key") || (data && lookupProperty(data,"key"))) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"key","hash":{},"data":data,"loc":{"start":{"line":11,"column":34},"end":{"line":11,"column":42}}}) : helper)))
    + "=\""
    + container.escapeExpression(container.lambda(depth0, depth0))
    + "\"";
},"15":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "aria-labelledby=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"idBtnLabel") || (depth0 != null ? lookupProperty(depth0,"idBtnLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"idBtnLabel","hash":{},"data":data,"loc":{"start":{"line":12,"column":63},"end":{"line":12,"column":77}}}) : helper)))
    + "\" ";
},"17":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "aria-describedby=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"idBtnDescription") || (depth0 != null ? lookupProperty(depth0,"idBtnDescription") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"idBtnDescription","hash":{},"data":data,"loc":{"start":{"line":13,"column":48},"end":{"line":13,"column":68}}}) : helper)))
    + "\" ";
},"19":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return " aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"multiFieldLabel") || (depth0 != null ? lookupProperty(depth0,"multiFieldLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"multiFieldLabel","hash":{},"data":data,"loc":{"start":{"line":14,"column":42},"end":{"line":14,"column":61}}}) : helper)))
    + "\"";
},"21":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "\r\n        aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"writeModeAria") || (depth0 != null ? lookupProperty(depth0,"writeModeAria") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"writeModeAria","hash":{},"data":data,"loc":{"start":{"line":15,"column":20},"end":{"line":15,"column":37}}}) : helper)))
    + "\"";
},"23":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return " aria-required=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"ariaRequired") || (depth0 != null ? lookupProperty(depth0,"ariaRequired") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"ariaRequired","hash":{},"data":data,"loc":{"start":{"line":16,"column":42},"end":{"line":16,"column":58}}}) : helper)))
    + "\"";
},"25":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "      <div class=\"icon-container\">\r\n        <div class=\"csui-icon-edit inline-edit-icon edit-cancel\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"cancel") || (depth0 != null ? lookupProperty(depth0,"cancel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"cancel","hash":{},"data":data,"loc":{"start":{"line":21,"column":72},"end":{"line":21,"column":82}}}) : helper)))
    + "\"></div>\r\n      </div>\r\n";
},"27":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"applyFlag") : stack1),{"name":"if","hash":{},"fn":container.program(28, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":24,"column":6},"end":{"line":28,"column":13}}})) != null ? stack1 : "");
},"28":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "        <div class=\"icon-container binf-hidden\">\r\n          <div class=\"csui-icon apply-all binf-hidden\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"titleApplyAll") || (depth0 != null ? lookupProperty(depth0,"titleApplyAll") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"titleApplyAll","hash":{},"data":data,"loc":{"start":{"line":26,"column":62},"end":{"line":26,"column":79}}}) : helper)))
    + "\" tabindex=\"0\"></div>\r\n        </div>\r\n";
},"30":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "        "
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"hasData") : depth0),{"name":"if","hash":{},"fn":container.program(31, data, 0),"inverse":container.program(33, data, 0),"data":data,"loc":{"start":{"line":37,"column":8},"end":{"line":37,"column":76}}})) != null ? stack1 : "")
    + "\r\n                                                            target=\"_blank\"title=\""
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"anchorTitle") : stack1),{"name":"if","hash":{},"fn":container.program(35, data, 0),"inverse":container.program(37, data, 0),"data":data,"loc":{"start":{"line":38,"column":82},"end":{"line":39,"column":77}}})) != null ? stack1 : "")
    + "\"\r\n        "
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"multiFieldLabel") : depth0),{"name":"if","hash":{},"fn":container.program(39, data, 0),"inverse":container.program(41, data, 0),"data":data,"loc":{"start":{"line":40,"column":8},"end":{"line":41,"column":96}}})) != null ? stack1 : "")
    + ">\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"hasData") : depth0),{"name":"if","hash":{},"fn":container.program(43, data, 0),"inverse":container.program(45, data, 0),"data":data,"loc":{"start":{"line":42,"column":8},"end":{"line":46,"column":15}}})) != null ? stack1 : "")
    + "      </a>\r\n";
},"31":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return " <a href=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"data") || (depth0 != null ? lookupProperty(depth0,"data") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"data","hash":{},"data":data,"loc":{"start":{"line":37,"column":38},"end":{"line":37,"column":46}}}) : helper)))
    + "\" ";
},"33":function(container,depth0,helpers,partials,data) {
    return " <a href=\"#\" ";
},"35":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"anchorTitle") : stack1), depth0));
},"37":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(((helper = (helper = lookupProperty(helpers,"data") || (depth0 != null ? lookupProperty(depth0,"data") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"data","hash":{},"data":data,"loc":{"start":{"line":39,"column":62},"end":{"line":39,"column":70}}}) : helper)));
},"39":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return " aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"readModeMultiFieldAria") || (depth0 != null ? lookupProperty(depth0,"readModeMultiFieldAria") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"readModeMultiFieldAria","hash":{},"data":data,"loc":{"start":{"line":40,"column":44},"end":{"line":40,"column":70}}}) : helper)))
    + "\" ";
},"41":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "\r\n                                                            aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"readModeAria") || (depth0 != null ? lookupProperty(depth0,"readModeAria") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"readModeAria","hash":{},"data":data,"loc":{"start":{"line":41,"column":72},"end":{"line":41,"column":88}}}) : helper)))
    + "\"";
},"43":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "          <span>"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"data") || (depth0 != null ? lookupProperty(depth0,"data") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"data","hash":{},"data":data,"loc":{"start":{"line":43,"column":16},"end":{"line":43,"column":24}}}) : helper)))
    + "</span>\r\n";
},"45":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "          <span class=\"placeholder\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"noValue") || (depth0 != null ? lookupProperty(depth0,"noValue") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"noValue","hash":{},"data":data,"loc":{"start":{"line":45,"column":43},"end":{"line":45,"column":54}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"emptyLabel") || (depth0 != null ? lookupProperty(depth0,"emptyLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"emptyLabel","hash":{},"data":data,"loc":{"start":{"line":45,"column":56},"end":{"line":45,"column":70}}}) : helper)))
    + "</span>\r\n";
},"47":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "        <button title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"tooltip") || (depth0 != null ? lookupProperty(depth0,"tooltip") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"tooltip","hash":{},"data":data,"loc":{"start":{"line":49,"column":23},"end":{"line":49,"column":34}}}) : helper)))
    + "\"\r\n          "
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"schema") : depth0)) != null ? lookupProperty(stack1,"readonly") : stack1),{"name":"if","hash":{},"fn":container.program(48, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":50,"column":10},"end":{"line":50,"column":62}}})) != null ? stack1 : "")
    + "\r\n          "
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"multiFieldLabel") : depth0),{"name":"if","hash":{},"fn":container.program(39, data, 0),"inverse":container.program(50, data, 0),"data":data,"loc":{"start":{"line":51,"column":10},"end":{"line":53,"column":17}}})) != null ? stack1 : "")
    + "        >\r\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"hasData") : depth0),{"name":"if","hash":{},"fn":container.program(52, data, 0),"inverse":container.program(54, data, 0),"data":data,"loc":{"start":{"line":55,"column":10},"end":{"line":59,"column":17}}})) != null ? stack1 : "")
    + "        </button>\r\n";
},"48":function(container,depth0,helpers,partials,data) {
    return " aria-disabled=\"true\" ";
},"50":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "\r\n                aria-label=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"readModeAria") || (depth0 != null ? lookupProperty(depth0,"readModeAria") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"readModeAria","hash":{},"data":data,"loc":{"start":{"line":52,"column":28},"end":{"line":52,"column":44}}}) : helper)))
    + "\"\r\n";
},"52":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "            <span>"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"data") || (depth0 != null ? lookupProperty(depth0,"data") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"data","hash":{},"data":data,"loc":{"start":{"line":56,"column":18},"end":{"line":56,"column":26}}}) : helper)))
    + "</span>\r\n";
},"54":function(container,depth0,helpers,partials,data) {
    var helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "            <span class=\"placeholder\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"noValue") || (depth0 != null ? lookupProperty(depth0,"noValue") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"noValue","hash":{},"data":data,"loc":{"start":{"line":58,"column":45},"end":{"line":58,"column":56}}}) : helper)))
    + "\">"
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"emptyLabel") || (depth0 != null ? lookupProperty(depth0,"emptyLabel") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"emptyLabel","hash":{},"data":data,"loc":{"start":{"line":58,"column":58},"end":{"line":58,"column":72}}}) : helper)))
    + "</span>\r\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, helper, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"cs-field-write\">\r\n  <div class=\"cs-field-write-inner\">\r\n    <div class=\"cs-item-picker\">\r\n    <input type=\"text\" id=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"id") || (depth0 != null ? lookupProperty(depth0,"id") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"id","hash":{},"data":data,"loc":{"start":{"line":4,"column":27},"end":{"line":4,"column":33}}}) : helper)))
    + "\" aria-expanded=\"false\" aria-autocomplete=\"list\"\r\n      "
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"maxLength") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":5,"column":6},"end":{"line":5,"column":56}}})) != null ? stack1 : "")
    + "\r\n      "
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"placeholder") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(5, data, 0),"data":data,"loc":{"start":{"line":6,"column":6},"end":{"line":7,"column":54}}})) != null ? stack1 : "")
    + "\r\n      "
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"size") : stack1),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":8,"column":6},"end":{"line":8,"column":56}}})) != null ? stack1 : "")
    + "\r\n      "
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"name") : depth0),{"name":"if","hash":{},"fn":container.program(9, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":9,"column":6},"end":{"line":9,"column":40}}})) != null ? stack1 : "")
    + "\r\n      "
    + ((stack1 = lookupProperty(helpers,"each").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"data") : stack1),{"name":"each","hash":{},"fn":container.program(11, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":10,"column":6},"end":{"line":10,"column":61}}})) != null ? stack1 : "")
    + "\r\n      "
    + ((stack1 = lookupProperty(helpers,"each").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"attributes") : stack1),{"name":"each","hash":{},"fn":container.program(13, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":11,"column":6},"end":{"line":11,"column":62}}})) != null ? stack1 : "")
    + "\r\n      value=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"writeData") || (depth0 != null ? lookupProperty(depth0,"writeData") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"writeData","hash":{},"data":data,"loc":{"start":{"line":12,"column":13},"end":{"line":12,"column":26}}}) : helper)))
    + "\" "
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"idBtnLabel") : depth0),{"name":"if","hash":{},"fn":container.program(15, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":12,"column":28},"end":{"line":12,"column":86}}})) != null ? stack1 : "")
    + "\r\n      "
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"idBtnDescription") : depth0),{"name":"if","hash":{},"fn":container.program(17, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":13,"column":6},"end":{"line":13,"column":77}}})) != null ? stack1 : "")
    + "\r\n      "
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"multiFieldLabel") : depth0),{"name":"if","hash":{},"fn":container.program(19, data, 0),"inverse":container.program(21, data, 0),"data":data,"loc":{"start":{"line":14,"column":6},"end":{"line":15,"column":45}}})) != null ? stack1 : "")
    + "\r\n      "
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"ariaRequired") : depth0),{"name":"if","hash":{},"fn":container.program(23, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":16,"column":6},"end":{"line":16,"column":66}}})) != null ? stack1 : "")
    + "/>\r\n      <span class=\"cs-icon icon-caret-down \"></span>\r\n    </div>\r\n"
    + ((stack1 = (lookupProperty(helpers,"xif")||(depth0 && lookupProperty(depth0,"xif"))||container.hooks.helperMissing).call(depth0 != null ? depth0 : (container.nullContext || {}),"this.mode !== 'writeonly'",{"name":"xif","hash":{},"fn":container.program(25, data, 0),"inverse":container.program(27, data, 0),"data":data,"loc":{"start":{"line":19,"column":4},"end":{"line":29,"column":12}}})) != null ? stack1 : "")
    + "\r\n  </div>\r\n</div>\r\n<div class=\"cs-field-read\">\r\n  <div class=\"cs-field-read-inner\">\r\n    <div class=\"btn-container\">\r\n"
    + ((stack1 = (lookupProperty(helpers,"xif")||(depth0 && lookupProperty(depth0,"xif"))||container.hooks.helperMissing).call(depth0 != null ? depth0 : (container.nullContext || {}),"this.options && this.options.type === 'url'",{"name":"xif","hash":{},"fn":container.program(30, data, 0),"inverse":container.program(47, data, 0),"data":data,"loc":{"start":{"line":36,"column":6},"end":{"line":61,"column":14}}})) != null ? stack1 : "")
    + "    </div>\r\n    <div class=\"icon-container\">\r\n      <div class=\"csui-icon-edit inline-edit-icon icon-edit\" title=\""
    + container.escapeExpression(((helper = (helper = lookupProperty(helpers,"edit") || (depth0 != null ? lookupProperty(depth0,"edit") : depth0)) != null ? helper : container.hooks.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{"name":"edit","hash":{},"data":data,"loc":{"start":{"line":64,"column":68},"end":{"line":64,"column":76}}}) : helper)))
    + "\"></div>\r\n    </div>\r\n  </div>\r\n</div>\r\n";
},"useData":true});
Handlebars.registerPartial('xecmpf_controls_form_impl_fields_documenttypepicker_documenttypepicker', t);
return t;
});
/* END_TEMPLATE */
;
csui.define('xecmpf/controls/form/impl/nls/lang',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});
csui.define('xecmpf/controls/form/impl/nls/root/lang',{

  nodePickerDialogTitle: 'Select {0}',
  noValue: '(no value)',
  edit: 'Edit',
  cancel: 'Cancel',
  editFields: 'Edit fields', //Only for multi-field attributes

  fieldEditAria: '{0}: {1}, Click to Edit',
  fieldReadOnlyAria: '{0}: {1}', // like Age: 23 or Name: Smith
  userFieldReadOnlyAria: '{0}: {1}, Click to view profile',
  emptyUserFieldReadOnlyAria: '{0}: {1}',
  requiredField: ', Required',

  addField: 'Add new field',
  removeField: 'Remove field',
  addRow: 'Add row',
  removeRow: 'Remove row',
  selectFieldDefaultLabel: 'None',
  selectValueLabel: 'Select value',
  addFieldAria: 'Add {0} field',
  removeFieldAria: 'Remove {0} field',
  clearValue: "Clear input value",

  datePickerIcon: 'Date picker',

  originalNodeUnavailable: 'Unavailable node',
  originalNodeUnavailableTooltip: 'The original node is unavailable or you do not have' +
                                  ' permission to access it.',

  invalidItem: 'Invalid item',
  invalidUser: 'Invalid user',
  invalidGroup: 'Invalid group',
  invalidUserOrGroup: 'Invalid user or group',
  invalidTkl: 'Invalid Value',

  // alpaca placeholder
  alpacaPlaceholderNotAvailable: 'n/a',
  alpacaPlaceholderGeneric: 'Add value',
  alpacaPlaceholderNumber: 'Add value',
  alpacaPlaceholderText: 'Add text',
  alpacaPlaceholderTime: 'Add time',
  alpacaPlaceholderDate: 'Add date',
  alpacaPlaceholderDateTime: 'Add date and time',
  alpacaPlaceholderEmail: 'Add email',
  alpacaPlaceholderFile: 'Select file',
  alpacaPlaceholderPassword: 'Add password',
  alpacaPlaceholderPhone: 'Add phone number',
  alpacaPlaceholderSearch: 'Enter search',
  alpacaPlaceholderUrl: 'Add web address',
  alpacaPlaceholderIPv4: 'Add IP address',
  alpacaPlaceholderOTUserPicker: 'Add user',
  alpacaPlaceholderOTGroupPicker: 'Add group',
  alpacaPlaceholderOTUserGroupPicker: 'Add user or group',
  alpacaPlaceholderOTNodePicker: 'Select',
  alpacaPlaceholderDocumentTypePicker: 'Add document type',
  titleApplyAll: "Apply to all selected items",
  confirmApplyNotification: "Applied to all selected documents",
  titleColoutButton: 'Open summary view',

  seeMore: "See more",
  seeLess: "See less",

  tklFieldNone: 'None',
  noResultFound: 'No results found',

  noOwner: '<No Owner>',
  // alpaca placeholder - No value
  noValueSet: 'No value',
  radioFieldValidationErrorInvalidValue: 'The selected value does not exist anymore.',
  showMore: "Show more",
  showLess: "Show less",
  showMoreAria: "Show more rows",
  showLessAria: "Show less rows"
});


csui.define('css!xecmpf/controls/form/impl/fields/documenttypepicker/documenttypepicker',[],function(){});
csui.define('xecmpf/controls/form/fields/documenttypepicker.view',['module',
  'require', 'csui/lib/underscore', 'csui/lib/jquery', 'csui/lib/backbone',
  'csui/lib/handlebars',
  'csui/utils/base',
  'csui/utils/contexts/factories/connector',
  'csui/controls/form/fields/base/csformfield.view',
  'csui/utils/log',
  'xecmpf/controls/form/impl/fields/documenttypepicker/documenttypecollection',
  'hbs!xecmpf/controls/form/impl/fields/documenttypepicker/documenttypepicker',
  'i18n!xecmpf/controls/form/impl/nls/lang',
  'css!xecmpf/controls/form/impl/fields/documenttypepicker/documenttypepicker',
  'csui/lib/bootstrap3-typeahead'
], function (module, require, _, $, Backbone, Handlebars, base, ConnectorFactory,
    FormFieldView, Log, DocumentTypeCollection, template,
    lang) {

  var log = new Log(module.id);

  var DocumentTypePicker = FormFieldView.extend({

    constructor: function DocumentTypePicker(options) {
      FormFieldView.apply(this, arguments);
      options = options || {};
      this.connector = options.context.getObject(ConnectorFactory);
      this.emptyTemplate = Handlebars.compile(
          '<span>' +
          '<li class="csui-typeahead-picker-no-results {{#if classNoResults}}' +
          ' {{classNoResults}}{{/if}}">{{langNoResults}}</li>' +
          '</span>')({
        classNoResults: 'documenttypepicker-noresults',
        langNoResults: lang.noResultFound
      });
    },
    className: 'cs-formfield cs-documenttypepicker',

    template: template,
    typeaheadFieldWithCaret: true,

    ui: function () {
      return _.defaults({
        itempicker: 'div.cs-item-picker',
        caretIcon: '.icon-caret-down',
        inputBox: 'input',
      }, FormFieldView.prototype.ui);
    },

    events: function () {
      return _.defaults({
        'mousedown @ui.caretIcon': 'clickCaretIcon',
        'mousedown @ui.inputBox': 'mouseDownOnInput',
        'mouseup @ui.inputBox': 'mouseUpOnInput',
        'focus @ui.inputBox': 'selectText',
        'blur @ui.inputBox': 'onBlur',
        'keydown @ui.inputBox': 'onKeyDown',
        'mousedown': 'onMouseDown'
      }, FormFieldView.prototype.events);
    },

    templateHelpers: function () {
      var multiFieldLabel        = "",
          writeModeAria          = "",
          data                   = lang.alpacaPlaceholderGeneric,
          writeData              = "",
          readModeAria           = "", // better default value?
          readModeMultiFieldAria = "", // better default value?
          isRequired             = false,
          isReadOnly             = this.mode === "readonly",
          requiredTxt            = "",
          placeholder            = this.options.alpacaField && this.options.alpacaField.options &&
                                   this.options.alpacaField.options.placeholder ||
                                   lang.alpacaPlaceholderDocumentTypePicker,
          maxLength              = this.options.alpacaField && this.options.alpacaField.schema &&
                                   this.options.alpacaField.schema.maxLength;

      isRequired = this.options.alpacaField && this.options.alpacaField.isRequired();
      requiredTxt = isRequired ? lang.requiredField : "";
      writeModeAria = this.alpacaField.options.label || placeholder;
      if (!!this.model.get('data').classification_name) {
        data = this.model.get('data').classification_name;
        writeData = this.model.get('data').classification_name;
      }
      if (this.alpacaField && this.alpacaField.options &&
          this.alpacaField.options.isMultiFieldItem) {
        multiFieldLabel = (this.alpacaField.parent && this.alpacaField.parent.options) ?
                          this.alpacaField.parent.options.label : "";
      }
      if (this.model.get('options')) {
        readModeAria = isReadOnly ?
                       _.str.sformat(lang.fieldReadOnlyAria, this.model.get('options').label,
                           data) + requiredTxt :
                       _.str.sformat(lang.fieldEditAria, this.model.get('options').label, data) +
                       requiredTxt;
      }

      readModeMultiFieldAria = isReadOnly ?
                               _.str.sformat(lang.fieldReadOnlyAria, multiFieldLabel, data) +
                               requiredTxt :
                               _.str.sformat(lang.fieldEditAria, multiFieldLabel, data) +
                               requiredTxt;
      return _.extend(FormFieldView.prototype.templateHelpers.apply(this), {
        inputType: 'text',
        idBtnLabel: this.options.labelId,
        idBtnDescription: this.options.descriptionId,
        writeModeAria: writeModeAria,
        readModeAria: readModeAria,
        readModeMultiFieldAria: readModeMultiFieldAria,
        multiFieldLabel: multiFieldLabel,
        ariaRequired: isRequired,
        maxLength: maxLength,
        placeholder: placeholder,
        data: data,
        writeData: writeData
      });
    },

    initialize: function () {
      this.collection = new DocumentTypeCollection(undefined, {
        connector: this.options.context.getObject(ConnectorFactory),
        autoreset: true
      });

      // TODO: this needs to be changed while integration with business workspace picker.
      // A listener need to be written which listens for business workspace picker id change.
      // and then assign the id to this property and call getDocumentTypes().
      this.collection.businessWorkspaceId = this.options.alpacaField &&
                                            this.options.alpacaField.options.businessWorkspaceId;
      this.getDocumentTypes();
    },

    // to check whether a drop down item is clicked or the clear or search icon.
    onMouseDown: function (event) {
      if (this._isInPicker(event.target, '.typeahead.scroll-container')) {
        // must stop mousedown propagation here otherwise the alpaca fousout handling
        // suppresses/steals the click event in some cases and the fields, wehre the
        // click events were stolen don't work anymore.
        event.preventDefault();
        event.stopPropagation();
      }
    },

    _isInPicker: function (element, included) {
      var picker = this.$(".cs-item-picker");
      if (picker[0] && $.contains(picker[0], element)) {
        if (included && $(included).length) {
          if ($.contains($(included)[0], element)) {
            return true;
          }
        }
      }
      return false;
    },

    onBlur: function () {
      this.ui.inputBox.attr("aria-expanded", false);
    },

    selectText: function () {
      this.ui.inputBox.select();
    },

    mouseDownOnInput: function () {
      this.typeahead.options.showHintOnFocus = true;
    },

    mouseUpOnInput: function () {
      this.typeahead.options.showHintOnFocus = false;
    },

    isDropDownOpen: function () {
      return $('.binf-dropdown-menu').is(":visible");
    },

    isReadyToSave: function () {
      return this.getItemPicked();
    },

    getDocumentTypes: function (args) {
      this.collection.fetch();
    },

    source: function () {
      return this.collection.models;
    },

    setItemPicked: function (bool) {
      this.itemPicked = bool;
    },

    getItemPicked: function () {
      return this.itemPicked;
    },

    _afterSelect: function (item) {
      this.setItemPicked(true);
      this.ui.inputBox.attr("aria-expanded", false);
      this.editValue = item.attributes;
      this.selectText();
      this.alpacaField && this.alpacaField.refreshValidationState(false);
    },

    _retrieveDisplayText: function (item) {
      return item.get('classification_name');
    },

    onRender: function () {
      this.data = this.model.get('data');
      this.editValue = this.data;
      this.curVal = this.editValue;
      //As this handler should be called before typeahead events handler.
      this.ui.inputBox.on('keyup', this.onKeyUp.bind(this));
      var typeaheadOptions = {
        items: 'all',
        showHintOnFocus: false,
        minLength: 0,
        source: this.source.bind(this),
        afterSelect: _.bind(this._afterSelect, this),
        autoSelect: false,
        appendTo: this.ui.itempicker,
        prettyScrolling: true,
        handleNoResults: true,
        emptyTemplate: this.emptyTemplate,
        displayText: this._retrieveDisplayText.bind(this),
        afterShow: this._adjustPerfectScroll.bind(this),
        scrollContainerHeight: 240,
        selectOnBlur: false
      };
      this.ui.inputBox.typeahead(typeaheadOptions);
      this.typeahead = this.ui.inputBox.data().typeahead;
      this.setItemPicked(true);
    },

    _adjustPerfectScroll: function () {
      this.typeahead.$scrollContainer.perfectScrollbar("update");
      this.ui.inputBox.attr("aria-expanded", true);
    },

    trySetValue: function () {
      var editVal           = this.getEditValue() !== null &&
                              this.getEditValue() !== undefined ? this.getEditValue() :
                              "", // new value
          curVal            = this.getValue() !== null && this.getValue() !== undefined ?
                              this.getValue().toString() : "",  // old value
          bIsValid          = true,
          hasClassInvalid   = this.$el.hasClass('cs-formfield-invalid'),
          isReadyToSaveView = this.isReadyToSave(),
          //flags used to check scenario where empty-required-fields are present in  update-mode
          isRequired        = this.alpacaField && this.alpacaField.schema.required,
          validate          = this.alpacaField && this.alpacaField.options.validate,
          writeonly         = this.mode === "writeonly",
          emptyField        = curVal === "";

      bIsValid = this.getItemPicked && this.getItemPicked();
      if (isReadyToSaveView && ((editVal !== curVal) || writeonly || hasClassInvalid ||
          (!writeonly && isRequired && validate && emptyField)) || this.mlDataChanged) {
        bIsValid = this.setValue(editVal, true);
      }
      return bIsValid;
    },

    clickCaretIcon: function (e) {

      if (e.which === 1 && !this.$el.find('ul').is(':visible')) {
        setTimeout(function () {
          this.typeahead.options.showHintOnFocus = true;
          this.ui.inputBox.focus();
          this.typeahead.options.showHintOnFocus = false;
        }.bind(this));
      }
    },

    _getChangeEventValue: function () {
      var ret = this.getValue().classification_id;
      return ret;
    },

    getEditValue: function () {
      // in case the field has been reset (by deleting input field text)
      var fieldValue = this.ui.inputBox.val();
      if (!fieldValue) {
        this.editValue = {
          'classification_name': "",
          'classification_id': null
        };
      }
      if (this.getItemPicked()) {
        this.ui.inputBox.val(this.editValue.classification_name);
      }

      return this.editValue;
    },

    onKeyPress: function (event) {

      if (event.keyCode === 13) { // enter:13
        event.preventDefault();
        event.stopPropagation();
        if (this.getStatesBehavior().isStateRead() && this.allowEditOnEnter()) {
          this.getEditableBehavior().setViewStateWriteAndEnterEditMode();
        } else if (this.getStatesBehavior().isStateWrite() && this.allowSaveOnEnter()) {
          this.getEditableBehavior().trySetValueAndLeaveEditMode(true, true);
        }
      } else if (event.keyCode === 32) {  // space
        if (this.getStatesBehavior().isStateRead() && this.allowEditOnEnter()) {
          event.preventDefault();
          event.stopPropagation();
          this.getEditableBehavior().setViewStateWriteAndEnterEditMode();
        }
      }
      if (event.keyCode === 13 || event.keyCode === 16 ||  // enter, shift, f2
          event.keyCode === 113) {  // for refreshing validation state
        if (this.alpacaField && this.alpacaField.refreshValidationState) {
          this.alpacaField.refreshValidationState(false);
        }
      } else {
        this.setItemPicked(false);
      }
      return true; // we handle it
    },

    onKeyDown: function (event) {

      if (event.keyCode === 27) { // escape
        this.options.isDropDownOpen = this.isDropDownOpen();
        event.preventDefault();
      } else if (event.keyCode === 13 || event.keyCode === 32 || event.keyCode === 9) { // enter, space and tab
        if (this.alpacaField) {
          this.alpacaField.keyDown = true;
        }
      }

    },

    onKeyUp: function (event) {
      // to stop focus from tab opening the dropdown
      if (event.keyCode === 9 && !this.alpacaField.keyDown) { // tab
        event.stopImmediatePropagation();
      }
      if (event.keyCode === 13) { // enter:13
        if (this.alpacaField && this.alpacaField.refreshValidationState &&
            !!this.alpacaField.keyDown) {
          var that = this;
          this.alpacaField.refreshValidationState(false, function () {
            if (that.alpacaField.field.hasClass('alpaca-invalid')) {
              that.alpacaField.fieldView.$el.find('input').select();
            }
          });
        }

      }
      else if (event.keyCode === 8 || event.keyCode === 46) { // backspace and del key respectively
        if (event.target.value === '') {
          this.setItemPicked(true);
          this.$el.removeClass('cs-formfield-invalid');
          if (this.mode === 'writeonly') {
            this.model.set('data', "");
          }
        } else {
          this.setItemPicked(false);
        }
      }
      else if (event.keyCode === 27) { //escape:27
        this.ui.inputBox.attr("aria-expanded", false);
        event.preventDefault();
        event.stopPropagation();
      }
      if (this.alpacaField) {
        this.alpacaField.keyDown = false;
      }
    }
  });
  return DocumentTypePicker;
});

csui.define('xecmpf/controls/form/fields/alpaca/alpdocumenttypepickerfield',['csui/lib/underscore', 'csui/lib/jquery',
  'csui/lib/backbone', 'csui/lib/marionette',
  'csui/lib/alpaca/js/alpaca.lite',
  'xecmpf/controls/form/fields/documenttypepicker.view',
  'i18n!xecmpf/controls/form/impl/nls/lang'
], function (_, $, Backbone,
    Marionette, Alpaca,
    DocumentTypePickerView,
    Lang) {

  Alpaca.Fields.XecmpfDocumentTypePickerField = Alpaca.Fields.TextField.extend({

    constructor: function XecmpfDocumentTypePickerField(container, data, options, schema, view,
        connector, onError) {
      var errorMessage = "Invalid item";
      options = _.extend(options, {
        alpacaFieldType: 'xecmpf_document_type_picker',
        lang: {
          invalidItem: errorMessage
        },
      });

      this.base(container, data, options, schema, view, connector, onError);
    },

    setValueAndValidate: function (value, validate) {
      this.setValue(value);
      var bIsValid = true;
      if (validate) {
        bIsValid = this.validate();
        this.refreshValidationState(false);
      } else {
        this.fieldView.$el.trigger($.Event('field:invalid'));
        var formValue = this.fieldView.ui.writeField && this.fieldView.ui.writeField.val();
        if (this.fieldView.$el.hasClass('cs-formfield-invalid') && this.fieldView.preVal !==
            formValue) {
          this.fieldView.$el.find('input.typeahead').select();
          this.fieldView.preVal = formValue;
        }
      }
      return bIsValid;
    },

    postRender: function (callback) {
      this.base(callback);
      this.showField({
        'classification_name': "",
        'classification_id': null
      });
      this.field.parent().addClass("csui-field-" + this.getFieldType());
    },

    getValue: function () {
      var retValue = "";
      if (!!this.data && !!this.data.classification_id) { // updated field
        retValue = this.data.classification_id;
      } else if (!!this.data) { // initial value
        retValue = (this.data.classification_id === "" || this.data.classification_id === null) ?
                   "" : this.data;
      }
      return retValue;
    },

    handleValidate: function () {
      var ret = this.base();
      if (!ret) {
        var arrayValidations = this.validation;
        if (this.fieldView.$el.find("input").val() !== undefined &&
            this.fieldView.$el.find("input").val()) {
          arrayValidations["notOptional"]["status"] = true;
          arrayValidations["notOptional"]["message"] = "";
          return ret;
        }
        for (var validation in arrayValidations) {
          if (arrayValidations[validation]["status"] === false) {
            if (validation !== "notOptional") {
              arrayValidations[validation]["status"] = true;
              arrayValidations[validation]["message"] = "";
            }
          }
        }
      }
      return ret;
    },

    showField: function (data) {

      var id = this.id;

      // add an id to the <label> element like alpaca23Label
      var id4Label, id4Description = this.options ? this.options.descriptionId : '',
          labelElement             = $(this.field[0]).find('label');

      if (labelElement && labelElement.length === 1) {
        id4Label = labelElement.attr('for') + "Label";
        labelElement.attr('id', id4Label);
      }

      // our field
      this.fieldView = new DocumentTypePickerView({
        model: new Backbone.Model({
          data: data,
          options: this.options,
          schema: this.schema,
          inputType: 'text',
          id: id
        }),
        data: data,
        context: this.connector.config.context,
        id: _.uniqueId(id), // wrapper <div>
        alpacaField: this,
        labelId: id4Label,
        descriptionId: id4Description,
        value: this.data,
        dataId: this.name,
        path: this.path,
        alpaca: {
          data: this.data,
          options: this.options,
          schema: this.schema
        }
      });

      if (this.options.fieldValidator) {
        this.options.validator = this.options.fieldValidator;
      } else {
        this.options.validator = function (callback) {
          var status = this.fieldView && this.fieldView.getItemPicked &&
                       this.fieldView.getItemPicked();
          callback({
            "status": status,
            "message": status ? "" :
                       this.options.lang && this.options.lang.invalidItem || Lang.invalidItem
          });
        };
      }

      // replace alpaca control with empty div having same classes as control
      var $field = $('<div>').addClass('alpaca-control');
      this.getControlEl().replaceWith($field);

      // show our field in div
      this.region = new Marionette.Region({el: $field});
      this.region.show(this.fieldView);

      return;
    },
  });

  Alpaca.registerFieldClass('xecmpf_document_type_picker',
      Alpaca.Fields.XecmpfDocumentTypePickerField);

  return $.alpaca.Fields.XecmpfDocumentTypePickerField;
});

csui.define('xecmpf/utils/commands/navigate/navigate.workspace',[], function () {
    return {
        isWorkspaceNavigationEnabled: function (status, options) {
            if (status.context && status.context.options) {
                var contextOptions = status.context.options;
                if (contextOptions.enableWorkspaceNavigation === false) {
                    return false;
                } else {
                    return true;
                }
            }
            return true;
        },

        checkNodesTableToolbarElements: function (status, options, current) {
            if (status.context && status.context.options) {
                var contextOptions = status.context.options;
                if (contextOptions.navigateMode && contextOptions.navigateMode === 'treeView') {
                    return { treeView: true, navigateUp: false };
                } else if (contextOptions.navigateMode && contextOptions.navigateMode === 'navigateUp') {
                    return { treeView: false, navigateUp: true };
                }
            }
            return current;
        },

        checkHeaderViewOptions: function (options, current) {
            if (options.context && options.context.options) {
                var contextOptions = options.context.options;
                if (contextOptions.headerViewOptions) {
                    return contextOptions.headerViewOptions;
                }
            }
            return current;
        }
    };
});
csui.define('xecmpf/controls/breadcrumbspanel/breadcrumbspanel.extension',[], function () {
  'use strict';

  var BreadcrumbsPanelExtension = {

    hideBreadcrumbs: function (options) {
      var contextOptions = options && options.context && options.context.options;
      return !!(contextOptions && contextOptions.hideBreadcrumbsPanel);
    }

  };

  return BreadcrumbsPanelExtension;
});

csui.define('json!xecmpf/widgets/workspaces/workspaces.manifest.json',{
  "$schema": "http://opentext.com/cs/json-schema/draft-04/schema#",
  "title": "Workspaces Creation and Completion Widget",
  "description": "User gets a list of early workspaces so he can select one workspace to complete the reference. If the user does not find an appropriate early workspace he can create a new workspace.",
  "schema": {
    "type": "object",
    "properties": {
      "busObjectId": {
        "type": "string",
        "title": "Business object id",
        "description": "ID of a business object"
      },
      "busObjectType": {
        "type": "string",
        "title": "Business object type",
        "description": "Type of a business object"
      },
      "extSystemId": {
        "type": "string",
        "title": "External system id",
        "description": "ID of an external system"
      }
    }
  }
}
);


csui.define('json!xecmpf/widgets/boattachments/boattachments.manifest.json',{
  "$schema": "http://opentext.com/cs/json-schema/draft-04/schema#",
  "title": "{{widgetTitle}}",
  "description": "{{widgetDescription}}",
  "schema": {
    "type": "object",
    "properties": {
      "title": {
        "type": "object",
        "title": "{{tileTitle}}",
        "description": "{{tileDescription}}"
      },
      "businessattachment": {
        "type": "object",
        "title": "{{businessAttachmentTitle}}",
        "description": "{{businessAttachmentDesc}}",
        "properties": {
          "properties": {
            "type": "object",
            "title": "{{busAttPropertiesTitle}}",
            "description": "{{busAttPropertiesDesc}}",
            "properties": {
              "busObjectId": {
                "type": "string",
                "title": "{{boIdTitle}}",
                "default": "",
                "description": "{{boIdDesc}}"
              },
              "busObjectType": {
                "type": "string",
                "title": "{{boTypeTitle}}",
                "default": "",
                "description": "{{boTypeDesc}}"
              },
              "extSystemId": {
                "type": "string",
                "title": "{{busAppTitle}}",
                "default": "",
                "description": "{{busAppDesc}}"
              }
            }
          }
        }
      },
      "collapsedView": {
        "type": "object",
        "title": "{{collapsedViewTitle}}",
        "description": "{{collapsedViewDesc}}",
        "properties": {
          "noResultsPlaceholder": {
            "type": "object",
            "title": "{{noResultsPlaceholderTitle}}",
            "description": "{{noResultsPlaceholderDescription}}"
          },
          "orderBy": {
            "type": "object",
            "title": "{{orderTitle}}",
            "description": "{{orderDescription}}",
            "properties": {
              "sortColumn": {
                "type": "string",
                "title": "{{sortColumnTitle}}",
                "description": "{{sortColumnDescription}}"
              },
              "sortOrder": {
                "type": "string",
                "enum": [
                  "asc",
                  "desc"
                ],
                "title": "{{sortOrderTitle}}",
                "description": "{{sortOrderDescription}}"
              }
            }
          },
          "title": {
            "type": "object",
            "title": "{{businessAttachmentsTileTitle}}",
            "description": "{{businessAttachmentsTileDesc}}",
            "properties": {
              "value": {
                "type": "string",
                "title": "{{valueTitle}}",
                "description": "{{valueDescription}}"
              }
            }
          },
          "description": {
            "type": "object",
            "title": "{{descriptionSectionTitle}}",
            "description": "{{descriptionSectionDesc}}",
            "properties": {
              "value": {
                "type": "string",
                "title": "{{descriptionValueTitle}}",
                "description": "{{descriptionFieldValue}}"
              }
            }
          },
          "topRight": {
            "type": "object",
            "title": "{{topRightSectionTitle}}",
            "description": "{{topRightSectionDescription}}",
            "properties": {
              "label": {
                "type": "object",
                "title": "{{topRightLabel}}",
                "description": "{{topRightLabelDesc}}"
              },
              "value": {
                "type": "string",
                "title": "{{topRightValue}}",
                "description": "{{topRightValueDesc}}"
              }
            }
          },
          "bottomLeft": {
            "type": "object",
            "title": "{{bottomLeftTitle}}",
            "description": "{{bottomLeftTitleDesc}}",
            "properties": {
              "label": {
                "type": "object",
                "title": "{{bottomLeftLabelTitle}}",
                "description": "{{bottomLeftLabelDesc}}"
              },
              "value": {
                "type": "string",
                "title": "{{bottomLeftValue}}",
                "description": "{{bottomLeftValueDesc}}"
              }
            }
          },
          "bottomRight": {
            "type": "object",
            "title": "{{bottomRightTitle}}",
            "description": "{{bottomRightTitleDesc}}",
            "properties": {
              "label": {
                "type": "object",
                "title": "{{bottomRightLabel}}",
                "description": "{{bottomRightLabelDesc}}"
              },
              "value": {
                "type": "string",
                "title": "{{bottomRightValue}}",
                "description": "{{bottomRightValueDesc}}"
              }
            }
          }
        }
      },
      "expandedView": {
        "type": "object",
        "title": "{{expandedViewTitle}}",
        "description": "{{expandedViewDesc}}",
        "properties": {
          "orderBy": {
            "type": "object",
            "title": "{{orderTitle}}",
            "description": "{{orderDescription}}",
            "properties": {
              "sortColumn": {
                "type": "string",
                "title": "{{sortColumnTitle}}",
                "description": "{{sortColumnDescription}}"
              },
              "sortOrder": {
                "type": "string",
                "enum": [
                  "asc",
                  "desc"
                ],
                "title": "{{sortOrderTitle}}",
                "description": "{{sortOrderDescription}}"
              }
            }
          }
        }
      },
      "snapshot": {
        "type": "object",
        "title": "{{snapshotTitle}}",
        "description": "{{snapshotDesc}}",
        "properties": {
          "parentFolderName": {
            "type": "string",
            "title": "{{parentFolderTitle}}",
            "description": "{{parentFolderDesc}}"
          },
          "folderNamePrefix": {
            "type": "string",
            "title": "{{snapshotNameTitle}}",
            "description": "{{snapshotNameDesc}}"
          }
        }
      }
    }
  },
  "options": {
    "fields": {
      "businessattachment": {
        "fields": {
          "properties": {
            "fields": {
              "busObjectId": {
                "type": "otconws_metadata_string"
              },
              "busObjectType": {
                "type": "otconws_metadata_string"
              },
              "extSystemId": {
                "type": "otconws_metadata_string"
              }
            }
          }
        }
      },
      "title": {
        "type": "otcs_multilingual_string"
      },
      "collapsedView": {
        "fields": {
          "noResultsPlaceholder": {
            "type": "otcs_multilingual_string"
          },
          "orderBy": {
            "fields": {
              "sortColumn": {
                "type": "otconws_customcolumn"
              },
              "sortOrder": {
                "type": "select",
                "optionLabels": [
                  "{{sortOrderOptionLabelAsc}}",
                  "{{sortOrderOptionLabelDesc}}"
                ]
              }
            }
          },
          "title": {
            "fields": {
              "value": {
                "type": "otconws_customcolumn"
              }
            }
          },
          "description": {
            "fields": {
              "value": {
                "type": "otconws_customcolumn"
              }
            }
          },
          "topRight": {
            "fields": {
              "label": {
                "type": "otcs_multilingual_string"
              },
              "value": {
                "type": "otconws_customcolumn"
              }
            }
          },
          "bottomLeft": {
            "fields": {
              "label": {
                "type": "otcs_multilingual_string"
              },
              "value": {
                "type": "otconws_customcolumn"
              }
            }
          },
          "bottomRight": {
            "fields": {
              "label": {
                "type": "otcs_multilingual_string"
              },
              "value": {
                "type": "otconws_customcolumn"
              }
            }
          }
        }
      },
      "expandedView": {
        "fields": {
          "orderBy": {
            "fields": {
              "sortColumn": {
                "type": "otconws_customcolumn"
              },
              "sortOrder": {
                "type": "select",
                "optionLabels": [
                  "{{sortOrderOptionLabelAsc}}",
                  "{{sortOrderOptionLabelDesc}}"
                ]
              }
            }
          }
        }
      },
      "snapshot": {
        "fields": {
          "parentFolderName": {
            "type": "text"
          },
          "folderNamePrefix": {
            "type": "text"
          }
        }
      }
    }
  }
}
);


csui.define('json!xecmpf/widgets/dossier/dossier.manifest.json',{
  "$schema": "http://opentext.com/cs/json-schema/draft-04/schema#",
  "title": "{{widgetTitle}}",
  "description": "{{widgetDescription}}",
  "schema": {
    "type": "object",
    "properties": {
      "groupBy": {
        "type": "string",
        "enum": [
          "{{classification}}",
          "{{create_date}}"
        ],
        "default": "{{create_date}}",
        "title": "{{groupBy_title}}",
        "description": "{{groupBy_Description}}"
      },
      "hideGroupByCriterionDropdown": {
        "type": "boolean",
        "enum": [
          true,
          false
        ],
        "default": false,
        "title": "{{hideGroupByCriterionDropdown_title}}",
        "description": "{{hideGroupByCriterionDropdown_description}}"
      },
      "hideMetadata": {
        "type": "boolean",
        "enum": [
          true,
          false
        ],
        "default": false,
        "title": "{{hideMetadata_title}}",
        "description": "{{hideMetadata_description}}"
      },
      "metadata": {
        "type": "array",
        "title": "{{metadata_title}}",
        "description": "{{metadata_description}}",
        "items": {
          "type": "object",
          "title": "{{metadata_items_title}}",
          "description": "{{metadata_items_description}}"
        }
      },
      "hideEmptyFields": {
        "type": "boolean",
        "enum": [
          true,
          false
        ],
        "default": false,
        "title": "{{hideEmptyFields_title}}",
        "description": "{{hideEmptyFields_description}}"
      },
      "hideFavorite": {
        "type": "boolean",
        "enum": [
          true,
          false
        ],
        "default": false,
        "title": "{{hideFavorite_title}}",
        "description": "{{hideFavorite_description}}"
      }
    }
  },
  "options": {
    "fields": {
      "groupBy": {
        "type": "select",
        "optionLabels": [
          "Classification",
          "Create Date"
        ]
      },
      "metadata": {
        "fields": {
          "item": {
            "type": "otconws_metadata"
          }
        }
      }
    }
  }
}
);


csui.define('json!xecmpf/widgets/header/header.manifest.json',{
  "$schema": "http://opentext.com/cs/json-schema/draft-04/schema#",
  "title": "{{widgetTitle}}",
  "description": "{{widgetDescription}}",
  "schema": {
    "type": "object",
    "properties": {
      "workspace": {
        "type": "object",
        "title": "{{workspaceTitle}}",
        "description": "{{workspaceDescription}}",
        "properties": {
          "properties": {
            "type": "object",
            "title": "{{workspacePropertiesTitle}}",
            "description": "{{workspacePropertiesDesc}}",
            "properties": {
              "title": {
                "type": "string",
                "title": "{{businessworkspaceTitle}}",
                "default": "{name}",
                "description": "{{businessworkspaceDesc}}"
              },
              "type": {
                "type": "string",
                "title": "{{workspaceTypeTitle}}",
                "default": "{business_properties.workspace_type_name}",
                "description": "{{workspaceTypeDesc}}"
              },
              "description": {
                "type": "string",
                "title": "{{descriptionSectionTitle}}",
                "default": "{description}",
                "description": "{{descriptionSection}}"
              }
            }
          }
        }
      },
      "completenessCheckSettings": {
        "type": "object",
        "title": "{{completenessCheckTitle}}",
        "description": "{{completenessCheckDescription}}",
        "properties": {
          "hideMissingDocsCheck": {
            "title": "{{hideMissingDocsCheckTitle}}",
            "description": "{{hideMissingDocsCheckDescription}}",
            "type": "boolean",
            "default": false
          },
          "hideOutdatedDocsCheck": {
            "title": "{{hideOutdatedDocsCheckTitle}}",
            "description": "{{hideOutdatedDocsCheckDescription}}",
            "type": "boolean",
            "default": false
          },
          "hideInProcessDocsCheck": {
            "title": "{{hideInProcessDocsCheckTitle}}",
            "description": "{{hideInProcessDocsCheckDesc}}",
            "type": "boolean",
            "default": false
          }
        }
      },
      "headerwidget": {
        "type": "object",
        "title": "{{additionalWidgetTitle}}",
        "description": "{{additionalWidgetDescription}}",
        "properties": {
          "type": {
            "type": "string",
            "enum": [
              "none",
              "activityfeed",
              "metadata"
            ],
            "default": "none",
            "title": "{{embedWidgetSectionTitle}}",
            "description": "{{embedWidgetSectionDesc}}"
          }
        }
      },
      "metadataSettings": {
        "type": "object",
        "title": "{{metadataWidgetTitle}}",
        "description": "{{metadataWidgetDescription}}",
        "properties": {  
          "metadataInColumns":{          
            "type": "string",			
            "enum": [
              "singleCol",
              "doubleCol"
            ],
            "default": "doubleCol",
            "title": "{{showMetadataTitle}}",
            "description": "{{showMetadataTitle}}"
        },      
          "hideMetadata": {
            "type": "boolean",
            "enum": [
              true,
              false
            ],
            "default": false,
            "title": "{{hideMetadataTitle}}",
            "description": "{{hideMetadataDesc}}"
          },
          "hideEmptyFields": {
            "type": "boolean",
            "enum": [
              true,
              false
            ],
            "default": false,
            "title": "{{hideEmptyFieldsTitle}}",
            "description": "{{hideEmptyFieldsDesc}}"
          },
          "metadata": {
            "type": "array",
            "title": "{{metadataWidgetTitle}}",
            "description": "{{headerMetadataDesc}}",
            "items": {
              "type": "object",
              "title": "{{categoryTitle}}",
              "description": "{{categoryDescription}}"
            }
          }
        }
      },
      "favoriteSettings": {
        "type": "object",
        "title": "{{favoriteWidgetTitle}}",
        "description": "{{favoriteWidgetDesc}}",
        "properties": {
          "hideFavorite": {
            "type": "boolean",
            "enum": [
              true,
              false
            ],
            "default": false,
            "title": "{{hideFavoriteTitle}}",
            "description": "{{hideFavoriteDesc}}"
          }
        }
      }
    }
  },
  "options": {
    "fields": {
      "workspace": {
        "fields": {
          "properties": {
            "fields": {
              "title": {
                "type": "otconws_metadata_string"
              },
              "type": {
                "type": "otconws_metadata_string"
              },
              "description": {
                "type": "otconws_metadata_string"
              }
            }
          }
        }
      },
      "metadataSettings": {
        "fields": {
            "metadata": {
              "fields": {                        
                "item": {
                  "type": "otconws_metadata"          
                }
              }
            },
          "metadataInColumns": {
            "type": "select",            
            "optionLabels": [
              "{{singleColumnOption}}",
              "{{doubleColumnOption}}"
            ]
          }
        }
      },
      
      "headerwidget": {
        "fields": {
          "type": {
            "type": "select",
            "optionLabels": [
              "{{embedWidgetOptionLabelNone}}",
              "{{embedWidgetOptionLabelActivityFeed}}",
              "{{embedWidgetOptionLabelMetadata}}"
            ]
          }
        }
      }
    }
  }
}
);


csui.define('json!xecmpf/widgets/scan/scan.manifest.json',{
  "$schema": "http://opentext.com/cs/json-schema/draft-04/schema",
  "title": "{{widgetTitle}}",
  "description": "{{widgetDescription}}",
  "schema": {
    "type": "object",
    "properties": {
      "businessobjecttypes": {      
        "description": "{{botypesDescription}}",
        "title": "{{botypesTitle}}",
        "type": "array",
        "minItems": 1,
        "items": {
          "type": "object",
          "properties": {
            "id": {
              "type": "integer",
              "description": "{{botypeBrowseDescription}}",
              "title": "{{botypeBrowseTitle}}"
            }
          },
          "required": false
        }
      }
    }
  },
  "options": {
    "fields": {
      "businessobjecttypes": {
        "items":{
          "fields":{
            "id":{
              "type": "otcs_node_picker",
              "type_control": {
                "parameters": {
                  "dialogTitle" : "{{botypeBrowseTitle}}",
                  "select_types": [
                    889
                  ],
                  "globalSearch": false,
                  "startLocation": "xecmpf/dialogs/node.picker/start.locations/businessobjecttypes.container",
                  "startLocations": [
                    "xecmpf/dialogs/node.picker/start.locations/businessobjecttypes.container"
                  ]
                }
              }
            }

          }
        }
      }
    }
  }
}
);


csui.define('json!xecmpf/widgets/fileupload/fileupload.manifest.json',{
  "$schema": "http://opentext.com/cs/json-schema/draft-04/schema#",
  "title": "{{widgetTitle}}",
  "description": "{{widgetDescription}}",
  "kind": "tile",
  "schema": {
    "type": "object",
    "properties": {
      "title": {
        "type": "otcs_multilingual_string",
        "title": "{{idTitle}}",
        "description": "{{idDescription}}",
        "default": ""
      }
    }
  }
});


csui.define('json!xecmpf/utils/perspective/custom.search.json',{
  "type": "grid",
  "options": {
    "rows": [
      {
        "columns": [
          {
            "sizes": {
              "md": 12
            },
            "heights": {
              "xs": "full"
            },
            "widget": {
              "type": "xecmpf/widgets/integration/folderbrowse/search.results",
              "options": {
                "enableBackButton": true
              }
            }
          }
        ]
      }
    ]
  }
}
);

// Lists explicit locale mappings and fallbacks

csui.define('xecmpf/widgets/header/impl/nls/header.manifest',{
    // Always load the root bundle for the default locale (en-us)
    "root": true,
    // Do not load English locale bundle provided by the root bundle
    "en-us": false,
    "en": false
  });
csui.define('xecmpf/widgets/header/impl/nls/root/header.manifest',{
    widgetTitle: "Header",
    widgetDescription: "Header widget for business workspaces",
    workspaceTitle: "Workspace",
    workspaceDescription: "Workspace specific options",
    workspacePropertiesTitle: "Properties",
    workspacePropertiesDesc: "Configuration properties",
    businessworkspaceTitle: "Title",
    businessworkspaceDesc: "Name of the business workspace",
    workspaceTypeTitle: "Type",
    workspaceTypeDesc: "Name of the workspace type",
    descriptionSectionTitle: "Description",
    descriptionSection: "Description of the business workspace",
    completenessCheckTitle: "Completeness check",
    completenessCheckDescription: "Completeness check configuration",
    hideMissingDocsCheckTitle: "Hide missing documents check",
    hideMissingDocsCheckDescription: "Option to show or hide the missing document check",
    hideOutdatedDocsCheckTitle: "Hide outdated documents check",
    hideOutdatedDocsCheckDescription: "Option to show or hide the outdated document check. This option will be effective only if the Extended ECM for SAP SuccessFactors module is installed on the system",
    hideInProcessDocsCheckTitle: "Hide In process documents check",
    hideInProcessDocsCheckDesc: "Option to show or hide the In process document check. This option will be effective only if the Extended ECM for SAP SuccessFactors module is installed on the system",
    additionalWidgetTitle: "Widget",
    additionalWidgetDescription: "Additional widget that can be embedded in the header widget",
    embedWidgetSectionTitle: "Embed widget",
    embedWidgetSectionDesc: "Widget to be embedded in the header widget",
    embedWidgetOptionLabelNone: "None",
    embedWidgetOptionLabelActivityFeed: "Activity Feed",
    embedWidgetOptionLabelMetadata: "Metadata",
    metadataWidgetTitle: "Metadata",
    metadataWidgetDescription: "Header metadata configuration",
    showMetadataTitle: "Show Metadata In Columns",
    hideMetadataTitle: "Hide Metadata",
    hideMetadataDesc: "Hide metadata on header",
    hideEmptyFieldsTitle: "Hide empty fields",
    hideEmptyFieldsDesc: "Display only fields with values",
    headerMetadataDesc: "Metadata displayed in Header widget",
    categoryTitle: "Category or attribute",
    categoryDescription: "Category or attribute with metadata",
    favoriteWidgetTitle: "Favorite",
    favoriteWidgetDesc: "Favorite configuration",
    hideFavoriteTitle: "Hide Favorite",
    hideFavoriteDesc: "Option to hide the favorite icon on the header",
    singleColumnOption: "Single",
    doubleColumnOption: "Double"
});

csui.define('xecmpf/widgets/boattachments/impl/nls/boattachments.manifest',{
    // Always load the root bundle for the default locale (en-us)
    "root": true,
    // Do not load English locale bundle provided by the root bundle
    "en-us": false,
    "en": false
});

csui.define('xecmpf/widgets/boattachments/impl/nls/root/boattachments.manifest',{
    widgetTitle: "Business Attachments",
    widgetDescription: "Shows business attachments for a business object",
    tileTitle: "Title",
    tileDescription: "Title of the business attachments widget",
    businessAttachmentTitle: "Business attachment",
    businessAttachmentDesc: "Business attachment specific options",
    busAttPropertiesTitle: "Properties",
    busAttPropertiesDesc: "Configuration properties",
    boIdTitle: "Business object id",
    boIdDesc: "ID of the business object whose business attachments are displayed",
    boTypeTitle: "Business object type",
    boTypeDesc: "Type of the business object",
    busAppTitle: "Business application ID",
    busAppDesc: "Business application of the business object",
    collapsedViewTitle: "Collapsed view",
    collapsedViewDesc: "Options for the collapsed view of this widget",
    noResultsPlaceholderTitle: "Message for empty result",
    noResultsPlaceholderDescription: "Message if there are no business attachments to display",
    orderTitle: "Order by",
    orderDescription: "Sort order of the displayed business attachments",
    sortColumnTitle: "Column",
    sortColumnDescription: "Column to order by",
    sortOrderTitle: "Sort order",
    sortOrderDescription: "Sort order to be used",
    sortOrderOptionLabelAsc: "Ascending",
    sortOrderOptionLabelDesc: "Descending",
    businessAttachmentsTileTitle: "Business attachment title",
    businessAttachmentsTileDesc: "Title of the business attachment in collapsed view",
    valueTitle: "Title",
    valueDescription: "Value for the Title field",
    descriptionSectionTitle: "Business attachment description",
    descriptionSectionDesc: "Description of the business attachment in collapsed view",
    descriptionValueTitle: "Description",
    descriptionFieldValue: "Value for the description field",
    topRightSectionTitle: "Top right metadata field",
    topRightSectionDescription: "Metadata displayed in top right  metadata field in collapsed view",
    topRightLabel: "Label",
    topRightLabelDesc: "Label for the metadata field",
    topRightValue: "Value",
    topRightValueDesc: "Value for the top right metadata field",
    bottomLeftTitle: "Bottom left  metadata field",
    bottomLeftTitleDesc: "Metadata displayed in bottom left  metadata field in collapsed view",
    bottomLeftLabelTitle: "Label",
    bottomLeftLabelDesc: "Label for the metadata field",
    bottomLeftValue: "Value",
    bottomLeftValueDesc: "Value for the bottom left metadata  metadata field",
    bottomRightTitle: "Bottom right  metadata field",
    bottomRightTitleDesc: "Metadata displayed in bottom right  metadata field in collapsed view",
    bottomRightLabel: "Label",
    bottomRightLabelDesc: "Label for the metadata field",
    bottomRightValue: "Value",
    bottomRightValueDesc: "Value for the bottom right metadata  metadata field",
    expandedViewTitle: "Expanded view",
    expandedViewDesc: "Options for the expanded view of this widget",
    snapshotTitle: "Snapshot",
    snapshotDesc: "Options for the snapshots of Business Attachments",
    parentFolderTitle: "Parent folder name",
    parentFolderDesc: "Folder in business workspace, where Snapshots are created.",
    snapshotNameTitle: "Snapshot name prefix",
    snapshotNameDesc: "The name of a snapshot consists of the prefix and a timestamp."
});

csui.define('xecmpf/widgets/scan/impl/nls/scan.manifest',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  // Do not load English locale bundle provided by the root bundle
  "en-us": false,
  "en": false
});

csui.define('xecmpf/widgets/scan/impl/nls/root/scan.manifest',{
  widgetTitle:"Scan barcode",
  widgetDescription:"Select business object types for the code scan with mobile devices. This widget can only be used with the Content Server Mobile app.",
  botypesTitle: 'Business Object Types',
  botypesDescription:"List of business object types which are relavant for the scan",
  botypeBrowseTitle:"Business Object Type",
  botypeBrowseDescription:"Select the business object type which is relavant for the scan"
});

csui.define('xecmpf/widgets/fileupload/impl/nls/fileupload.manifest',{
  // Always load the root bundle for the default locale (en-us)
  "root": true,
  "en-us": false,
  "en": false
});

csui.define('xecmpf/widgets/fileupload/impl/nls/root/fileupload.manifest',{
  "widgetTitle": "File upload",
  "widgetDescription": "Shows information about documents uploaded and contains provision to upload documents",
  "idTitle": "Title",
  "idDescription": "Title of the File upload widget"
});


csui.define('xecmpf/widgets/dossier/impl/nls/dossier.manifest',{
    // Always load the root bundle for the default locale (en-us)
    "root": true,
    // Do not load English locale bundle provided by the root bundle
    "en-us": false,
    "en": false
  });
csui.define('xecmpf/widgets/dossier/impl/nls/root/dossier.manifest',{
    widgetTitle:"Dossier",
    widgetDescription:"Dossier View for business workspaces grouped by some criterion say create date ,classification",
    classification:"classification",
    create_date:"create_date",
    groupBy_title:"Default group by criterion",
    groupBy_Description:"Group by criterion that dossier view will use to load for the first time",
    hideGroupByCriterionDropdown_title:"Hide group by criterion dropdown",
    hideGroupByCriterionDropdown_description:"Option to hide the dropdown to choose the group by criterion",
    hideMetadata_title:"Hide metadata",
    hideMetadata_description:"Option to hide the document's metadata view",
    metadata_title:"Metadata",
    metadata_description:"Metadata displayed for document",
    metadata_items_title:"Category or attribute",
    metadata_items_description:"Category or attribute with metadata",
    hideEmptyFields_title:"Hide empty fields",
    hideEmptyFields_description:"Display only fields with values",
    hideFavorite_title:"Hide favorite",
    hideFavorite_description:"Option to hide the favorite icon"
});

csui.define('xecmpf/utils/perspective/custom.search.perspective',['csui/lib/backbone'], function (Backbone) {
  return [
    {
      decides: function () {
        return Backbone.history.root && !!Backbone.history.root.match("xecm");
      },
      module: 'json!xecmpf/utils/perspective/custom.search.json'
    }
  ];
});

csui.define('xecmpf/utils/perspective/eventactionnode.perspective',[],function () {
    'use strict';
    return [
      {
        equals: {type: [898]},
        important: true,
        module: 'json!xecmpf/utils/perspective/impl/perspectives/eventaction.json'
      }
    ];
  
  });
csui.define('xecmpf/utils/perspective/eventdefinitionnode.perspective',[],function () {
    'use strict';
    return [
      {
        equals: {type: [806]},
        important: true,
        module: 'json!xecmpf/utils/perspective/impl/perspectives/eventdefinition.json'
      }
    ];
  
  });
csui.define('xecmpf/utils/contexts/perspective/plugins/node/impl/node.extra.data',[], function () {
  'use strict';

  return {
    getModelFields: function (options) {
      return {
        external_source: [],
        bwsinfo: ['up'],
        showworkflowicon: '',
      };
    },

    getModelExpand: function (options) {
      return {};
    }
  };

});
csui.define('xecmpf/utils/perspective/fileuploadnode.perspective',[],function () {
    'use strict';
    return [
      {
        equals: {type: [848]},
        important: true,
        module: 'json!xecmpf/utils/perspective/impl/perspectives/fileupload.json'
      }
    ];
  
  });
csui.define('xecmpf/utils/commands/toolbar.extension',["csui/lib/jquery", "csui/lib/underscore"], function ($, _) {

  function ToolbarExtension() {}

  _.extend(ToolbarExtension.prototype, {

    OnUpdateToolbar: function (args) {
      var done         = args.async(),
          container    = args.container,
          toolbarItems = args.toolbarItems,
          deferred     = $.Deferred(),
          EventItem    = _.find(toolbarItems, function (toolItem) {
            if (toolItem.attributes.type === 806) {
              return toolItem;
            }
          });

      if (!!EventItem) {
        EventItem.set("signature", "addEvents");
      }

      deferred.resolve.apply(deferred, arguments);
      done();
    }
  });

  return function (tableToolbarView) {
    var extension = new ToolbarExtension();
    tableToolbarView.on('before:updateAddToolbar',
        function () { extension.OnUpdateToolbar.apply(extension, arguments);});

  };

});

csui.define('json!xecmpf/utils/perspective/impl/perspectives/eventaction.json',{
  "type": "left-center-right",
  "options": {
    "center": {
      "kind": "fullpage",
      "options":{
      },
      "type": "xecmpf/widgets/eac"
    },
    "left":{},
    "right":{}
  }
}
  );


csui.define('json!xecmpf/utils/perspective/impl/perspectives/eventdefinition.json',{
    "type": "left-center-right",
    "options": {
      "center": {
        "kind": "fullpage",
        "options":{
        },
        "type": "xecmpf/widgets/eac/impl/actionplan.details"
      },
      "left":{},
      "right":{}
    }
  }
    );

csui.define('xecmpf/utils/contexts/fileupload/fileupload.perspective.context.plugin',['csui/lib/underscore', 'csui/utils/contexts/factories/application.scope.factory',
    'csui/utils/contexts/perspective/perspective.context.plugin'
], function (_, ApplicationScopeModelFactory,
    PerspectiveContextPlugin) {
    'use strict';

    var supportedPerspectives = {
        fileupload: 'fileupload'
    };

    var FileUploadPerspectiveContextPlugin = PerspectiveContextPlugin.extend({

        constructor: function FileUploadPerspectiveContextPlugin(options) {
            PerspectiveContextPlugin.prototype.constructor.apply(this, arguments);

            this.applicationScope = this.context
                .getModel(ApplicationScopeModelFactory)
                .on('change:id', this._fetchFileUploadPerspective, this);

        },

        _fetchFileUploadPerspective: function () {
            var scope = this.applicationScope.id;
            if (!supportedPerspectives[scope] || this.loadingPerspective) {
                return;
            }

            this.context.loadPerspective('json!xecmpf/utils/contexts/fileupload/' +
                supportedPerspectives[scope] + '.json');
        }

    });

    return FileUploadPerspectiveContextPlugin;

});

csui.define('json!xecmpf/utils/contexts/fileupload/fileupload.json',{
  "type": "left-center-right",
  "options": {
    "center": {
      "type": "xecmpf/widgets/fileupload/impl/fileupload.expand"
    }
  }
});

csui.define('xecmpf/utils/router/fileupload/fileupload.perspective.router',['csui/lib/underscore', 'csui/pages/start/perspective.router',
  'csui/utils/contexts/factories/application.scope.factory',
  'i18n!xecmpf/widgets/fileupload/impl/nls/lang'
], function (_, PerspectiveRouter, ApplicationScopeModelFactory, 

    lang) {
  'use strict';

  var FileUploadPerspectiveRouter = PerspectiveRouter.extend({

    routes: {
      'nodes/:node_id/fileupload': 'openFileUploadPerspective'
    },

    constructor: function FileUploadPerspectiveRouter(options) {
      PerspectiveRouter.prototype.constructor.apply(this, arguments);

      this.applicationScope = this.context.getModel(ApplicationScopeModelFactory);

      this.listenTo(this.applicationScope, 'change:id', this._updateUrl);
    },

    openFileUploadPerspective: function ( id ) {
      if( id ){
        
          this.context.wsid = id;
      } else {
        this.context.wsid = 0;
      }

      this.openApplicationScope('fileupload');
    },

    openApplicationScope: function (scope) {
      this._updatePageTitle();
      this.applicationScope.set('id', scope);
    },

    _updatePageTitle: function () {
      document.title = lang.dialogTitle;
    },

    _updateUrl: function () {
      
      // Skip scopes handled by other routers
      var scope = this.applicationScope.id;
      if (scope !== 'fileupload') {
        return;
      }
      
      var url = "nodes/"+ this.context.wsid + '/fileupload';
      this.navigate(url);
    }

  });

  return FileUploadPerspectiveRouter;

});

// Placeholder for the build target file; the name must be the same,
// include public modules from this component

csui.define('bundles/xecmpf-app',[
  //Pages
  'xecmpf/pages/start/perspective-only.page.view',

  //Search box widget extension
  'xecmpf/widgets/integration/folderbrowse/search.box.view',

  //Page as dialog
  'xecmpf/widgets/integration/folderbrowse/full.page.workspace.view',

  //Custom Search Results
  'xecmpf/widgets/integration/folderbrowse/search.results/search.results.view',

  // Toolbar items
  'xecmpf/utils/commands/xecmpf.nodestable.toolitems',
  'xecmpf/utils/commands/xecmpf.searchresults.toolitems',

  'xecmpf/widgets/eac/eac.view',

  // Custom modal dialog for Full page wokrspace
  'xecmpf/widgets/integration/folderbrowse/modaldialog/modal.dialog.view',
  'xecmpf/utils/table/inlineforms/eventactioncenter/eventactioncenter.view',
  'xecmpf/controls/table/cells/node.state/node.state.icons',


  //Icons
  'xecmpf/utils/icons/icons',
  'xecmpf/utils/icons/xecmpf.icons.v2',

  // Event Definition default action
  'xecmpf/utils/eventdefinition.defaultactionitems',

  // Commands
  'xecmpf/utils/commands/folderbrowse/go.to.workspace.history',
  'xecmpf/utils/commands/folderbrowse/search.container',
  'xecmpf/utils/commands/folderbrowse/open.full.page.workspace',
  'xecmpf/utils/commands/workspaces/delete.workspace.handler',
  'xecmpf/utils/commands/boattachments/boattachments.create',
  'xecmpf/utils/commands/eac/eac.refresh',
  'xecmpf/utils/commands/eac/eac.back',
  'xecmpf/utils/commands/eac/add.to.warehouse',
  'xecmpf/widgets/boattachments/impl/boattachment.table/commands/snapshot',
  "xecmpf/utils/commands/eac/add.events",
  "xecmpf/utils/commands/eac/add.action.plan",
  "xecmpf/utils/commands/eac/delete",
  'xecmpf/utils/commands/eac/open.eventdefinition',
  'xecmpf/utils/commands/xecm.open.plugins/impl/xecm.open.plugins',
  'xecmpf/utils/commands/xecm.open.plugins/impl/web.viewer.plugin',
  'xecmpf/utils/commands/workflows',
  'xecmpf/utils/commands/createdocument',


  // Behaviors
  'xecmpf/behaviors/toggle.header/toggle.header.behavior',

  // Toolbar buttons
  'xecmpf/widgets/integration/folderbrowse/toolbaritems',
  'xecmpf/widgets/eac/toolbaritems',

  // Cell views
  'xecmpf/widgets/boattachments/impl/boattachment.table/tablecell/createdby.view',
  'xecmpf/widgets/boattachments/impl/boattachment.table/tablecell/modifiedby.view',

  'xecmpf/controls/table/cells/eac.actionplan.view',
  'xecmpf/controls/table/cells/location.cell.view',
  'xecmpf/controls/table/cells/statusicon.view',

  // Inline forms

  // Integration widgets

  // workspace reference
  'xecmpf/controls/bosearch/bosearch.dialog.controller',
  'xecmpf/controls/property.panels/reference/impl/reference.panel.view',

  // Public widgets
  'xecmpf/widgets/boattachments/boattachments.view',

  // Application widgets
  'xecmpf/widgets/workspaces/workspaces.widget',

  // Metadata widget extensions
  // Metadata panel collection
  'xecmpf/widgets/myattachments/metadata.property.panels',

  // Widgets
  'xecmpf/widgets/dossier/dossier.view',
  'xecmpf/widgets/header/header.view',
  'xecmpf/widgets/scan/scan.view',
  'xecmpf/widgets/fileupload/fileupload.view',
  'xecmpf/widgets/fileupload/impl/fileupload.expand/fileupload.expand.view',

  // Public Views
  'xecmpf/utils/document.thumbnail/document.thumbnail.view',
  'xecmpf/controls/savedquery.node.picker/savedquery.node.picker.view',
  'xecmpf/controls/savedquery.node.picker/impl/savedquery.form.view',
  'xecmpf/controls/search.textbox/search.textbox.view',

  // Public Controls
  'xecmpf/controls/property.panels/reference/reference.panel',
  'xecmpf/dialogs/node.picker/start.locations/businessobjecttypes.container/businessobjecttypes.container.factory',
  'xecmpf/dialogs/node.picker/start.locations/extended.ecm.volume.container/extended.ecm.volume.container.factory',
  'xecmpf/controls/form/fields/alpaca/alpdocumenttypepickerfield',

  // Navigation header extensions
  'xecmpf/utils/commands/navigate/navigate.workspace',
  'xecmpf/controls/breadcrumbspanel/breadcrumbspanel.extension',

  // Application widgets manifests
  'json!xecmpf/widgets/workspaces/workspaces.manifest.json',
  'json!xecmpf/widgets/boattachments/boattachments.manifest.json',
  'json!xecmpf/widgets/dossier/dossier.manifest.json',
  'json!xecmpf/widgets/header/header.manifest.json',
  'json!xecmpf/widgets/scan/scan.manifest.json',
  'json!xecmpf/widgets/fileupload/fileupload.manifest.json',
  'json!xecmpf/utils/perspective/custom.search.json',

  // Application widgets nls language files
  'i18n!xecmpf/widgets/header/impl/nls/header.manifest',
  'i18n!xecmpf/widgets/boattachments/impl/nls/boattachments.manifest',
  'i18n!xecmpf/widgets/scan/impl/nls/scan.manifest',
  'i18n!xecmpf/widgets/fileupload/impl/nls/fileupload.manifest',
  'i18n!xecmpf/widgets/boattachments/impl/nls/lang',
  'i18n!xecmpf/controls/property.panels/reference/impl/nls/lang',
  'i18n!xecmpf/controls/table/cells/node.state/impl/nls/lang',
  'i18n!xecmpf/dialogs/node.picker/start.locations/impl/nls/lang',
  'i18n!xecmpf/widgets/dossier/impl/nls/dossier.manifest',


  // Perspective overrides
  'xecmpf/utils/perspective/custom.search.perspective',

  //Utils
  'xecmpf/widgets/boattachments/impl/boattachmentutil',

  //eventaction Content
  'xecmpf/utils/perspective/eventactionnode.perspective',
  'xecmpf/utils/perspective/eventdefinitionnode.perspective',
  'xecmpf/utils/contexts/perspective/plugins/node/impl/node.extra.data',

  //fileupload node perspective
  'xecmpf/utils/perspective/fileuploadnode.perspective',

  // toolbar extension
  'xecmpf/utils/commands/toolbar.extension',

  //generic util
  'xecmpf/utils/util',


  //eventaction perspective
  'json!xecmpf/utils/perspective/impl/perspectives/eventaction.json',
  'json!xecmpf/utils/perspective/impl/perspectives/eventdefinition.json',

  //file upload perspective Contexts
  'xecmpf/utils/contexts/fileupload/fileupload.perspective.context.plugin',
  'json!xecmpf/utils/contexts/fileupload/fileupload.json',

  //fileupload Router
  'xecmpf/utils/router/fileupload/fileupload.perspective.router'

], {});

csui.require(['require', 'css'], function (require, css) {
  css.styleLoad(require, 'xecmpf/bundles/xecmpf-app', true);
});
